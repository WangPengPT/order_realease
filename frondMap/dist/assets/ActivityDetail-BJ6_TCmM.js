import{j as e,r as i,p as G,bJ as Os,bg as Se,b9 as ne,a4 as de,aM as se,b0 as _e,bK as $s,aW as qs,bL as Bs,bM as me,bv as q,aZ as ce,bN as Hs,bE as Ws,w as z,q as De,bH as Ks,bG as rs,bB as Us,aO as Qs,u as Gs,bO as D,L as Y,bm as Vs,bC as We,bP as Xs,bu as Ke,b2 as Ne,aX as Ue,b1 as Zs,bI as Js,b6 as Qe,bk as Ys,aw as Ge,ba as be,bf as ea}from"./vendor-react-DImbKuZP.js";import{f as ns}from"./textFormatting-C5ODvpSJ.js";import{S as o,C as B,E as ee,F as U,w as sa,R as ue,q as N,D as Le,c as Ae,d as Te,e as Ee,Z as is,$ as Ve,B as F,a0 as ls,Q as os,a1 as aa,a2 as Xe,a as cs,a3 as ta,T as ra,U as na,V as ia,W as M,X as Ze,z as la,s as Q,u as oa,a4 as ca,K as Je,r as da,t as ma,v as ua,A as ha,f as xa,h as pa,i as ga,j as fa,k as ja,l as va,m as wa}from"./index-_G3CuCzp.js";import{S as Ye}from"./separator-8wE-3N0K.js";import{C as Na,a as ba,b as ya}from"./collapsible-dyuDlGDF.js";import{E as Ca}from"./ExternalLinkConfirmDialog-C_70Xa0h.js";import{l as es}from"./xiaoxiong-logo-v3-D2n3VLi4.js";import{P as ka}from"./PullToRefresh-BimBuYXa.js";import{b as Sa,c as _a,a as Da,d as La,e as Aa,f as Ta,g as Ea,h as Pa}from"./useActivities-B-dkIh_c.js";import{a as Ra}from"./useActivityRealtime-Qkau-lST.js";import{u as Ia,a as Ma,b as za}from"./useActivityParticipation-DhsksXqN.js";import{u as ds}from"./useLocalizedContent-B2SRIfSp.js";import Fa from"./RestaurantComments-tvmu5H0K.js";import{m as K}from"./vendor-map-CvE3ASYw.js";import{m as Oa}from"./map-icon-DR07RZr_.js";import{C as ss}from"./checkbox-DvE0llcT.js";import{R as $a}from"./ReportDialog-vrnk1akO.js";import{A as qa}from"./ActivityTermsAgreement-nfGD1UJb.js";import{T as Ba,a as Ha,b as ye,c as Ce}from"./tabs-Dk5peax5.js";import{u as Wa,a as Ka}from"./useGlobalHandbook-Bg7uqOK1.js";import{R as ke}from"./RichTextEditor-Bg0Y3csO.js";import{L as Ua}from"./LocationPermissionDialog-BDLW4gbZ.js";import{g as Qa,c as Ga}from"./geolocation-YPf7LJYy.js";import{u as Va,a as Xa,b as Za,c as Ja}from"./useCoupons-CNcgtS4u.js";import{u as Ya}from"./usePageView-DuFNa9bb.js";import{u as et}from"./ShareDrawer-DMcIfFNZ.js";import{i as st}from"./vendor-i18n-AOdgFpXS.js";import{D as as}from"./vendor-utils-vwQGbBim.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CRxszhSs.js";import"./useSensitiveWords-BhXzQ4qo.js";import"./TranslateButton-P5tJRjUf.js";import"./ImagePreviewModal-CyiB2E01.js";import"./input-otp-BfQczcWm.js";import"./useActivityRules-BHraIJKQ.js";import"./drawer-CK8DetMs.js";const at=()=>e.jsxs("div",{className:"min-h-screen bg-secondary/20 pb-8",children:[e.jsxs("div",{className:"relative h-[33vh] overflow-hidden",children:[e.jsx(o,{className:"w-full h-full rounded-none"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent"}),e.jsx("div",{className:"absolute top-4 left-4",children:e.jsx(o,{className:"h-10 w-10 rounded-md"})}),e.jsxs("div",{className:"absolute top-4 right-4 flex gap-2",children:[e.jsx(o,{className:"h-10 w-10 rounded-md"}),e.jsx(o,{className:"h-10 w-10 rounded-md"})]})]}),e.jsxs("div",{className:"container mx-auto px-4 -mt-20 relative z-10",children:[e.jsx(B,{className:"shadow-large",children:e.jsxs(ee,{children:[e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx(o,{className:"h-6 w-16 rounded-full"}),e.jsx(o,{className:"h-6 w-20 rounded-full"}),e.jsx(o,{className:"h-6 w-24 rounded-full"})]}),e.jsx(o,{className:"h-9 w-3/4 mb-4"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mb-4",children:[e.jsx(o,{className:"h-5 w-24"}),e.jsx(o,{className:"h-5 w-20"}),e.jsx(o,{className:"h-5 w-28"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(o,{className:"h-5 w-5 flex-shrink-0"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"h-4 w-32"}),e.jsx(o,{className:"h-4 w-40"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(o,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"h-4 w-20"}),e.jsx(o,{className:"h-4 w-32"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(o,{className:"h-10 w-28 rounded-md"}),e.jsx(o,{className:"h-10 w-32 rounded-md"}),e.jsx(o,{className:"h-10 w-24 rounded-md"})]})]})}),e.jsxs(B,{className:"mt-6 shadow-large",children:[e.jsx(ee,{children:e.jsx(o,{className:"h-6 w-36"})}),e.jsxs(U,{className:"space-y-3",children:[e.jsx(o,{className:"h-4 w-full"}),e.jsx(o,{className:"h-4 w-full"}),e.jsx(o,{className:"h-4 w-5/6"}),e.jsx(o,{className:"h-4 w-4/5"})]})]}),e.jsxs(B,{className:"mt-6 shadow-large",children:[e.jsx(ee,{children:e.jsx(o,{className:"h-6 w-28"})}),e.jsxs(U,{className:"space-y-2",children:[e.jsx(o,{className:"h-4 w-full"}),e.jsx(o,{className:"h-4 w-3/4"})]})]}),e.jsxs(B,{className:"mt-6 shadow-large",children:[e.jsxs(ee,{className:"flex flex-row items-center justify-between",children:[e.jsx(o,{className:"h-6 w-40"}),e.jsx(o,{className:"h-5 w-24"})]}),e.jsxs(U,{children:[e.jsx(o,{className:"h-[200px] w-full rounded-lg mb-4"}),e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsx(o,{className:"h-16 w-16 rounded-lg flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(o,{className:"h-5 w-40"}),e.jsx(o,{className:"h-4 w-full"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{className:"h-5 w-16 rounded-full"}),e.jsx(o,{className:"h-5 w-12"})]})]})]},s))})]})]})]})]}),ms=i.memo(({restaurants:s,onMarkerClick:d})=>{const{t:x}=G(),a=i.useRef(null),t=i.useRef(null),j=i.useRef([]),[v,p]=i.useState(!1),[m,C]=i.useState(null),u=i.useRef(null);return i.useEffect(()=>{if(!a.current||t.current)return;const R="pk.eyJ1IjoieGlhb3hpb25nMTIzIiwiYSI6ImNtNTFjOXliYjF1Y2IyaXM4bnNzMGxvdnkifQ.mPcWqH7ndIrjEqlWIJVk8g";if(!K.supported()){console.warn("[ActivityMap] WebGL not supported",{isIOSDevice:sa(),isIOSWebView:ue(),userAgent:navigator.userAgent}),C(x("map.webglNotSupported","Your browser does not support map display"));return}const g=()=>{if(!a.current)return;const w=a.current.getBoundingClientRect();if(w.width===0||w.height===0){setTimeout(g,100);return}try{K.accessToken=R;const l=s.reduce((c,f)=>c+Number(f.restaurants.lat||0),0)/s.length,h=s.reduce((c,f)=>c+Number(f.restaurants.lng||0),0)/s.length;t.current=new K.Map({container:a.current,style:"mapbox://styles/mapbox/light-v11",center:[h,l],zoom:12,cooperativeGestures:!0,doubleClickZoom:!1}),t.current.on("error",c=>{console.error("[ActivityMap] Map error:",c),C(x("map.loadError","Map failed to load"))}),t.current.addControl(new K.NavigationControl,"top-right"),t.current.on("load",()=>{p(!0)})}catch(l){console.error("[ActivityMap] Failed to initialize map:",l),C(x("map.loadError","Map failed to load"))}};return g(),()=>{j.current.forEach(w=>w.remove()),j.current=[],u.current&&(u.current.remove(),u.current=null),t.current?.remove(),t.current=null,p(!1)}},[s.length,x]),i.useEffect(()=>{if(!t.current||!v||s.length===0)return;(()=>{if(j.current.forEach(g=>g.remove()),j.current=[],u.current&&(u.current.remove(),u.current=null),s.forEach(g=>{const w=Number(g.restaurants.lat),l=Number(g.restaurants.lng);if(isNaN(w)||isNaN(l))return;const h=document.createElement("div");h.className="p-3 min-w-[200px]",h.innerHTML=`
          <div class="space-y-2">
            <h3 class="font-bold text-base text-foreground">${g.restaurants.name}</h3>
            <p class="text-xs text-muted-foreground">${g.restaurants.address}</p>
          </div>
        `;const c=new K.Popup({offset:25,closeButton:!0,closeOnClick:!1,closeOnMove:!1,maxWidth:"300px"}).setLngLat([l,w]).setDOMContent(h),f=document.createElement("div");f.className="custom-marker",f.style.backgroundImage=`url(${Oa})`,f.style.width="40px",f.style.height="40px",f.style.backgroundSize="contain",f.style.backgroundRepeat="no-repeat",f.style.backgroundPosition="center",f.style.cursor="pointer";const T=new K.Marker({element:f,draggable:!1}).setLngLat([l,w]).addTo(t.current),k=T.getElement();k.style.cursor="pointer";const y=P=>{P.stopPropagation(),P.preventDefault(),u.current&&u.current!==c&&u.current.remove(),c.addTo(t.current),u.current=c,t.current.easeTo({center:[l,w],zoom:17,duration:800}),d&&d(g.restaurant_id)};k.addEventListener("click",y,!0),c.on("close",()=>{u.current===c&&(u.current=null)}),j.current.push(T)}),s.length>1){const g=new K.LngLatBounds;s.forEach(w=>{const l=Number(w.restaurants.lat),h=Number(w.restaurants.lng);!isNaN(l)&&!isNaN(h)&&g.extend([h,l])}),t.current?.fitBounds(g,{padding:50,maxZoom:14})}})()},[s,v,d]),s.length===0?null:m?e.jsxs("div",{className:"w-full h-[350px] rounded-lg bg-muted/50 flex flex-col items-center justify-center p-6 text-center",children:[e.jsx(Os,{className:"w-10 h-10 text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground text-sm mb-2",children:m}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:x("map.viewListInstead","Please view the restaurant list below")}),ue()&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>window.open(window.location.href,"_blank"),children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),x("map.openInBrowser","Open in Browser")]})]}):e.jsx("div",{ref:a,className:"w-full h-[350px] rounded-lg"})});ms.displayName="ActivityParticipationMap";const tt=({open:s,onOpenChange:d,restaurants:x,participatingRestaurantIds:a,onConfirm:t,isPending:j,isParticipating:v})=>{const{t:p}=G(),{localizeRestaurant:m}=ds(),[C,u]=i.useState([]);i.useEffect(()=>{s&&u(a)},[s,a]);const R=l=>{u(h=>h.includes(l)?h.filter(c=>c!==l):[...h,l])},g=()=>{C.length===x.length?u([]):u(x.map(l=>l.id))},w=()=>{t(C)};return e.jsx(Le,{open:s,onOpenChange:d,children:e.jsxs(Ae,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(Te,{children:[e.jsxs(Ee,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5"}),"选择参与的餐厅"]}),e.jsx(is,{children:"勾选要参与活动的餐厅，取消勾选将退出活动"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b",children:[e.jsx(ss,{id:"select-all",checked:C.length===x.length,onCheckedChange:g}),e.jsxs(Ve,{htmlFor:"select-all",className:"cursor-pointer font-semibold",children:["全选/取消全选 (",C.length,"/",x.length,")"]})]}),e.jsx("div",{className:"space-y-3",children:x.map(l=>{const h=m(l),c=C.includes(l.id),f=a.includes(l.id);return e.jsx(B,{className:`transition-all ${c?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,children:e.jsx(U,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ss,{id:l.id,checked:c,onCheckedChange:()=>R(l.id)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(Ve,{htmlFor:l.id,className:"cursor-pointer flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold truncate",children:ns(h.name)}),f&&e.jsxs(F,{variant:"secondary",className:"text-xs",children:[e.jsx(de,{className:"w-3 h-3 mr-1"}),"已参与"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:l.address}),h.type&&h.type.length>0&&e.jsx("div",{className:"flex gap-1 mt-1 flex-wrap",children:h.type.slice(0,2).map((T,k)=>e.jsx(F,{variant:"outline",className:"text-xs",children:T},k))})]})]})})},l.id)})})]}),e.jsxs(ls,{children:[e.jsx(N,{variant:"outline",onClick:()=>d(!1),disabled:j,children:p("common.cancel")}),e.jsx(N,{onClick:w,disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2 animate-spin"}),p("common.loading")]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"确认 (",C.length,")"]})})]})]})})},ts=({children:s})=>{const{t:d,i18n:x}=G(),{isAdmin:a}=os(),{data:t,isLoading:j}=Wa(),v=Ka(),[p,m]=i.useState(!1),[C,u]=i.useState(!1),[R,g]=i.useState("zh"),[w,l]=i.useState(""),[h,c]=i.useState(""),[f,T]=i.useState("");i.useEffect(()=>{t&&(l(t.content_zh),c(t.content_en),T(t.content_pt))},[t]);const k=()=>{if(!t)return"";const L=x.language;return L==="zh"?t.content_zh||t.content_en||t.content_pt||"":L==="pt"?t.content_pt||t.content_en||t.content_zh||"":t.content_en||t.content_zh||t.content_pt||""},y=t&&(t.content_zh||t.content_en||t.content_pt),P=async()=>{if(t)try{await v.mutateAsync({id:t.id,content_zh:w,content_en:h,content_pt:f}),Xe({title:d("common.success"),description:d("activities.handbook.updateSuccess")}),u(!1)}catch{Xe({title:d("common.error"),description:d("activities.handbook.updateError"),variant:"destructive"})}};return e.jsxs(Le,{open:p,onOpenChange:m,children:[e.jsx(aa,{asChild:!0,children:s}),e.jsxs(Ae,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Te,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"w-5 h-5 text-primary"}),e.jsx(Ee,{children:d("activities.handbook.title")})]})}),j?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(se,{className:"w-6 h-6 animate-spin text-primary"})}):C&&a?e.jsx("div",{className:"space-y-4",children:e.jsxs(Ba,{value:R,onValueChange:g,children:[e.jsxs(Ha,{className:"grid w-full grid-cols-3",children:[e.jsx(ye,{value:"zh",children:"中文"}),e.jsx(ye,{value:"en",children:"English"}),e.jsx(ye,{value:"pt",children:"Português"})]}),e.jsx(Ce,{value:"zh",className:"mt-4",children:e.jsx(ke,{value:w,onChange:l,placeholder:"请输入中文活动手册内容..."})}),e.jsx(Ce,{value:"en",className:"mt-4",children:e.jsx(ke,{value:h,onChange:c,placeholder:"Enter English activity handbook content..."})}),e.jsx(Ce,{value:"pt",className:"mt-4",children:e.jsx(ke,{value:f,onChange:T,placeholder:"Digite o conteúdo do manual da atividade em português..."})})]})}):e.jsx("div",{className:"space-y-4",children:y?e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:k()}}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(_e,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:d("activities.handbook.empty")}),a&&e.jsx("p",{className:"text-sm mt-2",children:d("activities.handbook.addPrompt")})]})}),e.jsx(ls,{className:"gap-2 sm:gap-0",children:C?e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",onClick:()=>u(!1),children:d("common.cancel")}),e.jsxs(N,{onClick:P,disabled:v.isPending,children:[v.isPending?e.jsx(se,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx($s,{className:"w-4 h-4 mr-2"}),d("common.save")]})]}):a&&e.jsxs(N,{onClick:()=>u(!0),children:[e.jsx(qs,{className:"w-4 h-4 mr-2"}),d(y?"common.edit":"activities.handbook.add")]})})]})]})},rt=({open:s,onOpenChange:d,activityTitle:x,activityId:a,onShareComplete:t,onShareAction:j,isProcessing:v=!1,hasAlreadyClaimed:p=!1})=>{const{t:m}=G(),C=cs(),[u,R]=i.useState(!1),[g,w]=i.useState(!1),l=ue()||ta();i.useEffect(()=>{w(typeof navigator<"u"&&!!navigator.share&&typeof navigator.canShare=="function"&&!l)},[l]);const h=async()=>{try{await navigator.clipboard.writeText(window.location.href),z.success(m("common.linkCopied")),R(!0),j?.()}catch(k){console.error("Error copying link:",k),z.error(m("common.shareError"))}},c=k=>{const y=encodeURIComponent(window.location.href),P=encodeURIComponent(`${x} - Xiaoxiong Market`);let L="";switch(k){case"whatsapp":L=`https://wa.me/?text=${P}%20${y}`;break;case"facebook":L=`https://www.facebook.com/sharer/sharer.php?u=${y}`;break;case"twitter":L=`https://twitter.com/intent/tweet?text=${P}&url=${y}`;break;case"telegram":L=`https://t.me/share/url?url=${y}&text=${P}`;break;case"linkedin":L=`https://www.linkedin.com/sharing/share-offsite/?url=${y}`;break;case"reddit":L=`https://reddit.com/submit?url=${y}&title=${P}`;break;case"line":L=`https://social-plugins.line.me/lineit/share?url=${y}`;break;case"wechat":h(),z.info(m("sharing.copiedForWeChat"));return;case"instagram":h(),z.info(m("sharing.copiedForInstagram"));return;default:return}ue()||la()?window.location.href=L:window.open(L,"_blank","noopener,noreferrer"),R(!0),j?.()},f=async()=>{const k={title:x,text:`${x} - Xiaoxiong Market`,url:window.location.href};if(l){await h();return}try{navigator.share&&navigator.canShare&&navigator.canShare(k)?(await navigator.share(k),R(!0),j?.()):h()}catch(y){y.name!=="AbortError"&&(console.error("Error sharing:",y),z.error(m("common.shareError")))}},T=()=>{u&&t()};return e.jsx(Le,{open:s,onOpenChange:d,children:e.jsxs(Ae,{className:"sm:max-w-md",children:[e.jsxs(Te,{children:[e.jsxs(Ee,{className:"flex items-center gap-2",children:[p?e.jsx(Bs,{className:"w-5 h-5 text-primary"}):e.jsx(me,{className:"w-5 h-5 text-primary"}),m("shareDialog.title")]}),e.jsx(is,{className:"space-y-2",children:p?e.jsx("p",{className:"text-primary font-medium",children:m("shareDialog.alreadyShared")}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:m("shareDialog.description")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:m("shareDialog.hint")})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col gap-2",children:C&&g?e.jsxs(N,{onClick:f,className:"w-full",variant:"default",children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),m("sharing.shareToApps")]}):e.jsxs(ra,{children:[e.jsx(na,{asChild:!0,children:e.jsxs(N,{className:"w-full",variant:"default",children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),m("sharing.selectPlatform")]})}),e.jsxs(ia,{className:"w-56",children:[g&&e.jsxs(e.Fragment,{children:[e.jsxs(M,{onClick:f,children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),m("sharing.systemShare")]}),e.jsx(Ze,{})]}),e.jsxs(M,{onClick:()=>c("wechat"),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"WeChat"]}),e.jsxs(M,{onClick:()=>c("instagram"),children:[e.jsx(Hs,{className:"w-4 h-4 mr-2"}),"Instagram"]}),e.jsxs(M,{onClick:()=>c("whatsapp"),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"WhatsApp"]}),e.jsxs(M,{onClick:()=>c("facebook"),children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"Facebook"]}),e.jsxs(M,{onClick:()=>c("twitter"),children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"X (Twitter)"]}),e.jsxs(M,{onClick:()=>c("telegram"),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Telegram"]}),e.jsxs(M,{onClick:()=>c("linkedin"),children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"LinkedIn"]}),e.jsxs(M,{onClick:()=>c("line"),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"LINE"]}),e.jsxs(M,{onClick:()=>c("reddit"),children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"Reddit"]}),e.jsx(Ze,{}),e.jsxs(M,{onClick:h,children:[e.jsx(Ws,{className:"w-4 h-4 mr-2"}),m("common.copyLink")]})]})]})}),!p&&e.jsx(N,{onClick:T,disabled:!u||v,className:"w-full",variant:u?"default":"secondary",children:v?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2 animate-spin"}),m("shareDialog.claiming")]}):u?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),m("shareDialog.confirmButton")]}):m("shareDialog.shareFirst")})]})]})})},nt=({activityId:s,initialCount:d=0})=>{const{t:x}=G(),a=De(),[t,j]=i.useState(d),v=i.useCallback(async()=>{const{count:p}=await Q.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",s);p!==null&&j(p)},[s]);return i.useEffect(()=>{j(d)},[d]),i.useEffect(()=>{const p=Q.channel(`share-count-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"activity_shares",filter:`activity_id=eq.${s}`},()=>{v(),a.invalidateQueries({queryKey:["shareCount",s]})}).subscribe();return()=>{Q.removeChannel(p)}},[s,v,a]),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Ks,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[t," ",x("activities.shareCount")]})]})},it=({activityId:s,initialCount:d=0})=>{const{t:x}=G(),a=De(),[t,j]=i.useState(d),v=i.useCallback(async()=>{const{count:p}=await Q.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",s);p!==null&&j(p)},[s]);return i.useEffect(()=>{j(d)},[d]),i.useEffect(()=>{const p=Q.channel(`subscriber-count-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"subscriptions",filter:`activity_id=eq.${s}`},()=>{v(),a.invalidateQueries({queryKey:["subscriberCount",s]})}).subscribe();return()=>{Q.removeChannel(p)}},[s,v,a]),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(rs,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[t," ",x("activities.subscribersCount")]})]})},Ht=()=>{const{id:s}=Us(),d=Qs(),x=Gs(),{t:a}=G(),{user:t}=oa(),{isMerchant:j,isSupervisor:v,isAdmin:p}=os(),{data:m}=ca(),{localizeActivity:C,localizeRestaurant:u,currentLang:R}=ds();cs();const[g,w]=D.useState(!1),[l,h]=D.useState(!1),[c,f]=D.useState(null),[T,k]=D.useState(!1),[y,P]=D.useState(!1),[L,he]=D.useState(!1),[us,Pe]=D.useState(!1),[xe,hs]=D.useState(!0),[xs,pe]=D.useState(!1),[ps,ge]=D.useState(!1),[gs,Re]=D.useState(!1),[fs,fe]=D.useState(!1),[js,je]=D.useState(!1),[ae,Ie]=D.useState(null),I=De(),{share:Me,DrawerComponent:vs}=et(),ws=i.useCallback(async()=>{I.removeQueries({queryKey:["activity",s]}),I.removeQueries({queryKey:["activity-restaurants",s]}),I.removeQueries({queryKey:["subscriber-count",s]}),I.removeQueries({queryKey:["share-count",s]}),I.removeQueries({queryKey:["comments",s]}),await Promise.all([I.invalidateQueries({queryKey:["activity",s]}),I.invalidateQueries({queryKey:["activity-restaurants",s]}),I.invalidateQueries({queryKey:["subscriber-count",s]}),I.invalidateQueries({queryKey:["share-count",s]}),I.invalidateQueries({queryKey:["comments",s]})])},[I,s]),Ns=i.useCallback(async(r,S)=>{try{const b=new URL(r);if(t&&S)try{const{data:_}=await Q.functions.invoke("generate-private-token",{body:{restaurant_id:S}});_?.token&&b.searchParams.set("token",_.token)}catch(_){console.error("Token generation failed:",_)}Ie(b.toString()),je(!0)}catch(b){console.error("Invalid URL:",b)}},[t]),bs=i.useCallback(()=>{ae&&(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!/Safari\//.test(navigator.userAgent)&&!window.Capacitor?.isNativePlatform?.()?window.location.href=ae:window.open(ae,"_blank")),je(!1),Ie(null)},[ae]);Ya({pageType:"activity",targetId:s}),Ra(s);const{data:ie=[]}=Va(s),{data:V=!1}=Xa(s),{data:ve}=Za(),ze=Ja(),H=ie.length>0||!!ve,ys=D.useCallback(r=>{x(`/restaurant/${r}`,{state:{fromActivity:s}})},[x,s]),Fe=d.state?.from==="admin"?"/admin/activities":"/activities",{data:n,isLoading:Cs}=Sa(s),{data:X,isLoading:ks}=_a(s),{data:Ss=[]}=Da(),_s=Ss.map(r=>r.activity_id),{data:Ds=0}=La(s),{data:Ls=0}=Aa(s),Z=Ta(),{data:E}=Ea(n?.creator_id),we=Pa(),{data:O=[]}=Ia(),{data:W=[]}=Ma(s),$=za(),A=n?C(n):null,Oe=n?_s.includes(n.id):!1,te=j||v,As=i.useCallback(()=>{!t||!n||we.mutate(n.id)},[t,n,we]),le=O.filter(r=>W.includes(r.id)).length,re=le>0;O.length,le>0&&le<O.length;const Ts=i.useCallback(()=>{if(!(!n||!te||O.length===0))if(v)he(!0);else if(re)for(const r of O)W.includes(r.id)&&$.mutate({activityId:n.id,restaurantId:r.id});else for(const r of O)$.mutate({activityId:n.id,restaurantId:r.id})},[n,te,O,v,re,W,$]),Es=i.useCallback(r=>{if(!n)return;const S=r.filter(_=>!W.includes(_)),b=W.filter(_=>!r.includes(_));S.forEach(_=>{$.mutate({activityId:n.id,restaurantId:_})}),b.forEach(_=>{$.mutate({activityId:n.id,restaurantId:_})}),he(!1)},[n,W,$]),Ps=i.useCallback(()=>{ge(!0)},[]),Rs=i.useCallback(async()=>{ge(!1),P(!0);try{const r=await Qa();f({lat:r.coords.latitude,lng:r.coords.longitude}),k(!0),z.success(a("map.locationEnabled"))}catch(r){console.error("Location error:",r),k(!1)}finally{P(!1)}},[a]),Is=i.useCallback(()=>{f(null),k(!1)},[]);D.useEffect(()=>{if(t&&H&&!V&&xe){const r=setTimeout(()=>{hs(!1)},3e3);return()=>clearTimeout(r)}},[t,H,V,xe]),i.useCallback(async()=>{try{await navigator.clipboard.writeText(window.location.href),z.success(a("common.linkCopied"))}catch(r){console.error("Error copying link:",r),z.error(a("common.shareError"))}},[a]);const $e=i.useCallback(async()=>{!n||!A||Me({title:A.title,text:`${A.title} - Xiaoxiong Market

${A.content.replace(/<[^>]*>/g,"").substring(0,200)}...`,url:window.location.href},()=>{z.success(a("common.shareSuccess"))})},[n,A,Me,a]),Ms=i.useCallback(()=>{if(!(!n||!A)){if(!t){fe(!0);return}H?pe(!0):($e(),Z.mutateAsync({activityId:s,userId:t.id}).catch(()=>{}))}},[n,A,t,H,$e,Z,s]),zs=i.useCallback(async()=>{if(!(!n||!t)){Re(!0);try{await Z.mutateAsync({activityId:s,userId:t.id});const r=ie.length>0?ie[0]:ve;r&&(await ze.mutateAsync({templateId:r.id,activityId:s,source:"share"}),z.success(a("coupon.claimSuccess"))),pe(!1)}catch(r){console.error("Error claiming coupon:",r),z.error(a("common.error"))}finally{Re(!1)}}},[n,t,Z,s,ie,ve,ze,a]),Fs=i.useCallback(()=>{!t||!s||Z.mutateAsync({activityId:s,userId:t.id}).catch(r=>{console.log("Share already recorded or error:",r)})},[t,s,Z]),J=i.useMemo(()=>{if(!X)return[];const r=X.map(S=>{if(c){const b=Ga(c.lat,c.lng,Number(S.restaurants.lat),Number(S.restaurants.lng));return{...S,distance:b}}return{...S,distance:void 0}});return T&&c?r.sort((S,b)=>S.distance!==void 0&&b.distance!==void 0?S.distance-b.distance:0):r.sort((S,b)=>{const _=Number(S.restaurants.rating)||0;return(Number(b.restaurants.rating)||0)-_})},[X,T,c]);if(Cs)return e.jsx(at,{});if(!n||!A||n.status==="draft"&&!p)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl text-muted-foreground",children:a("error.notFound")}),e.jsx(N,{asChild:!0,className:"mt-4",children:e.jsx(Y,{to:Fe,children:a("common.back")})})]})});const qe=new Date(n.start_date),oe=n.end_date?new Date(n.end_date):null,Be=oe?new Date<=oe:new Date>=qe;return e.jsx(ka,{onRefresh:ws,children:e.jsxs("div",{className:"min-h-screen bg-secondary/20",children:[e.jsxs("div",{className:"relative h-[33vh] overflow-hidden",children:[n.media_type==="video"&&n.video_url?e.jsx("video",{src:n.video_url,poster:n.image_url||void 0,className:"w-full h-full object-cover",muted:!0,loop:!0,playsInline:!0,autoPlay:!0}):e.jsx("img",{src:n.image_url||"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=1200&q=80",alt:A.title,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent"}),e.jsx(N,{asChild:!0,variant:"secondary",size:"icon",className:"absolute top-4 left-4",children:e.jsx(Y,{to:Fe,children:e.jsx(Vs,{className:"w-5 h-5"})})}),t&&te&&m&&!m.activity_terms_agreed&&e.jsxs(Y,{to:"/profile?tab=activities",className:"absolute top-4 left-16 bg-destructive/95 backdrop-blur-sm text-destructive-foreground text-xs px-3 py-1.5 rounded-full shadow-lg whitespace-nowrap animate-pulse flex items-center gap-1.5 hover:bg-destructive transition-colors",children:[e.jsx(We,{className:"w-3.5 h-3.5"}),a("activities.termsNotAgreed")]}),e.jsxs("div",{className:"absolute top-4 right-4 flex gap-2 items-start",children:[n.status==="draft"&&p&&e.jsxs(F,{variant:"outline",className:"bg-amber-500/90 text-white border-amber-600",children:[e.jsx(Xs,{className:"w-3 h-3 mr-1"}),a("admin.activities.draftPreview")]}),n.pinned&&e.jsx(F,{className:"bg-accent",children:a("activities.pinned")}),e.jsx($a,{targetType:"activity",targetId:n.id,onLoginRequired:()=>fe(!0),trigger:e.jsx(N,{variant:"secondary",size:"icon",className:"shadow-lg",children:e.jsx(We,{className:"w-5 h-5"})})}),e.jsxs("div",{className:"relative",children:[e.jsxs(N,{variant:"secondary",size:"icon",className:"shadow-lg relative",onClick:Ms,children:[e.jsx(q,{className:"w-5 h-5"}),H&&!V&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-primary text-primary-foreground rounded-full w-4 h-4 flex items-center justify-center",children:e.jsx(me,{className:"w-2.5 h-2.5"})}),H&&V&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center",children:e.jsx(de,{className:"w-2.5 h-2.5"})})]}),t&&H&&!V&&xe&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-primary/95 backdrop-blur-sm text-primary-foreground text-xs px-3 py-1.5 rounded-full shadow-lg whitespace-nowrap animate-pulse z-10",children:[e.jsx(me,{className:"w-3 h-3 inline mr-1"}),a("activities.shareToGetCoupon")]})]})]})]}),e.jsx("div",{className:"container mx-auto max-w-6xl px-4 -mt-20 relative z-10 pb-12",children:e.jsxs(B,{className:"shadow-large",children:[e.jsxs(ee,{className:"relative",children:[e.jsx("div",{className:"hidden sm:block absolute top-4 right-4",children:e.jsx(ts,{children:e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(Ke,{className:"w-4 h-4"}),a("activities.handbook.button")]})})}),e.jsxs("div",{className:"flex flex-col gap-4 sm:pr-32",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(F,{variant:Be?"default":"secondary",children:a(Be?"activities.ongoing":"activities.ended")}),n.repeat_mode&&n.repeat_mode!=="none"&&n.repeat_mode!=="days_before"&&e.jsx(F,{variant:"outline",children:a(`activities.repeat.${n.repeat_mode}`)}),n.service_type&&e.jsxs(F,{variant:"outline",className:"flex items-center gap-1.5",children:[n.service_type==="dine_in"&&e.jsx(Ne,{className:"w-3.5 h-3.5"}),n.service_type==="takeaway"&&e.jsx(Ue,{className:"w-3.5 h-3.5"}),n.service_type==="both"&&e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"w-3.5 h-3.5"}),e.jsx(Ue,{className:"w-3.5 h-3.5"})]}),a(`activities.serviceType.${n.service_type}`)]}),e.jsx("div",{className:"sm:hidden",children:e.jsx(ts,{children:e.jsxs(N,{variant:"outline",size:"sm",className:"gap-1.5 h-7 px-2",children:[e.jsx(Ke,{className:"w-3.5 h-3.5"}),a("activities.handbook.button")]})})})]}),e.jsx(Je,{className:"text-3xl",children:A.title}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap gap-x-6 gap-y-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Zs,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[as(qe,"PPP"),oe&&` - ${as(oe,"PPP")}`]})]}),e.jsx(it,{activityId:s,initialCount:Ds}),e.jsx(nt,{activityId:s,initialCount:Ls}),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(ne,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[X?.length||0," ",a("activities.restaurantsParticipating")]})]}),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Js,{className:"w-4 h-4 shrink-0"}),e.jsx("span",{children:a("activities.creatorLabel")}),E?.isAdmin?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("img",{src:es,alt:"Platform",className:"w-4 h-4 rounded-full object-contain"}),e.jsx("span",{className:"font-medium",children:a("activities.createdByPlatform")})]}):E?.restaurant?e.jsxs(Y,{to:`/restaurant/${E.restaurant.id}`,className:"flex items-center gap-1",onClick:r=>r.stopPropagation(),children:[E.avatar_url?e.jsxs(da,{className:"w-4 h-4",children:[e.jsx(ma,{src:E.avatar_url,alt:"Creator"}),e.jsx(ua,{className:"text-[8px]",children:E.restaurant.name.charAt(0)})]}):e.jsx("div",{className:"w-4 h-4 rounded-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-[8px] font-medium",children:E.restaurant.name.charAt(0)})}),e.jsx("span",{className:"text-primary font-medium hover:underline",children:(()=>{const r=st.language;return r==="zh"?E.restaurant.name:r==="pt"?E.restaurant.name_pt||E.restaurant.name_en||E.restaurant.name:E.restaurant.name_en||E.restaurant.name})()})]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("img",{src:es,alt:"Platform",className:"w-4 h-4 rounded-full object-contain"}),e.jsx("span",{className:"font-medium",children:a("activities.createdByPlatform")})]})]})]}),t&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full sm:w-auto",children:[te&&O.length>0&&(m?.activity_terms_agreed?e.jsx(N,{onClick:Ts,disabled:$.isPending,size:"lg",variant:re?"outline":"default",className:"w-full sm:w-auto",children:v?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"选择参与的餐厅"]}):re?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"退出活动"]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"参与活动"]})}):e.jsx(N,{onClick:()=>Pe(!0),size:"lg",variant:"outline",className:"w-full sm:w-auto text-muted-foreground",children:a("activities.agreeTermsFirst")})),e.jsx(N,{onClick:As,disabled:we.isPending,size:"lg",variant:Oe?"outline":"secondary",className:"w-full sm:w-auto",children:Oe?e.jsxs(e.Fragment,{children:[e.jsx(Qe,{className:"w-4 h-4 mr-2 fill-current"}),a("activities.favorited")||"已收藏"]}):e.jsxs(e.Fragment,{children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),a("activities.favorite")||"收藏活动"]})})]}),!t&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:e.jsx(Ys,{i18nKey:"activities.signInToJoin",components:{login:e.jsx("a",{href:"/auth",className:"text-primary hover:underline font-medium"})}})}),e.jsxs("p",{className:"text-xs text-muted-foreground/80 flex items-center gap-1.5",children:[e.jsx(rs,{className:"w-3.5 h-3.5"}),a("activities.signInToJoinHint")]})]})]})]}),e.jsxs(U,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:a("activities.about")}),e.jsx("div",{className:`prose prose-sm max-w-none text-muted-foreground\r
                  prose-headings:text-foreground prose-headings:font-semibold\r
                  prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg\r
                  prose-p:leading-relaxed prose-p:my-3\r
                  prose-strong:text-foreground prose-strong:font-semibold\r
                  prose-ul:my-3 prose-ol:my-3\r
                  prose-li:my-1\r
                  prose-a:text-primary prose-a:no-underline hover:prose-a:underline\r
                  [&_*]:!text-inherit [&_span[style*='color']]:!text-muted-foreground`,dangerouslySetInnerHTML:{__html:A.content}})]}),A.usage_instructions&&e.jsxs(e.Fragment,{children:[e.jsx(Ye,{}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(_e,{className:"w-6 h-6 text-primary"}),a("activities.usageInstructions")]}),e.jsx("div",{className:`prose prose-sm max-w-none text-muted-foreground\r
                      prose-headings:text-foreground prose-headings:font-semibold\r
                      prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg\r
                      prose-p:leading-relaxed prose-p:my-3\r
                      prose-strong:text-foreground prose-strong:font-semibold\r
                      prose-ul:my-3 prose-ol:my-3\r
                      prose-li:my-1\r
                      prose-a:text-primary prose-a:no-underline hover:prose-a:underline`,dangerouslySetInnerHTML:{__html:A.usage_instructions}})]})]}),e.jsx(Ye,{}),ks?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(se,{className:"w-6 h-6 animate-spin text-primary"})}):X&&X.length>0?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Na,{open:g,onOpenChange:w,children:e.jsxs(B,{className:"border-primary/20 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden",children:[e.jsx(ee,{className:"pb-3",children:e.jsx(ba,{asChild:!0,children:e.jsxs("div",{className:"flex items-center justify-between cursor-pointer group",children:[e.jsxs(Je,{className:"text-lg font-semibold flex items-center gap-2 transition-colors duration-200 group-hover:text-primary",children:[e.jsx(ne,{className:"w-5 h-5 transition-transform duration-300 group-hover:scale-110"}),a("activities.participatingRestaurants")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{variant:"secondary",className:"transition-opacity duration-200",children:a(g?"common.showLess":"common.showDetails")}),e.jsx("div",{className:"transition-transform duration-300 ease-in-out",style:{transform:g?"rotate(180deg)":"rotate(0deg)"},children:e.jsx(Ge,{className:"w-5 h-5 text-muted-foreground group-hover:text-primary"})})]})]})})}),e.jsx(ya,{className:"overflow-hidden transition-all duration-500 ease-in-out data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",children:e.jsxs(U,{className:"pt-0 pb-6 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-end",children:T?e.jsxs(F,{variant:"default",className:"flex items-center gap-1.5 cursor-pointer hover:opacity-80 transition-opacity",onClick:Is,children:[e.jsx(be,{className:"w-3.5 h-3.5"}),a("activities.sortByLocationEnabled")]}):e.jsxs(N,{variant:"outline",size:"sm",onClick:Ps,disabled:y,children:[y?e.jsx(se,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(be,{className:"w-4 h-4 mr-2"}),a("activities.enableLocationSort")]})}),e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:(l?J:J.slice(0,6)).map((r,S)=>{const b=u(r.restaurants);return e.jsxs(B,{className:"overflow-hidden hover:shadow-lg transition-all duration-300 opacity-0 animate-fade-in h-full flex flex-col",style:{animationDelay:`${S*50}ms`,animationFillMode:"forwards"},children:[e.jsx(Y,{to:`/restaurant/${r.restaurant_id}`,state:{fromActivity:n.id},className:"block",children:e.jsxs("div",{className:"relative h-40 overflow-hidden flex-shrink-0",children:[e.jsx("img",{src:r.restaurants.image_url||"https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&q=80",alt:b.name,className:"w-full h-full object-cover transition-transform hover:scale-105"}),b.type&&b.type.length>0&&e.jsx("div",{className:"absolute top-2 left-2 flex flex-wrap gap-1",children:b.type.slice(0,3).map((_,He)=>e.jsx(F,{className:"bg-primary",children:_},He))})]})}),e.jsxs(U,{className:"pt-4 pb-4 flex flex-col flex-grow",children:[e.jsxs(Y,{to:`/restaurant/${r.restaurant_id}`,state:{fromActivity:n.id},className:"block",children:[e.jsx("h3",{className:"font-semibold text-lg mb-2 line-clamp-1 hover:text-primary transition-colors",children:ns(b.name)}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-3",children:[e.jsx(Se,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-1",children:r.restaurants.address})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-3 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ea,{className:`w-4 h-4 ${r.restaurants.rating?"fill-accent text-accent":"text-muted-foreground"}`}),r.restaurants.rating?e.jsx("span",{className:"font-semibold text-sm",children:r.restaurants.rating.toFixed(1)}):e.jsxs("span",{className:"text-xs text-muted-foreground text-center whitespace-nowrap",children:[a("restaurant.noRatingLine1"),e.jsx("br",{}),a("restaurant.noRatingLine2")]})]}),r.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(be,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"font-semibold text-sm text-foreground",children:[r.distance.toFixed(1)," km"]})]})]}),r.restaurants.website_url&&e.jsx("div",{className:"flex gap-2 mt-3 pt-3 border-t border-border/50",children:e.jsxs(N,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>Ns(r.restaurants.website_url,r.restaurants.id),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),a("restaurant.orderOnline")]})})]})]},r.id)})}),J.length>6&&!l&&e.jsxs(N,{variant:"outline",className:"w-full hover:bg-primary hover:text-primary-foreground transition-all duration-200",onClick:()=>h(!0),children:[e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"查看更多 (",J.length-6," 个餐厅)"]})]})})]})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2 mb-4",children:[e.jsx(Se,{className:"w-6 h-6"}),a("activities.participatingRestaurants")," (",J.length,")"]}),e.jsx(ms,{restaurants:J,onMarkerClick:ys})]})]}):null,e.jsx(Fa,{restaurantId:n.id,targetType:"activity"})]})]})}),v&&e.jsx(tt,{open:L,onOpenChange:he,restaurants:O,participatingRestaurantIds:W,onConfirm:Es,isPending:$.isPending,isParticipating:re}),te&&e.jsx(qa,{isAgreed:m?.activity_terms_agreed||!1,agreedAt:m?.activity_terms_agreed_at||null,open:us,onOpenChange:Pe}),e.jsx(rt,{open:xs,onOpenChange:pe,activityTitle:A?.title||"",activityId:s,onShareComplete:zs,onShareAction:Fs,isProcessing:gs,hasAlreadyClaimed:V}),e.jsx(Ua,{open:ps,onOpenChange:ge,onConfirm:Rs}),e.jsx(ha,{open:fs,onOpenChange:fe,children:e.jsxs(xa,{children:[e.jsxs(pa,{children:[e.jsx(ga,{children:a("activities.loginRequired")}),e.jsx(fa,{children:a("activities.loginRequiredMessage")})]}),e.jsxs(ja,{children:[e.jsx(va,{children:a("common.cancel")}),e.jsx(wa,{onClick:()=>x("/auth"),children:a("activities.goToLogin")})]})]})}),e.jsx(Ca,{open:js,onOpenChange:je,onConfirm:bs,url:ae||void 0}),vs]})})};export{Ht as default};
//# sourceMappingURL=ActivityDetail-BJ6_TCmM.js.map
