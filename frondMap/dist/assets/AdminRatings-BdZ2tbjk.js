import{u as _,k as $,af as H,r as d,ag as b,j as s,B as k,C as N,f as v,I as R,aa as J,s as L}from"./index-DjxB8hoH.js";import{n as W}from"./useAdmin-AKXqQ7Zm.js";import{u as X}from"./useLocalizedContent-qVyUbtVE.js";import{u as Y,P as Z,a as ee,b as l,c as se,d as te,f as ae}from"./usePagination-He2BE_Vo.js";import{S as q}from"./save-C-iPdE9a.js";import{S as ne}from"./search-CS9G3xHd.js";import{S as ie}from"./star-BbfM7Axl.js";import"./chevron-left-BVUAV8vX.js";import"./ellipsis-D_bPBYiU.js";const ge=()=>{const{t:n}=_(),{toast:m}=$(),o=H(),{data:u,isLoading:E}=W(),{getLocalizedField:x}=X(),[r,Q]=d.useState(""),[i,h]=d.useState({}),[F,y]=d.useState(new Set),K=d.useMemo(()=>u?u.filter(e=>r===""||x(e,"name").toString().toLowerCase().includes(r.toLowerCase())||e.address.toLowerCase().includes(r.toLowerCase())):[],[u,r,x]),{currentPage:c,totalPages:g,paginatedData:p,goToPage:A,nextPage:I,previousPage:T,canGoNext:z,canGoPrevious:M,startIndex:O,endIndex:B,totalItems:G}=Y({data:K,itemsPerPage:20}),w=b({mutationFn:async({restaurantId:e,rating:t})=>{const{error:a}=await L.from("restaurants").update({rating:t}).eq("id",e);if(a)throw a;return e},onSuccess:e=>{o.invalidateQueries({queryKey:["admin-restaurants"]}),o.invalidateQueries({queryKey:["restaurants"]}),y(t=>new Set([...t,e])),h(t=>{const a={...t};return delete a[e],a}),setTimeout(()=>{y(t=>{const a=new Set(t);return a.delete(e),a})},2e3)},onError:e=>{m({title:n("common.error"),description:e.message,variant:"destructive"})}}),S=b({mutationFn:async()=>{const e=Object.entries(i).map(([t,a])=>({id:t,rating:parseFloat(a)||0}));for(const t of e){const{error:a}=await L.from("restaurants").update({rating:t.rating}).eq("id",t.id);if(a)throw a}return e.length},onSuccess:e=>{o.invalidateQueries({queryKey:["admin-restaurants"]}),o.invalidateQueries({queryKey:["restaurants"]}),h({}),m({title:n("common.success"),description:n("admin.ratings.updated",{count:e})})},onError:e=>{m({title:n("common.error"),description:e.message,variant:"destructive"})}}),U=(e,t)=>{if(t===""||/^\d*\.?\d*$/.test(t)){const a=parseFloat(t);(t===""||a>=0&&a<=5)&&h(f=>({...f,[e]:t}))}},C=e=>{const t=parseFloat(i[e]||"0");t>=0&&t<=5&&w.mutate({restaurantId:e,rating:t})},D=(e,t)=>{e.key==="Enter"&&C(t)},V=Object.keys(i).length>0;return E?s.jsx("div",{className:"text-center",children:n("common.loading")}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl md:text-3xl font-bold mb-2",children:n("admin.ratings.title")}),s.jsx("p",{className:"text-muted-foreground",children:n("admin.ratings.description")})]}),V&&s.jsxs(k,{onClick:()=>S.mutate(),disabled:S.isPending,children:[s.jsx(q,{className:"mr-2 h-4 w-4"}),n("admin.ratings.saveAll")," (",Object.keys(i).length,")"]})]}),s.jsx(N,{children:s.jsx(v,{className:"pt-6",children:s.jsxs("div",{className:"relative max-w-md",children:[s.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(R,{placeholder:n("admin.ratings.searchPlaceholder"),value:r,onChange:e=>Q(e.target.value),className:"pl-9"})]})})}),s.jsx(N,{className:"bg-muted/50",children:s.jsx(v,{className:"pt-6",children:s.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[s.jsxs("p",{children:["• ",n("admin.ratings.instruction1")]}),s.jsxs("p",{children:["• ",n("admin.ratings.instruction2")]}),s.jsxs("p",{children:["• ",n("admin.ratings.instruction3")]})]})})}),s.jsx("div",{className:"flex items-center justify-between pb-2 border-b",children:s.jsx("span",{className:"text-sm text-muted-foreground",children:n("admin.ratings.showing",{start:O,end:B,total:G})})}),s.jsx("div",{className:"grid gap-3",children:p==null?void 0:p.map(e=>{var P;const t=i[e.id]??(((P=e.rating)==null?void 0:P.toString())||"0"),a=e.id in i,f=F.has(e.id);return s.jsx(N,{className:a?"border-primary/50":"",children:s.jsx(v,{className:"py-4",children:s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("h3",{className:"font-medium truncate",children:x(e,"name")}),f&&s.jsxs("span",{className:"flex items-center text-green-600 text-sm",children:[s.jsx(J,{className:"h-4 w-4 mr-1"}),n("admin.ratings.saved")]})]}),s.jsx("p",{className:"text-sm text-muted-foreground truncate",children:e.address})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[s.jsx(ie,{className:"h-4 w-4 fill-accent text-accent"}),s.jsx("span",{className:"text-sm",children:n("admin.ratings.current")}),s.jsx("span",{className:"font-medium",children:e.rating||0})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(R,{type:"text",inputMode:"decimal",value:t,onChange:j=>U(e.id,j.target.value),onKeyPress:j=>D(j,e.id),className:"w-20 text-center",placeholder:"0-5"}),s.jsx(k,{size:"sm",variant:a?"default":"outline",onClick:()=>C(e.id),disabled:!a||w.isPending,children:s.jsx(q,{className:"h-4 w-4"})})]})]})]})})},e.id)})}),g>1&&s.jsx(Z,{className:"mt-6",children:s.jsxs(ee,{children:[s.jsx(l,{children:s.jsx(se,{onClick:T,className:M?"cursor-pointer":"pointer-events-none opacity-50"})}),Array.from({length:g},(e,t)=>t+1).map(e=>e===1||e===g||e>=c-1&&e<=c+1?s.jsx(l,{children:s.jsx(te,{onClick:()=>A(e),isActive:c===e,className:"cursor-pointer",children:e})},e):e===c-2||e===c+2?s.jsx(l,{children:"..."},e):null),s.jsx(l,{children:s.jsx(ae,{onClick:I,className:z?"cursor-pointer":"pointer-events-none opacity-50"})})]})})]})};export{ge as default};
