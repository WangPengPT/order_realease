import{p as ce,r as c,c9 as re,u as fe,j as e,bK as pe,am as xe,aM as ie,ca as we,cb as be,aN as je}from"./vendor-react-COnB1Bf9.js";import{u as ye,b as Ne,Z as Se,i as Z,B as oe,S as ke,I as ve,o as Ce}from"./index-T7L6ozN1.js";import{L as Re}from"./LocationPermissionDialog-DnJZycA9.js";import{E as Ae}from"./ExternalLinkConfirmDialog-Bkoi4Xoy.js";const G="https://tzdgqhwyzsxkxnncgzap.supabase.co",B="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",Ie=["最近","附近","离我","距离","远近","近的","周边","周围","最近的","附近的","nearest","closest","nearby","near me","close to me","distance","around me","mais perto","próximo","perto de mim","distância","mais próximo"],Ee=()=>{const x="xiaoxiong_anonymous_user_id";let C=localStorage.getItem(x);return C||(C=`anon_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(x,C)),C},ze=(x="ask-xiaoxiong")=>{const{i18n:C}=ce(),{user:T}=ye(),[E,V]=c.useState(""),[_,S]=c.useState([]),[U,H]=c.useState(!1),[O,F]=c.useState(null),[Q,M]=c.useState(!1),[W,X]=c.useState(null),R=c.useRef(null),k=c.useCallback(()=>T?.id?T.id:Ee(),[T?.id]),K=c.useCallback(n=>{const h=n.toLowerCase();return Ie.some(o=>h.includes(o))},[]),ee=async(n,h)=>{const o=await fetch(`${G}/functions/v1/ask-xiaoxiong`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`,apikey:B},body:JSON.stringify({text:n.content,stream:!0,lat:O?.lat,lng:O?.lng}),signal:R.current?.signal});if(!o.ok)throw new Error(`Request failed with status: ${o.status}`);if(!o.body)throw new Error("No response body");const f=o.body.getReader(),j=new TextDecoder;let g="";for(;;){const{done:d,value:a}=await f.read();if(d)break;const y=j.decode(a,{stream:!0});g+=y;let i=g;i.startsWith('"')&&(i=i.slice(1)),i.endsWith('"')&&(i=i.slice(0,-1)),i=i.replace(/\\n/g,`
`),S(p=>p.map(I=>I.id===h?{...I,content:i}:I))}let l=g;l.startsWith('"')&&(l=l.slice(1)),l.endsWith('"')&&(l=l.slice(0,-1)),l=l.replace(/\\n/g,`
`),S(d=>d.map(a=>a.id===h?{...a,content:l,isStreaming:!1}:a))},te=async(n,h)=>{const o=k(),f=await fetch(`${G}/functions/v1/xiaoxiong-agent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`,apikey:B},body:JSON.stringify({message:n.content,userId:o}),signal:R.current?.signal});if(!f.ok)throw new Error(`Request failed with status: ${f.status}`);if(!f.body)throw new Error("No response body");const j=f.body.getReader(),g=new TextDecoder;let l="";for(;;){const{done:d,value:a}=await j.read();if(d)break;const y=g.decode(a,{stream:!0});l+=y,re.flushSync(()=>{S(i=>i.map(p=>p.id===h?{...p,content:l}:p))}),await new Promise(i=>requestAnimationFrame(i))}S(d=>d.map(a=>a.id===h?{...a,isStreaming:!1}:a))},z=async(n,h)=>{const o=await fetch(`${G}/functions/v1/lovable-chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`,apikey:B},body:JSON.stringify({message:n.content,lat:O?.lat,lng:O?.lng,language:C.language}),signal:R.current?.signal});if(!o.ok){const d=await o.json().catch(()=>({}));throw new Error(d.error||`Request failed with status: ${o.status}`)}if(!o.body)throw new Error("No response body");const f=o.body.getReader(),j=new TextDecoder;let g="",l="";for(;;){const{done:d,value:a}=await f.read();if(d)break;l+=j.decode(a,{stream:!0});let y;for(;(y=l.indexOf(`
`))!==-1;){let i=l.slice(0,y);if(l=l.slice(y+1),i.endsWith("\r")&&(i=i.slice(0,-1)),i.startsWith(":")||i.trim()===""||!i.startsWith("data: "))continue;const p=i.slice(6).trim();if(p==="[DONE]")break;try{const q=JSON.parse(p).choices?.[0]?.delta?.content;q&&(g+=q,re.flushSync(()=>{S(w=>w.map(D=>D.id===h?{...D,content:g}:D))}),await new Promise(w=>requestAnimationFrame(w)))}catch{}}}S(d=>d.map(a=>a.id===h?{...a,isStreaming:!1}:a))},Y=async(n,h)=>{const o=_.filter(a=>a.content&&!a.isStreaming).map(a=>({role:a.role,content:a.content}));o.push({role:"user",content:n.content});const f=await fetch(`${G}/functions/v1/xiaoxiong-community`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`,apikey:B},body:JSON.stringify({messages:o,includeContext:!0}),signal:R.current?.signal});if(!f.ok){const a=await f.json().catch(()=>({}));throw new Error(a.error||`Request failed with status: ${f.status}`)}if(!f.body)throw new Error("No response body");const j=f.body.getReader(),g=new TextDecoder;let l="",d="";for(;;){const{done:a,value:y}=await j.read();if(a)break;d+=g.decode(y,{stream:!0});let i;for(;(i=d.indexOf(`
`))!==-1;){let p=d.slice(0,i);if(d=d.slice(i+1),p.endsWith("\r")&&(p=p.slice(0,-1)),p.startsWith(":")||p.trim()===""||!p.startsWith("data: "))continue;const I=p.slice(6).trim();if(I==="[DONE]")break;try{const w=JSON.parse(I).choices?.[0]?.delta?.content;w&&(l+=w,re.flushSync(()=>{S(D=>D.map(P=>P.id===h?{...P,content:l}:P))}),await new Promise(D=>requestAnimationFrame(D)))}catch{}}}S(a=>a.map(y=>y.id===h?{...y,isStreaming:!1}:y))},A=c.useCallback(async n=>{const h={id:Date.now().toString(),role:"user",content:n},o=(Date.now()+1).toString(),f={id:o,role:"assistant",content:"",isStreaming:!0};S(j=>[...j,h,f]),V(""),H(!0),R.current&&R.current.abort(),R.current=new AbortController;try{x==="xiaoxiong-community"?await Y(h,o):x==="lovable-ai"?await z(h,o):x==="xiaoxiong-agent"?await te(h,o):await ee(h,o)}catch(j){if(j instanceof Error&&j.name==="AbortError"){console.log("Request aborted");return}console.error("Ask API error:",j);const g=C.language==="zh"?"抱歉，暂时无法获取结果，请稍后再试":C.language==="pt"?"Desculpe, não foi possível obter resultados. Tente novamente mais tarde.":"Sorry, unable to get results. Please try again later.";S(l=>l.map(d=>d.id===o?{...d,content:g,isStreaming:!1}:d))}finally{H(!1)}},[x,O,C.language,k]),L=c.useCallback(()=>{M(!1),navigator.geolocation?.getCurrentPosition(n=>{F({lat:n.coords.latitude,lng:n.coords.longitude}),W&&setTimeout(()=>{A(W),X(null)},100)},n=>{console.log("Location permission denied:",n.message),W&&(A(W),X(null))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},[W,A]),$=c.useCallback(async()=>{if(!E.trim()||U)return;const n=E.trim();if(!O&&K(n)){X(n),M(!0),V("");return}await A(n)},[E,U,O,K,A]),se=c.useCallback(n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),$())},[$]),J=c.useCallback(()=>{R.current&&R.current.abort()},[]),ne=c.useCallback(()=>{navigator.geolocation?.getCurrentPosition(n=>{F({lat:n.coords.latitude,lng:n.coords.longitude})},n=>{console.log("Unable to get user location:",n.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5})},[]);return{input:E,setInput:V,messages:_,isLoading:U,showLocationDialog:Q,setShowLocationDialog:M,pendingMessage:W,setPendingMessage:X,handleSubmit:$,handleKeyDown:se,handleLocationConfirm:L,processMessage:A,abortRequest:J,requestLocation:ne}},Oe=()=>!!(window.webkit?.messageHandlers?.VoiceBridge||window.VoiceBridge),le={start:()=>{const x=JSON.stringify({action:"start"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(x):window.VoiceBridge&&window.VoiceBridge.postMessage(x)},stop:()=>{const x=JSON.stringify({action:"stop"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(x):window.VoiceBridge&&window.VoiceBridge.postMessage(x)}},Be=({messages:x,input:C,setInput:T,isLoading:E,showLocationDialog:V,setShowLocationDialog:_,pendingMessage:S,handleSubmit:U,handleKeyDown:H,handleLocationConfirm:O,processMessage:F,setPendingMessage:Q,onClose:M,showBackButton:W=!1,showHeader:X=!0,className:R})=>{const{i18n:k}=ce(),K=fe(),{settings:ee}=Ne(),{data:te}=Se(),z=ee?.logo_url,Y=te?.avatar_url,[A,L]=c.useState(!1),[$,se]=c.useState(!1),[J,ne]=c.useState(!1),[n,h]=c.useState(!1),[o,f]=c.useState(null),j=c.useRef(null),g=c.useRef(null),l=c.useRef(null);c.useEffect(()=>{const t=window.SpeechRecognition||window.webkitSpeechRecognition;return se(!!t),ne(Oe()),window.onSpeechResult=u=>{T(u),L(!1)},()=>{window.onSpeechResult=void 0}},[T]),c.useEffect(()=>{l.current?.scrollIntoView({behavior:"smooth"})},[x]),c.useEffect(()=>()=>{g.current&&g.current.stop()},[]);const d=()=>$||J,a=()=>{if(J){le.start(),L(!0);return}const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t)return;g.current&&g.current.stop();const u=new t;g.current=u;const s={zh:"zh-CN",en:"en-US",pt:"pt-BR"};u.lang=s[k.language]||"zh-CN",u.continuous=!1,u.interimResults=!0,u.onstart=()=>L(!0),u.onresult=b=>{const r=Array.from(b.results).map(m=>m[0].transcript).join("");T(r)},u.onerror=()=>L(!1),u.onend=()=>L(!1),u.start()},y=()=>{if(J){le.stop(),L(!1);return}g.current&&(g.current.stop(),L(!1))},i=()=>{A?y():a()},p=t=>{M?.(),K(t)},I=t=>{f(t),h(!0)},q=()=>{o&&Ce(o),h(!1),f(null)},w=t=>{const u=/\[([^\]]+)\]\(([^)]+)\)/g,s=[];let b=0,r,m=0;for(;(r=u.exec(t))!==null;){r.index>b&&s.push(e.jsx("span",{children:t.slice(b,r.index)},m++));const v=r[1],N=r[2];if(N.startsWith("/"))s.push(e.jsx("button",{onClick:()=>p(N),className:"text-primary hover:underline font-medium cursor-pointer",children:v},m++));else if(N.startsWith("!external:")){const ae=N.slice(10);s.push(e.jsx("button",{onClick:()=>I(ae),className:"text-primary hover:underline font-medium cursor-pointer",children:v},m++))}else N.startsWith("http://")||N.startsWith("https://")?s.push(e.jsx("button",{onClick:()=>I(N),className:"text-primary hover:underline font-medium cursor-pointer",children:v},m++)):s.push(e.jsx("a",{href:N,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline font-medium",children:v},m++));b=r.index+r[0].length}return b<t.length&&s.push(e.jsx("span",{children:t.slice(b)},m++)),s.length>0?s:[e.jsx("span",{children:t},"0")]},D=t=>t.replace(/\*\*(.*?)\*\*/g,"$1"),P=(t,u=20)=>t.length<=u?t:t.slice(0,u)+"...",de=(t,u)=>{const s=m=>m.split("|").slice(1,-1).map(v=>D(v.trim())),b=s(t[0]),r=t.slice(2).map(s);return e.jsx("div",{className:"overflow-x-auto my-2 max-w-full",children:e.jsxs("table",{className:"w-full text-xs border border-border rounded-md overflow-hidden table-fixed",children:[e.jsx("thead",{className:"bg-muted/60",children:e.jsx("tr",{children:b.map((m,v)=>e.jsx("th",{className:"px-2 py-2 text-left font-semibold border-b border-border truncate max-w-[100px]",title:m,children:w(P(m,15))},v))})}),e.jsx("tbody",{children:r.map((m,v)=>e.jsx("tr",{className:"border-b border-border last:border-0 hover:bg-muted/30 transition-colors",children:m.map((N,ae)=>e.jsx("td",{className:"px-2 py-2 truncate max-w-[100px]",title:N,children:w(P(N,18))},ae))},v))})]})},u)},ue=t=>{const u=t.split(`
`),s=[];let b=0;for(;b<u.length;){const r=u[b];if(r.trim().startsWith("|")&&r.split("|").length>2){const m=[];for(;b<u.length&&u[b].trim().startsWith("|");)m.push(u[b]),b++;m.length>=2&&s.push(de(m,s.length));continue}if(r.startsWith("### "))s.push(e.jsx("h3",{className:"text-base font-semibold mt-3 mb-1",children:w(r.slice(4))},s.length));else if(r.startsWith("## "))s.push(e.jsx("h2",{className:"text-lg font-bold mt-4 mb-2",children:w(r.slice(3))},s.length));else if(r.startsWith("# "))s.push(e.jsx("h1",{className:"text-xl font-bold mt-4 mb-2",children:w(r.slice(2))},s.length));else if(r.includes("**")){const m=r.split(/\*\*(.*?)\*\*/g);s.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:m.map((v,N)=>N%2===1?e.jsx("strong",{className:"font-semibold",children:w(v)},N):w(v))},s.length))}else r.startsWith("- ")||r.startsWith("* ")?s.push(e.jsx("li",{className:"ml-4 mb-0.5 list-disc",children:w(r.slice(2))},s.length)):/^\d+\.\s/.test(r)?s.push(e.jsx("li",{className:"ml-4 mb-0.5 list-decimal",children:w(r.replace(/^\d+\.\s/,""))},s.length)):r.match(/^[-*_]{3,}$/)?s.push(e.jsx("hr",{className:"my-3 border-border"},s.length)):r.trim()===""?s.push(e.jsx("div",{className:"h-1"},s.length)):s.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:w(r)},s.length));b++}return s},he=()=>k.language==="zh"?"小熊AI助手":k.language==="pt"?"Assistente IA Xiaoxiong":"Xiaoxiong AI Assistant",me=()=>k.language==="zh"?"告诉小熊，你想吃什么...":k.language==="pt"?"Diga ao Xiaoxiong o que você quer comer...":"Tell Xiaoxiong what you want to eat...",ge=()=>k.language==="zh"?"你好，我是小熊，我来帮你推荐餐厅；比如：「我附近的寿司餐厅」":k.language==="pt"?"Olá, eu sou o Xiaoxiong, vou te ajudar a encontrar restaurantes; por exemplo: 「restaurantes de sushi perto de mim」":`Hi, I'm Xiaoxiong, I'll help you find restaurants; for example: "sushi restaurants near me"`;return e.jsxs("div",{className:Z("flex flex-col h-full bg-background overflow-hidden",R),children:[X&&e.jsxs("div",{className:"px-4 py-3 shrink-0 border-b flex items-center gap-2 bg-background sticky top-0 z-10",children:[W&&e.jsx(oe,{variant:"ghost",size:"icon",onClick:M,className:"shrink-0",children:e.jsx(pe,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[z&&e.jsx("img",{src:z,alt:"Logo",className:"w-8 h-8 rounded-full object-cover"}),e.jsx("h1",{className:"text-base font-semibold",children:he()})]})]}),e.jsx(ke,{className:"flex-1 min-h-0 overflow-auto",ref:j,children:e.jsxs("div",{className:"p-4 space-y-4",children:[x.length===0&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:z&&e.jsx("img",{src:z,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:"flex-1 bg-muted rounded-lg px-3 py-2 text-sm",children:ge()})]}),x.map(t=>e.jsxs("div",{className:Z("flex gap-3",t.role==="user"&&"flex-row-reverse"),children:[t.role==="user"?e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:Y?e.jsx("img",{src:Y,alt:"User",className:"w-full h-full object-cover"}):e.jsx(xe,{className:"h-4 w-4"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:z&&e.jsx("img",{src:z,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:Z("flex-1 max-w-[85%] rounded-lg px-3 py-2 text-sm bg-muted"),children:t.role==="assistant"?e.jsxs(e.Fragment,{children:[t.content?e.jsx("div",{className:"prose-sm",children:ue(t.content)}):e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:k.language==="zh"?"思考中...":k.language==="pt"?"Pensando...":"Thinking..."})]}),t.isStreaming&&t.content&&e.jsx("span",{className:"inline-block w-1.5 h-4 bg-primary/50 animate-pulse ml-0.5 align-middle"})]}):t.content})]},t.id)),e.jsx("div",{ref:l})]})}),e.jsx("div",{className:"px-2 py-1.5 pb-[max(1.5rem,calc(env(safe-area-inset-bottom)+1rem))] md:pb-4 shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 rounded-full backdrop-blur-md border border-border/50 bg-muted/80 dark:bg-muted/60",children:[d()&&e.jsx(oe,{variant:"ghost",size:"icon",onClick:i,disabled:E,className:Z("bg-transparent hover:bg-transparent",A&&"text-destructive"),children:A?e.jsx(we,{className:"h-4 w-4"}):e.jsx(be,{className:"h-4 w-4"})}),e.jsx(ve,{value:C,onChange:t=>T(t.target.value),onKeyDown:H,placeholder:A?k.language==="zh"?"正在聆听...":"Listening...":me(),disabled:E,className:"flex-1 bg-transparent border-0 shadow-none focus-visible:ring-0 focus-visible:ring-offset-0"}),e.jsx(oe,{onClick:U,disabled:!C.trim()||E,size:"icon",variant:"ghost",className:"bg-transparent hover:bg-white/50 rounded-full",children:E?e.jsx(ie,{className:"h-4 w-4 animate-spin"}):e.jsx(je,{className:"h-4 w-4"})})]})}),e.jsx(Re,{open:V,onOpenChange:t=>{_(t),!t&&S&&(F(S),Q(null))},onConfirm:O}),e.jsx(Ae,{open:n,onOpenChange:h,onConfirm:q,url:o||void 0})]})};export{Be as X,ze as u};
//# sourceMappingURL=XiaoxiongChatContent-CI0Uth0_.js.map
