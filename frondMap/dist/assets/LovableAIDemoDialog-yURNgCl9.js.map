{"version":3,"file":"LovableAIDemoDialog-yURNgCl9.js","sources":["../../src/components/admin/LovableAIDemoDialog.tsx"],"sourcesContent":["import { useState, useRef, useEffect } from \"react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Send, Trash2, Loader2, Sparkles, User } from \"lucide-react\";\r\nimport { flushSync } from \"react-dom\";\r\n\r\ninterface Message {\r\n  role: \"user\" | \"assistant\";\r\n  content: string;\r\n}\r\n\r\ninterface LovableAIDemoDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n}\r\n\r\nexport function LovableAIDemoDialog({ open, onOpenChange }: LovableAIDemoDialogProps) {\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);\r\n  const scrollAreaRef = useRef<HTMLDivElement>(null);\r\n  const abortControllerRef = useRef<AbortController | null>(null);\r\n\r\n  // Get user location when dialog opens\r\n  useEffect(() => {\r\n    if (open && !userLocation) {\r\n      navigator.geolocation?.getCurrentPosition(\r\n        (position) => {\r\n          setUserLocation({\r\n            lat: position.coords.latitude,\r\n            lng: position.coords.longitude,\r\n          });\r\n        },\r\n        (error) => {\r\n          console.log(\"Unable to get user location:\", error.message);\r\n        },\r\n        { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 }\r\n      );\r\n    }\r\n  }, [open, userLocation]);\r\n\r\n  useEffect(() => {\r\n    if (scrollAreaRef.current) {\r\n      scrollAreaRef.current.scrollTop = scrollAreaRef.current.scrollHeight;\r\n    }\r\n  }, [messages]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!input.trim() || isLoading) return;\r\n\r\n    const userMessage: Message = { role: \"user\", content: input.trim() };\r\n    setMessages((prev) => [...prev, userMessage]);\r\n    setInput(\"\");\r\n    setIsLoading(true);\r\n\r\n    const assistantMessage: Message = { role: \"assistant\", content: \"\" };\r\n    setMessages((prev) => [...prev, assistantMessage]);\r\n\r\n    try {\r\n      abortControllerRef.current = new AbortController();\r\n\r\n      const response = await fetch(\r\n        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/lovable-chat`,\r\n        {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY}`,\r\n          },\r\n          body: JSON.stringify({\r\n            messages: [...messages, userMessage],\r\n            lat: userLocation?.lat,\r\n            lng: userLocation?.lng,\r\n          }),\r\n          signal: abortControllerRef.current.signal,\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({}));\r\n        throw new Error(errorData.error || `请求失败: ${response.status}`);\r\n      }\r\n\r\n      const reader = response.body?.getReader();\r\n      if (!reader) throw new Error(\"无法读取响应流\");\r\n\r\n      const decoder = new TextDecoder();\r\n      let buffer = \"\";\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split(\"\\n\");\r\n        buffer = lines.pop() || \"\";\r\n\r\n        for (const line of lines) {\r\n          if (!line.startsWith(\"data: \")) continue;\r\n          const jsonStr = line.slice(6).trim();\r\n          if (jsonStr === \"[DONE]\") continue;\r\n\r\n          try {\r\n            const parsed = JSON.parse(jsonStr);\r\n            const content = parsed.choices?.[0]?.delta?.content;\r\n            if (content) {\r\n              flushSync(() => {\r\n                setMessages((prev) => {\r\n                  const updated = [...prev];\r\n                  const lastMsg = updated[updated.length - 1];\r\n                  if (lastMsg?.role === \"assistant\") {\r\n                    lastMsg.content += content;\r\n                  }\r\n                  return updated;\r\n                });\r\n              });\r\n            }\r\n          } catch {\r\n            // 忽略解析错误\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      if ((error as Error).name === \"AbortError\") return;\r\n      \r\n      setMessages((prev) => {\r\n        const updated = [...prev];\r\n        const lastMsg = updated[updated.length - 1];\r\n        if (lastMsg?.role === \"assistant\") {\r\n          lastMsg.content = `错误: ${(error as Error).message}`;\r\n        }\r\n        return updated;\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n      abortControllerRef.current = null;\r\n    }\r\n  };\r\n\r\n  const handleClear = () => {\r\n    abortControllerRef.current?.abort();\r\n    setMessages([]);\r\n    setIsLoading(false);\r\n  };\r\n\r\n  const handleClose = (open: boolean) => {\r\n    if (!open) {\r\n      abortControllerRef.current?.abort();\r\n    }\r\n    onOpenChange(open);\r\n  };\r\n\r\n  const renderMarkdown = (text: string) => {\r\n    // 简单的 Markdown 渲染\r\n    let html = text\r\n      // 代码块\r\n      .replace(/```(\\w*)\\n([\\s\\S]*?)```/g, '<pre class=\"bg-muted p-2 rounded my-2 overflow-x-auto text-sm\"><code>$2</code></pre>')\r\n      // 行内代码\r\n      .replace(/`([^`]+)`/g, '<code class=\"bg-muted px-1 rounded text-sm\">$1</code>')\r\n      // 粗体\r\n      .replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>')\r\n      // 斜体\r\n      .replace(/\\*([^*]+)\\*/g, '<em>$1</em>')\r\n      // 链接\r\n      .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" target=\"_blank\" class=\"text-primary underline\">$1</a>')\r\n      // 换行\r\n      .replace(/\\n/g, '<br />');\r\n\r\n    return <span dangerouslySetInnerHTML={{ __html: html }} />;\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent className=\"max-w-2xl h-[600px] flex flex-col p-0\">\r\n        <DialogHeader className=\"p-4 pb-2 border-b\">\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <Sparkles className=\"h-5 w-5 text-purple-500\" />\r\n            Lovable AI 测试\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <ScrollArea className=\"flex-1 p-4\" ref={scrollAreaRef}>\r\n          <div className=\"space-y-4\">\r\n            {messages.length === 0 && (\r\n              <div className=\"text-center text-muted-foreground py-8\">\r\n                <Sparkles className=\"h-12 w-12 mx-auto mb-4 text-purple-500/50\" />\r\n                <p>发送消息开始测试 Lovable AI</p>\r\n                <p className=\"text-sm mt-2\">使用 google/gemini-3-flash-preview 模型</p>\r\n              </div>\r\n            )}\r\n\r\n            {messages.map((message, index) => (\r\n              <div\r\n                key={index}\r\n                className={`flex gap-3 ${message.role === \"user\" ? \"justify-end\" : \"justify-start\"}`}\r\n              >\r\n                {message.role === \"assistant\" && (\r\n                  <div className=\"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0\">\r\n                    <Sparkles className=\"h-4 w-4 text-purple-500\" />\r\n                  </div>\r\n                )}\r\n                <div\r\n                  className={`max-w-[80%] rounded-lg px-4 py-2 ${\r\n                    message.role === \"user\"\r\n                      ? \"bg-primary text-primary-foreground\"\r\n                      : \"bg-muted\"\r\n                  }`}\r\n                >\r\n                  {message.role === \"assistant\" ? (\r\n                    <div className=\"prose prose-sm dark:prose-invert max-w-none\">\r\n                      {message.content ? renderMarkdown(message.content) : (\r\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                      )}\r\n                    </div>\r\n                  ) : (\r\n                    <p className=\"whitespace-pre-wrap\">{message.content}</p>\r\n                  )}\r\n                </div>\r\n                {message.role === \"user\" && (\r\n                  <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\r\n                    <User className=\"h-4 w-4 text-primary\" />\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        <div className=\"p-4 border-t\">\r\n          <form onSubmit={handleSubmit} className=\"flex gap-2\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              size=\"icon\"\r\n              onClick={handleClear}\r\n              disabled={messages.length === 0 && !isLoading}\r\n            >\r\n              <Trash2 className=\"h-4 w-4\" />\r\n            </Button>\r\n            <Input\r\n              value={input}\r\n              onChange={(e) => setInput(e.target.value)}\r\n              placeholder=\"输入消息测试 Lovable AI...\"\r\n              disabled={isLoading}\r\n              className=\"flex-1\"\r\n            />\r\n            <Button type=\"submit\" disabled={!input.trim() || isLoading}>\r\n              {isLoading ? (\r\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n              ) : (\r\n                <Send className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n          </form>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":["LovableAIDemoDialog","open","onOpenChange","messages","setMessages","useState","input","setInput","isLoading","setIsLoading","userLocation","setUserLocation","scrollAreaRef","useRef","abortControllerRef","useEffect","position","error","handleSubmit","e","userMessage","prev","assistantMessage","response","errorData","reader","decoder","buffer","done","value","lines","line","jsonStr","content","flushSync","updated","lastMsg","handleClear","handleClose","renderMarkdown","text","html","jsx","Dialog","jsxs","DialogContent","DialogHeader","DialogTitle","Sparkles","ScrollArea","message","index","Loader2","User","Button","Trash2","Input","Send"],"mappings":"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"}