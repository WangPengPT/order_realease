import{p as F,q as K,r,j as e,bh as u,bg as U,b6 as J,bn as X,ck as G,c2 as Y,bt as Z,e2 as $,b8 as O,aL as ee,w as I,c5 as D,bL as se,c1 as ae,c8 as te,by as ie,a4 as ne}from"./vendor-react-Hsdnn-sD.js";import{D as re,d as le,f as ce,g as de,A as me,h as oe,i as ue,W as n,B as x,e as l,k as L,I as xe,a2 as h,a3 as g,a4 as j,a5 as f,a6 as c,s as he}from"./index-DyYi8ya3.js";import{S as ge}from"./separator-DHl1P3Aj.js";import{a as je}from"./useCommunityPosts-DE951PiU.js";import{u as fe}from"./useActivities-3nH-jK51.js";import{u as Ne}from"./useLocalizedContent-D-CDxH29.js";import{H as T,p as ve,I as pe,J as ye}from"./vendor-utils-Z4kpnli5.js";const Pe=({post:s,open:q,onOpenChange:d})=>{const{t,i18n:z}=F(),{getLocalizedField:N}=Ne(),m=je(),{data:E}=fe(),v=K(),[p,y]=r.useState(0),[b,w]=r.useState("approved"),[_,k]=r.useState("pending"),[S,C]=r.useState(""),[A,P]=r.useState(!1);r.useEffect(()=>{s&&(y(s.weight),w(s.status),k(s.moderation_status),C(s.activity_id||""))},[s]);const H=a=>a===null?"bg-gray-100 text-gray-600":a<=30?"bg-emerald-100 text-emerald-700":a<=60?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700",M=async()=>{if(s){P(!0);try{const{error:a}=await he.functions.invoke("moderate-post",{body:{post_id:s.id,content:s.content,user_id:s.author_id,image_urls:s.image_urls,video_url:s.video_url}});if(a)throw a;I.success(t("admin.moderation.reReviewSuccess","重新审核完成")),v.invalidateQueries({queryKey:["admin-community-posts"]}),v.invalidateQueries({queryKey:["community-post"]})}catch(a){console.error("Re-moderation error:",a),I.error(t("admin.moderation.reReviewError","重新审核失败"))}finally{P(!1)}}},R=()=>{switch(z.language){case"zh":return ye;case"pt":return pe;default:return ve}},B=async()=>{s&&(await m.mutateAsync({id:s.id,weight:p,status:b,moderation_status:_,activity_id:S||null}),d(!1))};if(!s)return null;const V=E?.filter(a=>a.status==="published")||[],Q=a=>{switch(a){case"approved":return{icon:te,label:t("admin.status.approved","已发布"),className:"text-emerald-600"};case"pending":return{icon:u,label:t("admin.status.pending","待审核"),className:"text-amber-600"};case"rejected":return{icon:ae,label:t("admin.status.rejected","已拒绝"),className:"text-red-600"};case"hidden":return{icon:se,label:t("admin.status.hidden","已隐藏"),className:"text-gray-500"};default:return{icon:D,label:a,className:"text-gray-500"}}},W=a=>{switch(a){case"approved":return{icon:ne,label:t("admin.moderation.approved","通过"),className:"text-emerald-600"};case"flagged":return{icon:ie,label:t("admin.moderation.flagged","标记"),className:"text-orange-500"};case"pending":return{icon:u,label:t("admin.moderation.pending","待审"),className:"text-gray-500"};default:return{icon:D,label:a,className:"text-gray-500"}}};return e.jsx(re,{open:q,onOpenChange:d,children:e.jsxs(le,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4 border-b",children:e.jsx(de,{className:"text-xl",children:t("admin.communityPosts.manage","管理帖子")})}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gradient-to-r from-muted/50 to-muted/30 rounded-xl",children:[e.jsxs(me,{className:"h-14 w-14 ring-2 ring-background shadow-md",children:[e.jsx(oe,{src:s.author?.avatar_url||void 0}),e.jsx(ue,{className:"bg-primary/10 text-primary font-semibold text-lg",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-lg",children:s.author?.display_name}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1.5",children:[e.jsx(u,{className:"h-3.5 w-3.5"}),T(new Date(s.created_at),{addSuffix:!0,locale:R()})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:t("admin.communityPosts.content","内容")}),e.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert p-4 border rounded-xl bg-muted/20",dangerouslySetInnerHTML:{__html:N(s,"content")}})]}),s.image_urls&&s.image_urls.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:t("admin.communityPosts.images","图片")}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:s.image_urls.map((a,i)=>e.jsx("div",{className:"aspect-square rounded-xl overflow-hidden border shadow-sm hover:shadow-md transition-shadow",children:e.jsx("img",{src:a,alt:"",className:"w-full h-full object-cover"})},i))})]}),s.video_url&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:t("admin.communityPosts.video","视频")}),e.jsx("video",{src:s.video_url,controls:!0,className:"w-full max-h-48 rounded-xl border shadow-sm",preload:"metadata"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/30 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(U,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium",children:s.likes_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.likes","赞")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(J,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium",children:s.comments_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.comments","评论")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(X,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium",children:s.shares_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.shares","分享")})]})]}),(s.risk_score!==null||s.ai_reviewed_at)&&e.jsxs("div",{className:"space-y-3 p-4 bg-muted/30 rounded-xl border border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(n,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),t("admin.moderation.aiResult","AI审核结果")]}),e.jsxs(x,{size:"sm",variant:"ghost",onClick:M,disabled:A,className:"h-7 text-xs",children:[e.jsx(Y,{className:l("h-3.5 w-3.5 mr-1",A&&"animate-spin")}),t("admin.moderation.reReview","重审")]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(L,{className:l("text-sm",H(s.risk_score)),children:[e.jsx(Z,{className:"h-3.5 w-3.5 mr-1"}),t("admin.moderation.riskScore","风险分数"),": ",s.risk_score??"-"]}),s.ai_reviewed_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:T(new Date(s.ai_reviewed_at),{addSuffix:!0,locale:R()})})]}),s.risk_reasons&&s.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.risk_reasons.map((a,i)=>e.jsx(L,{variant:"outline",className:"text-xs",children:a},i))})]}),e.jsx(ge,{}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(n,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx($,{className:"h-4 w-4"}),t("admin.communityPosts.weight","权重")]}),e.jsx(xe,{type:"number",value:p,onChange:a=>y(parseInt(a.target.value)||0),min:0,max:1e3,className:"h-10"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.communityPosts.weightHint","权重越高，帖子排序越靠前")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(n,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4"}),t("admin.communityPosts.linkActivity","关联活动")]}),e.jsxs(h,{value:S||"none",onValueChange:a=>C(a==="none"?"":a),children:[e.jsx(g,{className:"h-10",children:e.jsx(j,{placeholder:t("community.selectActivity","选择活动（可选）")})}),e.jsxs(f,{children:[e.jsx(c,{value:"none",children:t("community.noActivity","不关联活动")}),V.map(a=>e.jsx(c,{value:a.id,children:N(a,"title")},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:t("admin.communityPosts.status","状态")}),e.jsxs(h,{value:b,onValueChange:w,children:[e.jsx(g,{className:"h-10",children:e.jsx(j,{})}),e.jsx(f,{children:["approved","pending","hidden","rejected"].map(a=>{const i=Q(a),o=i.icon;return e.jsx(c,{value:a,children:e.jsxs("span",{className:l("flex items-center gap-2",i.className),children:[e.jsx(o,{className:"h-4 w-4"}),i.label]})},a)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:t("admin.communityPosts.moderation","审核状态")}),e.jsxs(h,{value:_,onValueChange:k,children:[e.jsx(g,{className:"h-10",children:e.jsx(j,{})}),e.jsx(f,{children:["pending","approved","flagged"].map(a=>{const i=W(a),o=i.icon;return e.jsx(c,{value:a,children:e.jsxs("span",{className:l("flex items-center gap-2",i.className),children:[e.jsx(o,{className:"h-4 w-4"}),i.label]})},a)})})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(x,{variant:"outline",onClick:()=>d(!1),className:"px-6",children:t("common.cancel","取消")}),e.jsxs(x,{onClick:B,disabled:m.isPending,className:"px-6",children:[m.isPending&&e.jsx(ee,{className:"h-4 w-4 mr-2 animate-spin"}),t("common.save","保存")]})]})]})})};export{Pe as P};
//# sourceMappingURL=PostManagementDialog-DC7eWfO6.js.map
