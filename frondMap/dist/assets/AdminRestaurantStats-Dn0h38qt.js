import{j as e}from"./vendor-ui-DmpovMYY.js";import{j as Z,r as $,L as _}from"./vendor-react-iAJ0IrSD.js";import{c7 as T,K as z,B as b,a3 as U,G as J,r as I,av as B,aW as ee,aX as se,aY as ae,aZ as te,a_ as D,bX as re,af as ne,q as o,P as m,aQ as ie,M as E,V,O as C,Z as S,bB as de,aO as X,ax as P,ay as Y,az as G,k as Q,s as p}from"./index-DFxKlyPh.js";import{d as le}from"./useRestaurants-2ZYL66R3.js";import{u as ce}from"./useLocalizedContent-BN2IWylL.js";import{a as M}from"./vendor-query-D82cqPtt.js";import{u as oe}from"./vendor-i18n-DxKeo2S1.js";import{R as me,L as xe,C as he,X as ue,Y as ge,T as je,b as pe}from"./vendor-charts-Bz7hPIBd.js";import{s as q}from"./subDays-Cp850VDB.js";import{f as x}from"./format-BPfl-CpL.js";import{s as A}from"./startOfDay-CC-9vSfy.js";import"./vendor-supabase-6pZ9VDFn.js";function W(r,a){const f=T(r.start),d=T(r.end);let y=+f>+d;const R=y?+f:+d,c=y?d:f;c.setHours(0,0,0,0);let l=1;const v=[];for(;+c<=R;)v.push(T(c)),c.setDate(c.getDate()+l),c.setHours(0,0,0,0);return y?v.reverse():v}const ke=()=>{const{id:r}=Z(),{t:a}=oe(),{localizeRestaurant:f}=ce(),[d,y]=$.useState("30days"),R=()=>{const s=new Date;switch(d){case"today":return A(s).toISOString();case"7days":return A(q(s,6)).toISOString();case"30days":return A(q(s,29)).toISOString();default:return null}},c=()=>{switch(d){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:l,isLoading:v}=le(r),j=R(),{data:L=[],isLoading:fe}=M({queryKey:["restaurant-page-views",r,d],queryFn:async()=>{let s=p.from("page_views").select("created_at").eq("page_type","restaurant").eq("target_id",r);j&&(s=s.gte("created_at",j));const{data:t,error:i}=await s;if(i)throw i;return t},enabled:!!r}),{data:h=[],isLoading:ye}=M({queryKey:["restaurant-comments",r,d],queryFn:async()=>{let s=p.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_type","restaurant").eq("target_id",r).order("created_at",{ascending:!1});j&&(s=s.gte("created_at",j));const{data:t,error:i}=await s;if(i)throw i;if(t&&t.length>0){const N=[...new Set(t.map(n=>n.user_id))],{data:u}=await p.rpc("get_public_profiles",{user_ids:N});return t.map(n=>({...n,profile:u?.find(g=>g.id===n.user_id)}))}return[]},enabled:!!r}),{data:w=[],isLoading:ve}=M({queryKey:["restaurant-favorites",r,d],queryFn:async()=>{let s=p.from("favorites").select("user_id, created_at").eq("restaurant_id",r);j&&(s=s.gte("created_at",j));const{data:t,error:i}=await s;if(i)throw i;if(t&&t.length>0){const N=t.map(n=>n.user_id),{data:u}=await p.rpc("get_public_profiles",{user_ids:N});return t.map(n=>({...n,profile:u?.find(g=>g.id===n.user_id)}))}return[]},enabled:!!r}),{data:H=[]}=M({queryKey:["restaurant-activities",r],queryFn:async()=>{const{data:s,error:t}=await p.from("activity_restaurants").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            status
          )
        `).eq("restaurant_id",r);if(t)throw t;return s?.map(i=>i.activities).filter(Boolean)||[]},enabled:!!r}),K=(()=>{if(d==="all"){const t=new Date,i=q(t,29);return W({start:i,end:t}).map(u=>{const n=x(u,"yyyy-MM-dd"),g=L.filter(k=>x(new Date(k.created_at),"yyyy-MM-dd")===n).length;return{date:n,views:g}})}else{const s=c(),t=new Date,i=q(t,s-1);return W({start:i,end:t}).map(u=>{const n=x(u,"yyyy-MM-dd"),g=L.filter(k=>x(new Date(k.created_at),"yyyy-MM-dd")===n).length;return{date:n,views:g}})}})(),O=h.length>0?h.filter(s=>s.rating_value).reduce((s,t)=>s+(t.rating_value||0),0)/h.filter(s=>s.rating_value).length:0,F=l?f(l):null;return v?e.jsxs("div",{className:"space-y-6",children:[e.jsx(z,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(z,{className:"h-24"},s))}),e.jsx(z,{className:"h-64"})]}):!l||!F?e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"text-muted-foreground",children:a("error.notFound")})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(b,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(_,{to:"/admin/restaurant-stats",children:e.jsx(U,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[l.image_url?e.jsx("img",{src:l.image_url,alt:F.name,className:"w-12 h-12 rounded-lg object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(J,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:F.name}),l.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(I,{className:"h-3 w-3 fill-amber-400 text-amber-400"}),e.jsx("span",{children:l.rating.toFixed(1)})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(ee,{value:d,onValueChange:s=>y(s),children:[e.jsx(se,{className:"w-[140px]",children:e.jsx(ae,{})}),e.jsxs(te,{children:[e.jsx(D,{value:"today",children:a("analytics.today","今日")}),e.jsx(D,{value:"7days",children:a("analytics.last7Days","近7天")}),e.jsx(D,{value:"30days",children:a("analytics.last30Days","近30天")}),e.jsx(D,{value:"all",children:a("analytics.allTime","所有时间")})]})]}),e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(_,{to:`/restaurant/${r}`,target:"_blank",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),a("admin.preview","预览")]})}),e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(_,{to:"/admin/restaurants",state:{editRestaurantId:r},children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),a("admin.edit","编辑")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx(ie,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.views","浏览量")}),e.jsx("p",{className:"text-2xl font-bold",children:L.length})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx(E,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.comments","评论")}),e.jsx("p",{className:"text-2xl font-bold",children:h.length})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg",children:e.jsx(V,{className:"h-5 w-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.favorites","收藏")}),e.jsx("p",{className:"text-2xl font-bold",children:w.length})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/10 rounded-lg",children:e.jsx(I,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.avgRating","平均评分")}),e.jsx("p",{className:"text-2xl font-bold",children:O>0?O.toFixed(1):"-"})]})]})})})]}),e.jsxs(o,{children:[e.jsx(C,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5"}),a("admin.viewTrend","浏览趋势")]})}),e.jsx(m,{children:e.jsx("div",{className:"h-[300px]",children:K.length>0?e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(xe,{data:K,children:[e.jsx(he,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(ue,{dataKey:"date",tickFormatter:s=>x(new Date(s),"MM/dd"),className:"text-xs"}),e.jsx(ge,{className:"text-xs"}),e.jsx(je,{labelFormatter:s=>x(new Date(s),"yyyy-MM-dd"),contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(pe,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,name:a("admin.views")})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:a("analytics.noData")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(o,{children:[e.jsxs(C,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),a("admin.recentComments","最近评论")]}),e.jsx(X,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(h.length,10)})})]}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[h.slice(0,10).map(s=>e.jsxs("div",{className:"flex gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(P,{className:"h-8 w-8",children:[e.jsx(Y,{src:s.profile?.avatar_url}),e.jsx(G,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||a("common.anonymous")}),s.rating_value&&e.jsxs(Q,{variant:"secondary",className:"text-xs",children:[e.jsx(I,{className:"h-3 w-3 mr-1 fill-amber-400 text-amber-400"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:x(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},s.id)),h.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noComments","暂无评论")})]})})]}),e.jsxs(o,{children:[e.jsxs(C,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5"}),a("admin.recentFavorites","最近收藏")]}),e.jsx(X,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(w.length,10)})})]}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:[w.slice(0,10).map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(P,{className:"h-8 w-8",children:[e.jsx(Y,{src:s.profile?.avatar_url}),e.jsx(G,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||a("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:x(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},t)),w.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noFavorites","暂无收藏")})]})})]})]}),e.jsxs(o,{children:[e.jsx(C,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),a("admin.participatingActivities","参与的活动")]})}),e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[H.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.title_zh||s.title_en}),e.jsx(Q,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?a("admin.published","已发布"):a("admin.draft","草稿")})]}),e.jsx(b,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:e.jsx(_,{to:`/admin/activity-stats/${s.id}`,children:a("admin.viewStats","查看统计")})})]},s.id)),H.length===0&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:a("admin.noActivities","暂未参与活动")})]})})]})]})};export{ke as default};
//# sourceMappingURL=AdminRestaurantStats-Dn0h38qt.js.map
