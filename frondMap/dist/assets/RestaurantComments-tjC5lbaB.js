import{j as e}from"./vendor-ui-DAmPMpEA.js";import{u as ke,r as l}from"./vendor-react-iAJ0IrSD.js";import{c as Se,o as Re,a5 as Ae,x as Ie,n as De,s as J,Y as K,Z as Q,_ as Y,ai as _e,r as Z,e as G,B as c,ag as ee,ab as se,X as ae,I as te,aj as Ue,C as v,k as y,a6 as Pe,a7 as Le,a8 as ze,a9 as Ee,aa as Me,j as $e,J as le,K as ie,N as re,O as ne,Q as ce,R as me,T as oe,V as de}from"./index-Do1W_89N.js";import{u as Te,a as Ve,b as Be,D as xe,R as Fe}from"./ReportDialog-J5wCMsyR.js";import{d as Oe}from"./useSensitiveWords-0R7frj4O.js";import{u as qe}from"./vendor-i18n-DxKeo2S1.js";import{C as He}from"./clock-C2dMhwrG.js";import{C as We}from"./circle-alert-DQaz5Go2.js";import{S as M}from"./star-DGsfeJZk.js";import{S as Xe}from"./shield-alert-BmgUigh1.js";import{I as ue}from"./image-B9MAqH9W.js";import{V as Je}from"./volume-x-BmTxfx-w.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-query-BlSVl3IQ.js";import"./vendor-supabase-KNAP0qdW.js";import"./input-otp-Dij468hC.js";import"./plus-D-VZe8Eb.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=Se("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),he=[{value:"0-5",label:"0-5€"},{value:"5-10",label:"5-10€"},{value:"10-15",label:"10-15€"},{value:"15-20",label:"15-20€"},{value:"20-25",label:"20-25€"},{value:"25-30",label:"25-30€"},{value:"30-40",label:"30-40€"},{value:"40-50",label:"40-50€"},{value:"50+",label:"50€+"}],hs=({restaurantId:g,targetType:m="restaurant"})=>{const{t:a}=qe(),{user:i}=Re(),{data:o}=Ae(),{isAdmin:pe}=Ie(),{toast:n}=De(),ge=ke(),[x,$]=l.useState(""),[u,T]=l.useState(0),[je,V]=l.useState(0),[f,B]=l.useState(""),[ve,b]=l.useState(null),[h,k]=l.useState(""),[S,R]=l.useState(null),[F,A]=l.useState(null),[I,D]=l.useState(null),[O,_]=l.useState(null),[d,N]=l.useState(!1),[fe,q]=l.useState(!1),[U,P]=l.useState(null),{data:L,isLoading:Ne}=Te(g,m),p=Ve(),H=Be(),{checkContent:w}=Oe(),C=l.useCallback(async s=>{try{const r=s.name.split(".").pop(),j=`${`${i?.id}-${Date.now()}.${r}`}`,{error:X,data:Qe}=await J.storage.from("comment-images").upload(j,s);if(X)throw X;const{data:{publicUrl:be}}=J.storage.from("comment-images").getPublicUrl(j);return be}catch(r){return console.error("Error uploading image:",r),n({title:a("common.error"),description:a("restaurant.imageUploadFailed"),variant:"destructive"}),null}},[i,n,a]),W=l.useCallback((s,r=!1)=>{const t=s.target.files?.[0];if(t){if(t.size>5*1024*1024){n({title:a("common.error"),description:a("restaurant.imageTooLarge"),variant:"destructive"});return}r?(D(t),_(URL.createObjectURL(t))):(R(t),A(URL.createObjectURL(t)))}},[n,a]),z=l.useCallback((s=!1)=>{s?(D(null),_(null)):(R(null),A(null))},[]),we=l.useCallback(async()=>{if(!x.trim()||!i)return;if(o?.is_muted){n({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(w(x).hasSensitive){n({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}if(m==="restaurant"&&!u){n({title:a("common.hint","提示"),description:a("toast.pleaseSelectRating"),variant:"warning"});return}N(!0);let r;if(S){const t=await C(S);t&&(r=t)}await p.mutateAsync({targetId:g,targetType:m,content:x,ratingValue:m==="restaurant"?u:void 0,priceRange:m==="restaurant"&&f?f:void 0,imageUrl:r}),$(""),T(0),B(""),R(null),A(null),N(!1)},[x,i,o,m,u,n,a,S,C,p,g,f,w]),Ce=l.useCallback(async s=>{if(!h.trim()||!i)return;if(o?.is_muted){n({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(w(h).hasSensitive){n({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}N(!0);let t;if(I){const j=await C(I);j&&(t=j)}await p.mutateAsync({targetId:g,targetType:m,content:h,parentId:s,imageUrl:t}),k(""),b(null),D(null),_(null),N(!1)},[h,i,o,I,C,p,g,m,w,n,a]),ye=l.useCallback(async s=>{await H.mutateAsync(s),P(null)},[H]),E=l.memo(({comment:s,isReply:r=!1})=>e.jsxs("div",{className:`flex gap-2 sm:gap-3 ${r?"ml-8 sm:ml-12 mt-3":""}`,children:[e.jsxs(K,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(Q,{src:s.profiles?.avatar_url}),e.jsx(Y,{className:"text-xs sm:text-sm",children:s.profiles?.display_name?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-xs sm:text-sm truncate",children:s.profiles?.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0",children:_e(new Date(s.created_at),{addSuffix:!0})}),s.edited&&e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:["(",a("restaurant.edited"),")"]}),i?.id===s.user_id&&s.moderation_status==="pending"&&e.jsxs(Z,{variant:"outline",className:"text-yellow-600 border-yellow-500 bg-yellow-50 dark:bg-yellow-950/30 text-xs py-0 h-5",children:[e.jsx(He,{className:"w-3 h-3 mr-1"}),a("restaurant.commentPending","审核中")]}),i?.id===s.user_id&&s.moderation_status==="flagged"&&e.jsxs(Z,{variant:"outline",className:"text-destructive border-destructive bg-destructive/10 text-xs py-0 h-5",children:[e.jsx(We,{className:"w-3 h-3 mr-1"}),a("restaurant.commentFailed","发送失败")]})]}),!r&&s.rating_value&&e.jsxs("div",{className:"flex items-center gap-3 mt-1 mb-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(t=>e.jsx(M,{className:G("w-4 h-4",t<=s.rating_value?"fill-accent text-accent":"text-muted-foreground")},t))}),s.price_range&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(xe,{className:"w-3 h-3"}),e.jsx("span",{children:he.find(t=>t.value===s.price_range)?.label})]})]}),e.jsx("p",{className:"text-xs sm:text-sm mt-1 text-foreground break-words",children:s.content}),s.image_url&&e.jsx("img",{src:s.image_url,alt:"Comment attachment",className:"mt-2 rounded-lg max-w-full sm:max-w-sm w-full"}),e.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-2",children:[!r&&i&&!o?.is_muted&&e.jsxs(c,{variant:"ghost",size:"sm",onClick:()=>b(s.id),className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Ke,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("restaurant.reply")})]}),(i?.id===s.user_id||pe)&&e.jsxs(c,{variant:"ghost",size:"sm",onClick:()=>P(s.id),className:"h-7 text-xs text-destructive hover:text-destructive px-2 sm:px-3",children:[e.jsx(ee,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("common.delete")})]}),i?.id!==s.user_id&&e.jsx(Fe,{targetType:"comment",targetId:s.id,onLoginRequired:()=>q(!0),trigger:e.jsxs(c,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Xe,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("report.title")})]})})]}),ve===s.id&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(se,{value:h,onChange:t=>k(t.target.value),placeholder:a("restaurant.writeReply"),className:"min-h-[80px] text-sm"}),O&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:O,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(c,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>z(!0),children:e.jsx(ae,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex sm:flex-col gap-2",children:[e.jsx(c,{size:"sm",onClick:()=>Ce(s.id),disabled:!h.trim()||d,className:"text-xs",children:a(d?"common.loading":"restaurant.reply")}),e.jsx(te,{type:"file",accept:"image/*",onChange:t=>W(t,!0),className:"hidden",id:`reply-image-${s.id}`,disabled:d}),e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>document.getElementById(`reply-image-${s.id}`)?.click(),disabled:d,className:"text-xs sm:px-3",children:[e.jsx(ue,{className:"h-4 w-4 sm:mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>{b(null),k(""),z(!0)},className:"text-xs",children:a("common.cancel")})]})]})}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3",children:s.replies.map(t=>e.jsx(E,{comment:t,isReply:!0},t.id))})]})]}));return E.displayName="CommentItem",Ne?e.jsx("div",{className:"text-center py-8",children:a("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-4 sm:w-5 h-4 sm:h-5"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold",children:[a("restaurant.reviews")," (",L?.length||0,")"]})]}),i?o?.is_muted?e.jsx(v,{className:"border-yellow-300 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(y,{className:"py-4 sm:py-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex items-center gap-3 text-yellow-600 dark:text-yellow-400",children:[e.jsx(Je,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:a("restaurant.youAreMutedNotice")})]})})}):e.jsx(v,{children:e.jsx(y,{className:"pt-4 sm:pt-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex gap-2 sm:gap-3",children:[e.jsxs(K,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(Q,{src:o?.avatar_url||void 0}),e.jsx(Y,{className:"text-xs sm:text-sm",children:o?.display_name?.charAt(0).toUpperCase()||i?.email?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 space-y-2 sm:space-y-3 min-w-0",children:[m==="restaurant"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-accent"}),"评分 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onMouseEnter:()=>V(s),onMouseLeave:()=>V(0),onClick:()=>T(s),className:"transition-transform hover:scale-110",children:e.jsx(M,{className:G("w-7 h-7 cursor-pointer transition-colors",s<=(je||u)?"fill-accent text-accent":"text-muted-foreground hover:text-accent")})},s)),u>0&&e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",u,"/5)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),a("restaurant.priceRange")]}),e.jsxs(Pe,{value:f,onValueChange:B,children:[e.jsx(Le,{className:"w-full",children:e.jsx(ze,{placeholder:a("restaurant.selectPriceRange")})}),e.jsx(Ee,{className:"bg-background",children:he.map(s=>e.jsx(Me,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsx(se,{value:x,onChange:s=>$(s.target.value),placeholder:a("restaurant.writeComment"),className:"min-h-[80px] sm:min-h-[100px] text-sm"}),F&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:F,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(c,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>z(!1),children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(te,{type:"file",accept:"image/*",onChange:s=>W(s,!1),className:"hidden",id:"comment-image",disabled:d}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>document.getElementById("comment-image")?.click(),disabled:d,className:"text-xs",children:[e.jsx(ue,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(c,{onClick:we,disabled:!x.trim()||p.isPending||d,size:"sm",className:"text-xs",children:d||p.isPending?a("common.loading"):a("restaurant.postComment")})]})]})]})})}):e.jsx(v,{children:e.jsx(y,{className:"py-4 sm:py-6 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.signInToComment")})}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:L?.map(s=>e.jsx(v,{children:e.jsx($e,{className:"p-3 sm:p-6",children:e.jsx(E,{comment:s})})},s.id))}),L?.length===0&&e.jsx(v,{children:e.jsx(y,{className:"py-8 sm:py-12 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.noComments")})})]}),e.jsx(le,{open:fe,onOpenChange:q,children:e.jsxs(ie,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:a("activities.loginRequired")}),e.jsx(ce,{children:a("activities.loginRequiredMessage")})]}),e.jsxs(me,{children:[e.jsx(oe,{children:a("common.cancel")}),e.jsx(de,{onClick:()=>ge("/auth"),children:a("activities.goToLogin")})]})]})}),e.jsx(le,{open:!!U,onOpenChange:s=>!s&&P(null),children:e.jsxs(ie,{className:"max-w-sm",children:[e.jsxs(re,{children:[e.jsx("div",{className:"mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(ee,{className:"h-7 w-7 text-destructive"})}),e.jsx(ne,{className:"text-center",children:a("restaurant.deleteComment")}),e.jsx(ce,{className:"text-center",children:a("restaurant.confirmDelete")})]}),e.jsxs(me,{className:"sm:justify-center gap-2",children:[e.jsx(oe,{className:"sm:w-24",children:a("common.cancel")}),e.jsx(de,{onClick:()=>U&&ye(U),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 sm:w-24",children:a("common.delete")})]})]})})]})};export{hs as default};
//# sourceMappingURL=RestaurantComments-tjC5lbaB.js.map
