import{s as R,p as X,q as W,r as S,j as e,c7 as Y,M as Z,bI as T,c6 as I,b4 as ee,eg as L,bf as ae}from"./vendor-react-DTNwRJdt.js";import{s as k,B as P,C as f,p as h,F as u,q as j,j as v,I as ie,a2 as B,a3 as K,a4 as H,a5 as Q,a6 as p,g as _}from"./index-60xCuNp_.js";import{T as se,a as te,b as F,c as N,d as ne,e as w}from"./table-DegufvQH.js";import{D as re,p as le,I as ce,J as de}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CY_qUJoS.js";const oe=a=>{const n=a.split("@");return n.length>1?n[1]:""},z=a=>[".edu",".edu.pt",".edu.br",".edu.cn","iscte","estudantes","alunos","student","university","universidade","uni.",".ac."].some(s=>a.toLowerCase().includes(s)),me=(a,n,s,o=0,m=50)=>R({queryKey:["email-verification-logs",a,n,s,o,m],queryFn:async()=>{let t=k.from("email_verification_codes").select("*",{count:"exact"}).order("created_at",{ascending:!1});a==="verified"?t=t.eq("verified",!0):a==="expired"?t=t.eq("verified",!1).lt("expires_at",new Date().toISOString()):a==="pending"&&(t=t.eq("verified",!1).gte("expires_at",new Date().toISOString())),n&&(t=t.ilike("email",`%${n}%`)),s&&(t=t.ilike("email",`%@${s}`));const y=o*m,b=y+m-1;t=t.range(y,b);const{data:q,error:r,count:d}=await t;if(r)throw r;const g=new Date;return{logs:(q||[]).map(l=>{const C=oe(l.email),x=new Date(l.expires_at);let c;return l.verified?c="verified":x<g?c="expired":c="pending",{id:l.id,email:l.email,verified:l.verified||!1,created_at:l.created_at||"",expires_at:l.expires_at,status:c,domain:C,isSchoolEmail:z(C)}}),totalCount:d||0,totalPages:Math.ceil((d||0)/m),currentPage:o}}}),xe=()=>R({queryKey:["email-verification-stats"],queryFn:async()=>{const{data:a,error:n}=await k.rpc("get_email_verification_stats");if(n)throw n;if(a&&typeof a=="object"&&"error"in a)throw new Error(String(a.error));const s=a;return{total:s.total||0,verified:s.verified||0,expired:s.expired||0,pending:s.pending||0,verificationRate:s.verificationRate||0}}}),fe=()=>R({queryKey:["email-domains"],queryFn:async()=>{const{data:a,error:n}=await k.rpc("get_email_domain_stats");if(n)throw n;return!a||!Array.isArray(a)?[]:a.map(s=>({domain:s.domain,count:s.count,isSchoolEmail:z(s.domain)}))}}),we=()=>{const{t:a,i18n:n}=X(),s=W(),[o,m]=S.useState("all"),[t,y]=S.useState(""),[b,q]=S.useState(""),[r,d]=S.useState(0),g=50,{data:V,isLoading:l,refetch:C}=me(o,t,b,r,g),{data:x,isLoading:c}=xe(),{data:O}=fe(),M=V?.logs||[],D=V?.totalCount||0,E=V?.totalPages||0,$=()=>{switch(n.language){case"zh":return de;case"pt":return ce;default:return le}},A=i=>i?re(new Date(i),"yyyy-MM-dd HH:mm",{locale:$()}):"-",G=i=>{switch(i){case"verified":return e.jsxs(_,{className:"bg-green-500/10 text-green-600 hover:bg-green-500/20",children:[e.jsx(T,{className:"w-3 h-3 mr-1"}),a("admin.emailVerification.verified","已验证")]});case"expired":return e.jsxs(_,{variant:"destructive",className:"bg-red-500/10 text-red-600 hover:bg-red-500/20",children:[e.jsx(I,{className:"w-3 h-3 mr-1"}),a("admin.emailVerification.expired","已过期")]});case"pending":return e.jsxs(_,{variant:"secondary",className:"bg-yellow-500/10 text-yellow-600 hover:bg-yellow-500/20",children:[e.jsx(ae,{className:"w-3 h-3 mr-1"}),a("admin.emailVerification.pending","待验证")]})}},J=()=>{s.invalidateQueries({queryKey:["email-verification-logs"]}),s.invalidateQueries({queryKey:["email-verification-stats"]}),s.invalidateQueries({queryKey:["email-domains"]}),C()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:a("admin.emailVerification.title","邮箱验证管理")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.emailVerification.description","查看所有验证码发送记录和验证状态")})]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:J,children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),a("common.refresh","刷新")]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(f,{children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium",children:a("admin.emailVerification.totalSent","总发送数")}),e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold",children:x?.total||0})})]}),e.jsxs(f,{children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium",children:a("admin.emailVerification.verifiedCount","已验证")}),e.jsx(T,{className:"h-4 w-4 text-green-500"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-green-600",children:x?.verified||0})})]}),e.jsxs(f,{children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium",children:a("admin.emailVerification.expiredCount","已过期未验证")}),e.jsx(I,{className:"h-4 w-4 text-red-500"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-red-600",children:x?.expired||0})})]}),e.jsxs(f,{children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium",children:a("admin.emailVerification.verificationRate","验证成功率")}),e.jsx(T,{className:"h-4 w-4 text-blue-500"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[x?.verificationRate||0,"%"]})})]})]}),e.jsxs(f,{children:[e.jsx(h,{children:e.jsx(u,{className:"text-lg",children:a("admin.emailVerification.filters","筛选条件")})}),e.jsx(j,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ie,{placeholder:a("admin.emailVerification.searchPlaceholder","搜索邮箱..."),value:t,onChange:i=>{y(i.target.value),d(0)},className:"pl-10"})]}),e.jsxs(B,{value:o,onValueChange:i=>{m(i),d(0)},children:[e.jsx(K,{className:"w-full sm:w-40",children:e.jsx(H,{placeholder:a("admin.emailVerification.allStatus","全部状态")})}),e.jsxs(Q,{children:[e.jsx(p,{value:"all",children:a("admin.emailVerification.allStatus","全部状态")}),e.jsx(p,{value:"verified",children:a("admin.emailVerification.verified","已验证")}),e.jsx(p,{value:"expired",children:a("admin.emailVerification.expired","已过期")}),e.jsx(p,{value:"pending",children:a("admin.emailVerification.pending","待验证")})]})]}),e.jsxs(B,{value:b||"all",onValueChange:i=>{q(i==="all"?"":i),d(0)},children:[e.jsx(K,{className:"w-full sm:w-48",children:e.jsx(H,{placeholder:a("admin.emailVerification.allDomains","全部域名")})}),e.jsxs(Q,{children:[e.jsx(p,{value:"all",children:a("admin.emailVerification.allDomains","全部域名")}),O?.map(i=>e.jsxs(p,{value:i.domain,children:[i.isSchoolEmail&&e.jsx(L,{className:"w-3 h-3 inline mr-1"}),i.domain," (",i.count,")"]},i.domain))]})]})]})})]}),e.jsxs(f,{children:[e.jsx(h,{children:e.jsxs(u,{className:"text-lg flex items-center gap-2",children:[a("admin.emailVerification.records","验证记录"),e.jsx(_,{variant:"secondary",children:D})]})}),e.jsx(j,{children:l?e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((i,U)=>e.jsx(v,{className:"h-12 w-full"},U))}):M.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(F,{children:[e.jsx(N,{children:a("admin.emailVerification.email","邮箱")}),e.jsx(N,{children:a("admin.emailVerification.status","状态")}),e.jsx(N,{children:a("admin.emailVerification.domain","域名")}),e.jsx(N,{children:a("admin.emailVerification.sentAt","发送时间")}),e.jsx(N,{children:a("admin.emailVerification.expiresAt","过期时间")})]})}),e.jsx(ne,{children:M.map(i=>e.jsxs(F,{children:[e.jsx(w,{className:"font-medium",children:i.email}),e.jsx(w,{children:G(i.status)}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[i.isSchoolEmail&&e.jsx(L,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:i.domain})]})}),e.jsx(w,{className:"text-sm text-muted-foreground",children:A(i.created_at)}),e.jsx(w,{className:"text-sm text-muted-foreground",children:A(i.expires_at)})]},i.id))})]})}),E>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a("admin.emailVerification.showing","显示")," ",r*g+1," - ",Math.min((r+1)*g,D)," ",a("admin.emailVerification.of","共")," ",D]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{variant:"outline",size:"sm",onClick:()=>d(Math.max(0,r-1)),disabled:r===0,children:a("common.previous","上一页")}),e.jsx(P,{variant:"outline",size:"sm",onClick:()=>d(Math.min(E-1,r+1)),disabled:r>=E-1,children:a("common.next","下一页")})]})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("admin.emailVerification.noRecords","暂无记录")})})]})]})};export{we as default};
//# sourceMappingURL=AdminEmailVerification-Bhdj6htX.js.map
