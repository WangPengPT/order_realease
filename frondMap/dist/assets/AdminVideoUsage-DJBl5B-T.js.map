{"version":3,"file":"AdminVideoUsage-DJBl5B-T.js","sources":["../../src/pages/admin/AdminVideoUsage.tsx"],"sourcesContent":["import { useState } from \"react\";\r\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { toast } from \"sonner\";\r\nimport { Trash2, Search, Video, Settings } from \"lucide-react\";\r\nimport { format } from \"date-fns\";\r\n\r\ninterface UsageRow {\r\n  id: string;\r\n  user_id: string;\r\n  created_at: string;\r\n  recipe_name: string | null;\r\n  task_id: string | null;\r\n}\r\n\r\nconst AdminVideoUsage = () => {\r\n  const queryClient = useQueryClient();\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [dailyLimit, setDailyLimit] = useState<number>(20);\r\n\r\n  // Fetch site settings for daily limit\r\n  useQuery({\r\n    queryKey: [\"site-settings-video-limit\"],\r\n    queryFn: async () => {\r\n      const { data } = await supabase\r\n        .from(\"site_settings\")\r\n        .select(\"daily_video_limit\")\r\n        .single();\r\n      const limit = (data as any)?.daily_video_limit;\r\n      if (limit) setDailyLimit(limit);\r\n      return limit || 20;\r\n    },\r\n  });\r\n\r\n  // Fetch today's usage\r\n  const { data: usageData, isLoading } = useQuery({\r\n    queryKey: [\"admin-video-usage\", searchTerm],\r\n    queryFn: async () => {\r\n      const todayStart = new Date();\r\n      todayStart.setHours(0, 0, 0, 0);\r\n\r\n      const { data, error } = await supabase.rpc(\"get_daily_video_usage\" as any, {\r\n        p_date: todayStart.toISOString(),\r\n      });\r\n\r\n      // Fallback: direct query via REST\r\n      const resp = await fetch(\r\n        `${import.meta.env.VITE_SUPABASE_URL}/rest/v1/ai_video_usage?created_at=gte.${todayStart.toISOString()}&order=created_at.desc`,\r\n        {\r\n          headers: {\r\n            apikey: import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY,\r\n            Authorization: `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`,\r\n          },\r\n        }\r\n      );\r\n      const rows: UsageRow[] = await resp.json();\r\n\r\n      // Group by user_id\r\n      const userMap: Record<string, { count: number; userId: string; lastUsed: string; recipes: string[] }> = {};\r\n      for (const row of rows) {\r\n        if (!userMap[row.user_id]) {\r\n          userMap[row.user_id] = { count: 0, userId: row.user_id, lastUsed: row.created_at, recipes: [] };\r\n        }\r\n        userMap[row.user_id].count++;\r\n        if (row.recipe_name) userMap[row.user_id].recipes.push(row.recipe_name);\r\n      }\r\n\r\n      // Fetch profiles\r\n      const userIds = Object.keys(userMap);\r\n      if (userIds.length === 0) return [];\r\n\r\n      const { data: profiles } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, display_name, avatar_url\")\r\n        .in(\"id\", userIds);\r\n\r\n      return Object.values(userMap)\r\n        .map(u => {\r\n          const profile = profiles?.find(p => p.id === u.userId);\r\n          return { ...u, displayName: profile?.display_name || \"Unknown\", avatarUrl: profile?.avatar_url };\r\n        })\r\n        .filter(u => !searchTerm || u.displayName?.toLowerCase().includes(searchTerm.toLowerCase()));\r\n    },\r\n  });\r\n\r\n  // Reset user's today usage\r\n  const resetMutation = useMutation({\r\n    mutationFn: async (userId: string) => {\r\n      const todayStart = new Date();\r\n      todayStart.setHours(0, 0, 0, 0);\r\n      const resp = await fetch(\r\n        `${import.meta.env.VITE_SUPABASE_URL}/rest/v1/ai_video_usage?user_id=eq.${userId}&created_at=gte.${todayStart.toISOString()}`,\r\n        {\r\n          method: \"DELETE\",\r\n          headers: {\r\n            apikey: import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY,\r\n            Authorization: `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`,\r\n          },\r\n        }\r\n      );\r\n      if (!resp.ok) throw new Error(\"Delete failed\");\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-video-usage\"] });\r\n      toast.success(\"已重置用户今日用量\");\r\n    },\r\n    onError: () => toast.error(\"重置失败\"),\r\n  });\r\n\r\n  // Update daily limit\r\n  const updateLimitMutation = useMutation({\r\n    mutationFn: async (limit: number) => {\r\n      const { error } = await supabase\r\n        .from(\"site_settings\")\r\n        .update({ daily_video_limit: limit } as any)\r\n        .not(\"id\", \"is\", null);\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"site-settings-video-limit\"] });\r\n      toast.success(\"每日限制已更新\");\r\n    },\r\n    onError: () => toast.error(\"更新失败\"),\r\n  });\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center gap-3\">\r\n        <Video className=\"h-6 w-6 text-primary\" />\r\n        <h1 className=\"text-2xl font-bold\">AI视频用量管理</h1>\r\n      </div>\r\n\r\n      {/* Settings Card */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <CardTitle className=\"text-base flex items-center gap-2\">\r\n            <Settings className=\"h-4 w-4\" />\r\n            每日生成限制\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center gap-3\">\r\n            <Input\r\n              type=\"number\"\r\n              value={dailyLimit}\r\n              onChange={(e) => setDailyLimit(Number(e.target.value))}\r\n              className=\"w-32\"\r\n              min={1}\r\n              max={999}\r\n            />\r\n            <span className=\"text-sm text-muted-foreground\">次/用户/天</span>\r\n            <Button\r\n              size=\"sm\"\r\n              onClick={() => updateLimitMutation.mutate(dailyLimit)}\r\n              disabled={updateLimitMutation.isPending}\r\n            >\r\n              保存\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Search */}\r\n      <div className=\"flex items-center gap-2\">\r\n        <div className=\"relative flex-1 max-w-sm\">\r\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n          <Input\r\n            value={searchTerm}\r\n            onChange={(e) => setSearchTerm(e.target.value)}\r\n            placeholder=\"搜索用户名...\"\r\n            className=\"pl-9\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Usage Table */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <CardTitle className=\"text-base\">今日用量</CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>用户</TableHead>\r\n                <TableHead>今日已用</TableHead>\r\n                <TableHead>最近使用</TableHead>\r\n                <TableHead>生成菜品</TableHead>\r\n                <TableHead className=\"text-right\">操作</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {isLoading ? (\r\n                <TableRow>\r\n                  <TableCell colSpan={5} className=\"text-center py-8 text-muted-foreground\">\r\n                    加载中...\r\n                  </TableCell>\r\n                </TableRow>\r\n              ) : !usageData?.length ? (\r\n                <TableRow>\r\n                  <TableCell colSpan={5} className=\"text-center py-8 text-muted-foreground\">\r\n                    今日暂无使用记录\r\n                  </TableCell>\r\n                </TableRow>\r\n              ) : (\r\n                usageData.map((user) => (\r\n                  <TableRow key={user.userId}>\r\n                    <TableCell>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        {user.avatarUrl && (\r\n                          <img src={user.avatarUrl} className=\"w-6 h-6 rounded-full\" alt=\"\" />\r\n                        )}\r\n                        <span className=\"text-sm font-medium\">{user.displayName}</span>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <span className={user.count >= dailyLimit ? \"text-destructive font-semibold\" : \"\"}>\r\n                        {user.count} / {dailyLimit}\r\n                      </span>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-xs text-muted-foreground\">\r\n                      {format(new Date(user.lastUsed), \"HH:mm:ss\")}\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex flex-wrap gap-1\">\r\n                        {[...new Set(user.recipes)].slice(0, 3).map((r, i) => (\r\n                          <span key={i} className=\"text-xs bg-muted px-1.5 py-0.5 rounded\">{r}</span>\r\n                        ))}\r\n                        {user.recipes.length > 3 && (\r\n                          <span className=\"text-xs text-muted-foreground\">+{user.recipes.length - 3}</span>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-right\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => resetMutation.mutate(user.userId)}\r\n                        disabled={resetMutation.isPending}\r\n                        className=\"text-destructive hover:text-destructive\"\r\n                      >\r\n                        <Trash2 className=\"h-3.5 w-3.5 mr-1\" />\r\n                        重置\r\n                      </Button>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))\r\n              )}\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AdminVideoUsage;\r\n"],"names":["AdminVideoUsage","queryClient","useQueryClient","searchTerm","setSearchTerm","useState","dailyLimit","setDailyLimit","useQuery","data","supabase","limit","usageData","isLoading","todayStart","rows","userMap","row","userIds","profiles","u","profile","p","resetMutation","useMutation","userId","toast","updateLimitMutation","error","jsxs","jsx","Video","Card","CardHeader","CardTitle","Settings","CardContent","Input","e","Button","Search","Table","TableHeader","TableRow","TableHead","TableBody","TableCell","user","format","r","i","Trash2"],"mappings":"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"}