import{t as d,A as a,y as i,u as p,af as y,ai as l,ae as o}from"./index-tBrG_sQo.js";const _=()=>{const{user:t}=d();return a({queryKey:["user-points",t==null?void 0:t.id],queryFn:async()=>{if(!(t!=null&&t.id))return 0;const{data:e,error:s}=await i.from("profiles").select("points").eq("id",t.id).single();if(s)throw s;return(e==null?void 0:e.points)??0},enabled:!!(t!=null&&t.id)})},q=t=>{const{user:e}=d(),s=e==null?void 0:e.id;return a({queryKey:["points-transactions",s],queryFn:async()=>{if(!s)return[];const{data:n,error:r}=await i.from("points_transactions").select("*").eq("user_id",s).order("created_at",{ascending:!1});if(r)throw r;return n},enabled:!!s})},w=t=>a({queryKey:["all-points-transactions",t],queryFn:async()=>{let e=i.from("points_transactions").select(`
          *,
          profiles:user_id (
            id,
            display_name,
            avatar_url
          )
        `).order("created_at",{ascending:!1}).limit(500);const{data:s,error:n}=await e;if(n)throw n;return s}}),g=()=>a({queryKey:["points-settings"],queryFn:async()=>{const{data:t,error:e}=await i.from("points_settings").select("*");if(e)throw e;return t}}),v=()=>{const{t}=p(),e=y();return l({mutationFn:async({key:s,value:n})=>{const{error:r}=await i.from("points_settings").update({value:n,updated_at:new Date().toISOString()}).eq("key",s);if(r)throw r},onSuccess:()=>{e.invalidateQueries({queryKey:["points-settings"]}),o({title:t("common.success"),description:t("admin.points.settingUpdated")})},onError:()=>{o({title:t("common.error"),description:t("common.errorOccurred"),variant:"destructive"})}})},K=()=>{const{t}=p(),e=y();return l({mutationFn:async({userId:s,amount:n,reason:r})=>{const{data:m,error:u}=await i.rpc("admin_modify_points",{p_target_user_id:s,p_amount:n,p_reason:r});if(u)throw u;const c=m;if(!c.success)throw new Error(c.error||"Unknown error");return c},onSuccess:(s,n)=>{e.invalidateQueries({queryKey:["user-points"]}),e.invalidateQueries({queryKey:["points-transactions"]}),e.invalidateQueries({queryKey:["all-points-transactions"]}),e.invalidateQueries({queryKey:["profiles"]}),o({title:t("common.success"),description:n.amount>0?t("admin.points.grantSuccess"):t("admin.points.deductSuccess")})},onError:s=>{o({title:t("common.error"),description:s.message==="insufficient_points"?t("admin.points.insufficientPoints"):t("common.errorOccurred"),variant:"destructive"})}})};export{K as a,w as b,g as c,v as d,_ as e,q as u};
