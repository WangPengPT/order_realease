import{r as G,j as e}from"./vendor-react-core-BErlw7p5.js";import{c as Q,L as y}from"./vendor-router-CLK0c9aH.js";import{g as M,B as v,X as U,Y as Z,Z as J,$ as ee,a0 as N,C as l,j as d,h as w,p as _,a2 as T,N as z,O as A,P as H,o as O,s as j}from"./index-CEqKPgls.js";import{d as se}from"./useRestaurants-D4oR_teN.js";import{u as ae}from"./useLocalizedContent-DqTgPnyL.js";import{a as b}from"./vendor-query-BS0wY7WL.js";import{u as te}from"./vendor-i18n-CqcxoxDo.js";import{s as C,I as K,C as c,c as R}from"./vendor-date-fYlqblcl.js";import{O as re,w as ne,u as L,e as B,aY as ie,W as le,ae as de,q as E,H as Y,aH as ce}from"./vendor-icons-C2Bicc1E.js";import{R as me,L as oe,C as xe,X as he,Y as ue,T as ge,b as je}from"./vendor-charts-C2PWrzKy.js";import"./vendor-editor-BdQcs4B3.js";import"./vendor-misc-DH4LiFnZ.js";import"./vendor-ui-other-CPTlx-W2.js";import"./vendor-supabase-Clrw0GhO.js";import"./vendor-ui-dialog-Sv_VEL0d.js";import"./vendor-ui-dropdown-DwTcg2UT.js";const ze=()=>{const{id:r}=Q(),{t:a}=te(),{localizeRestaurant:P}=ae(),[m,V]=G.useState("30days"),X=()=>{const s=new Date;switch(m){case"today":return R(s).toISOString();case"7days":return R(C(s,6)).toISOString();case"30days":return R(C(s,29)).toISOString();default:return null}},$=()=>{switch(m){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:o,isLoading:W}=se(r),g=X(),{data:D=[],isLoading:pe}=b({queryKey:["restaurant-page-views",r,m],queryFn:async()=>{let s=j.from("page_views").select("created_at").eq("page_type","restaurant").eq("target_id",r);g&&(s=s.gte("created_at",g));const{data:t,error:i}=await s;if(i)throw i;return t},enabled:!!r}),{data:x=[],isLoading:fe}=b({queryKey:["restaurant-comments",r,m],queryFn:async()=>{let s=j.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_type","restaurant").eq("target_id",r).order("created_at",{ascending:!1});g&&(s=s.gte("created_at",g));const{data:t,error:i}=await s;if(i)throw i;if(t&&t.length>0){const p=[...new Set(t.map(n=>n.user_id))],{data:h}=await j.rpc("get_public_profiles",{user_ids:p});return t.map(n=>({...n,profile:h?.find(u=>u.id===n.user_id)}))}return[]},enabled:!!r}),{data:f=[],isLoading:ye}=b({queryKey:["restaurant-favorites",r,m],queryFn:async()=>{let s=j.from("favorites").select("user_id, created_at").eq("restaurant_id",r);g&&(s=s.gte("created_at",g));const{data:t,error:i}=await s;if(i)throw i;if(t&&t.length>0){const p=t.map(n=>n.user_id),{data:h}=await j.rpc("get_public_profiles",{user_ids:p});return t.map(n=>({...n,profile:h?.find(u=>u.id===n.user_id)}))}return[]},enabled:!!r}),{data:F=[]}=b({queryKey:["restaurant-activities",r],queryFn:async()=>{const{data:s,error:t}=await j.from("activity_restaurants").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            status
          )
        `).eq("restaurant_id",r);if(t)throw t;return s?.map(i=>i.activities).filter(Boolean)||[]},enabled:!!r}),k=(()=>{if(m==="all"){const t=new Date,i=C(t,29);return K({start:i,end:t}).map(h=>{const n=c(h,"yyyy-MM-dd"),u=D.filter(q=>c(new Date(q.created_at),"yyyy-MM-dd")===n).length;return{date:n,views:u}})}else{const s=$(),t=new Date,i=C(t,s-1);return K({start:i,end:t}).map(h=>{const n=c(h,"yyyy-MM-dd"),u=D.filter(q=>c(new Date(q.created_at),"yyyy-MM-dd")===n).length;return{date:n,views:u}})}})(),I=x.length>0?x.filter(s=>s.rating_value).reduce((s,t)=>s+(t.rating_value||0),0)/x.filter(s=>s.rating_value).length:0,S=o?P(o):null;return W?e.jsxs("div",{className:"space-y-6",children:[e.jsx(M,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(M,{className:"h-24"},s))}),e.jsx(M,{className:"h-64"})]}):!o||!S?e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"text-muted-foreground",children:a("error.notFound")})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(v,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(y,{to:"/admin/restaurant-stats",children:e.jsx(re,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[o.image_url?e.jsx("img",{src:o.image_url,alt:S.name,className:"w-12 h-12 rounded-lg object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(ne,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:S.name}),o.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(L,{className:"h-3 w-3 fill-amber-400 text-amber-400"}),e.jsx("span",{children:o.rating.toFixed(1)})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(U,{value:m,onValueChange:s=>V(s),children:[e.jsx(Z,{className:"w-[140px]",children:e.jsx(J,{})}),e.jsxs(ee,{children:[e.jsx(N,{value:"today",children:a("analytics.today","今日")}),e.jsx(N,{value:"7days",children:a("analytics.last7Days","近7天")}),e.jsx(N,{value:"30days",children:a("analytics.last30Days","近30天")}),e.jsx(N,{value:"all",children:a("analytics.allTime","所有时间")})]})]}),e.jsx(v,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(y,{to:`/restaurant/${r}`,target:"_blank",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),a("admin.preview","预览")]})}),e.jsx(v,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(y,{to:"/admin/restaurants",state:{editRestaurantId:r},children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),a("admin.edit","编辑")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx(de,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.views","浏览量")}),e.jsx("p",{className:"text-2xl font-bold",children:D.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx(E,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.comments","评论")}),e.jsx("p",{className:"text-2xl font-bold",children:x.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg",children:e.jsx(Y,{className:"h-5 w-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.favorites","收藏")}),e.jsx("p",{className:"text-2xl font-bold",children:f.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/10 rounded-lg",children:e.jsx(L,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.avgRating","平均评分")}),e.jsx("p",{className:"text-2xl font-bold",children:I>0?I.toFixed(1):"-"})]})]})})})]}),e.jsxs(l,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),a("admin.viewTrend","浏览趋势")]})}),e.jsx(d,{children:e.jsx("div",{className:"h-[300px]",children:k.length>0?e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(oe,{data:k,children:[e.jsx(xe,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(he,{dataKey:"date",tickFormatter:s=>c(new Date(s),"MM/dd"),className:"text-xs"}),e.jsx(ue,{className:"text-xs"}),e.jsx(ge,{labelFormatter:s=>c(new Date(s),"yyyy-MM-dd"),contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(je,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,name:a("admin.views")})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:a("analytics.noData")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsxs(w,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),a("admin.recentComments","最近评论")]}),e.jsx(T,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(x.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[x.slice(0,10).map(s=>e.jsxs("div",{className:"flex gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(z,{className:"h-8 w-8",children:[e.jsx(A,{src:s.profile?.avatar_url}),e.jsx(H,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||a("common.anonymous")}),s.rating_value&&e.jsxs(O,{variant:"secondary",className:"text-xs",children:[e.jsx(L,{className:"h-3 w-3 mr-1 fill-amber-400 text-amber-400"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:c(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},s.id)),x.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noComments","暂无评论")})]})})]}),e.jsxs(l,{children:[e.jsxs(w,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),a("admin.recentFavorites","最近收藏")]}),e.jsx(T,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(f.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:[f.slice(0,10).map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(z,{className:"h-8 w-8",children:[e.jsx(A,{src:s.profile?.avatar_url}),e.jsx(H,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||a("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},t)),f.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noFavorites","暂无收藏")})]})})]})]}),e.jsxs(l,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),a("admin.participatingActivities","参与的活动")]})}),e.jsx(d,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[F.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.title_zh||s.title_en}),e.jsx(O,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?a("admin.published","已发布"):a("admin.draft","草稿")})]}),e.jsx(v,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:e.jsx(y,{to:`/admin/activity-stats/${s.id}`,children:a("admin.viewStats","查看统计")})})]},s.id)),F.length===0&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:a("admin.noActivities","暂未参与活动")})]})})]})]})};export{ze as default};
//# sourceMappingURL=AdminRestaurantStats-B4sGSvrh.js.map
