import{s as xe,q as Z,v as ee,p as te,r as u,j as e,by as ve,X as Y,bW as ye,w as n}from"./vendor-react-DTNwRJdt.js";import{u as V,s as f,f as re,D as je,W as Ce,B as w,c as we,d as _e,e as be,T as Ne,U as T,a2 as Se,a3 as De,a4 as Ee,a5 as Te,a6 as Ue,a8 as Ie,I as L,A as qe,t as Fe,v as Ae,w as ke,x as Re,y as Pe,z as ze,E as Qe}from"./index-60xCuNp_.js";import{I as $e,a as Ke,b as Q}from"./input-otp-CFGCIdCN.js";import{T as Me}from"./TranslateButton-CjPyQJkV.js";const se=new Set,He=(o,g="restaurant",d)=>{const{user:l}=V();return xe({queryKey:["comments",o,g],enabled:d?.enabled!==!1&&!!o,queryFn:async()=>{let t=f.from("comments").select("*").eq("target_id",o).eq("target_type",g).order("created_at",{ascending:!1});const{data:c,error:N}=await t;if(N)throw N;if(!c||c.length===0)return[];const y=c.filter(s=>s.moderation_status==="approved"||l&&s.user_id===l.id&&s.moderation_status==="pending"||l&&s.user_id===l.id&&s.moderation_status==="flagged"&&se.has(s.id)),U=[...new Set(y.map(s=>s.user_id))],{data:_}=await f.rpc("get_public_profiles",{user_ids:U}),p=new Map((_||[]).map(s=>[s.id,{display_name:s.display_name,avatar_url:s.avatar_url}])),h=y.filter(s=>!s.parent_id),j=y.filter(s=>s.parent_id),C=new Map;return j.forEach(s=>{const i=s.parent_id;C.has(i)||C.set(i,[]),C.get(i).push(s)}),h.map(s=>({...s,moderation_status:s.moderation_status,profiles:p.get(s.user_id),replies:(C.get(s.id)||[]).sort((i,I)=>new Date(i.created_at).getTime()-new Date(I.created_at).getTime()).map(i=>({...i,moderation_status:i.moderation_status,profiles:p.get(i.user_id)}))}))},staleTime:3e4})},We=()=>{const{user:o}=V(),{toast:g}=re(),d=Z();return ee({mutationFn:async({targetId:l,targetType:t,content:c,ratingValue:N,priceRange:y,imageUrl:U,parentId:_})=>{if(!o)throw new Error("User not authenticated");const p={user_id:o.id,target_id:l,target_type:t,content:c,parent_id:_,moderation_status:"pending"};_||(N&&(p.rating_value=N),y&&(p.price_range=y)),U&&(p.image_url=U);const{data:h,error:j}=await f.from("comments").insert(p).select().single();if(j)throw j;try{const{data:C,error:v}=await f.functions.invoke("moderate-comment",{body:{comment_id:h.id,content:c,user_id:o.id,sensitive_word_detected:!1,target_id:l,target_type:t}});v&&(console.error("AI moderation error:",v),await f.from("comments").update({moderation_status:"approved"}).eq("id",h.id))}catch(C){console.error("Failed to invoke AI moderation:",C),await f.from("comments").update({moderation_status:"approved"}).eq("id",h.id)}return h},onSuccess:(l,t)=>{l?.id&&se.add(l.id),d.invalidateQueries({queryKey:["comments",t.targetId,t.targetType]}),d.invalidateQueries({queryKey:["restaurants"]}),d.invalidateQueries({queryKey:["restaurant",t.targetId]}),t.targetType==="post"&&(d.invalidateQueries({queryKey:["community-post",t.targetId]}),d.invalidateQueries({queryKey:["community-posts"]}))},onError:()=>{g({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Ge=()=>{const{t:o}=te(),{toast:g}=re(),d=Z();return ee({mutationFn:async l=>{const{error:t}=await f.from("comments").delete().eq("id",l);if(t)throw t},onSuccess:(l,t)=>{d.invalidateQueries({queryKey:["comments"]}),d.invalidateQueries({queryKey:["community-post"]}),d.invalidateQueries({queryKey:["community-posts"]}),g({title:o("common.success","Success"),description:o("toast.commentDeleted","Comment deleted successfully")})},onError:()=>{g({title:o("common.error","Error"),description:o("toast.commentDeleteFailed","Failed to delete comment"),variant:"destructive"})}})},Xe=({targetType:o,targetId:g,trigger:d,onLoginRequired:l})=>{const{t}=te(),{user:c}=V(),[N,y]=u.useState(!1),[U,_]=u.useState(!1),[p,h]=u.useState(!1),[j,C]=u.useState(""),[v,s]=u.useState(""),[i,I]=u.useState(c?.email||""),[b,A]=u.useState([""]),[q,$]=u.useState([]),[O,B]=u.useState(!1),[K,F]=u.useState("form"),[k,R]=u.useState(""),[S,M]=u.useState(0),[H,W]=u.useState(!1),ae=r=>{if(r&&!c){l?.();return}y(r),r&&c?.email&&I(c.email),r||(F("form"),R(""),M(0))};u.useEffect(()=>{let r;return S>0&&(r=setTimeout(()=>M(S-1),1e3)),()=>clearTimeout(r)},[S]);const ie=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],oe=()=>{A([...b,""])},ne=r=>{A(b.filter((a,m)=>m!==r))},le=(r,a)=>{const m=[...b];m[r]=a,A(m)},ce=r=>{const a=Array.from(r.target.files||[]);if(a.filter(x=>x.size>5*1024*1024).length>0){n.error(t("report.imageTooLarge"));return}const D=["image/jpeg","image/png","image/webp","image/gif"];if(a.filter(x=>!D.includes(x.type)).length>0){n.error(t("report.invalidImageType"));return}$(x=>[...x,...a])},de=r=>{$(a=>a.filter((m,D)=>D!==r))},me=async()=>{if(q.length===0)return[];B(!0);const r=[];try{for(const a of q){const m=a.name.split(".").pop(),E=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${m}`}`,{error:x}=await f.storage.from("report-evidence").upload(E,a);if(x)throw x;const{data:P}=f.storage.from("report-evidence").getPublicUrl(E);r.push(P.publicUrl)}return r}catch(a){throw console.error("Error uploading images:",a),a}finally{B(!1)}},G=async()=>{if(!i.trim()){n.error(t("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){n.error(t("report.invalidEmail"));return}W(!0);try{const{error:r}=await f.functions.invoke("send-verification-code",{body:{email:i}});if(r){n.error(t("auth.verificationCodeFailed")),console.error(r);return}F("verify"),n.success(t("auth.verificationCodeSent")),M(30)}catch(r){n.error(r.message||t("error.general"))}finally{W(!1)}},ue=async()=>{S>0||await G()},pe=async()=>{if(k.length!==4){n.error(t("auth.invalidVerificationCode"));return}h(!0);try{const{data:r,error:a}=await f.functions.invoke("verify-email-code",{body:{email:i,code:k}});if(a||!r?.success){r?.error==="This verification code has already been used"?n.error(t("auth.verificationCodeUsed")):n.error(r?.error||t("auth.invalidVerificationCode")),h(!1);return}F("submitting"),await X()}catch(r){n.error(r.message||t("error.general")),h(!1)}},fe=async()=>{if(!j){n.error(t("report.reasonPlaceholder"));return}if(!v||v.length<20){n.error(t("report.detailsMin"));return}if(!i.trim()){n.error(t("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){n.error(t("report.invalidEmail"));return}if(b.filter(a=>a.trim()!=="").length===0&&q.length===0){n.error(t("report.evidenceRequired"));return}c?_(!0):await G()},X=async()=>{h(!0);try{let r=[];try{r=await me()}catch{n.error(t("report.imageUploadFailed")),h(!1);return}const m=[...b.filter(z=>z.trim()!==""),...r],D={reporter_id:c?.id||null,target_type:o,target_id:g,reason:j,description:v,evidence_urls:m,reporter_contact:i};console.log("Attempting to insert report:",D);const{data:E,error:x}=await f.from("reports").insert(D).select().single();if(console.log("Insert result:",{report:E,error:x}),x)throw x;let P="Anonymous",J=i;if(c){const{data:z}=await f.from("profiles").select("display_name").eq("id",c.id).single();P=z?.display_name||"Unknown",J=c.email||i}await f.functions.invoke("send-report-email",{body:{reportId:E.id,reporterName:P,reporterEmail:J,targetType:o,targetId:g,reason:j,description:v,evidenceUrls:m.length>0?m:void 0,reporterContact:i||void 0}});const ge=E.id.substring(0,8).toUpperCase();n.success(t("report.successDetailed",{reference:ge}),{description:t("report.successDescription"),duration:8e3}),y(!1),_(!1),C(""),s(""),c||I(""),A([""]),$([]),F("form"),R("")}catch(r){console.error("Error submitting report:",r),n.error(t("report.failed"))}finally{h(!1)}},he=()=>{switch(o){case"comment":return t("report.reportComment");case"restaurant":return t("report.reportRestaurant");case"activity":return t("report.reportActivity");case"user":return t("report.reportUser");default:return t("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(je,{open:N,onOpenChange:ae,children:[e.jsx(Ce,{asChild:!0,children:d||e.jsxs(w,{variant:"ghost",size:"sm",children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),t("report.title")]})}),e.jsxs(we,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(be,{children:he()}),e.jsx(Ne,{children:t(K==="verify"?"auth.verificationCodeSent":"report.description")})]}),K==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"reason",children:t("report.reason")}),e.jsxs(Se,{value:j,onValueChange:C,children:[e.jsx(De,{children:e.jsx(Ee,{placeholder:t("report.reasonPlaceholder")})}),e.jsx(Te,{children:ie.map(r=>e.jsx(Ue,{value:r,children:t(`report.reasons.${r}`)},r))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"description",children:t("report.detailsLabel")}),e.jsx(Ie,{id:"description",value:v,onChange:r=>s(r.target.value),placeholder:t("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[v.length,"/20 ",t("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{htmlFor:"contact",children:[t("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(L,{id:"contact",type:"email",value:i,onChange:r=>I(r.target.value),placeholder:t("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{children:[t("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:t("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"image-upload",className:"text-sm font-medium",children:t("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:q.map((r,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(r),alt:`Evidence ${a+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(w,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>de(a),children:e.jsx(Y,{className:"w-3 h-3"})})]},a))}),e.jsx(L,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:ce,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(T,{className:"text-sm font-medium",children:t("report.evidenceUrls")}),b.map((r,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{value:r,onChange:m=>le(a,m.target.value),placeholder:t("report.evidencePlaceholder")}),b.length>1&&e.jsx(w,{variant:"ghost",size:"icon",onClick:()=>ne(a),children:e.jsx(Y,{className:"w-4 h-4"})})]},a)),e.jsxs(w,{variant:"outline",size:"sm",onClick:oe,className:"w-full",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),t("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(w,{variant:"outline",onClick:()=>y(!1),children:t("report.cancel")}),e.jsx(w,{onClick:fe,disabled:!j||v.length<20||!i.trim()||b.filter(r=>r.trim()!=="").length===0&&q.length===0||O||H,children:t(O?"common.uploading":H?"auth.sendingCode":"report.submit")})]})]}):K==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:t("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:t("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{maxLength:4,value:k,onChange:r=>R(r),children:e.jsxs(Ke,{children:[e.jsx(Q,{index:0}),e.jsx(Q,{index:1}),e.jsx(Q,{index:2}),e.jsx(Q,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:t("auth.verificationCodeHint",{email:i})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(w,{variant:"link",size:"sm",onClick:ue,disabled:S>0||p,children:S>0?`${t("auth.resendCode")} (${S}s)`:t("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",className:"w-full",onClick:()=>{F("form"),R("")},disabled:p,children:t("common.back")}),e.jsx(w,{className:"w-full",onClick:pe,disabled:k.length!==4||p,children:t(p?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(qe,{open:U,onOpenChange:_,children:e.jsxs(Fe,{children:[e.jsxs(Ae,{children:[e.jsx(ke,{children:t("report.confirmTitle")}),e.jsx(Re,{children:t("report.confirmMessage")})]}),e.jsxs(Pe,{children:[e.jsx(ze,{children:t("report.cancel")}),e.jsx(Qe,{onClick:X,disabled:p,children:t(p?"report.submitting":"report.submit")})]})]})})]})},Je=({text:o,className:g})=>{const[d,l]=u.useState(null);return e.jsxs("div",{className:g,children:[e.jsx("p",{className:"text-xs sm:text-sm text-foreground break-words",children:d||o}),e.jsx(Me,{text:o,onTranslation:l,className:"mt-0.5"})]})};export{Xe as R,Je as T,We as a,Ge as b,He as u};
//# sourceMappingURL=TranslatableText-05Juth9U.js.map
