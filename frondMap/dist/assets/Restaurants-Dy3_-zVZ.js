import{j as e,r as o}from"./vendor-react-core-BErlw7p5.js";import{u as ve,L as Ne}from"./vendor-router-CLK0c9aH.js";import{C as Q,g as t,h as U,j as G,k as J,m as we,n as be,I as ye,B as c,o as w,s as ke}from"./index-kEIDKiMZ.js";import{P as K,a as Y,b as Z}from"./popover-5UdhqzTn.js";import{u as Ce,a as Re,b as Se,c as Te}from"./useRestaurants-DqjXOEg2.js";import{c as Le,o as ze,g as De}from"./geolocation-YPf7LJYy.js";import{f as Fe,N as _e}from"./timeUtils-CT6bV2eP.js";import{u as Ae,R as Me,l as $e}from"./xiaoxiong-logo-clean--agh719N.js";import{u as Pe}from"./useLocalizedContent-DqTgPnyL.js";import{u as Be}from"./useActivities-DrndOeGI.js";import{u as Ee}from"./useInfiniteScroll-cJxGn4-3.js";import{L as Ie}from"./LocationPermissionDialog-_lae4nk3.js";import{u as Ve}from"./vendor-i18n-CqcxoxDo.js";import{L as We,f as qe,F as He,X as F,N as B,H as Oe,u as Xe,d as Qe,P as Ue,x as Ge,E as Je}from"./vendor-icons-C2Bicc1E.js";import"./vendor-editor-BdQcs4B3.js";import"./vendor-misc-DH4LiFnZ.js";import"./vendor-date-fYlqblcl.js";import"./vendor-ui-other-CPTlx-W2.js";import"./vendor-query-BS0wY7WL.js";import"./vendor-supabase-Clrw0GhO.js";import"./vendor-ui-dialog-Sv_VEL0d.js";import"./vendor-ui-dropdown-DwTcg2UT.js";import"./vendor-map-DWLu9L1V.js";import"./map-icon-DR07RZr_.js";const Ke=({count:p=6})=>e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:Array.from({length:p}).map((a,u)=>e.jsxs(Q,{className:"overflow-hidden flex flex-col h-full",style:{animationDelay:`${u*100}ms`},children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx(t,{className:"w-full h-full rounded-none"}),e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx(t,{className:"h-9 w-9 rounded-md"})})]}),e.jsx(U,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(t,{className:"h-6 w-40"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(t,{className:"h-4 w-4 rounded-full"}),e.jsx(t,{className:"h-4 w-16"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(t,{className:"h-5 w-5 rounded-full"}),e.jsx(t,{className:"h-5 w-8"})]})]})}),e.jsxs(G,{className:"space-y-3 flex-grow",children:[e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(t,{className:"h-5 w-16 rounded-full"}),e.jsx(t,{className:"h-5 w-20 rounded-full"}),e.jsx(t,{className:"h-5 w-14 rounded-full"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(t,{className:"h-4 w-full"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(t,{className:"h-4 w-32"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(t,{className:"h-4 w-40"})]})]}),e.jsxs(J,{className:"gap-2 mt-auto",children:[e.jsx(t,{className:"h-10 flex-1 rounded-md"}),e.jsx(t,{className:"h-10 w-10 rounded-md"})]})]},u))}),Ye=()=>e.jsxs("div",{className:"relative flex-1 min-h-[300px] sm:min-h-[400px] lg:mx-4 lg:mb-4 lg:rounded-lg overflow-hidden lg:shadow-lg bg-muted",children:[e.jsx(t,{className:"absolute inset-0 w-full h-full rounded-none"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2",children:e.jsx(t,{className:"h-8 w-8 rounded-full"})}),e.jsx("div",{className:"absolute top-1/4 left-1/3",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute top-1/3 right-1/4",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute bottom-1/3 left-1/4",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute bottom-1/4 right-1/3",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-4 left-4 z-10",children:e.jsx(t,{className:"h-10 w-36 rounded-full"})}),e.jsxs("div",{className:"absolute top-4 right-4 z-10 flex flex-col gap-2",children:[e.jsx(t,{className:"h-8 w-8 rounded-md"}),e.jsx(t,{className:"h-8 w-8 rounded-md"})]})]}),Ze=({restaurant:p,language:a})=>{const[u,b]=o.useState(999),y=o.useRef(null),k=p.type.map((l,C)=>({key:`type-${C}`,label:l,variant:"secondary",color:void 0}));o.useEffect(()=>{const l=()=>{if(!y.current)return;const f=y.current,r=Array.from(f.querySelectorAll(".tag-badge"));if(r.length===0){setTimeout(l,50);return}const L=r[0]?.offsetTop;let i=r.length;for(let h=0;h<r.length;h++)if(r[h].offsetTop>L){i=h;break}if(i===r.length){b(r.length);return}const R=f.offsetWidth,x=40;let z=0,j=i;for(let h=0;h<i;h++)z+=r[h].offsetWidth+8;z+x>R&&(j=Math.max(1,i-1)),b(j)};b(999);const C=setTimeout(l,100);return window.addEventListener("resize",l),()=>{clearTimeout(C),window.removeEventListener("resize",l)}},[k.length,p.id]);const d=k.slice(0,u),g=k.slice(u),m=g.length>0;return e.jsxs("div",{className:"flex items-center gap-2 -mt-1",children:[e.jsx("div",{ref:y,className:"flex gap-2 flex-wrap flex-1",children:d.map(l=>e.jsx(w,{variant:l.variant,className:"text-xs whitespace-nowrap tag-badge",style:l.color?{backgroundColor:l.color,color:"white"}:void 0,children:l.label},l.key))}),m&&e.jsxs(K,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-muted-foreground hover:text-foreground flex-shrink-0",children:e.jsx(Je,{className:"h-4 w-4"})})}),e.jsx(Z,{className:"w-auto max-w-80",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map(l=>e.jsx(w,{variant:l.variant,className:"text-xs",style:l.color?{backgroundColor:l.color,color:"white"}:void 0,children:l.label},l.key))})})]})]})},ks=()=>{const p=ve(),{t:a,i18n:u}=Ve(),{toast:b}=we(),{localizeRestaurant:y}=Pe(),[T,k]=o.useState(""),[d,g]=o.useState([]),[m,l]=o.useState(null),[C,f]=o.useState([]),[r,L]=o.useState("list"),[i,R]=o.useState(null),[x,z]=o.useState(null),[j,h]=o.useState(!1),[_,ee]=o.useState(!1),[A,se]=o.useState(!1),[ae,M]=o.useState(!1),[te,$]=o.useState(!1),[S,le]=o.useState(null),{user:E}=be(),{data:I,isLoading:re}=Ce(T,d.length>0?d.join(","):void 0),{data:ne=[]}=Re(),{data:P=[]}=Se(),{data:ie=[]}=Be(),{data:oe={}}=Ae(),D=ie.filter(s=>(oe[s.id]||0)>0),ce=Te(),de=(s,n)=>{n.preventDefault(),n.stopPropagation(),E&&ce.mutate(s)},me=s=>{g(n=>n.includes(s)?n.filter(N=>N!==s):[...n,s])},xe=()=>{$(!0)},V=async()=>{$(!1);try{const s=await De();z({lat:s.coords.latitude,lng:s.coords.longitude}),h(!0),b({title:a("restaurants.locationEnabled"),description:a("restaurants.sortByDistance")})}catch(s){console.error("Location error:",s)}},he=s=>{R(s),s&&!x&&V()},ue=async s=>{if(m===s)l(null),f([]);else{l(s);const{data:n,error:N}=await ke.from("activity_restaurants").select("restaurant_id").eq("activity_id",s);N?(console.error("Error fetching activity restaurants:",N),f([])):f(n.map(je=>je.restaurant_id))}},W=I?.map(s=>{const n=y(s);if(x){const N=Le(x.lat,x.lng,s.lat,s.lng);return{...n,distance:N}}return n})||[],q=m?W.filter(s=>C.includes(s.id)):W,H=i&&x?q.filter(s=>s.distance&&s.distance<=i):q,v=x?[...H].sort((s,n)=>(s.distance||0)-(n.distance||0)):[...H].sort((s,n)=>(n.rating||0)-(s.rating||0)),{displayedData:O,hasMore:fe,loadMore:pe,reset:X}=Ee({data:v,initialItemsPerPage:12,incrementPerPage:12});o.useEffect(()=>{X()},[T,d,m,i,j,X]);const ge=s=>{p(`/restaurant/${s.id}`)};return e.jsx("div",{className:`bg-secondary/20 animate-fade-in ${r==="map"?"h-screen flex flex-col overflow-hidden":"min-h-screen py-8 px-4"}`,children:e.jsxs("div",{className:`${r==="map"?"flex flex-col h-full":"container mx-auto max-w-7xl"}`,children:[e.jsxs("div",{className:`${r==="map"?"px-4 pt-4 pb-2 flex-shrink-0":"mb-8"}`,children:[e.jsx("h1",{className:`text-4xl font-bold text-primary ${r==="map"?"hidden md:block md:mb-4":"mb-4"}`,children:a("restaurants.title")}),e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 md:items-center",children:[e.jsx(ye,{placeholder:a("restaurants.search"),value:T,onChange:s=>k(s.target.value),className:"w-full md:max-w-md"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(c,{variant:r==="list"?"default":"outline",size:"icon",onClick:()=>L("list"),title:a("restaurants.listView"),className:"flex-shrink-0",children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx(c,{variant:r==="map"?"default":"outline",size:"icon",onClick:()=>L("map"),title:a("restaurants.mapView"),className:"flex-shrink-0",children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsxs(K,{children:[e.jsx(Y,{asChild:!0,children:e.jsxs(c,{variant:d.length>0||m||i?"default":"outline",size:"icon",className:"flex-shrink-0 relative",title:a("restaurants.filter"),children:[e.jsx(He,{className:"w-4 h-4"}),(d.length>0||m||i)&&e.jsx(w,{variant:"secondary",className:"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:(d.length>0?1:0)+(m?1:0)+(i?1:0)})]})}),e.jsx(Z,{className:"w-[90vw] max-w-sm p-0",align:"start",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border/50 bg-muted/30",children:[e.jsx("span",{className:"font-semibold text-foreground text-base",children:a("restaurants.filter")}),(d.length>0||m||i)&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{g([]),l(null),f([]),R(null)},children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),a("common.actions.clearFilter")]})]}),e.jsxs("div",{className:"p-4 space-y-5",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("restaurants.restaurantTypes")}),e.jsxs("div",{className:"flex items-center gap-2",children:[d.length>0&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>g([]),children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]}),P.length>8&&e.jsx(c,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-primary hover:text-primary/80",onClick:()=>ee(!_),children:a(_?"common.showLess":"common.showMore")})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap max-h-36 overflow-y-auto pr-1",children:(_?P:P.slice(0,8)).map(s=>e.jsx(w,{variant:d.includes(s)?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${d.includes(s)?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>me(s),children:s},s))})]}),D.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("nav.activities")}),e.jsxs("div",{className:"flex items-center gap-2",children:[m&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{l(null),f([])},children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]}),D.length>8&&e.jsx(c,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-primary hover:text-primary/80",onClick:()=>se(!A),children:a(A?"common.showLess":"common.showMore")})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap max-h-36 overflow-y-auto pr-1",children:(A?D:D.slice(0,8)).map(s=>{const n=u.language==="zh"?s.badge_text_zh||s.title_zh:u.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(w,{variant:m===s.id?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${m===s.id?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>ue(s.id),children:n},s.id)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("restaurants.radius")}),i&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>R(null),children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[{value:null,label:a("restaurants.allRestaurants")},{value:5,label:a("restaurants.radius5km")},{value:10,label:a("restaurants.radius10km")},{value:20,label:a("restaurants.radius20km")}].map(s=>e.jsx(w,{variant:i===s.value?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${i===s.value?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>he(s.value),children:s.label},s.value??"all"))})]})]})]})})]}),x?e.jsx(c,{variant:j?"default":"outline",onClick:()=>h(!j),className:"flex-1 md:flex-initial whitespace-nowrap",children:a("restaurants.sortByDistance")}):e.jsxs(c,{variant:"outline",onClick:xe,className:"flex-1 md:flex-initial",children:[e.jsx(B,{className:"w-4 h-4 mr-2 flex-shrink-0"}),e.jsx("span",{className:"md:hidden whitespace-nowrap text-sm",children:a("restaurants.getLocationMobile")}),e.jsx("span",{className:"hidden md:inline whitespace-nowrap",children:a("restaurants.getLocation")})]})]})]})})]}),re||!I?r==="map"?e.jsx(Ye,{}):e.jsx(Ke,{count:6}):v.length===0?e.jsxs("div",{className:`text-center ${r==="map"?"flex-1 flex flex-col justify-center px-4":"py-20"}`,children:[e.jsx("p",{className:"text-xl text-muted-foreground",children:a("restaurants.noResults")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:a("restaurants.noResultsDesc")})]}):e.jsxs(e.Fragment,{children:[r==="map"&&v.length>0&&e.jsxs("div",{className:"relative flex-1 min-h-[300px] sm:min-h-[400px] lg:mx-4 lg:mb-4 lg:rounded-lg overflow-hidden lg:shadow-lg",children:[e.jsx(Me,{restaurants:v,onRestaurantClick:ge,userLocation:x,radiusFilter:i,showViewDetailsButton:!0}),e.jsxs("div",{className:"absolute bottom-4 left-4 z-10 pointer-events-none flex items-center gap-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg",children:[e.jsx("img",{src:$e,alt:"Xiaoxiong Market Logo",className:"h-6 w-6 object-contain"}),e.jsx("span",{className:"text-sm font-semibold text-foreground whitespace-nowrap",children:u.language==="zh"?"小熊市场":"Xiaoxiong Market"})]})]}),r==="list"&&v.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:O.map(s=>e.jsxs(Q,{className:"overflow-hidden hover:shadow-large transition-shadow flex flex-col h-full",children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx("img",{src:s.image_url||"https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600&q=80",alt:s.name,className:"w-full h-full object-cover transition-transform hover:scale-105"}),E&&e.jsx(c,{size:"icon",variant:"secondary",className:"absolute top-3 right-3",onClick:n=>de(s.id,n),children:e.jsx(Oe,{className:`w-5 h-5 ${ne.includes(s.id)?"fill-destructive text-destructive":""}`})})]}),e.jsx(U,{className:"mb-px pb-[15px]",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-card-foreground",children:s.name}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(B,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"font-semibold text-sm text-foreground",children:[s.distance.toFixed(1)," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xe,{className:`w-5 h-5 ${s.rating?"fill-accent text-accent":"text-muted-foreground"}`}),s.rating?e.jsx("span",{className:"font-semibold text-card-foreground",children:s.rating.toFixed(1)}):e.jsxs("span",{className:"text-xs text-muted-foreground text-center whitespace-nowrap",children:[a("restaurant.noRatingLine1"),e.jsx("br",{}),a("restaurant.noRatingLine2")]})]})]})}),e.jsxs(G,{className:"space-y-2 flex-grow",children:[e.jsx(Ze,{restaurant:s,language:u.language}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Qe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-1",children:s.address})]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Ue,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.phone})]}),s.opening_hours&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Ge,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:Fe(s.opening_hours)})]})]}),e.jsxs(J,{className:"gap-2 mt-auto",children:[e.jsx(c,{asChild:!0,className:"flex-1",children:e.jsx(Ne,{to:`/restaurant/${s.id}`,children:a("restaurants.viewDetails")})}),x&&e.jsx(c,{variant:"outline",size:"icon",onClick:()=>{le({lat:s.lat,lng:s.lng,name:s.name}),M(!0)},title:a("restaurants.directions"),children:e.jsx(B,{className:"w-4 h-4"})})]})]},s.id))}),fe&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsxs(c,{onClick:pe,size:"lg",variant:"outline",children:[a("common.loadMore")," (",O.length," / ",v.length,")"]})})]})]}),e.jsx(_e,{open:ae,onOpenChange:M,onConfirm:()=>{S&&ze(S.lat,S.lng,S.name),M(!1)},destinationName:S?.name||""}),e.jsx(Ie,{open:te,onOpenChange:$,onConfirm:V})]})})};export{ks as default};
//# sourceMappingURL=Restaurants-Dy3_-zVZ.js.map
