{"version":3,"file":"useRecipeVideo-CWGjMCP6.js","sources":["../../src/hooks/useRecipeVideo.ts"],"sourcesContent":["import { useState, useCallback, useRef, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\nconst SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;\r\nconst ANON_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;\r\nconst VIDEO_URL = `${SUPABASE_URL}/functions/v1/ai-recipe-video`;\r\n\r\nconst STORAGE_KEY = \"xiaoxiong_video_tasks\";\r\n\r\nexport type VideoTaskStatus = \"idle\" | \"creating\" | \"processing\" | \"succeeded\" | \"failed\";\r\n\r\nexport interface VideoTask {\r\n  taskId: string;\r\n  status: VideoTaskStatus;\r\n  videoUrl: string | null;\r\n  error: string | null;\r\n}\r\n\r\nexport interface RecipeVideoState {\r\n  /** All completed or in-progress tasks (max 2) */\r\n  tasks: VideoTask[];\r\n  /** Index of the currently selected video (in the succeeded list) */\r\n  selectedIndex: number;\r\n}\r\n\r\nconst MAX_ATTEMPTS = 2;\r\n\r\n/** Load persisted tasks from localStorage */\r\nconst loadPersistedState = (): Record<string, RecipeVideoState> => {\r\n  try {\r\n    const raw = localStorage.getItem(STORAGE_KEY);\r\n    if (!raw) return {};\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    return {};\r\n  }\r\n};\r\n\r\n/** Save state to localStorage (only succeeded videos) */\r\nconst persistState = (states: Record<string, RecipeVideoState>) => {\r\n  try {\r\n    const toSave: Record<string, RecipeVideoState> = {};\r\n    for (const [key, state] of Object.entries(states)) {\r\n      const succeededTasks = (state.tasks ?? []).filter(t => t.status === \"succeeded\" && t.videoUrl);\r\n      if (succeededTasks.length > 0) {\r\n        toSave[key] = { tasks: succeededTasks, selectedIndex: Math.min(state.selectedIndex, succeededTasks.length - 1) };\r\n      }\r\n    }\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));\r\n  } catch {\r\n    // ignore\r\n  }\r\n};\r\n\r\nexport const useRecipeVideo = () => {\r\n  const [videoStates, setVideoStates] = useState<Record<string, RecipeVideoState>>(() => loadPersistedState());\r\n  const pollTimers = useRef<Record<string, number>>({});\r\n\r\n  useEffect(() => {\r\n    persistState(videoStates);\r\n  }, [videoStates]);\r\n\r\n  const updateTaskInList = useCallback((recipeName: string, taskId: string, patch: Partial<VideoTask>) => {\r\n    setVideoStates(prev => {\r\n      const state = prev[recipeName];\r\n      if (!state) return prev;\r\n      const newTasks = (state.tasks ?? []).map(t => t.taskId === taskId ? { ...t, ...patch } : t);\r\n      return { ...prev, [recipeName]: { ...state, tasks: newTasks } };\r\n    });\r\n  }, []);\r\n\r\n  const pollTask = useCallback(async (recipeName: string, taskId: string) => {\r\n    const timerKey = `${recipeName}_${taskId}`;\r\n    try {\r\n      const resp = await fetch(`${VIDEO_URL}/${taskId}`, {\r\n        headers: { Authorization: `Bearer ${ANON_KEY}` },\r\n      });\r\n      if (!resp.ok) throw new Error(`Poll failed ${resp.status}`);\r\n      const data = await resp.json();\r\n\r\n      const status = data.status;\r\n      if (status === \"succeeded\") {\r\n        const videoUrl =\r\n          data.content?.video_url ||\r\n          data.content?.[0]?.url ||\r\n          data.content?.[0]?.video_url ||\r\n          null;\r\n        updateTaskInList(recipeName, taskId, { status: \"succeeded\", videoUrl });\r\n        // Auto-select the newest succeeded video\r\n        setVideoStates(prev => {\r\n          const state = prev[recipeName];\r\n          if (!state) return prev;\r\n          const succeededIdx = (state.tasks ?? []).filter(t => t.taskId === taskId || (t.status === \"succeeded\" && t.videoUrl)).length - 1;\r\n          return { ...prev, [recipeName]: { ...state, selectedIndex: Math.max(0, succeededIdx) } };\r\n        });\r\n        delete pollTimers.current[timerKey];\r\n      } else if (status === \"failed\") {\r\n        updateTaskInList(recipeName, taskId, { status: \"failed\", error: data.error?.message || \"视频生成失败\" });\r\n        delete pollTimers.current[timerKey];\r\n      } else {\r\n        pollTimers.current[timerKey] = window.setTimeout(() => pollTask(recipeName, taskId), 6000);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Poll video task error:\", err);\r\n      updateTaskInList(recipeName, taskId, { status: \"failed\", error: \"查询视频状态失败\" });\r\n      delete pollTimers.current[timerKey];\r\n    }\r\n  }, [updateTaskInList]);\r\n\r\n  const generateVideo = useCallback(async (recipeName: string, imageUrl: string, prompt?: string) => {\r\n    const existing = videoStates[recipeName];\r\n    const totalAttempts = existing?.tasks?.length ?? 0;\r\n\r\n    // Check if already at max attempts\r\n    if (totalAttempts >= MAX_ATTEMPTS) return;\r\n\r\n    // Check if there's an active task (creating/processing)\r\n    if (existing?.tasks?.some(t => t.status === \"creating\" || t.status === \"processing\")) return;\r\n\r\n    const newTask: VideoTask = { taskId: \"\", status: \"creating\", videoUrl: null, error: null };\r\n\r\n    setVideoStates(prev => {\r\n      const state = prev[recipeName] || { tasks: [], selectedIndex: 0 };\r\n      const tasks = state.tasks ?? [];\r\n      const keptTasks = tasks.filter(t => t.status === \"succeeded\");\r\n      return {\r\n        ...prev,\r\n        [recipeName]: { tasks: [...keptTasks, newTask], selectedIndex: state.selectedIndex },\r\n      };\r\n    });\r\n\r\n    try {\r\n      // Get current user id\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      \r\n      const resp = await fetch(VIDEO_URL, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${ANON_KEY}`,\r\n        },\r\n        body: JSON.stringify({ \r\n          image_url: imageUrl, \r\n          prompt,\r\n          user_id: user?.id || null,\r\n          recipe_name: recipeName,\r\n        }),\r\n      });\r\n\r\n      if (!resp.ok) {\r\n        const errData = await resp.json().catch(() => ({}));\r\n        if (resp.status === 429 && errData.error === \"daily_limit_reached\") {\r\n          throw new Error(errData.message || \"今日视频生成次数已达上限\");\r\n        }\r\n        throw new Error(errData.error || `Error ${resp.status}`);\r\n      }\r\n\r\n      const data = await resp.json();\r\n      const taskId = data.id;\r\n      if (!taskId) throw new Error(\"No task ID returned\");\r\n\r\n      // Update the placeholder task with real taskId\r\n      setVideoStates(prev => {\r\n        const state = prev[recipeName];\r\n        if (!state) return prev;\r\n        const newTasks = (state.tasks ?? []).map(t => t.status === \"creating\" && !t.taskId ? { ...t, taskId, status: \"processing\" as const } : t);\r\n        return { ...prev, [recipeName]: { ...state, tasks: newTasks } };\r\n      });\r\n\r\n      const timerKey = `${recipeName}_${taskId}`;\r\n      pollTimers.current[timerKey] = window.setTimeout(() => pollTask(recipeName, taskId), 6000);\r\n    } catch (err: any) {\r\n      console.error(\"Generate video error:\", err);\r\n      // Mark the creating task as failed\r\n      setVideoStates(prev => {\r\n        const state = prev[recipeName];\r\n        if (!state) return prev;\r\n        const newTasks = (state.tasks ?? []).map(t => t.status === \"creating\" ? { ...t, status: \"failed\" as const, error: err.message || \"创建视频任务失败\" } : t);\r\n        return { ...prev, [recipeName]: { ...state, tasks: newTasks } };\r\n      });\r\n    }\r\n  }, [pollTask, videoStates]);\r\n\r\n  const selectVideo = useCallback((recipeName: string, index: number) => {\r\n    setVideoStates(prev => {\r\n      const state = prev[recipeName];\r\n      if (!state) return prev;\r\n      return { ...prev, [recipeName]: { ...state, selectedIndex: index } };\r\n    });\r\n  }, []);\r\n\r\n  // Cleanup timers on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      Object.values(pollTimers.current).forEach(t => clearTimeout(t));\r\n    };\r\n  }, []);\r\n\r\n  const clearTask = useCallback((recipeName: string) => {\r\n    // Clear all timers for this recipe\r\n    Object.keys(pollTimers.current).forEach(key => {\r\n      if (key.startsWith(recipeName)) {\r\n        clearTimeout(pollTimers.current[key]);\r\n        delete pollTimers.current[key];\r\n      }\r\n    });\r\n    setVideoStates(prev => {\r\n      const next = { ...prev };\r\n      delete next[recipeName];\r\n      return next;\r\n    });\r\n  }, []);\r\n\r\n  // Derive legacy-compatible videoTasks for backward compat\r\n  const videoTasks: Record<string, VideoTask> = {};\r\n  for (const [key, state] of Object.entries(videoStates)) {\r\n    const tasks = state?.tasks ?? [];\r\n    if (tasks.length === 0) continue;\r\n    const activeTask = tasks.find(t => t.status === \"creating\" || t.status === \"processing\");\r\n    const selectedSucceeded = tasks.filter(t => t.status === \"succeeded\")[state?.selectedIndex ?? 0];\r\n    const failedTask = tasks.find(t => t.status === \"failed\");\r\n    videoTasks[key] = activeTask || selectedSucceeded || failedTask || tasks[tasks.length - 1];\r\n  }\r\n\r\n  return { videoTasks, videoStates, generateVideo, selectVideo, clearTask };\r\n};\r\n"],"names":["SUPABASE_URL","ANON_KEY","VIDEO_URL","STORAGE_KEY","MAX_ATTEMPTS","loadPersistedState","raw","persistState","states","toSave","key","state","succeededTasks","t","useRecipeVideo","videoStates","setVideoStates","useState","pollTimers","useRef","useEffect","updateTaskInList","useCallback","recipeName","taskId","patch","prev","newTasks","pollTask","timerKey","resp","data","status","videoUrl","succeededIdx","err","generateVideo","imageUrl","prompt","existing","newTask","keptTasks","user","supabase","errData","selectVideo","index","clearTask","next","videoTasks","tasks","activeTask","selectedSucceeded","failedTask"],"mappings":"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"}