{"version":3,"file":"useActivityRealtime-BAP_iRS6.js","sources":["../../src/hooks/useActivityRealtime.ts"],"sourcesContent":["import { useEffect } from \"react\";\r\nimport { useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\n/**\r\n * Hook to subscribe to realtime updates for activity subscriptions and shares\r\n * This will automatically update the UI when someone favorites or shares an activity\r\n */\r\nexport const useActivityRealtime = (activityId?: string) => {\r\n  const queryClient = useQueryClient();\r\n\r\n  useEffect(() => {\r\n    // Create a unique channel for this hook instance\r\n    const channelName = activityId \r\n      ? `activity-realtime-${activityId}` \r\n      : 'activities-realtime-all';\r\n\r\n    const channel = supabase\r\n      .channel(channelName)\r\n      // Listen for subscription changes (favorites)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'subscriptions',\r\n          ...(activityId ? { filter: `activity_id=eq.${activityId}` } : {})\r\n        },\r\n        (payload) => {\r\n          console.log('Subscription change detected:', payload);\r\n          \r\n          // Invalidate relevant queries\r\n          if (activityId) {\r\n            queryClient.invalidateQueries({ queryKey: [\"subscriberCount\", activityId] });\r\n          }\r\n          queryClient.invalidateQueries({ queryKey: [\"activities\"] });\r\n          queryClient.invalidateQueries({ queryKey: [\"admin-activities\"] });\r\n        }\r\n      )\r\n      // Listen for share changes\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'activity_shares',\r\n          ...(activityId ? { filter: `activity_id=eq.${activityId}` } : {})\r\n        },\r\n        (payload) => {\r\n          console.log('Share change detected:', payload);\r\n          \r\n          // Invalidate relevant queries\r\n          if (activityId) {\r\n            queryClient.invalidateQueries({ queryKey: [\"shareCount\", activityId] });\r\n          }\r\n          queryClient.invalidateQueries({ queryKey: [\"activities\"] });\r\n          queryClient.invalidateQueries({ queryKey: [\"admin-activities\"] });\r\n        }\r\n      )\r\n      .subscribe((status) => {\r\n        console.log(`Realtime subscription status for ${channelName}:`, status);\r\n      });\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [activityId, queryClient]);\r\n};\r\n\r\n/**\r\n * Hook specifically for the activities list page\r\n * Subscribes to all subscription and share changes\r\n */\r\nexport const useActivitiesListRealtime = () => {\r\n  useActivityRealtime();\r\n};\r\n\r\n/**\r\n * Hook specifically for a single activity detail page\r\n */\r\nexport const useActivityDetailRealtime = (activityId: string) => {\r\n  useActivityRealtime(activityId);\r\n};\r\n"],"names":["useActivityRealtime","activityId","queryClient","useQueryClient","useEffect","channelName","channel","supabase","payload","status","useActivitiesListRealtime","useActivityDetailRealtime"],"mappings":"8FAQa,MAAAA,EAAuBC,GAAwB,CAC1D,MAAMC,EAAcC,IAEpBC,EAAAA,UAAU,IAAM,CAEd,MAAMC,EAAcJ,EAChB,qBAAqBA,CAAU,GAC/B,0BAEEK,EAAUC,EACb,QAAQF,CAAW,EAEnB,GACC,mBACA,CACE,MAAO,IACP,OAAQ,SACR,MAAO,gBACP,GAAIJ,EAAa,CAAE,OAAQ,kBAAkBA,CAAU,EAAA,EAAO,CAAC,CACjE,EACCO,GAAY,CACH,QAAA,IAAI,gCAAiCA,CAAO,EAGhDP,GACFC,EAAY,kBAAkB,CAAE,SAAU,CAAC,kBAAmBD,CAAU,EAAG,EAE7EC,EAAY,kBAAkB,CAAE,SAAU,CAAC,YAAY,CAAG,CAAA,EAC1DA,EAAY,kBAAkB,CAAE,SAAU,CAAC,kBAAkB,CAAG,CAAA,CAClE,CAAA,EAGD,GACC,mBACA,CACE,MAAO,IACP,OAAQ,SACR,MAAO,kBACP,GAAID,EAAa,CAAE,OAAQ,kBAAkBA,CAAU,EAAA,EAAO,CAAC,CACjE,EACCO,GAAY,CACH,QAAA,IAAI,yBAA0BA,CAAO,EAGzCP,GACFC,EAAY,kBAAkB,CAAE,SAAU,CAAC,aAAcD,CAAU,EAAG,EAExEC,EAAY,kBAAkB,CAAE,SAAU,CAAC,YAAY,CAAG,CAAA,EAC1DA,EAAY,kBAAkB,CAAE,SAAU,CAAC,kBAAkB,CAAG,CAAA,CAClE,CAAA,EAED,UAAWO,GAAW,CACrB,QAAQ,IAAI,oCAAoCJ,CAAW,IAAKI,CAAM,CAAA,CACvE,EAEH,MAAO,IAAM,CACXF,EAAS,cAAcD,CAAO,CAAA,CAChC,EACC,CAACL,EAAYC,CAAW,CAAC,CAC9B,EAMaQ,EAA4B,IAAM,CACzBV,GACtB,EAKaW,EAA6BV,GAAuB,CAC/DD,EAAoBC,CAAU,CAChC"}