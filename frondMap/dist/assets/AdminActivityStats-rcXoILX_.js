import{bw as J,p as Z,r as ee,s as g,j as e,L as se,bj as ae,b5 as te,bQ as ie,be as k,bq as F,a$ as T,b3 as R,ba as re,cw as ne,cx as le,cy as ce,cz as de,cA as me,cB as oe,cC as xe,cE as he}from"./vendor-react-3frukg7q.js";import{j as o,B as pe,a2 as ue,a3 as je,a4 as ge,a5 as fe,a6 as f,C as l,q as c,p as y,F as N,P as _,Q as b,R as C,g as ye,s as S}from"./index-DBl0LkXN.js";import{b as Ne,c as ve}from"./useActivities-CiIZkAMt.js";import{u as we}from"./useLocalizedContent-CqXl0rku.js";import{f as v}from"./paginatedQuery-qP-_V_iu.js";import{D as p,s as L,f as D}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CcYybVOv.js";const Fe=()=>{const{id:r}=J(),{t}=Z(),{getLocalizedField:I}=we(),[m,z]=ee.useState("30days"),K=()=>{const s=new Date;switch(m){case"today":return D(s).toISOString();case"7days":return D(L(s,6)).toISOString();case"30days":return D(L(s,29)).toISOString();default:return null}},V=()=>{switch(m){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:A,isLoading:E}=Ne(r),{data:B=[]}=ve(r),d=K(),{data:u=[],isLoading:H}=g({queryKey:["activity-subscribers",r,m],queryFn:async()=>{const s=await v("subscriptions","user_id, created_at",a=>(a=a.eq("activity_id",r).order("created_at",{ascending:!1}),d&&(a=a.gte("created_at",d)),a));if(s&&s.length>0){const a=s.map(i=>i.user_id),{data:n}=await S.rpc("get_public_profiles",{user_ids:a});return s.map(i=>({...i,profile:n?.find(h=>h.id===i.user_id)}))}return[]},enabled:!!r}),{data:j=[],isLoading:O}=g({queryKey:["activity-sharers",r,m],queryFn:async()=>{const s=await v("activity_shares","user_id, created_at",a=>(a=a.eq("activity_id",r).order("created_at",{ascending:!1}),d&&(a=a.gte("created_at",d)),a));if(s&&s.length>0){const a=s.map(i=>i.user_id),{data:n}=await S.rpc("get_public_profiles",{user_ids:a});return s.map(i=>({...i,profile:n?.find(h=>h.id===i.user_id)}))}return[]},enabled:!!r}),{data:x=[],isLoading:U}=g({queryKey:["activity-comments",r,m],queryFn:async()=>{const s=await v("comments","id, user_id, content, rating_value, created_at",a=>(a=a.eq("target_id",r).eq("target_type","activity").order("created_at",{ascending:!1}),d&&(a=a.gte("created_at",d)),a));if(s&&s.length>0){const a=[...new Set(s.map(i=>i.user_id))],{data:n}=await S.rpc("get_public_profiles",{user_ids:a});return s.map(i=>({...i,profile:n?.find(h=>h.id===i.user_id)}))}return[]},enabled:!!r}),{data:M=[],isLoading:P}=g({queryKey:["activity-page-views",r,m],queryFn:async()=>await v("page_views","created_at",s=>(s=s.eq("target_id",r).eq("page_type","activity"),d&&(s=s.gte("created_at",d)),s)),enabled:!!r}),Q=(()=>{const s=new Map,a=V();for(let n=a-1;n>=0;n--){const i=p(L(new Date,n),"MM-dd");s.set(i,0)}return M.forEach(n=>{const i=p(new Date(n.created_at),"MM-dd");s.has(i)&&s.set(i,(s.get(i)||0)+1)}),Array.from(s.entries()).map(([n,i])=>({date:n,views:i}))})(),W=M.length,G=u.length,X=j.length,w=x.filter(s=>s.rating_value!==null),Y=w.length>0?(w.reduce((s,a)=>s+(a.rating_value||0),0)/w.length).toFixed(1):"0.0",$=x.length;if(E)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(o,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(o,{className:"h-32"},s))})]});if(!A)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:t("common.notFound")})});const q=I(A,"title");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(pe,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(se,{to:"/admin/activity-stats",children:e.jsx(ae,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:t("admin.activityStats")}),e.jsx("p",{className:"text-muted-foreground",children:q})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-12 sm:ml-0",children:[e.jsx(te,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(ue,{value:m,onValueChange:s=>z(s),children:[e.jsx(je,{className:"w-[140px]",children:e.jsx(ge,{})}),e.jsxs(fe,{children:[e.jsx(f,{value:"today",children:t("analytics.today")}),e.jsx(f,{value:"7days",children:t("analytics.last7Days")}),e.jsx(f,{value:"30days",children:t("analytics.last30Days","近30天")}),e.jsx(f,{value:"all",children:t("analytics.allTime","所有时间")})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(l,{children:e.jsxs(c,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("analytics.pageViews")})]}),e.jsx("p",{className:"text-2xl font-bold",children:W})]})}),e.jsx(l,{children:e.jsxs(c,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(k,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.favorites")})]}),e.jsx("p",{className:"text-2xl font-bold",children:G})]})}),e.jsx(l,{children:e.jsxs(c,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.shares")})]}),e.jsx("p",{className:"text-2xl font-bold",children:X})]})}),e.jsx(l,{children:e.jsxs(c,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(T,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("restaurant.rating")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Y})]})}),e.jsx(l,{children:e.jsxs(c,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("restaurant.comments")})]}),e.jsx("p",{className:"text-2xl font-bold",children:$})]})}),e.jsx(l,{children:e.jsxs(c,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.participatingRestaurants")})]}),e.jsx("p",{className:"text-2xl font-bold",children:B.length})]})})]}),e.jsxs(l,{children:[e.jsx(y,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5"}),t("analytics.viewTrend")]})}),e.jsx(c,{children:e.jsx("div",{className:"h-[300px]",children:P?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(o,{className:"h-full w-full"})}):e.jsx(le,{width:"100%",height:"100%",children:e.jsxs(ce,{data:Q,children:[e.jsx(de,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(me,{dataKey:"date",className:"text-xs",tick:{fontSize:11}}),e.jsx(oe,{className:"text-xs",tick:{fontSize:11}}),e.jsx(xe,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(he,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1})]})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(y,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),t("admin.sharersList","分享用户")," (",j.length,")"]})}),e.jsx(c,{children:O?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(o,{className:"h-12 w-full"},s))}):j.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:j.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(_,{className:"h-8 w-8",children:[e.jsx(b,{src:s.profile?.avatar_url}),e.jsx(C,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:p(new Date(s.created_at),"yyyy-MM-dd")})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]}),e.jsxs(l,{children:[e.jsx(y,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"}),t("admin.subscribersList","收藏用户")," (",u.length,")"]})}),e.jsx(c,{children:H?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(o,{className:"h-12 w-full"},s))}):u.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:u.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(_,{className:"h-8 w-8",children:[e.jsx(b,{src:s.profile?.avatar_url}),e.jsx(C,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:p(new Date(s.created_at),"yyyy-MM-dd")})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]})]}),e.jsxs(l,{children:[e.jsx(y,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5"}),t("admin.commentsAndRatings","评论与评分")," (",x.length,")"]})}),e.jsx(c,{children:U?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(o,{className:"h-20 w-full"},s))}):x.length>0?e.jsx("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:x.map(s=>e.jsxs("div",{className:"p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(_,{className:"h-8 w-8",children:[e.jsx(b,{src:s.profile?.avatar_url}),e.jsx(C,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),s.rating_value&&e.jsxs(ye,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(T,{className:"w-3 h-3 fill-current"}),s.rating_value]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:p(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3",children:s.content})]},s.id))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]})]})};export{Fe as default};
//# sourceMappingURL=AdminActivityStats-rcXoILX_.js.map
