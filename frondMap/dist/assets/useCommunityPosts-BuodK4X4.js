import{a as d,u as c,b as m}from"./vendor-query-EnOED-MY.js";import{u as y,s as o,a6 as n}from"./index-CMe-28It.js";import{u as l}from"./vendor-i18n-DWR4v88Y.js";const w=e=>{const{user:r}=y();return d({queryKey:["community-posts",e],queryFn:async()=>{let t=o.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt)
        `).order("weight",{ascending:!1}).order("created_at",{ascending:!1});e?.authorId&&(t=t.eq("author_id",e.authorId)),e?.status&&(t=t.eq("status",e.status)),e?.limit&&(t=t.limit(e.limit));const{data:s,error:i}=await t;if(i)throw i;if(r&&s){const a=s.map(u=>u.id),{data:_}=await o.from("post_likes").select("post_id").eq("user_id",r.id).in("post_id",a),f=new Set(_?.map(u=>u.post_id)||[]);return s.map(u=>({...u,user_liked:f.has(u.id)}))}return s}})},v=e=>{const{user:r}=y();return d({queryKey:["community-post",e],queryFn:async()=>{const{data:t,error:s}=await o.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt)
        `).eq("id",e).single();if(s)throw s;if(r){const{data:i}=await o.from("post_likes").select("id").eq("post_id",e).eq("user_id",r.id).maybeSingle();return{...t,user_liked:!!i}}return t},enabled:!!e})},g=()=>{const e=c(),{t:r}=l();return m({mutationFn:async t=>{const{data:{user:s}}=await o.auth.getUser();if(!s)throw new Error("Not authenticated");const{data:i,error:a}=await o.from("community_posts").insert({author_id:s.id,content:t.content,image_urls:t.image_urls||[],video_url:t.video_url||null,activity_id:t.activity_id||null}).select().single();if(a)throw a;return i},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),n.success(r("community.postCreated","帖子发布成功"))},onError:t=>{console.error("Create post error:",t),n.error(r("community.postError","发布失败"))}})},k=()=>{const e=c(),{t:r}=l();return m({mutationFn:async({id:t,...s})=>{const{data:i,error:a}=await o.from("community_posts").update(s).eq("id",t).select().single();if(a)throw a;return i},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]}),e.invalidateQueries({queryKey:["admin-community-posts"]}),n.success(r("common.saved","保存成功"))},onError:t=>{console.error("Update post error:",t),n.error(r("common.error","操作失败"))}})},C=()=>{const e=c(),{t:r}=l();return m({mutationFn:async t=>{const{error:s}=await o.from("community_posts").delete().eq("id",t);if(s)throw s},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["admin-community-posts"]}),n.success(r("common.deleted","删除成功"))},onError:t=>{console.error("Delete post error:",t),n.error(r("common.error","操作失败"))}})},K=()=>{const e=c();return m({mutationFn:async({postId:r,liked:t})=>{const{data:{user:s}}=await o.auth.getUser();if(!s)throw new Error("Not authenticated");if(t){const{error:i}=await o.from("post_likes").delete().eq("post_id",r).eq("user_id",s.id);if(i)throw i}else{const{error:i}=await o.from("post_likes").insert({post_id:r,user_id:s.id});if(i)throw i}},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]})}})},Q=()=>{const e=c(),{t:r}=l();return m({mutationFn:async t=>{const{data:{user:s}}=await o.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:i}=await o.from("post_shares").insert({post_id:t,user_id:s.id});if(i)throw i},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]}),n.success(r("community.shared","分享成功"))}})},P=()=>{const{user:e}=y();return d({queryKey:["can-create-post",e?.id],queryFn:async()=>{if(!e)return!1;const{data:r,error:t}=await o.from("user_roles").select("role").eq("user_id",e.id).single();return t?!1:["merchant","supervisor","admin"].includes(r.role)},enabled:!!e})},F=e=>d({queryKey:["admin-community-posts",e],queryFn:async()=>{let r=o.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt)
        `).order("created_at",{ascending:!1});e?.status&&(r=r.eq("status",e.status)),e?.moderation_status&&(r=r.eq("moderation_status",e.moderation_status)),e?.search&&(r=r.ilike("content",`%${e.search}%`));const{data:t,error:s}=await r;if(s)throw s;return t}});export{F as a,C as b,K as c,g as d,w as e,P as f,Q as g,v as h,k as u};
//# sourceMappingURL=useCommunityPosts-BuodK4X4.js.map
