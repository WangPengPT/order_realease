import{c as Me,u as O,r as m,x as ae,j as e,D as re,aa as Ze,B as b,a as le,b as de,d as ce,a6 as oe,a1 as Je,L as ue,v as F,s as x,a7 as ie,I as Te,ag as I,ah as V,ai as $,aj as Q,ak as g,a9 as qe,G as T,A as Xe,n as es,ac as ss,C as X,k as ee,w as se,l as te,e as ts,g as as,as as is,a3 as ge,a4 as fe,a5 as _e,av as ve,h as ye,R as Ne,T as be,U as we,V as Ce,W as Se,Y as De,Z as Ae,$ as ke}from"./index-DDDDgwLZ.js";import{S as K}from"./separator-tCRYj1Nj.js";import{u as ze}from"./useLocalizedContent-pbKMpp6T.js";import{h as Fe,i as ns,j as rs,k as ls}from"./useCoupons-gmeOyMOl.js";import{C as ne}from"./checkbox-DbrPu41g.js";import{L as Ee}from"./link-DGIJJ1bq.js";import{f as M}from"./format-B49CpSpa.js";import{u as ds}from"./index.esm--54UaIQe.js";import{A as cs}from"./arrow-left-C3d3SO1X.js";import{T as Le}from"./ticket-DT_GPl8s.js";import{S as os}from"./search-C3gG7zdj.js";import{P as us}from"./pencil-CedC2cs4.js";import"./startOfDay-BDvM62ew.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=Me("Code",[["polyline",{points:"16 18 22 12 16 6",key:"z7tu5w"}],["polyline",{points:"8 6 2 12 8 18",key:"1eg1df"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=Me("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]),hs=({templateId:r,children:y})=>{O();const{getLocalizedField:i}=ze(),[D,t]=m.useState(!1),{data:h,isLoading:k}=Fe(r),{data:l,isLoading:q}=ae({queryKey:["allActivitiesForCoupon"],queryFn:async()=>{const{data:d,error:c}=await x.from("activities").select("id, title_zh, title_en, title_pt, start_date, end_date, visible").eq("visible",!0).order("start_date",{ascending:!1});if(c)throw c;return d},enabled:D}),_=ns(),v=rs(),p=new Set((h==null?void 0:h.map(d=>d.activity_id))||[]),H=async(d,c)=>{c?await v.mutateAsync({templateId:r,activityId:d}):await _.mutateAsync({templateId:r,activityId:d})},L=k||q,E=_.isPending||v.isPending;return e.jsxs(re,{open:D,onOpenChange:t,children:[e.jsx(Ze,{asChild:!0,children:y||e.jsxs(b,{variant:"outline",size:"sm",children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"管理关联活动"]})}),e.jsxs(le,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(de,{children:[e.jsx(ce,{children:"管理关联活动"}),e.jsx(oe,{children:"选择要关联到此优惠券模板的活动。一个优惠券可以关联多个活动。"})]}),e.jsx(Je,{className:"flex-1 pr-4",children:L?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(ue,{className:"w-6 h-6 animate-spin"})}):e.jsx("div",{className:"space-y-2",children:l&&l.length>0?l.map(d=>{const c=p.has(d.id);return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(ne,{checked:c,onCheckedChange:()=>H(d.id,c),disabled:E}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:i(d,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[M(new Date(d.start_date),"yyyy-MM-dd"),d.end_date&&` ~ ${M(new Date(d.end_date),"yyyy-MM-dd")}`]})]})]}),c&&e.jsxs(F,{variant:"secondary",className:"ml-2",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1"}),"已关联"]})]},d.id)}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"暂无可关联的活动"})})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["已关联 ",p.size," 个活动"]}),e.jsx(b,{variant:"outline",onClick:()=>t(!1),children:"关闭"})]})]})]})};function ps({open:r,onOpenChange:y,couponCode:i,onSuccess:D}){const{t}=O(),[h,k]=m.useState(!1),l=()=>{var w;return i.is_active?((w=i.user_coupons)==null?void 0:w.some(A=>A.used_at))?"used":"available":"expired"},{register:q,handleSubmit:_,watch:v,setValue:p,reset:H,formState:{errors:L}}=ds({defaultValues:{usage_limit:i.usage_limit,status:l()}});m.useEffect(()=>{H({usage_limit:i.usage_limit,status:l()})},[i,H]);const E=v("status"),d=async c=>{k(!0);try{const{error:w}=await x.from("coupon_codes").update({usage_limit:c.usage_limit,is_active:c.status!=="expired"}).eq("id",i.id);if(w)throw w;if(i.user_coupons&&i.user_coupons.length>0){if(c.status==="used"){const{error:A}=await x.from("user_coupons").update({used_at:new Date().toISOString()}).eq("coupon_code_id",i.id).is("used_at",null);if(A)throw A}else if(c.status==="available"){const{error:A}=await x.from("user_coupons").update({used_at:null}).eq("coupon_code_id",i.id);if(A)throw A}}T.success(t("admin.couponCode.updateSuccess")),D(),y(!1)}catch(w){console.error("Error updating coupon code:",w),T.error(t("admin.couponCode.updateError"))}finally{k(!1)}};return e.jsx(re,{open:r,onOpenChange:y,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsxs(de,{children:[e.jsx(ce,{children:t("admin.couponCode.editTitle")}),e.jsxs(oe,{children:[t("admin.couponCode.editDescription"),": ",e.jsx("code",{className:"font-mono font-semibold",children:i.code})]})]}),e.jsxs("form",{onSubmit:_(d),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"usage_limit",children:t("admin.couponCode.usageLimit")}),e.jsx(Te,{id:"usage_limit",type:"number",min:"1",...q("usage_limit",{required:t("admin.couponCode.usageLimitRequired"),min:{value:1,message:t("admin.couponCode.usageLimitMin")},valueAsNumber:!0})}),L.usage_limit&&e.jsx("p",{className:"text-sm text-destructive",children:L.usage_limit.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.couponCode.usageLimitHint")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(I,{value:E,onValueChange:c=>p("status",c),children:[e.jsx(V,{children:e.jsx($,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs(Q,{children:[e.jsx(g,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(g,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(g,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[E==="available"&&t("admin.couponCode.statusAvailableHint"),E==="used"&&t("admin.couponCode.statusUsedHint"),E==="expired"&&t("admin.couponCode.statusExpiredHint")]})]}),e.jsxs(qe,{children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>y(!1),disabled:h,children:t("common.cancel")}),e.jsxs(b,{type:"submit",disabled:h,children:[h&&e.jsx(ue,{className:"mr-2 h-4 w-4 animate-spin"}),t("common.save")]})]})]})]})})}function js({open:r,onOpenChange:y,selectedCodeIds:i,onSuccess:D}){const{t}=O(),[h,k]=m.useState(!1),[l,q]=m.useState("available"),_=async()=>{if(i.length!==0){k(!0);try{const{error:v}=await x.from("coupon_codes").update({is_active:l!=="expired"}).in("id",i);if(v)throw v;if(l==="used"){const{error:p}=await x.from("user_coupons").update({used_at:new Date().toISOString()}).in("coupon_code_id",i).is("used_at",null);if(p)throw p}else if(l==="available"){const{error:p}=await x.from("user_coupons").update({used_at:null}).in("coupon_code_id",i);if(p)throw p}T.success(t("admin.couponCode.batchUpdateSuccess",{count:i.length})),D(),y(!1)}catch(v){console.error("Error batch updating coupon codes:",v),T.error(t("admin.couponCode.batchUpdateError"))}finally{k(!1)}}};return e.jsx(re,{open:r,onOpenChange:y,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsxs(de,{children:[e.jsx(ce,{children:t("admin.couponCode.batchEditTitle")}),e.jsx(oe,{children:t("admin.couponCode.batchEditDescription",{count:i.length})})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(I,{value:l,onValueChange:v=>q(v),children:[e.jsx(V,{children:e.jsx($,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs(Q,{children:[e.jsx(g,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(g,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(g,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[l==="available"&&t("admin.couponCode.statusAvailableHint"),l==="used"&&t("admin.couponCode.statusUsedHint"),l==="expired"&&t("admin.couponCode.statusExpiredHint")]})]})}),e.jsxs(qe,{children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>y(!1),disabled:h,children:t("common.cancel")}),e.jsxs(b,{onClick:_,disabled:h,children:[h&&e.jsx(ue,{className:"mr-2 h-4 w-4 animate-spin"}),t("admin.couponCode.batchUpdate")]})]})]})})}const Ls=()=>{const{id:r}=Xe(),y=es(),{t:i}=O(),{getLocalizedField:D}=ze(),t=ss(),[h,k]=m.useState(""),[l,q]=m.useState("all"),[_,v]=m.useState("all"),[p,H]=m.useState("all"),[L,E]=m.useState(null),[d,c]=m.useState(null),[w,A]=m.useState(!1),[C,P]=m.useState(new Set),[He,me]=m.useState(!1),[Ue,R]=m.useState(!1),[W,xe]=m.useState(!1),{data:n,isLoading:Pe}=ae({queryKey:["couponTemplate",r],queryFn:async()=>{const{data:s,error:a}=await x.from("coupon_templates").select("*").eq("id",r).single();if(a)throw a;return s},enabled:!!r}),{data:G,isLoading:Be}=Fe(r),{data:U,isLoading:Ie}=ls(r),{data:j,isLoading:Ve}=ae({queryKey:["templateCouponCodes",r],queryFn:async()=>{const{data:s,error:a}=await x.from("coupon_codes").select(`
          *,
          user_coupons(
            id,
            user_id,
            claimed_at,
            used_at,
            source
          )
        `).eq("template_id",r).order("created_at",{ascending:!1});if(a)throw a;const u=(s||[]).map(o=>o.id),{data:B}=await x.from("coupon_usage_history").select("user_coupon_id, used_by_user_id, restaurant_id").in("coupon_code_id",u),Z=[...new Set((B||[]).map(o=>o.used_by_user_id))],{data:J}=await x.from("profiles").select("id, display_name, avatar_url").in("id",Z),S=(J||[]).reduce((o,f)=>(o[f.id]={display_name:f.display_name,avatar_url:f.avatar_url},o),{}),he=[...new Set((B||[]).filter(o=>o.restaurant_id).map(o=>o.restaurant_id))];let pe={};if(he.length>0){const{data:o}=await x.from("restaurants").select("id, name, name_en, name_pt").in("id",he);pe=(o||[]).reduce((f,N)=>(f[N.id]={name:N.name,name_en:N.name_en,name_pt:N.name_pt},f),{})}const je=(B||[]).reduce((o,f)=>(f.user_coupon_id&&(o[f.user_coupon_id]={used_by_merchant:S[f.used_by_user_id]||null,used_at_restaurant:f.restaurant_id&&pe[f.restaurant_id]||null}),o),{});return await Promise.all((s||[]).map(async o=>{const f=await Promise.all((o.user_coupons||[]).map(async N=>{if(!N.user_id)return{...N,profiles:{id:"",display_name:"Unknown",avatar_url:null},...je[N.id]};const{data:Ye}=await x.from("profiles").select("id, display_name, avatar_url").eq("id",N.user_id).maybeSingle();return{...N,profiles:Ye||{id:N.user_id,display_name:"Unknown",avatar_url:null},...je[N.id]}}));return{...o,user_coupons:f}}))},enabled:!!r}),z=m.useMemo(()=>j?j.filter(s=>{const a=h.toLowerCase(),u=h===""||s.code.toLowerCase().includes(a)||s.user_coupons.some(S=>S.profiles.display_name.toLowerCase().includes(a)),B=l==="all"||l==="active"&&s.is_active||l==="inactive"&&!s.is_active,Z=_==="all"||_==="unclaimed"&&s.user_coupons.length===0||_==="claimed"&&s.user_coupons.length>0&&s.user_coupons.every(S=>!S.used_at)||_==="used"&&s.user_coupons.some(S=>S.used_at),J=p==="all"||p==="share"&&s.user_coupons.some(S=>S.source==="share")||p==="other"&&s.user_coupons.some(S=>S.source!=="share");return u&&B&&Z&&J}):[],[j,h,l,_,p]),Y=(j==null?void 0:j.length)||0,$e=(j==null?void 0:j.reduce((s,a)=>s+a.used_count,0))||0,Qe=(j==null?void 0:j.reduce((s,a)=>s+a.user_coupons.length,0))||0,Ke=s=>{P(a=>{const u=new Set(a);return u.has(s)?u.delete(s):u.add(s),u})},Oe=()=>{C.size===z.length?P(new Set):P(new Set(z.map(s=>s.id)))},Re=()=>{P(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",r]})},We=async()=>{if(C.size!==0){xe(!0);try{const s=Array.from(C),{error:a}=await x.from("user_coupons").delete().in("coupon_code_id",s);if(a)throw a;const{error:u}=await x.from("coupon_codes").delete().in("id",s);if(u)throw u;T.success(i("admin.couponCode.batchDeleteSuccess",{count:s.length})),P(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",r]}),R(!1)}catch(s){console.error("Error batch deleting coupon codes:",s),T.error(i("admin.couponCode.batchDeleteError"))}finally{xe(!1)}}},Ge=async s=>{A(!0);try{const{error:a}=await x.from("user_coupons").delete().eq("coupon_code_id",s);if(a)throw a;const{error:u}=await x.from("coupon_codes").delete().eq("id",s);if(u)throw u;T.success("子优惠券已删除"),t.invalidateQueries({queryKey:["templateCouponCodes",r]}),c(null)}catch(a){console.error("Error deleting coupon code:",a),T.error("删除失败")}finally{A(!1)}};return Pe?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center py-12",children:"加载中..."})}):n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(b,{variant:"ghost",onClick:()=>y("/admin/coupons"),className:"mb-4",children:[e.jsx(cs,{className:"w-4 h-4 mr-2"}),"返回列表"]}),e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(Le,{className:"w-8 h-8"}),"优惠券模板详情"]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(X,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-lg",children:"模板信息"})}),e.jsxs(te,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"关联活动"}),Be?e.jsx("p",{className:"text-sm",children:"加载中..."}):G&&G.length>0?e.jsx("div",{className:"space-y-2",children:G.map(s=>e.jsx(ts,{to:`/activity/${s.activity_id}`,className:"block text-primary hover:underline",children:D(s.activities,"title")},s.activity_id))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"未关联任何活动"})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(hs,{templateId:r}),!n.visible&&e.jsx(F,{variant:"secondary",children:"已隐藏"}),!n.is_active&&e.jsx(F,{variant:"secondary",children:"未激活"}),n.is_active&&e.jsx(F,{children:"已激活"})]})]}),e.jsx(K,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"标题"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"中文："}),n.title_zh]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"English："}),n.title_en]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Português："}),n.title_pt]})]})]}),(n.description_zh||n.description_en||n.description_pt)&&e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"描述"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[n.description_zh&&e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"中文："}),n.description_zh]}),n.description_en&&e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"English："}),n.description_en]}),n.description_pt&&e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Português："}),n.description_pt]})]})]})]}),e.jsx(K,{}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"折扣类型"}),e.jsx("p",{className:"font-medium",children:n.discount_type==="percentage"?"百分比折扣":"固定金额"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"折扣值"}),e.jsx("p",{className:"font-medium text-primary text-lg",children:n.discount_type==="percentage"?`${n.discount_value}%`:`€${n.discount_value}`})]}),n.min_order_amount&&n.min_order_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"最低消费"}),e.jsxs("p",{className:"font-medium",children:["€",n.min_order_amount]})]}),n.max_discount_amount&&n.max_discount_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"最高折扣"}),e.jsxs("p",{className:"font-medium",children:["€",n.max_discount_amount]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"已生成"}),e.jsxs("p",{className:"font-medium",children:[Y," 张"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"已领取"}),e.jsxs("p",{className:"font-medium",children:[Qe," 次"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"已使用"}),e.jsxs("p",{className:"font-medium",children:[$e," 次"]})]})]}),e.jsx(K,{}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"有效期"}),e.jsxs("p",{className:"font-medium",children:[M(new Date(n.valid_from),"yyyy-MM-dd"),n.valid_until?` - ${M(new Date(n.valid_until),"yyyy-MM-dd")}`:" - 无限期"]})]})]})})]})]}),e.jsxs(X,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(ms,{className:"h-4 w-4"}),"已生成的子优惠券 (",Y,")"]}),j&&j.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(os,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Te,{placeholder:"搜索优惠券代码或用户名",value:h,onChange:s=>k(s.target.value),className:"pl-9"})]}),e.jsxs(I,{value:l,onValueChange:s=>q(s),children:[e.jsx(V,{children:e.jsx($,{placeholder:"状态"})}),e.jsxs(Q,{children:[e.jsx(g,{value:"all",children:"全部状态"}),e.jsx(g,{value:"active",children:"已激活"}),e.jsx(g,{value:"inactive",children:"已停用"})]})]}),e.jsxs(I,{value:_,onValueChange:s=>v(s),children:[e.jsx(V,{children:e.jsx($,{placeholder:"使用状态"})}),e.jsxs(Q,{children:[e.jsx(g,{value:"all",children:"全部"}),e.jsx(g,{value:"unclaimed",children:"未领取"}),e.jsx(g,{value:"claimed",children:"已领取未使用"}),e.jsx(g,{value:"used",children:"已使用"})]})]}),e.jsxs(I,{value:p,onValueChange:s=>H(s),children:[e.jsx(V,{children:e.jsx($,{placeholder:"来源"})}),e.jsxs(Q,{children:[e.jsx(g,{value:"all",children:"全部来源"}),e.jsx(g,{value:"share",children:"分享"}),e.jsx(g,{value:"other",children:"其他"})]})]})]})]})}),e.jsx(te,{children:Ve?e.jsx("p",{className:"text-sm text-muted-foreground",children:"加载中..."}):!j||j.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"暂无生成的优惠券，用户分享后将自动生成"}):z.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"没有符合筛选条件的优惠券"}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{id:"selectAll",checked:C.size===z.length&&z.length>0,onCheckedChange:Oe}),e.jsx("label",{htmlFor:"selectAll",className:"text-sm cursor-pointer",children:i("admin.couponCode.selectAll")})]}),C.size>0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:i("admin.couponCode.selectedCount",{count:C.size})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"outline",size:"sm",onClick:()=>me(!0),children:i("admin.couponCode.batchEditStatus")}),e.jsx(b,{variant:"destructive",size:"sm",onClick:()=>R(!0),children:i("admin.couponCode.batchDelete")})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[z.length," / ",Y]})]})]}),z.map(s=>e.jsxs("div",{className:`rounded-lg border bg-card p-4 ${C.has(s.id)?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{checked:C.has(s.id),onCheckedChange:()=>Ke(s.id)}),e.jsx("div",{className:"w-12 h-12 rounded bg-primary/10 flex items-center justify-center",children:e.jsx(Le,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("code",{className:"font-mono font-semibold text-base",children:s.code}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["生成时间：",M(new Date(s.created_at),"yyyy-MM-dd HH:mm")]}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["使用：",s.used_count," / ",s.usage_limit]}),e.jsx(F,{variant:s.is_active?"default":"secondary",children:s.is_active?"激活":"停用"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>E(s),title:"编辑",children:e.jsx(us,{className:"h-4 w-4"})}),e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>c(s.id),title:"删除",children:e.jsx(is,{className:"h-4 w-4 text-destructive"})})]})]}),s.user_coupons.length>0?e.jsxs("div",{className:"space-y-2 pt-3 border-t",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:"领取用户"}),s.user_coupons.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-md bg-secondary/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ge,{className:"h-10 w-10",children:[e.jsx(fe,{src:a.profiles.avatar_url||void 0}),e.jsx(_e,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.profiles.display_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["领取时间：",M(new Date(a.claimed_at),"yyyy-MM-dd HH:mm")]}),a.source&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["来源：",a.source==="share"?"分享":a.source]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(F,{variant:a.used_at?"default":"secondary",children:a.used_at?`已使用 ${M(new Date(a.used_at),"MM-dd HH:mm")}`:"未使用"}),a.used_at&&a.used_by_merchant&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ye,{className:"h-3 w-3"}),e.jsxs("span",{children:["核销：",a.used_by_merchant.display_name]}),a.used_at_restaurant&&e.jsxs("span",{className:"text-primary",children:["@ ",D(a.used_at_restaurant,"name")]})]})]})]},a.id))]}):e.jsx("p",{className:"text-sm text-muted-foreground pt-3 border-t",children:"暂无用户领取此优惠券"})]},s.id))]})})]}),e.jsxs(X,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4"}),"使用历史记录 (",(U==null?void 0:U.length)||0,")"]})}),e.jsx(te,{children:Ie?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"加载中..."}):!U||U.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"暂无使用记录"}):e.jsx("div",{className:"space-y-3",children:U.map(s=>{var a,u;return e.jsxs("div",{className:"flex items-start gap-4 p-4 border rounded-lg",children:[e.jsxs(ge,{className:"h-10 w-10",children:[(a=s.used_by_profile)!=null&&a.avatar_url?e.jsx(fe,{src:s.used_by_profile.avatar_url}):null,e.jsx(_e,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium",children:((u=s.used_by_profile)==null?void 0:u.display_name)||"未知用户"}),e.jsx("span",{className:"text-muted-foreground",children:"核销了优惠券"}),s.coupon_code&&e.jsx(F,{variant:"outline",className:"font-mono text-xs",children:s.coupon_code})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground flex-wrap",children:[e.jsx("span",{children:M(new Date(s.used_at),"yyyy-MM-dd HH:mm:ss")}),s.restaurant&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"h-3 w-3"}),D(s.restaurant,"name")]})]}),s.notes&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["备注: ",s.notes]})]})]},s.id)})})})]})]})]}),L&&e.jsx(ps,{open:!!L,onOpenChange:s=>!s&&E(null),couponCode:L,onSuccess:()=>{t.invalidateQueries({queryKey:["templateCouponCodes",r]})}}),e.jsx(js,{open:He,onOpenChange:me,selectedCodeIds:Array.from(C),onSuccess:Re}),e.jsx(Ne,{open:!!d,onOpenChange:s=>!s&&c(null),children:e.jsxs(be,{children:[e.jsxs(we,{children:[e.jsx(Ce,{children:"确认删除"}),e.jsx(Se,{children:"确定要删除这个子优惠券吗？此操作将同时删除所有关联的用户领取记录，且无法撤销。"})]}),e.jsxs(De,{children:[e.jsx(Ae,{disabled:w,children:"取消"}),e.jsx(ke,{onClick:()=>d&&Ge(d),disabled:w,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:w?"删除中...":"确认删除"})]})]})}),e.jsx(Ne,{open:Ue,onOpenChange:R,children:e.jsxs(be,{children:[e.jsxs(we,{children:[e.jsx(Ce,{children:i("admin.couponCode.batchDeleteTitle")}),e.jsx(Se,{children:i("admin.couponCode.batchDeleteDescription",{count:C.size})})]}),e.jsxs(De,{children:[e.jsx(Ae,{disabled:W,children:i("common.cancel")}),e.jsx(ke,{onClick:We,disabled:W,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:i(W?"common.deleting":"common.delete")})]})]})})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"优惠券模板不存在"}),e.jsx(b,{onClick:()=>y("/admin/coupons"),children:"返回列表"})]})})};export{Ls as default};
