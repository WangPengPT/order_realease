import{r as d,j as e}from"./vendor-react-core-BErlw7p5.js";import{u as Pe,a as B,b as H}from"./vendor-query-BS0wY7WL.js";import{n as Re,m as Fe,D as M,U as qe,B as o,a as V,b as A,c as K,R as r,I as f,a1 as Q,X as S,Y as k,$ as D,a0 as m,Z as G,T as Y,C as $,h as de,p as me,o as W,a2 as Ee,j as X,Q as he,s as h}from"./index-CEqKPgls.js";import{T as Z,a as J,b as j,c as y}from"./tabs-CCXSC-tz.js";import{T as Le,a as Oe,b as xe,c as I,d as Be,e as U}from"./table-BmTgE8rr.js";import{u as He}from"./vendor-i18n-CqcxoxDo.js";import{B as se,ac as Me,o as P,a as Ve,aa as Ae,z as Ke,ae as ue,W as Qe,T as Ge,p as ee,a2 as Ye,U as je,aY as $e,b8 as We,a8 as Xe,u as Ze,H as Je,ar as es,aO as ss,b9 as ts,ba as ns,bb as as}from"./vendor-icons-C2Bicc1E.js";import{C as pe}from"./vendor-date-fYlqblcl.js";import"./vendor-editor-BdQcs4B3.js";import"./vendor-misc-DH4LiFnZ.js";import"./vendor-router-CLK0c9aH.js";import"./vendor-ui-other-CPTlx-W2.js";import"./vendor-supabase-Clrw0GhO.js";import"./vendor-ui-dialog-Sv_VEL0d.js";import"./vendor-ui-dropdown-DwTcg2UT.js";const is=["Bell","Megaphone","Gift","Star","Heart","AlertCircle","Info","PartyPopper","Sparkles","Trophy"],ls={Bell:se,Megaphone:We,Gift:Xe,Star:Ze,Heart:Je,AlertCircle:es,Info:ss,PartyPopper:ts,Sparkles:ns,Trophy:as},R=({name:t,className:N})=>{const w=ls[t]||se;return e.jsx(w,{className:N})};function Ns(){const{t,i18n:N}=He(),{user:w}=Re(),{toast:v}=Fe(),F=Pe(),[ge,C]=d.useState(!1),[fe,T]=d.useState(!1),[ve,b]=d.useState(!1),[z,te]=d.useState(null),[x,ne]=d.useState(null),[l,_e]=d.useState(null),[q,ae]=d.useState("zh"),[ye,Ne]=d.useState("templates"),[i,c]=d.useState({title_zh:"",title_en:"",title_pt:"",content_zh:"",content_en:"",content_pt:"",icon:"Bell",image_url:"",link:"",status:"draft"}),[n,g]=d.useState({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),{data:we=[],isLoading:Ce}=B({queryKey:["notification-templates"],queryFn:async()=>{const{data:s,error:a}=await h.from("notification_templates").select("*").order("created_at",{ascending:!1});if(a)throw a;return s}}),{data:Te=[],isLoading:be}=B({queryKey:["notification-send-records"],queryFn:async()=>{const{data:s,error:a}=await h.from("notification_send_records").select("*").order("sent_at",{ascending:!1});if(a)throw a;return s}}),{data:ze=[]}=B({queryKey:["all-users-for-notification"],queryFn:async()=>{const{data:s,error:a}=await h.from("profiles").select("id, display_name").order("display_name");if(a)throw a;return s}}),E=H({mutationFn:async s=>{if(s.id){const{error:a}=await h.from("notification_templates").update({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon,image_url:s.image_url||null,link:s.link||null,status:s.status}).eq("id",s.id);if(a)throw a}else{const{error:a}=await h.from("notification_templates").insert({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon,image_url:s.image_url||null,link:s.link||null,status:s.status,created_by:w?.id});if(a)throw a}},onSuccess:()=>{F.invalidateQueries({queryKey:["notification-templates"]}),C(!1),le(),v({title:t("common.success"),description:t(z?"common.updated":"common.created")})},onError:s=>{v({title:t("common.error"),description:s.message,variant:"destructive"})}}),ie=H({mutationFn:async s=>{const{error:a}=await h.from("notification_templates").delete().eq("id",s);if(a)throw a},onSuccess:()=>{F.invalidateQueries({queryKey:["notification-templates"]}),v({title:t("common.success"),description:t("common.deleted")})}}),L=H({mutationFn:async()=>{if(!x)throw new Error("No template selected");let s=[];if(n.targetType==="all"){const{data:_}=await h.from("profiles").select("id");s=_?.map(O=>O.id)||[]}else if(n.targetType==="role"){const _=n.targetRole,{data:O}=await h.from("user_roles").select("user_id").eq("role",_);s=O?.map(Ue=>Ue.user_id)||[]}else s=n.targetUserIds;if(s.length===0)throw new Error("No users to send to");const a=s.map(_=>({user_id:_,type:"activity_update",title:p(x,"title"),content:p(x,"content"),link:x.link})),{error:u}=await h.from("notifications").insert(a);if(u)throw u;const Ie=n.targetType==="role"?n.targetRole:null,{error:oe}=await h.from("notification_send_records").insert({template_id:x.id,title:p(x,"title"),content:p(x,"content"),target_type:n.targetType,target_role:Ie,target_user_ids:n.targetType==="specific"?n.targetUserIds:null,sent_count:s.length,sent_by:w?.id});if(oe)throw oe;return s.length},onSuccess:s=>{F.invalidateQueries({queryKey:["notification-send-records"]}),T(!1),ne(null),g({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),v({title:t("common.success"),description:t("admin.notificationsSent",{count:s})||`已发送 ${s} 条通知`})},onError:s=>{v({title:t("common.error"),description:s.message,variant:"destructive"})}}),p=(s,a)=>{const u=N.language;return a==="title"?u==="zh"?s.title_zh:u==="pt"?s.title_pt:s.title_en:u==="zh"?s.content_zh:u==="pt"?s.content_pt:s.content_en},le=()=>{c({title_zh:"",title_en:"",title_pt:"",content_zh:"",content_en:"",content_pt:"",icon:"Bell",image_url:"",link:"",status:"draft"}),te(null)},Se=s=>{te(s),c({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon||"Bell",image_url:s.image_url||"",link:s.link||"",status:s.status}),C(!0)},re=s=>{ne(s),T(!0)},ke=s=>{_e(s),ae(N.language),b(!0)},ce=(s,a)=>({title:a==="zh"?s.title_zh:a==="pt"?s.title_pt:s.title_en,content:a==="zh"?s.content_zh:a==="pt"?s.content_pt:s.content_en}),De=ze.filter(s=>s.display_name?.toLowerCase().includes(n.userSearch.toLowerCase()));return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(se,{className:"h-6 w-6"}),t("admin.notifications","发送通知")]}),e.jsx("p",{className:"text-muted-foreground",children:t("admin.notificationsDesc","管理通知模板和发送站内通知")})]})}),e.jsxs(Z,{value:ye,onValueChange:Ne,children:[e.jsxs(J,{children:[e.jsx(j,{value:"templates",children:t("admin.templates","模板管理")}),e.jsx(j,{value:"records",children:t("admin.sendRecords","发送记录")})]}),e.jsxs(y,{value:"templates",className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(M,{open:ge,onOpenChange:s=>{C(s),s||le()},children:[e.jsx(qe,{asChild:!0,children:e.jsxs(o,{children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),t("admin.createTemplate","创建模板")]})}),e.jsxs(V,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(A,{children:e.jsx(K,{children:z?t("admin.editTemplate","编辑模板"):t("admin.createTemplate","创建模板")})}),e.jsxs(Z,{defaultValue:"zh",className:"w-full",children:[e.jsxs(J,{className:"grid w-full grid-cols-3",children:[e.jsx(j,{value:"zh",children:"中文"}),e.jsx(j,{value:"en",children:"English"}),e.jsx(j,{value:"pt",children:"Português"})]}),e.jsxs(y,{value:"zh",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(f,{value:i.title_zh,onChange:s=>c({...i,title_zh:s.target.value}),placeholder:"通知标题"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Q,{value:i.content_zh,onChange:s=>c({...i,content_zh:s.target.value}),placeholder:"通知内容",rows:4})]})]}),e.jsxs(y,{value:"en",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(f,{value:i.title_en,onChange:s=>c({...i,title_en:s.target.value}),placeholder:"Notification Title"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Q,{value:i.content_en,onChange:s=>c({...i,content_en:s.target.value}),placeholder:"Notification Content",rows:4})]})]}),e.jsxs(y,{value:"pt",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(f,{value:i.title_pt,onChange:s=>c({...i,title_pt:s.target.value}),placeholder:"Título da Notificação"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Q,{value:i.content_pt,onChange:s=>c({...i,content_pt:s.target.value}),placeholder:"Conteúdo da Notificação",rows:4})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("admin.icon","图标")}),e.jsxs(S,{value:i.icon,onValueChange:s=>c({...i,icon:s}),children:[e.jsx(k,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{name:i.icon,className:"h-4 w-4"}),e.jsx("span",{children:i.icon})]})}),e.jsx(D,{children:is.map(s=>e.jsx(m,{value:s,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{name:s,className:"h-4 w-4"}),e.jsx("span",{children:s})]})},s))})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.status")}),e.jsxs(S,{value:i.status,onValueChange:s=>c({...i,status:s}),children:[e.jsx(k,{children:e.jsx(G,{})}),e.jsxs(D,{children:[e.jsx(m,{value:"draft",children:t("common.draft","草稿")}),e.jsx(m,{value:"published",children:t("common.published","已发布")})]})]})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("admin.imageUrl","图片URL（可选）")}),e.jsx(f,{value:i.image_url,onChange:s=>c({...i,image_url:s.target.value}),placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("admin.link","链接（可选）")}),e.jsx(f,{value:i.link,onChange:s=>c({...i,link:s.target.value}),placeholder:"/activity/xxx"})]}),e.jsxs(Y,{children:[e.jsx(o,{variant:"outline",onClick:()=>C(!1),children:t("common.cancel")}),e.jsxs(o,{onClick:()=>E.mutate({...i,id:z?.id}),disabled:E.isPending||!i.title_zh||!i.content_zh,children:[E.isPending&&e.jsx(P,{className:"h-4 w-4 mr-2 animate-spin"}),t(z?"common.save":"common.create")]})]})]})]})}),Ce?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(P,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:we.map(s=>e.jsxs($,{children:[e.jsxs(de,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(me,{className:"text-lg",children:p(s,"title")}),e.jsx(W,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"h-3 w-3 mr-1"}),t("common.published","已发布")]}):e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"h-3 w-3 mr-1"}),t("common.draft","草稿")]})})]}),e.jsx(Ee,{className:"line-clamp-2",children:p(s,"content")})]}),e.jsxs(X,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-4",children:[e.jsx(R,{name:s.icon||"Bell",className:"h-4 w-4"}),e.jsx("span",{children:s.icon||"Bell"}),s.image_url&&e.jsx(Ke,{className:"h-4 w-4 ml-2"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>ke(s),children:[e.jsx(ue,{className:"h-4 w-4 mr-1"}),t("common.preview","预览")]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>Se(s),children:[e.jsx(Qe,{className:"h-4 w-4 mr-1"}),t("common.edit")]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>ie.mutate(s.id),disabled:ie.isPending,children:[e.jsx(Ge,{className:"h-4 w-4 mr-1"}),t("common.delete")]}),s.status==="published"&&e.jsxs(o,{size:"sm",onClick:()=>re(s),children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),t("common.send","发送")]})]})]})]},s.id))})]}),e.jsx(y,{value:"records",children:e.jsxs($,{children:[e.jsx(de,{children:e.jsx(me,{children:t("admin.sendRecords","发送记录")})}),e.jsx(X,{children:be?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(P,{className:"h-8 w-8 animate-spin"})}):e.jsxs(Le,{children:[e.jsx(Oe,{children:e.jsxs(xe,{children:[e.jsx(I,{children:t("common.title")}),e.jsx(I,{children:t("admin.targetType","发送对象")}),e.jsx(I,{children:t("admin.sentCount","发送数量")}),e.jsx(I,{children:t("admin.sentAt","发送时间")})]})}),e.jsx(Be,{children:Te.map(s=>e.jsxs(xe,{children:[e.jsx(U,{className:"font-medium",children:s.title}),e.jsx(U,{children:e.jsx(W,{variant:"outline",children:s.target_type==="all"?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"h-3 w-3 mr-1"}),t("admin.allUsers","全部用户")]}):s.target_type==="role"?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),s.target_role]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),t("admin.specificUsers","指定用户")]})})}),e.jsx(U,{children:s.sent_count}),e.jsx(U,{children:pe(new Date(s.sent_at),"yyyy-MM-dd HH:mm")})]},s.id))})]})})]})})]}),e.jsx(M,{open:fe,onOpenChange:T,children:e.jsxs(V,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(K,{children:t("admin.sendNotification","发送通知")}),e.jsx(he,{children:x&&p(x,"title")})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("admin.targetType","发送对象")}),e.jsxs(S,{value:n.targetType,onValueChange:s=>g({...n,targetType:s}),children:[e.jsx(k,{children:e.jsx(G,{})}),e.jsxs(D,{children:[e.jsx(m,{value:"all",children:t("admin.allUsers","全部用户")}),e.jsx(m,{value:"role",children:t("admin.byRole","按身份")}),e.jsx(m,{value:"specific",children:t("admin.specificUsers","指定用户")})]})]})]}),n.targetType==="role"&&e.jsxs("div",{children:[e.jsx(r,{children:t("admin.selectRole","选择身份")}),e.jsxs(S,{value:n.targetRole,onValueChange:s=>g({...n,targetRole:s}),children:[e.jsx(k,{children:e.jsx(G,{placeholder:t("admin.selectRole")})}),e.jsxs(D,{children:[e.jsx(m,{value:"user",children:t("common.user","用户")}),e.jsx(m,{value:"merchant",children:t("common.merchant","商家")}),e.jsx(m,{value:"supervisor",children:t("common.supervisor","主管")}),e.jsx(m,{value:"admin",children:t("common.admin","管理员")})]})]})]}),n.targetType==="specific"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:t("admin.selectUsers","选择用户")}),e.jsx(f,{placeholder:t("admin.searchUsers","搜索用户..."),value:n.userSearch,onChange:s=>g({...n,userSearch:s.target.value})}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-md p-2 space-y-1",children:De.slice(0,20).map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-muted rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:n.targetUserIds.includes(s.id),onChange:a=>{a.target.checked?g({...n,targetUserIds:[...n.targetUserIds,s.id]}):g({...n,targetUserIds:n.targetUserIds.filter(u=>u!==s.id)})}}),e.jsx("span",{className:"text-sm",children:s.display_name})]},s.id))}),n.targetUserIds.length>0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.selectedUsersCount",{count:n.targetUserIds.length})})]})]}),e.jsxs(Y,{children:[e.jsx(o,{variant:"outline",onClick:()=>T(!1),children:t("common.cancel")}),e.jsxs(o,{onClick:()=>L.mutate(),disabled:L.isPending||n.targetType==="role"&&!n.targetRole||n.targetType==="specific"&&n.targetUserIds.length===0,children:[L.isPending&&e.jsx(P,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx(ee,{className:"h-4 w-4 mr-2"}),t("common.send","发送")]})]})]})}),e.jsx(M,{open:ve,onOpenChange:b,children:e.jsxs(V,{className:"max-w-lg",children:[e.jsxs(A,{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-5 w-5"}),t("admin.previewNotification","预览通知")]}),e.jsx(he,{children:t("admin.previewNotificationDesc","查看不同语言版本的通知内容")})]}),l&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(Z,{value:q,onValueChange:s=>ae(s),children:e.jsxs(J,{className:"grid w-full grid-cols-3",children:[e.jsx(j,{value:"zh",children:"中文"}),e.jsx(j,{value:"en",children:"English"}),e.jsx(j,{value:"pt",children:"Português"})]})}),e.jsx($,{className:"border-2",children:e.jsx(X,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(R,{name:l.icon||"Bell",className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("h4",{className:"font-semibold text-base",children:ce(l,q).title}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:ce(l,q).content}),l.image_url&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:l.image_url,alt:"Notification",className:"rounded-md max-h-40 object-cover"})}),l.link&&e.jsxs("div",{className:"mt-2 flex items-center gap-1 text-sm text-primary",children:[e.jsx($e,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate",children:l.link})]})]})]})})}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:[t("common.status"),":"]}),e.jsx(W,{variant:l.status==="published"?"default":"secondary",className:"text-xs",children:l.status==="published"?t("common.published","已发布"):t("common.draft","草稿")})]}),e.jsxs("div",{children:[t("common.createdAt"),": ",pe(new Date(l.created_at),"yyyy-MM-dd HH:mm")]})]})]}),e.jsxs(Y,{children:[e.jsx(o,{variant:"outline",onClick:()=>b(!1),children:t("common.close","关闭")}),l?.status==="published"&&e.jsxs(o,{onClick:()=>{b(!1),re(l)},children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),t("common.send","发送")]})]})]})})]})}export{Ns as default};
//# sourceMappingURL=AdminNotifications-CQ2vb0Uz.js.map
