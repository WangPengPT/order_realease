import{s as v,q as u,v as m,p as _,r as x,j as e,c1 as N,c3 as y,cD as b,cE as g,bf as q,b$ as D,b1 as T,bB as E,aK as S}from"./vendor-react-DO-hMdHk.js";import{u as c,s as l,f as p,D as C,W as A,B as F,c as U,d as H,e as K,T as Q,S as B,g as M}from"./index-KBuYVGMg.js";import{T as $,a as L,b as h,c as P}from"./tabs-CHgu_pmy.js";import{u as O}from"./usePoints-C0owLGEQ.js";import{D as R}from"./vendor-utils-Z4kpnli5.js";const W=()=>{const{user:s}=c();return v({queryKey:["user-addresses",s?.id],queryFn:async()=>{if(!s)return[];const{data:n,error:o}=await l.from("user_addresses").select("*").eq("user_id",s.id).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(o)throw o;return n},enabled:!!s})},J=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async a=>{if(!s)throw new Error("User not authenticated");const{data:r,error:i}=await l.from("user_addresses").insert({user_id:s.id,label:a.label,street:a.street,district:a.district||null,city:a.city,postal_code:a.postal_code||null,country:a.country,phone:a.phone||null,phone_code:a.phone_code||"+351",is_default:a.is_default||!1}).select().single();if(i)throw i;return r},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Address added successfully"})},onError:()=>{n({title:"Error",description:"Failed to add address",variant:"destructive"})}})},X=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async({id:a,address:r})=>{if(!s)throw new Error("User not authenticated");const{data:i,error:d}=await l.from("user_addresses").update({label:r.label,street:r.street,district:r.district||null,city:r.city,postal_code:r.postal_code||null,country:r.country,phone:r.phone||null,phone_code:r.phone_code||"+351",is_default:r.is_default}).eq("id",a).eq("user_id",s.id).select().single();if(d)throw d;return i},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Address updated successfully"})},onError:()=>{n({title:"Error",description:"Failed to update address",variant:"destructive"})}})},Y=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async a=>{if(!s)throw new Error("User not authenticated");const{error:r}=await l.from("user_addresses").delete().eq("id",a).eq("user_id",s.id);if(r)throw r},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Address deleted successfully"})},onError:()=>{n({title:"Error",description:"Failed to delete address",variant:"destructive"})}})},Z=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async a=>{if(!s)throw new Error("User not authenticated");const{data:r,error:i}=await l.from("user_addresses").update({is_default:!0}).eq("id",a).eq("user_id",s.id).select().single();if(i)throw i;return r},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Default address updated"})},onError:()=>{n({title:"Error",description:"Failed to set default address",variant:"destructive"})}})},ee=()=>{const{t:s}=_(),[n,o]=x.useState(!1),{data:a=[],isLoading:r}=O(),[i,d]=x.useState("all"),j=t=>{switch(t){case"comment":return e.jsx(S,{className:"w-4 h-4"});case"admin_grant":return e.jsx(E,{className:"w-4 h-4"});case"admin_deduct":return e.jsx(g,{className:"w-4 h-4"});case"purchase":return e.jsx(T,{className:"w-4 h-4"});case"refund":return e.jsx(D,{className:"w-4 h-4"});case"expire":return e.jsx(q,{className:"w-4 h-4"});default:return e.jsx(y,{className:"w-4 h-4"})}},w=t=>s(`points.type.${t}`),f=a.filter(t=>i==="all"?!0:i==="earned"?t.amount>0:i==="spent"?t.amount<0:!0);return e.jsxs(C,{open:n,onOpenChange:o,children:[e.jsx(A,{asChild:!0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"h-6 px-2",children:[e.jsx(N,{className:"h-3 w-3 mr-1"}),s("profile.pointsHistory","明细")]})}),e.jsxs(U,{className:"sm:max-w-lg max-h-[80vh]",children:[e.jsxs(H,{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(y,{className:"w-5 h-5 text-accent"}),s("points.history")]}),e.jsx(Q,{children:s("points.historyDesc")})]}),e.jsxs($,{value:i,onValueChange:t=>d(t),children:[e.jsxs(L,{className:"grid w-full grid-cols-3",children:[e.jsx(h,{value:"all",children:s("points.filter.all")}),e.jsx(h,{value:"earned",children:s("points.filter.earned")}),e.jsx(h,{value:"spent",children:s("points.filter.spent")})]}),e.jsx(P,{value:i,className:"mt-4",children:e.jsx(B,{className:"h-[400px] pr-4",children:r?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):f.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("points.noTransactions")}):e.jsx("div",{className:"space-y-3",children:f.map(t=>e.jsxs("div",{className:"flex items-start justify-between p-3 rounded-lg border bg-card",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${t.amount>0?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"}`,children:j(t.type)}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2",children:[w(t.type),t.reason&&e.jsx(M,{variant:"outline",className:"text-xs font-normal",children:t.reason})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:R(new Date(t.created_at),"yyyy-MM-dd HH:mm")}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[s("points.balanceAfter"),": ",t.balance_after]})]})]}),e.jsxs("div",{className:`font-bold flex items-center gap-1 ${t.amount>0?"text-green-500":"text-red-500"}`,children:[t.amount>0?e.jsx(b,{className:"w-4 h-4"}):e.jsx(g,{className:"w-4 h-4"}),e.jsxs("span",{children:[t.amount>0?"+":"",t.amount]})]})]},t.id))})})})]})]})]})};export{ee as P,J as a,X as b,Y as c,Z as d,W as u};
//# sourceMappingURL=PointsHistoryDialog-Ctk8zcFv.js.map
