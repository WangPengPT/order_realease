{"version":3,"file":"VisitorPresenceTracker-CW2zIPM9.js","sources":["../../src/hooks/useVisitorPresence.ts","../../src/components/VisitorPresenceTracker.tsx"],"sourcesContent":["import { useEffect, useRef } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\n\r\nconst LOCATION_CACHE_KEY = \"location_cache\";\r\n\r\ninterface LocationData {\r\n  country: string | null;\r\n  city: string | null;\r\n  ip: string | null;\r\n}\r\n\r\n// Generate or retrieve a persistent visitor ID\r\nconst getVisitorId = (): string => {\r\n  const key = \"visitor_id\";\r\n  let visitorId = localStorage.getItem(key);\r\n  if (!visitorId) {\r\n    visitorId = crypto.randomUUID();\r\n    localStorage.setItem(key, visitorId);\r\n  }\r\n  return visitorId;\r\n};\r\n\r\n// Get cached location data from sessionStorage\r\nconst getCachedLocation = (): LocationData | null => {\r\n  try {\r\n    const cached = sessionStorage.getItem(LOCATION_CACHE_KEY);\r\n    if (cached) {\r\n      const data = JSON.parse(cached);\r\n      return {\r\n        country: data.country || null,\r\n        city: data.city || null,\r\n        ip: data.ip || null,\r\n      };\r\n    }\r\n  } catch {\r\n    // Ignore parse errors\r\n  }\r\n  return null;\r\n};\r\n\r\n// Cache location data to sessionStorage\r\nconst cacheLocation = (data: LocationData): void => {\r\n  try {\r\n    sessionStorage.setItem(LOCATION_CACHE_KEY, JSON.stringify(data));\r\n  } catch {\r\n    // Ignore storage errors\r\n  }\r\n};\r\n\r\n// Fetch location data via Edge Function\r\nconst fetchLocationData = async (): Promise<LocationData> => {\r\n  const cached = getCachedLocation();\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n\r\n  try {\r\n    const { data, error } = await supabase.functions.invoke('get-location');\r\n    \r\n    if (error) {\r\n      console.error(\"Failed to fetch location:\", error);\r\n      return { country: null, city: null, ip: null };\r\n    }\r\n\r\n    const locationData: LocationData = {\r\n      country: data?.country || null,\r\n      city: data?.city || null,\r\n      ip: data?.ip || null,\r\n    };\r\n\r\n    if (locationData.country || locationData.city) {\r\n      cacheLocation(locationData);\r\n    }\r\n\r\n    return locationData;\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch location data:\", error);\r\n    return { country: null, city: null, ip: null };\r\n  }\r\n};\r\n\r\nexport const useVisitorPresence = () => {\r\n  const { user } = useAuth();\r\n  const channelRef = useRef<ReturnType<typeof supabase.channel> | null>(null);\r\n  const locationDataRef = useRef<LocationData | null>(null);\r\n  const initDelayRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  useEffect(() => {\r\n    // Skip if user is logged in (they are tracked via useUserPresence)\r\n    if (user?.id) return;\r\n\r\n    const visitorId = getVisitorId();\r\n    \r\n\r\n    const initializePresence = async () => {\r\n      // Fetch location data once\r\n      const locationData = await fetchLocationData();\r\n      locationDataRef.current = locationData;\r\n      \r\n\r\n      // Create presence channel with visitor_id as the presence key\r\n      // Use a different channel for visitors to separate from logged-in users\r\n      const channel = supabase.channel('online-visitors', {\r\n        config: {\r\n          presence: {\r\n            key: visitorId,\r\n          },\r\n        },\r\n      });\r\n\r\n      channel\r\n        .on('presence', { event: 'sync' }, () => {\r\n          const state = channel.presenceState();\r\n          \r\n        })\r\n        .subscribe(async (status) => {\r\n          \r\n          if (status === 'SUBSCRIBED') {\r\n            const trackResult = await channel.track({\r\n              visitor_id: visitorId,\r\n              online_at: new Date().toISOString(),\r\n              country: locationDataRef.current?.country,\r\n              city: locationDataRef.current?.city,\r\n            });\r\n            \r\n          }\r\n        });\r\n\r\n      channelRef.current = channel;\r\n    };\r\n\r\n    // Delay presence initialization for performance\r\n    const initDelay = 2000;\r\n    initDelayRef.current = setTimeout(initializePresence, initDelay);\r\n\r\n    // Heartbeat to keep presence alive\r\n    const heartbeatInterval = 60000;\r\n    const heartbeat = setInterval(() => {\r\n      if (channelRef.current) {\r\n        channelRef.current.track({\r\n          visitor_id: visitorId,\r\n          online_at: new Date().toISOString(),\r\n          country: locationDataRef.current?.country,\r\n          city: locationDataRef.current?.city,\r\n        });\r\n      }\r\n    }, heartbeatInterval);\r\n\r\n    // Handle visibility change\r\n    const handleVisibilityChange = () => {\r\n      if (document.visibilityState === 'visible' && channelRef.current) {\r\n        channelRef.current.track({\r\n          visitor_id: visitorId,\r\n          online_at: new Date().toISOString(),\r\n          country: locationDataRef.current?.country,\r\n          city: locationDataRef.current?.city,\r\n        });\r\n      }\r\n    };\r\n\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n\r\n    return () => {\r\n      \r\n      \r\n      if (initDelayRef.current) {\r\n        clearTimeout(initDelayRef.current);\r\n      }\r\n      \r\n      clearInterval(heartbeat);\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n      \r\n      if (channelRef.current) {\r\n        channelRef.current.untrack();\r\n        supabase.removeChannel(channelRef.current);\r\n      }\r\n    };\r\n  }, [user?.id]);\r\n};\r\n","import { useVisitorPresence } from '@/hooks/useVisitorPresence';\r\n\r\nexport const VisitorPresenceTracker = () => {\r\n  useVisitorPresence();\r\n  return null;\r\n};\r\n\r\nexport default VisitorPresenceTracker;\r\n"],"names":["LOCATION_CACHE_KEY","getVisitorId","key","visitorId","getCachedLocation","cached","data","cacheLocation","fetchLocationData","error","supabase","locationData","useVisitorPresence","user","useAuth","channelRef","useRef","locationDataRef","initDelayRef","useEffect","initializePresence","channel","status","initDelay","heartbeat","handleVisibilityChange","VisitorPresenceTracker"],"mappings":"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"}