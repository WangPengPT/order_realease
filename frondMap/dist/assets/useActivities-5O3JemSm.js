import{p as o,k as l,s as a,i as b,ad as y,ae as _,a2 as d}from"./index-OzGmxN22.js";const h=()=>o({queryKey:["activities"],queryFn:async()=>{const{data:t,error:r}=await a.from("activities").select("*").eq("status","published").order("pinned",{ascending:!1}).order("sort_order",{ascending:!0}).order("start_date",{ascending:!1});if(r)throw r;return await Promise.all((t||[]).map(async i=>{const{count:n}=await a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{count:u}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{data:c}=await a.rpc("get_activity_creator_info",{creator_user_id:i.creator_id}),s=c;return{...i,subscriber_count:n||0,share_count:u||0,creator:{isAdmin:(s==null?void 0:s.isAdmin)??!0,restaurant:(s==null?void 0:s.restaurant)??null,avatar_url:(s==null?void 0:s.avatar_url)??null}}}))}}),v=()=>o({queryKey:["admin-activities"],queryFn:async()=>{const{data:t,error:r}=await a.from("activities").select("*").order("pinned",{ascending:!1}).order("sort_order",{ascending:!0}).order("start_date",{ascending:!1});if(r)throw r;return await Promise.all((t||[]).map(async i=>{const{count:n}=await a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{count:u}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{data:c}=await a.rpc("get_activity_creator_info",{creator_user_id:i.creator_id}),s=c;return{...i,subscriber_count:n||0,share_count:u||0,creator:{isAdmin:(s==null?void 0:s.isAdmin)??!0,restaurant:(s==null?void 0:s.restaurant)??null,avatar_url:(s==null?void 0:s.avatar_url)??null}}}))}}),q=t=>o({queryKey:["activity",t],queryFn:async()=>{const{data:r,error:e}=await a.from("activities").select("*").eq("id",t).single();if(e)throw e;return r},enabled:!!t}),w=t=>o({queryKey:["activityRestaurants",t],queryFn:async()=>{const{data:r,error:e}=await a.from("activity_restaurants").select("*").eq("activity_id",t);if(e)throw e;if(!r||r.length===0)return[];const i=r.map(c=>c.restaurant_id),{data:n,error:u}=await a.from("restaurants").select("id, name, name_en, name_pt, type, type_en, type_pt, address, image_url, rating, lat, lng").in("id",i);if(u)throw u;return r.map(c=>({...c,restaurants:(n==null?void 0:n.find(s=>s.id===c.restaurant_id))||{id:c.restaurant_id,name:"",name_en:null,name_pt:null,type:[],type_en:null,type_pt:null,address:"",image_url:null,rating:null,lat:null,lng:null}}))},enabled:!!t}),f=()=>{const{user:t}=l();return o({queryKey:["subscriptions",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const{data:r,error:e}=await a.from("subscriptions").select("*").eq("user_id",t.id).order("created_at",{ascending:!1});if(e)throw e;return(await Promise.all((r||[]).map(async n=>{const{data:u}=await a.from("activities").select("*").eq("id",n.activity_id).eq("status","published").maybeSingle();return{...n,activity:u}}))).filter(n=>n.activity!==null)},enabled:!!t})},p=()=>{const{user:t}=l(),{toast:r}=b(),e=y();return _({mutationFn:async i=>{if(!t)throw new Error("User not authenticated");const{data:n}=await a.from("subscriptions").select("id").eq("activity_id",i).eq("user_id",t.id).maybeSingle();if(n){const{error:u}=await a.from("subscriptions").delete().eq("id",n.id);if(u)throw u;return{action:"unsubscribed"}}else{const{error:u}=await a.from("subscriptions").insert({activity_id:i,user_id:t.id});if(u)throw u;return{action:"subscribed"}}},onSuccess:i=>{e.invalidateQueries({queryKey:["subscriptions"]}),r({title:i.action==="subscribed"?d.t("toast.subscribed"):d.t("toast.unsubscribed"),description:i.action==="subscribed"?d.t("toast.subscribedDesc"):d.t("toast.unsubscribedDesc")})},onError:()=>{r({title:d.t("common.error"),description:d.t("toast.subscriptionFailed"),variant:"destructive"})}})},g=t=>o({queryKey:["subscriberCount",t],queryFn:async()=>{const{count:r,error:e}=await a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",t);if(e)throw e;return r||0},enabled:!!t}),A=t=>o({queryKey:["shareCount",t],queryFn:async()=>{const{count:r,error:e}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",t);if(e)throw e;return r||0},enabled:!!t}),x=()=>{const t=y();return _({mutationFn:async({activityId:r,userId:e})=>{const{error:i}=await a.from("activity_shares").insert({activity_id:r,user_id:e});if(i)throw i},onSuccess:(r,e)=>{t.invalidateQueries({queryKey:["shareCount",e.activityId]}),t.invalidateQueries({queryKey:["hasShared",e.activityId]}),t.invalidateQueries({queryKey:["activities"]})}})},K=t=>o({queryKey:["activityCreator",t],queryFn:async()=>{if(!t)return null;const{data:r}=await a.rpc("get_activity_creator_info",{creator_user_id:t}),e=r;return{isAdmin:(e==null?void 0:e.isAdmin)??!0,restaurant:(e==null?void 0:e.restaurant)??null,avatar_url:(e==null?void 0:e.avatar_url)??null}},enabled:!!t});export{f as a,p as b,q as c,w as d,g as e,A as f,x as g,K as h,v as i,h as u};
