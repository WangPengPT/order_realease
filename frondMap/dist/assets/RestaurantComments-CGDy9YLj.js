import{l as ve,d as je,f as fe,ae as Ne,y as we,e as Ce,u as ye,r as i,s as J,j as e,a1 as Y,a2 as Z,a3 as ee,av as be,h as $,n as se,B as d,an as ae,X as te,I as le,ax as ke,C as w,b as R,ai as Se,aj as Re,ak as Ae,al as Ie,am as De,a as Ue,K as _e,N as Pe,O as Le,Q as ze,R as Ee,T as Me,U as Te,V as $e}from"./index-BFidtWYN.js";import{u as Ve,a as qe,b as Be,D as ie,R as Fe}from"./ReportDialog-CGJLRg0a.js";import{d as He}from"./useSensitiveWords-BfS158x_.js";import{T as Oe}from"./trash-2-CsnJWyJn.js";import{S as We}from"./shield-alert-CBSp37sr.js";import{I as ne}from"./image-B8hIdkwh.js";import{V as Xe}from"./volume-x-ByLzbqHf.js";import"./input-otp-BGdmZceB.js";import"./plus-Do2rl3FN.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=ve("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),re=[{value:"0-5",label:"0-5€"},{value:"5-10",label:"5-10€"},{value:"10-15",label:"10-15€"},{value:"15-20",label:"15-20€"},{value:"20-25",label:"20-25€"},{value:"25-30",label:"25-30€"},{value:"30-40",label:"30-40€"},{value:"40-50",label:"40-50€"},{value:"50+",label:"50€+"}],ls=({restaurantId:f,targetType:x="restaurant"})=>{var Q,G;const{t:a}=je(),{user:l}=fe(),{data:t}=Ne(),{isAdmin:ce}=we(),{toast:m}=Ce(),me=ye(),[p,V]=i.useState(""),[g,q]=i.useState(0),[oe,B]=i.useState(0),[C,F]=i.useState(""),[de,A]=i.useState(null),[v,I]=i.useState(""),[D,U]=i.useState(null),[H,_]=i.useState(null),[P,L]=i.useState(null),[O,z]=i.useState(null),[h,y]=i.useState(!1),[xe,W]=i.useState(!1),{data:u,isLoading:ue}=Ve(f,x),j=qe(),X=Be(),{checkContent:b}=He(),k=i.useCallback(async s=>{try{const c=s.name.split(".").pop(),o=`${`${l==null?void 0:l.id}-${Date.now()}.${c}`}`,{error:N,data:T}=await J.storage.from("comment-images").upload(o,s);if(N)throw N;const{data:{publicUrl:S}}=J.storage.from("comment-images").getPublicUrl(o);return S}catch(c){return console.error("Error uploading image:",c),m({title:a("common.error"),description:a("restaurant.imageUploadFailed"),variant:"destructive"}),null}},[l,m,a]),K=i.useCallback((s,c=!1)=>{var o;const n=(o=s.target.files)==null?void 0:o[0];if(n){if(n.size>5*1024*1024){m({title:a("common.error"),description:a("restaurant.imageTooLarge"),variant:"destructive"});return}c?(L(n),z(URL.createObjectURL(n))):(U(n),_(URL.createObjectURL(n)))}},[m,a]),E=i.useCallback((s=!1)=>{s?(L(null),z(null)):(U(null),_(null))},[]),he=i.useCallback(async()=>{if(!p.trim()||!l)return;if(t!=null&&t.is_muted){m({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(b(p).hasSensitive){m({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}if(x==="restaurant"&&!g){m({title:a("common.error"),description:a("toast.pleaseSelectRating"),variant:"destructive"});return}y(!0);let c;if(D){const n=await k(D);n&&(c=n)}await j.mutateAsync({targetId:f,targetType:x,content:p,ratingValue:x==="restaurant"?g:void 0,priceRange:x==="restaurant"&&C?C:void 0,imageUrl:c}),V(""),q(0),F(""),U(null),_(null),y(!1)},[p,l,t,x,g,m,a,D,k,j,f,C,b]),pe=i.useCallback(async s=>{if(!v.trim()||!l)return;if(t!=null&&t.is_muted){m({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(b(v).hasSensitive){m({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}y(!0);let n;if(P){const o=await k(P);o&&(n=o)}await j.mutateAsync({targetId:f,targetType:x,content:v,parentId:s,imageUrl:n}),I(""),A(null),L(null),z(null),y(!1)},[v,l,t,P,k,j,f,x,b,m,a]),ge=i.useCallback(async s=>{window.confirm(a("restaurant.confirmDelete"))&&await X.mutateAsync(s)},[X,a]),M=i.memo(({comment:s,isReply:c=!1})=>{var n,o,N,T,S;return e.jsxs("div",{className:`flex gap-2 sm:gap-3 ${c?"ml-8 sm:ml-12 mt-3":""}`,children:[e.jsxs(Y,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(Z,{src:(n=s.profiles)==null?void 0:n.avatar_url}),e.jsx(ee,{className:"text-xs sm:text-sm",children:((N=(o=s.profiles)==null?void 0:o.display_name)==null?void 0:N.charAt(0).toUpperCase())||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-xs sm:text-sm truncate",children:(T=s.profiles)==null?void 0:T.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0",children:be(new Date(s.created_at),{addSuffix:!0})}),s.edited&&e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:["(",a("restaurant.edited"),")"]})]}),!c&&s.rating_value&&e.jsxs("div",{className:"flex items-center gap-3 mt-1 mb-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(r=>e.jsx($,{className:se("w-4 h-4",r<=s.rating_value?"fill-accent text-accent":"text-muted-foreground")},r))}),s.price_range&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(ie,{className:"w-3 h-3"}),e.jsx("span",{children:(S=re.find(r=>r.value===s.price_range))==null?void 0:S.label})]})]}),e.jsx("p",{className:"text-xs sm:text-sm mt-1 text-foreground break-words",children:s.content}),s.image_url&&e.jsx("img",{src:s.image_url,alt:"Comment attachment",className:"mt-2 rounded-lg max-w-full sm:max-w-sm w-full"}),e.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-2",children:[!c&&l&&!(t!=null&&t.is_muted)&&e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>A(s.id),className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Ke,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("restaurant.reply")})]}),((l==null?void 0:l.id)===s.user_id||ce)&&e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>ge(s.id),className:"h-7 text-xs text-destructive hover:text-destructive px-2 sm:px-3",children:[e.jsx(Oe,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("common.delete")})]}),(l==null?void 0:l.id)!==s.user_id&&e.jsx(Fe,{targetType:"comment",targetId:s.id,onLoginRequired:()=>W(!0),trigger:e.jsxs(d,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(We,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("report.title")})]})})]}),de===s.id&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ae,{value:v,onChange:r=>I(r.target.value),placeholder:a("restaurant.writeReply"),className:"min-h-[80px] text-sm"}),O&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:O,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(d,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>E(!0),children:e.jsx(te,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex sm:flex-col gap-2",children:[e.jsx(d,{size:"sm",onClick:()=>pe(s.id),disabled:!v.trim()||h,className:"text-xs",children:a(h?"common.loading":"restaurant.reply")}),e.jsx(le,{type:"file",accept:"image/*",onChange:r=>K(r,!0),className:"hidden",id:`reply-image-${s.id}`,disabled:h}),e.jsxs(d,{size:"sm",variant:"outline",onClick:()=>{var r;return(r=document.getElementById(`reply-image-${s.id}`))==null?void 0:r.click()},disabled:h,className:"text-xs sm:px-3",children:[e.jsx(ne,{className:"h-4 w-4 sm:mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>{A(null),I(""),E(!0)},className:"text-xs",children:a("common.cancel")})]})]})}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3",children:s.replies.map(r=>e.jsx(M,{comment:r,isReply:!0},r.id))})]})]})});return M.displayName="CommentItem",ue?e.jsx("div",{className:"text-center py-8",children:a("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"w-4 sm:w-5 h-4 sm:h-5"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold",children:[a("restaurant.reviews")," (",(u==null?void 0:u.length)||0,")"]})]}),l?t!=null&&t.is_muted?e.jsx(w,{className:"border-yellow-300 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(R,{className:"py-4 sm:py-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex items-center gap-3 text-yellow-600 dark:text-yellow-400",children:[e.jsx(Xe,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:a("restaurant.youAreMutedNotice")})]})})}):e.jsx(w,{children:e.jsx(R,{className:"pt-4 sm:pt-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex gap-2 sm:gap-3",children:[e.jsxs(Y,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(Z,{src:(t==null?void 0:t.avatar_url)||void 0}),e.jsx(ee,{className:"text-xs sm:text-sm",children:((Q=t==null?void 0:t.display_name)==null?void 0:Q.charAt(0).toUpperCase())||((G=l==null?void 0:l.email)==null?void 0:G.charAt(0).toUpperCase())||"U"})]}),e.jsxs("div",{className:"flex-1 space-y-2 sm:space-y-3 min-w-0",children:[x==="restaurant"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4 text-accent"}),"评分 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onMouseEnter:()=>B(s),onMouseLeave:()=>B(0),onClick:()=>q(s),className:"transition-transform hover:scale-110",children:e.jsx($,{className:se("w-7 h-7 cursor-pointer transition-colors",s<=(oe||g)?"fill-accent text-accent":"text-muted-foreground hover:text-accent")})},s)),g>0&&e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",g,"/5)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4"}),a("restaurant.priceRange")]}),e.jsxs(Se,{value:C,onValueChange:F,children:[e.jsx(Re,{className:"w-full",children:e.jsx(Ae,{placeholder:a("restaurant.selectPriceRange")})}),e.jsx(Ie,{className:"bg-background",children:re.map(s=>e.jsx(De,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsx(ae,{value:p,onChange:s=>V(s.target.value),placeholder:a("restaurant.writeComment"),className:"min-h-[80px] sm:min-h-[100px] text-sm"}),H&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:H,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(d,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>E(!1),children:e.jsx(te,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(le,{type:"file",accept:"image/*",onChange:s=>K(s,!1),className:"hidden",id:"comment-image",disabled:h}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{var s;return(s=document.getElementById("comment-image"))==null?void 0:s.click()},disabled:h,className:"text-xs",children:[e.jsx(ne,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(d,{onClick:he,disabled:!p.trim()||j.isPending||h,size:"sm",className:"text-xs",children:h||j.isPending?a("common.loading"):a("restaurant.postComment")})]})]})]})})}):e.jsx(w,{children:e.jsx(R,{className:"py-4 sm:py-6 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.signInToComment")})}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:u==null?void 0:u.map(s=>e.jsx(w,{children:e.jsx(Ue,{className:"p-3 sm:p-6",children:e.jsx(M,{comment:s})})},s.id))}),(u==null?void 0:u.length)===0&&e.jsx(w,{children:e.jsx(R,{className:"py-8 sm:py-12 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.noComments")})})]}),e.jsx(_e,{open:xe,onOpenChange:W,children:e.jsxs(Pe,{children:[e.jsxs(Le,{children:[e.jsx(ze,{children:a("activities.loginRequired")}),e.jsx(Ee,{children:a("activities.loginRequiredMessage")})]}),e.jsxs(Me,{children:[e.jsx(Te,{children:a("common.cancel")}),e.jsx($e,{onClick:()=>me("/auth"),children:a("activities.goToLogin")})]})]})})]})};export{ls as default};
