{"version":3,"file":"useInvitationCodes-DQvzzTyi.js","sources":["../../src/hooks/useInvitationCodes.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { useEffect } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\n\r\nexport interface InvitationCode {\r\n  id: string;\r\n  user_id: string;\r\n  code: string;\r\n  status: 'pending' | 'approved' | 'rejected' | 'revoked';\r\n  full_name: string;\r\n  nif: string;\r\n  contact: string;\r\n  address: string;\r\n  rejection_reason: string | null;\r\n  reviewed_by: string | null;\r\n  reviewed_at: string | null;\r\n  usage_count: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  code_type?: 'user' | 'merchant';\r\n  usage_limit?: number;\r\n}\r\n\r\n// Hook for user to get their own invitation code with realtime updates\r\nexport const useMyInvitationCode = () => {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  // Subscribe to realtime changes for this user's invitation codes\r\n  useEffect(() => {\r\n    if (!user?.id) return;\r\n\r\n    const channel = supabase\r\n      .channel(`invitation-code-${user.id}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'invitation_codes',\r\n          filter: `user_id=eq.${user.id}`,\r\n        },\r\n        () => {\r\n          // Invalidate the query to trigger a refetch\r\n          queryClient.invalidateQueries({ queryKey: [\"my-invitation-code\", user.id] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [user?.id, queryClient]);\r\n\r\n  return useQuery({\r\n    queryKey: [\"my-invitation-code\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user?.id) return null;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (error) throw error;\r\n      return data as InvitationCode | null;\r\n    },\r\n    enabled: !!user?.id,\r\n  });\r\n};\r\n\r\n// Hook for user to get their invitation code history (all codes including rejected/revoked)\r\nexport const useMyInvitationCodeHistory = () => {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  // Subscribe to realtime changes for this user's invitation codes\r\n  useEffect(() => {\r\n    if (!user?.id) return;\r\n\r\n    const channel = supabase\r\n      .channel(`invitation-code-history-${user.id}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'invitation_codes',\r\n          filter: `user_id=eq.${user.id}`,\r\n        },\r\n        () => {\r\n          queryClient.invalidateQueries({ queryKey: [\"my-invitation-code-history\", user.id] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [user?.id, queryClient]);\r\n\r\n  return useQuery({\r\n    queryKey: [\"my-invitation-code-history\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user?.id) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data as InvitationCode[];\r\n    },\r\n    enabled: !!user?.id,\r\n  });\r\n};\r\n\r\n// Hook for user to apply for an invitation code\r\nexport const useApplyInvitationCode = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (data: { full_name: string; nif: string; contact: string; address: string }) => {\r\n      if (!user?.id) throw new Error(\"User not authenticated\");\r\n\r\n      // Check if NIF is already used by another user\r\n      const { data: existingNif } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"id, user_id\")\r\n        .eq(\"nif\", data.nif)\r\n        .neq(\"user_id\", user.id)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (existingNif) {\r\n        throw new Error(\"NIF_ALREADY_EXISTS\");\r\n      }\r\n\r\n      // First generate a unique code\r\n      const { data: codeResult, error: codeError } = await supabase\r\n        .rpc(\"generate_invitation_code\");\r\n\r\n      if (codeError) throw codeError;\r\n\r\n      // Insert the application\r\n      const { data: result, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .insert({\r\n          user_id: user.id,\r\n          code: codeResult,\r\n          full_name: data.full_name,\r\n          nif: data.nif,\r\n          contact: data.contact,\r\n          address: data.address,\r\n          status: \"pending\",\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Sync application info to profiles table\r\n      await supabase\r\n        .from(\"profiles\")\r\n        .update({\r\n          full_name: data.full_name,\r\n          nif: data.nif,\r\n          contact: data.contact,\r\n          address: data.address,\r\n        })\r\n        .eq(\"id\", user.id);\r\n\r\n      // Send email notification to admin\r\n      try {\r\n        await supabase.functions.invoke('send-invitation-code-email', {\r\n          body: {\r\n            user_id: user.id,\r\n            full_name: data.full_name,\r\n            nif: data.nif,\r\n            contact: data.contact,\r\n            address: data.address,\r\n            is_reapply: false,\r\n          },\r\n        });\r\n        console.log(\"Invitation code application email sent\");\r\n      } catch (emailError) {\r\n        console.error(\"Failed to send invitation code email:\", emailError);\r\n        // Don't throw - the application was successful, email is secondary\r\n      }\r\n\r\n      return result;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"my-invitation-code\"] });\r\n      toast({\r\n        title: t(\"invitationCode.applySuccess\", \"申请已提交\"),\r\n        description: t(\"invitationCode.applySuccessDesc\", \"您的邀请码申请已提交，请等待管理员审核\"),\r\n      });\r\n    },\r\n    onError: (error: Error) => {\r\n      if (error.message === \"NIF_ALREADY_EXISTS\") {\r\n        toast({\r\n          title: t(\"invitationCode.applyFailed\", \"申请失败\"),\r\n          description: t(\"invitationCode.nifExists\", \"该NIF已被其他用户使用，请检查后重试\"),\r\n          variant: \"destructive\",\r\n        });\r\n      } else {\r\n        toast({\r\n          title: t(\"invitationCode.applyFailed\", \"申请失败\"),\r\n          description: t(\"invitationCode.applyFailedDesc\", \"提交申请时发生错误，请稍后重试\"),\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    },\r\n  });\r\n};\r\n\r\n// Hook for user to reapply after rejection\r\nexport const useReapplyInvitationCode = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ id, data }: { id: string; data: { full_name: string; nif: string; contact: string; address: string } }) => {\r\n      if (!user?.id) throw new Error(\"User not authenticated\");\r\n\r\n      // Check if NIF is already used by another user (excluding current user's record)\r\n      const { data: existingNif } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"id, user_id\")\r\n        .eq(\"nif\", data.nif)\r\n        .neq(\"user_id\", user.id)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (existingNif) {\r\n        throw new Error(\"NIF_ALREADY_EXISTS\");\r\n      }\r\n\r\n      const { data: result, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .update({\r\n          full_name: data.full_name,\r\n          nif: data.nif,\r\n          contact: data.contact,\r\n          address: data.address,\r\n          status: \"pending\",\r\n          rejection_reason: null,\r\n          reviewed_by: null,\r\n          reviewed_at: null,\r\n        })\r\n        .eq(\"id\", id)\r\n        .eq(\"user_id\", user.id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Sync application info to profiles table\r\n      await supabase\r\n        .from(\"profiles\")\r\n        .update({\r\n          full_name: data.full_name,\r\n          nif: data.nif,\r\n          contact: data.contact,\r\n          address: data.address,\r\n        })\r\n        .eq(\"id\", user.id);\r\n\r\n      // Send email notification to admin\r\n      try {\r\n        await supabase.functions.invoke('send-invitation-code-email', {\r\n          body: {\r\n            user_id: user.id,\r\n            full_name: data.full_name,\r\n            nif: data.nif,\r\n            contact: data.contact,\r\n            address: data.address,\r\n            is_reapply: true,\r\n          },\r\n        });\r\n        console.log(\"Invitation code reapplication email sent\");\r\n      } catch (emailError) {\r\n        console.error(\"Failed to send invitation code email:\", emailError);\r\n        // Don't throw - the application was successful, email is secondary\r\n      }\r\n\r\n      return result;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"my-invitation-code\"] });\r\n      toast({\r\n        title: t(\"invitationCode.reapplySuccess\", \"重新申请已提交\"),\r\n        description: t(\"invitationCode.reapplySuccessDesc\", \"您的邀请码申请已重新提交，请等待管理员审核\"),\r\n      });\r\n    },\r\n    onError: (error: Error) => {\r\n      if (error.message === \"NIF_ALREADY_EXISTS\") {\r\n        toast({\r\n          title: t(\"invitationCode.applyFailed\", \"申请失败\"),\r\n          description: t(\"invitationCode.nifExists\", \"该NIF已被其他用户使用，请检查后重试\"),\r\n          variant: \"destructive\",\r\n        });\r\n      } else {\r\n        toast({\r\n          title: t(\"invitationCode.applyFailed\", \"申请失败\"),\r\n          description: t(\"invitationCode.applyFailedDesc\", \"提交申请时发生错误，请稍后重试\"),\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    },\r\n  });\r\n};\r\n\r\n// Admin hooks\r\n\r\n// Get all invitation codes for admin\r\nexport const useAdminInvitationCodes = () => {\r\n  return useQuery({\r\n    queryKey: [\"admin-invitation-codes\"],\r\n    queryFn: async () => {\r\n      // Step 1: 获取邀请码列表\r\n      const { data: codes, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"*\")\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      if (!codes?.length) return [];\r\n\r\n      // Step 2: 获取相关用户信息\r\n      const userIds = [...new Set(codes.map(c => c.user_id))];\r\n      const { data: profiles } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, display_name, avatar_url\")\r\n        .in(\"id\", userIds);\r\n\r\n      // Step 3: 合并数据\r\n      return codes.map(code => ({\r\n        ...code,\r\n        profiles: profiles?.find(p => p.id === code.user_id) || null\r\n      }));\r\n    },\r\n  });\r\n};\r\n\r\n// Get invitation code stats for admin\r\nexport const useInvitationCodeStats = () => {\r\n  return useQuery({\r\n    queryKey: [\"invitation-code-stats\"],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"status\");\r\n\r\n      if (error) throw error;\r\n\r\n      const stats = {\r\n        total: data.length,\r\n        pending: data.filter(c => c.status === \"pending\").length,\r\n        approved: data.filter(c => c.status === \"approved\").length,\r\n        rejected: data.filter(c => c.status === \"rejected\").length,\r\n        revoked: data.filter(c => c.status === \"revoked\").length,\r\n      };\r\n\r\n      return stats;\r\n    },\r\n  });\r\n};\r\n\r\n// Get detailed usage stats for a specific invitation code\r\nexport const useInvitationCodeUsageDetails = (code: string | null) => {\r\n  return useQuery({\r\n    queryKey: [\"invitation-code-usage-details\", code],\r\n    queryFn: async () => {\r\n      if (!code) return null;\r\n\r\n      // Get join requests that used this code\r\n      const { data: joinRequests, error: joinError } = await supabase\r\n        .from(\"join_requests\")\r\n        .select(\"id, name, email, restaurant_name, status, created_at\")\r\n        .eq(\"invitation_code\", code)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (joinError) throw joinError;\r\n\r\n      // Get registered users that used this code\r\n      const { data: invitedUsers, error: usersError } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, display_name, avatar_url, created_at, invited_at\")\r\n        .eq(\"invitation_code_used\", code)\r\n        .order(\"invited_at\", { ascending: false });\r\n\r\n      if (usersError) throw usersError;\r\n\r\n      // Calculate stats\r\n      const totalUsed = joinRequests?.length || 0;\r\n      const completedJoinRequests = joinRequests?.filter(r => r.status === \"completed\").length || 0;\r\n      const pendingJoinRequests = joinRequests?.filter(r => r.status === \"pending\" || r.status === \"received\").length || 0;\r\n      const registeredUsers = invitedUsers?.length || 0;\r\n\r\n      // Success rate = (completed join requests + registered users) / total used * 100\r\n      const successRate = totalUsed > 0 \r\n        ? Math.round(((completedJoinRequests + registeredUsers) / totalUsed) * 100) \r\n        : 0;\r\n\r\n      return {\r\n        joinRequests: joinRequests || [],\r\n        invitedUsers: invitedUsers || [],\r\n        stats: {\r\n          totalUsed,\r\n          completedJoinRequests,\r\n          pendingJoinRequests,\r\n          registeredUsers,\r\n          successRate,\r\n        },\r\n      };\r\n    },\r\n    enabled: !!code,\r\n  });\r\n};\r\n\r\n// Get overall invitation code performance stats\r\nexport const useInvitationCodePerformanceStats = () => {\r\n  return useQuery({\r\n    queryKey: [\"invitation-code-performance-stats\"],\r\n    queryFn: async () => {\r\n      // Get all approved invitation codes with usage count\r\n      const { data: codes, error: codesError } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"code, usage_count\")\r\n        .eq(\"status\", \"approved\");\r\n\r\n      if (codesError) throw codesError;\r\n\r\n      // Get all join requests with invitation codes\r\n      const { data: joinRequests, error: joinError } = await supabase\r\n        .from(\"join_requests\")\r\n        .select(\"invitation_code, status\")\r\n        .not(\"invitation_code\", \"is\", null);\r\n\r\n      if (joinError) throw joinError;\r\n\r\n      // Get all users with invitation codes\r\n      const { data: invitedUsers, error: usersError } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"invitation_code_used\")\r\n        .not(\"invitation_code_used\", \"is\", null);\r\n\r\n      if (usersError) throw usersError;\r\n\r\n      const totalCodes = codes?.length || 0;\r\n      const totalUsage = codes?.reduce((sum, c) => sum + (c.usage_count || 0), 0) || 0;\r\n      const activeCodesCount = codes?.filter(c => (c.usage_count || 0) > 0).length || 0;\r\n\r\n      const completedJoinRequests = joinRequests?.filter(r => r.status === \"completed\").length || 0;\r\n      const totalJoinRequestsWithCode = joinRequests?.length || 0;\r\n      const totalRegisteredUsers = invitedUsers?.length || 0;\r\n\r\n      const overallSuccessRate = totalJoinRequestsWithCode > 0\r\n        ? Math.round(((completedJoinRequests + totalRegisteredUsers) / totalJoinRequestsWithCode) * 100)\r\n        : 0;\r\n\r\n      return {\r\n        totalCodes,\r\n        totalUsage,\r\n        activeCodesCount,\r\n        completedJoinRequests,\r\n        totalJoinRequestsWithCode,\r\n        totalRegisteredUsers,\r\n        overallSuccessRate,\r\n      };\r\n    },\r\n  });\r\n};\r\n\r\n// Admin approve invitation code\r\nexport const useApproveInvitationCode = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (id: string) => {\r\n      if (!user?.id) throw new Error(\"User not authenticated\");\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .update({\r\n          status: \"approved\",\r\n          reviewed_by: user.id,\r\n          reviewed_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-invitation-codes\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"invitation-code-stats\"] });\r\n      toast({\r\n        title: t(\"invitationCode.approveSuccess\", \"审核通过\"),\r\n        description: t(\"invitationCode.approveSuccessDesc\", \"邀请码申请已通过\"),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t(\"invitationCode.operationFailed\", \"操作失败\"),\r\n        description: t(\"invitationCode.operationFailedDesc\", \"审核操作失败，请稍后重试\"),\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Admin reject invitation code\r\nexport const useRejectInvitationCode = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ id, reason }: { id: string; reason: string }) => {\r\n      if (!user?.id) throw new Error(\"User not authenticated\");\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .update({\r\n          status: \"rejected\",\r\n          rejection_reason: reason,\r\n          reviewed_by: user.id,\r\n          reviewed_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-invitation-codes\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"invitation-code-stats\"] });\r\n      toast({\r\n        title: t(\"invitationCode.rejectSuccess\", \"已拒绝\"),\r\n        description: t(\"invitationCode.rejectSuccessDesc\", \"邀请码申请已拒绝\"),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t(\"invitationCode.operationFailed\", \"操作失败\"),\r\n        description: t(\"invitationCode.operationFailedDesc\", \"审核操作失败，请稍后重试\"),\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Admin revoke invitation code\r\nexport const useRevokeInvitationCode = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ id, reason }: { id: string; reason: string }) => {\r\n      if (!user?.id) throw new Error(\"User not authenticated\");\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .update({\r\n          status: \"revoked\",\r\n          rejection_reason: reason,\r\n          reviewed_by: user.id,\r\n          reviewed_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-invitation-codes\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"invitation-code-stats\"] });\r\n      toast({\r\n        title: t(\"invitationCode.revokeSuccess\", \"已收回\"),\r\n        description: t(\"invitationCode.revokeSuccessDesc\", \"邀请码已成功收回\"),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t(\"invitationCode.operationFailed\", \"操作失败\"),\r\n        description: t(\"invitationCode.operationFailedDesc\", \"收回操作失败，请稍后重试\"),\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Validate invitation code (public)\r\nexport const useValidateInvitationCode = () => {\r\n  return useMutation({\r\n    mutationFn: async (code: string) => {\r\n      const { data, error } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"id, code, user_id, status, code_type, usage_limit, usage_count\")\r\n        .eq(\"code\", code.toUpperCase())\r\n        .eq(\"status\", \"approved\")\r\n        .maybeSingle();\r\n\r\n      if (error) throw error;\r\n      \r\n      // Check if code has reached usage limit (merchant one-time codes)\r\n      if (data && data.usage_limit > 0 && data.usage_count >= data.usage_limit) {\r\n        return null; // Code is exhausted\r\n      }\r\n      \r\n      return data;\r\n    },\r\n  });\r\n};\r\n\r\n// Increment invitation code usage and auto-revoke if limit reached\r\nexport const useIncrementInvitationCodeUsage = () => {\r\n  return useMutation({\r\n    mutationFn: async (code: string) => {\r\n      // First increment usage\r\n      const { error } = await supabase\r\n        .rpc(\"increment_invitation_code_usage\", { code_text: code.toUpperCase() });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Check if we need to revoke the code (for one-time merchant codes)\r\n      const { data: codeData } = await supabase\r\n        .from(\"invitation_codes\")\r\n        .select(\"id, usage_count, usage_limit, code_type\")\r\n        .eq(\"code\", code.toUpperCase())\r\n        .single();\r\n      \r\n      // Auto-revoke if usage limit is reached\r\n      if (codeData && codeData.usage_limit > 0 && codeData.usage_count >= codeData.usage_limit) {\r\n        await supabase\r\n          .from(\"invitation_codes\")\r\n          .update({ status: \"revoked\", rejection_reason: \"Usage limit reached\" })\r\n          .eq(\"id\", codeData.id);\r\n      }\r\n    },\r\n  });\r\n};\r\n"],"names":["useMyInvitationCode","user","useAuth","queryClient","useQueryClient","useEffect","channel","supabase","useQuery","data","error","useMyInvitationCodeHistory","useApplyInvitationCode","toast","useToast","useTranslation","useMutation","existingNif","codeResult","codeError","result","emailError","useReapplyInvitationCode","id","useAdminInvitationCodes","codes","userIds","c","profiles","code","p","useInvitationCodeStats","useInvitationCodeUsageDetails","joinRequests","joinError","invitedUsers","usersError","totalUsed","completedJoinRequests","r","pendingJoinRequests","registeredUsers","successRate","useInvitationCodePerformanceStats","codesError","totalCodes","totalUsage","sum","activeCodesCount","totalJoinRequestsWithCode","totalRegisteredUsers","overallSuccessRate","useApproveInvitationCode","useRejectInvitationCode","reason","useRevokeInvitationCode","useValidateInvitationCode"],"mappings":"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"}