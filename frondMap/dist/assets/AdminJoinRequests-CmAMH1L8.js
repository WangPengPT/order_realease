import{r as c,j as e}from"./vendor-react-core-BErlw7p5.js";import{s as i,C as R,h as k,p as T,a2 as M,j as O,I as w,B as m,v as me,w as ue,x as he,y as Y,o as F,X as je,Y as xe,Z as pe,$ as ge,a0 as fe,A as ve,E as we,F as ye,G as Ue,J as be,K as Ne,L as Se,M as Ce,D as De,a as _e,b as Ee,c as Ae,Q as Re,R as N,T as ke,V as r}from"./index-kEIDKiMZ.js";import{T as Te,a as Me,b as Z,c as u,d as Oe,e as h}from"./table-Cd72RMvS.js";import{u as Fe,a as q,b as W}from"./vendor-query-BS0wY7WL.js";import{S as qe}from"./switch-DLggLZLa.js";import{u as Pe}from"./vendor-i18n-CqcxoxDo.js";import{D as Le,t as $e,F as Ie,M as Ke,P as Qe,w as Be,d as He,p as Ve,T as ze}from"./vendor-icons-C2Bicc1E.js";import{F as Je}from"./vendor-date-fYlqblcl.js";import"./vendor-editor-BdQcs4B3.js";import"./vendor-misc-DH4LiFnZ.js";import"./vendor-router-CLK0c9aH.js";import"./vendor-ui-other-CPTlx-W2.js";import"./vendor-supabase-Clrw0GhO.js";import"./vendor-ui-dialog-Sv_VEL0d.js";import"./vendor-ui-dropdown-DwTcg2UT.js";const ee=["pending","received","completed","cancelled"],ds=()=>{const{t:s}=Pe(),[P,se]=c.useState(""),[y,L]=c.useState("all"),[S,C]=c.useState(null),[te,f]=c.useState(!1),[o,ae]=c.useState(null),[v,$]=c.useState(""),[j,I]=c.useState(""),[D,_]=c.useState(!1),[E,d]=c.useState(!1),[U,K]=c.useState(!1),x=Fe(),{data:Q,isLoading:re}=q({queryKey:["joinRequests"],queryFn:async()=>{const{data:t,error:a}=await i.from("join_requests").select("*").order("created_at",{ascending:!1});if(a)throw a;return t}}),{data:A}=q({queryKey:["emailConfig","join_request"],queryFn:async()=>{const{data:t,error:a}=await i.from("email_config").select("*").eq("type","join_request").single();if(a)throw a;return t}}),{data:B}=q({queryKey:["siteSettings"],queryFn:async()=>{const{data:t,error:a}=await i.from("site_settings").select("logo_url").single();if(a)throw a;return t}});c.useEffect(()=>{const t=i.channel("join_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"join_requests"},()=>{x.invalidateQueries({queryKey:["joinRequests"]})}).subscribe();return()=>{i.removeChannel(t)}},[x]);const p=Q?.filter(t=>{const a=P.toLowerCase(),n=t.name.toLowerCase().includes(a)||t.email.toLowerCase().includes(a)||t.restaurant_name.toLowerCase().includes(a)||t.phone.toLowerCase().includes(a),g=y==="all"||t.status===y;return n&&g}),ne=async()=>{const t=prompt(s("joinUs.enterNewEmail"),A?.recipient_email);if(t)try{const{error:a}=await i.from("email_config").update({recipient_email:t}).eq("id",A?.id);if(a)throw a;r({title:s("common.success"),description:s("joinUs.emailUpdated")})}catch(a){console.error("Error updating email:",a),r({title:s("common.error"),description:s("joinUs.emailUpdateError"),variant:"destructive"})}},H=W({mutationFn:async({id:t,status:a})=>{const{error:n}=await i.from("join_requests").update({status:a}).eq("id",t);if(n)throw n},onSuccess:()=>{x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.statusUpdated")})},onError:t=>{console.error("Error updating status:",t),r({title:s("common.error"),description:s("joinUs.statusUpdateError"),variant:"destructive"})}}),V=W({mutationFn:async t=>{const{error:a}=await i.from("join_requests").delete().eq("id",t);if(a)throw a},onSuccess:()=>{x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.requestDeleted")}),C(null)},onError:t=>{console.error("Error deleting request:",t),r({title:s("common.error"),description:s("joinUs.deleteError"),variant:"destructive"})}}),ie=()=>{if(!p||p.length===0){r({title:s("admin.noDataToExport"),variant:"destructive"});return}const t=[["Name","Email","Phone","Restaurant Name","Restaurant Address","Features","Status","Submitted Date"],...p.map(l=>[l.name,l.email,l.phone,l.restaurant_name,l.restaurant_address||"",Array.isArray(l.features_selected)?l.features_selected.join(", "):"",l.status||"pending",new Date(l.created_at).toLocaleString()])].map(l=>l.map(b=>`"${b}"`).join(",")).join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),g=URL.createObjectURL(a);n.setAttribute("href",g),n.setAttribute("download",`join_requests_${new Date().toISOString()}.csv`),n.click(),URL.revokeObjectURL(g),r({title:s("admin.exportSuccess")})},z=t=>{switch(t){case"completed":return"default";case"received":return"secondary";case"cancelled":return"destructive";default:return"outline"}},oe=t=>{ae(t),$(t.email),I(""),K(!1),f(!0)},le=async()=>{if(!o||!v.trim()||!j.trim()){r({title:s("common.error"),description:s("joinUs.accountPasswordRequired"),variant:"destructive"});return}if(j.length<6){r({title:s("common.error"),description:s("auth.passwordTooShort"),variant:"destructive"});return}try{if(U){_(!0);const ce=`【小熊市场】您的商家账号信息 - ${o.restaurant_name}`,de="您的商家账号信息如下！",{data:G,error:X}=await i.functions.invoke("send-merchant-email",{body:{to:o.email,subject:ce,content:de,merchantName:o.name,account:v,password:j,logoUrl:B?.logo_url||null}});if(X)throw X;if(!G.success)throw new Error(G.error);await i.from("join_requests").update({email_sent_at:new Date().toISOString()}).eq("id",o.id),x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),f(!1);return}d(!0);const{data:t}=await i.auth.getSession();if(!t?.session){r({title:s("common.error"),description:s("auth.sessionExpired"),variant:"destructive"}),d(!1);return}const{data:a,error:n}=await i.functions.invoke("admin-create-user",{body:{email:v,password:j,displayName:o.name,phone:o.phone,role:"merchant"}});if(n){console.error("Create user function error:",n),r({title:s("common.error"),description:n.message||s("admin.createUserError"),variant:"destructive"}),d(!1);return}if(a?.error){console.error("Create user business error:",a.error),r({title:s("common.error"),description:a.error,variant:"destructive"}),d(!1);return}if(!a?.success||!a?.user){console.error("User creation failed - no user returned"),r({title:s("common.error"),description:s("admin.createUserError"),variant:"destructive"}),d(!1);return}r({title:s("common.success"),description:s("joinUs.merchantUserCreated")}),d(!1),_(!0);const g=`【小熊市场】您的商家账号已创建 - ${o.restaurant_name}`,l="您的商家账号已创建成功！",{data:b,error:J}=await i.functions.invoke("send-merchant-email",{body:{to:o.email,subject:g,content:l,merchantName:o.name,account:v,password:j,logoUrl:B?.logo_url||null}});if(J)throw J;if(!b.success)throw new Error(b.error);await i.from("join_requests").update({status:"received",email_sent_at:new Date().toISOString()}).eq("id",o.id),x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),f(!1)}catch(t){console.error("Error:",t),r({title:s("common.error"),description:t.message||s("joinUs.emailSendError"),variant:"destructive"})}finally{d(!1),_(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("joinUs.adminTitle")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:s("joinUs.adminDescription")})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsx(T,{children:s("joinUs.recipientEmail")}),e.jsx(M,{children:s("joinUs.recipientEmailDesc")})]}),e.jsx(O,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{value:A?.recipient_email||"",readOnly:!0}),e.jsx(m,{onClick:ne,children:s("common.edit")})]})})]}),e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsx(T,{children:s("joinUs.totalRequests")}),e.jsx(M,{children:s("joinUs.totalRequestsDesc")})]}),e.jsx(O,{children:e.jsx("div",{className:"text-3xl font-bold",children:Q?.length||0})})]})]}),e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(T,{children:s("joinUs.allRequests")}),e.jsx(M,{children:s("joinUs.allRequestsDesc")})]}),e.jsxs(m,{onClick:ie,variant:"outline",children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),s("admin.exportCSV")]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx($e,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(w,{placeholder:s("joinUs.searchPlaceholder"),value:P,onChange:t=>se(t.target.value),className:"pl-10"})]}),e.jsxs(me,{children:[e.jsx(ue,{asChild:!0,children:e.jsxs(m,{variant:"outline",className:"gap-2",children:[e.jsx(Ie,{className:"w-4 h-4"}),s(y==="all"?"admin.allStatus":`joinUs.status.${y}`)]})}),e.jsxs(he,{align:"end",className:"bg-background",children:[e.jsx(Y,{onClick:()=>L("all"),children:s("admin.allStatus")}),ee.map(t=>e.jsx(Y,{onClick:()=>L(t),children:s(`joinUs.status.${t}`)},t))]})]})]})]}),e.jsx(O,{children:re?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):p&&p.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Te,{children:[e.jsx(Me,{children:e.jsxs(Z,{children:[e.jsx(u,{children:s("joinUs.name")}),e.jsx(u,{children:s("joinUs.contact")}),e.jsx(u,{children:s("joinUs.restaurant")}),e.jsx(u,{children:s("joinUs.featuresNeeded")}),e.jsx(u,{children:s("joinUs.status")}),e.jsx(u,{children:s("joinUs.submittedAt")}),e.jsx(u,{className:"text-right",children:s("common.actions")})]})}),e.jsx(Oe,{children:p.map(t=>e.jsxs(Z,{children:[e.jsx(h,{className:"font-medium",children:t.name}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ke,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`mailto:${t.email}`,className:"hover:underline",children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Qe,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`tel:${t.phone}`,className:"hover:underline",children:t.phone})]})]})}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Be,{className:"w-3 h-3 text-muted-foreground"}),t.restaurant_name]}),t.restaurant_address&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(He,{className:"w-3 h-3"}),t.restaurant_address]})]})}),e.jsx(h,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:Array.isArray(t.features_selected)&&t.features_selected.map((a,n)=>e.jsx(F,{variant:"secondary",children:s(`joinUs.feature.${a}`)},n))})}),e.jsx(h,{children:e.jsxs(je,{value:t.status||"pending",onValueChange:a=>H.mutate({id:t.id,status:a}),disabled:H.isPending,children:[e.jsx(xe,{className:"w-[130px]",children:e.jsx(pe,{children:e.jsx(F,{variant:z(t.status||"pending"),children:s(`joinUs.status.${t.status||"pending"}`)})})}),e.jsx(ge,{children:ee.map(a=>e.jsx(fe,{value:a,children:e.jsx(F,{variant:z(a),children:s(`joinUs.status.${a}`)})},a))})]})}),e.jsx(h,{className:"text-sm text-muted-foreground",children:Je(new Date(t.created_at),{addSuffix:!0})}),e.jsx(h,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>oe(t),title:s("joinUs.sendEmail"),children:e.jsx(Ve,{className:"w-4 h-4"})}),e.jsx(m,{size:"sm",variant:"destructive",onClick:()=>C(t.id),disabled:V.isPending,children:e.jsx(ze,{className:"w-4 h-4"})})]})})]},t.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("joinUs.noRequests")})})]})]}),e.jsx(ve,{open:S!==null,onOpenChange:t=>!t&&C(null),children:e.jsxs(we,{children:[e.jsxs(ye,{children:[e.jsx(Ue,{children:s("joinUs.confirmDelete")}),e.jsx(be,{children:s("joinUs.confirmDeleteDescription")})]}),e.jsxs(Ne,{children:[e.jsx(Se,{children:s("common.cancel")}),e.jsx(Ce,{onClick:()=>S&&V.mutate(S),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s("common.delete")})]})]})}),e.jsx(De,{open:te,onOpenChange:f,children:e.jsxs(_e,{className:"sm:max-w-[500px]",children:[e.jsxs(Ee,{children:[e.jsx(Ae,{children:s("joinUs.sendAccountTitle")}),e.jsx(Re,{children:s("joinUs.sendAccountDescription",{name:o?.name})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(N,{htmlFor:"emailOnlyMode",className:"font-medium",children:s("joinUs.emailOnlyMode")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.emailOnlyModeDesc")})]}),e.jsx(qe,{id:"emailOnlyMode",checked:U,onCheckedChange:K})]}),!U&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:["ℹ️ ",s("joinUs.createUserModeNote")]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:s("joinUs.emailRecipient")}),e.jsx(w,{value:o?.email||"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"account",children:s("joinUs.merchantAccount")}),e.jsx(w,{id:"account",value:v,onChange:t=>$(t.target.value),placeholder:s("joinUs.merchantAccountPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"password",children:s("joinUs.merchantPassword")}),e.jsx(w,{id:"password",type:"text",value:j,onChange:t=>I(t.target.value),placeholder:s("joinUs.merchantPasswordPlaceholder")})]}),e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:["⚠️ ",s("joinUs.passwordSecurityNote")]})})]}),e.jsxs(ke,{children:[e.jsx(m,{variant:"outline",onClick:()=>f(!1),disabled:E||D,children:s("common.cancel")}),e.jsx(m,{onClick:le,disabled:E||D,children:s(E?"joinUs.creatingUser":D?"common.sending":U?"joinUs.sendEmailOnly":"joinUs.createAndSendEmail")})]})]})})]})};export{ds as default};
//# sourceMappingURL=AdminJoinRequests-CmAMH1L8.js.map
