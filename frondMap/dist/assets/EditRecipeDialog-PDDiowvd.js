import{p as $,r as m,j as e,b4 as te,X as G,dJ as je,a4 as K,a_ as Ne,dK as M,b5 as ve,dL as Fe,dM as ye,bR as ae,aM as W,bh as ne,cR as De,w as k,bN as Ae,bf as qe,dN as $e,bD as ze,dO as Be,ay as Oe,aw as Ve,ak as be,ce as He,bW as we,d1 as Ke,q as Ge,v as Qe,b7 as We}from"./vendor-react-DwI6ZJq7.js";import{a as ie,g as Y,I as L,B as T,i as P,S as ke,G as Xe,af as Ce,ag as Se,ah as _e,a8 as le,s as R,U as D,a2 as Je,a3 as Ye,a4 as Ze,a5 as es,a6 as ss}from"./index-C7QjDrm6.js";import{u as ce}from"./useLocalizedContent-MCfjRTM4.js";import{D as oe,b as de,c as me,d as ue,f as Ie}from"./drawer-ByIZbZw9.js";import{P as pe,a as he,b as xe}from"./popover-4Bdikmag.js";import{c as ts}from"./useCommunityPosts-CLuoFC0C.js";import{u as as}from"./useActivities-Dq8fuV2w.js";import{u as rs}from"./useRestaurants-DnfmWCbl.js";import{P as ns}from"./progress-BvJjdbpj.js";import{C as is,a as ls,b as cs}from"./collapsible-IuqJYKyZ.js";const os=({open:t,onOpenChange:c,value:s,onSelect:n,restaurants:o,required:d=!1,maxDisplay:u=2})=>{const{t:x}=$(),{getLocalizedField:r}=ce(),v=ie(),[p,y]=m.useState(""),[i,h]=m.useState(s),[f,a]=m.useState("85vh");m.useEffect(()=>{if(!t||!v)return;const l=window.visualViewport;if(!l){a("85vh");return}const g=()=>{const N=l.height,b=Math.min(N*.85,N-50);a(`${b}px`)};return g(),l.addEventListener("resize",g),()=>{l.removeEventListener("resize",g)}},[t,v]);const j=l=>{l&&(h(s),y("")),c(l)},C=o?.filter(l=>{if(!p)return!0;const g=r(l,"name")?.toLowerCase()||"",N=l.address?.toLowerCase()||"",b=p.toLowerCase();return g.includes(b)||N.includes(b)})||[],F=l=>{h(g=>g.includes(l)?g.filter(N=>N!==l):[...g,l])},S=()=>{n(i),c(!1),y("")},I=l=>{const g=s.includes(l)?s.filter(N=>N!==l):[...s,l];n(g)},E=s.map(l=>{const g=o?.find(N=>N.id===l);return g?r(g,"name"):null}).filter(Boolean),Q=()=>{if(E.length===0)return e.jsxs("span",{className:"text-muted-foreground",children:[x("community.linkRestaurants","å…³è”é¤åŽ…"),d&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]});const l=E.slice(0,u),g=E.length-u;return e.jsxs("span",{className:"text-primary flex items-center gap-1 flex-wrap",children:[l.map((N,b)=>e.jsxs("span",{children:[N,b<l.length-1?"ã€":""]},b)),g>0&&e.jsxs(Y,{variant:"secondary",className:"text-xs px-1.5 py-0",children:["+",g]})]})},O=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors text-left",onClick:()=>j(!0),children:[e.jsx(Q,{}),e.jsx(je,{className:"h-4 w-4 opacity-50 shrink-0"})]}),V=({restaurant:l,isSelected:g,onToggle:N})=>e.jsxs("div",{className:P("flex items-start gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",g?"bg-primary/10":"hover:bg-muted"),onClick:N,children:[e.jsx("div",{className:P("h-5 w-5 shrink-0 mt-0.5 rounded border flex items-center justify-center transition-colors",g?"bg-primary border-primary":"border-muted-foreground/30"),children:g&&e.jsx(K,{className:"h-3 w-3 text-primary-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r(l,"name")}),l.address&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate flex items-center gap-1 mt-0.5",children:[e.jsx(Ne,{className:"h-3 w-3 shrink-0"}),l.address]})]})]});return v?e.jsxs(e.Fragment,{children:[O,e.jsx(oe,{open:t,onOpenChange:j,children:e.jsxs(de,{className:"flex flex-col",style:{height:f,maxHeight:f,transition:"height 0.15s ease-out, max-height 0.15s ease-out"},children:[e.jsx(me,{className:"pb-2 shrink-0",children:e.jsxs(ue,{children:[x("community.selectRestaurants","é€‰æ‹©é¤åŽ…"),i.length>0&&e.jsx(Y,{variant:"secondary",className:"ml-2",children:i.length})]})}),e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(L,{placeholder:x("community.searchRestaurant","æœç´¢é¤åŽ…..."),value:p,onChange:l=>y(l.target.value),className:"pl-9"})]})}),i.length>0&&e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:i.map(l=>{const g=o?.find(N=>N.id===l);return g?e.jsxs(Y,{variant:"secondary",className:"gap-1 pr-1",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:r(g,"name")}),e.jsx("button",{type:"button",className:"hover:bg-muted-foreground/20 rounded-full p-0.5",onClick:N=>{N.stopPropagation(),h(b=>b.filter(U=>U!==l))},children:e.jsx(G,{className:"h-3 w-3"})})]},l):null})})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 min-h-0",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[C.map(l=>e.jsx(V,{restaurant:l,isSelected:i.includes(l.id),onToggle:()=>F(l.id)},l.id)),C.length===0&&p&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:x("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤åŽ…")})]})}),e.jsx(Ie,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(T,{variant:"outline",className:"flex-1",onClick:()=>j(!1),children:x("common.cancel","å–æ¶ˆ")}),e.jsxs(T,{className:"flex-1",onClick:S,children:[x("community.confirmSelection","ç¡®è®¤é€‰æ‹©"),i.length>0&&` (${i.length})`]})]})})]})})]}):e.jsxs(pe,{open:t,onOpenChange:j,children:[e.jsx(he,{asChild:!0,children:O}),e.jsxs(xe,{className:"w-80 p-0",align:"start",children:[e.jsx("div",{className:"p-3 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(L,{placeholder:x("community.searchRestaurant","æœç´¢é¤åŽ…..."),value:p,onChange:l=>y(l.target.value),className:"pl-9"})]})}),s.length>0&&e.jsx("div",{className:"p-3 border-b",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map(l=>{const g=o?.find(N=>N.id===l);return g?e.jsxs(Y,{variant:"secondary",className:"gap-1 pr-1",children:[e.jsx("span",{className:"truncate max-w-[100px]",children:r(g,"name")}),e.jsx("button",{type:"button",className:"hover:bg-muted-foreground/20 rounded-full p-0.5",onClick:N=>{N.stopPropagation(),I(l)},children:e.jsx(G,{className:"h-3 w-3"})})]},l):null})})}),e.jsxs("div",{className:"max-h-64 overflow-y-auto p-2",children:[C.map(l=>e.jsx(V,{restaurant:l,isSelected:s.includes(l.id),onToggle:()=>I(l.id)},l.id)),C.length===0&&p&&e.jsx("div",{className:"py-4 text-center text-muted-foreground text-sm",children:x("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤åŽ…")})]})]})]})},Re=m.forwardRef(({className:t,...c},s)=>e.jsx(M,{ref:s,className:P("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...c}));Re.displayName=M.displayName;const ds=m.forwardRef(({className:t,...c},s)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(te,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(M.Input,{ref:s,className:P("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...c})]}));ds.displayName=M.Input.displayName;const Ee=m.forwardRef(({className:t,...c},s)=>e.jsx(M.List,{ref:s,className:P("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...c}));Ee.displayName=M.List.displayName;const ms=m.forwardRef((t,c)=>e.jsx(M.Empty,{ref:c,className:"py-6 text-center text-sm",...t}));ms.displayName=M.Empty.displayName;const Ue=m.forwardRef(({className:t,...c},s)=>e.jsx(M.Group,{ref:s,className:P("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...c}));Ue.displayName=M.Group.displayName;const us=m.forwardRef(({className:t,...c},s)=>e.jsx(M.Separator,{ref:s,className:P("-mx-1 h-px bg-border",t),...c}));us.displayName=M.Separator.displayName;const re=m.forwardRef(({className:t,...c},s)=>e.jsx(M.Item,{ref:s,className:P("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",t),...c}));re.displayName=M.Item.displayName;const ps=({open:t,onOpenChange:c,value:s,onSelect:n,activities:o})=>{const{t:d}=$(),{getLocalizedField:u}=ce(),x=ie(),[r,v]=m.useState(s),p=a=>{a&&v(s),c(a)},y=()=>{if(!s)return"";const a=o?.find(j=>j.id===s);return a?u(a,"title"):""},i=()=>{n(r),c(!1)},h=a=>{n(a),c(!1)},f=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>p(!0),children:[s?e.jsx("span",{className:"text-primary",children:y()}):e.jsx("span",{className:"text-muted-foreground",children:d("community.linkActivity","å…³è”æ´»åŠ¨")}),e.jsx(je,{className:"h-4 w-4 opacity-50"})]});return x?e.jsxs(e.Fragment,{children:[f,e.jsx(oe,{open:t,onOpenChange:p,children:e.jsxs(de,{className:"max-h-[85vh] flex flex-col",children:[e.jsx(me,{className:"pb-2",children:e.jsx(ue,{children:d("community.selectActivity","é€‰æ‹©æ´»åŠ¨")})}),e.jsx(ke,{className:"flex-1 px-4",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:P("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",r===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>v(""),children:[e.jsx(K,{className:P("h-4 w-4 shrink-0",r===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:d("community.noActivity","ä¸å…³è”æ´»åŠ¨")})]}),o.map(a=>e.jsxs("div",{className:P("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",r===a.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>v(a.id),children:[e.jsx(K,{className:P("h-4 w-4 shrink-0",r===a.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:u(a,"title")})]})]},a.id)),o.length===0&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:d("activities.noActivities","æš‚æ— å¯ç”¨æ´»åŠ¨")})]})}),e.jsx(Ie,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(T,{variant:"outline",className:"flex-1",onClick:()=>p(!1),children:d("common.cancel","å–æ¶ˆ")}),e.jsx(T,{className:"flex-1",onClick:i,children:d("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(pe,{open:t,onOpenChange:p,children:[e.jsx(he,{asChild:!0,children:f}),e.jsx(xe,{className:"w-72 p-0",align:"start",children:e.jsx(Re,{children:e.jsx(Ee,{children:e.jsxs(Ue,{children:[e.jsxs(re,{value:"none",onSelect:()=>h(""),children:[e.jsx(K,{className:P("mr-2 h-4 w-4",s?"opacity-0":"opacity-100")}),d("community.noActivity","ä¸å…³è”æ´»åŠ¨")]}),o.map(a=>e.jsxs(re,{value:a.id,onSelect:()=>h(a.id),children:[e.jsx(K,{className:P("mr-2 h-4 w-4",s===a.id?"opacity-100":"opacity-0")}),u(a,"title")]},a.id))]})})})})]})},fe=[{name:"smileys",emojis:["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ¤£","ðŸ˜‚","ðŸ™‚","ðŸ˜Š","ðŸ˜‡","ðŸ¥°","ðŸ˜","ðŸ¤©","ðŸ˜˜","ðŸ˜—","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ¤¥","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¥µ","ðŸ¥¶","ðŸ¥´","ðŸ˜µ","ðŸ¤¯","ðŸ¤ ","ðŸ¥³","ðŸ˜Ž","ðŸ¤“","ðŸ§"]},{name:"gestures",emojis:["ðŸ‘","ðŸ‘Ž","ðŸ‘Œ","ðŸ¤Œ","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ‘‡","â˜ï¸","âœ‹","ðŸ¤š","ðŸ–ï¸","ðŸ––","ðŸ‘‹","ðŸ¤","ðŸ™","ðŸ’ª","ðŸ¦¾","ðŸ¦¿","ðŸ¦µ","ðŸ¦¶","ðŸ‘‚","ðŸ¦»","ðŸ‘ƒ","ðŸ§ ","ðŸ‘€","ðŸ‘ï¸","ðŸ‘…","ðŸ‘„"]},{name:"food",emojis:["ðŸ","ðŸŽ","ðŸ","ðŸŠ","ðŸ‹","ðŸŒ","ðŸ‰","ðŸ‡","ðŸ“","ðŸ«","ðŸˆ","ðŸ’","ðŸ‘","ðŸ¥­","ðŸ","ðŸ¥¥","ðŸ¥","ðŸ…","ðŸ†","ðŸ¥‘","ðŸ¥¦","ðŸ¥¬","ðŸ¥’","ðŸŒ¶ï¸","ðŸ«‘","ðŸŒ½","ðŸ¥•","ðŸ§„","ðŸ§…","ðŸ¥”","ðŸ ","ðŸ¥","ðŸ¥¯","ðŸž","ðŸ¥–","ðŸ¥¨","ðŸ§€","ðŸ¥š","ðŸ³","ðŸ§ˆ","ðŸ¥ž","ðŸ§‡","ðŸ¥“","ðŸ¥©","ðŸ—","ðŸ–","ðŸ¦´","ðŸŒ­","ðŸ”","ðŸŸ","ðŸ•","ðŸ«“","ðŸ¥ª","ðŸ¥™","ðŸ§†","ðŸŒ®","ðŸŒ¯","ðŸ«”","ðŸ¥—","ðŸ¥˜","ðŸ«•","ðŸ¥«","ðŸ","ðŸœ","ðŸ²","ðŸ›","ðŸ£","ðŸ±","ðŸ¥Ÿ","ðŸ¦ª","ðŸ¤","ðŸ™","ðŸš","ðŸ˜","ðŸ¥","ðŸ¥ ","ðŸ¥®","ðŸ¢","ðŸ¡","ðŸ§","ðŸ¨","ðŸ¦","ðŸ¥§","ðŸ§","ðŸ°","ðŸŽ‚","ðŸ®","ðŸ­","ðŸ¬","ðŸ«","ðŸ¿","ðŸ©","ðŸª"]},{name:"hearts",emojis:["â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ","â™¥ï¸"]},{name:"objects",emojis:["â­","ðŸŒŸ","âœ¨","ðŸ’«","ðŸ”¥","ðŸ’¯","ðŸŽ‰","ðŸŽŠ","ðŸŽˆ","ðŸŽ","ðŸ†","ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰","âš½","ðŸ€","ðŸˆ","âš¾","ðŸŽ¾","ðŸ","ðŸŽ±","ðŸ“","ðŸŽ®","ðŸŽ²","ðŸ§©","ðŸŽ­","ðŸŽ¨","ðŸŽ¬","ðŸŽ¤","ðŸŽ§","ðŸŽµ","ðŸŽ¶","ðŸŽ¹","ðŸŽ¸","ðŸŽº","ðŸŽ»","ðŸ“·","ðŸ“¸","ðŸ“¹","ðŸŽ¥","ðŸ“±","ðŸ’»","âŒ¨ï¸","ðŸ–¥ï¸","ðŸ“º","ðŸ“»","â°","âŒš","ðŸ’¡","ðŸ”¦","ðŸ“š","ðŸ“–","âœï¸","ðŸ“","ðŸ’°","ðŸ’µ","ðŸ’´","ðŸ’¶","ðŸ’·","ðŸ’³","ðŸ›’","ðŸŽ€","ðŸŽ—ï¸"]},{name:"nature",emojis:["ðŸŒ¸","ðŸ’®","ðŸµï¸","ðŸŒ¹","ðŸ¥€","ðŸŒº","ðŸŒ»","ðŸŒ¼","ðŸŒ·","ðŸŒ±","ðŸª´","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŒµ","ðŸŒ¾","ðŸŒ¿","â˜˜ï¸","ðŸ€","ðŸ","ðŸ‚","ðŸƒ","ðŸŒ","ðŸŒŽ","ðŸŒ","ðŸŒ™","â­","â˜€ï¸","ðŸŒ¤ï¸","â›…","ðŸŒ¥ï¸","â˜ï¸","ðŸŒ¦ï¸","ðŸŒ§ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","â˜ƒï¸","â›„","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒŠ","ðŸ’§","ðŸ’¦","â˜”","ðŸŒˆ"]}],hs=({onSelect:t})=>{const{t:c}=$(),s=ie(),[n,o]=m.useState(!1),[d,u]=m.useState(0),x=y=>{t(y),s||o(!1)},r={smileys:c("emoji.smileys","è¡¨æƒ…"),gestures:c("emoji.gestures","æ‰‹åŠ¿"),food:c("emoji.food","ç¾Žé£Ÿ"),hearts:c("emoji.hearts","çˆ±å¿ƒ"),objects:c("emoji.objects","ç‰©å“"),nature:c("emoji.nature","è‡ªç„¶")},v=e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 border-b",children:fe.map((y,i)=>e.jsx("button",{type:"button",onClick:()=>u(i),className:`px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors ${d===i?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-muted-foreground"}`,children:r[y.name]},y.name))}),e.jsx("div",{className:"grid grid-cols-8 gap-1",children:fe[d].emojis.map((y,i)=>e.jsx("button",{type:"button",onClick:()=>x(y),className:"w-9 h-9 flex items-center justify-center text-xl hover:bg-muted rounded-md transition-colors",children:y},i))})]}),p=e.jsxs("button",{type:"button",onClick:()=>o(!0),className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(Fe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:c("community.emoji","è¡¨æƒ…")})]});return s?e.jsxs(e.Fragment,{children:[p,e.jsx(oe,{open:n,onOpenChange:o,children:e.jsxs(de,{className:"h-[50vh]",children:[e.jsx(me,{className:"pb-2",children:e.jsx(ue,{children:c("emoji.title","é€‰æ‹©è¡¨æƒ…")})}),e.jsx(ke,{className:"flex-1 px-4 pb-4",children:v})]})})]}):e.jsxs(pe,{open:n,onOpenChange:o,children:[e.jsx(he,{asChild:!0,children:p}),e.jsx(xe,{className:"w-80 p-3",align:"start",side:"top",children:v})]})},Ps=({post:t,open:c,onOpenChange:s})=>{const{t:n}=$();ce();const o=ts(),{data:d}=as(),{data:u}=rs(),{isMerchant:x,isAdmin:r,isSupervisor:v}=Xe(),p=!x&&!v&&!r,[y,i]=m.useState(t.content),[h,f]=m.useState(t.image_urls||[]),[a,j]=m.useState(t.video_url||null),[C,F]=m.useState(t.activity_id||""),[S,I]=m.useState(t.restaurants?.map(w=>w.id)||(t.restaurant?[t.restaurant.id]:[])),[A,E]=m.useState(!1),[Q,O]=m.useState(!1),[V,l]=m.useState(!1),[g,N]=m.useState(!1),b=m.useRef(null),U=m.useRef(null);m.useEffect(()=>{c&&(i(t.content),f(t.image_urls||[]),j(t.video_url||null),F(t.activity_id||""),I(t.restaurants?.map(w=>w.id)||(t.restaurant?[t.restaurant.id]:[])))},[c,t]);const ee=d?.filter(w=>w.status==="published")||[],z=async w=>{const _=w.target.files;if(!(!_||_.length===0)){if(h.length+_.length>9){k.error(n("community.maxImages","æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡"));return}E(!0);try{const{data:{user:q}}=await R.auth.getUser();if(!q)throw new Error("Not authenticated");const H=[];for(const B of Array.from(_)){const X=B.name.split(".").pop(),J=`${q.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${X}`,{error:ge}=await R.storage.from("community-posts").upload(J,B);if(ge)throw ge;const{data:{publicUrl:Te}}=R.storage.from("community-posts").getPublicUrl(J);H.push(Te)}f(B=>[...B,...H])}catch(q){console.error("Upload error:",q),k.error(n("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{E(!1),b.current&&(b.current.value="")}}},se=async w=>{const _=w.target.files?.[0];if(_){if(_.size>100*1024*1024){k.error(n("community.videoTooLarge","è§†é¢‘ä¸èƒ½è¶…è¿‡100MB"));return}E(!0);try{const{data:{user:q}}=await R.auth.getUser();if(!q)throw new Error("Not authenticated");const H=_.name.split(".").pop(),B=`${q.id}/${Date.now()}.${H}`,{error:X}=await R.storage.from("community-posts").upload(B,_);if(X)throw X;const{data:{publicUrl:J}}=R.storage.from("community-posts").getPublicUrl(B);j(J)}catch(q){console.error("Upload error:",q),k.error(n("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{E(!1),U.current&&(U.current.value="")}}},Pe=w=>{f(_=>_.filter((q,H)=>H!==w))},Me=()=>{j(null)},Le=async()=>{if(N(!1),!y.trim()){k.error(n("community.contentRequired","è¯·è¾“å…¥å†…å®¹"));return}if(p&&S.length===0){N(!0),k.error(n("community.restaurantRequired","è¯·é€‰æ‹©é¤åŽ…"));return}await o.mutateAsync({id:t.id,content:y,image_urls:h,video_url:a,activity_id:C||null,restaurant_ids:S.length>0?S:void 0}),s(!1)};return e.jsx(Ce,{open:c,onOpenChange:s,children:e.jsxs(Se,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(ye,{children:e.jsx(_e,{children:n("community.editPost","ç¼–è¾‘å¸–å­")})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>s(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(ae,{className:"h-5 w-5"})}),e.jsx("span",{className:"font-medium text-sm",children:n("community.editPost","ç¼–è¾‘å¸–å­")}),e.jsxs(T,{size:"sm",onClick:Le,disabled:o.isPending||!y.trim(),className:"rounded-full px-6",children:[o.isPending&&e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}),n("community.resubmit","é‡æ–°æäº¤")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[e.jsx("div",{className:"px-3 py-2 bg-amber-500/10 border border-amber-500/30 rounded-md text-sm text-amber-700 dark:text-amber-400",children:n("community.editNotice","ç¼–è¾‘åŽå¸–å­å°†é‡æ–°æäº¤å®¡æ ¸")}),e.jsx(le,{value:y,onChange:w=>i(w.target.value),placeholder:n("community.contentPlaceholder","åˆ†äº«ä½ çš„æƒ³æ³•..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base whitespace-pre-wrap"}),h.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:h.map((w,_)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:w,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>Pe(_),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-3 w-3"})})]},_))}),a&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:a,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:Me,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-2 pb-0 bg-background shrink-0 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:`flex items-center gap-3 ${g&&p&&S.length===0?"text-destructive":""}`,children:[e.jsx(Ne,{className:`h-5 w-5 shrink-0 ${g&&p&&S.length===0?"text-destructive":"text-muted-foreground"}`}),x?e.jsx("span",{className:"text-sm text-muted-foreground",children:S.length>0?n("community.restaurantSelected","å·²é€‰æ‹©é¤åŽ…"):n("community.noRestaurant","æœªå…³è”é¤åŽ…")}):e.jsx(os,{open:Q,onOpenChange:w=>{O(w),w&&N(!1)},value:S,onSelect:w=>{I(w),N(!1)},restaurants:u||[],required:p})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ve,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(ps,{open:V,onOpenChange:l,value:C,onSelect:F,activities:ee})]})]}),g&&p&&S.length===0&&e.jsx("p",{className:"text-xs text-destructive pl-8",children:n("community.restaurantRequired","è¯·é€‰æ‹©é¤åŽ…")})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 pt-0 py-2 pb-[max(2rem,calc(env(safe-area-inset-bottom)+1rem))] bg-background shrink-0",children:[e.jsx("input",{ref:b,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:z}),e.jsx("input",{ref:U,type:"file",accept:"video/*",className:"hidden",onChange:se}),e.jsxs("button",{type:"button",onClick:()=>b.current?.click(),disabled:A||h.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(ne,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:n("community.photo","ç…§ç‰‡")})]}),e.jsxs("button",{type:"button",onClick:()=>U.current?.click(),disabled:A||!!a,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(De,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:n("community.video","è§†é¢‘")})]}),e.jsx(hs,{onSelect:w=>i(_=>_+w)}),A&&e.jsx(W,{className:"h-5 w-5 animate-spin ml-auto"})]})]})})},xs=[{value:"easy",labelKey:"recipe.difficulty.easy"},{value:"medium",labelKey:"recipe.difficulty.medium"},{value:"hard",labelKey:"recipe.difficulty.hard"}],gs=["g","kg","ml","L","tsp","tbsp","cup","piece","slice","clove","pinch"],fs=({data:t,coverImage:c,nutrition:s,introduction:n,onDataChange:o,onCoverImageChange:d,onNutritionChange:u,onIntroductionChange:x})=>{const{t:r}=$(),v=m.useRef(null),[p,y]=m.useState(!!(s.calories||s.protein||s.carbs||s.fat)),[i,h]=m.useState(!1),f=async a=>{const j=a.target.files?.[0];if(j){if(j.size>5*1024*1024){k.error(r("common.imageTooLarge","å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB"));return}h(!0);try{const{data:{user:C}}=await R.auth.getUser();if(!C)throw new Error("Not authenticated");const F=j.name.split(".").pop(),S=`${C.id}/${Date.now()}-recipe-cover.${F}`,{error:I}=await R.storage.from("community-posts").upload(S,j);if(I)throw I;const{data:{publicUrl:A}}=R.storage.from("community-posts").getPublicUrl(S);d(A)}catch(C){console.error("Upload error:",C),k.error(r("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{h(!1),v.current&&(v.current.value="")}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:r("recipe.coverImage","å°é¢å›¾ç‰‡")}),e.jsx("input",{ref:v,type:"file",accept:"image/*",className:"hidden",onChange:f}),c?e.jsxs("div",{className:"relative aspect-video rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:c,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>d(null),className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-4 w-4"})})]}):e.jsx("button",{type:"button",onClick:()=>v.current?.click(),disabled:i,className:"w-full aspect-video rounded-lg border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-2 text-muted-foreground hover:border-primary hover:text-primary transition-colors",children:i?e.jsx(W,{className:"h-8 w-8 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-8 w-8"}),e.jsx("span",{className:"text-sm",children:r("recipe.addCoverImage","æ·»åŠ å°é¢å›¾ç‰‡")})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"recipe-name",children:[r("recipe.name","é£Ÿè°±åç§°")," *"]}),e.jsx(L,{id:"recipe-name",value:t.recipe_name||"",onChange:a=>o({...t,recipe_name:a.target.value}),placeholder:r("recipe.namePlaceholder","å¦‚ï¼šçº¢çƒ§è‚‰ã€ç•ªèŒ„ç‚’è›‹")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"introduction",children:[e.jsx(Ae,{className:"h-4 w-4 inline mr-1"}),r("recipe.introduction","ç¾Žé£Ÿä»‹ç»")]}),e.jsx(le,{id:"introduction",value:n,onChange:a=>x(a.target.value),placeholder:r("recipe.introductionPlaceholder","ä»‹ç»è¿™é“ç¾Žé£Ÿçš„ç‰¹è‰²ã€å£æ„Ÿã€æ¥æºæ•…äº‹ç­‰..."),rows:Math.max(3,Math.min(12,(n?.split(`
`).length||1)+1)),className:"resize-y min-h-[80px]"}),n&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[n.length," ",r("common.characters","å­—")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"cook-time",children:[e.jsx(qe,{className:"h-4 w-4 inline mr-1"}),r("recipe.cookTime","çƒ¹é¥ªæ—¶é—´")," *"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{id:"cook-time",type:"number",min:1,value:t.cook_time||"",onChange:a=>o({...t,cook_time:parseInt(a.target.value)||0}),placeholder:"30",className:"w-24"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:r("recipe.minutes","åˆ†é’Ÿ")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{children:[e.jsx($e,{className:"h-4 w-4 inline mr-1"}),r("recipe.difficulty","éš¾åº¦")," *"]}),e.jsxs(Je,{value:t.difficulty||"",onValueChange:a=>o({...t,difficulty:a}),children:[e.jsx(Ye,{children:e.jsx(Ze,{placeholder:r("recipe.selectDifficulty","é€‰æ‹©éš¾åº¦")})}),e.jsx(es,{children:xs.map(a=>e.jsx(ss,{value:a.value,children:r(a.labelKey,a.value)},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"servings",children:[e.jsx(ze,{className:"h-4 w-4 inline mr-1"}),r("recipe.servings","ä»½é‡")," *"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{id:"servings",type:"number",min:1,value:t.servings||"",onChange:a=>o({...t,servings:parseInt(a.target.value)||0}),placeholder:"2",className:"w-24"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:r("recipe.people","äººä»½")})]})]}),e.jsxs(is,{open:p,onOpenChange:y,children:[e.jsx(ls,{asChild:!0,children:e.jsxs(T,{variant:"ghost",type:"button",className:"w-full justify-between px-0 hover:bg-transparent",children:[e.jsxs("span",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Be,{className:"h-4 w-4"}),r("recipe.nutritionInfo","è¥å…»ä¿¡æ¯"),e.jsxs("span",{className:"text-xs text-muted-foreground font-normal",children:["(",r("common.optional","å¯é€‰"),")"]})]}),p?e.jsx(Oe,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})]})}),e.jsx(cs,{className:"space-y-4 pt-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(D,{htmlFor:"calories",className:"text-xs",children:r("recipe.calories","å¡è·¯é‡Œ")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{id:"calories",type:"number",min:0,value:s.calories||"",onChange:a=>u({...s,calories:parseInt(a.target.value)||void 0}),placeholder:"300",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"kcal"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(D,{htmlFor:"protein",className:"text-xs",children:r("recipe.protein","è›‹ç™½è´¨")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{id:"protein",type:"number",min:0,value:s.protein||"",onChange:a=>u({...s,protein:parseInt(a.target.value)||void 0}),placeholder:"20",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"g"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(D,{htmlFor:"carbs",className:"text-xs",children:r("recipe.carbs","ç¢³æ°´")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{id:"carbs",type:"number",min:0,value:s.carbs||"",onChange:a=>u({...s,carbs:parseInt(a.target.value)||void 0}),placeholder:"30",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"g"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(D,{htmlFor:"fat",className:"text-xs",children:r("recipe.fat","è„‚è‚ª")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{id:"fat",type:"number",min:0,value:s.fat||"",onChange:a=>u({...s,fat:parseInt(a.target.value)||void 0}),placeholder:"10",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"g"})]})]})]})})]})]})},js=({ingredients:t,onChange:c})=>{const{t:s}=$(),n=()=>{c([...t,{name:"",amount:"",unit:""}])},o=(u,x,r)=>{const v=[...t];v[u]={...v[u],[x]:r},c(v)},d=u=>{c(t.filter((x,r)=>r!==u))};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(D,{className:"text-base font-medium",children:[s("recipe.ingredients","é…æ–™")," *"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[t.filter(u=>u.name).length," ",s("recipe.items","é¡¹")]})]}),e.jsx("div",{className:"space-y-3",children:t.map((u,x)=>e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(L,{value:u.name,onChange:r=>o(x,"name",r.target.value),placeholder:s("recipe.ingredientName","é…æ–™åç§°")})}),e.jsx("div",{className:"w-20",children:e.jsx(L,{value:u.amount,onChange:r=>o(x,"amount",r.target.value),placeholder:s("recipe.amount","é‡")})}),e.jsxs("div",{className:"w-20",children:[e.jsx(L,{value:u.unit,onChange:r=>o(x,"unit",r.target.value),placeholder:s("recipe.unit","å•ä½"),list:"common-units"}),e.jsx("datalist",{id:"common-units",children:gs.map(r=>e.jsx("option",{value:r},r))})]}),e.jsx(T,{type:"button",variant:"ghost",size:"icon",onClick:()=>d(x),disabled:t.length===1,className:"shrink-0",children:e.jsx(be,{className:"h-4 w-4 text-destructive"})})]}),e.jsxs("div",{className:"flex items-center gap-2 pl-0",children:[e.jsx(He,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx(L,{value:u.link||"",onChange:r=>o(x,"link",r.target.value),placeholder:s("recipe.ingredientLink","é“¾æŽ¥ï¼ˆé€‰å¡«ï¼‰"),className:"h-8 text-xs"})]})]},x))}),e.jsxs(T,{type:"button",variant:"outline",onClick:n,className:"w-full",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),s("recipe.addIngredient","æ·»åŠ é…æ–™")]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("recipe.unitsHint","å¸¸ç”¨å•ä½ï¼šg, kg, ml, L, å‹º, æ¯, ä¸ª, ç‰‡, é€‚é‡")})]})},Z=3,Ns=({steps:t,onChange:c})=>{const{t:s}=$(),[n,o]=m.useState(null),d=m.useRef([]),u=i=>i.image_urls&&i.image_urls.length>0?i.image_urls:i.image_url?[i.image_url]:[],x=()=>{const i=t.length+1;c([...t,{order:i,description:"",image_urls:[]}])},r=(i,h,f)=>{const a=[...t];a[i]={...a[i],[h]:f},c(a)},v=i=>{const h=t.filter((f,a)=>a!==i).map((f,a)=>({...f,order:a+1}));c(h)},p=(i,h)=>{const a=u(t[i]).filter((j,C)=>C!==h);r(i,"image_urls",a),r(i,"image_url",void 0)},y=async(i,h)=>{const f=h.target.files?.[0];if(!f)return;const a=u(t[i]);if(a.length>=Z){k.error(s("recipe.maxStepImages","æ¯ä¸ªæ­¥éª¤æœ€å¤šä¸Šä¼ {{max}}å¼ å›¾ç‰‡",{max:Z}));return}if(f.size>5*1024*1024){k.error(s("common.imageTooLarge","å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB"));return}o(i);try{const{data:{user:j}}=await R.auth.getUser();if(!j)throw new Error("Not authenticated");const C=f.name.split(".").pop(),F=`${j.id}/${Date.now()}-step-${i}.${C}`,{error:S}=await R.storage.from("community-posts").upload(F,f);if(S)throw S;const{data:{publicUrl:I}}=R.storage.from("community-posts").getPublicUrl(F),A=[...a,I],E=[...t];E[i]={...E[i],image_urls:A,image_url:void 0},c(E)}catch(j){console.error("Upload error:",j),k.error(s("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{o(null),d.current[i]&&(d.current[i].value="")}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(D,{className:"text-base font-medium",children:[s("recipe.steps","çƒ¹é¥ªæ­¥éª¤")," *"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[t.filter(i=>i.description).length," ",s("recipe.stepsCount","æ­¥")]})]}),e.jsx("div",{className:"space-y-4",children:t.map((i,h)=>{const f=u(i);return e.jsxs("div",{className:"p-4 border rounded-lg space-y-3 bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-primary",children:s("recipe.stepNumber","ç¬¬{{n}}æ­¥",{n:h+1})})]}),e.jsx(T,{type:"button",variant:"ghost",size:"icon",onClick:()=>v(h),disabled:t.length===1,children:e.jsx(be,{className:"h-4 w-4 text-destructive"})})]}),e.jsx(le,{value:i.description,onChange:a=>r(h,"description",a.target.value),placeholder:s("recipe.stepDescriptionPlaceholder","æè¿°è¿™ä¸€æ­¥çš„æ“ä½œ..."),className:"min-h-[80px]"}),e.jsxs("div",{children:[e.jsx("input",{ref:a=>d.current[h]=a,type:"file",accept:"image/*",className:"hidden",onChange:a=>y(h,a)}),f.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:f.map((a,j)=>e.jsxs("div",{className:"relative w-24 h-20 rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:a,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>p(h,j),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-3 w-3"})})]},j))}),f.length<Z&&e.jsxs("button",{type:"button",onClick:()=>d.current[h]?.click(),disabled:n===h,className:"flex items-center gap-2 text-sm text-muted-foreground hover:text-primary transition-colors",children:[n===h?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(ne,{className:"h-4 w-4"}),e.jsx("span",{children:f.length===0?s("recipe.addStepImage","æ·»åŠ æ­¥éª¤å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰"):s("recipe.addMoreImages","ç»§ç»­æ·»åŠ  ({{current}}/{{max}})",{current:f.length,max:Z})})]})]})]},h)})}),e.jsxs(T,{type:"button",variant:"outline",onClick:x,className:"w-full",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),s("recipe.addStep","æ·»åŠ æ­¥éª¤")]})]})},vs=()=>{const t=Ge(),{t:c}=$();return Qe({mutationFn:async s=>{const{data:{user:n}}=await R.auth.getUser();if(!n)throw new Error("Not authenticated");const o=s.introduction||"",d=[];s.cover_image&&d.push(s.cover_image),s.steps.forEach(r=>{r.image_urls&&r.image_urls.length>0?r.image_urls.forEach(v=>d.push(v)):r.image_url&&d.push(r.image_url)});const{data:u,error:x}=await R.from("community_posts").update({content:o,image_urls:d,recipe_name:s.recipe_name,cook_time:s.cook_time,difficulty:s.difficulty,servings:s.servings,ingredients:s.ingredients,steps:s.steps,nutrition:s.nutrition?s.nutrition:null,recipe_tags:s.recipe_tags||null,recipe_category:s.recipe_category||null,status:"pending",moderation_status:"pending",risk_score:null,risk_reasons:null,ai_reviewed_at:null}).eq("id",s.id).eq("author_id",n.id).select().single();if(x)throw x;try{await R.functions.invoke("moderate-post",{body:{post_id:u.id,content:o,user_id:n.id,image_urls:d}})}catch(r){console.error("Moderation call failed:",r)}return u},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["community-post"]}),t.invalidateQueries({queryKey:["admin-community-posts"]}),t.invalidateQueries({queryKey:["has-posted-today"]}),k.success(c("recipe.editSuccess","é£Ÿè°±å·²æ›´æ–°ï¼Œç­‰å¾…å®¡æ ¸"))},onError:s=>{console.error("Edit recipe error:",s),k.error(c("recipe.editError","ç¼–è¾‘å¤±è´¥"))}})},ys=({post:t,onClose:c,onSuccess:s})=>{const{t:n}=$(),o=vs(),[d,u]=m.useState(0),x=()=>!t.image_urls||t.image_urls.length===0?null:t.image_urls[0]||null,[r,v]=m.useState(x()),[p,y]=m.useState({recipe_name:t.recipe_name||"",cook_time:t.cook_time||void 0,difficulty:t.difficulty||void 0,servings:t.servings||void 0}),[i,h]=m.useState(t.ingredients&&t.ingredients.length>0?t.ingredients:[{name:"",amount:"",unit:""}]),[f,a]=m.useState(t.steps&&t.steps.length>0?t.steps:[{order:1,description:""}]),[j,C]=m.useState(t.nutrition||{}),[F,S]=m.useState(t.content||""),I=[{key:"basic",title:n("recipe.step.basic","åŸºæœ¬ä¿¡æ¯")},{key:"ingredients",title:n("recipe.step.ingredients","é…æ–™")},{key:"steps",title:n("recipe.step.steps","æ­¥éª¤")}],A=(d+1)/I.length*100,E=()=>p.recipe_name?.trim()?!p.cook_time||p.cook_time<1?(k.error(n("recipe.cookTimeRequired","è¯·è¾“å…¥çƒ¹é¥ªæ—¶é—´")),!1):p.difficulty?!p.servings||p.servings<1?(k.error(n("recipe.servingsRequired","è¯·è¾“å…¥ä»½é‡")),!1):!0:(k.error(n("recipe.difficultyRequired","è¯·é€‰æ‹©éš¾åº¦")),!1):(k.error(n("recipe.nameRequired","è¯·è¾“å…¥é£Ÿè°±åç§°")),!1),Q=()=>i.filter(U=>U.name.trim()).length===0?(k.error(n("recipe.ingredientsRequired","è¯·è‡³å°‘æ·»åŠ ä¸€ç§é…æ–™")),!1):!0,O=()=>f.filter(U=>U.description.trim()).length===0?(k.error(n("recipe.stepsRequired","è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ­¥éª¤")),!1):!0,V=()=>{d===0&&!E()||d===1&&!Q()||u(b=>Math.min(b+1,I.length-1))},l=()=>{u(b=>Math.max(b-1,0))},g=async()=>{if(!O())return;const b=i.filter(z=>z.name.trim()),U=f.filter(z=>z.description.trim()).map((z,se)=>({...z,order:se+1})),ee=j.calories||j.protein||j.carbs||j.fat;try{await o.mutateAsync({id:t.id,recipe_name:p.recipe_name,cook_time:p.cook_time,difficulty:p.difficulty,servings:p.servings,ingredients:b,steps:U,cover_image:r,nutrition:ee?j:void 0,introduction:F.trim()||void 0}),s()}catch{}},N=()=>{switch(d){case 0:return e.jsx(fs,{data:p,coverImage:r,nutrition:j,introduction:F,onDataChange:y,onCoverImageChange:v,onNutritionChange:C,onIntroductionChange:S});case 1:return e.jsx(js,{ingredients:i,onChange:h});case 2:return e.jsx(Ns,{steps:f,onChange:a});default:return null}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-background shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("button",{type:"button",onClick:c,className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(ae,{className:"h-5 w-5"})}),e.jsx("h2",{className:"font-medium",children:n("recipe.editTitle","ç¼–è¾‘é£Ÿè°±")}),e.jsx("div",{className:"w-6"})]}),e.jsx("div",{className:"px-3 py-2 mb-3 bg-amber-500/10 border border-amber-500/30 rounded-md text-xs text-amber-700 dark:text-amber-400",children:n("community.editNotice","ç¼–è¾‘åŽå¸–å­å°†é‡æ–°æäº¤å®¡æ ¸")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ns,{value:A,className:"h-1"}),e.jsx("div",{className:"flex justify-between text-xs text-muted-foreground",children:I.map((b,U)=>e.jsx("span",{className:U===d?"text-primary font-medium":"",children:b.title},b.key))})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:N()}),e.jsx("div",{className:"px-4 py-3 pb-[max(1rem,env(safe-area-inset-bottom))] border-t bg-background shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[d>0&&e.jsxs(T,{type:"button",variant:"outline",onClick:l,className:"flex-1",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),n("common.back","ä¸Šä¸€æ­¥")]}),d<I.length-1?e.jsxs(T,{type:"button",onClick:V,className:"flex-1",children:[n("common.next","ä¸‹ä¸€æ­¥"),e.jsx(We,{className:"h-4 w-4 ml-2"})]}):e.jsxs(T,{type:"button",onClick:g,disabled:o.isPending,className:"flex-1",children:[o.isPending?e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(K,{className:"h-4 w-4 mr-2"}),n("recipe.resubmit","é‡æ–°æäº¤")]})]})})]})},Ms=({post:t,open:c,onOpenChange:s})=>{const{t:n}=$();return e.jsx(Ce,{open:c,onOpenChange:s,children:e.jsxs(Se,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(ye,{children:e.jsx(_e,{children:n("recipe.editTitle","ç¼–è¾‘é£Ÿè°±")})}),e.jsx(ys,{post:t,onClose:()=>s(!1),onSuccess:()=>s(!1)})]})})};export{ps as A,Ms as E,os as M,Ns as R,Ps as a,js as b,fs as c,hs as d};
//# sourceMappingURL=EditRecipeDialog-PDDiowvd.js.map
