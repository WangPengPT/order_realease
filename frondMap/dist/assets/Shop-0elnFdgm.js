import{p as L,r as N,j as s,c2 as j,b0 as B,aL as U,u as O,q as Q,b4 as D,e7 as z,ce as H,am as K}from"./vendor-react-Snp1tga-.js";import{D as V,d as $,e as E,f as Y,V as W,W as X,a2 as G,a3 as J,a4 as Z,a5 as ss,a6 as es,X as as,B as P,u as ts,a as ns,N as is,C as w,w as b,v as rs,M as cs,$ as ls,k}from"./index-sfQV7kES.js";import{e as os}from"./usePoints-DfPIb5ss.js";import{d as ds,e as ms,f as hs}from"./useShopItems-r6YXfLff.js";import{u as T}from"./useLocalizedContent-Ei9FcTeq.js";import{u as ps,P as xs}from"./PointsHistoryDialog-DXy_UC1P.js";import{P as us}from"./PullToRefresh-CGU9Lz6E.js";import{F as js}from"./FeatureDisabledPage-FkCOuGCD.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-D3137XJ9.js";import"./tabs-BW4oWhgn.js";const fs=({open:a,onOpenChange:x,item:t,userPoints:d})=>{const{t:n}=L(),{getLocalizedField:m}=T(),{data:f=[]}=ps(),i=ds(),[r,y]=N.useState(""),h=t.item_type==="physical",v=d-t.points_cost,_=async()=>{await i.mutateAsync({itemId:t.id,shippingAddressId:h?r:void 0}),x(!1)},g=!h||r;return s.jsx(V,{open:a,onOpenChange:x,children:s.jsxs($,{className:"sm:max-w-md",children:[s.jsxs(E,{children:[s.jsx(Y,{children:n("shop.confirmPurchase")}),s.jsx(W,{children:n("shop.confirmPurchaseDesc")})]}),s.jsxs("div",{className:"space-y-4 py-4",children:[s.jsxs("div",{className:"flex items-start gap-4 p-4 bg-secondary/30 rounded-lg",children:[t.image_url&&s.jsx("img",{src:t.image_url,alt:String(m(t,"name")),className:"w-16 h-16 rounded-lg object-cover"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h4",{className:"font-semibold",children:m(t,"name")}),s.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:m(t,"description")})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"text-muted-foreground",children:n("shop.currentPoints")}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(j,{className:"w-4 h-4 text-accent"}),s.jsx("span",{className:"font-medium",children:d})]})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"text-muted-foreground",children:n("shop.pointsCost")}),s.jsxs("span",{className:"flex items-center gap-1 text-destructive",children:[s.jsx("span",{children:"-"}),s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{className:"font-medium",children:t.points_cost})]})]}),s.jsxs("div",{className:"border-t pt-2 flex justify-between items-center",children:[s.jsx("span",{className:"font-medium",children:n("shop.afterPurchase")}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(j,{className:"w-4 h-4 text-accent"}),s.jsx("span",{className:"font-bold",children:v})]})]})]}),h&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs(X,{className:"flex items-center gap-2",children:[s.jsx(B,{className:"w-4 h-4"}),n("shop.selectAddress")]}),f.length===0?s.jsx("p",{className:"text-sm text-muted-foreground",children:n("shop.noAddresses")}):s.jsxs(G,{value:r,onValueChange:y,children:[s.jsx(J,{children:s.jsx(Z,{placeholder:n("shop.selectAddressPlaceholder")})}),s.jsx(ss,{children:f.map(l=>s.jsx(es,{value:l.id,children:s.jsxs("div",{className:"text-left",children:[s.jsx("div",{className:"font-medium",children:l.label}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[l.street,", ",l.city]})]})},l.id))})]})]})]}),s.jsxs(as,{className:"gap-2 sm:gap-0",children:[s.jsx(P,{variant:"outline",onClick:()=>x(!1),children:n("common.cancel")}),s.jsx(P,{onClick:_,disabled:!g||i.isPending,children:i.isPending?s.jsxs(s.Fragment,{children:[s.jsx(U,{className:"w-4 h-4 mr-2 animate-spin"}),n("common.processing")]}):n("shop.confirmPurchaseBtn")})]})]})})},Ts=()=>{const{t:a}=L(),x=O(),{user:t}=ts(),{getLocalizedField:d}=T(),{settings:n,isLoading:m}=ns(),{isAdmin:f}=is(),i=Q(),{data:r=0,isLoading:y}=os(),{data:h=[],isLoading:v}=ms(),{data:_=[]}=hs(),[g,l]=N.useState(null),[I,C]=N.useState(!1),A=N.useCallback(async()=>{await Promise.all([i.invalidateQueries({queryKey:["shop-items"]}),i.invalidateQueries({queryKey:["user-points"]}),i.invalidateQueries({queryKey:["user-purchase-limits"]})])},[i]),F=e=>{switch(e){case"coupon":return s.jsx(K,{className:"w-5 h-5"});case"physical":return s.jsx(H,{className:"w-5 h-5"});case"badge":return s.jsx(z,{className:"w-5 h-5"});default:return s.jsx(D,{className:"w-5 h-5"})}},R=e=>{switch(e){case"coupon":return a("shop.itemType.coupon");case"physical":return a("shop.itemType.physical");case"badge":return a("shop.itemType.badge");default:return e}},S=e=>{const c=_.find(u=>u.shop_item_id===e.id);if(!c)return e.per_user_limit;const o=new Date(c.period_start),p=new Date;if(e.limit_refresh_period==="daily"&&o.toDateString()!==p.toDateString())return e.per_user_limit;if(e.limit_refresh_period==="weekly"){const u=new Date(p.getTime()-6048e5);if(o<u)return e.per_user_limit}return e.limit_refresh_period==="monthly"&&(o.getMonth()!==p.getMonth()||o.getFullYear()!==p.getFullYear())?e.per_user_limit:Math.max(0,e.per_user_limit-c.purchase_count)},M=e=>!(!t||r<e.points_cost||e.stock!==null&&e.stock<=0||S(e)<=0),q=e=>{if(!t){x("/auth");return}l(e),C(!0)};return!m&&n?.shop_enabled===!1&&!f?s.jsx(js,{}):v||m?s.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4",children:s.jsx("div",{className:"container mx-auto max-w-6xl",children:s.jsx("div",{className:"text-center",children:a("common.loading")})})}):s.jsx(us,{onRefresh:A,children:s.jsxs("div",{className:"min-h-screen bg-secondary/20 py-4 md:py-8 px-3 md:px-4",children:[s.jsxs("div",{className:"container mx-auto max-w-6xl",children:[s.jsx("div",{className:"mb-6 md:mb-8",children:s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-foreground mb-2",children:a("shop.title")}),s.jsx("p",{className:"text-muted-foreground",children:a("shop.description")})]}),t&&s.jsx(w,{className:"md:w-auto",children:s.jsxs(b,{className:"p-4 flex items-center gap-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(j,{className:"w-6 h-6 text-accent"}),s.jsx("span",{className:"text-2xl font-bold text-foreground",children:y?"...":r}),s.jsx("span",{className:"text-muted-foreground",children:a("shop.points")})]}),s.jsx(xs,{})]})})]})}),h.length===0?s.jsx(w,{children:s.jsxs(b,{className:"py-12 text-center",children:[s.jsx(D,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),s.jsx("p",{className:"text-muted-foreground",children:a("shop.noItems")})]})}):s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6",children:h.map(e=>{const c=e.stock!==null&&e.stock<=0,o=S(e),p=o<=0,u=r<e.points_cost;return s.jsxs(w,{className:`overflow-hidden ${c?"opacity-60":""}`,children:[e.image_url&&s.jsx("div",{className:"aspect-video overflow-hidden bg-secondary/30",children:s.jsx("img",{src:e.image_url,alt:String(d(e,"name")),className:"w-full h-full object-cover"})}),s.jsx(rs,{className:"pb-2",children:s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx(cs,{className:"text-lg line-clamp-1",children:d(e,"name")}),s.jsx(ls,{className:"line-clamp-2 mt-1",children:d(e,"description")})]}),s.jsxs(k,{variant:"secondary",className:"flex items-center gap-1 shrink-0",children:[F(e.item_type),s.jsx("span",{className:"hidden sm:inline",children:R(e.item_type)})]})]})}),s.jsxs(b,{className:"pt-0",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(j,{className:"w-4 h-4 text-accent"}),s.jsx("span",{className:"font-bold text-lg",children:e.points_cost}),s.jsx("span",{className:"text-muted-foreground text-sm",children:a("shop.points")})]}),s.jsx("div",{className:"text-sm text-muted-foreground",children:e.stock!==null?c?s.jsx(k,{variant:"destructive",children:a("shop.soldOut")}):s.jsxs("span",{children:[a("shop.stock"),": ",e.stock]}):s.jsx("span",{children:a("shop.unlimited")})})]}),s.jsxs("div",{className:"text-sm text-muted-foreground mb-3",children:[e.limit_refresh_period==="none"?s.jsx("span",{children:a("shop.limitTotal",{count:e.per_user_limit})}):s.jsx("span",{children:a(`shop.limit.${e.limit_refresh_period}`,{count:e.per_user_limit})}),t&&!c&&s.jsxs("span",{className:"ml-2",children:["(",a("shop.remaining"),": ",o,")"]})]}),s.jsx(P,{className:"w-full",disabled:!M(e),onClick:()=>q(e),children:a(t?c?"shop.soldOut":p?"shop.limitReached":u?"shop.insufficientPoints":"shop.purchase":"shop.loginToPurchase")})]})]},e.id)})})]}),g&&s.jsx(fs,{open:I,onOpenChange:C,item:g,userPoints:r})]})})};export{Ts as default};
//# sourceMappingURL=Shop-0elnFdgm.js.map
