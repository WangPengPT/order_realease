import{a as v,u,b as m}from"./vendor-query-EnOED-MY.js";import{u as c,s as l,j as p,D as _,aE as b,B as N,bh as q,c as D,d as E,e as S,bo as x,aA as T,S as A,k as C,bU as F,bV as y,Y as U,bf as H,t as Q,aJ as K,bn as B}from"./index-BjZfkycM.js";import{j as e}from"./vendor-ui-BO6fjm1h.js";import{r as g}from"./vendor-react-CrHRjzzo.js";import{T as M,a as L,b as h,c as P}from"./tabs-B66j6NG1.js";import{u as $}from"./usePoints-C3rMvZkW.js";import{u as k}from"./vendor-i18n-DWR4v88Y.js";import{f as O}from"./format-De_9CFft.js";const X=()=>{const{user:s}=c();return v({queryKey:["user-addresses",s?.id],queryFn:async()=>{if(!s)return[];const{data:n,error:o}=await l.from("user_addresses").select("*").eq("user_id",s.id).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(o)throw o;return n},enabled:!!s})},Z=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async a=>{if(!s)throw new Error("User not authenticated");const{data:r,error:i}=await l.from("user_addresses").insert({user_id:s.id,label:a.label,street:a.street,district:a.district||null,city:a.city,postal_code:a.postal_code||null,country:a.country,phone:a.phone||null,phone_code:a.phone_code||"+351",is_default:a.is_default||!1}).select().single();if(i)throw i;return r},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Address added successfully"})},onError:()=>{n({title:"Error",description:"Failed to add address",variant:"destructive"})}})},ee=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async({id:a,address:r})=>{if(!s)throw new Error("User not authenticated");const{data:i,error:d}=await l.from("user_addresses").update({label:r.label,street:r.street,district:r.district||null,city:r.city,postal_code:r.postal_code||null,country:r.country,phone:r.phone||null,phone_code:r.phone_code||"+351",is_default:r.is_default}).eq("id",a).eq("user_id",s.id).select().single();if(d)throw d;return i},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Address updated successfully"})},onError:()=>{n({title:"Error",description:"Failed to update address",variant:"destructive"})}})},se=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async a=>{if(!s)throw new Error("User not authenticated");const{error:r}=await l.from("user_addresses").delete().eq("id",a).eq("user_id",s.id);if(r)throw r},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Address deleted successfully"})},onError:()=>{n({title:"Error",description:"Failed to delete address",variant:"destructive"})}})},te=()=>{const{user:s}=c(),{toast:n}=p(),o=u();return m({mutationFn:async a=>{if(!s)throw new Error("User not authenticated");const{data:r,error:i}=await l.from("user_addresses").update({is_default:!0}).eq("id",a).eq("user_id",s.id).select().single();if(i)throw i;return r},onSuccess:()=>{o.invalidateQueries({queryKey:["user-addresses"]}),n({title:"Success",description:"Default address updated"})},onError:()=>{n({title:"Error",description:"Failed to set default address",variant:"destructive"})}})},re=()=>{const{t:s}=k(),[n,o]=g.useState(!1),{data:a=[],isLoading:r}=$(),[i,d]=g.useState("all"),j=t=>{switch(t){case"comment":return e.jsx(B,{className:"w-4 h-4"});case"admin_grant":return e.jsx(K,{className:"w-4 h-4"});case"admin_deduct":return e.jsx(y,{className:"w-4 h-4"});case"purchase":return e.jsx(Q,{className:"w-4 h-4"});case"refund":return e.jsx(H,{className:"w-4 h-4"});case"expire":return e.jsx(U,{className:"w-4 h-4"});default:return e.jsx(x,{className:"w-4 h-4"})}},w=t=>s(`points.type.${t}`),f=a.filter(t=>i==="all"?!0:i==="earned"?t.amount>0:i==="spent"?t.amount<0:!0);return e.jsxs(_,{open:n,onOpenChange:o,children:[e.jsx(b,{asChild:!0,children:e.jsxs(N,{variant:"ghost",size:"sm",className:"h-6 px-2",children:[e.jsx(q,{className:"h-3 w-3 mr-1"}),s("profile.pointsHistory","明细")]})}),e.jsxs(D,{className:"sm:max-w-lg max-h-[80vh]",children:[e.jsxs(E,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(x,{className:"w-5 h-5 text-accent"}),s("points.history")]}),e.jsx(T,{children:s("points.historyDesc")})]}),e.jsxs(M,{value:i,onValueChange:t=>d(t),children:[e.jsxs(L,{className:"grid w-full grid-cols-3",children:[e.jsx(h,{value:"all",children:s("points.filter.all")}),e.jsx(h,{value:"earned",children:s("points.filter.earned")}),e.jsx(h,{value:"spent",children:s("points.filter.spent")})]}),e.jsx(P,{value:i,className:"mt-4",children:e.jsx(A,{className:"h-[400px] pr-4",children:r?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):f.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("points.noTransactions")}):e.jsx("div",{className:"space-y-3",children:f.map(t=>e.jsxs("div",{className:"flex items-start justify-between p-3 rounded-lg border bg-card",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${t.amount>0?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"}`,children:j(t.type)}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2",children:[w(t.type),t.reason&&e.jsx(C,{variant:"outline",className:"text-xs font-normal",children:t.reason})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:O(new Date(t.created_at),"yyyy-MM-dd HH:mm")}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[s("points.balanceAfter"),": ",t.balance_after]})]})]}),e.jsxs("div",{className:`font-bold flex items-center gap-1 ${t.amount>0?"text-green-500":"text-red-500"}`,children:[t.amount>0?e.jsx(F,{className:"w-4 h-4"}):e.jsx(y,{className:"w-4 h-4"}),e.jsxs("span",{children:[t.amount>0?"+":"",t.amount]})]})]},t.id))})})})]})]})]})};export{re as P,Z as a,ee as b,se as c,te as d,X as u};
//# sourceMappingURL=PointsHistoryDialog-D1tkT0XC.js.map
