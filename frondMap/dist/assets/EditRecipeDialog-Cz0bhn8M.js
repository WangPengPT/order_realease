import{p as $,r as m,j as e,aZ as te,X as G,dK as je,a4 as K,bd as ve,dL as M,b0 as Ne,dM as Le,dN as ye,bT as re,aM as W,bi as ne,cW as Ae,w as k,bt as De,be as qe,a_ as $e,bG as ze,dO as Be,ay as Oe,aw as Ve,ak as be,bY as we,d6 as He,q as Ke,v as Ge,b2 as Qe}from"./vendor-react-87iFmKFJ.js";import{a as ie,B as Z,I as F,h as L,g as P,U as ke,M as We,F as Ce,J as Se,L as _e,ad as le,s as R,Z as T,a7 as Xe,a8 as Ye,a9 as Ze,aa as Je,ab as es}from"./index-BrOhGy48.js";import{u as ce}from"./useLocalizedContent-CFh79NZC.js";import{D as oe,a as de,b as me,c as ue,e as Ie}from"./drawer-CW6pNCyQ.js";import{P as pe,a as he,b as xe}from"./popover-EdXj_xX-.js";import{c as ss}from"./useCommunityPosts-DKYl2zeJ.js";import{u as ts}from"./useActivities-BAx51-Kh.js";import{u as rs}from"./useRestaurants-Ch3qGF43.js";import{P as as}from"./progress-BadpfeCy.js";import{C as ns,a as is,b as ls}from"./collapsible-DE4DVYv9.js";const cs=({open:s,onOpenChange:c,value:t,onSelect:n,restaurants:o,required:d=!1,maxDisplay:p=2})=>{const{t:x}=$(),{getLocalizedField:a}=ce(),N=ie(),[u,y]=m.useState(""),[i,h]=m.useState(t),[f,r]=m.useState("85vh");m.useEffect(()=>{if(!s||!N)return;const l=window.visualViewport;if(!l){r("85vh");return}const g=()=>{const v=l.height,b=Math.min(v*.85,v-50);r(`${b}px`)};return g(),l.addEventListener("resize",g),()=>{l.removeEventListener("resize",g)}},[s,N]);const j=l=>{l&&(h(t),y("")),c(l)},C=o?.filter(l=>{if(!u)return!0;const g=a(l,"name")?.toLowerCase()||"",v=l.address?.toLowerCase()||"",b=u.toLowerCase();return g.includes(b)||v.includes(b)})||[],A=l=>{h(g=>g.includes(l)?g.filter(v=>v!==l):[...g,l])},S=()=>{n(i),c(!1),y("")},I=l=>{const g=t.includes(l)?t.filter(v=>v!==l):[...t,l];n(g)},E=t.map(l=>{const g=o?.find(v=>v.id===l);return g?a(g,"name"):null}).filter(Boolean),Q=()=>{if(E.length===0)return e.jsxs("span",{className:"text-muted-foreground",children:[x("community.linkRestaurants","å…³è”é¤åŽ…"),d&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]});const l=E.slice(0,p),g=E.length-p;return e.jsxs("span",{className:"text-primary flex items-center gap-1 flex-wrap",children:[l.map((v,b)=>e.jsxs("span",{children:[v,b<l.length-1?"ã€":""]},b)),g>0&&e.jsxs(Z,{variant:"secondary",className:"text-xs px-1.5 py-0",children:["+",g]})]})},O=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors text-left",onClick:()=>j(!0),children:[e.jsx(Q,{}),e.jsx(je,{className:"h-4 w-4 opacity-50 shrink-0"})]}),V=({restaurant:l,isSelected:g,onToggle:v})=>e.jsxs("div",{className:P("flex items-start gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",g?"bg-primary/10":"hover:bg-muted"),onClick:v,children:[e.jsx("div",{className:P("h-5 w-5 shrink-0 mt-0.5 rounded border flex items-center justify-center transition-colors",g?"bg-primary border-primary":"border-muted-foreground/30"),children:g&&e.jsx(K,{className:"h-3 w-3 text-primary-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:a(l,"name")}),l.address&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate flex items-center gap-1 mt-0.5",children:[e.jsx(ve,{className:"h-3 w-3 shrink-0"}),l.address]})]})]});return N?e.jsxs(e.Fragment,{children:[O,e.jsx(oe,{open:s,onOpenChange:j,children:e.jsxs(de,{className:"flex flex-col",style:{height:f,maxHeight:f,transition:"height 0.15s ease-out, max-height 0.15s ease-out"},children:[e.jsx(me,{className:"pb-2 shrink-0",children:e.jsxs(ue,{children:[x("community.selectRestaurants","é€‰æ‹©é¤åŽ…"),i.length>0&&e.jsx(Z,{variant:"secondary",className:"ml-2",children:i.length})]})}),e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(F,{placeholder:x("community.searchRestaurant","æœç´¢é¤åŽ…..."),value:u,onChange:l=>y(l.target.value),className:"pl-9"})]})}),i.length>0&&e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:i.map(l=>{const g=o?.find(v=>v.id===l);return g?e.jsxs(Z,{variant:"secondary",className:"gap-1 pr-1",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:a(g,"name")}),e.jsx("button",{type:"button",className:"hover:bg-muted-foreground/20 rounded-full p-0.5",onClick:v=>{v.stopPropagation(),h(b=>b.filter(U=>U!==l))},children:e.jsx(G,{className:"h-3 w-3"})})]},l):null})})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 min-h-0",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[C.map(l=>e.jsx(V,{restaurant:l,isSelected:i.includes(l.id),onToggle:()=>A(l.id)},l.id)),C.length===0&&u&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:x("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤åŽ…")})]})}),e.jsx(Ie,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(L,{variant:"outline",className:"flex-1",onClick:()=>j(!1),children:x("common.cancel","å–æ¶ˆ")}),e.jsxs(L,{className:"flex-1",onClick:S,children:[x("community.confirmSelection","ç¡®è®¤é€‰æ‹©"),i.length>0&&` (${i.length})`]})]})})]})})]}):e.jsxs(pe,{open:s,onOpenChange:j,children:[e.jsx(he,{asChild:!0,children:O}),e.jsxs(xe,{className:"w-80 p-0",align:"start",children:[e.jsx("div",{className:"p-3 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(F,{placeholder:x("community.searchRestaurant","æœç´¢é¤åŽ…..."),value:u,onChange:l=>y(l.target.value),className:"pl-9"})]})}),t.length>0&&e.jsx("div",{className:"p-3 border-b",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.map(l=>{const g=o?.find(v=>v.id===l);return g?e.jsxs(Z,{variant:"secondary",className:"gap-1 pr-1",children:[e.jsx("span",{className:"truncate max-w-[100px]",children:a(g,"name")}),e.jsx("button",{type:"button",className:"hover:bg-muted-foreground/20 rounded-full p-0.5",onClick:v=>{v.stopPropagation(),I(l)},children:e.jsx(G,{className:"h-3 w-3"})})]},l):null})})}),e.jsxs("div",{className:"max-h-64 overflow-y-auto p-2",children:[C.map(l=>e.jsx(V,{restaurant:l,isSelected:t.includes(l.id),onToggle:()=>I(l.id)},l.id)),C.length===0&&u&&e.jsx("div",{className:"py-4 text-center text-muted-foreground text-sm",children:x("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤åŽ…")})]})]})]})},Re=m.forwardRef(({className:s,...c},t)=>e.jsx(M,{ref:t,className:P("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...c}));Re.displayName=M.displayName;const os=m.forwardRef(({className:s,...c},t)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(te,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(M.Input,{ref:t,className:P("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...c})]}));os.displayName=M.Input.displayName;const Ee=m.forwardRef(({className:s,...c},t)=>e.jsx(M.List,{ref:t,className:P("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...c}));Ee.displayName=M.List.displayName;const ds=m.forwardRef((s,c)=>e.jsx(M.Empty,{ref:c,className:"py-6 text-center text-sm",...s}));ds.displayName=M.Empty.displayName;const Ue=m.forwardRef(({className:s,...c},t)=>e.jsx(M.Group,{ref:t,className:P("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...c}));Ue.displayName=M.Group.displayName;const ms=m.forwardRef(({className:s,...c},t)=>e.jsx(M.Separator,{ref:t,className:P("-mx-1 h-px bg-border",s),...c}));ms.displayName=M.Separator.displayName;const ae=m.forwardRef(({className:s,...c},t)=>e.jsx(M.Item,{ref:t,className:P("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",s),...c}));ae.displayName=M.Item.displayName;const us=({open:s,onOpenChange:c,value:t,onSelect:n,activities:o})=>{const{t:d}=$(),{getLocalizedField:p}=ce(),x=ie(),[a,N]=m.useState(t),u=r=>{r&&N(t),c(r)},y=()=>{if(!t)return"";const r=o?.find(j=>j.id===t);return r?p(r,"title"):""},i=()=>{n(a),c(!1)},h=r=>{n(r),c(!1)},f=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>u(!0),children:[t?e.jsx("span",{className:"text-primary",children:y()}):e.jsx("span",{className:"text-muted-foreground",children:d("community.linkActivity","å…³è”æ´»åŠ¨")}),e.jsx(je,{className:"h-4 w-4 opacity-50"})]});return x?e.jsxs(e.Fragment,{children:[f,e.jsx(oe,{open:s,onOpenChange:u,children:e.jsxs(de,{className:"max-h-[85vh] flex flex-col",children:[e.jsx(me,{className:"pb-2",children:e.jsx(ue,{children:d("community.selectActivity","é€‰æ‹©æ´»åŠ¨")})}),e.jsx(ke,{className:"flex-1 px-4",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:P("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",a===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>N(""),children:[e.jsx(K,{className:P("h-4 w-4 shrink-0",a===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:d("community.noActivity","ä¸å…³è”æ´»åŠ¨")})]}),o.map(r=>e.jsxs("div",{className:P("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",a===r.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>N(r.id),children:[e.jsx(K,{className:P("h-4 w-4 shrink-0",a===r.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:p(r,"title")})]})]},r.id)),o.length===0&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:d("activities.noActivities","æš‚æ— å¯ç”¨æ´»åŠ¨")})]})}),e.jsx(Ie,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(L,{variant:"outline",className:"flex-1",onClick:()=>u(!1),children:d("common.cancel","å–æ¶ˆ")}),e.jsx(L,{className:"flex-1",onClick:i,children:d("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(pe,{open:s,onOpenChange:u,children:[e.jsx(he,{asChild:!0,children:f}),e.jsx(xe,{className:"w-72 p-0",align:"start",children:e.jsx(Re,{children:e.jsx(Ee,{children:e.jsxs(Ue,{children:[e.jsxs(ae,{value:"none",onSelect:()=>h(""),children:[e.jsx(K,{className:P("mr-2 h-4 w-4",t?"opacity-0":"opacity-100")}),d("community.noActivity","ä¸å…³è”æ´»åŠ¨")]}),o.map(r=>e.jsxs(ae,{value:r.id,onSelect:()=>h(r.id),children:[e.jsx(K,{className:P("mr-2 h-4 w-4",t===r.id?"opacity-100":"opacity-0")}),p(r,"title")]},r.id))]})})})})]})},fe=[{name:"smileys",emojis:["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ¤£","ðŸ˜‚","ðŸ™‚","ðŸ˜Š","ðŸ˜‡","ðŸ¥°","ðŸ˜","ðŸ¤©","ðŸ˜˜","ðŸ˜—","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ¤¥","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¥µ","ðŸ¥¶","ðŸ¥´","ðŸ˜µ","ðŸ¤¯","ðŸ¤ ","ðŸ¥³","ðŸ˜Ž","ðŸ¤“","ðŸ§"]},{name:"gestures",emojis:["ðŸ‘","ðŸ‘Ž","ðŸ‘Œ","ðŸ¤Œ","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ‘‡","â˜ï¸","âœ‹","ðŸ¤š","ðŸ–ï¸","ðŸ––","ðŸ‘‹","ðŸ¤","ðŸ™","ðŸ’ª","ðŸ¦¾","ðŸ¦¿","ðŸ¦µ","ðŸ¦¶","ðŸ‘‚","ðŸ¦»","ðŸ‘ƒ","ðŸ§ ","ðŸ‘€","ðŸ‘ï¸","ðŸ‘…","ðŸ‘„"]},{name:"food",emojis:["ðŸ","ðŸŽ","ðŸ","ðŸŠ","ðŸ‹","ðŸŒ","ðŸ‰","ðŸ‡","ðŸ“","ðŸ«","ðŸˆ","ðŸ’","ðŸ‘","ðŸ¥­","ðŸ","ðŸ¥¥","ðŸ¥","ðŸ…","ðŸ†","ðŸ¥‘","ðŸ¥¦","ðŸ¥¬","ðŸ¥’","ðŸŒ¶ï¸","ðŸ«‘","ðŸŒ½","ðŸ¥•","ðŸ§„","ðŸ§…","ðŸ¥”","ðŸ ","ðŸ¥","ðŸ¥¯","ðŸž","ðŸ¥–","ðŸ¥¨","ðŸ§€","ðŸ¥š","ðŸ³","ðŸ§ˆ","ðŸ¥ž","ðŸ§‡","ðŸ¥“","ðŸ¥©","ðŸ—","ðŸ–","ðŸ¦´","ðŸŒ­","ðŸ”","ðŸŸ","ðŸ•","ðŸ«“","ðŸ¥ª","ðŸ¥™","ðŸ§†","ðŸŒ®","ðŸŒ¯","ðŸ«”","ðŸ¥—","ðŸ¥˜","ðŸ«•","ðŸ¥«","ðŸ","ðŸœ","ðŸ²","ðŸ›","ðŸ£","ðŸ±","ðŸ¥Ÿ","ðŸ¦ª","ðŸ¤","ðŸ™","ðŸš","ðŸ˜","ðŸ¥","ðŸ¥ ","ðŸ¥®","ðŸ¢","ðŸ¡","ðŸ§","ðŸ¨","ðŸ¦","ðŸ¥§","ðŸ§","ðŸ°","ðŸŽ‚","ðŸ®","ðŸ­","ðŸ¬","ðŸ«","ðŸ¿","ðŸ©","ðŸª"]},{name:"hearts",emojis:["â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ","â™¥ï¸"]},{name:"objects",emojis:["â­","ðŸŒŸ","âœ¨","ðŸ’«","ðŸ”¥","ðŸ’¯","ðŸŽ‰","ðŸŽŠ","ðŸŽˆ","ðŸŽ","ðŸ†","ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰","âš½","ðŸ€","ðŸˆ","âš¾","ðŸŽ¾","ðŸ","ðŸŽ±","ðŸ“","ðŸŽ®","ðŸŽ²","ðŸ§©","ðŸŽ­","ðŸŽ¨","ðŸŽ¬","ðŸŽ¤","ðŸŽ§","ðŸŽµ","ðŸŽ¶","ðŸŽ¹","ðŸŽ¸","ðŸŽº","ðŸŽ»","ðŸ“·","ðŸ“¸","ðŸ“¹","ðŸŽ¥","ðŸ“±","ðŸ’»","âŒ¨ï¸","ðŸ–¥ï¸","ðŸ“º","ðŸ“»","â°","âŒš","ðŸ’¡","ðŸ”¦","ðŸ“š","ðŸ“–","âœï¸","ðŸ“","ðŸ’°","ðŸ’µ","ðŸ’´","ðŸ’¶","ðŸ’·","ðŸ’³","ðŸ›’","ðŸŽ€","ðŸŽ—ï¸"]},{name:"nature",emojis:["ðŸŒ¸","ðŸ’®","ðŸµï¸","ðŸŒ¹","ðŸ¥€","ðŸŒº","ðŸŒ»","ðŸŒ¼","ðŸŒ·","ðŸŒ±","ðŸª´","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŒµ","ðŸŒ¾","ðŸŒ¿","â˜˜ï¸","ðŸ€","ðŸ","ðŸ‚","ðŸƒ","ðŸŒ","ðŸŒŽ","ðŸŒ","ðŸŒ™","â­","â˜€ï¸","ðŸŒ¤ï¸","â›…","ðŸŒ¥ï¸","â˜ï¸","ðŸŒ¦ï¸","ðŸŒ§ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","â˜ƒï¸","â›„","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒŠ","ðŸ’§","ðŸ’¦","â˜”","ðŸŒˆ"]}],ps=({onSelect:s})=>{const{t:c}=$(),t=ie(),[n,o]=m.useState(!1),[d,p]=m.useState(0),x=y=>{s(y),t||o(!1)},a={smileys:c("emoji.smileys","è¡¨æƒ…"),gestures:c("emoji.gestures","æ‰‹åŠ¿"),food:c("emoji.food","ç¾Žé£Ÿ"),hearts:c("emoji.hearts","çˆ±å¿ƒ"),objects:c("emoji.objects","ç‰©å“"),nature:c("emoji.nature","è‡ªç„¶")},N=e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 border-b",children:fe.map((y,i)=>e.jsx("button",{type:"button",onClick:()=>p(i),className:`px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors ${d===i?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-muted-foreground"}`,children:a[y.name]},y.name))}),e.jsx("div",{className:"grid grid-cols-8 gap-1",children:fe[d].emojis.map((y,i)=>e.jsx("button",{type:"button",onClick:()=>x(y),className:"w-9 h-9 flex items-center justify-center text-xl hover:bg-muted rounded-md transition-colors",children:y},i))})]}),u=e.jsxs("button",{type:"button",onClick:()=>o(!0),className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(Le,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:c("community.emoji","è¡¨æƒ…")})]});return t?e.jsxs(e.Fragment,{children:[u,e.jsx(oe,{open:n,onOpenChange:o,children:e.jsxs(de,{className:"h-[50vh]",children:[e.jsx(me,{className:"pb-2",children:e.jsx(ue,{children:c("emoji.title","é€‰æ‹©è¡¨æƒ…")})}),e.jsx(ke,{className:"flex-1 px-4 pb-4",children:N})]})})]}):e.jsxs(pe,{open:n,onOpenChange:o,children:[e.jsx(he,{asChild:!0,children:u}),e.jsx(xe,{className:"w-80 p-3",align:"start",side:"top",children:N})]})},Us=({post:s,open:c,onOpenChange:t})=>{const{t:n}=$();ce();const o=ss(),{data:d}=ts(),{data:p}=rs(),{isMerchant:x,isAdmin:a,isSupervisor:N}=We(),u=!x&&!N&&!a,[y,i]=m.useState(s.content),[h,f]=m.useState(s.image_urls||[]),[r,j]=m.useState(s.video_url||null),[C,A]=m.useState(s.activity_id||""),[S,I]=m.useState(s.restaurants?.map(w=>w.id)||(s.restaurant?[s.restaurant.id]:[])),[D,E]=m.useState(!1),[Q,O]=m.useState(!1),[V,l]=m.useState(!1),[g,v]=m.useState(!1),b=m.useRef(null),U=m.useRef(null);m.useEffect(()=>{c&&(i(s.content),f(s.image_urls||[]),j(s.video_url||null),A(s.activity_id||""),I(s.restaurants?.map(w=>w.id)||(s.restaurant?[s.restaurant.id]:[])))},[c,s]);const ee=d?.filter(w=>w.status==="published")||[],z=async w=>{const _=w.target.files;if(!(!_||_.length===0)){if(h.length+_.length>9){k.error(n("community.maxImages","æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡"));return}E(!0);try{const{data:{user:q}}=await R.auth.getUser();if(!q)throw new Error("Not authenticated");const H=[];for(const B of Array.from(_)){const X=B.name.split(".").pop(),Y=`${q.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${X}`,{error:ge}=await R.storage.from("community-posts").upload(Y,B);if(ge)throw ge;const{data:{publicUrl:Fe}}=R.storage.from("community-posts").getPublicUrl(Y);H.push(Fe)}f(B=>[...B,...H])}catch(q){console.error("Upload error:",q),k.error(n("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{E(!1),b.current&&(b.current.value="")}}},se=async w=>{const _=w.target.files?.[0];if(_){if(_.size>100*1024*1024){k.error(n("community.videoTooLarge","è§†é¢‘ä¸èƒ½è¶…è¿‡100MB"));return}E(!0);try{const{data:{user:q}}=await R.auth.getUser();if(!q)throw new Error("Not authenticated");const H=_.name.split(".").pop(),B=`${q.id}/${Date.now()}.${H}`,{error:X}=await R.storage.from("community-posts").upload(B,_);if(X)throw X;const{data:{publicUrl:Y}}=R.storage.from("community-posts").getPublicUrl(B);j(Y)}catch(q){console.error("Upload error:",q),k.error(n("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{E(!1),U.current&&(U.current.value="")}}},Pe=w=>{f(_=>_.filter((q,H)=>H!==w))},Me=()=>{j(null)},Te=async()=>{if(v(!1),!y.trim()){k.error(n("community.contentRequired","è¯·è¾“å…¥å†…å®¹"));return}if(u&&S.length===0){v(!0),k.error(n("community.restaurantRequired","è¯·é€‰æ‹©é¤åŽ…"));return}await o.mutateAsync({id:s.id,content:y,image_urls:h,video_url:r,activity_id:C||null,restaurant_ids:S.length>0?S:void 0}),t(!1)};return e.jsx(Ce,{open:c,onOpenChange:t,children:e.jsxs(Se,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(ye,{children:e.jsx(_e,{children:n("community.editPost","ç¼–è¾‘å¸–å­")})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>t(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(re,{className:"h-5 w-5"})}),e.jsx("span",{className:"font-medium text-sm",children:n("community.editPost","ç¼–è¾‘å¸–å­")}),e.jsxs(L,{size:"sm",onClick:Te,disabled:o.isPending||!y.trim(),className:"rounded-full px-6",children:[o.isPending&&e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}),n("community.resubmit","é‡æ–°æäº¤")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[e.jsx("div",{className:"px-3 py-2 bg-amber-500/10 border border-amber-500/30 rounded-md text-sm text-amber-700 dark:text-amber-400",children:n("community.editNotice","ç¼–è¾‘åŽå¸–å­å°†é‡æ–°æäº¤å®¡æ ¸")}),e.jsx(le,{value:y,onChange:w=>i(w.target.value),placeholder:n("community.contentPlaceholder","åˆ†äº«ä½ çš„æƒ³æ³•..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base whitespace-pre-wrap"}),h.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:h.map((w,_)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:w,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>Pe(_),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-3 w-3"})})]},_))}),r&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:r,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:Me,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-2 pb-0 bg-background shrink-0 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:`flex items-center gap-3 ${g&&u&&S.length===0?"text-destructive":""}`,children:[e.jsx(ve,{className:`h-5 w-5 shrink-0 ${g&&u&&S.length===0?"text-destructive":"text-muted-foreground"}`}),x?e.jsx("span",{className:"text-sm text-muted-foreground",children:S.length>0?n("community.restaurantSelected","å·²é€‰æ‹©é¤åŽ…"):n("community.noRestaurant","æœªå…³è”é¤åŽ…")}):e.jsx(cs,{open:Q,onOpenChange:w=>{O(w),w&&v(!1)},value:S,onSelect:w=>{I(w),v(!1)},restaurants:p||[],required:u})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ne,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(us,{open:V,onOpenChange:l,value:C,onSelect:A,activities:ee})]})]}),g&&u&&S.length===0&&e.jsx("p",{className:"text-xs text-destructive pl-8",children:n("community.restaurantRequired","è¯·é€‰æ‹©é¤åŽ…")})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 pt-0 py-2 pb-[max(2rem,calc(env(safe-area-inset-bottom)+1rem))] bg-background shrink-0",children:[e.jsx("input",{ref:b,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:z}),e.jsx("input",{ref:U,type:"file",accept:"video/*",className:"hidden",onChange:se}),e.jsxs("button",{type:"button",onClick:()=>b.current?.click(),disabled:D||h.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(ne,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:n("community.photo","ç…§ç‰‡")})]}),e.jsxs("button",{type:"button",onClick:()=>U.current?.click(),disabled:D||!!r,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Ae,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:n("community.video","è§†é¢‘")})]}),e.jsx(ps,{onSelect:w=>i(_=>_+w)}),D&&e.jsx(W,{className:"h-5 w-5 animate-spin ml-auto"})]})]})})},hs=[{value:"easy",labelKey:"recipe.difficulty.easy"},{value:"medium",labelKey:"recipe.difficulty.medium"},{value:"hard",labelKey:"recipe.difficulty.hard"}],xs=["g","kg","ml","L","tsp","tbsp","cup","piece","slice","clove","pinch"],gs=({data:s,coverImage:c,nutrition:t,introduction:n,onDataChange:o,onCoverImageChange:d,onNutritionChange:p,onIntroductionChange:x})=>{const{t:a}=$(),N=m.useRef(null),[u,y]=m.useState(!!(t.calories||t.protein||t.carbs||t.fat)),[i,h]=m.useState(!1),f=async r=>{const j=r.target.files?.[0];if(j){if(j.size>5*1024*1024){k.error(a("common.imageTooLarge","å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB"));return}h(!0);try{const{data:{user:C}}=await R.auth.getUser();if(!C)throw new Error("Not authenticated");const A=j.name.split(".").pop(),S=`${C.id}/${Date.now()}-recipe-cover.${A}`,{error:I}=await R.storage.from("community-posts").upload(S,j);if(I)throw I;const{data:{publicUrl:D}}=R.storage.from("community-posts").getPublicUrl(S);d(D)}catch(C){console.error("Upload error:",C),k.error(a("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{h(!1),N.current&&(N.current.value="")}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:a("recipe.coverImage","å°é¢å›¾ç‰‡")}),e.jsx("input",{ref:N,type:"file",accept:"image/*",className:"hidden",onChange:f}),c?e.jsxs("div",{className:"relative aspect-video rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:c,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>d(null),className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-4 w-4"})})]}):e.jsx("button",{type:"button",onClick:()=>N.current?.click(),disabled:i,className:"w-full aspect-video rounded-lg border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-2 text-muted-foreground hover:border-primary hover:text-primary transition-colors",children:i?e.jsx(W,{className:"h-8 w-8 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-8 w-8"}),e.jsx("span",{className:"text-sm",children:a("recipe.addCoverImage","æ·»åŠ å°é¢å›¾ç‰‡")})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{htmlFor:"recipe-name",children:[a("recipe.name","é£Ÿè°±åç§°")," *"]}),e.jsx(F,{id:"recipe-name",value:s.recipe_name||"",onChange:r=>o({...s,recipe_name:r.target.value}),placeholder:a("recipe.namePlaceholder","å¦‚ï¼šçº¢çƒ§è‚‰ã€ç•ªèŒ„ç‚’è›‹")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{htmlFor:"subtitle",children:[a("recipe.subtitle","å‰¯æ ‡é¢˜"),e.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["(",a("common.optional","å¯é€‰"),")"]})]}),e.jsx(F,{id:"subtitle",value:s.subtitle||"",onChange:r=>o({...s,subtitle:r.target.value}),placeholder:a("recipe.subtitlePlaceholder","ä¸€å¥è¯æè¿°è¿™é“èœçš„ç¾Žé£Ÿå“²å­¦æˆ–çµé­‚")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{htmlFor:"introduction",children:[e.jsx(De,{className:"h-4 w-4 inline mr-1"}),a("recipe.introduction","ç¾Žé£Ÿä»‹ç»")]}),e.jsx(le,{id:"introduction",value:n,onChange:r=>x(r.target.value),placeholder:a("recipe.introductionPlaceholder","ä»‹ç»è¿™é“ç¾Žé£Ÿçš„ç‰¹è‰²ã€å£æ„Ÿã€æ¥æºæ•…äº‹ç­‰..."),rows:Math.max(3,Math.min(12,(n?.split(`
`).length||1)+1)),className:"resize-y min-h-[80px]"}),n&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[n.length," ",a("common.characters","å­—")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{htmlFor:"cook-time",children:[e.jsx(qe,{className:"h-4 w-4 inline mr-1"}),a("recipe.cookTime","çƒ¹é¥ªæ—¶é—´")," *"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{id:"cook-time",type:"number",min:1,value:s.cook_time||"",onChange:r=>o({...s,cook_time:parseInt(r.target.value)||0}),placeholder:"30",className:"w-24"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:a("recipe.minutes","åˆ†é’Ÿ")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{children:[e.jsx($e,{className:"h-4 w-4 inline mr-1"}),a("recipe.difficulty","éš¾åº¦")," *"]}),e.jsxs(Xe,{value:s.difficulty||"",onValueChange:r=>o({...s,difficulty:r}),children:[e.jsx(Ye,{children:e.jsx(Ze,{placeholder:a("recipe.selectDifficulty","é€‰æ‹©éš¾åº¦")})}),e.jsx(Je,{children:hs.map(r=>e.jsx(es,{value:r.value,children:a(r.labelKey,r.value)},r.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(T,{htmlFor:"servings",children:[e.jsx(ze,{className:"h-4 w-4 inline mr-1"}),a("recipe.servings","ä»½é‡")," *"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{id:"servings",type:"number",min:1,value:s.servings||"",onChange:r=>o({...s,servings:parseInt(r.target.value)||0}),placeholder:"2",className:"w-24"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:a("recipe.people","äººä»½")})]})]}),e.jsxs(ns,{open:u,onOpenChange:y,children:[e.jsx(is,{asChild:!0,children:e.jsxs(L,{variant:"ghost",type:"button",className:"w-full justify-between px-0 hover:bg-transparent",children:[e.jsxs("span",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Be,{className:"h-4 w-4"}),a("recipe.nutritionInfo","è¥å…»ä¿¡æ¯"),e.jsxs("span",{className:"text-xs text-muted-foreground font-normal",children:["(",a("common.optional","å¯é€‰"),")"]})]}),u?e.jsx(Oe,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})]})}),e.jsx(ls,{className:"space-y-4 pt-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(T,{htmlFor:"calories",className:"text-xs",children:a("recipe.calories","å¡è·¯é‡Œ")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{id:"calories",type:"number",min:0,value:t.calories||"",onChange:r=>p({...t,calories:parseInt(r.target.value)||void 0}),placeholder:"300",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"kcal"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(T,{htmlFor:"protein",className:"text-xs",children:a("recipe.protein","è›‹ç™½è´¨")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{id:"protein",type:"number",min:0,value:t.protein||"",onChange:r=>p({...t,protein:parseInt(r.target.value)||void 0}),placeholder:"20",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"g"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(T,{htmlFor:"carbs",className:"text-xs",children:a("recipe.carbs","ç¢³æ°´")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{id:"carbs",type:"number",min:0,value:t.carbs||"",onChange:r=>p({...t,carbs:parseInt(r.target.value)||void 0}),placeholder:"30",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"g"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(T,{htmlFor:"fat",className:"text-xs",children:a("recipe.fat","è„‚è‚ª")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{id:"fat",type:"number",min:0,value:t.fat||"",onChange:r=>p({...t,fat:parseInt(r.target.value)||void 0}),placeholder:"10",className:"h-8"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"g"})]})]})]})})]})]})},fs=({ingredients:s,onChange:c})=>{const{t}=$(),n=()=>{c([...s,{name:"",amount:"",unit:""}])},o=(p,x,a)=>{const N=[...s];N[p]={...N[p],[x]:a},c(N)},d=p=>{c(s.filter((x,a)=>a!==p))};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(T,{className:"text-base font-medium",children:[t("recipe.ingredients","é…æ–™")," *"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[s.filter(p=>p.name).length," ",t("recipe.items","é¡¹")]})]}),e.jsx("div",{className:"space-y-3",children:s.map((p,x)=>e.jsx("div",{className:"space-y-1.5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(F,{value:p.name,onChange:a=>o(x,"name",a.target.value),placeholder:t("recipe.ingredientName","é…æ–™åç§°")})}),e.jsx("div",{className:"w-20",children:e.jsx(F,{value:p.amount,onChange:a=>o(x,"amount",a.target.value),placeholder:t("recipe.amount","é‡")})}),e.jsxs("div",{className:"w-20",children:[e.jsx(F,{value:p.unit,onChange:a=>o(x,"unit",a.target.value),placeholder:t("recipe.unit","å•ä½"),list:"common-units"}),e.jsx("datalist",{id:"common-units",children:xs.map(a=>e.jsx("option",{value:a},a))})]}),e.jsx(L,{type:"button",variant:"ghost",size:"icon",onClick:()=>d(x),disabled:s.length===1,className:"shrink-0",children:e.jsx(be,{className:"h-4 w-4 text-destructive"})})]})},x))}),e.jsxs(L,{type:"button",variant:"outline",onClick:n,className:"w-full",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),t("recipe.addIngredient","æ·»åŠ é…æ–™")]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.unitsHint","å¸¸ç”¨å•ä½ï¼šg, kg, ml, L, å‹º, æ¯, ä¸ª, ç‰‡, é€‚é‡")})]})},J=3,js=({steps:s,onChange:c})=>{const{t}=$(),[n,o]=m.useState(null),d=m.useRef([]),p=i=>i.image_urls&&i.image_urls.length>0?i.image_urls:i.image_url?[i.image_url]:[],x=()=>{const i=s.length+1;c([...s,{order:i,description:"",image_urls:[]}])},a=(i,h,f)=>{const r=[...s];r[i]={...r[i],[h]:f},c(r)},N=i=>{const h=s.filter((f,r)=>r!==i).map((f,r)=>({...f,order:r+1}));c(h)},u=(i,h)=>{const r=p(s[i]).filter((j,C)=>C!==h);a(i,"image_urls",r),a(i,"image_url",void 0)},y=async(i,h)=>{const f=h.target.files?.[0];if(!f)return;const r=p(s[i]);if(r.length>=J){k.error(t("recipe.maxStepImages","æ¯ä¸ªæ­¥éª¤æœ€å¤šä¸Šä¼ {{max}}å¼ å›¾ç‰‡",{max:J}));return}if(f.size>5*1024*1024){k.error(t("common.imageTooLarge","å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB"));return}o(i);try{const{data:{user:j}}=await R.auth.getUser();if(!j)throw new Error("Not authenticated");const C=f.name.split(".").pop(),A=`${j.id}/${Date.now()}-step-${i}.${C}`,{error:S}=await R.storage.from("community-posts").upload(A,f);if(S)throw S;const{data:{publicUrl:I}}=R.storage.from("community-posts").getPublicUrl(A),D=[...r,I],E=[...s];E[i]={...E[i],image_urls:D,image_url:void 0},c(E)}catch(j){console.error("Upload error:",j),k.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{o(null),d.current[i]&&(d.current[i].value="")}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(T,{className:"text-base font-medium",children:[t("recipe.steps","çƒ¹é¥ªæ­¥éª¤")," *"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[s.filter(i=>i.description).length," ",t("recipe.stepsCount","æ­¥")]})]}),e.jsx("div",{className:"space-y-4",children:s.map((i,h)=>{const f=p(i);return e.jsxs("div",{className:"p-4 border rounded-lg space-y-3 bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-primary",children:t("recipe.stepNumber","ç¬¬{{n}}æ­¥",{n:h+1})})]}),e.jsx(L,{type:"button",variant:"ghost",size:"icon",onClick:()=>N(h),disabled:s.length===1,children:e.jsx(be,{className:"h-4 w-4 text-destructive"})})]}),e.jsx(le,{value:i.description,onChange:r=>a(h,"description",r.target.value),placeholder:t("recipe.stepDescriptionPlaceholder","æè¿°è¿™ä¸€æ­¥çš„æ“ä½œ..."),className:"min-h-[80px]"}),e.jsxs("div",{children:[e.jsx("input",{ref:r=>d.current[h]=r,type:"file",accept:"image/*",className:"hidden",onChange:r=>y(h,r)}),f.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:f.map((r,j)=>e.jsxs("div",{className:"relative w-24 h-20 rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:r,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>u(h,j),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(G,{className:"h-3 w-3"})})]},j))}),f.length<J&&e.jsxs("button",{type:"button",onClick:()=>d.current[h]?.click(),disabled:n===h,className:"flex items-center gap-2 text-sm text-muted-foreground hover:text-primary transition-colors",children:[n===h?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(ne,{className:"h-4 w-4"}),e.jsx("span",{children:f.length===0?t("recipe.addStepImage","æ·»åŠ æ­¥éª¤å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰"):t("recipe.addMoreImages","ç»§ç»­æ·»åŠ  ({{current}}/{{max}})",{current:f.length,max:J})})]})]})]},h)})}),e.jsxs(L,{type:"button",variant:"outline",onClick:x,className:"w-full",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),t("recipe.addStep","æ·»åŠ æ­¥éª¤")]})]})},vs=()=>{const s=Ke(),{t:c}=$();return Ge({mutationFn:async t=>{const{data:{user:n}}=await R.auth.getUser();if(!n)throw new Error("Not authenticated");const o=t.introduction||"",d=[];t.cover_image&&d.push(t.cover_image),t.steps.forEach(a=>{a.image_urls&&a.image_urls.length>0?a.image_urls.forEach(N=>d.push(N)):a.image_url&&d.push(a.image_url)});const{data:p,error:x}=await R.from("community_posts").update({content:o,image_urls:d,recipe_name:t.recipe_name,cook_time:t.cook_time,difficulty:t.difficulty,servings:t.servings,ingredients:t.ingredients,steps:t.steps,nutrition:t.nutrition?t.nutrition:null,recipe_tags:t.recipe_tags||null,recipe_category:t.recipe_category||null,status:"pending",moderation_status:"pending",risk_score:null,risk_reasons:null,ai_reviewed_at:null}).eq("id",t.id).eq("author_id",n.id).select().single();if(x)throw x;try{await R.functions.invoke("moderate-post",{body:{post_id:p.id,content:o,user_id:n.id,image_urls:d}})}catch(a){console.error("Moderation call failed:",a)}return p},onSuccess:()=>{s.invalidateQueries({queryKey:["community-posts"]}),s.invalidateQueries({queryKey:["community-post"]}),s.invalidateQueries({queryKey:["admin-community-posts"]}),s.invalidateQueries({queryKey:["has-posted-today"]}),k.success(c("recipe.editSuccess","é£Ÿè°±å·²æ›´æ–°ï¼Œç­‰å¾…å®¡æ ¸"))},onError:t=>{console.error("Edit recipe error:",t),k.error(c("recipe.editError","ç¼–è¾‘å¤±è´¥"))}})},Ns=({post:s,onClose:c,onSuccess:t})=>{const{t:n}=$(),o=vs(),[d,p]=m.useState(0),x=()=>!s.image_urls||s.image_urls.length===0?null:s.image_urls[0]||null,[a,N]=m.useState(x()),[u,y]=m.useState({recipe_name:s.recipe_name||"",cook_time:s.cook_time||void 0,difficulty:s.difficulty||void 0,servings:s.servings||void 0}),[i,h]=m.useState(s.ingredients&&s.ingredients.length>0?s.ingredients:[{name:"",amount:"",unit:""}]),[f,r]=m.useState(s.steps&&s.steps.length>0?s.steps:[{order:1,description:""}]),[j,C]=m.useState(s.nutrition||{}),[A,S]=m.useState(s.content||""),I=[{key:"basic",title:n("recipe.step.basic","åŸºæœ¬ä¿¡æ¯")},{key:"ingredients",title:n("recipe.step.ingredients","é…æ–™")},{key:"steps",title:n("recipe.step.steps","æ­¥éª¤")}],D=(d+1)/I.length*100,E=()=>u.recipe_name?.trim()?!u.cook_time||u.cook_time<1?(k.error(n("recipe.cookTimeRequired","è¯·è¾“å…¥çƒ¹é¥ªæ—¶é—´")),!1):u.difficulty?!u.servings||u.servings<1?(k.error(n("recipe.servingsRequired","è¯·è¾“å…¥ä»½é‡")),!1):!0:(k.error(n("recipe.difficultyRequired","è¯·é€‰æ‹©éš¾åº¦")),!1):(k.error(n("recipe.nameRequired","è¯·è¾“å…¥é£Ÿè°±åç§°")),!1),Q=()=>i.filter(U=>U.name.trim()).length===0?(k.error(n("recipe.ingredientsRequired","è¯·è‡³å°‘æ·»åŠ ä¸€ç§é…æ–™")),!1):!0,O=()=>f.filter(U=>U.description.trim()).length===0?(k.error(n("recipe.stepsRequired","è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ­¥éª¤")),!1):!0,V=()=>{d===0&&!E()||d===1&&!Q()||p(b=>Math.min(b+1,I.length-1))},l=()=>{p(b=>Math.max(b-1,0))},g=async()=>{if(!O())return;const b=i.filter(z=>z.name.trim()),U=f.filter(z=>z.description.trim()).map((z,se)=>({...z,order:se+1})),ee=j.calories||j.protein||j.carbs||j.fat;try{await o.mutateAsync({id:s.id,recipe_name:u.recipe_name,cook_time:u.cook_time,difficulty:u.difficulty,servings:u.servings,ingredients:b,steps:U,cover_image:a,nutrition:ee?j:void 0,introduction:A.trim()||void 0}),t()}catch{}},v=()=>{switch(d){case 0:return e.jsx(gs,{data:u,coverImage:a,nutrition:j,introduction:A,onDataChange:y,onCoverImageChange:N,onNutritionChange:C,onIntroductionChange:S});case 1:return e.jsx(fs,{ingredients:i,onChange:h});case 2:return e.jsx(js,{steps:f,onChange:r});default:return null}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-background shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("button",{type:"button",onClick:c,className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(re,{className:"h-5 w-5"})}),e.jsx("h2",{className:"font-medium",children:n("recipe.editTitle","ç¼–è¾‘é£Ÿè°±")}),e.jsx("div",{className:"w-6"})]}),e.jsx("div",{className:"px-3 py-2 mb-3 bg-amber-500/10 border border-amber-500/30 rounded-md text-xs text-amber-700 dark:text-amber-400",children:n("community.editNotice","ç¼–è¾‘åŽå¸–å­å°†é‡æ–°æäº¤å®¡æ ¸")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(as,{value:D,className:"h-1"}),e.jsx("div",{className:"flex justify-between text-xs text-muted-foreground",children:I.map((b,U)=>e.jsx("span",{className:U===d?"text-primary font-medium":"",children:b.title},b.key))})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:v()}),e.jsx("div",{className:"px-4 py-3 pb-[max(1rem,env(safe-area-inset-bottom))] border-t bg-background shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[d>0&&e.jsxs(L,{type:"button",variant:"outline",onClick:l,className:"flex-1",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),n("common.back","ä¸Šä¸€æ­¥")]}),d<I.length-1?e.jsxs(L,{type:"button",onClick:V,className:"flex-1",children:[n("common.next","ä¸‹ä¸€æ­¥"),e.jsx(Qe,{className:"h-4 w-4 ml-2"})]}):e.jsxs(L,{type:"button",onClick:g,disabled:o.isPending,className:"flex-1",children:[o.isPending?e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(K,{className:"h-4 w-4 mr-2"}),n("recipe.resubmit","é‡æ–°æäº¤")]})]})})]})},Ps=({post:s,open:c,onOpenChange:t})=>{const{t:n}=$();return e.jsx(Ce,{open:c,onOpenChange:t,children:e.jsxs(Se,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(ye,{children:e.jsx(_e,{children:n("recipe.editTitle","ç¼–è¾‘é£Ÿè°±")})}),e.jsx(Ns,{post:s,onClose:()=>t(!1),onSuccess:()=>t(!1)})]})})};export{us as A,Ps as E,cs as M,js as R,Us as a,fs as b,gs as c,ps as d};
//# sourceMappingURL=EditRecipeDialog-Cz0bhn8M.js.map
