import{j as s}from"./vendor-ui-DAmPMpEA.js";import{r as d}from"./vendor-react-iAJ0IrSD.js";import{n as V,B as C,C as j,k as N,I as P,a1 as _,s as b}from"./index-Do1W_89N.js";import{n as $}from"./useAdmin-Cqjt-KAT.js";import{u as H}from"./useLocalizedContent-tJ7i_ycU.js";import{u as J,b as R}from"./vendor-query-BlSVl3IQ.js";import{u as W,P as X,a as Y,b as l,c as Z,d as ee,f as se}from"./usePagination-DzBUX65H.js";import{u as te}from"./vendor-i18n-DxKeo2S1.js";import{S as k}from"./save-Dtf4njxK.js";import{S as ae}from"./search-DsePuv7P.js";import{S as ne}from"./star-DGsfeJZk.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-KNAP0qdW.js";import"./chevron-left-BcmQFin1.js";import"./ellipsis-BlUeEC9G.js";const ve=()=>{const{t:n}=te(),{toast:m}=V(),c=J(),{data:u,isLoading:L}=$(),{getLocalizedField:x}=H(),[r,q]=d.useState(""),[i,h]=d.useState({}),[E,v]=d.useState(new Set),Q=d.useMemo(()=>u?u.filter(e=>r===""||x(e,"name").toString().toLowerCase().includes(r.toLowerCase())||e.address.toLowerCase().includes(r.toLowerCase())):[],[u,r,x]),{currentPage:o,totalPages:g,paginatedData:F,goToPage:K,nextPage:A,previousPage:I,canGoNext:T,canGoPrevious:z,startIndex:M,endIndex:O,totalItems:B}=W({data:Q,itemsPerPage:20}),y=R({mutationFn:async({restaurantId:e,rating:t})=>{const{error:a}=await b.from("restaurants").update({rating:t}).eq("id",e);if(a)throw a;return e},onSuccess:e=>{c.invalidateQueries({queryKey:["admin-restaurants"]}),c.invalidateQueries({queryKey:["restaurants"]}),v(t=>new Set([...t,e])),h(t=>{const a={...t};return delete a[e],a}),setTimeout(()=>{v(t=>{const a=new Set(t);return a.delete(e),a})},2e3)},onError:e=>{m({title:n("common.error"),description:e.message,variant:"destructive"})}}),w=R({mutationFn:async()=>{const e=Object.entries(i).map(([t,a])=>({id:t,rating:parseFloat(a)||0}));for(const t of e){const{error:a}=await b.from("restaurants").update({rating:t.rating}).eq("id",t.id);if(a)throw a}return e.length},onSuccess:e=>{c.invalidateQueries({queryKey:["admin-restaurants"]}),c.invalidateQueries({queryKey:["restaurants"]}),h({}),m({title:n("common.success"),description:n("admin.ratings.updated",{count:e})})},onError:e=>{m({title:n("common.error"),description:e.message,variant:"destructive"})}}),G=(e,t)=>{if(t===""||/^\d*\.?\d*$/.test(t)){const a=parseFloat(t);(t===""||a>=0&&a<=5)&&h(p=>({...p,[e]:t}))}},S=e=>{const t=parseFloat(i[e]||"0");t>=0&&t<=5&&y.mutate({restaurantId:e,rating:t})},U=(e,t)=>{e.key==="Enter"&&S(t)},D=Object.keys(i).length>0;return L?s.jsx("div",{className:"text-center",children:n("common.loading")}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl md:text-3xl font-bold mb-2",children:n("admin.ratings.title")}),s.jsx("p",{className:"text-muted-foreground",children:n("admin.ratings.description")})]}),D&&s.jsxs(C,{onClick:()=>w.mutate(),disabled:w.isPending,children:[s.jsx(k,{className:"mr-2 h-4 w-4"}),n("admin.ratings.saveAll")," (",Object.keys(i).length,")"]})]}),s.jsx(j,{children:s.jsx(N,{className:"pt-6",children:s.jsxs("div",{className:"relative max-w-md",children:[s.jsx(ae,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(P,{placeholder:n("admin.ratings.searchPlaceholder"),value:r,onChange:e=>q(e.target.value),className:"pl-9"})]})})}),s.jsx(j,{className:"bg-muted/50",children:s.jsx(N,{className:"pt-6",children:s.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[s.jsxs("p",{children:["• ",n("admin.ratings.instruction1")]}),s.jsxs("p",{children:["• ",n("admin.ratings.instruction2")]}),s.jsxs("p",{children:["• ",n("admin.ratings.instruction3")]})]})})}),s.jsx("div",{className:"flex items-center justify-between pb-2 border-b",children:s.jsx("span",{className:"text-sm text-muted-foreground",children:n("admin.ratings.showing",{start:M,end:O,total:B})})}),s.jsx("div",{className:"grid gap-3",children:F?.map(e=>{const t=i[e.id]??(e.rating?.toString()||"0"),a=e.id in i,p=E.has(e.id);return s.jsx(j,{className:a?"border-primary/50":"",children:s.jsx(N,{className:"py-4",children:s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("h3",{className:"font-medium truncate",children:x(e,"name")}),p&&s.jsxs("span",{className:"flex items-center text-green-600 text-sm",children:[s.jsx(_,{className:"h-4 w-4 mr-1"}),n("admin.ratings.saved")]})]}),s.jsx("p",{className:"text-sm text-muted-foreground truncate",children:e.address})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[s.jsx(ne,{className:"h-4 w-4 fill-accent text-accent"}),s.jsx("span",{className:"text-sm",children:n("admin.ratings.current")}),s.jsx("span",{className:"font-medium",children:e.rating||0})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(P,{type:"text",inputMode:"decimal",value:t,onChange:f=>G(e.id,f.target.value),onKeyPress:f=>U(f,e.id),className:"w-20 text-center",placeholder:"0-5"}),s.jsx(C,{size:"sm",variant:a?"default":"outline",onClick:()=>S(e.id),disabled:!a||y.isPending,children:s.jsx(k,{className:"h-4 w-4"})})]})]})]})})},e.id)})}),g>1&&s.jsx(X,{className:"mt-6",children:s.jsxs(Y,{children:[s.jsx(l,{children:s.jsx(Z,{onClick:I,className:z?"cursor-pointer":"pointer-events-none opacity-50"})}),Array.from({length:g},(e,t)=>t+1).map(e=>e===1||e===g||e>=o-1&&e<=o+1?s.jsx(l,{children:s.jsx(ee,{onClick:()=>K(e),isActive:o===e,className:"cursor-pointer",children:e})},e):e===o-2||e===o+2?s.jsx(l,{children:"..."},e):null),s.jsx(l,{children:s.jsx(se,{onClick:A,className:T?"cursor-pointer":"pointer-events-none opacity-50"})})]})})]})};export{ve as default};
//# sourceMappingURL=AdminRatings-DQCIZcEE.js.map
