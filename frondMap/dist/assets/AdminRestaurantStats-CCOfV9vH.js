import{j as e}from"./vendor-ui-DAmPMpEA.js";import{j as U,r as W,L as _}from"./vendor-react-iAJ0IrSD.js";import{ax as T,h as z,B as b,g as Z,f as O,a6 as J,a7 as ee,a8 as se,a9 as ae,aa as D,C as o,j as m,i as C,t as S,ac as B,Y as V,Z as Y,_ as P,q as X,s as p}from"./index-BcrfGQEh.js";import{d as te}from"./useRestaurants-Bz5Pv7_Q.js";import{u as re}from"./useLocalizedContent-tJ7i_ycU.js";import{a as M}from"./vendor-query-BlSVl3IQ.js";import{u as ne}from"./vendor-i18n-DxKeo2S1.js";import{C as ie}from"./chevron-left-BHcY9IrV.js";import{S as H}from"./star-DqKRai6M.js";import{E as de}from"./external-link-C5GWMUy2.js";import{S as le}from"./square-pen-B33wHQe-.js";import{E as ce}from"./eye-CrXJhp4G.js";import{M as $}from"./message-circle-C4oJUb2D.js";import{H as G}from"./heart-ClAJibHi.js";import{T as oe}from"./trending-up-DjOVe_c3.js";import{R as me,L as xe,C as he,X as ue,Y as ge,T as je,b as pe}from"./vendor-charts-Bz7hPIBd.js";import{s as q}from"./subDays-DEpdoBC8.js";import{f as x}from"./format-C1rHoFdk.js";import{s as I}from"./startOfDay-CJ0Nm-E7.js";import"./vendor-supabase-KNAP0qdW.js";function Q(r,a){const f=T(r.start),d=T(r.end);let y=+f>+d;const R=y?+f:+d,c=y?d:f;c.setHours(0,0,0,0);let l=1;const v=[];for(;+c<=R;)v.push(T(c)),c.setDate(c.getDate()+l),c.setHours(0,0,0,0);return y?v.reverse():v}const Oe=()=>{const{id:r}=U(),{t:a}=ne(),{localizeRestaurant:f}=re(),[d,y]=W.useState("30days"),R=()=>{const s=new Date;switch(d){case"today":return I(s).toISOString();case"7days":return I(q(s,6)).toISOString();case"30days":return I(q(s,29)).toISOString();default:return null}},c=()=>{switch(d){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:l,isLoading:v}=te(r),j=R(),{data:L=[],isLoading:fe}=M({queryKey:["restaurant-page-views",r,d],queryFn:async()=>{let s=p.from("page_views").select("created_at").eq("page_type","restaurant").eq("target_id",r);j&&(s=s.gte("created_at",j));const{data:t,error:i}=await s;if(i)throw i;return t},enabled:!!r}),{data:h=[],isLoading:ye}=M({queryKey:["restaurant-comments",r,d],queryFn:async()=>{let s=p.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_type","restaurant").eq("target_id",r).order("created_at",{ascending:!1});j&&(s=s.gte("created_at",j));const{data:t,error:i}=await s;if(i)throw i;if(t&&t.length>0){const N=[...new Set(t.map(n=>n.user_id))],{data:u}=await p.rpc("get_public_profiles",{user_ids:N});return t.map(n=>({...n,profile:u?.find(g=>g.id===n.user_id)}))}return[]},enabled:!!r}),{data:w=[],isLoading:ve}=M({queryKey:["restaurant-favorites",r,d],queryFn:async()=>{let s=p.from("favorites").select("user_id, created_at").eq("restaurant_id",r);j&&(s=s.gte("created_at",j));const{data:t,error:i}=await s;if(i)throw i;if(t&&t.length>0){const N=t.map(n=>n.user_id),{data:u}=await p.rpc("get_public_profiles",{user_ids:N});return t.map(n=>({...n,profile:u?.find(g=>g.id===n.user_id)}))}return[]},enabled:!!r}),{data:A=[]}=M({queryKey:["restaurant-activities",r],queryFn:async()=>{const{data:s,error:t}=await p.from("activity_restaurants").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            status
          )
        `).eq("restaurant_id",r);if(t)throw t;return s?.map(i=>i.activities).filter(Boolean)||[]},enabled:!!r}),E=(()=>{if(d==="all"){const t=new Date,i=q(t,29);return Q({start:i,end:t}).map(u=>{const n=x(u,"yyyy-MM-dd"),g=L.filter(k=>x(new Date(k.created_at),"yyyy-MM-dd")===n).length;return{date:n,views:g}})}else{const s=c(),t=new Date,i=q(t,s-1);return Q({start:i,end:t}).map(u=>{const n=x(u,"yyyy-MM-dd"),g=L.filter(k=>x(new Date(k.created_at),"yyyy-MM-dd")===n).length;return{date:n,views:g}})}})(),K=h.length>0?h.filter(s=>s.rating_value).reduce((s,t)=>s+(t.rating_value||0),0)/h.filter(s=>s.rating_value).length:0,F=l?f(l):null;return v?e.jsxs("div",{className:"space-y-6",children:[e.jsx(z,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(z,{className:"h-24"},s))}),e.jsx(z,{className:"h-64"})]}):!l||!F?e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"text-muted-foreground",children:a("error.notFound")})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(b,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(_,{to:"/admin/restaurant-stats",children:e.jsx(ie,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[l.image_url?e.jsx("img",{src:l.image_url,alt:F.name,className:"w-12 h-12 rounded-lg object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(Z,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:F.name}),l.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(H,{className:"h-3 w-3 fill-amber-400 text-amber-400"}),e.jsx("span",{children:l.rating.toFixed(1)})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(J,{value:d,onValueChange:s=>y(s),children:[e.jsx(ee,{className:"w-[140px]",children:e.jsx(se,{})}),e.jsxs(ae,{children:[e.jsx(D,{value:"today",children:a("analytics.today","今日")}),e.jsx(D,{value:"7days",children:a("analytics.last7Days","近7天")}),e.jsx(D,{value:"30days",children:a("analytics.last30Days","近30天")}),e.jsx(D,{value:"all",children:a("analytics.allTime","所有时间")})]})]}),e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(_,{to:`/restaurant/${r}`,target:"_blank",children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),a("admin.preview","预览")]})}),e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(_,{to:"/admin/restaurants",state:{editRestaurantId:r},children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),a("admin.edit","编辑")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx(ce,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.views","浏览量")}),e.jsx("p",{className:"text-2xl font-bold",children:L.length})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx($,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.comments","评论")}),e.jsx("p",{className:"text-2xl font-bold",children:h.length})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg",children:e.jsx(G,{className:"h-5 w-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.favorites","收藏")}),e.jsx("p",{className:"text-2xl font-bold",children:w.length})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/10 rounded-lg",children:e.jsx(H,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.avgRating","平均评分")}),e.jsx("p",{className:"text-2xl font-bold",children:K>0?K.toFixed(1):"-"})]})]})})})]}),e.jsxs(o,{children:[e.jsx(C,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),a("admin.viewTrend","浏览趋势")]})}),e.jsx(m,{children:e.jsx("div",{className:"h-[300px]",children:E.length>0?e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(xe,{data:E,children:[e.jsx(he,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(ue,{dataKey:"date",tickFormatter:s=>x(new Date(s),"MM/dd"),className:"text-xs"}),e.jsx(ge,{className:"text-xs"}),e.jsx(je,{labelFormatter:s=>x(new Date(s),"yyyy-MM-dd"),contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(pe,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,name:a("admin.views")})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:a("analytics.noData")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(o,{children:[e.jsxs(C,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx($,{className:"w-5 h-5"}),a("admin.recentComments","最近评论")]}),e.jsx(B,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(h.length,10)})})]}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[h.slice(0,10).map(s=>e.jsxs("div",{className:"flex gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(V,{className:"h-8 w-8",children:[e.jsx(Y,{src:s.profile?.avatar_url}),e.jsx(P,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||a("common.anonymous")}),s.rating_value&&e.jsxs(X,{variant:"secondary",className:"text-xs",children:[e.jsx(H,{className:"h-3 w-3 mr-1 fill-amber-400 text-amber-400"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:x(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},s.id)),h.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noComments","暂无评论")})]})})]}),e.jsxs(o,{children:[e.jsxs(C,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5"}),a("admin.recentFavorites","最近收藏")]}),e.jsx(B,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(w.length,10)})})]}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:[w.slice(0,10).map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(V,{className:"h-8 w-8",children:[e.jsx(Y,{src:s.profile?.avatar_url}),e.jsx(P,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||a("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:x(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},t)),w.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noFavorites","暂无收藏")})]})})]})]}),e.jsxs(o,{children:[e.jsx(C,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),a("admin.participatingActivities","参与的活动")]})}),e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[A.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.title_zh||s.title_en}),e.jsx(X,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?a("admin.published","已发布"):a("admin.draft","草稿")})]}),e.jsx(b,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:e.jsx(_,{to:`/admin/activity-stats/${s.id}`,children:a("admin.viewStats","查看统计")})})]},s.id)),A.length===0&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:a("admin.noActivities","暂未参与活动")})]})})]})]})};export{Oe as default};
//# sourceMappingURL=AdminRestaurantStats-CCOfV9vH.js.map
