import{p as Q,r as u,bO as _e,bS as ge,j as e,w as A,s as ve,aZ as fe,am as ye,bW as G,b3 as Ne,bQ as K,bP as Z,cp as E,d2 as be,dI as Ce,bx as we,ak as Se}from"./vendor-react-BycBeP44.js";import{D as ne,c as ae,d as ie,e as te,a2 as P,a3 as R,a4 as O,a5 as H,a6 as C,I as D,a8 as V,h as N,s as W,T as De,F as ke,P as Te,Q as Ie,R as Le,V as Ae,b as ze,C as J,m as X,E as Y,$ as Fe,n as ee,U as Ue,B as Ee,A as Pe,q as Re,r as Oe,t as He,v as Ve,w as qe,x as Be,y as We}from"./index-B82I__2U.js";import{T as Me,a as Qe,b as se,c as w,d as $e,e as S}from"./table-B7kvgjV9.js";import{S as M}from"./switch-BebVCsEQ.js";import{u as re,a as Ge,b as Ke,c as Ze}from"./useShopItems-BeDyydoY.js";import{u as Je}from"./useLocalizedContent-Bf3Dc_ef.js";import{F as Xe,a as c,b as d,c as m,d as h,e as x,f as q}from"./form-CQqlsCNu.js";import{N as Ye,O as g,T as B,U as es}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CJSxlXC7.js";const ss=Ye({item_type:g(),coupon_template_id:g().optional().nullable(),name_zh:g().min(1),name_en:g().min(1),name_pt:g().min(1),description_zh:g().optional(),description_en:g().optional(),description_pt:g().optional(),image_url:g().optional(),points_cost:B().min(1),stock:B().optional().nullable(),per_user_limit:B().min(1),limit_refresh_period:g(),is_active:es()}),ns=({open:n,onOpenChange:_,item:t})=>{const{t:i}=Q(),v=re(),[p,k]=u.useState([]),[T,f]=u.useState(!1),r=_e({resolver:ge(ss),defaultValues:{item_type:"coupon",coupon_template_id:null,name_zh:"",name_en:"",name_pt:"",description_zh:"",description_en:"",description_pt:"",image_url:"",points_cost:100,stock:null,per_user_limit:1,limit_refresh_period:"none",is_active:!0}});u.useEffect(()=>{n&&(async()=>{f(!0);try{const{data:o,error:y}=await W.from("coupon_templates").select("id, title_zh, title_en, title_pt, discount_type, discount_value").eq("is_active",!0).order("title_en");if(y)throw y;k(o||[])}catch(o){console.error("Error loading templates:",o)}finally{f(!1)}})()},[n]),u.useEffect(()=>{t?r.reset({item_type:t.item_type,coupon_template_id:t.coupon_template_id,name_zh:t.name_zh,name_en:t.name_en,name_pt:t.name_pt,description_zh:t.description_zh||"",description_en:t.description_en||"",description_pt:t.description_pt||"",image_url:t.image_url||"",points_cost:t.points_cost,stock:t.stock,per_user_limit:t.per_user_limit,limit_refresh_period:t.limit_refresh_period,is_active:t.is_active}):r.reset({item_type:"coupon",coupon_template_id:null,name_zh:"",name_en:"",name_pt:"",description_zh:"",description_en:"",description_pt:"",image_url:"",points_cost:100,stock:null,per_user_limit:1,limit_refresh_period:"none",is_active:!0})},[t,r]);const I=async s=>{try{await v.mutateAsync({...t?.id?{id:t.id}:{},item_type:s.item_type,name_zh:s.name_zh,name_en:s.name_en,name_pt:s.name_pt,description_zh:s.description_zh,description_en:s.description_en,description_pt:s.description_pt,image_url:s.image_url,points_cost:s.points_cost,per_user_limit:s.per_user_limit,limit_refresh_period:s.limit_refresh_period,is_active:s.is_active,stock:s.stock||null,coupon_template_id:s.item_type==="coupon"?s.coupon_template_id:null}),A.success(i(t?"admin.shop.updateSuccess":"admin.shop.createSuccess")),_(!1)}catch(o){console.error("Save error:",o),A.error(i("common.error"))}},z=r.watch("item_type");return e.jsx(ne,{open:n,onOpenChange:_,children:e.jsxs(ae,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ie,{children:e.jsx(te,{children:i(t?"admin.shop.editItem":"admin.shop.addItem")})}),e.jsx(Xe,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(I),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(c,{control:r.control,name:"item_type",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.itemType")}),e.jsxs(P,{onValueChange:s.onChange,value:s.value,children:[e.jsx(h,{children:e.jsx(R,{children:e.jsx(O,{})})}),e.jsxs(H,{children:[e.jsx(C,{value:"coupon",children:i("admin.shop.typeCoupon")}),e.jsx(C,{value:"physical",children:i("admin.shop.typePhysical")}),e.jsx(C,{value:"badge",children:i("admin.shop.typeBadge")})]})]}),e.jsx(x,{})]})}),z==="coupon"&&e.jsx(c,{control:r.control,name:"coupon_template_id",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.couponTemplate")}),e.jsxs(P,{onValueChange:s.onChange,value:s.value||"",disabled:T,children:[e.jsx(h,{children:e.jsx(R,{children:e.jsx(O,{placeholder:i("admin.shop.selectTemplate")})})}),e.jsx(H,{children:p.map(o=>e.jsxs(C,{value:o.id,children:[o.title_zh," (",o.discount_type==="percentage"?`${o.discount_value}%`:`â‚¬${o.discount_value}`,")"]},o.id))})]}),e.jsx(x,{})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:i("admin.shop.itemName")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(c,{control:r.control,name:"name_zh",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.chinese")}),e.jsx(h,{children:e.jsx(D,{...s})}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"name_en",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.english")}),e.jsx(h,{children:e.jsx(D,{...s})}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"name_pt",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.portuguese")}),e.jsx(h,{children:e.jsx(D,{...s})}),e.jsx(x,{})]})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:i("admin.shop.itemDescription")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(c,{control:r.control,name:"description_zh",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.chinese")}),e.jsx(h,{children:e.jsx(V,{...s,rows:2})}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"description_en",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.english")}),e.jsx(h,{children:e.jsx(V,{...s,rows:2})}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"description_pt",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.portuguese")}),e.jsx(h,{children:e.jsx(V,{...s,rows:2})}),e.jsx(x,{})]})})]})]}),e.jsx(c,{control:r.control,name:"image_url",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.imageUrl")}),e.jsx(h,{children:e.jsx(D,{...s,placeholder:"https://..."})}),e.jsx(q,{children:i("admin.shop.imageUrlHelp")}),e.jsx(x,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(c,{control:r.control,name:"points_cost",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.pointsCost")}),e.jsx(h,{children:e.jsx(D,{type:"number",...s,onChange:o=>s.onChange(parseInt(o.target.value)||0)})}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"stock",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.stock")}),e.jsx(h,{children:e.jsx(D,{type:"number",placeholder:i("admin.shop.unlimited"),value:s.value??"",onChange:o=>s.onChange(o.target.value?parseInt(o.target.value):null)})}),e.jsx(q,{children:i("admin.shop.stockHelp")}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"per_user_limit",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.perUserLimit")}),e.jsx(h,{children:e.jsx(D,{type:"number",...s,onChange:o=>s.onChange(parseInt(o.target.value)||1)})}),e.jsx(x,{})]})}),e.jsx(c,{control:r.control,name:"limit_refresh_period",render:({field:s})=>e.jsxs(d,{children:[e.jsx(m,{children:i("admin.shop.refreshPeriod")}),e.jsxs(P,{onValueChange:s.onChange,value:s.value,children:[e.jsx(h,{children:e.jsx(R,{children:e.jsx(O,{})})}),e.jsxs(H,{children:[e.jsx(C,{value:"none",children:i("admin.shop.periodNone")}),e.jsx(C,{value:"daily",children:i("admin.shop.periodDaily")}),e.jsx(C,{value:"weekly",children:i("admin.shop.periodWeekly")}),e.jsx(C,{value:"monthly",children:i("admin.shop.periodMonthly")})]})]}),e.jsx(x,{})]})})]}),e.jsx(c,{control:r.control,name:"is_active",render:({field:s})=>e.jsxs(d,{className:"flex items-center justify-between rounded-lg border p-4",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(m,{children:i("admin.shop.isActive")}),e.jsx(q,{children:i("admin.shop.isActiveHelp")})]}),e.jsx(h,{children:e.jsx(M,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>_(!1),children:i("common.cancel")}),e.jsx(N,{type:"submit",disabled:v.isPending,children:v.isPending?i("common.saving"):i("common.save")})]})]})})]})})},as=({open:n,onOpenChange:_,itemId:t,itemName:i,onConfirm:v})=>{const{t:p}=Q(),[k,T]=u.useState(""),[f,r]=u.useState(null),{data:I,isLoading:z}=ve({queryKey:["item-purchase-limits",t],queryFn:async()=>{const{data:l,error:b}=await W.from("user_purchase_limits").select("user_id, purchase_count").eq("shop_item_id",t);if(b)throw b;if(!l||l.length===0)return[];const U=l.map(j=>j.user_id),{data:F}=await W.from("profiles").select("id, display_name, avatar_url").in("id",U),L=new Map(F?.map(j=>[j.id,j])||[]);return l.map(j=>({user_id:j.user_id,purchase_count:j.purchase_count,profile:L.get(j.user_id)||null}))},enabled:n}),s=I?.filter(l=>{if(!k)return!0;const b=k.toLowerCase();return(l.profile?.display_name?.toLowerCase()||"").includes(b)||l.user_id.toLowerCase().includes(b)}),o=()=>{f&&(v(f),r(null),T(""))},y=()=>{r(null),T(""),_(!1)};return e.jsx(ne,{open:n,onOpenChange:y,children:e.jsxs(ae,{className:"max-w-md",children:[e.jsxs(ie,{children:[e.jsx(te,{children:p("admin.shop.resetUserLimit")}),e.jsx(De,{children:p("admin.shop.resetUserLimitDesc",{itemName:i})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(D,{placeholder:p("admin.shop.searchUser"),value:k,onChange:l=>T(l.target.value),className:"pl-9"})]}),e.jsx(ke,{className:"h-64 border rounded-md",children:z?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:p("common.loading")}):s&&s.length>0?e.jsx("div",{className:"p-2 space-y-1",children:s.map(l=>e.jsxs("div",{className:`flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors ${f===l.user_id?"bg-primary/10 border border-primary":"hover:bg-muted"}`,onClick:()=>r(l.user_id),children:[e.jsxs(Te,{className:"h-8 w-8",children:[e.jsx(Ie,{src:l.profile?.avatar_url||void 0}),e.jsx(Le,{children:e.jsx(ye,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:l.profile?.display_name||p("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:p("admin.shop.purchaseCount",{count:l.purchase_count})})]})]},l.user_id))}):e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:p("admin.shop.noUsersWithLimits")})})]}),e.jsxs(Ae,{children:[e.jsx(N,{variant:"outline",onClick:y,children:p("common.cancel")}),e.jsx(N,{onClick:o,disabled:!f,className:"bg-amber-500 hover:bg-amber-600",children:p("admin.shop.resetLimits")})]})]})})},us=()=>{const{t:n}=Q(),{getLocalizedField:_}=Je(),{data:t,isLoading:i}=Ge(),{settings:v,updateSettings:p}=ze(),k=re(),T=Ke(),f=Ze(),[r,I]=u.useState(!1),[z,s]=u.useState(null),[o,y]=u.useState(!1),[l,b]=u.useState(null),[U,F]=u.useState(!1),[L,j]=u.useState(null),oe=async()=>{const a=!v?.shop_enabled;await p.mutateAsync({shop_enabled:a}),A.success(n(a?"admin.shop.shopEnabledSuccess":"admin.shop.shopDisabledSuccess"))},$=()=>{s(null),I(!0)},le=a=>{s(a),I(!0)},ce=a=>{b(a),y(!0)},de=async()=>{if(l)try{await T.mutateAsync(l.id),A.success(n("admin.shop.deleteSuccess"))}catch{A.error(n("admin.shop.deleteFailed"))}y(!1),b(null)},me=a=>{j(a),F(!0)},he=async a=>{if(L)try{await f.mutateAsync({itemId:L.id,userId:a})}catch{}F(!1),j(null)},pe=async a=>{try{await k.mutateAsync({...a,is_active:!a.is_active}),A.success(a.is_active?n("admin.shop.itemDeactivated"):n("admin.shop.itemActivated"))}catch{A.error(n("common.error"))}},xe=a=>{switch(a){case"coupon":return n("admin.shop.typeCoupon");case"physical":return n("admin.shop.typePhysical");case"badge":return n("admin.shop.typeBadge");default:return a}},ue=a=>{switch(a){case"daily":return n("admin.shop.periodDaily");case"weekly":return n("admin.shop.periodWeekly");case"monthly":return n("admin.shop.periodMonthly");case"none":return n("admin.shop.periodNone");default:return a}};return i?e.jsx("div",{className:"p-6",children:n("common.loading")}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:n("admin.shop.title")}),e.jsx("p",{className:"text-muted-foreground",children:n("admin.shop.description")})]}),e.jsxs(N,{onClick:$,children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),n("admin.shop.addItem")]})]}),e.jsxs(J,{children:[e.jsxs(X,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),n("admin.shop.shopEnabled")]}),e.jsx(Fe,{children:n("admin.shop.shopEnabledDesc")})]}),e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{id:"shop-enabled",checked:v?.shop_enabled??!0,onCheckedChange:oe}),e.jsx(Ue,{htmlFor:"shop-enabled",className:"flex items-center gap-2",children:v?.shop_enabled?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:n("admin.shop.itemActivated")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:n("admin.shop.itemDeactivated")})]})})]})})]}),e.jsxs(J,{children:[e.jsx(X,{children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5"}),n("admin.shop.itemList")]})}),e.jsx(ee,{children:t&&t.length>0?e.jsxs(Me,{children:[e.jsx(Qe,{children:e.jsxs(se,{children:[e.jsx(w,{className:"w-12"}),e.jsx(w,{children:n("admin.shop.itemName")}),e.jsx(w,{children:n("admin.shop.itemType")}),e.jsx(w,{children:n("admin.shop.pointsCost")}),e.jsx(w,{children:n("admin.shop.stock")}),e.jsx(w,{children:n("admin.shop.limit")}),e.jsx(w,{children:n("admin.shop.status")}),e.jsx(w,{className:"text-right",children:n("common.actions")})]})}),e.jsx($e,{children:t.map(a=>e.jsxs(se,{children:[e.jsx(S,{children:e.jsx(be,{className:"h-4 w-4 text-muted-foreground cursor-grab"})}),e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[a.image_url?e.jsx("img",{src:a.image_url,alt:_(a,"name"),className:"w-10 h-10 rounded object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded bg-muted flex items-center justify-center",children:e.jsx(E,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:_(a,"name")}),e.jsx("div",{className:"text-sm text-muted-foreground line-clamp-1",children:_(a,"description")})]})]})}),e.jsx(S,{children:e.jsx(Ee,{variant:"outline",children:xe(a.item_type)})}),e.jsx(S,{className:"font-medium",children:a.points_cost}),e.jsx(S,{children:a.stock===null?e.jsx("span",{className:"text-muted-foreground",children:n("admin.shop.unlimited")}):e.jsx("span",{className:a.stock<=0?"text-destructive":"",children:a.stock})}),e.jsx(S,{children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[a.per_user_limit," ",n("admin.shop.times")]}),e.jsx("div",{className:"text-muted-foreground text-xs",children:ue(a.limit_refresh_period)})]})}),e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{checked:a.is_active,onCheckedChange:()=>pe(a)}),a.is_active?e.jsx(K,{className:"h-4 w-4 text-green-500"}):e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"})]})}),e.jsx(S,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>me(a),title:n("admin.shop.resetLimits"),children:e.jsx(Ce,{className:"h-4 w-4 text-amber-500"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>le(a),children:e.jsx(we,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>ce(a),children:e.jsx(Se,{className:"h-4 w-4 text-destructive"})})]})})]},a.id))})]}):e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(E,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:n("admin.shop.noItems")}),e.jsxs(N,{variant:"outline",className:"mt-4",onClick:$,children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),n("admin.shop.addFirstItem")]})]})})]}),e.jsx(ns,{open:r,onOpenChange:I,item:z}),e.jsx(Pe,{open:o,onOpenChange:y,children:e.jsxs(Re,{children:[e.jsxs(Oe,{children:[e.jsx(He,{children:n("admin.shop.confirmDelete")}),e.jsx(Ve,{children:n("admin.shop.deleteWarning")})]}),e.jsxs(qe,{children:[e.jsx(Be,{children:n("common.cancel")}),e.jsx(We,{onClick:de,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:n("common.delete")})]})]})}),e.jsx(as,{open:U,onOpenChange:F,itemId:L?.id||"",itemName:L?_(L,"name"):"",onConfirm:he})]})};export{us as default};
//# sourceMappingURL=AdminShopItems-gN4P3Kcl.js.map
