{"version":3,"file":"ActivityDetail-C8kQ1yb4.js","sources":["../../src/components/skeletons/ActivityDetailSkeleton.tsx","../../src/components/ActivityParticipationMap.tsx","../../src/components/SelectRestaurantsDialog.tsx","../../src/components/GlobalHandbookDialog.tsx","../../src/components/ShareForCouponDialog.tsx","../../src/components/ActivityShareCount.tsx","../../src/components/ActivitySubscriberCount.tsx","../../src/pages/ActivityDetail.tsx"],"sourcesContent":["import { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\r\n\r\nconst ActivityDetailSkeleton = () => {\r\n  return (\r\n    <div className=\"min-h-screen bg-secondary/20 pb-8\">\r\n      {/* Hero Media Section */}\r\n      <div className=\"relative h-[33vh] overflow-hidden\">\r\n        <Skeleton className=\"w-full h-full rounded-none\" />\r\n        <div className=\"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent\" />\r\n        \r\n        {/* Back Button */}\r\n        <div className=\"absolute top-4 left-4\">\r\n          <Skeleton className=\"h-10 w-10 rounded-md\" />\r\n        </div>\r\n        \r\n        {/* Action Buttons */}\r\n        <div className=\"absolute top-4 right-4 flex gap-2\">\r\n          <Skeleton className=\"h-10 w-10 rounded-md\" />\r\n          <Skeleton className=\"h-10 w-10 rounded-md\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Content */}\r\n      <div className=\"container mx-auto px-4 -mt-20 relative z-10\">\r\n        <Card className=\"shadow-large\">\r\n          <CardHeader>\r\n            {/* Status badges */}\r\n            <div className=\"flex flex-wrap gap-2 mb-3\">\r\n              <Skeleton className=\"h-6 w-16 rounded-full\" />\r\n              <Skeleton className=\"h-6 w-20 rounded-full\" />\r\n              <Skeleton className=\"h-6 w-24 rounded-full\" />\r\n            </div>\r\n            \r\n            {/* Title */}\r\n            <Skeleton className=\"h-9 w-3/4 mb-4\" />\r\n            \r\n            {/* Stats bar */}\r\n            <div className=\"flex flex-wrap items-center gap-4 mb-4\">\r\n              <Skeleton className=\"h-5 w-24\" />\r\n              <Skeleton className=\"h-5 w-20\" />\r\n              <Skeleton className=\"h-5 w-28\" />\r\n            </div>\r\n            \r\n            {/* Info grid */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n              {/* Date info */}\r\n              <div className=\"flex items-start gap-3\">\r\n                <Skeleton className=\"h-5 w-5 flex-shrink-0\" />\r\n                <div className=\"space-y-1\">\r\n                  <Skeleton className=\"h-4 w-32\" />\r\n                  <Skeleton className=\"h-4 w-40\" />\r\n                </div>\r\n              </div>\r\n              \r\n              {/* Creator info */}\r\n              <div className=\"flex items-center gap-3\">\r\n                <Skeleton className=\"h-10 w-10 rounded-full\" />\r\n                <div className=\"space-y-1\">\r\n                  <Skeleton className=\"h-4 w-20\" />\r\n                  <Skeleton className=\"h-4 w-32\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Action buttons */}\r\n            <div className=\"flex flex-wrap gap-3\">\r\n              <Skeleton className=\"h-10 w-28 rounded-md\" />\r\n              <Skeleton className=\"h-10 w-32 rounded-md\" />\r\n              <Skeleton className=\"h-10 w-24 rounded-md\" />\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n        \r\n        {/* Activity Description */}\r\n        <Card className=\"mt-6 shadow-large\">\r\n          <CardHeader>\r\n            <Skeleton className=\"h-6 w-36\" />\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-3\">\r\n            <Skeleton className=\"h-4 w-full\" />\r\n            <Skeleton className=\"h-4 w-full\" />\r\n            <Skeleton className=\"h-4 w-5/6\" />\r\n            <Skeleton className=\"h-4 w-4/5\" />\r\n          </CardContent>\r\n        </Card>\r\n        \r\n        {/* Usage Instructions */}\r\n        <Card className=\"mt-6 shadow-large\">\r\n          <CardHeader>\r\n            <Skeleton className=\"h-6 w-28\" />\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-2\">\r\n            <Skeleton className=\"h-4 w-full\" />\r\n            <Skeleton className=\"h-4 w-3/4\" />\r\n          </CardContent>\r\n        </Card>\r\n        \r\n        {/* Participating Restaurants */}\r\n        <Card className=\"mt-6 shadow-large\">\r\n          <CardHeader className=\"flex flex-row items-center justify-between\">\r\n            <Skeleton className=\"h-6 w-40\" />\r\n            <Skeleton className=\"h-5 w-24\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            {/* Map placeholder */}\r\n            <Skeleton className=\"h-[200px] w-full rounded-lg mb-4\" />\r\n            \r\n            {/* Restaurant list */}\r\n            <div className=\"space-y-3\">\r\n              {[1, 2, 3].map((i) => (\r\n                <div key={i} className=\"flex items-center gap-3 p-3 border rounded-lg\">\r\n                  <Skeleton className=\"h-16 w-16 rounded-lg flex-shrink-0\" />\r\n                  <div className=\"flex-1 space-y-2\">\r\n                    <Skeleton className=\"h-5 w-40\" />\r\n                    <Skeleton className=\"h-4 w-full\" />\r\n                    <div className=\"flex gap-2\">\r\n                      <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                      <Skeleton className=\"h-5 w-12\" />\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ActivityDetailSkeleton;\r\n","import { useEffect, useRef, memo, useState } from \"react\";\r\nimport mapboxgl from \"mapbox-gl\";\r\nimport \"mapbox-gl/dist/mapbox-gl.css\";\r\nimport { ActivityRestaurant } from \"@/hooks/useActivities\";\r\nimport { isIOSDevice, isIOSWebView } from \"@/lib/externalLinks\";\r\nimport { AlertTriangle, MapPin } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport mapIcon from \"@/assets/map-icon.png\";\r\n\r\ninterface ActivityParticipationMapProps {\r\n  restaurants: ActivityRestaurant[];\r\n  onMarkerClick?: (restaurantId: string) => void;\r\n}\r\n\r\nconst ActivityParticipationMap = memo(({ restaurants, onMarkerClick }: ActivityParticipationMapProps) => {\r\n  const { t } = useTranslation();\r\n  const mapContainer = useRef<HTMLDivElement>(null);\r\n  const map = useRef<mapboxgl.Map | null>(null);\r\n  const markers = useRef<mapboxgl.Marker[]>([]);\r\n  const [mapLoaded, setMapLoaded] = useState(false);\r\n  const [mapError, setMapError] = useState<string | null>(null);\r\n  const currentPopup = useRef<mapboxgl.Popup | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!mapContainer.current || map.current) return;\r\n\r\n    const MAPBOX_TOKEN = import.meta.env.VITE_MAPBOX_TOKEN;\r\n    if (!MAPBOX_TOKEN) {\r\n      console.warn('[ActivityMap] No Mapbox token found');\r\n      return;\r\n    }\r\n\r\n    // Check WebGL support\r\n    if (!mapboxgl.supported()) {\r\n      console.warn('[ActivityMap] WebGL not supported', {\r\n        isIOSDevice: isIOSDevice(),\r\n        isIOSWebView: isIOSWebView(),\r\n        userAgent: navigator.userAgent\r\n      });\r\n      setMapError(t('map.webglNotSupported', 'Your browser does not support map display'));\r\n      return;\r\n    }\r\n\r\n    // Wait for container to have valid dimensions\r\n    const initMap = () => {\r\n      if (!mapContainer.current) return;\r\n      \r\n      const rect = mapContainer.current.getBoundingClientRect();\r\n      \r\n      if (rect.width === 0 || rect.height === 0) {\r\n        setTimeout(initMap, 100);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        mapboxgl.accessToken = MAPBOX_TOKEN;\r\n\r\n        // Calculate center based on all restaurants\r\n        const avgLat = restaurants.reduce((sum, r) => sum + Number(r.restaurants.lat || 0), 0) / restaurants.length;\r\n        const avgLng = restaurants.reduce((sum, r) => sum + Number(r.restaurants.lng || 0), 0) / restaurants.length;\r\n\r\n        map.current = new mapboxgl.Map({\r\n          container: mapContainer.current,\r\n          style: \"mapbox://styles/mapbox/light-v11\",\r\n          center: [avgLng, avgLat],\r\n          zoom: 12,\r\n          cooperativeGestures: true,\r\n          doubleClickZoom: false,\r\n        });\r\n\r\n        map.current.on('error', (e) => {\r\n          console.error('[ActivityMap] Map error:', e);\r\n          setMapError(t('map.loadError', 'Map failed to load'));\r\n        });\r\n\r\n        map.current.addControl(new mapboxgl.NavigationControl(), \"top-right\");\r\n\r\n        map.current.on(\"load\", () => {\r\n          setMapLoaded(true);\r\n        });\r\n      } catch (error) {\r\n        console.error('[ActivityMap] Failed to initialize map:', error);\r\n        setMapError(t('map.loadError', 'Map failed to load'));\r\n      }\r\n    };\r\n\r\n    initMap();\r\n\r\n    return () => {\r\n      markers.current.forEach(marker => marker.remove());\r\n      markers.current = [];\r\n      if (currentPopup.current) {\r\n        currentPopup.current.remove();\r\n        currentPopup.current = null;\r\n      }\r\n      map.current?.remove();\r\n      map.current = null;\r\n      setMapLoaded(false);\r\n    };\r\n  }, [restaurants.length, t]);\r\n\r\n  useEffect(() => {\r\n    if (!map.current || !mapLoaded || restaurants.length === 0) return;\r\n\r\n    // Add markers using default Mapbox style\r\n    const addMarkers = () => {\r\n      // Clear existing markers\r\n      markers.current.forEach(marker => marker.remove());\r\n      markers.current = [];\r\n      \r\n      // Clear existing popup\r\n      if (currentPopup.current) {\r\n        currentPopup.current.remove();\r\n        currentPopup.current = null;\r\n      }\r\n\r\n      restaurants.forEach((restaurant) => {\r\n        const lat = Number(restaurant.restaurants.lat);\r\n        const lng = Number(restaurant.restaurants.lng);\r\n\r\n        if (isNaN(lat) || isNaN(lng)) return;\r\n\r\n        const popupContent = document.createElement('div');\r\n        popupContent.className = 'p-3 min-w-[200px]';\r\n        popupContent.innerHTML = `\r\n          <div class=\"space-y-2\">\r\n            <h3 class=\"font-bold text-base text-foreground\">${restaurant.restaurants.name}</h3>\r\n            <p class=\"text-xs text-muted-foreground\">${restaurant.restaurants.address}</p>\r\n          </div>\r\n        `;\r\n\r\n        const popup = new mapboxgl.Popup({ \r\n          offset: 25,\r\n          closeButton: true,\r\n          closeOnClick: false,\r\n          closeOnMove: false,\r\n          maxWidth: '300px'\r\n        })\r\n          .setLngLat([lng, lat])\r\n          .setDOMContent(popupContent);\r\n\r\n        const el = document.createElement('div');\r\n        el.className = 'custom-marker';\r\n        el.style.backgroundImage = `url(${mapIcon})`;\r\n        el.style.width = '40px';\r\n        el.style.height = '40px';\r\n        el.style.backgroundSize = 'contain';\r\n        el.style.backgroundRepeat = 'no-repeat';\r\n        el.style.backgroundPosition = 'center';\r\n        el.style.cursor = 'pointer';\r\n\r\n        const marker = new mapboxgl.Marker({ \r\n          element: el,\r\n          draggable: false\r\n        })\r\n          .setLngLat([lng, lat])\r\n          .addTo(map.current!);\r\n\r\n        const markerElement = marker.getElement();\r\n        markerElement.style.cursor = 'pointer';\r\n        \r\n        // Handle marker click with proper popup management\r\n        const handleMarkerClick = (e: MouseEvent) => {\r\n          e.stopPropagation();\r\n          e.preventDefault();\r\n          \r\n          // Close previous popup if exists\r\n          if (currentPopup.current && currentPopup.current !== popup) {\r\n            currentPopup.current.remove();\r\n          }\r\n          \r\n          // Open new popup\r\n          popup.addTo(map.current!);\r\n          currentPopup.current = popup;\r\n          \r\n          // Zoom to marker\r\n          map.current!.easeTo({\r\n            center: [lng, lat],\r\n            zoom: 17,\r\n            duration: 800,\r\n          });\r\n          \r\n          if (onMarkerClick) {\r\n            onMarkerClick(restaurant.restaurant_id);\r\n          }\r\n        };\r\n        \r\n        markerElement.addEventListener('click', handleMarkerClick, true);\r\n        \r\n        // Handle popup close\r\n        popup.on('close', () => {\r\n          if (currentPopup.current === popup) {\r\n            currentPopup.current = null;\r\n          }\r\n        });\r\n\r\n        markers.current.push(marker);\r\n      });\r\n\r\n      // Fit bounds to show all markers\r\n      if (restaurants.length > 1) {\r\n        const bounds = new mapboxgl.LngLatBounds();\r\n        restaurants.forEach((restaurant) => {\r\n          const lat = Number(restaurant.restaurants.lat);\r\n          const lng = Number(restaurant.restaurants.lng);\r\n          if (!isNaN(lat) && !isNaN(lng)) {\r\n            bounds.extend([lng, lat]);\r\n          }\r\n        });\r\n        map.current?.fitBounds(bounds, { padding: 50, maxZoom: 14 });\r\n      }\r\n    };\r\n\r\n    addMarkers();\r\n  }, [restaurants, mapLoaded, onMarkerClick]);\r\n\r\n  if (restaurants.length === 0) return null;\r\n\r\n  // Show error fallback UI\r\n  if (mapError) {\r\n    return (\r\n      <div className=\"w-full h-[350px] rounded-lg bg-muted/50 flex flex-col items-center justify-center p-6 text-center\">\r\n        <AlertTriangle className=\"w-10 h-10 text-muted-foreground mb-3\" />\r\n        <p className=\"text-muted-foreground text-sm mb-2\">{mapError}</p>\r\n        <p className=\"text-xs text-muted-foreground mb-3\">\r\n          {t('map.viewListInstead', 'Please view the restaurant list below')}\r\n        </p>\r\n        {isIOSWebView() && (\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => window.open(window.location.href, '_blank')}\r\n          >\r\n            <MapPin className=\"w-4 h-4 mr-2\" />\r\n            {t('map.openInBrowser', 'Open in Browser')}\r\n          </Button>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return <div ref={mapContainer} className=\"w-full h-[350px] rounded-lg\" />;\r\n});\r\n\r\nActivityParticipationMap.displayName = \"ActivityParticipationMap\";\r\n\r\nexport default ActivityParticipationMap;\r\n","import { formatTrademarkSymbols } from \"@/lib/textFormatting\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Store, Loader2, Check } from \"lucide-react\";\r\nimport { useLocalizedContent } from \"@/hooks/useLocalizedContent\";\r\n\r\ninterface Restaurant {\r\n  id: string;\r\n  name: string;\r\n  name_en: string | null;\r\n  name_pt: string | null;\r\n  type: string[];\r\n  type_en: string[] | null;\r\n  type_pt: string[] | null;\r\n  address: string;\r\n  image_url: string | null;\r\n}\r\n\r\ninterface SelectRestaurantsDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  restaurants: Restaurant[];\r\n  participatingRestaurantIds: string[];\r\n  onConfirm: (selectedRestaurantIds: string[]) => void;\r\n  isPending: boolean;\r\n  isParticipating: boolean;\r\n}\r\n\r\nconst SelectRestaurantsDialog = ({\r\n  open,\r\n  onOpenChange,\r\n  restaurants,\r\n  participatingRestaurantIds,\r\n  onConfirm,\r\n  isPending,\r\n  isParticipating,\r\n}: SelectRestaurantsDialogProps) => {\r\n  const { t } = useTranslation();\r\n  const { localizeRestaurant } = useLocalizedContent();\r\n  const [selectedRestaurantIds, setSelectedRestaurantIds] = useState<string[]>([]);\r\n\r\n  // Reset selected restaurants when dialog opens or participatingRestaurantIds changes\r\n  useEffect(() => {\r\n    if (open) {\r\n      setSelectedRestaurantIds(participatingRestaurantIds);\r\n    }\r\n  }, [open, participatingRestaurantIds]);\r\n\r\n  const handleToggleRestaurant = (restaurantId: string) => {\r\n    setSelectedRestaurantIds((prev) =>\r\n      prev.includes(restaurantId)\r\n        ? prev.filter((id) => id !== restaurantId)\r\n        : [...prev, restaurantId]\r\n    );\r\n  };\r\n\r\n  const handleSelectAll = () => {\r\n    if (selectedRestaurantIds.length === restaurants.length) {\r\n      setSelectedRestaurantIds([]);\r\n    } else {\r\n      setSelectedRestaurantIds(restaurants.map((r) => r.id));\r\n    }\r\n  };\r\n\r\n  const handleConfirm = () => {\r\n    onConfirm(selectedRestaurantIds);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-hidden flex flex-col\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <Store className=\"w-5 h-5\" />\r\n            选择参与的餐厅\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            勾选要参与活动的餐厅，取消勾选将退出活动\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"flex-1 overflow-y-auto space-y-4 py-4\">\r\n          {/* Select All */}\r\n          <div className=\"flex items-center gap-2 pb-2 border-b\">\r\n            <Checkbox\r\n              id=\"select-all\"\r\n              checked={selectedRestaurantIds.length === restaurants.length}\r\n              onCheckedChange={handleSelectAll}\r\n            />\r\n            <Label htmlFor=\"select-all\" className=\"cursor-pointer font-semibold\">\r\n              全选/取消全选 ({selectedRestaurantIds.length}/{restaurants.length})\r\n            </Label>\r\n          </div>\r\n\r\n          {/* Restaurant List */}\r\n          <div className=\"space-y-3\">\r\n            {restaurants.map((restaurant) => {\r\n              const localizedRestaurant = localizeRestaurant(restaurant);\r\n              const isSelected = selectedRestaurantIds.includes(restaurant.id);\r\n              const wasParticipating = participatingRestaurantIds.includes(restaurant.id);\r\n\r\n              return (\r\n                <Card\r\n                  key={restaurant.id}\r\n                  className={`transition-all ${\r\n                    isSelected\r\n                      ? \"border-primary bg-primary/5\"\r\n                      : \"border-border hover:border-primary/50\"\r\n                  }`}\r\n                >\r\n                  <CardContent className=\"p-4\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Checkbox\r\n                        id={restaurant.id}\r\n                        checked={isSelected}\r\n                        onCheckedChange={() => handleToggleRestaurant(restaurant.id)}\r\n                      />\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <Label\r\n                          htmlFor={restaurant.id}\r\n                          className=\"cursor-pointer flex items-center gap-2\"\r\n                        >\r\n                          <span className=\"font-semibold truncate\">\r\n                            {formatTrademarkSymbols(localizedRestaurant.name)}\r\n                          </span>\r\n                          {wasParticipating && (\r\n                            <Badge variant=\"secondary\" className=\"text-xs\">\r\n                              <Check className=\"w-3 h-3 mr-1\" />\r\n                              已参与\r\n                            </Badge>\r\n                          )}\r\n                        </Label>\r\n                        <p className=\"text-sm text-muted-foreground truncate\">\r\n                          {restaurant.address}\r\n                        </p>\r\n                        {localizedRestaurant.type && localizedRestaurant.type.length > 0 && (\r\n                          <div className=\"flex gap-1 mt-1 flex-wrap\">\r\n                            {localizedRestaurant.type.slice(0, 2).map((type, index) => (\r\n                              <Badge\r\n                                key={index}\r\n                                variant=\"outline\"\r\n                                className=\"text-xs\"\r\n                              >\r\n                                {type}\r\n                              </Badge>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button\r\n            variant=\"outline\"\r\n            onClick={() => onOpenChange(false)}\r\n            disabled={isPending}\r\n          >\r\n            {t(\"common.cancel\")}\r\n          </Button>\r\n          <Button onClick={handleConfirm} disabled={isPending}>\r\n            {isPending ? (\r\n              <>\r\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                {t(\"common.loading\")}\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Check className=\"w-4 h-4 mr-2\" />\r\n                确认 ({selectedRestaurantIds.length})\r\n              </>\r\n            )}\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default SelectRestaurantsDialog;\r\n","import { useState, useEffect } from \"react\";\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Loader2, BookOpen, Edit, Save } from \"lucide-react\";\r\nimport { useGlobalHandbook, useUpdateGlobalHandbook } from \"@/hooks/useGlobalHandbook\";\r\nimport { useUserRole } from \"@/hooks/useUserRole\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { RichTextEditor } from \"@/components/admin/RichTextEditor\";\r\n\r\ninterface GlobalHandbookDialogProps {\r\n  children: React.ReactNode;\r\n}\r\n\r\nconst GlobalHandbookDialog = ({ children }: GlobalHandbookDialogProps) => {\r\n  const { t, i18n } = useTranslation();\r\n  const { isAdmin } = useUserRole();\r\n  const { data: handbook, isLoading } = useGlobalHandbook();\r\n  const updateHandbook = useUpdateGlobalHandbook();\r\n  \r\n  const [open, setOpen] = useState(false);\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [activeTab, setActiveTab] = useState(\"zh\");\r\n  const [contentZh, setContentZh] = useState(\"\");\r\n  const [contentEn, setContentEn] = useState(\"\");\r\n  const [contentPt, setContentPt] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    if (handbook) {\r\n      setContentZh(handbook.content_zh);\r\n      setContentEn(handbook.content_en);\r\n      setContentPt(handbook.content_pt);\r\n    }\r\n  }, [handbook]);\r\n\r\n  const getLocalizedContent = () => {\r\n    if (!handbook) return \"\";\r\n    const lang = i18n.language;\r\n    if (lang === \"zh\") return handbook.content_zh || handbook.content_en || handbook.content_pt || \"\";\r\n    if (lang === \"pt\") return handbook.content_pt || handbook.content_en || handbook.content_zh || \"\";\r\n    return handbook.content_en || handbook.content_zh || handbook.content_pt || \"\";\r\n  };\r\n\r\n  const hasContent = handbook && (handbook.content_zh || handbook.content_en || handbook.content_pt);\r\n\r\n  const handleSave = async () => {\r\n    if (!handbook) return;\r\n    \r\n    try {\r\n      await updateHandbook.mutateAsync({\r\n        id: handbook.id,\r\n        content_zh: contentZh,\r\n        content_en: contentEn,\r\n        content_pt: contentPt,\r\n      });\r\n      toast({\r\n        title: t(\"common.success\"),\r\n        description: t(\"activities.handbook.updateSuccess\"),\r\n      });\r\n      setIsEditing(false);\r\n    } catch (error) {\r\n      toast({\r\n        title: t(\"common.error\"),\r\n        description: t(\"activities.handbook.updateError\"),\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        {children}\r\n      </DialogTrigger>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <div className=\"flex items-center gap-2\">\r\n            <BookOpen className=\"w-5 h-5 text-primary\" />\r\n            <DialogTitle>{t(\"activities.handbook.title\")}</DialogTitle>\r\n          </div>\r\n        </DialogHeader>\r\n        \r\n        {isLoading ? (\r\n          <div className=\"flex justify-center py-8\">\r\n            <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\r\n          </div>\r\n        ) : isEditing && isAdmin ? (\r\n          <div className=\"space-y-4\">\r\n            <Tabs value={activeTab} onValueChange={setActiveTab}>\r\n              <TabsList className=\"grid w-full grid-cols-3\">\r\n                <TabsTrigger value=\"zh\">中文</TabsTrigger>\r\n                <TabsTrigger value=\"en\">English</TabsTrigger>\r\n                <TabsTrigger value=\"pt\">Português</TabsTrigger>\r\n              </TabsList>\r\n              \r\n              <TabsContent value=\"zh\" className=\"mt-4\">\r\n                <RichTextEditor\r\n                  value={contentZh}\r\n                  onChange={setContentZh}\r\n                  placeholder=\"请输入中文活动手册内容...\"\r\n                />\r\n              </TabsContent>\r\n              \r\n              <TabsContent value=\"en\" className=\"mt-4\">\r\n                <RichTextEditor\r\n                  value={contentEn}\r\n                  onChange={setContentEn}\r\n                  placeholder=\"Enter English activity handbook content...\"\r\n                />\r\n              </TabsContent>\r\n              \r\n              <TabsContent value=\"pt\" className=\"mt-4\">\r\n                <RichTextEditor\r\n                  value={contentPt}\r\n                  onChange={setContentPt}\r\n                  placeholder=\"Digite o conteúdo do manual da atividade em português...\"\r\n                />\r\n              </TabsContent>\r\n            </Tabs>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {hasContent ? (\r\n              <div \r\n                className=\"prose prose-sm dark:prose-invert max-w-none\"\r\n                dangerouslySetInnerHTML={{ __html: getLocalizedContent() }}\r\n              />\r\n            ) : (\r\n              <div className=\"text-center py-8 text-muted-foreground\">\r\n                <BookOpen className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\r\n                <p>{t(\"activities.handbook.empty\")}</p>\r\n                {isAdmin && (\r\n                  <p className=\"text-sm mt-2\">{t(\"activities.handbook.addPrompt\")}</p>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n        \r\n        <DialogFooter className=\"gap-2 sm:gap-0\">\r\n          {isEditing ? (\r\n            <>\r\n              <Button variant=\"outline\" onClick={() => setIsEditing(false)}>\r\n                {t(\"common.cancel\")}\r\n              </Button>\r\n              <Button onClick={handleSave} disabled={updateHandbook.isPending}>\r\n                {updateHandbook.isPending ? (\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                ) : (\r\n                  <Save className=\"w-4 h-4 mr-2\" />\r\n                )}\r\n                {t(\"common.save\")}\r\n              </Button>\r\n            </>\r\n          ) : (\r\n            isAdmin && (\r\n              <Button onClick={() => setIsEditing(true)}>\r\n                <Edit className=\"w-4 h-4 mr-2\" />\r\n                {hasContent ? t(\"common.edit\") : t(\"activities.handbook.add\")}\r\n              </Button>\r\n            )\r\n          )}\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default GlobalHandbookDialog;\r\n","import { useState, useEffect } from \"react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\r\nimport { Share2, MessageCircle, Link2, Gift, Loader2, Instagram, CheckCircle } from \"lucide-react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { toast } from \"sonner\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { isIOSWebView, isInWebView, isAndroidWebView } from \"@/lib/externalLinks\";\r\nimport { smartShare } from \"@/lib/share\";\r\n\r\ninterface ShareForCouponDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  activityTitle: string;\r\n  activityId: string;\r\n  onShareComplete: () => void;\r\n  onShareAction?: () => void; // Called whenever user shares, regardless of coupon status\r\n  isProcessing?: boolean;\r\n  hasAlreadyClaimed?: boolean;\r\n}\r\n\r\nexport const ShareForCouponDialog = ({\r\n  open,\r\n  onOpenChange,\r\n  activityTitle,\r\n  activityId,\r\n  onShareComplete,\r\n  onShareAction,\r\n  isProcessing = false,\r\n  hasAlreadyClaimed = false,\r\n}: ShareForCouponDialogProps) => {\r\n  const { t } = useTranslation();\r\n  const isMobile = useIsMobile();\r\n  const [hasShared, setHasShared] = useState(false);\r\n  const [supportsNativeShare, setSupportsNativeShare] = useState(false);\r\n  const isWebView = isIOSWebView() || isAndroidWebView();\r\n\r\n  useEffect(() => {\r\n    setSupportsNativeShare(\r\n      typeof navigator !== 'undefined' && \r\n      !!navigator.share && \r\n      typeof navigator.canShare === 'function' &&\r\n      !isWebView // Don't use native share in WebView\r\n    );\r\n  }, [isWebView]);\r\n\r\n  const handleCopyLink = async () => {\r\n    try {\r\n      await navigator.clipboard.writeText(window.location.href);\r\n      toast.success(t(\"common.linkCopied\"));\r\n      setHasShared(true);\r\n      // Trigger share action callback\r\n      onShareAction?.();\r\n    } catch (error) {\r\n      console.error(\"Error copying link:\", error);\r\n      toast.error(t(\"common.shareError\"));\r\n    }\r\n  };\r\n\r\n  const handleShareToPlatform = (platform: string) => {\r\n    const url = encodeURIComponent(window.location.href);\r\n    const text = encodeURIComponent(`${activityTitle} - Xiaoxiong Market`);\r\n\r\n    let shareUrl = \"\";\r\n    switch (platform) {\r\n      case \"whatsapp\":\r\n        shareUrl = `https://wa.me/?text=${text}%20${url}`;\r\n        break;\r\n      case \"facebook\":\r\n        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;\r\n        break;\r\n      case \"twitter\":\r\n        shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;\r\n        break;\r\n      case \"telegram\":\r\n        shareUrl = `https://t.me/share/url?url=${url}&text=${text}`;\r\n        break;\r\n      case \"linkedin\":\r\n        shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;\r\n        break;\r\n      case \"reddit\":\r\n        shareUrl = `https://reddit.com/submit?url=${url}&title=${text}`;\r\n        break;\r\n      case \"line\":\r\n        shareUrl = `https://social-plugins.line.me/lineit/share?url=${url}`;\r\n        break;\r\n      case \"wechat\":\r\n        handleCopyLink();\r\n        toast.info(t(\"sharing.copiedForWeChat\"));\r\n        return;\r\n      case \"instagram\":\r\n        handleCopyLink();\r\n        toast.info(t(\"sharing.copiedForInstagram\"));\r\n        return;\r\n      default:\r\n        return;\r\n    }\r\n\r\n    // Use appropriate method based on environment\r\n    if (isIOSWebView() || isInWebView()) {\r\n      window.location.href = shareUrl;\r\n    } else {\r\n      window.open(shareUrl, \"_blank\", \"noopener,noreferrer\");\r\n    }\r\n    setHasShared(true);\r\n    // Trigger share action callback\r\n    onShareAction?.();\r\n  };\r\n\r\n  const handleNativeShare = async () => {\r\n    const shareData = {\r\n      title: activityTitle,\r\n      text: `${activityTitle} - Xiaoxiong Market`,\r\n      url: window.location.href,\r\n    };\r\n\r\n    // In WebView, directly copy to clipboard\r\n    if (isWebView) {\r\n      await handleCopyLink();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {\r\n        await navigator.share(shareData);\r\n        setHasShared(true);\r\n        // Trigger share action callback\r\n        onShareAction?.();\r\n      } else {\r\n        handleCopyLink();\r\n      }\r\n    } catch (error) {\r\n      if ((error as Error).name !== \"AbortError\") {\r\n        console.error(\"Error sharing:\", error);\r\n        toast.error(t(\"common.shareError\"));\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleConfirmShare = () => {\r\n    if (hasShared) {\r\n      onShareComplete();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"sm:max-w-md\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            {hasAlreadyClaimed ? (\r\n              <CheckCircle className=\"w-5 h-5 text-primary\" />\r\n            ) : (\r\n              <Gift className=\"w-5 h-5 text-primary\" />\r\n            )}\r\n            {t(\"shareDialog.title\")}\r\n          </DialogTitle>\r\n          <DialogDescription className=\"space-y-2\">\r\n            {hasAlreadyClaimed ? (\r\n              <p className=\"text-primary font-medium\">{t(\"shareDialog.alreadyShared\")}</p>\r\n            ) : (\r\n              <>\r\n                <p>{t(\"shareDialog.description\")}</p>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  {t(\"shareDialog.hint\")}\r\n                </p>\r\n              </>\r\n            )}\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-4\">\r\n          {/* Share options */}\r\n          <div className=\"flex flex-col gap-2\">\r\n            {/* On mobile with native share support, show native share as primary option */}\r\n            {isMobile && supportsNativeShare ? (\r\n              <Button onClick={handleNativeShare} className=\"w-full\" variant=\"default\">\r\n                <Share2 className=\"w-4 h-4 mr-2\" />\r\n                {t(\"sharing.shareToApps\")}\r\n              </Button>\r\n            ) : (\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button className=\"w-full\" variant=\"default\">\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    {t(\"sharing.selectPlatform\")}\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent className=\"w-56\">\r\n                  {supportsNativeShare && (\r\n                    <>\r\n                      <DropdownMenuItem onClick={handleNativeShare}>\r\n                        <Share2 className=\"w-4 h-4 mr-2\" />\r\n                        {t(\"sharing.systemShare\")}\r\n                      </DropdownMenuItem>\r\n                      <DropdownMenuSeparator />\r\n                    </>\r\n                  )}\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"wechat\")}>\r\n                    <MessageCircle className=\"w-4 h-4 mr-2\" />\r\n                    WeChat\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"instagram\")}>\r\n                    <Instagram className=\"w-4 h-4 mr-2\" />\r\n                    Instagram\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"whatsapp\")}>\r\n                    <MessageCircle className=\"w-4 h-4 mr-2\" />\r\n                    WhatsApp\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"facebook\")}>\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    Facebook\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"twitter\")}>\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    X (Twitter)\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"telegram\")}>\r\n                    <MessageCircle className=\"w-4 h-4 mr-2\" />\r\n                    Telegram\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"linkedin\")}>\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    LinkedIn\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"line\")}>\r\n                    <MessageCircle className=\"w-4 h-4 mr-2\" />\r\n                    LINE\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleShareToPlatform(\"reddit\")}>\r\n                    <Share2 className=\"w-4 h-4 mr-2\" />\r\n                    Reddit\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuSeparator />\r\n                  <DropdownMenuItem onClick={handleCopyLink}>\r\n                    <Link2 className=\"w-4 h-4 mr-2\" />\r\n                    {t(\"common.copyLink\")}\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            )}\r\n          </div>\r\n\r\n          {/* Confirm button - only show if not already claimed */}\r\n          {!hasAlreadyClaimed && (\r\n            <Button\r\n              onClick={handleConfirmShare}\r\n              disabled={!hasShared || isProcessing}\r\n              className=\"w-full\"\r\n              variant={hasShared ? \"default\" : \"secondary\"}\r\n            >\r\n              {isProcessing ? (\r\n                <>\r\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                  {t(\"shareDialog.claiming\")}\r\n                </>\r\n              ) : hasShared ? (\r\n                <>\r\n                  <Gift className=\"w-4 h-4 mr-2\" />\r\n                  {t(\"shareDialog.confirmButton\")}\r\n                </>\r\n              ) : (\r\n                t(\"shareDialog.shareFirst\")\r\n              )}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n","import { useState, useEffect, useCallback } from \"react\";\r\nimport { Forward } from \"lucide-react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useQueryClient } from \"@tanstack/react-query\";\r\n\r\ninterface ActivityShareCountProps {\r\n  activityId: string;\r\n  initialCount?: number;\r\n}\r\n\r\nexport const ActivityShareCount = ({ activityId, initialCount = 0 }: ActivityShareCountProps) => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  const [count, setCount] = useState(initialCount);\r\n\r\n  // Function to fetch fresh count\r\n  const fetchCount = useCallback(async () => {\r\n    const { count: newCount } = await supabase\r\n      .from(\"activity_shares\")\r\n      .select(\"*\", { count: \"exact\", head: true })\r\n      .eq(\"activity_id\", activityId);\r\n    \r\n    if (newCount !== null) {\r\n      setCount(newCount);\r\n    }\r\n  }, [activityId]);\r\n\r\n  // Sync with initial value changes (from query invalidation)\r\n  useEffect(() => {\r\n    setCount(initialCount);\r\n  }, [initialCount]);\r\n\r\n  // Subscribe to realtime updates\r\n  useEffect(() => {\r\n    const channel = supabase\r\n      .channel(`share-count-${activityId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'activity_shares',\r\n          filter: `activity_id=eq.${activityId}`\r\n        },\r\n        () => {\r\n          // Fetch updated count when any change occurs\r\n          fetchCount();\r\n          // Also invalidate the query cache\r\n          queryClient.invalidateQueries({ queryKey: [\"shareCount\", activityId] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [activityId, fetchCount, queryClient]);\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-2 whitespace-nowrap\">\r\n      <Forward className=\"w-4 h-4 shrink-0\" />\r\n      <span>{count} {t(\"activities.shareCount\")}</span>\r\n    </div>\r\n  );\r\n};\r\n","import { useState, useEffect, useCallback } from \"react\";\r\nimport { Users } from \"lucide-react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useQueryClient } from \"@tanstack/react-query\";\r\n\r\ninterface ActivitySubscriberCountProps {\r\n  activityId: string;\r\n  initialCount?: number;\r\n}\r\n\r\nexport const ActivitySubscriberCount = ({ activityId, initialCount = 0 }: ActivitySubscriberCountProps) => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  const [count, setCount] = useState(initialCount);\r\n\r\n  // Function to fetch fresh count\r\n  const fetchCount = useCallback(async () => {\r\n    const { count: newCount } = await supabase\r\n      .from(\"subscriptions\")\r\n      .select(\"*\", { count: \"exact\", head: true })\r\n      .eq(\"activity_id\", activityId);\r\n    \r\n    if (newCount !== null) {\r\n      setCount(newCount);\r\n    }\r\n  }, [activityId]);\r\n\r\n  // Sync with initial value changes (from query invalidation)\r\n  useEffect(() => {\r\n    setCount(initialCount);\r\n  }, [initialCount]);\r\n\r\n  // Subscribe to realtime updates\r\n  useEffect(() => {\r\n    const channel = supabase\r\n      .channel(`subscriber-count-${activityId}`)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'subscriptions',\r\n          filter: `activity_id=eq.${activityId}`\r\n        },\r\n        () => {\r\n          // Fetch updated count when any change occurs\r\n          fetchCount();\r\n          // Also invalidate the query cache\r\n          queryClient.invalidateQueries({ queryKey: [\"subscriberCount\", activityId] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [activityId, fetchCount, queryClient]);\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-2 whitespace-nowrap\">\r\n      <Users className=\"w-4 h-4 shrink-0\" />\r\n      <span>{count} {t(\"activities.subscribersCount\")}</span>\r\n    </div>\r\n  );\r\n};\r\n","import { formatTrademarkSymbols } from \"@/lib/textFormatting\";\r\nimport { useParams, Link, useLocation, useNavigate } from \"react-router-dom\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"@/components/ui/dropdown-menu\";\r\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\r\nimport { Calendar, Users, MapPin, Star, ChevronLeft, Loader2, Check, Store, ChevronDown, ChevronUp, Navigation, Share2, ShieldAlert, Link2, MessageCircle, UtensilsCrossed, ShoppingBag, ExternalLink, BookOpen, Gift, Tag, UserCircle, FileText, Heart, FileEdit } from \"lucide-react\";\r\nimport ExternalLinkConfirmDialog from \"@/components/ExternalLinkConfirmDialog\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\r\nimport platformLogo from \"@/assets/xiaoxiong-logo-v3.png\";\r\nimport i18n from \"@/i18n/config\";\r\nimport React, { useMemo, useCallback, useState } from \"react\";\r\nimport { useQueryClient } from \"@tanstack/react-query\";\r\nimport { PullToRefresh } from \"@/components/PullToRefresh\";\r\nimport { useActivity, useActivityRestaurants, useToggleSubscription, useSubscriptions, useSubscriberCount, useShareCount, useActivityCreator, useRecordShare, ActivityCreator } from \"@/hooks/useActivities\";\r\nimport { useActivityDetailRealtime } from \"@/hooks/useActivityRealtime\";\r\nimport { useMerchantRestaurants, useMyParticipatingRestaurants, useToggleRestaurantParticipation } from \"@/hooks/useActivityParticipation\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useUserRole } from \"@/hooks/useUserRole\";\r\nimport { useProfile } from \"@/hooks/useProfile\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useLocalizedContent } from \"@/hooks/useLocalizedContent\";\r\nimport { format } from \"date-fns\";\r\nimport RestaurantComments from \"@/components/RestaurantComments\";\r\nimport ActivityParticipationMap from \"@/components/ActivityParticipationMap\";\r\nimport SelectRestaurantsDialog from \"@/components/SelectRestaurantsDialog\";\r\nimport ReportDialog from \"@/components/ReportDialog\";\r\nimport ActivityTermsAgreement from \"@/components/ActivityTermsAgreement\";\r\nimport GlobalHandbookDialog from \"@/components/GlobalHandbookDialog\";\r\nimport LocationPermissionDialog from \"@/components/LocationPermissionDialog\";\r\nimport { ShareForCouponDialog } from \"@/components/ShareForCouponDialog\";\r\nimport { getUserLocation, calculateDistance } from \"@/lib/geolocation\";\r\nimport { toast } from \"sonner\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useActivityCouponTemplates, useHasSharedCoupon, useClaimCouponFromTemplate, useGlobalShareCouponTemplate } from \"@/hooks/useCoupons\";\r\nimport { usePageView } from \"@/hooks/usePageView\";\r\nimport { ActivityDetailSkeleton } from \"@/components/skeletons\";\r\nimport { ActivityShareCount } from \"@/components/ActivityShareCount\";\r\nimport { ActivitySubscriberCount } from \"@/components/ActivitySubscriberCount\";\r\nimport { useSmartShare, ShareDrawer } from \"@/components/ShareDrawer\";\r\n\r\nconst ActivityDetail = () => {\r\n  const { id } = useParams<{ id: string }>();\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const { t } = useTranslation();\r\n  const { user } = useAuth();\r\n  const { isMerchant, isSupervisor, isAdmin } = useUserRole();\r\n  const { data: profile } = useProfile();\r\n  const { localizeActivity, localizeRestaurant, currentLang } = useLocalizedContent();\r\n  const isMobile = useIsMobile();\r\n  const [isRestaurantsOpen, setIsRestaurantsOpen] = React.useState(false);\r\n  const [showAllRestaurants, setShowAllRestaurants] = React.useState(false);\r\n  const [userLocation, setUserLocation] = React.useState<{ lat: number; lng: number } | null>(null);\r\n  const [locationEnabled, setLocationEnabled] = React.useState(false);\r\n  const [isLoadingLocation, setIsLoadingLocation] = React.useState(false);\r\n  const [selectRestaurantsDialogOpen, setSelectRestaurantsDialogOpen] = React.useState(false);\r\n  const [termsDialogOpen, setTermsDialogOpen] = React.useState(false);\r\n  const [showCouponHint, setShowCouponHint] = React.useState(true);\r\n  const [showShareDialog, setShowShareDialog] = React.useState(false);\r\n  const [showLocationDialog, setShowLocationDialog] = React.useState(false);\r\n  const [isClaimingCoupon, setIsClaimingCoupon] = React.useState(false);\r\n  const [showLoginDialog, setShowLoginDialog] = React.useState(false);\r\n  const [externalLinkDialogOpen, setExternalLinkDialogOpen] = React.useState(false);\r\n  const [pendingExternalUrl, setPendingExternalUrl] = React.useState<string | null>(null);\r\n  const queryClient = useQueryClient();\r\n  const { share: smartShareFn, DrawerComponent: SmartShareDrawer } = useSmartShare();\r\n\r\n  // Pull-to-refresh handler - clears cache and forces fresh data\r\n  const handleRefresh = useCallback(async () => {\r\n    // Clear caches first\r\n    queryClient.removeQueries({ queryKey: ['activity', id] });\r\n    queryClient.removeQueries({ queryKey: ['activity-restaurants', id] });\r\n    queryClient.removeQueries({ queryKey: ['subscriber-count', id] });\r\n    queryClient.removeQueries({ queryKey: ['share-count', id] });\r\n    queryClient.removeQueries({ queryKey: ['comments', id] });\r\n    \r\n    // Refetch with fresh data\r\n    await Promise.all([\r\n      queryClient.invalidateQueries({ queryKey: ['activity', id] }),\r\n      queryClient.invalidateQueries({ queryKey: ['activity-restaurants', id] }),\r\n      queryClient.invalidateQueries({ queryKey: ['subscriber-count', id] }),\r\n      queryClient.invalidateQueries({ queryKey: ['share-count', id] }),\r\n      queryClient.invalidateQueries({ queryKey: ['comments', id] }),\r\n    ]);\r\n  }, [queryClient, id]);\r\n\r\n  // Handler for external link with confirmation dialog (iOS compatible)\r\n  // Requires login first, consistent with restaurant detail page behavior\r\n  const handleExternalLinkClick = useCallback((websiteUrl: string) => {\r\n    try {\r\n      const url = new URL(websiteUrl);\r\n      if (user) {\r\n        url.searchParams.set('user_id', user.id);\r\n      }\r\n      setPendingExternalUrl(url.toString());\r\n      setExternalLinkDialogOpen(true);\r\n    } catch (e) {\r\n      console.error('Invalid URL:', e);\r\n    }\r\n  }, [user]);\r\n\r\n  const handleConfirmExternalLink = useCallback(() => {\r\n    if (pendingExternalUrl) {\r\n      // Use location.href for iOS WebView compatibility\r\n      // This ensures the link works in WeChat, TikTok, and other in-app browsers\r\n      const isIOSWebView = /iPad|iPhone|iPod/.test(navigator.userAgent) && \r\n        !/Safari\\//.test(navigator.userAgent) && \r\n        !(window as any).Capacitor?.isNativePlatform?.();\r\n      \r\n      if (isIOSWebView) {\r\n        window.location.href = pendingExternalUrl;\r\n      } else {\r\n        window.open(pendingExternalUrl, '_blank');\r\n      }\r\n    }\r\n    setExternalLinkDialogOpen(false);\r\n    setPendingExternalUrl(null);\r\n  }, [pendingExternalUrl]);\r\n\r\n  // Track page view\r\n  usePageView({ pageType: \"activity\", targetId: id });\r\n\r\n  // Enable realtime updates for this activity\r\n  useActivityDetailRealtime(id!);\r\n  \r\n  const { data: activityCouponTemplates = [] } = useActivityCouponTemplates(id!);\r\n  const { data: hasSharedCoupon = false } = useHasSharedCoupon(id!);\r\n  const { data: globalShareCouponTemplate } = useGlobalShareCouponTemplate();\r\n  const claimCoupon = useClaimCouponFromTemplate();\r\n  \r\n  // Check if there's any coupon available (activity-specific OR global share coupon)\r\n  const hasCouponAvailable = activityCouponTemplates.length > 0 || !!globalShareCouponTemplate;\r\n  \r\n  // Memoize marker click handler to prevent map reloading\r\n  const handleMarkerClick = React.useCallback((restaurantId: string) => {\r\n    navigate(`/restaurant/${restaurantId}`, {\r\n      state: { fromActivity: id }\r\n    });\r\n  }, [navigate, id]);\r\n  \r\n  // Determine where to go back based on where we came from\r\n  const backUrl = (location.state as { from?: string })?.from === \"admin\" \r\n    ? \"/admin/activities\" \r\n    : \"/activities\";\r\n\r\n  const { data: activity, isLoading: activityLoading } = useActivity(id!);\r\n  const { data: activityRestaurants, isLoading: restaurantsLoading } = useActivityRestaurants(id!);\r\n  const { data: subscriptions = [] } = useSubscriptions();\r\n  const subscribedIds = subscriptions.map(sub => sub.activity_id);\r\n  const { data: subscriberCount = 0 } = useSubscriberCount(id!);\r\n  const { data: shareCount = 0 } = useShareCount(id!);\r\n  const recordShare = useRecordShare();\r\n  const { data: creator } = useActivityCreator(activity?.creator_id);\r\n  const toggleSubscription = useToggleSubscription();\r\n\r\n  // For merchant/supervisor\r\n  const { data: myRestaurants = [] } = useMerchantRestaurants();\r\n  const { data: participatingRestaurantIds = [] } = useMyParticipatingRestaurants(id!);\r\n  const toggleParticipation = useToggleRestaurantParticipation();\r\n\r\n  const localizedActivity = activity ? localizeActivity(activity) : null;\r\n  const isSubscribed = activity ? subscribedIds.includes(activity.id) : false;\r\n  const isMerchantOrSupervisor = isMerchant || isSupervisor;\r\n\r\n  const handleToggleSubscription = useCallback(() => {\r\n    if (!user || !activity) {\r\n      return;\r\n    }\r\n    toggleSubscription.mutate(activity.id);\r\n  }, [user, activity, toggleSubscription]);\r\n\r\n  // Check participation status for button text\r\n  const participatingCount = myRestaurants.filter(r => \r\n    participatingRestaurantIds.includes(r.id)\r\n  ).length;\r\n  const hasParticipatingRestaurants = participatingCount > 0;\r\n  const allRestaurantsParticipating = participatingCount === myRestaurants.length;\r\n  const someRestaurantsParticipating = participatingCount > 0 && participatingCount < myRestaurants.length;\r\n\r\n  const handleToggleActivityParticipation = useCallback(() => {\r\n    if (!activity || !isMerchantOrSupervisor || myRestaurants.length === 0) return;\r\n    \r\n    // Open dialog to let supervisor select restaurants\r\n    if (isSupervisor) {\r\n      setSelectRestaurantsDialogOpen(true);\r\n    } else {\r\n      // For merchants, toggle all restaurants directly\r\n      if (hasParticipatingRestaurants) {\r\n        // Remove all merchant's restaurants from activity\r\n        for (const restaurant of myRestaurants) {\r\n          if (participatingRestaurantIds.includes(restaurant.id)) {\r\n            toggleParticipation.mutate({\r\n              activityId: activity.id,\r\n              restaurantId: restaurant.id,\r\n            });\r\n          }\r\n        }\r\n      } else {\r\n        // Add all merchant's restaurants to activity\r\n        for (const restaurant of myRestaurants) {\r\n          toggleParticipation.mutate({\r\n            activityId: activity.id,\r\n            restaurantId: restaurant.id,\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }, [activity, isMerchantOrSupervisor, myRestaurants, isSupervisor, hasParticipatingRestaurants, participatingRestaurantIds, toggleParticipation]);\r\n\r\n  const handleConfirmRestaurantSelection = useCallback((selectedRestaurantIds: string[]) => {\r\n    if (!activity) return;\r\n\r\n    // Determine which restaurants to add and which to remove\r\n    const toAdd = selectedRestaurantIds.filter(id => !participatingRestaurantIds.includes(id));\r\n    const toRemove = participatingRestaurantIds.filter(id => !selectedRestaurantIds.includes(id));\r\n\r\n    // Add restaurants\r\n    toAdd.forEach(restaurantId => {\r\n      toggleParticipation.mutate({\r\n        activityId: activity.id,\r\n        restaurantId,\r\n      });\r\n    });\r\n\r\n    // Remove restaurants\r\n    toRemove.forEach(restaurantId => {\r\n      toggleParticipation.mutate({\r\n        activityId: activity.id,\r\n        restaurantId,\r\n      });\r\n    });\r\n\r\n    setSelectRestaurantsDialogOpen(false);\r\n  }, [activity, participatingRestaurantIds, toggleParticipation]);\r\n\r\n  const handleRequestLocation = useCallback(() => {\r\n    setShowLocationDialog(true);\r\n  }, []);\r\n\r\n  const requestLocation = useCallback(async () => {\r\n    setShowLocationDialog(false);\r\n    setIsLoadingLocation(true);\r\n    try {\r\n      const position = await getUserLocation();\r\n      setUserLocation({\r\n        lat: position.coords.latitude,\r\n        lng: position.coords.longitude,\r\n      });\r\n      setLocationEnabled(true);\r\n      toast.success(t(\"map.locationEnabled\"));\r\n    } catch (error) {\r\n      console.error(\"Location error:\", error);\r\n      setLocationEnabled(false);\r\n    } finally {\r\n      setIsLoadingLocation(false);\r\n    }\r\n  }, [t]);\r\n\r\n  const handleDisableLocation = useCallback(() => {\r\n    setUserLocation(null);\r\n    setLocationEnabled(false);\r\n  }, []);\r\n\r\n  // Auto-hide coupon hint after 3 seconds\r\n  React.useEffect(() => {\r\n    if (user && hasCouponAvailable && !hasSharedCoupon && showCouponHint) {\r\n      const timer = setTimeout(() => {\r\n        setShowCouponHint(false);\r\n      }, 3000);\r\n\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [user, hasCouponAvailable, hasSharedCoupon, showCouponHint]);\r\n\r\n  const handleCopyLink = useCallback(async () => {\r\n    try {\r\n      await navigator.clipboard.writeText(window.location.href);\r\n      toast.success(t(\"common.linkCopied\"));\r\n    } catch (error) {\r\n      console.error(\"Error copying link:\", error);\r\n      toast.error(t(\"common.shareError\"));\r\n    }\r\n  }, [t]);\r\n\r\n  const handleNativeShare = useCallback(async () => {\r\n    if (!activity || !localizedActivity) return;\r\n    \r\n    smartShareFn({\r\n      title: localizedActivity.title,\r\n      text: `${localizedActivity.title} - Xiaoxiong Market\\n\\n${localizedActivity.content.replace(/<[^>]*>/g, '').substring(0, 200)}...`,\r\n      url: window.location.href,\r\n    }, () => {\r\n      toast.success(t(\"common.shareSuccess\"));\r\n    });\r\n  }, [activity, localizedActivity, smartShareFn, t]);\r\n\r\n  const handleShareClick = useCallback(() => {\r\n    if (!activity || !localizedActivity) return;\r\n    \r\n    // Check if user is logged in - always require login for share\r\n    if (!user) {\r\n      setShowLoginDialog(true);\r\n      return;\r\n    }\r\n    \r\n    // If user is logged in and coupon is available, show the share dialog\r\n    // Dialog will show \"already claimed\" state if user has already claimed\r\n    if (hasCouponAvailable) {\r\n      setShowShareDialog(true);\r\n    } else {\r\n      // For users with no coupon available, just do normal share\r\n      handleNativeShare();\r\n      // Record share for logged-in users\r\n      recordShare.mutateAsync({ activityId: id!, userId: user.id }).catch(() => {});\r\n    }\r\n  }, [activity, localizedActivity, user, hasCouponAvailable, handleNativeShare, recordShare, id]);\r\n\r\n  const handleShareComplete = useCallback(async () => {\r\n    if (!activity || !user) return;\r\n    \r\n    setIsClaimingCoupon(true);\r\n    try {\r\n      // Record share\r\n      await recordShare.mutateAsync({ activityId: id!, userId: user.id });\r\n      \r\n      // Claim coupon\r\n      const template = activityCouponTemplates.length > 0 \r\n        ? activityCouponTemplates[0] \r\n        : globalShareCouponTemplate;\r\n      \r\n      if (template) {\r\n        await claimCoupon.mutateAsync({\r\n          templateId: template.id,\r\n          activityId: id!,\r\n          source: \"share\",\r\n        });\r\n        toast.success(t(\"coupon.claimSuccess\"));\r\n      }\r\n      \r\n      setShowShareDialog(false);\r\n    } catch (error) {\r\n      console.error(\"Error claiming coupon:\", error);\r\n      toast.error(t(\"common.error\"));\r\n    } finally {\r\n      setIsClaimingCoupon(false);\r\n    }\r\n  }, [activity, user, recordShare, id, activityCouponTemplates, globalShareCouponTemplate, claimCoupon, t]);\r\n\r\n  // Handler for when user actually shares (regardless of coupon claim)\r\n  const handleShareAction = useCallback(() => {\r\n    if (!user || !id) return;\r\n    // Record share in background\r\n    recordShare.mutateAsync({ activityId: id, userId: user.id }).catch((error) => {\r\n      console.log(\"Share already recorded or error:\", error);\r\n    });\r\n  }, [user, id, recordShare]);\r\n\r\n  // Calculate distance for all restaurants and sort by distance if location is available, otherwise by rating\r\n  const filteredRestaurants = useMemo(() => {\r\n    if (!activityRestaurants) return [];\r\n    \r\n    // Calculate distance for all restaurants if user location is available\r\n    const restaurantsWithDistance = activityRestaurants.map((ar) => {\r\n      if (userLocation) {\r\n        const distance = calculateDistance(\r\n          userLocation.lat,\r\n          userLocation.lng,\r\n          Number(ar.restaurants.lat),\r\n          Number(ar.restaurants.lng)\r\n        );\r\n        return { ...ar, distance };\r\n      }\r\n      return { ...ar, distance: undefined as number | undefined };\r\n    });\r\n\r\n    // Sort by distance (nearest first) if location is available, otherwise by rating (highest first)\r\n    if (locationEnabled && userLocation) {\r\n      return restaurantsWithDistance.sort((a, b) => {\r\n        if (a.distance !== undefined && b.distance !== undefined) {\r\n          return a.distance - b.distance;\r\n        }\r\n        return 0;\r\n      });\r\n    }\r\n\r\n    // Sort by rating (highest first) when no location\r\n    return restaurantsWithDistance.sort((a, b) => {\r\n      const ratingA = Number(a.restaurants.rating) || 0;\r\n      const ratingB = Number(b.restaurants.rating) || 0;\r\n      return ratingB - ratingA;\r\n    });\r\n  }, [activityRestaurants, locationEnabled, userLocation]);\r\n\r\n  if (activityLoading) {\r\n    return <ActivityDetailSkeleton />;\r\n  }\r\n\r\n  // Draft activities should not be accessible to regular users - admins can preview\r\n  if (!activity || !localizedActivity || (activity.status === \"draft\" && !isAdmin)) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"text-xl text-muted-foreground\">{t(\"error.notFound\")}</p>\r\n          <Button asChild className=\"mt-4\">\r\n            <Link to={backUrl}>{t(\"common.back\")}</Link>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const startDate = new Date(activity.start_date);\r\n  const endDate = activity.end_date ? new Date(activity.end_date) : null;\r\n  // If no end_date, activity is ongoing indefinitely\r\n  const isOngoing = endDate ? new Date() <= endDate : new Date() >= startDate;\r\n\r\n  return (\r\n    <PullToRefresh onRefresh={handleRefresh}>\r\n    <div className=\"min-h-screen bg-secondary/20\">\r\n      {/* Hero Media */}\r\n      <div className=\"relative h-[33vh] overflow-hidden\">\r\n        {activity.media_type === \"video\" && activity.video_url ? (\r\n          <video\r\n            src={activity.video_url}\r\n            poster={activity.image_url || undefined}\r\n            className=\"w-full h-full object-cover\"\r\n            muted\r\n            loop\r\n            playsInline\r\n            autoPlay\r\n          />\r\n        ) : (\r\n          <img\r\n            src={activity.image_url || \"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=1200&q=80\"}\r\n            alt={localizedActivity.title}\r\n            className=\"w-full h-full object-cover\"\r\n          />\r\n        )}\r\n        <div className=\"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent\" />\r\n        \r\n        {/* Back Button */}\r\n        <Button\r\n          asChild\r\n          variant=\"secondary\"\r\n          size=\"icon\"\r\n          className=\"absolute top-4 left-4\"\r\n        >\r\n          <Link to={backUrl}>\r\n            <ChevronLeft className=\"w-5 h-5\" />\r\n          </Link>\r\n        </Button>\r\n        \r\n        {/* Terms Agreement Warning for Merchants/Supervisors */}\r\n        {user && isMerchantOrSupervisor && profile && !profile.activity_terms_agreed && (\r\n          <Link \r\n            to=\"/profile?tab=activities\"\r\n            className=\"absolute top-4 left-16 bg-destructive/95 backdrop-blur-sm text-destructive-foreground text-xs px-3 py-1.5 rounded-full shadow-lg whitespace-nowrap animate-pulse flex items-center gap-1.5 hover:bg-destructive transition-colors\"\r\n          >\r\n            <ShieldAlert className=\"w-3.5 h-3.5\" />\r\n            {t(\"activities.termsNotAgreed\")}\r\n          </Link>\r\n        )}\r\n        \r\n        {/* Top Right Actions */}\r\n        <div className=\"absolute top-4 right-4 flex gap-2 items-start\">\r\n          {/* Draft Preview Badge - only for admins */}\r\n          {activity.status === \"draft\" && isAdmin && (\r\n            <Badge variant=\"outline\" className=\"bg-amber-500/90 text-white border-amber-600\">\r\n              <FileEdit className=\"w-3 h-3 mr-1\" />\r\n              {t(\"admin.activities.draftPreview\")}\r\n            </Badge>\r\n          )}\r\n          {activity.pinned && (\r\n            <Badge className=\"bg-accent\">\r\n              {t(\"activities.pinned\")}\r\n            </Badge>\r\n          )}\r\n          \r\n          {/* Report Button */}\r\n          <ReportDialog\r\n            targetType=\"activity\"\r\n            targetId={activity.id}\r\n            onLoginRequired={() => setShowLoginDialog(true)}\r\n            trigger={\r\n              <Button\r\n                variant=\"secondary\"\r\n                size=\"icon\"\r\n                className=\"shadow-lg\"\r\n              >\r\n                <ShieldAlert className=\"w-5 h-5\" />\r\n              </Button>\r\n            }\r\n          />\r\n          \r\n          {/* Share Button with hint */}\r\n          <div className=\"relative\">\r\n            <Button\r\n              variant=\"secondary\"\r\n              size=\"icon\"\r\n              className=\"shadow-lg relative\"\r\n              onClick={handleShareClick}\r\n            >\r\n              <Share2 className=\"w-5 h-5\" />\r\n              {/* Small gift icon indicator when coupon is available */}\r\n              {hasCouponAvailable && !hasSharedCoupon && (\r\n                <span className=\"absolute -top-1 -right-1 bg-primary text-primary-foreground rounded-full w-4 h-4 flex items-center justify-center\">\r\n                  <Gift className=\"w-2.5 h-2.5\" />\r\n                </span>\r\n              )}\r\n              {/* Checkmark when already claimed */}\r\n              {hasCouponAvailable && hasSharedCoupon && (\r\n                <span className=\"absolute -top-1 -right-1 bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center\">\r\n                  <Check className=\"w-2.5 h-2.5\" />\r\n                </span>\r\n              )}\r\n            </Button>\r\n            \r\n            {/* Coupon hint for logged-in users who haven't shared */}\r\n            {user && hasCouponAvailable && !hasSharedCoupon && showCouponHint && (\r\n              <div className=\"absolute top-full right-0 mt-2 bg-primary/95 backdrop-blur-sm text-primary-foreground text-xs px-3 py-1.5 rounded-full shadow-lg whitespace-nowrap animate-pulse z-10\">\r\n                <Gift className=\"w-3 h-3 inline mr-1\" />\r\n                {t(\"activities.shareToGetCoupon\")}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"container mx-auto max-w-6xl px-4 -mt-20 relative z-10 pb-12\">\r\n        <Card className=\"shadow-large\">\r\n          <CardHeader className=\"relative\">\r\n            {/* Handbook Button - Desktop/Tablet: Top Right */}\r\n            <div className=\"hidden sm:block absolute top-4 right-4\">\r\n              <GlobalHandbookDialog>\r\n                <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\r\n                  <FileText className=\"w-4 h-4\" />\r\n                  {t(\"activities.handbook.button\")}\r\n                </Button>\r\n              </GlobalHandbookDialog>\r\n            </div>\r\n            \r\n            <div className=\"flex flex-col gap-4 sm:pr-32\">\r\n              <div className=\"flex items-center gap-2 flex-wrap\">\r\n                <Badge variant={isOngoing ? \"default\" : \"secondary\"}>\r\n                  {isOngoing ? t(\"activities.ongoing\") : t(\"activities.ended\")}\r\n                </Badge>\r\n                {activity.repeat_mode && activity.repeat_mode !== \"none\" && activity.repeat_mode !== \"days_before\" && (\r\n                  <Badge variant=\"outline\">\r\n                    {t(`activities.repeat.${activity.repeat_mode}`)}\r\n                  </Badge>\r\n                )}\r\n                {/* Service Type Badge */}\r\n                {activity.service_type && (\r\n                  <Badge variant=\"outline\" className=\"flex items-center gap-1.5\">\r\n                    {activity.service_type === \"dine_in\" && <UtensilsCrossed className=\"w-3.5 h-3.5\" />}\r\n                    {activity.service_type === \"takeaway\" && <ShoppingBag className=\"w-3.5 h-3.5\" />}\r\n                    {activity.service_type === \"both\" && (\r\n                      <>\r\n                        <UtensilsCrossed className=\"w-3.5 h-3.5\" />\r\n                        <ShoppingBag className=\"w-3.5 h-3.5\" />\r\n                      </>\r\n                    )}\r\n                    {t(`activities.serviceType.${activity.service_type}`)}\r\n                  </Badge>\r\n                )}\r\n                \r\n                {/* Handbook Button - Mobile: Inline with badges */}\r\n                <div className=\"sm:hidden\">\r\n                  <GlobalHandbookDialog>\r\n                    <Button variant=\"outline\" size=\"sm\" className=\"gap-1.5 h-7 px-2\">\r\n                      <FileText className=\"w-3.5 h-3.5\" />\r\n                      {t(\"activities.handbook.button\")}\r\n                    </Button>\r\n                  </GlobalHandbookDialog>\r\n                </div>\r\n              </div>\r\n              \r\n              <CardTitle className=\"text-3xl\">{localizedActivity.title}</CardTitle>\r\n\r\n              <div className=\"flex flex-col sm:flex-row sm:flex-wrap gap-x-6 gap-y-2 text-sm text-muted-foreground\">\r\n                <div className=\"flex items-center gap-2 whitespace-nowrap\">\r\n                  <Calendar className=\"w-4 h-4 shrink-0\" />\r\n                  <span>\r\n                    {format(startDate, \"PPP\")}\r\n                    {endDate && ` - ${format(endDate, \"PPP\")}`}\r\n                  </span>\r\n                </div>\r\n                <ActivitySubscriberCount \r\n                  activityId={id!} \r\n                  initialCount={subscriberCount} \r\n                />\r\n                <ActivityShareCount \r\n                  activityId={id!} \r\n                  initialCount={shareCount} \r\n                />\r\n                <div className=\"flex items-center gap-2 whitespace-nowrap\">\r\n                  <Store className=\"w-4 h-4 shrink-0\" />\r\n                  <span>{activityRestaurants?.length || 0} {t(\"activities.restaurantsParticipating\")}</span>\r\n                </div>\r\n                {/* Creator Info */}\r\n                <div className=\"flex items-center gap-2 whitespace-nowrap\">\r\n                  <UserCircle className=\"w-4 h-4 shrink-0\" />\r\n                  <span>{t(\"activities.creatorLabel\")}</span>\r\n                  {creator?.isAdmin ? (\r\n                    <div className=\"flex items-center gap-1\">\r\n                      <img src={platformLogo} alt=\"Platform\" className=\"w-4 h-4 rounded-full object-contain\" />\r\n                      <span className=\"font-medium\">{t(\"activities.createdByPlatform\")}</span>\r\n                    </div>\r\n                  ) : creator?.restaurant ? (\r\n                    <Link \r\n                      to={`/restaurant/${creator.restaurant.id}`}\r\n                      className=\"flex items-center gap-1\"\r\n                      onClick={(e) => e.stopPropagation()}\r\n                    >\r\n                      {creator.avatar_url ? (\r\n                        <Avatar className=\"w-4 h-4\">\r\n                          <AvatarImage src={creator.avatar_url} alt=\"Creator\" />\r\n                          <AvatarFallback className=\"text-[8px]\">\r\n                            {creator.restaurant.name.charAt(0)}\r\n                          </AvatarFallback>\r\n                        </Avatar>\r\n                      ) : (\r\n                        <div className=\"w-4 h-4 rounded-full bg-muted flex items-center justify-center\">\r\n                          <span className=\"text-[8px] font-medium\">\r\n                            {creator.restaurant.name.charAt(0)}\r\n                          </span>\r\n                        </div>\r\n                      )}\r\n                      <span className=\"text-primary font-medium hover:underline\">\r\n                        {(() => {\r\n                          const lang = i18n.language;\r\n                          if (lang === \"zh\") return creator.restaurant.name;\r\n                          if (lang === \"pt\") return creator.restaurant.name_pt || creator.restaurant.name_en || creator.restaurant.name;\r\n                          return creator.restaurant.name_en || creator.restaurant.name;\r\n                        })()}\r\n                      </span>\r\n                    </Link>\r\n                  ) : (\r\n                    <div className=\"flex items-center gap-1\">\r\n                      <img src={platformLogo} alt=\"Platform\" className=\"w-4 h-4 rounded-full object-contain\" />\r\n                      <span className=\"font-medium\">{t(\"activities.createdByPlatform\")}</span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Participation and Subscription buttons */}\r\n              {user && (\r\n                <div className=\"flex flex-col sm:flex-row gap-3 w-full sm:w-auto\">\r\n                  {/* Merchant/Supervisor participation button */}\r\n                  {isMerchantOrSupervisor && myRestaurants.length > 0 && (\r\n                    profile?.activity_terms_agreed ? (\r\n                      <Button\r\n                        onClick={handleToggleActivityParticipation}\r\n                        disabled={toggleParticipation.isPending}\r\n                        size=\"lg\"\r\n                        variant={hasParticipatingRestaurants ? \"outline\" : \"default\"}\r\n                        className=\"w-full sm:w-auto\"\r\n                      >\r\n                        {isSupervisor ? (\r\n                          <>\r\n                            <Store className=\"w-4 h-4 mr-2\" />\r\n                            选择参与的餐厅\r\n                          </>\r\n                        ) : (\r\n                          hasParticipatingRestaurants ? (\r\n                            <>\r\n                              <Check className=\"w-4 h-4 mr-2\" />\r\n                              退出活动\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <Store className=\"w-4 h-4 mr-2\" />\r\n                              参与活动\r\n                            </>\r\n                          )\r\n                        )}\r\n                      </Button>\r\n                    ) : (\r\n                      <Button\r\n                        onClick={() => setTermsDialogOpen(true)}\r\n                        size=\"lg\"\r\n                        variant=\"outline\"\r\n                        className=\"w-full sm:w-auto text-muted-foreground\"\r\n                      >\r\n                        {t(\"activities.agreeTermsFirst\")}\r\n                      </Button>\r\n                    )\r\n                  )}\r\n\r\n                  {/* Favorite button */}\r\n                  <Button\r\n                    onClick={handleToggleSubscription}\r\n                    disabled={toggleSubscription.isPending}\r\n                    size=\"lg\"\r\n                    variant={isSubscribed ? \"outline\" : \"secondary\"}\r\n                    className=\"w-full sm:w-auto\"\r\n                  >\r\n                    {isSubscribed ? (\r\n                      <>\r\n                        <Heart className=\"w-4 h-4 mr-2 fill-current\" />\r\n                        {t(\"activities.favorited\") || \"已收藏\"}\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <Heart className=\"w-4 h-4 mr-2\" />\r\n                        {t(\"activities.favorite\") || \"收藏活动\"}\r\n                      </>\r\n                    )}\r\n                  </Button>\r\n                </div>\r\n              )}\r\n\r\n\r\n              {!user && (\r\n                <div className=\"space-y-2\">\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {t(\"activities.signInToJoin\")}\r\n                  </p>\r\n                  <p className=\"text-xs text-muted-foreground/80 flex items-center gap-1.5\">\r\n                    <Users className=\"w-3.5 h-3.5\" />\r\n                    {t(\"activities.signInToJoinHint\")}\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </CardHeader>\r\n\r\n          <CardContent className=\"space-y-6\">\r\n            {/* Activity Content */}\r\n            <div>\r\n              <h2 className=\"text-2xl font-bold mb-4\">{t(\"activities.about\")}</h2>\r\n              <div \r\n                className=\"prose prose-sm max-w-none text-muted-foreground\r\n                  prose-headings:text-foreground prose-headings:font-semibold\r\n                  prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg\r\n                  prose-p:leading-relaxed prose-p:my-3\r\n                  prose-strong:text-foreground prose-strong:font-semibold\r\n                  prose-ul:my-3 prose-ol:my-3\r\n                  prose-li:my-1\r\n                  prose-a:text-primary prose-a:no-underline hover:prose-a:underline\r\n                  [&_*]:!text-inherit [&_span[style*='color']]:!text-muted-foreground\"\r\n                dangerouslySetInnerHTML={{ __html: localizedActivity.content }}\r\n              />\r\n            </div>\r\n\r\n            {/* Usage Instructions - Only show if content exists */}\r\n            {localizedActivity.usage_instructions && (\r\n              <>\r\n                <Separator />\r\n                <div>\r\n                  <h2 className=\"text-2xl font-bold mb-4 flex items-center gap-2\">\r\n                    <BookOpen className=\"w-6 h-6 text-primary\" />\r\n                    {t(\"activities.usageInstructions\")}\r\n                  </h2>\r\n                  <div \r\n                    className=\"prose prose-sm max-w-none text-muted-foreground\r\n                      prose-headings:text-foreground prose-headings:font-semibold\r\n                      prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg\r\n                      prose-p:leading-relaxed prose-p:my-3\r\n                      prose-strong:text-foreground prose-strong:font-semibold\r\n                      prose-ul:my-3 prose-ol:my-3\r\n                      prose-li:my-1\r\n                      prose-a:text-primary prose-a:no-underline hover:prose-a:underline\"\r\n                    dangerouslySetInnerHTML={{ __html: localizedActivity.usage_instructions }}\r\n                  />\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n\r\n            <Separator />\r\n\r\n            {/* Participating Restaurants */}\r\n            {restaurantsLoading ? (\r\n              <div className=\"flex justify-center py-8\">\r\n                <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\r\n              </div>\r\n            ) : activityRestaurants && activityRestaurants.length > 0 ? (\r\n              <div className=\"space-y-6\">\r\n                {/* Collapsible Restaurant List - Now on top */}\r\n                <Collapsible open={isRestaurantsOpen} onOpenChange={setIsRestaurantsOpen}>\r\n                  <Card className=\"border-primary/20 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden\">\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CollapsibleTrigger asChild>\r\n                        <div className=\"flex items-center justify-between cursor-pointer group\">\r\n                          <CardTitle className=\"text-lg font-semibold flex items-center gap-2 transition-colors duration-200 group-hover:text-primary\">\r\n                            <Store className=\"w-5 h-5 transition-transform duration-300 group-hover:scale-110\" />\r\n                            {t(\"activities.participatingRestaurants\")}\r\n                          </CardTitle>\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <Badge variant=\"secondary\" className=\"transition-opacity duration-200\">\r\n                              {isRestaurantsOpen ? t(\"common.showLess\") : t(\"common.showDetails\")}\r\n                            </Badge>\r\n                            <div className=\"transition-transform duration-300 ease-in-out\" style={{ transform: isRestaurantsOpen ? 'rotate(180deg)' : 'rotate(0deg)' }}>\r\n                              <ChevronDown className=\"w-5 h-5 text-muted-foreground group-hover:text-primary\" />\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </CollapsibleTrigger>\r\n                    </CardHeader>\r\n                    <CollapsibleContent className=\"overflow-hidden transition-all duration-500 ease-in-out data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\">\r\n                      <CardContent className=\"pt-0 pb-6 space-y-4\">\r\n                        {/* Location sorting button */}\r\n                        <div className=\"flex items-center justify-end\">\r\n                          {locationEnabled ? (\r\n                            <Badge variant=\"default\" className=\"flex items-center gap-1.5\">\r\n                              <Navigation className=\"w-3.5 h-3.5\" />\r\n                              {t(\"activities.sortByLocationEnabled\")}\r\n                            </Badge>\r\n                          ) : (\r\n                            <Button\r\n                              variant=\"outline\"\r\n                              size=\"sm\"\r\n                              onClick={handleRequestLocation}\r\n                              disabled={isLoadingLocation}\r\n                            >\r\n                              {isLoadingLocation ? (\r\n                                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                              ) : (\r\n                                <Navigation className=\"w-4 h-4 mr-2\" />\r\n                              )}\r\n                              {t(\"activities.enableLocationSort\")}\r\n                            </Button>\r\n                          )}\r\n                        </div>\r\n                        {/* Restaurant list */}\r\n                        <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                          {(showAllRestaurants ? filteredRestaurants : filteredRestaurants.slice(0, 6)).map((ar, index) => {\r\n                            const restaurant = localizeRestaurant(ar.restaurants);\r\n                            return (\r\n                              <Card \r\n                                key={ar.id} \r\n                                className=\"overflow-hidden hover:shadow-lg transition-all duration-300 opacity-0 animate-fade-in h-full flex flex-col\"\r\n                                style={{ \r\n                                  animationDelay: `${index * 50}ms`,\r\n                                  animationFillMode: 'forwards'\r\n                                }}\r\n                              >\r\n                                <Link \r\n                                  to={`/restaurant/${ar.restaurant_id}`}\r\n                                  state={{ fromActivity: activity.id }}\r\n                                  className=\"block\"\r\n                                >\r\n                                  <div className=\"relative h-40 overflow-hidden flex-shrink-0\">\r\n                                    <img\r\n                                      src={ar.restaurants.image_url || \"https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&q=80\"}\r\n                                      alt={restaurant.name}\r\n                                      className=\"w-full h-full object-cover transition-transform hover:scale-105\"\r\n                                    />\r\n                                    {restaurant.type && restaurant.type.length > 0 && (\r\n                                      <div className=\"absolute top-2 left-2 flex flex-wrap gap-1\">\r\n                                        {restaurant.type.slice(0, 3).map((type: string, typeIndex: number) => (\r\n                                          <Badge key={typeIndex} className=\"bg-primary\">\r\n                                            {type}\r\n                                          </Badge>\r\n                                        ))}\r\n                                      </div>\r\n                                    )}\r\n                                  </div>\r\n                                </Link>\r\n                                <CardContent className=\"pt-4 pb-4 flex flex-col flex-grow\">\r\n                                  <Link \r\n                                    to={`/restaurant/${ar.restaurant_id}`}\r\n                                    state={{ fromActivity: activity.id }}\r\n                                    className=\"block\"\r\n                                  >\r\n                                    <h3 className=\"font-semibold text-lg mb-2 line-clamp-1 hover:text-primary transition-colors\">\r\n                                      {formatTrademarkSymbols(restaurant.name)}\r\n                                    </h3>\r\n                                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-3\">\r\n                                      <MapPin className=\"w-4 h-4 flex-shrink-0\" />\r\n                                      <span className=\"line-clamp-1\">{ar.restaurants.address}</span>\r\n                                    </div>\r\n                                  </Link>\r\n                                  {/* Rating and Distance */}\r\n                                  <div className=\"flex items-center justify-between pt-3 border-t border-border/50\">\r\n                                    <div className=\"flex items-center gap-1\">\r\n                                      <Star className={`w-4 h-4 ${ar.restaurants.rating ? \"fill-accent text-accent\" : \"text-muted-foreground\"}`} />\r\n                                      {ar.restaurants.rating ? (\r\n                                        <span className=\"font-semibold text-sm\">\r\n                                          {ar.restaurants.rating.toFixed(1)}\r\n                                        </span>\r\n                                      ) : (\r\n                                        <span className=\"text-xs text-muted-foreground text-center whitespace-nowrap\">\r\n                                          {t(\"restaurant.noRatingLine1\")}<br />{t(\"restaurant.noRatingLine2\")}\r\n                                        </span>\r\n                                      )}\r\n                                    </div>\r\n                                    {ar.distance !== undefined && (\r\n                                      <div className=\"flex items-center gap-1\">\r\n                                        <Navigation className=\"w-4 h-4 text-primary\" />\r\n                                        <span className=\"font-semibold text-sm text-foreground\">\r\n                                          {ar.distance.toFixed(1)} km\r\n                                        </span>\r\n                                      </div>\r\n                                    )}\r\n                                  </div>\r\n                                  {/* Order Online button */}\r\n                                  {ar.restaurants.website_url && (\r\n                                    <div className=\"flex gap-2 mt-3 pt-3 border-t border-border/50\">\r\n                                      <Button\r\n                                        size=\"sm\"\r\n                                        variant=\"outline\"\r\n                                        className=\"flex-1\"\r\n                                        onClick={() => handleExternalLinkClick(ar.restaurants.website_url!)}\r\n                                      >\r\n                                        <UtensilsCrossed className=\"w-4 h-4 mr-1\" />\r\n                                        {t(\"restaurant.orderOnline\")}\r\n                                      </Button>\r\n                                    </div>\r\n                                  )}\r\n                                </CardContent>\r\n                              </Card>\r\n                            );\r\n                          })}\r\n                        </div>\r\n                        \r\n                        {/* Show More Button */}\r\n                        {filteredRestaurants.length > 6 && !showAllRestaurants && (\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            className=\"w-full hover:bg-primary hover:text-primary-foreground transition-all duration-200\"\r\n                            onClick={() => setShowAllRestaurants(true)}\r\n                          >\r\n                            <ChevronDown className=\"w-4 h-4 mr-2\" />\r\n                            查看更多 ({filteredRestaurants.length - 6} 个餐厅)\r\n                          </Button>\r\n                        )}\r\n                      </CardContent>\r\n                    </CollapsibleContent>\r\n                  </Card>\r\n                </Collapsible>\r\n\r\n                {/* Participating Restaurants Map - Now below */}\r\n                <div>\r\n                  <h2 className=\"text-2xl font-bold flex items-center gap-2 mb-4\">\r\n                    <MapPin className=\"w-6 h-6\" />\r\n                    {t(\"activities.participatingRestaurants\")} ({filteredRestaurants.length})\r\n                  </h2>\r\n                  \r\n                  {/* Map showing filtered restaurants */}\r\n                  <ActivityParticipationMap \r\n                    restaurants={filteredRestaurants}\r\n                    onMarkerClick={handleMarkerClick}\r\n                  />\r\n                </div>\r\n              </div>\r\n            ) : null}\r\n\r\n\r\n            {/* Comments Section */}\r\n            <RestaurantComments restaurantId={activity.id} targetType=\"activity\" />\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Restaurant Selection Dialog for Supervisor */}\r\n      {isSupervisor && (\r\n        <SelectRestaurantsDialog\r\n          open={selectRestaurantsDialogOpen}\r\n          onOpenChange={setSelectRestaurantsDialogOpen}\r\n          restaurants={myRestaurants}\r\n          participatingRestaurantIds={participatingRestaurantIds}\r\n          onConfirm={handleConfirmRestaurantSelection}\r\n          isPending={toggleParticipation.isPending}\r\n          isParticipating={hasParticipatingRestaurants}\r\n        />\r\n      )}\r\n\r\n      {/* Activity Terms Agreement Dialog */}\r\n      {isMerchantOrSupervisor && (\r\n        <ActivityTermsAgreement\r\n          isAgreed={profile?.activity_terms_agreed || false}\r\n          agreedAt={profile?.activity_terms_agreed_at || null}\r\n          open={termsDialogOpen}\r\n          onOpenChange={setTermsDialogOpen}\r\n        />\r\n      )}\r\n\r\n\r\n      {/* Share for Coupon Dialog */}\r\n      <ShareForCouponDialog\r\n        open={showShareDialog}\r\n        onOpenChange={setShowShareDialog}\r\n        activityTitle={localizedActivity?.title || \"\"}\r\n        activityId={id!}\r\n        onShareComplete={handleShareComplete}\r\n        onShareAction={handleShareAction}\r\n        isProcessing={isClaimingCoupon}\r\n        hasAlreadyClaimed={hasSharedCoupon}\r\n      />\r\n\r\n      <LocationPermissionDialog\r\n        open={showLocationDialog}\r\n        onOpenChange={setShowLocationDialog}\r\n        onConfirm={requestLocation}\r\n      />\r\n\r\n      {/* Login Required Dialog */}\r\n      <AlertDialog open={showLoginDialog} onOpenChange={setShowLoginDialog}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>{t(\"activities.loginRequired\")}</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              {t(\"activities.loginRequiredMessage\")}\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>{t(\"common.cancel\")}</AlertDialogCancel>\r\n            <AlertDialogAction onClick={() => navigate(\"/auth\")}>\r\n              {t(\"activities.goToLogin\")}\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n\r\n      {/* External Link Confirmation Dialog - iOS compatible */}\r\n      <ExternalLinkConfirmDialog\r\n        open={externalLinkDialogOpen}\r\n        onOpenChange={setExternalLinkDialogOpen}\r\n        onConfirm={handleConfirmExternalLink}\r\n        url={pendingExternalUrl || undefined}\r\n      />\r\n      \r\n      {/* Smart Share Drawer for WebView environments */}\r\n      {SmartShareDrawer}\r\n    </div>\r\n    </PullToRefresh>\r\n  );\r\n};\r\n\r\nexport default ActivityDetail;\r\n"],"names":["ActivityDetailSkeleton","jsxs","jsx","Skeleton","Card","CardHeader","CardContent","i","ActivityParticipationMap","memo","restaurants","onMarkerClick","t","useTranslation","mapContainer","useRef","map","markers","mapLoaded","setMapLoaded","useState","mapError","setMapError","currentPopup","useEffect","MAPBOX_TOKEN","mapboxgl","isIOSDevice","isIOSWebView","initMap","rect","avgLat","sum","r","avgLng","e","error","marker","restaurant","lat","lng","popupContent","popup","el","mapIcon","markerElement","handleMarkerClick","bounds","AlertTriangle","Button","MapPin","SelectRestaurantsDialog","open","onOpenChange","participatingRestaurantIds","onConfirm","isPending","isParticipating","localizeRestaurant","useLocalizedContent","selectedRestaurantIds","setSelectedRestaurantIds","handleToggleRestaurant","restaurantId","prev","id","handleSelectAll","handleConfirm","Dialog","DialogContent","DialogHeader","DialogTitle","Store","DialogDescription","Checkbox","Label","localizedRestaurant","isSelected","wasParticipating","formatTrademarkSymbols","Badge","Check","type","index","DialogFooter","Fragment","Loader2","GlobalHandbookDialog","children","i18n","isAdmin","useUserRole","handbook","isLoading","useGlobalHandbook","updateHandbook","useUpdateGlobalHandbook","setOpen","isEditing","setIsEditing","activeTab","setActiveTab","contentZh","setContentZh","contentEn","setContentEn","contentPt","setContentPt","getLocalizedContent","lang","hasContent","handleSave","toast","DialogTrigger","BookOpen","Tabs","TabsList","TabsTrigger","TabsContent","RichTextEditor","Save","Edit","ShareForCouponDialog","activityTitle","activityId","onShareComplete","onShareAction","isProcessing","hasAlreadyClaimed","isMobile","useIsMobile","hasShared","setHasShared","supportsNativeShare","setSupportsNativeShare","isWebView","isAndroidWebView","handleCopyLink","handleShareToPlatform","platform","url","text","shareUrl","isInWebView","handleNativeShare","shareData","handleConfirmShare","CheckCircle","Gift","Share2","DropdownMenu","DropdownMenuTrigger","DropdownMenuContent","DropdownMenuItem","DropdownMenuSeparator","MessageCircle","Instagram","Link2","ActivityShareCount","initialCount","queryClient","useQueryClient","count","setCount","fetchCount","useCallback","newCount","supabase","channel","Forward","ActivitySubscriberCount","Users","ActivityDetail","useParams","location","useLocation","navigate","useNavigate","user","useAuth","isMerchant","isSupervisor","profile","useProfile","localizeActivity","currentLang","isRestaurantsOpen","setIsRestaurantsOpen","React","showAllRestaurants","setShowAllRestaurants","userLocation","setUserLocation","locationEnabled","setLocationEnabled","isLoadingLocation","setIsLoadingLocation","selectRestaurantsDialogOpen","setSelectRestaurantsDialogOpen","termsDialogOpen","setTermsDialogOpen","showCouponHint","setShowCouponHint","showShareDialog","setShowShareDialog","showLocationDialog","setShowLocationDialog","isClaimingCoupon","setIsClaimingCoupon","showLoginDialog","setShowLoginDialog","externalLinkDialogOpen","setExternalLinkDialogOpen","pendingExternalUrl","setPendingExternalUrl","smartShareFn","SmartShareDrawer","useSmartShare","handleRefresh","handleExternalLinkClick","websiteUrl","handleConfirmExternalLink","usePageView","useActivityDetailRealtime","activityCouponTemplates","useActivityCouponTemplates","hasSharedCoupon","useHasSharedCoupon","globalShareCouponTemplate","useGlobalShareCouponTemplate","claimCoupon","useClaimCouponFromTemplate","hasCouponAvailable","backUrl","activity","activityLoading","useActivity","activityRestaurants","restaurantsLoading","useActivityRestaurants","subscriptions","useSubscriptions","subscribedIds","sub","subscriberCount","useSubscriberCount","shareCount","useShareCount","recordShare","useRecordShare","creator","useActivityCreator","toggleSubscription","useToggleSubscription","myRestaurants","useMerchantRestaurants","useMyParticipatingRestaurants","toggleParticipation","useToggleRestaurantParticipation","localizedActivity","isSubscribed","isMerchantOrSupervisor","handleToggleSubscription","participatingCount","hasParticipatingRestaurants","handleToggleActivityParticipation","handleConfirmRestaurantSelection","toAdd","toRemove","handleRequestLocation","requestLocation","position","getUserLocation","timer","handleShareClick","handleShareComplete","template","handleShareAction","filteredRestaurants","useMemo","restaurantsWithDistance","ar","distance","calculateDistance","a","b","ratingA","Link","startDate","endDate","isOngoing","PullToRefresh","ChevronLeft","ShieldAlert","FileEdit","ReportDialog","FileText","UtensilsCrossed","ShoppingBag","CardTitle","Calendar","format","UserCircle","platformLogo","Avatar","AvatarImage","AvatarFallback","Heart","Separator","Collapsible","CollapsibleTrigger","ChevronDown","CollapsibleContent","Navigation","typeIndex","Star","RestaurantComments","ActivityTermsAgreement","LocationPermissionDialog","AlertDialog","AlertDialogContent","AlertDialogHeader","AlertDialogTitle","AlertDialogDescription","AlertDialogFooter","AlertDialogCancel","AlertDialogAction","ExternalLinkConfirmDialog"],"mappings":"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"}