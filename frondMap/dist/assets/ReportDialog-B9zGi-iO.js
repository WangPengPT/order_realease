import{c as fe,p as ge,s as g,k as Y,i as Z,ad as ee,ae as re,u as xe,r as d,j as e,D as ve,aa as je,B as C,t as ye,a4 as Ce,a5 as we,a6 as be,a7 as D,af as Ne,ag as Se,ah as _e,ai as De,aj as Ee,ak as Ue,I as H,X as J,N as Ie,O as Te,Q as ke,R as Fe,T as Ae,U as qe,V as Pe,W as ze,z as n}from"./index-DVul3rRI.js";import{I as Me,a as $e,b as z}from"./input-otp-Da-9DObi.js";import{S as Qe}from"./shield-alert-BR0zpY-U.js";import{P as Ve}from"./plus-D3nVzAkL.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=fe("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),Be=(m,x="restaurant",h)=>ge({queryKey:["comments",m,x],enabled:(h==null?void 0:h.enabled)!==!1&&!!m,queryFn:async()=>{const{data:l,error:r}=await g.from("comments").select("*").eq("target_id",m).eq("target_type",x).order("created_at",{ascending:!1});if(r)throw r;if(!l||l.length===0)return[];const i=[...new Set(l.map(a=>a.user_id))],{data:E}=await g.rpc("get_public_profiles",{user_ids:i}),v=new Map((E||[]).map(a=>[a.id,{display_name:a.display_name,avatar_url:a.avatar_url}])),U=l.filter(a=>!a.parent_id),w=l.filter(a=>a.parent_id),o=new Map;return w.forEach(a=>{const f=a.parent_id;o.has(f)||o.set(f,[]),o.get(f).push(a)}),U.map(a=>({...a,profiles:v.get(a.user_id),replies:(o.get(a.id)||[]).sort((f,y)=>new Date(f.created_at).getTime()-new Date(y.created_at).getTime()).map(f=>({...f,profiles:v.get(f.user_id)}))}))},staleTime:3e4}),We=()=>{const{user:m}=Y(),{toast:x}=Z(),h=ee();return re({mutationFn:async({targetId:l,targetType:r,content:i,ratingValue:E,priceRange:v,imageUrl:U,parentId:w})=>{if(!m)throw new Error("User not authenticated");const o={user_id:m.id,target_id:l,target_type:r,content:i,parent_id:w};w||(E&&(o.rating_value=E),v&&(o.price_range=v)),U&&(o.image_url=U);const{data:j,error:a}=await g.from("comments").insert(o).select().single();if(a)throw a;return j},onSuccess:(l,r)=>{h.invalidateQueries({queryKey:["comments",r.targetId,r.targetType]}),h.invalidateQueries({queryKey:["restaurants"]}),h.invalidateQueries({queryKey:["restaurant",r.targetId]}),x({title:"Success",description:"Comment added successfully"})},onError:()=>{x({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Ge=()=>{const{toast:m}=Z(),x=ee();return re({mutationFn:async h=>{const{error:l}=await g.from("comments").delete().eq("id",h);if(l)throw l},onSuccess:()=>{x.invalidateQueries({queryKey:["comments"]}),m({title:"Success",description:"Comment deleted successfully"})},onError:()=>{m({title:"Error",description:"Failed to delete comment",variant:"destructive"})}})},Xe=({targetType:m,targetId:x,trigger:h,onLoginRequired:l})=>{const{t:r}=xe(),{user:i}=Y(),[E,v]=d.useState(!1),[U,w]=d.useState(!1),[o,j]=d.useState(!1),[a,f]=d.useState(""),[y,O]=d.useState(""),[u,M]=d.useState((i==null?void 0:i.email)||""),[b,F]=d.useState([""]),[T,$]=d.useState([]),[K,L]=d.useState(!1),[Q,k]=d.useState("form"),[A,q]=d.useState(""),[N,V]=d.useState(0),[R,B]=d.useState(!1),te=t=>{if(t&&!i){l==null||l();return}v(t),t&&(i!=null&&i.email)&&M(i.email),t||(k("form"),q(""),V(0))};d.useEffect(()=>{let t;return N>0&&(t=setTimeout(()=>V(N-1),1e3)),()=>clearTimeout(t)},[N]);const se=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],ae=()=>{F([...b,""])},ie=t=>{F(b.filter((s,c)=>c!==t))},ne=(t,s)=>{const c=[...b];c[t]=s,F(c)},oe=t=>{const s=Array.from(t.target.files||[]);if(s.filter(p=>p.size>5*1024*1024).length>0){n.error(r("report.imageTooLarge"));return}const S=["image/jpeg","image/png","image/webp","image/gif"];if(s.filter(p=>!S.includes(p.type)).length>0){n.error(r("report.invalidImageType"));return}$(p=>[...p,...s])},le=t=>{$(s=>s.filter((c,S)=>S!==t))},ce=async()=>{if(T.length===0)return[];L(!0);const t=[];try{for(const s of T){const c=s.name.split(".").pop(),_=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${c}`}`,{error:p}=await g.storage.from("report-evidence").upload(_,s);if(p)throw p;const{data:P}=g.storage.from("report-evidence").getPublicUrl(_);t.push(P.publicUrl)}return t}catch(s){throw console.error("Error uploading images:",s),s}finally{L(!1)}},W=async()=>{if(!u.trim()){n.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u)){n.error(r("report.invalidEmail"));return}B(!0);try{const{error:t}=await g.functions.invoke("send-verification-code",{body:{email:u}});if(t){n.error(r("auth.verificationCodeFailed")),console.error(t);return}k("verify"),n.success(r("auth.verificationCodeSent")),V(30)}catch(t){n.error(t.message||r("error.general"))}finally{B(!1)}},de=async()=>{N>0||await W()},me=async()=>{if(A.length!==4){n.error(r("auth.invalidVerificationCode"));return}j(!0);try{const{data:t,error:s}=await g.functions.invoke("verify-email-code",{body:{email:u,code:A}});if(s||!(t!=null&&t.success)){(t==null?void 0:t.error)==="This verification code has already been used"?n.error(r("auth.verificationCodeUsed")):n.error((t==null?void 0:t.error)||r("auth.invalidVerificationCode")),j(!1);return}k("submitting"),await G()}catch(t){n.error(t.message||r("error.general")),j(!1)}},ue=async()=>{if(!a){n.error(r("report.reasonPlaceholder"));return}if(!y||y.length<20){n.error(r("report.detailsMin"));return}if(!u.trim()){n.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u)){n.error(r("report.invalidEmail"));return}if(b.filter(s=>s.trim()!=="").length===0&&T.length===0){n.error(r("report.evidenceRequired"));return}i?w(!0):await W()},G=async()=>{j(!0);try{let t=[];try{t=await ce()}catch{n.error(r("report.imageUploadFailed")),j(!1);return}const c=[...b.filter(I=>I.trim()!==""),...t],S={reporter_id:(i==null?void 0:i.id)||null,target_type:m,target_id:x,reason:a,description:y,evidence_urls:c,reporter_contact:u};console.log("Attempting to insert report:",S);const{data:_,error:p}=await g.from("reports").insert(S).select().single();if(console.log("Insert result:",{report:_,error:p}),p)throw p;let P="Anonymous",X=u;if(i){const{data:I}=await g.from("profiles").select("display_name").eq("id",i.id).single();P=(I==null?void 0:I.display_name)||"Unknown",X=i.email||u}await g.functions.invoke("send-report-email",{body:{reportId:_.id,reporterName:P,reporterEmail:X,targetType:m,targetId:x,reason:a,description:y,evidenceUrls:c.length>0?c:void 0,reporterContact:u||void 0}});const he=_.id.substring(0,8).toUpperCase();n.success(r("report.successDetailed",{reference:he}),{description:r("report.successDescription"),duration:8e3}),v(!1),w(!1),f(""),O(""),i||M(""),F([""]),$([]),k("form"),q("")}catch(t){console.error("Error submitting report:",t),n.error(r("report.failed"))}finally{j(!1)}},pe=()=>{switch(m){case"comment":return r("report.reportComment");case"restaurant":return r("report.reportRestaurant");case"activity":return r("report.reportActivity");case"user":return r("report.reportUser");default:return r("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(ve,{open:E,onOpenChange:te,children:[e.jsx(je,{asChild:!0,children:h||e.jsxs(C,{variant:"ghost",size:"sm",children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),r("report.title")]})}),e.jsxs(ye,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ce,{children:[e.jsx(we,{children:pe()}),e.jsx(be,{children:r(Q==="verify"?"auth.verificationCodeSent":"report.description")})]}),Q==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"reason",children:r("report.reason")}),e.jsxs(Ne,{value:a,onValueChange:f,children:[e.jsx(Se,{children:e.jsx(_e,{placeholder:r("report.reasonPlaceholder")})}),e.jsx(De,{children:se.map(t=>e.jsx(Ee,{value:t,children:r(`report.reasons.${t}`)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"description",children:r("report.detailsLabel")}),e.jsx(Ue,{id:"description",value:y,onChange:t=>O(t.target.value),placeholder:r("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y.length,"/20 ",r("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"contact",children:[r("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(H,{id:"contact",type:"email",value:u,onChange:t=>M(t.target.value),placeholder:r("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{children:[r("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:r("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"image-upload",className:"text-sm font-medium",children:r("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:T.map((t,s)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Evidence ${s+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(C,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>le(s),children:e.jsx(J,{className:"w-3 h-3"})})]},s))}),e.jsx(H,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:oe,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(D,{className:"text-sm font-medium",children:r("report.evidenceUrls")}),b.map((t,s)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:t,onChange:c=>ne(s,c.target.value),placeholder:r("report.evidencePlaceholder")}),b.length>1&&e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>ie(s),children:e.jsx(J,{className:"w-4 h-4"})})]},s)),e.jsxs(C,{variant:"outline",size:"sm",onClick:ae,className:"w-full",children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),r("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(C,{variant:"outline",onClick:()=>v(!1),children:r("report.cancel")}),e.jsx(C,{onClick:ue,disabled:!a||y.length<20||!u.trim()||b.filter(t=>t.trim()!=="").length===0&&T.length===0||K||R,children:r(K?"common.uploading":R?"auth.sendingCode":"report.submit")})]})]}):Q==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:r("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:r("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Me,{maxLength:4,value:A,onChange:t=>q(t),children:e.jsxs($e,{children:[e.jsx(z,{index:0}),e.jsx(z,{index:1}),e.jsx(z,{index:2}),e.jsx(z,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:r("auth.verificationCodeHint",{email:u})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(C,{variant:"link",size:"sm",onClick:de,disabled:N>0||o,children:N>0?`${r("auth.resendCode")} (${N}s)`:r("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"outline",className:"w-full",onClick:()=>{k("form"),q("")},disabled:o,children:r("common.back")}),e.jsx(C,{className:"w-full",onClick:me,disabled:A.length!==4||o,children:r(o?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(Ie,{open:U,onOpenChange:w,children:e.jsxs(Te,{children:[e.jsxs(ke,{children:[e.jsx(Fe,{children:r("report.confirmTitle")}),e.jsx(Ae,{children:r("report.confirmMessage")})]}),e.jsxs(qe,{children:[e.jsx(Pe,{children:r("report.cancel")}),e.jsx(ze,{onClick:G,disabled:o,children:r(o?"report.submitting":"report.submit")})]})]})})]})};export{Re as D,Xe as R,We as a,Ge as b,Be as u};
