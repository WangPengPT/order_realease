import{p as ie,r,c8 as ae,u as me,j as e,bJ as ge,am as fe,aM as re,c9 as pe,ca as xe,aN as be}from"./vendor-react-C7F4V4j9.js";import{u as we,b as je,i as F,B as se,S as Ne,I as ye,o as ke}from"./index-BgP4kwZT.js";import{L as ve}from"./LocationPermissionDialog-LAxMUquE.js";import{E as Se}from"./ExternalLinkConfirmDialog-eqM1JX6c.js";const ne="https://tzdgqhwyzsxkxnncgzap.supabase.co",V="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",Ce=["最近","附近","离我","距离","远近","近的","周边","周围","最近的","附近的","nearest","closest","nearby","near me","close to me","distance","around me","mais perto","próximo","perto de mim","distância","mais próximo"],Re=()=>{const p="xiaoxiong_anonymous_user_id";let k=localStorage.getItem(p);return k||(k=`anon_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(p,k)),k},De=(p="ask-xiaoxiong")=>{const{i18n:k}=ie(),{user:L}=we(),[I,X]=r.useState(""),[K,S]=r.useState([]),[P,$]=r.useState(!1),[A,q]=r.useState(null),[Y,z]=r.useState(!1),[O,T]=r.useState(null),R=r.useRef(null),w=r.useCallback(()=>L?.id?L.id:Re(),[L?.id]),H=r.useCallback(n=>{const u=n.toLowerCase();return Ce.some(i=>u.includes(i))},[]),Z=async(n,u)=>{const i=await fetch(`${ne}/functions/v1/ask-xiaoxiong`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${V}`,apikey:V},body:JSON.stringify({text:n.content,stream:!0,lat:A?.lat,lng:A?.lng}),signal:R.current?.signal});if(!i.ok)throw new Error(`Request failed with status: ${i.status}`);if(!i.body)throw new Error("No response body");const v=i.body.getReader(),h=new TextDecoder;let j="";for(;;){const{done:m,value:g}=await v.read();if(m)break;const E=h.decode(g,{stream:!0});j+=E;let l=j;l.startsWith('"')&&(l=l.slice(1)),l.endsWith('"')&&(l=l.slice(0,-1)),l=l.replace(/\\n/g,`
`),S(C=>C.map(W=>W.id===u?{...W,content:l}:W))}let c=j;c.startsWith('"')&&(c=c.slice(1)),c.endsWith('"')&&(c=c.slice(0,-1)),c=c.replace(/\\n/g,`
`),S(m=>m.map(g=>g.id===u?{...g,content:c,isStreaming:!1}:g))},D=async(n,u)=>{const i=w(),v=await fetch(`${ne}/functions/v1/xiaoxiong-agent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${V}`,apikey:V},body:JSON.stringify({message:n.content,userId:i}),signal:R.current?.signal});if(!v.ok)throw new Error(`Request failed with status: ${v.status}`);if(!v.body)throw new Error("No response body");const h=v.body.getReader(),j=new TextDecoder;let c="";for(;;){const{done:m,value:g}=await h.read();if(m)break;const E=j.decode(g,{stream:!0});c+=E,ae.flushSync(()=>{S(l=>l.map(C=>C.id===u?{...C,content:c}:C))}),await new Promise(l=>requestAnimationFrame(l))}S(m=>m.map(g=>g.id===u?{...g,isStreaming:!1}:g))},B=async(n,u)=>{const i=await fetch(`${ne}/functions/v1/lovable-chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${V}`,apikey:V},body:JSON.stringify({message:n.content,lat:A?.lat,lng:A?.lng,language:k.language}),signal:R.current?.signal});if(!i.ok){const m=await i.json().catch(()=>({}));throw new Error(m.error||`Request failed with status: ${i.status}`)}if(!i.body)throw new Error("No response body");const v=i.body.getReader(),h=new TextDecoder;let j="",c="";for(;;){const{done:m,value:g}=await v.read();if(m)break;c+=h.decode(g,{stream:!0});let E;for(;(E=c.indexOf(`
`))!==-1;){let l=c.slice(0,E);if(c=c.slice(E+1),l.endsWith("\r")&&(l=l.slice(0,-1)),l.startsWith(":")||l.trim()===""||!l.startsWith("data: "))continue;const C=l.slice(6).trim();if(C==="[DONE]")break;try{const N=JSON.parse(C).choices?.[0]?.delta?.content;N&&(j+=N,ae.flushSync(()=>{S(_=>_.map(M=>M.id===u?{...M,content:j}:M))}),await new Promise(_=>requestAnimationFrame(_)))}catch{}}}S(m=>m.map(g=>g.id===u?{...g,isStreaming:!1}:g))},x=r.useCallback(async n=>{const u={id:Date.now().toString(),role:"user",content:n},i=(Date.now()+1).toString(),v={id:i,role:"assistant",content:"",isStreaming:!0};S(h=>[...h,u,v]),X(""),$(!0),R.current&&R.current.abort(),R.current=new AbortController;try{p==="lovable-ai"?await B(u,i):p==="xiaoxiong-agent"?await D(u,i):await Z(u,i)}catch(h){if(h instanceof Error&&h.name==="AbortError"){console.log("Request aborted");return}console.error("Ask API error:",h);const j=k.language==="zh"?"抱歉，暂时无法获取结果，请稍后再试":k.language==="pt"?"Desculpe, não foi possível obter resultados. Tente novamente mais tarde.":"Sorry, unable to get results. Please try again later.";S(c=>c.map(m=>m.id===i?{...m,content:j,isStreaming:!1}:m))}finally{$(!1)}},[p,A,k.language,w]),G=r.useCallback(()=>{z(!1),navigator.geolocation?.getCurrentPosition(n=>{q({lat:n.coords.latitude,lng:n.coords.longitude}),O&&setTimeout(()=>{x(O),T(null)},100)},n=>{console.log("Location permission denied:",n.message),O&&(x(O),T(null))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},[O,x]),J=r.useCallback(async()=>{if(!I.trim()||P)return;const n=I.trim();if(!A&&H(n)){T(n),z(!0),X("");return}await x(n)},[I,P,A,H,x]),U=r.useCallback(n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),J())},[J]),Q=r.useCallback(()=>{R.current&&R.current.abort()},[]),ee=r.useCallback(()=>{navigator.geolocation?.getCurrentPosition(n=>{q({lat:n.coords.latitude,lng:n.coords.longitude})},n=>{console.log("Unable to get user location:",n.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5})},[]);return{input:I,setInput:X,messages:K,isLoading:P,showLocationDialog:Y,setShowLocationDialog:z,pendingMessage:O,setPendingMessage:T,handleSubmit:J,handleKeyDown:U,handleLocationConfirm:G,processMessage:x,abortRequest:Q,requestLocation:ee}},Ie=()=>!!(window.webkit?.messageHandlers?.VoiceBridge||window.VoiceBridge),oe={start:()=>{const p=JSON.stringify({action:"start"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(p):window.VoiceBridge&&window.VoiceBridge.postMessage(p)},stop:()=>{const p=JSON.stringify({action:"stop"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(p):window.VoiceBridge&&window.VoiceBridge.postMessage(p)}},ze=({messages:p,input:k,setInput:L,isLoading:I,showLocationDialog:X,setShowLocationDialog:K,pendingMessage:S,handleSubmit:P,handleKeyDown:$,handleLocationConfirm:A,processMessage:q,setPendingMessage:Y,onClose:z,showBackButton:O=!1,showHeader:T=!0,className:R})=>{const{i18n:w}=ie(),H=me(),{settings:Z}=je(),D=Z?.logo_url,[B,x]=r.useState(!1),[G,J]=r.useState(!1),[U,Q]=r.useState(!1),[ee,n]=r.useState(!1),[u,i]=r.useState(null),v=r.useRef(null),h=r.useRef(null),j=r.useRef(null);r.useEffect(()=>{const t=window.SpeechRecognition||window.webkitSpeechRecognition;return J(!!t),Q(Ie()),window.onSpeechResult=o=>{L(o),x(!1)},()=>{window.onSpeechResult=void 0}},[L]),r.useEffect(()=>{j.current?.scrollIntoView({behavior:"smooth"})},[p]),r.useEffect(()=>()=>{h.current&&h.current.stop()},[]);const c=()=>G||U,m=()=>{if(U){oe.start(),x(!0);return}const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t)return;h.current&&h.current.stop();const o=new t;h.current=o;const s={zh:"zh-CN",en:"en-US",pt:"pt-BR"};o.lang=s[w.language]||"zh-CN",o.continuous=!1,o.interimResults=!0,o.onstart=()=>x(!0),o.onresult=f=>{const a=Array.from(f.results).map(d=>d[0].transcript).join("");L(a)},o.onerror=()=>x(!1),o.onend=()=>x(!1),o.start()},g=()=>{if(U){oe.stop(),x(!1);return}h.current&&(h.current.stop(),x(!1))},E=()=>{B?g():m()},l=t=>{z?.(),H(t)},C=t=>{i(t),n(!0)},W=()=>{u&&ke(u),n(!1),i(null)},N=t=>{const o=/\[([^\]]+)\]\(([^)]+)\)/g,s=[];let f=0,a,d=0;for(;(a=o.exec(t))!==null;){a.index>f&&s.push(e.jsx("span",{children:t.slice(f,a.index)},d++));const y=a[1],b=a[2];if(b.startsWith("/"))s.push(e.jsx("button",{onClick:()=>l(b),className:"text-primary hover:underline font-medium cursor-pointer",children:y},d++));else if(b.startsWith("!external:")){const te=b.slice(10);s.push(e.jsx("button",{onClick:()=>C(te),className:"text-primary hover:underline font-medium cursor-pointer",children:y},d++))}else b.startsWith("http://")||b.startsWith("https://")?s.push(e.jsx("button",{onClick:()=>C(b),className:"text-primary hover:underline font-medium cursor-pointer",children:y},d++)):s.push(e.jsx("a",{href:b,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline font-medium",children:y},d++));f=a.index+a[0].length}return f<t.length&&s.push(e.jsx("span",{children:t.slice(f)},d++)),s.length>0?s:[e.jsx("span",{children:t},"0")]},_=t=>t.replace(/\*\*(.*?)\*\*/g,"$1"),M=(t,o=20)=>t.length<=o?t:t.slice(0,o)+"...",le=(t,o)=>{const s=d=>d.split("|").slice(1,-1).map(y=>_(y.trim())),f=s(t[0]),a=t.slice(2).map(s);return e.jsx("div",{className:"overflow-x-auto my-2 max-w-full",children:e.jsxs("table",{className:"w-full text-xs border border-border rounded-md overflow-hidden table-fixed",children:[e.jsx("thead",{className:"bg-muted/60",children:e.jsx("tr",{children:f.map((d,y)=>e.jsx("th",{className:"px-2 py-2 text-left font-semibold border-b border-border truncate max-w-[100px]",title:d,children:N(M(d,15))},y))})}),e.jsx("tbody",{children:a.map((d,y)=>e.jsx("tr",{className:"border-b border-border last:border-0 hover:bg-muted/30 transition-colors",children:d.map((b,te)=>e.jsx("td",{className:"px-2 py-2 truncate max-w-[100px]",title:b,children:N(M(b,18))},te))},y))})]})},o)},ce=t=>{const o=t.split(`
`),s=[];let f=0;for(;f<o.length;){const a=o[f];if(a.trim().startsWith("|")&&a.split("|").length>2){const d=[];for(;f<o.length&&o[f].trim().startsWith("|");)d.push(o[f]),f++;d.length>=2&&s.push(le(d,s.length));continue}if(a.startsWith("### "))s.push(e.jsx("h3",{className:"text-base font-semibold mt-3 mb-1",children:N(a.slice(4))},s.length));else if(a.startsWith("## "))s.push(e.jsx("h2",{className:"text-lg font-bold mt-4 mb-2",children:N(a.slice(3))},s.length));else if(a.startsWith("# "))s.push(e.jsx("h1",{className:"text-xl font-bold mt-4 mb-2",children:N(a.slice(2))},s.length));else if(a.includes("**")){const d=a.split(/\*\*(.*?)\*\*/g);s.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:d.map((y,b)=>b%2===1?e.jsx("strong",{className:"font-semibold",children:N(y)},b):N(y))},s.length))}else a.startsWith("- ")||a.startsWith("* ")?s.push(e.jsx("li",{className:"ml-4 mb-0.5 list-disc",children:N(a.slice(2))},s.length)):/^\d+\.\s/.test(a)?s.push(e.jsx("li",{className:"ml-4 mb-0.5 list-decimal",children:N(a.replace(/^\d+\.\s/,""))},s.length)):a.match(/^[-*_]{3,}$/)?s.push(e.jsx("hr",{className:"my-3 border-border"},s.length)):a.trim()===""?s.push(e.jsx("div",{className:"h-1"},s.length)):s.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:N(a)},s.length));f++}return s},de=()=>w.language==="zh"?"小熊AI助手":w.language==="pt"?"Assistente IA Xiaoxiong":"Xiaoxiong AI Assistant",ue=()=>w.language==="zh"?"告诉小熊，你想吃什么...":w.language==="pt"?"Diga ao Xiaoxiong o que você quer comer...":"Tell Xiaoxiong what you want to eat...",he=()=>w.language==="zh"?"你好，我是小熊，我来帮你推荐餐厅；比如：「我附近的寿司餐厅」":w.language==="pt"?"Olá, eu sou o Xiaoxiong, vou te ajudar a encontrar restaurantes; por exemplo: 「restaurantes de sushi perto de mim」":`Hi, I'm Xiaoxiong, I'll help you find restaurants; for example: "sushi restaurants near me"`;return e.jsxs("div",{className:F("flex flex-col h-full bg-background overflow-hidden",R),children:[T&&e.jsxs("div",{className:"px-4 py-3 shrink-0 border-b flex items-center gap-2 bg-background sticky top-0 z-10",children:[O&&e.jsx(se,{variant:"ghost",size:"icon",onClick:z,className:"shrink-0",children:e.jsx(ge,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[D&&e.jsx("img",{src:D,alt:"Logo",className:"w-8 h-8 rounded-full object-cover"}),e.jsx("h1",{className:"text-base font-semibold",children:de()})]})]}),e.jsx(Ne,{className:"flex-1 min-h-0 overflow-auto",ref:v,children:e.jsxs("div",{className:"p-4 space-y-4",children:[p.length===0&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:D&&e.jsx("img",{src:D,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:"flex-1 bg-muted rounded-lg px-3 py-2 text-sm",children:he()})]}),p.map(t=>e.jsxs("div",{className:F("flex gap-3",t.role==="user"&&"flex-row-reverse"),children:[t.role==="user"?e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0",children:e.jsx(fe,{className:"h-4 w-4"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:D&&e.jsx("img",{src:D,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:F("flex-1 max-w-[85%] rounded-lg px-3 py-2 text-sm",t.role==="user"?"bg-primary text-primary-foreground":"bg-muted"),children:t.role==="assistant"?e.jsxs(e.Fragment,{children:[t.content?e.jsx("div",{className:"prose-sm",children:ce(t.content)}):e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(re,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:w.language==="zh"?"思考中...":w.language==="pt"?"Pensando...":"Thinking..."})]}),t.isStreaming&&t.content&&e.jsx("span",{className:"inline-block w-1.5 h-4 bg-primary/50 animate-pulse ml-0.5 align-middle"})]}):t.content})]},t.id)),e.jsx("div",{ref:j})]})}),e.jsx("div",{className:"px-2 py-1.5 pb-[max(1.5rem,calc(env(safe-area-inset-bottom)+1rem))] md:pb-4 shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 rounded-full backdrop-blur-md border border-border/50 bg-muted/80 dark:bg-muted/60",children:[c()&&e.jsx(se,{variant:"ghost",size:"icon",onClick:E,disabled:I,className:F("bg-transparent hover:bg-transparent",B&&"text-destructive"),children:B?e.jsx(pe,{className:"h-4 w-4"}):e.jsx(xe,{className:"h-4 w-4"})}),e.jsx(ye,{value:k,onChange:t=>L(t.target.value),onKeyDown:$,placeholder:B?w.language==="zh"?"正在聆听...":"Listening...":ue(),disabled:I,className:"flex-1 bg-transparent border-0 shadow-none focus-visible:ring-0 focus-visible:ring-offset-0"}),e.jsx(se,{onClick:P,disabled:!k.trim()||I,size:"icon",variant:"ghost",className:"bg-transparent hover:bg-white/50 rounded-full",children:I?e.jsx(re,{className:"h-4 w-4 animate-spin"}):e.jsx(be,{className:"h-4 w-4"})})]})}),e.jsx(ve,{open:X,onOpenChange:t=>{K(t),!t&&S&&(q(S),Y(null))},onConfirm:A}),e.jsx(Se,{open:ee,onOpenChange:n,onConfirm:W,url:u||void 0})]})};export{ze as X,De as u};
//# sourceMappingURL=XiaoxiongChatContent-DhuW-8Rh.js.map
