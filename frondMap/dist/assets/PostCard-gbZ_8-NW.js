import{p as xe,u as ge,r as n,j as e,b0 as fe,L as v,b5 as je,a_ as pe,aw as we,ay as ve,dI as R,be,b3 as Ne,br as ye,cf as Ce,X as Se,bj as ke,W as Te,w as _e}from"./vendor-react-DTNwRJdt.js";import{C as Y,a as H,b as U}from"./carousel-Di3scV5-.js";import{u as De,C as Ae,p as Le,P as ze,Q as Ie,R as Me,K as Pe,L as Ee,B as d,M as $e,N as Fe,q as Re,g as B,r as Ye,A as He,t as Ue,v as Be,w as We,x as Oe,y as qe,z as Je,E as Ke}from"./index-60xCuNp_.js";import{a as Qe,b as Ve,c as Xe}from"./useCommunityPosts-lFMDLO9z.js";import{u as Ge}from"./useLocalizedContent-Z56eXyv6.js";import{T as Ze}from"./TranslateButton-CjPyQJkV.js";import{u as es}from"./ShareDrawer-DgHmusM0.js";import{H as ss,p as ts,I as as,J as ls}from"./vendor-utils-vwQGbBim.js";const xs=({post:s,showActions:W=!0,isDetailPage:g=!1})=>{const{t:o,i18n:f}=xe(),{user:j}=De(),O=ge(),{getLocalizedField:b}=Ge(),q=Qe(),J=Ve(),K=Xe(),[Q,N]=n.useState(!1),[T,_]=n.useState({}),[y,m]=n.useState(!1),[D,A]=n.useState(0),[u,V]=n.useState(),[L,X]=n.useState(),[z,I]=n.useState(0),[G,Z]=n.useState(null);n.useState(null),n.useState(!1),n.useState(0),n.useState(!1);const[M,ee]=n.useState({}),[h,p]=n.useState(null),[C,P]=n.useState(!1),{share:se,DrawerComponent:te}=es();n.useEffect(()=>{if(y){const t=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${t}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.overflow="",window.scrollTo(0,t)}}},[y]),n.useEffect(()=>{u&&(I(u.selectedScrollSnap()),u.on("select",()=>{I(u.selectedScrollSnap())}))},[u]);const ae=()=>{switch(f.language){case"zh":return ls;case"pt":return as;default:return ts}},le=()=>{j&&q.mutate({postId:s.id,liked:s.user_liked||!1})},ne=async()=>{const t=`${window.location.origin}/community/${s.id}`;se({title:o("community.shareTitle","分享帖子"),text:s.content.replace(/<[^>]*>/g,"").substring(0,100),url:t},()=>{j&&J.mutate(s.id),_e.success(o("community.shareSuccess","分享成功"))})},re=()=>{K.mutate(s.id),N(!1)},E=t=>{g?(A(t),m(!0)):O(`/community/${s.id}`)},w=(t,a)=>{const r=t.currentTarget;ee(c=>({...c,[a]:{width:r.naturalWidth,height:r.naturalHeight}}))},$=t=>{const a=M[t];return a?a.height/a.width>1.5:!1},oe=j?.id===s.author_id,ce=s.activity?b(s.activity,"title"):null,x=[...s.restaurants||[],...s.restaurant&&!s.restaurants?.find(t=>t.id===s.restaurant?.id)?[s.restaurant]:[]],S=g?3:2,ie=C?x:x.slice(0,S),F=x.length>S,de=b(s,"content"),me=f.language==="zh"&&s.content_zh||f.language==="en"&&s.content_en||f.language==="pt"&&s.content_pt,ue=(G||de||s.content)?.replace(/\n/g,"<br>")||"";return e.jsxs(e.Fragment,{children:[e.jsxs(Ae,{className:"overflow-hidden",children:[e.jsx(Le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ze,{className:"h-10 w-10",children:[e.jsx(Ie,{src:s.author?.avatar_url||void 0}),e.jsx(Me,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:ss(new Date(s.created_at),{addSuffix:!0,locale:ae()})})]})]}),W&&oe&&e.jsxs(Pe,{children:[e.jsx(Ee,{asChild:!0,children:e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(fe,{className:"h-4 w-4"})})}),e.jsx($e,{align:"end",children:e.jsx(Fe,{onClick:()=>N(!0),className:"text-destructive",children:o("common.delete","删除")})})]})]})}),e.jsxs(Re,{className:"pt-0 pb-3",children:[(s.activity||x.length>0)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3 items-center",children:[s.activity&&e.jsx(v,{to:`/activity/${s.activity.id}`,children:e.jsxs(B,{variant:"secondary",className:"gap-1",children:[e.jsx(je,{className:"h-3 w-3"}),ce]})}),ie.map(t=>e.jsx(v,{to:`/restaurant/${t.id}`,children:e.jsxs(B,{variant:"secondary",className:"gap-1",children:[e.jsx(pe,{className:"h-3 w-3"}),b(t,"name")]})},t.id)),F&&!C&&e.jsxs("button",{onClick:()=>P(!0),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-0.5",children:["+",x.length-S," ",o("community.more","更多"),e.jsx(we,{className:"h-3 w-3"})]}),C&&F&&e.jsxs("button",{onClick:()=>P(!1),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-0.5",children:[o("community.collapse","收起"),e.jsx(ve,{className:"h-3 w-3"})]})]}),e.jsx(v,{to:`/community/${s.id}`,children:e.jsx("div",{className:`prose prose-sm max-w-none dark:prose-invert ${g?"":"line-clamp-6"}`,dangerouslySetInnerHTML:{__html:ue}})}),!me&&e.jsx(Ze,{text:s.content,onTranslation:Z,className:"mt-1"}),(()=>{const t=g&&s.video_url?(s.image_urls||[]).filter(a=>!a.includes("-cover")):s.image_urls;return!t||t.length===0?null:e.jsx("div",{className:"relative mt-3",children:t.length===1?(()=>{const a=t[0],r=$(a);return e.jsx("div",{className:"relative overflow-hidden rounded-lg cursor-pointer max-h-[300px] sm:max-h-[400px]",onClick:()=>E(0),children:T[a]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:o("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"",className:"w-full max-h-[300px] sm:max-h-[400px] object-cover object-top",onLoad:c=>w(c,a),onError:()=>_(c=>({...c,[a]:!0}))}),r&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:o("community.longImage","长图")})]})]})})})():e.jsxs(e.Fragment,{children:[e.jsx(Y,{setApi:V,className:"w-full",opts:{loop:!0},children:e.jsx(H,{className:"-ml-0",children:t.map((a,r)=>{const c=$(a);return e.jsx(U,{className:"pl-0",children:e.jsx("div",{className:"relative overflow-hidden rounded-lg cursor-pointer aspect-[4/3] bg-muted",onClick:()=>E(r),children:T[a]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:o("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"",className:"w-full h-full object-contain",onLoad:l=>w(l,a),onError:()=>_(l=>({...l,[a]:!0}))}),c&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsx("span",{children:o("community.longImage","长图")})]})]})})},r)})})}),e.jsxs("div",{className:"absolute top-3 right-3 bg-black/60 text-white text-xs px-2 py-1 rounded-full z-10",children:[z+1,"/",t.length]}),e.jsx("div",{className:"flex justify-center gap-1.5 mt-2",children:t.map((a,r)=>e.jsx("button",{className:`w-1.5 h-1.5 rounded-full transition-colors ${r===z?"bg-primary":"bg-muted-foreground/30"}`,onClick:c=>{c.stopPropagation(),u?.scrollTo(r)}},r))})]})})})(),s.video_url&&e.jsx("div",{className:"mt-3 rounded-lg overflow-hidden bg-gray-900",children:e.jsx("video",{src:s.video_url,...s.image_urls?.length?{poster:s.image_urls[0]}:{},controls:!0,className:"w-full max-h-96",preload:"metadata",playsInline:!0})})]}),e.jsx(Ye,{className:"pt-0 border-t",children:e.jsxs("div",{className:"flex items-center gap-4 pt-3 w-full",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:`gap-2 ${s.user_liked?"text-red-500":""}`,onClick:le,disabled:!j,children:[e.jsx(be,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count})]}),e.jsx(v,{to:`/community/${s.id}`,children:e.jsxs(d,{variant:"ghost",size:"sm",className:"gap-2",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx("span",{children:s.comments_count})]})}),e.jsxs(d,{variant:"ghost",size:"sm",className:"gap-2",onClick:ne,children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{children:s.shares_count})]})]})})]}),e.jsx(He,{open:Q,onOpenChange:N,children:e.jsxs(Ue,{children:[e.jsxs(Be,{children:[e.jsx(We,{children:o("common.confirmDelete","确认删除")}),e.jsx(Oe,{children:o("community.deleteWarning","删除后无法恢复，确定要删除这篇帖子吗？")})]}),e.jsxs(qe,{children:[e.jsx(Je,{children:o("common.cancel","取消")}),e.jsx(Ke,{onClick:re,children:o("common.delete","删除")})]})]})}),y&&Ce.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black overflow-hidden",onClick:t=>{t.target===t.currentTarget&&m(!1)},onWheel:t=>t.stopPropagation(),onTouchMove:t=>t.stopPropagation(),children:[s.image_urls&&s.image_urls.length>1&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-10 text-white text-sm bg-black/50 px-4 py-1.5 rounded-full",children:[D+1," / ",s.image_urls.length]}),e.jsx(d,{variant:"ghost",size:"icon",className:"absolute top-4 right-4 z-10 text-white hover:bg-white/20",onClick:()=>m(!1),children:e.jsx(Se,{className:"h-6 w-6"})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Y,{className:"w-full",opts:{loop:!0,startIndex:D},setApi:t=>{X(t),t&&t.on("select",()=>{A(t.selectedScrollSnap())})},children:e.jsx(H,{className:"-ml-0",children:s.image_urls?.map((t,a)=>{const r=M[t],c=r?r.height/r.width>1.5:!1;return e.jsx(U,{className:"pl-0 flex items-center justify-center",children:c?e.jsx("div",{className:"w-full h-screen overflow-x-hidden overflow-y-scroll overscroll-contain",onMouseDown:l=>{const i=l.currentTarget;p({y:l.clientY,scrollTop:i.scrollTop})},onMouseUp:l=>{if(h){const i=Math.abs(l.clientY-h.y),k=Math.abs(l.currentTarget.scrollTop-h.scrollTop);i<10&&k<10&&m(!1),p(null)}},onTouchStart:l=>{const i=l.currentTarget;p({y:l.touches[0].clientY,scrollTop:i.scrollTop})},onTouchEnd:l=>{if(h){const i=l.changedTouches[0],k=Math.abs(i.clientY-h.y),he=Math.abs(l.currentTarget.scrollTop-h.scrollTop);k<15&&he<15&&(l.preventDefault(),m(!1)),p(null)}},children:e.jsx("img",{src:t,alt:"",className:"block select-none",style:{width:"100vw",minHeight:"100dvh",height:"auto",margin:0},draggable:!1,onLoad:l=>w(l,t)})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("img",{src:t,alt:"",className:"object-contain w-screen h-screen select-none cursor-pointer",draggable:!1,onClick:()=>m(!1),onLoad:l=>w(l,t)})})},a)})})})}),s.image_urls&&s.image_urls.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(d,{variant:"ghost",size:"icon",className:"absolute left-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>L?.scrollPrev(),children:e.jsx(ke,{className:"h-8 w-8"})}),e.jsx(d,{variant:"ghost",size:"icon",className:"absolute right-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>L?.scrollNext(),children:e.jsx(Te,{className:"h-8 w-8"})})]})]}),document.body),te]})};export{xs as P};
//# sourceMappingURL=PostCard-gbZ_8-NW.js.map
