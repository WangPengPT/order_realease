import{r as u}from"./vendor-react-CrHRjzzo.js";import{u as g,s as o}from"./index-CMe-28It.js";import"./vendor-ui-BO6fjm1h.js";import"./vendor-i18n-DWR4v88Y.js";import"./vendor-charts-C50LysBY.js";import"./vendor-query-EnOED-MY.js";import"./vendor-supabase-QnE9GqXs.js";const p="location_cache",v=()=>{try{const t=sessionStorage.getItem(p);if(t){const e=JSON.parse(t);return{country:e.country||null,city:e.city||null,ip:e.ip||null}}}catch{}return null},w=t=>{try{sessionStorage.setItem(p,JSON.stringify(t))}catch{}},D=async()=>{const t=v();if(t)return t;try{const{data:e,error:n}=await o.functions.invoke("get-location");if(n)return console.error("Failed to fetch location:",n),{country:null,city:null,ip:null};const r={country:e?.country||null,city:e?.city||null,ip:e?.ip||null};return(r.country||r.city)&&w(r),r}catch(e){return console.error("Failed to fetch location data:",e),{country:null,city:null,ip:null}}},_=()=>{const{user:t}=g(),e=u.useRef(null),n=u.useRef(null),r=u.useRef(null);u.useEffect(()=>{if(!t?.id)return;const i=async(l,c=!1)=>{try{const{data:{session:a}}=await o.auth.getSession();if(!a){console.warn("No active session, skipping presence update");return}const s={user_id:t.id,is_online:l,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()};c&&n.current&&(s.ip_address=n.current.ip,s.city=n.current.city,s.country=n.current.country);const{error:y}=await o.from("user_presence").upsert(s,{onConflict:"user_id"});y&&console.error("Error updating presence in DB:",y)}catch(a){console.error("Error in updatePresenceInDB:",a)}},h=async()=>{const l=await D();n.current=l;const c=o.channel("online-users",{config:{presence:{key:t.id}}});c.on("presence",{event:"sync"},()=>{c.presenceState()}).subscribe(async a=>{a==="SUBSCRIBED"&&(await c.track({user_id:t.id,online_at:new Date().toISOString()}),await i(!0,!0))}),e.current=c},m=2e3;r.current=setTimeout(h,m);const S=setInterval(()=>{i(!0,!1),e.current&&e.current.track({user_id:t.id,online_at:new Date().toISOString()})},6e4),d=()=>{document.visibilityState==="visible"&&(e.current&&e.current.track({user_id:t.id,online_at:new Date().toISOString()}),i(!0,!1))},f=()=>{i(!1,!1)};return document.addEventListener("visibilitychange",d),window.addEventListener("beforeunload",f),()=>{r.current&&clearTimeout(r.current),clearInterval(S),document.removeEventListener("visibilitychange",d),window.removeEventListener("beforeunload",f),e.current&&(e.current.untrack(),o.removeChannel(e.current)),i(!1,!1)}},[t?.id])},B=()=>(_(),null);export{B as UserPresenceTracker,B as default};
//# sourceMappingURL=UserPresenceTracker-5_Y75_YW.js.map
