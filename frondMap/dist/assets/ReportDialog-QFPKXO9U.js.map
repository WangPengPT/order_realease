{"version":3,"file":"ReportDialog-QFPKXO9U.js","sources":["../../src/hooks/useComments.ts","../../src/components/ReportDialog.tsx"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\n\r\n// Track comments posted in this session - resets on page refresh\r\n// This allows flagged comments to show during the current session\r\nexport const sessionPostedCommentIds = new Set<string>();\r\n\r\nexport interface Comment {\r\n  id: string;\r\n  user_id: string;\r\n  target_id: string;\r\n  target_type: string;\r\n  content: string;\r\n  rating_value?: number | null;\r\n  price_range?: string | null;\r\n  image_url?: string;\r\n  parent_id?: string;\r\n  edited: boolean;\r\n  moderation_status?: \"pending\" | \"approved\" | \"flagged\";\r\n  created_at: string;\r\n  updated_at: string;\r\n  profiles?: {\r\n    display_name: string;\r\n    avatar_url?: string;\r\n  };\r\n  replies?: Comment[];\r\n}\r\n\r\nexport const useComments = (targetId: string, targetType: string = \"restaurant\", options?: { enabled?: boolean }) => {\r\n  const { user } = useAuth();\r\n  \r\n  return useQuery({\r\n    queryKey: [\"comments\", targetId, targetType],\r\n    enabled: (options?.enabled !== false) && !!targetId,\r\n    queryFn: async () => {\r\n      // Fetch all comments (both main and replies) in a single query\r\n      let query = supabase\r\n        .from(\"comments\")\r\n        .select(\"*\")\r\n        .eq(\"target_id\", targetId)\r\n        .eq(\"target_type\", targetType)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      const { data: allComments, error } = await query;\r\n\r\n      if (error) throw error;\r\n      if (!allComments || allComments.length === 0) return [];\r\n\r\n      // Filter comments:\r\n      // 1. Show approved comments to everyone\r\n      // 2. Show user's own pending comments\r\n      // 3. Show user's own flagged comments ONLY if posted in this session (before refresh)\r\n      const filteredComments = allComments.filter(comment => \r\n        comment.moderation_status === \"approved\" || \r\n        (user && comment.user_id === user.id && comment.moderation_status === \"pending\") ||\r\n        (user && comment.user_id === user.id && comment.moderation_status === \"flagged\" && sessionPostedCommentIds.has(comment.id))\r\n      );\r\n\r\n      // Get unique user IDs from filtered comments\r\n      const userIds = [...new Set(filteredComments.map(c => c.user_id))];\r\n      \r\n      // Use secure function to get only public profile data (display_name, avatar_url)\r\n      const { data: profiles } = await supabase\r\n        .rpc(\"get_public_profiles\", { user_ids: userIds });\r\n\r\n      // Create a profile lookup map\r\n      const profileMap = new Map(\r\n        (profiles || []).map((p: { id: string; display_name: string; avatar_url: string }) => \r\n          [p.id, { display_name: p.display_name, avatar_url: p.avatar_url }]\r\n        )\r\n      );\r\n\r\n      // Separate main comments and replies from filtered comments\r\n      const mainComments = filteredComments.filter(c => !c.parent_id);\r\n      const replies = filteredComments.filter(c => c.parent_id);\r\n\r\n      // Group replies by parent_id\r\n      const repliesByParentId = new Map<string, typeof allComments>();\r\n      replies.forEach(reply => {\r\n        const parentId = reply.parent_id!;\r\n        if (!repliesByParentId.has(parentId)) {\r\n          repliesByParentId.set(parentId, []);\r\n        }\r\n        repliesByParentId.get(parentId)!.push(reply);\r\n      });\r\n\r\n      // Build the comment tree\r\n      const commentsWithDetails: Comment[] = mainComments.map(comment => ({\r\n        ...comment,\r\n        moderation_status: comment.moderation_status as \"pending\" | \"approved\" | \"flagged\" | undefined,\r\n        profiles: profileMap.get(comment.user_id),\r\n        replies: (repliesByParentId.get(comment.id) || [])\r\n          .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())\r\n          .map(reply => ({\r\n            ...reply,\r\n            moderation_status: reply.moderation_status as \"pending\" | \"approved\" | \"flagged\" | undefined,\r\n            profiles: profileMap.get(reply.user_id),\r\n          })),\r\n      }));\r\n\r\n      return commentsWithDetails;\r\n    },\r\n    staleTime: 30000, // Cache for 30 seconds\r\n  });\r\n};\r\n\r\nexport const useAddComment = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      targetId,\r\n      targetType,\r\n      content,\r\n      ratingValue,\r\n      priceRange,\r\n      imageUrl,\r\n      parentId,\r\n    }: {\r\n      targetId: string;\r\n      targetType: string;\r\n      content: string;\r\n      ratingValue?: number;\r\n      priceRange?: string;\r\n      imageUrl?: string;\r\n      parentId?: string;\r\n    }) => {\r\n      if (!user) throw new Error(\"User not authenticated\");\r\n\r\n      const insertData: any = {\r\n        user_id: user.id,\r\n        target_id: targetId,\r\n        target_type: targetType,\r\n        content,\r\n        parent_id: parentId,\r\n        moderation_status: \"pending\", // Start with pending until AI review\r\n      };\r\n\r\n      // Only add rating and price range for non-reply comments\r\n      if (!parentId) {\r\n        if (ratingValue) insertData.rating_value = ratingValue;\r\n        if (priceRange) insertData.price_range = priceRange;\r\n      }\r\n\r\n      if (imageUrl) insertData.image_url = imageUrl;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"comments\")\r\n        .insert(insertData)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Trigger AI moderation asynchronously\r\n      // Pass target info for user notification\r\n      try {\r\n        const { data: moderationResult, error: moderationError } = await supabase.functions.invoke(\"moderate-comment\", {\r\n          body: {\r\n            comment_id: data.id,\r\n            content,\r\n            user_id: user.id,\r\n            sensitive_word_detected: false,\r\n            target_id: targetId,\r\n            target_type: targetType,\r\n          },\r\n        });\r\n\r\n        if (moderationError) {\r\n          console.error(\"AI moderation error:\", moderationError);\r\n          // If moderation fails, auto-approve (fallback to allow comment)\r\n          await supabase\r\n            .from(\"comments\")\r\n            .update({ moderation_status: \"approved\" })\r\n            .eq(\"id\", data.id);\r\n        }\r\n      } catch (e) {\r\n        console.error(\"Failed to invoke AI moderation:\", e);\r\n        // If moderation fails, auto-approve (fallback to allow comment)\r\n        await supabase\r\n          .from(\"comments\")\r\n          .update({ moderation_status: \"approved\" })\r\n          .eq(\"id\", data.id);\r\n      }\r\n\r\n      return data;\r\n    },\r\n    onSuccess: (data, variables) => {\r\n      // Track this comment ID for session-based visibility of flagged comments\r\n      if (data?.id) {\r\n        sessionPostedCommentIds.add(data.id);\r\n      }\r\n      queryClient.invalidateQueries({ queryKey: [\"comments\", variables.targetId, variables.targetType] });\r\n      queryClient.invalidateQueries({ queryKey: [\"restaurants\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"restaurant\", variables.targetId] });\r\n      // No toast on success - only notify on failure\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to add comment\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\nexport const useUpdateComment = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      commentId,\r\n      content,\r\n    }: {\r\n      commentId: string;\r\n      content: string;\r\n    }) => {\r\n      const { data, error } = await supabase\r\n        .from(\"comments\")\r\n        .update({ content, edited: true })\r\n        .eq(\"id\", commentId)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"comments\"] });\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Comment updated successfully\",\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to update comment\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\nexport const useDeleteComment = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (commentId: string) => {\r\n      const { error } = await supabase\r\n        .from(\"comments\")\r\n        .delete()\r\n        .eq(\"id\", commentId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"comments\"] });\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Comment deleted successfully\",\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to delete comment\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n","import { useState, useEffect } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { ShieldAlert, X, Plus } from \"lucide-react\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\nimport { InputOTP, InputOTPGroup, InputOTPSlot } from \"@/components/ui/input-otp\";\r\n\r\ninterface ReportDialogProps {\r\n  targetType: \"comment\" | \"restaurant\" | \"activity\" | \"user\";\r\n  targetId: string;\r\n  trigger?: React.ReactNode;\r\n  onLoginRequired?: () => void;\r\n}\r\n\r\nconst ReportDialog = ({ targetType, targetId, trigger, onLoginRequired }: ReportDialogProps) => {\r\n  const { t } = useTranslation();\r\n  const { user } = useAuth();\r\n  const [open, setOpen] = useState(false);\r\n  const [showConfirm, setShowConfirm] = useState(false);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const [reason, setReason] = useState<string>(\"\");\r\n  const [description, setDescription] = useState(\"\");\r\n  const [contact, setContact] = useState(user?.email || \"\");\r\n  const [evidenceUrls, setEvidenceUrls] = useState<string[]>([\"\"]);\r\n  const [evidenceImages, setEvidenceImages] = useState<File[]>([]);\r\n  const [uploadingImages, setUploadingImages] = useState(false);\r\n\r\n  // Email verification states for non-logged-in users\r\n  const [verificationStep, setVerificationStep] = useState<\"form\" | \"verify\" | \"submitting\">(\"form\");\r\n  const [verificationCode, setVerificationCode] = useState(\"\");\r\n  const [resendCountdown, setResendCountdown] = useState(0);\r\n  const [isSendingCode, setIsSendingCode] = useState(false);\r\n\r\n  // Update contact email when user changes or dialog opens\r\n  const handleOpenChange = (newOpen: boolean) => {\r\n    // If trying to open and user is not logged in, trigger login required callback\r\n    if (newOpen && !user) {\r\n      onLoginRequired?.();\r\n      return;\r\n    }\r\n    \r\n    setOpen(newOpen);\r\n    if (newOpen && user?.email) {\r\n      setContact(user.email);\r\n    }\r\n    if (!newOpen) {\r\n      // Reset verification step when dialog closes\r\n      setVerificationStep(\"form\");\r\n      setVerificationCode(\"\");\r\n      setResendCountdown(0);\r\n    }\r\n  };\r\n\r\n  // Countdown timer for resend button\r\n  useEffect(() => {\r\n    let timer: NodeJS.Timeout;\r\n    if (resendCountdown > 0) {\r\n      timer = setTimeout(() => setResendCountdown(resendCountdown - 1), 1000);\r\n    }\r\n    return () => clearTimeout(timer);\r\n  }, [resendCountdown]);\r\n\r\n  const reasons = [\r\n    \"spam\",\r\n    \"harassment\",\r\n    \"inappropriate_content\",\r\n    \"misinformation\",\r\n    \"copyright\",\r\n    \"fraud\",\r\n    \"hate_speech\",\r\n    \"violence\",\r\n    \"other\",\r\n  ];\r\n\r\n  const addEvidenceUrl = () => {\r\n    setEvidenceUrls([...evidenceUrls, \"\"]);\r\n  };\r\n\r\n  const removeEvidenceUrl = (index: number) => {\r\n    setEvidenceUrls(evidenceUrls.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const updateEvidenceUrl = (index: number, value: string) => {\r\n    const newUrls = [...evidenceUrls];\r\n    newUrls[index] = value;\r\n    setEvidenceUrls(newUrls);\r\n  };\r\n\r\n  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = Array.from(e.target.files || []);\r\n    \r\n    // 验证文件大小（5MB）\r\n    const oversizedFiles = files.filter(f => f.size > 5 * 1024 * 1024);\r\n    if (oversizedFiles.length > 0) {\r\n      toast.error(t(\"report.imageTooLarge\"));\r\n      return;\r\n    }\r\n    \r\n    // 验证文件类型\r\n    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];\r\n    const invalidFiles = files.filter(f => !validTypes.includes(f.type));\r\n    if (invalidFiles.length > 0) {\r\n      toast.error(t(\"report.invalidImageType\"));\r\n      return;\r\n    }\r\n    \r\n    setEvidenceImages(prev => [...prev, ...files]);\r\n  };\r\n\r\n  const removeImage = (index: number) => {\r\n    setEvidenceImages(prev => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const uploadImages = async (): Promise<string[]> => {\r\n    if (evidenceImages.length === 0) return [];\r\n    \r\n    setUploadingImages(true);\r\n    const uploadedUrls: string[] = [];\r\n    \r\n    try {\r\n      for (const file of evidenceImages) {\r\n        const fileExt = file.name.split('.').pop();\r\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\r\n        const filePath = `${fileName}`;\r\n\r\n        const { error: uploadError } = await supabase.storage\r\n          .from('report-evidence')\r\n          .upload(filePath, file);\r\n\r\n        if (uploadError) throw uploadError;\r\n\r\n        // 获取文件的完整路径\r\n        const { data } = supabase.storage\r\n          .from('report-evidence')\r\n          .getPublicUrl(filePath);\r\n        \r\n        uploadedUrls.push(data.publicUrl);\r\n      }\r\n      \r\n      return uploadedUrls;\r\n    } catch (error) {\r\n      console.error('Error uploading images:', error);\r\n      throw error;\r\n    } finally {\r\n      setUploadingImages(false);\r\n    }\r\n  };\r\n\r\n  const sendVerificationCode = async () => {\r\n    if (!contact.trim()) {\r\n      toast.error(t(\"report.contactRequired\"));\r\n      return;\r\n    }\r\n\r\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(contact)) {\r\n      toast.error(t(\"report.invalidEmail\"));\r\n      return;\r\n    }\r\n\r\n    setIsSendingCode(true);\r\n    try {\r\n      const { error } = await supabase.functions.invoke(\"send-verification-code\", {\r\n        body: { email: contact },\r\n      });\r\n\r\n      if (error) {\r\n        toast.error(t(\"auth.verificationCodeFailed\"));\r\n        console.error(error);\r\n        return;\r\n      }\r\n\r\n      setVerificationStep(\"verify\");\r\n      toast.success(t(\"auth.verificationCodeSent\"));\r\n      setResendCountdown(30);\r\n    } catch (error: any) {\r\n      toast.error(error.message || t(\"error.general\"));\r\n    } finally {\r\n      setIsSendingCode(false);\r\n    }\r\n  };\r\n\r\n  const handleResendCode = async () => {\r\n    if (resendCountdown > 0) return;\r\n    await sendVerificationCode();\r\n  };\r\n\r\n  const verifyEmailCode = async () => {\r\n    if (verificationCode.length !== 4) {\r\n      toast.error(t(\"auth.invalidVerificationCode\"));\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n    try {\r\n      const { data: verifyResult, error: verifyError } = await supabase.functions.invoke(\r\n        \"verify-email-code\",\r\n        {\r\n          body: {\r\n            email: contact,\r\n            code: verificationCode,\r\n          },\r\n        }\r\n      );\r\n\r\n      if (verifyError || !verifyResult?.success) {\r\n        const errorMessage = verifyResult?.error;\r\n        if (errorMessage === \"This verification code has already been used\") {\r\n          toast.error(t(\"auth.verificationCodeUsed\"));\r\n        } else {\r\n          toast.error(verifyResult?.error || t(\"auth.invalidVerificationCode\"));\r\n        }\r\n        setIsSubmitting(false);\r\n        return;\r\n      }\r\n\r\n      // Verification successful, change to submitting state\r\n      setVerificationStep(\"submitting\");\r\n      \r\n      // Submit report\r\n      await handleConfirmSubmit();\r\n    } catch (error: any) {\r\n      toast.error(error.message || t(\"error.general\"));\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    if (!reason) {\r\n      toast.error(t(\"report.reasonPlaceholder\"));\r\n      return;\r\n    }\r\n\r\n    if (!description || description.length < 20) {\r\n      toast.error(t(\"report.detailsMin\"));\r\n      return;\r\n    }\r\n\r\n    // 联系邮箱必填\r\n    if (!contact.trim()) {\r\n      toast.error(t(\"report.contactRequired\"));\r\n      return;\r\n    }\r\n\r\n    // 验证邮箱格式\r\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(contact)) {\r\n      toast.error(t(\"report.invalidEmail\"));\r\n      return;\r\n    }\r\n\r\n    // 至少需要一个证据（链接或图片）\r\n    const filteredUrls = evidenceUrls.filter((url) => url.trim() !== \"\");\r\n    if (filteredUrls.length === 0 && evidenceImages.length === 0) {\r\n      toast.error(t(\"report.evidenceRequired\"));\r\n      return;\r\n    }\r\n\r\n    // If user is not logged in, require email verification\r\n    if (!user) {\r\n      await sendVerificationCode();\r\n    } else {\r\n      // If user is logged in, show confirmation dialog\r\n      setShowConfirm(true);\r\n    }\r\n  };\r\n\r\n  const handleConfirmSubmit = async () => {\r\n    setIsSubmitting(true);\r\n    try {\r\n      // 上传图片\r\n      let uploadedImageUrls: string[] = [];\r\n      try {\r\n        uploadedImageUrls = await uploadImages();\r\n      } catch (error) {\r\n        toast.error(t(\"report.imageUploadFailed\"));\r\n        setIsSubmitting(false);\r\n        return;\r\n      }\r\n\r\n      const filteredUrls = evidenceUrls.filter((url) => url.trim() !== \"\");\r\n      const allEvidenceUrls = [...filteredUrls, ...uploadedImageUrls];\r\n\r\n      // Prepare report data\r\n      const reportData = {\r\n        reporter_id: user?.id || null,\r\n        target_type: targetType,\r\n        target_id: targetId,\r\n        reason,\r\n        description,\r\n        evidence_urls: allEvidenceUrls,\r\n        reporter_contact: contact,\r\n      };\r\n\r\n      console.log(\"Attempting to insert report:\", reportData);\r\n\r\n      // Insert report into database\r\n      const { data: report, error: reportError } = await supabase\r\n        .from(\"reports\")\r\n        .insert(reportData as any)\r\n        .select()\r\n        .single();\r\n\r\n      console.log(\"Insert result:\", { report, error: reportError });\r\n\r\n      if (reportError) throw reportError;\r\n\r\n      // Get reporter info (if logged in)\r\n      let reporterName = \"Anonymous\";\r\n      let reporterEmail = contact;\r\n      \r\n      if (user) {\r\n        const { data: profile } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"display_name\")\r\n          .eq(\"id\", user.id)\r\n          .single();\r\n        \r\n        reporterName = profile?.display_name || \"Unknown\";\r\n        reporterEmail = user.email || contact;\r\n      }\r\n\r\n      // Send email notification\r\n      await supabase.functions.invoke(\"send-report-email\", {\r\n        body: {\r\n          reportId: report.id,\r\n          reporterName,\r\n          reporterEmail,\r\n          targetType,\r\n          targetId,\r\n          reason,\r\n          description,\r\n          evidenceUrls: allEvidenceUrls.length > 0 ? allEvidenceUrls : undefined,\r\n          reporterContact: contact || undefined,\r\n        },\r\n      });\r\n\r\n      // Show detailed success message\r\n      const reportReference = report.id.substring(0, 8).toUpperCase();\r\n      toast.success(\r\n        t(\"report.successDetailed\", { reference: reportReference }),\r\n        {\r\n          description: t(\"report.successDescription\"),\r\n          duration: 8000,\r\n        }\r\n      );\r\n      \r\n      setOpen(false);\r\n      setShowConfirm(false);\r\n      \r\n      // Reset form\r\n      setReason(\"\");\r\n      setDescription(\"\");\r\n      if (!user) {\r\n        setContact(\"\");\r\n      }\r\n      setEvidenceUrls([\"\"]);\r\n      setEvidenceImages([]);\r\n      setVerificationStep(\"form\");\r\n      setVerificationCode(\"\");\r\n    } catch (error: any) {\r\n      console.error(\"Error submitting report:\", error);\r\n      toast.error(t(\"report.failed\"));\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const getTitle = () => {\r\n    switch (targetType) {\r\n      case \"comment\":\r\n        return t(\"report.reportComment\");\r\n      case \"restaurant\":\r\n        return t(\"report.reportRestaurant\");\r\n      case \"activity\":\r\n        return t(\"report.reportActivity\");\r\n      case \"user\":\r\n        return t(\"report.reportUser\");\r\n      default:\r\n        return t(\"report.title\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Dialog open={open} onOpenChange={handleOpenChange}>\r\n        <DialogTrigger asChild>\r\n          {trigger || (\r\n            <Button variant=\"ghost\" size=\"sm\">\r\n              <ShieldAlert className=\"w-4 h-4 mr-2\" />\r\n              {t(\"report.title\")}\r\n            </Button>\r\n          )}\r\n        </DialogTrigger>\r\n        <DialogContent className=\"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto\">\r\n          <DialogHeader>\r\n            <DialogTitle>{getTitle()}</DialogTitle>\r\n            <DialogDescription>\r\n              {verificationStep === \"verify\" \r\n                ? t(\"auth.verificationCodeSent\") \r\n                : t(\"report.description\")}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          {verificationStep === \"form\" ? (\r\n            <>\r\n              <div className=\"space-y-4 py-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"reason\">{t(\"report.reason\")}</Label>\r\n                  <Select value={reason} onValueChange={setReason}>\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder={t(\"report.reasonPlaceholder\")} />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {reasons.map((r) => (\r\n                        <SelectItem key={r} value={r}>\r\n                          {t(`report.reasons.${r}`)}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"description\">{t(\"report.detailsLabel\")}</Label>\r\n                  <Textarea\r\n                    id=\"description\"\r\n                    value={description}\r\n                    onChange={(e) => setDescription(e.target.value)}\r\n                    placeholder={t(\"report.detailsPlaceholder\")}\r\n                    rows={5}\r\n                    className=\"resize-none\"\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {description.length}/20 {t(\"common.characters\")}\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"contact\">\r\n                    {t(\"report.contactLabel\")}\r\n                    <span className=\"text-destructive ml-1\">*</span>\r\n                  </Label>\r\n                  <Input\r\n                    id=\"contact\"\r\n                    type=\"email\"\r\n                    value={contact}\r\n                    onChange={(e) => setContact(e.target.value)}\r\n                    placeholder={t(\"report.contactPlaceholder\")}\r\n                    required\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label>\r\n                    {t(\"report.evidenceLabel\")}\r\n                    <span className=\"text-destructive ml-1\">*</span>\r\n                  </Label>\r\n                  <p className=\"text-xs text-muted-foreground mb-2\">\r\n                    {t(\"report.evidenceRequiredNote\")}\r\n                  </p>\r\n                  \r\n                  {/* 图片上传 */}\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"image-upload\" className=\"text-sm font-medium\">\r\n                      {t(\"report.uploadImages\")}\r\n                    </Label>\r\n                    <div className=\"flex flex-wrap gap-2 mb-2\">\r\n                      {evidenceImages.map((file, index) => (\r\n                        <div key={index} className=\"relative group\">\r\n                          <img\r\n                            src={URL.createObjectURL(file)}\r\n                            alt={`Evidence ${index + 1}`}\r\n                            className=\"w-20 h-20 object-cover rounded border\"\r\n                          />\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"destructive\"\r\n                            size=\"icon\"\r\n                            className=\"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                            onClick={() => removeImage(index)}\r\n                          >\r\n                            <X className=\"w-3 h-3\" />\r\n                          </Button>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                    <Input\r\n                      id=\"image-upload\"\r\n                      type=\"file\"\r\n                      accept=\"image/jpeg,image/png,image/webp,image/gif\"\r\n                      multiple\r\n                      onChange={handleImageSelect}\r\n                      className=\"cursor-pointer\"\r\n                    />\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {t(\"report.imageUploadHint\")}\r\n                    </p>\r\n                  </div>\r\n\r\n                  {/* URL 链接 */}\r\n                  <div className=\"space-y-2 pt-2\">\r\n                    <Label className=\"text-sm font-medium\">\r\n                      {t(\"report.evidenceUrls\")}\r\n                    </Label>\r\n                  {evidenceUrls.map((url, index) => (\r\n                    <div key={index} className=\"flex gap-2\">\r\n                      <Input\r\n                        value={url}\r\n                        onChange={(e) => updateEvidenceUrl(index, e.target.value)}\r\n                        placeholder={t(\"report.evidencePlaceholder\")}\r\n                      />\r\n                      {evidenceUrls.length > 1 && (\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          onClick={() => removeEvidenceUrl(index)}\r\n                        >\r\n                          <X className=\"w-4 h-4\" />\r\n                        </Button>\r\n                      )}\r\n                    </div>\r\n                  ))}\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={addEvidenceUrl}\r\n                    className=\"w-full\"\r\n                  >\r\n                    <Plus className=\"w-4 h-4 mr-2\" />\r\n                    {t(\"report.addEvidence\")}\r\n                  </Button>\r\n                </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex justify-end gap-2\">\r\n                <Button variant=\"outline\" onClick={() => setOpen(false)}>\r\n                  {t(\"report.cancel\")}\r\n                </Button>\r\n                <Button \r\n                  onClick={handleSubmit} \r\n                  disabled={\r\n                    !reason || \r\n                    description.length < 20 || \r\n                    !contact.trim() || \r\n                    (evidenceUrls.filter(url => url.trim() !== \"\").length === 0 && evidenceImages.length === 0) ||\r\n                    uploadingImages ||\r\n                    isSendingCode\r\n                  }\r\n                >\r\n                  {uploadingImages ? t(\"common.uploading\") : isSendingCode ? t(\"auth.sendingCode\") : t(\"report.submit\")}\r\n                </Button>\r\n              </div>\r\n            </>\r\n          ) : verificationStep === \"submitting\" ? (\r\n            <div className=\"space-y-4 py-8\">\r\n              <div className=\"flex flex-col items-center justify-center space-y-4\">\r\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\r\n                <p className=\"text-center text-muted-foreground\">\r\n                  {t(\"report.submitting\")}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4 py-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>{t(\"auth.verificationCode\")}</Label>\r\n                <div className=\"flex justify-center\">\r\n                  <InputOTP\r\n                    maxLength={4}\r\n                    value={verificationCode}\r\n                    onChange={(value) => setVerificationCode(value)}\r\n                  >\r\n                    <InputOTPGroup>\r\n                      <InputOTPSlot index={0} />\r\n                      <InputOTPSlot index={1} />\r\n                      <InputOTPSlot index={2} />\r\n                      <InputOTPSlot index={3} />\r\n                    </InputOTPGroup>\r\n                  </InputOTP>\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground text-center\">\r\n                  {t(\"auth.verificationCodeHint\", { email: contact })}\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex justify-center\">\r\n                <Button\r\n                  variant=\"link\"\r\n                  size=\"sm\"\r\n                  onClick={handleResendCode}\r\n                  disabled={resendCountdown > 0 || isSubmitting}\r\n                >\r\n                  {resendCountdown > 0\r\n                    ? `${t(\"auth.resendCode\")} (${resendCountdown}s)`\r\n                    : t(\"auth.resendCode\")}\r\n                </Button>\r\n              </div>\r\n\r\n              <div className=\"flex gap-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"w-full\"\r\n                  onClick={() => {\r\n                    setVerificationStep(\"form\");\r\n                    setVerificationCode(\"\");\r\n                  }}\r\n                  disabled={isSubmitting}\r\n                >\r\n                  {t(\"common.back\")}\r\n                </Button>\r\n                <Button\r\n                  className=\"w-full\"\r\n                  onClick={verifyEmailCode}\r\n                  disabled={verificationCode.length !== 4 || isSubmitting}\r\n                >\r\n                  {isSubmitting ? t(\"auth.verifying\") : t(\"auth.verify\")}\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      <AlertDialog open={showConfirm} onOpenChange={setShowConfirm}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>{t(\"report.confirmTitle\")}</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              {t(\"report.confirmMessage\")}\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>{t(\"report.cancel\")}</AlertDialogCancel>\r\n            <AlertDialogAction onClick={handleConfirmSubmit} disabled={isSubmitting}>\r\n              {isSubmitting ? t(\"report.submitting\") : t(\"report.submit\")}\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default ReportDialog;\r\n"],"names":["sessionPostedCommentIds","useComments","targetId","targetType","options","user","useAuth","useQuery","query","supabase","allComments","error","filteredComments","comment","userIds","c","profiles","profileMap","p","mainComments","replies","repliesByParentId","reply","parentId","a","b","useAddComment","toast","useToast","queryClient","useQueryClient","useMutation","content","ratingValue","priceRange","imageUrl","insertData","data","moderationResult","moderationError","e","variables","useDeleteComment","commentId","ReportDialog","trigger","onLoginRequired","t","useTranslation","open","setOpen","useState","showConfirm","setShowConfirm","isSubmitting","setIsSubmitting","reason","setReason","description","setDescription","contact","setContact","evidenceUrls","setEvidenceUrls","evidenceImages","setEvidenceImages","uploadingImages","setUploadingImages","verificationStep","setVerificationStep","verificationCode","setVerificationCode","resendCountdown","setResendCountdown","isSendingCode","setIsSendingCode","handleOpenChange","newOpen","useEffect","timer","reasons","addEvidenceUrl","removeEvidenceUrl","index","_","i","updateEvidenceUrl","value","newUrls","handleImageSelect","files","f","validTypes","prev","removeImage","uploadImages","uploadedUrls","file","fileExt","filePath","uploadError","sendVerificationCode","handleResendCode","verifyEmailCode","verifyResult","verifyError","handleConfirmSubmit","handleSubmit","url","uploadedImageUrls","allEvidenceUrls","reportData","report","reportError","reporterName","reporterEmail","profile","reportReference","getTitle","jsxs","Fragment","Dialog","jsx","DialogTrigger","Button","ShieldAlert","DialogContent","DialogHeader","DialogTitle","DialogDescription","Label","Select","SelectTrigger","SelectValue","SelectContent","r","SelectItem","Textarea","Input","X","Plus","InputOTP","InputOTPGroup","InputOTPSlot","AlertDialog","AlertDialogContent","AlertDialogHeader","AlertDialogTitle","AlertDialogDescription","AlertDialogFooter","AlertDialogCancel","AlertDialogAction"],"mappings":"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"}