import{q as E,r as f,s as I,v as w,j as e,cw as J,bV as q,a_ as H,ak as M,w as m}from"./vendor-react-DImbKuZP.js";import{C as v,E as _,K as b,F as S,J as C,q as O,s as n}from"./index-_G3CuCzp.js";import{T as X,a as F,b as x,c,d as U,e as i}from"./table-Bio9GwFz.js";import{D as L}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CRxszhSs.js";const R=()=>{const u=E(),[d,z]=f.useState(""),[l,h]=f.useState(20);I({queryKey:["site-settings-video-limit"],queryFn:async()=>{const{data:s}=await n.from("site_settings").select("daily_video_limit").single(),t=s?.daily_video_limit;return t&&h(t),t||20}});const{data:p,isLoading:T}=I({queryKey:["admin-video-usage",d],queryFn:async()=>{const s=new Date;s.setHours(0,0,0,0),await n.rpc("get_daily_video_usage",{p_date:s.toISOString()});const o=await(await fetch(`https://tzdgqhwyzsxkxnncgzap.supabase.co/rest/v1/ai_video_usage?created_at=gte.${s.toISOString()}&order=created_at.desc`,{headers:{apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",Authorization:`Bearer ${(await n.auth.getSession()).data.session?.access_token}`}})).json(),r={};for(const a of o)r[a.user_id]||(r[a.user_id]={count:0,userId:a.user_id,lastUsed:a.created_at,recipes:[]}),r[a.user_id].count++,a.recipe_name&&r[a.user_id].recipes.push(a.recipe_name);const y=Object.keys(r);if(y.length===0)return[];const{data:k}=await n.from("profiles").select("id, display_name, avatar_url").in("id",y);return Object.values(r).map(a=>{const N=k?.find(D=>D.id===a.userId);return{...a,displayName:N?.display_name||"Unknown",avatarUrl:N?.avatar_url}}).filter(a=>!d||a.displayName?.toLowerCase().includes(d.toLowerCase()))}}),j=w({mutationFn:async s=>{const t=new Date;if(t.setHours(0,0,0,0),!(await fetch(`https://tzdgqhwyzsxkxnncgzap.supabase.co/rest/v1/ai_video_usage?user_id=eq.${s}&created_at=gte.${t.toISOString()}`,{method:"DELETE",headers:{apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",Authorization:`Bearer ${(await n.auth.getSession()).data.session?.access_token}`}})).ok)throw new Error("Delete failed")},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-video-usage"]}),m.success("已重置用户今日用量")},onError:()=>m.error("重置失败")}),g=w({mutationFn:async s=>{const{error:t}=await n.from("site_settings").update({daily_video_limit:s}).not("id","is",null);if(t)throw t},onSuccess:()=>{u.invalidateQueries({queryKey:["site-settings-video-limit"]}),m.success("每日限制已更新")},onError:()=>m.error("更新失败")});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(J,{className:"h-6 w-6 text-primary"}),e.jsx("h1",{className:"text-2xl font-bold",children:"AI视频用量管理"})]}),e.jsxs(v,{children:[e.jsx(_,{className:"pb-3",children:e.jsxs(b,{className:"text-base flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4"}),"每日生成限制"]})}),e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(C,{type:"number",value:l,onChange:s=>h(Number(s.target.value)),className:"w-32",min:1,max:999}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"次/用户/天"}),e.jsx(O,{size:"sm",onClick:()=>g.mutate(l),disabled:g.isPending,children:"保存"})]})})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(H,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(C,{value:d,onChange:s=>z(s.target.value),placeholder:"搜索用户名...",className:"pl-9"})]})}),e.jsxs(v,{children:[e.jsx(_,{className:"pb-3",children:e.jsx(b,{className:"text-base",children:"今日用量"})}),e.jsx(S,{className:"p-0",children:e.jsxs(X,{children:[e.jsx(F,{children:e.jsxs(x,{children:[e.jsx(c,{children:"用户"}),e.jsx(c,{children:"今日已用"}),e.jsx(c,{children:"最近使用"}),e.jsx(c,{children:"生成菜品"}),e.jsx(c,{className:"text-right",children:"操作"})]})}),e.jsx(U,{children:T?e.jsx(x,{children:e.jsx(i,{colSpan:5,className:"text-center py-8 text-muted-foreground",children:"加载中..."})}):p?.length?p.map(s=>e.jsxs(x,{children:[e.jsx(i,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.avatarUrl&&e.jsx("img",{src:s.avatarUrl,className:"w-6 h-6 rounded-full",alt:""}),e.jsx("span",{className:"text-sm font-medium",children:s.displayName})]})}),e.jsx(i,{children:e.jsxs("span",{className:s.count>=l?"text-destructive font-semibold":"",children:[s.count," / ",l]})}),e.jsx(i,{className:"text-xs text-muted-foreground",children:L(new Date(s.lastUsed),"HH:mm:ss")}),e.jsx(i,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[[...new Set(s.recipes)].slice(0,3).map((t,o)=>e.jsx("span",{className:"text-xs bg-muted px-1.5 py-0.5 rounded",children:t},o)),s.recipes.length>3&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",s.recipes.length-3]})]})}),e.jsx(i,{className:"text-right",children:e.jsxs(O,{variant:"ghost",size:"sm",onClick:()=>j.mutate(s.userId),disabled:j.isPending,className:"text-destructive hover:text-destructive",children:[e.jsx(M,{className:"h-3.5 w-3.5 mr-1"}),"重置"]})})]},s.userId)):e.jsx(x,{children:e.jsx(i,{colSpan:5,className:"text-center py-8 text-muted-foreground",children:"今日暂无使用记录"})})})]})})]})]})};export{R as default};
//# sourceMappingURL=AdminVideoUsage-DJBl5B-T.js.map
