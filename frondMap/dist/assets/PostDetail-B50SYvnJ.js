import{p as W,u as O,r,j as e,b0 as je,L as N,b5 as pe,a_ as ve,aw as we,ay as ye,ed as Y,be as Ne,b3 as be,bm as Ce,c9 as Se,X as ke,bj as Te,W as De,w as _e,bq as Le,q as Ae,aM as ze,bL as H}from"./vendor-react-Bn2TaA3H.js";import{u as Ie,C as Pe,p as Me,P as Ee,Q as Re,R as Fe,K as $e,L as qe,B as c,M as Ye,N as He,q as Qe,g as Q,r as Ke,A as Ue,t as Be,v as We,w as Oe,x as Je,y as Ve,z as Xe,E as Ge}from"./index-B3Qm82qo.js";import{C as K,a as U,b as B}from"./carousel-CSBfYIp4.js";import{c as Ze,i as es,b as ss,j as ts}from"./useCommunityPosts-CA8T9HkG.js";import{u as as}from"./useLocalizedContent-DJ_BbG19.js";import{T as ns,R as ls}from"./RestaurantComments-B4T_Kv07.js";import{u as rs}from"./ShareDrawer-CFarpKp-.js";import{H as os,p as is,I as cs,J as ms}from"./vendor-utils-Z4kpnli5.js";import{P as ds}from"./PullToRefresh-Bw9OgfZz.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CnpAsn-m.js";import"./ReportDialog-Pdg2Vc25.js";import"./input-otp-C2_xBI7b.js";import"./useSensitiveWords-CZMbbCEo.js";import"./drawer-PJEbXVEL.js";const us=({post:s,showActions:j=!0,isDetailPage:u=!1})=>{const{t:l,i18n:m}=W(),{user:h}=Ie(),b=O(),{getLocalizedField:p}=as(),J=Ze(),V=es(),X=ss(),[G,C]=r.useState(!1),[_,L]=r.useState({}),[S,x]=r.useState(!1),[A,z]=r.useState(0),[g,Z]=r.useState(),[I,ee]=r.useState(),[P,M]=r.useState(0),[se,te]=r.useState(null);r.useState(null),r.useState(!1),r.useState(0),r.useState(!1);const[E,ae]=r.useState({}),[f,w]=r.useState(null),[k,R]=r.useState(!1),{share:ne,DrawerComponent:le}=rs();r.useEffect(()=>{if(S){const t=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${t}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.overflow="",window.scrollTo(0,t)}}},[S]),r.useEffect(()=>{g&&(M(g.selectedScrollSnap()),g.on("select",()=>{M(g.selectedScrollSnap())}))},[g]);const re=()=>{switch(m.language){case"zh":return ms;case"pt":return cs;default:return is}},oe=()=>{h&&J.mutate({postId:s.id,liked:s.user_liked||!1})},ie=async()=>{const t=`${window.location.origin}/community/${s.id}`;ne({title:l("community.shareTitle","分享帖子"),text:s.content.replace(/<[^>]*>/g,"").substring(0,100),url:t},()=>{h&&V.mutate(s.id),_e.success(l("community.shareSuccess","分享成功"))})},ce=()=>{X.mutate(s.id),C(!1)},F=t=>{u?(z(t),x(!0)):b(`/community/${s.id}`)},y=(t,a)=>{const o=t.currentTarget;ae(i=>({...i,[a]:{width:o.naturalWidth,height:o.naturalHeight}}))},$=t=>{const a=E[t];return a?a.height/a.width>1.5:!1},me=h?.id===s.author_id,de=s.activity?p(s.activity,"title"):null,v=[...s.restaurants||[],...s.restaurant&&!s.restaurants?.find(t=>t.id===s.restaurant?.id)?[s.restaurant]:[]],T=u?3:2,ue=k?v:v.slice(0,T),q=v.length>T,he=p(s,"content"),xe=m.language==="zh"&&s.content_zh||m.language==="en"&&s.content_en||m.language==="pt"&&s.content_pt,ge=(se||he||s.content)?.replace(/\n/g,"<br>")||"";return e.jsxs(e.Fragment,{children:[e.jsxs(Pe,{className:"overflow-hidden",children:[e.jsx(Me,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Ee,{className:"h-10 w-10",children:[e.jsx(Re,{src:s.author?.avatar_url||void 0}),e.jsx(Fe,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:os(new Date(s.created_at),{addSuffix:!0,locale:re()})})]})]}),j&&me&&e.jsxs($e,{children:[e.jsx(qe,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(je,{className:"h-4 w-4"})})}),e.jsx(Ye,{align:"end",children:e.jsx(He,{onClick:()=>C(!0),className:"text-destructive",children:l("common.delete","删除")})})]})]})}),e.jsxs(Qe,{className:"pt-0 pb-3",children:[(s.activity||v.length>0)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3 items-center",children:[s.activity&&e.jsx(N,{to:`/activity/${s.activity.id}`,children:e.jsxs(Q,{variant:"secondary",className:"gap-1",children:[e.jsx(pe,{className:"h-3 w-3"}),de]})}),ue.map(t=>e.jsx(N,{to:`/restaurant/${t.id}`,children:e.jsxs(Q,{variant:"secondary",className:"gap-1",children:[e.jsx(ve,{className:"h-3 w-3"}),p(t,"name")]})},t.id)),q&&!k&&e.jsxs("button",{onClick:()=>R(!0),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-0.5",children:["+",v.length-T," ",l("community.more","更多"),e.jsx(we,{className:"h-3 w-3"})]}),k&&q&&e.jsxs("button",{onClick:()=>R(!1),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-0.5",children:[l("community.collapse","收起"),e.jsx(ye,{className:"h-3 w-3"})]})]}),e.jsx(N,{to:`/community/${s.id}`,children:e.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert",dangerouslySetInnerHTML:{__html:ge}})}),!xe&&e.jsx(ns,{text:s.content,onTranslation:te,className:"mt-1"}),(()=>{const t=u&&s.video_url?(s.image_urls||[]).filter(a=>!a.includes("-cover")):s.image_urls;return!t||t.length===0?null:e.jsx("div",{className:"relative mt-3",children:t.length===1?(()=>{const a=t[0],o=$(a);return e.jsx("div",{className:"relative overflow-hidden rounded-lg cursor-pointer max-h-[300px] sm:max-h-[400px]",onClick:()=>F(0),children:_[a]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:l("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"",className:"w-full max-h-[300px] sm:max-h-[400px] object-cover object-top",onLoad:i=>y(i,a),onError:()=>L(i=>({...i,[a]:!0}))}),o&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx(Y,{className:"h-3 w-3"}),e.jsx("span",{children:l("community.longImage","长图")})]})]})})})():e.jsxs(e.Fragment,{children:[e.jsx(K,{setApi:Z,className:"w-full",opts:{loop:!0},children:e.jsx(U,{className:"-ml-0",children:t.map((a,o)=>{const i=$(a);return e.jsx(B,{className:"pl-0",children:e.jsx("div",{className:"relative overflow-hidden rounded-lg cursor-pointer aspect-[4/3] bg-muted",onClick:()=>F(o),children:_[a]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:l("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"",className:"w-full h-full object-contain",onLoad:n=>y(n,a),onError:()=>L(n=>({...n,[a]:!0}))}),i&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx(Y,{className:"h-3 w-3"}),e.jsx("span",{children:l("community.longImage","长图")})]})]})})},o)})})}),e.jsxs("div",{className:"absolute top-3 right-3 bg-black/60 text-white text-xs px-2 py-1 rounded-full z-10",children:[P+1,"/",t.length]}),e.jsx("div",{className:"flex justify-center gap-1.5 mt-2",children:t.map((a,o)=>e.jsx("button",{className:`w-1.5 h-1.5 rounded-full transition-colors ${o===P?"bg-primary":"bg-muted-foreground/30"}`,onClick:i=>{i.stopPropagation(),g?.scrollTo(o)}},o))})]})})})(),s.video_url&&e.jsx("div",{className:"mt-3 rounded-lg overflow-hidden bg-gray-900",children:e.jsx("video",{src:s.video_url,...s.image_urls?.length?{poster:s.image_urls[0]}:{},controls:!0,className:"w-full max-h-96",preload:"metadata",playsInline:!0})})]}),e.jsx(Ke,{className:"pt-0 border-t",children:e.jsxs("div",{className:"flex items-center gap-4 pt-3 w-full",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:`gap-2 ${s.user_liked?"text-red-500":""}`,onClick:oe,disabled:!h,children:[e.jsx(Ne,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count})]}),e.jsx(N,{to:`/community/${s.id}`,children:e.jsxs(c,{variant:"ghost",size:"sm",className:"gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),e.jsx("span",{children:s.comments_count})]})}),e.jsxs(c,{variant:"ghost",size:"sm",className:"gap-2",onClick:ie,children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsx("span",{children:s.shares_count})]})]})})]}),e.jsx(Ue,{open:G,onOpenChange:C,children:e.jsxs(Be,{children:[e.jsxs(We,{children:[e.jsx(Oe,{children:l("common.confirmDelete","确认删除")}),e.jsx(Je,{children:l("community.deleteWarning","删除后无法恢复，确定要删除这篇帖子吗？")})]}),e.jsxs(Ve,{children:[e.jsx(Xe,{children:l("common.cancel","取消")}),e.jsx(Ge,{onClick:ce,children:l("common.delete","删除")})]})]})}),S&&Se.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black overflow-hidden",onClick:t=>{t.target===t.currentTarget&&x(!1)},onWheel:t=>t.stopPropagation(),onTouchMove:t=>t.stopPropagation(),children:[s.image_urls&&s.image_urls.length>1&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-10 text-white text-sm bg-black/50 px-4 py-1.5 rounded-full",children:[A+1," / ",s.image_urls.length]}),e.jsx(c,{variant:"ghost",size:"icon",className:"absolute top-4 right-4 z-10 text-white hover:bg-white/20",onClick:()=>x(!1),children:e.jsx(ke,{className:"h-6 w-6"})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(K,{className:"w-full",opts:{loop:!0,startIndex:A},setApi:t=>{ee(t),t&&t.on("select",()=>{z(t.selectedScrollSnap())})},children:e.jsx(U,{className:"-ml-0",children:s.image_urls?.map((t,a)=>{const o=E[t],i=o?o.height/o.width>1.5:!1;return e.jsx(B,{className:"pl-0 flex items-center justify-center",children:i?e.jsx("div",{className:"w-full h-screen overflow-x-hidden overflow-y-scroll overscroll-contain",onMouseDown:n=>{const d=n.currentTarget;w({y:n.clientY,scrollTop:d.scrollTop})},onMouseUp:n=>{if(f){const d=Math.abs(n.clientY-f.y),D=Math.abs(n.currentTarget.scrollTop-f.scrollTop);d<10&&D<10&&x(!1),w(null)}},onTouchStart:n=>{const d=n.currentTarget;w({y:n.touches[0].clientY,scrollTop:d.scrollTop})},onTouchEnd:n=>{if(f){const d=n.changedTouches[0],D=Math.abs(d.clientY-f.y),fe=Math.abs(n.currentTarget.scrollTop-f.scrollTop);D<15&&fe<15&&(n.preventDefault(),x(!1)),w(null)}},children:e.jsx("img",{src:t,alt:"",className:"block select-none",style:{width:"100vw",minHeight:"100dvh",height:"auto",margin:0},draggable:!1,onLoad:n=>y(n,t)})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("img",{src:t,alt:"",className:"object-contain w-screen h-screen select-none cursor-pointer",draggable:!1,onClick:()=>x(!1),onLoad:n=>y(n,t)})})},a)})})})}),s.image_urls&&s.image_urls.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(c,{variant:"ghost",size:"icon",className:"absolute left-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>I?.scrollPrev(),children:e.jsx(Te,{className:"h-8 w-8"})}),e.jsx(c,{variant:"ghost",size:"icon",className:"absolute right-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>I?.scrollNext(),children:e.jsx(De,{className:"h-8 w-8"})})]})]}),document.body),le]})},Ls=()=>{const{id:s}=Le(),{t:j}=W(),u=O(),l=Ae(),{data:m,isLoading:h,error:b}=ts(s||""),p=r.useCallback(async()=>{l.removeQueries({queryKey:["community-post",s]}),l.removeQueries({queryKey:["comments",s]}),await Promise.all([l.invalidateQueries({queryKey:["community-post",s]}),l.invalidateQueries({queryKey:["comments",s]})])},[l,s]);return h?e.jsx("div",{className:"container max-w-2xl mx-auto py-6 px-4 flex justify-center",children:e.jsx(ze,{className:"h-8 w-8 animate-spin"})}):b||!m?e.jsx("div",{className:"container max-w-2xl mx-auto py-6 px-4",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground",children:j("community.postNotFound","帖子不存在或已被删除")}),e.jsxs(c,{variant:"outline",className:"mt-4",onClick:()=>u("/community"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),j("community.backToList","返回社区")]})]})}):e.jsx(ds,{onRefresh:p,children:e.jsxs("div",{className:"container max-w-2xl mx-auto py-6 px-4",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"mb-4",onClick:()=>u("/community"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),j("community.backToList","返回社区")]}),e.jsx(us,{post:m,showActions:!0,isDetailPage:!0}),e.jsx("div",{className:"mt-6",children:e.jsx(ls,{targetId:m.id,targetType:"post"})})]})})};export{Ls as default};
//# sourceMappingURL=PostDetail-B50SYvnJ.js.map
