import{p as P,r as a,w as N,j as e,bz as T,X as B,a6 as V,dS as O,cl as X,bJ as H,aM as J,bL as Q,c8 as W,aw as q,et as G,b2 as K,bi as D,ab as Y}from"./vendor-react-87iFmKFJ.js";import{s as S,i as y,ae as M}from"./index-C3xfGQgV.js";const te=()=>{const{t:u,i18n:w}=P(),[x,m]=a.useState(!1),[j,s]=a.useState(!1),[n,c]=a.useState(!1),[h,b]=a.useState(!1);return{identifyIngredients:async r=>{m(!0);try{const{data:t,error:i}=await S.functions.invoke("ai-recipe/identify",{body:{image_url:r}});if(i)throw i;if(t?.error)throw new Error(t.error);return t.ingredients||[]}catch(t){return console.error("Identify error:",t),N.error(u("aiRecipe.identifyError","食材识别失败，请重试")),null}finally{m(!1)}},generateRecipes:async(r,t,i,d,o,f)=>{s(!0);try{const{data:p,error:k}=await S.functions.invoke("ai-recipe/generate",{body:{ingredients:r,difficulty:t,servings:i,recipe_count:d||3,dish_count_specified:!!d,notes:o,exclude_dishes:f}});if(k){const C=(k?.context?.body?await k.context.json?.().catch(()=>null):null)?.error||k.message;if(C?.includes("credits"))return N.error(u("aiRecipe.creditsExhausted","AI 额度不足，请充值后重试")),null;if(C?.includes("rate limit"))return N.error(u("aiRecipe.rateLimited","请求过于频繁，请稍后重试")),null;throw new Error(C)}if(p?.error){if(p.error.includes("credits"))return N.error(u("aiRecipe.creditsExhausted","AI 额度不足，请充值后重试")),null;throw new Error(p.error)}return p.recipes||[]}catch(p){return console.error("Generate error:",p),N.error(u("aiRecipe.generateError","菜谱生成失败，请重试")),null}finally{s(!1)}},generateRecipeImages:async(r,t)=>{if(r.length){b(!0);try{const{data:i,error:d}=await S.functions.invoke("ai-recipe/generate-images",{body:{recipes:r}});if(d||!i?.images)return;for(const o of i.images)o.image_url&&t(o.recipe_name,o.image_url,o.image_source||"ai")}catch(i){console.error("Image generation error:",i)}finally{b(!1)}}},verifyResultPhoto:async(r,t,i,d)=>{c(!0);try{const{data:o,error:f}=await S.functions.invoke("ai-recipe/verify-photo",{body:{image_url:r,recipe_name:t,exif_time:i,lang:w.language,photo_source:d||"camera"}});if(f)throw f;if(o?.error)throw new Error(o.error);return o}catch(o){return console.error("Verify error:",o),N.error(u("aiRecipe.verifyError","照片验证失败，请重试")),null}finally{c(!1)}},uploadImage:async(r,t)=>{try{const i=r.name.split(".").pop(),d=`${t}/${Date.now()}-${Math.random().toString(36).slice(2)}.${i}`,{data:o,error:f}=await S.storage.from("community-images").upload(d,r,{cacheControl:"3600",upsert:!1});if(f)throw f;const{data:p}=S.storage.from("community-images").getPublicUrl(o.path);return p.publicUrl}catch(i){return console.error("Upload error:",i),N.error(u("common.uploadFailed","上传失败")),null}},isIdentifying:x,isGenerating:j,isVerifying:n,isGeneratingImages:h}},Z=({onCapture:u,onClose:w})=>{const{t:x}=P(),m=a.useRef(null),j=a.useRef(null),s=a.useRef(null),[n,c]=a.useState(!1),[h,b]=a.useState("environment"),[l,v]=a.useState(!1),I=a.useCallback(async r=>{s.current&&(s.current.getTracks().forEach(t=>t.stop()),s.current=null),c(!1);try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:r},audio:!1});s.current=t,m.current&&(m.current.srcObject=t,m.current.onloadedmetadata=()=>{m.current?.play(),c(!0)})}catch(t){console.error("Camera error:",t),t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?N.error(x("aiRecipe.cameraPermissionDenied","相机权限被拒绝，请在浏览器设置中允许访问相机")):t.name==="NotFoundError"?N.error(x("aiRecipe.cameraNotFound","未找到相机设备")):N.error(x("aiRecipe.cameraError","无法访问相机，请检查权限设置")),w()}},[w,x]);a.useEffect(()=>(I(h),()=>{s.current?.getTracks().forEach(r=>r.stop())}),[]);const R=async()=>{const r=h==="environment"?"user":"environment";b(r),await I(r)},E=()=>{if(!m.current||!j.current||!n)return;v(!0);const r=m.current,t=j.current;t.width=r.videoWidth,t.height=r.videoHeight;const i=t.getContext("2d");i&&(i.drawImage(r,0,0),t.toBlob(d=>{if(d){const o=new File([d],`photo-${Date.now()}.jpg`,{type:"image/jpeg"});s.current?.getTracks().forEach(f=>f.stop()),u(o)}v(!1)},"image/jpeg",.92))};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black flex flex-col",children:[e.jsxs("div",{className:"relative flex-1 overflow-hidden",children:[e.jsx("video",{ref:m,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),e.jsx("canvas",{ref:j,className:"hidden"}),n&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsxs("div",{className:"w-64 h-64 relative",children:[e.jsx("div",{className:"absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white/80 rounded-tl"}),e.jsx("div",{className:"absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white/80 rounded-tr"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/80 rounded-bl"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white/80 rounded-br"})]})}),!n&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3 text-white/70",children:[e.jsx(T,{className:"h-10 w-10 animate-pulse"}),e.jsx("span",{className:"text-sm",children:x("aiRecipe.cameraLoading","相机加载中...")})]})})]}),e.jsxs("div",{className:"bg-black/90 px-6 py-6 flex items-center justify-between safe-area-bottom",children:[e.jsx(y,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/10 rounded-full w-12 h-12",onClick:()=>{s.current?.getTracks().forEach(r=>r.stop()),w()},children:e.jsx(B,{className:"h-6 w-6"})}),e.jsx("button",{onClick:E,disabled:!n||l,className:"w-20 h-20 rounded-full bg-white flex items-center justify-center disabled:opacity-50 active:scale-95 transition-transform",children:e.jsx(V,{className:"w-16 h-16 text-black fill-black/10"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/10 rounded-full w-12 h-12",onClick:R,disabled:!n,children:e.jsx(O,{className:"h-6 w-6"})})]})]})},re=({onPhotoVerified:u,uploadImage:w,verifyPhoto:x,recipeName:m,isVerifying:j})=>{const{t:s}=P(),[n,c]=a.useState(!1),[h,b]=a.useState(null),[l,v]=a.useState(null),[I,R]=a.useState(!1),[E,r]=a.useState(null),[t,i]=a.useState(null),[d,o]=a.useState(""),[f,p]=a.useState(!1),[k,L]=a.useState(!1),C=a.useRef(null),U=async(g,_)=>{c(!0),v(null),r(_),b(URL.createObjectURL(g)),o(""),p(!1);const F=await w(g,"ai-recipe-results");if(!F){c(!1);return}i(F),c(!1);const z=await x(F,m,_);v(z),z?.is_genuine&&p(!0)},$=g=>{R(!1),U(g,"camera")},A=()=>{t&&l&&u(t,l.is_genuine,d.trim()||void 0)};return e.jsxs(e.Fragment,{children:[I&&e.jsx(Z,{onCapture:$,onClose:()=>R(!1)}),e.jsx("input",{ref:C,type:"file",accept:"image/*",className:"hidden",onChange:g=>{const _=g.target.files?.[0];_&&U(_,"upload"),g.target.value=""}}),e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto",children:e.jsx(X,{className:"h-10 w-10 text-primary"})}),e.jsx("h3",{className:"text-lg font-semibold",children:s("aiRecipe.resultPhotoTitle","拍摄成品")}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-xs",children:s("aiRecipe.resultPhotoDesc","拍摄或上传成品照片，系统将验证真实性")})]}),!h&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg w-full max-w-sm bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-400",children:[e.jsx(H,{className:"h-4 w-4 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs",children:s("aiRecipe.uploadStricterNote","相册上传将接受更严格的审核，建议直接拍摄")})]}),h&&e.jsxs("div",{className:"w-full max-w-sm rounded-xl overflow-hidden border relative",children:[e.jsx("img",{src:h,alt:"Result",className:"w-full h-48 object-cover"}),E==="upload"&&e.jsx("div",{className:"absolute top-2 right-2 bg-amber-500 text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s("aiRecipe.fromGallery","相册")}),E==="camera"&&e.jsx("div",{className:"absolute top-2 right-2 bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s("aiRecipe.fromCamera","拍摄")})]}),(n||j)&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(J,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:n?s("common.uploading","上传中..."):s("aiRecipe.verifying","验证中...")})]}),l&&e.jsxs("div",{className:`w-full max-w-sm rounded-lg overflow-hidden ${l.is_genuine?"bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-400":"bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 p-3",children:[l.is_genuine?e.jsx(Q,{className:"h-5 w-5 shrink-0"}):e.jsx(W,{className:"h-5 w-5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium flex-1",children:l.is_genuine?s("aiRecipe.photoVerified","照片验证通过"):s("aiRecipe.photoNotVerified","照片验证未通过")}),!l.is_genuine&&l.explanation&&e.jsxs("button",{onClick:()=>L(g=>!g),className:"flex items-center gap-0.5 text-xs opacity-70 hover:opacity-100 shrink-0",children:[s("aiRecipe.viewReason","原因"),e.jsx(q,{className:`h-3.5 w-3.5 transition-transform ${k?"rotate-180":""}`})]})]}),!l.is_genuine&&k&&l.explanation&&e.jsx("div",{className:"px-3 pb-3 text-xs opacity-80 border-t border-current/10 pt-2",children:l.explanation})]}),f&&l?.is_genuine&&e.jsxs("div",{className:"w-full max-w-sm space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-medium",children:[e.jsx(G,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:s("aiRecipe.cookingNote","写下烹饪心得")}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal ml-1",children:s("common.optional","（可选）")})]}),e.jsx(M,{placeholder:s("aiRecipe.cookingNotePlaceholder","分享一下今天的烹饪体验、技巧或感受..."),value:d,onChange:g=>o(g.target.value),rows:3,maxLength:500,className:"resize-none text-sm"}),d.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[d.length,"/500"]})]}),l?.is_genuine?e.jsxs("div",{className:"flex flex-col gap-2 w-full max-w-sm",children:[e.jsxs(y,{className:"w-full gap-2 h-11",onClick:A,children:[e.jsx(K,{className:"h-4 w-4"}),s("aiRecipe.continueToShare","继续")]}),e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsxs(y,{variant:"ghost",className:"flex-1 gap-2 text-muted-foreground",onClick:()=>R(!0),children:[e.jsx(T,{className:"h-4 w-4"}),s("aiRecipe.retakePhoto","重新拍摄")]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-9 w-9 shrink-0 text-muted-foreground",onClick:()=>C.current?.click(),title:s("aiRecipe.uploadFromGallery","上传相册"),children:e.jsx(D,{className:"h-4 w-4"})})]})]}):e.jsxs("div",{className:"flex items-center gap-3 w-full max-w-sm",children:[e.jsxs(y,{className:"flex-1 gap-2 h-11",onClick:()=>R(!0),disabled:n||j,children:[e.jsx(T,{className:"h-4 w-4"}),h?s("aiRecipe.retakePhoto","重新拍摄"):s("aiRecipe.takeResultPhoto","拍摄成品")]}),e.jsx(y,{variant:"outline",size:"icon",className:"h-11 w-11 shrink-0",onClick:()=>C.current?.click(),disabled:n||j,title:s("aiRecipe.uploadFromGallery","上传相册"),children:e.jsx(D,{className:"h-4 w-4"})})]})]})]})},ae=({resultImageUrl:u,recipeName:w,initialNote:x="",onPublish:m,onSkip:j,isPublishing:s})=>{const{t:n}=P(),[c,h]=a.useState(x),[b,l]=a.useState(!1);return e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx("h3",{className:"text-lg font-semibold",children:n("aiRecipe.congratulations","恭喜完成！")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n("aiRecipe.publishQuestion","要发布到社区吗？")})]}),u&&e.jsxs("div",{className:"w-full max-w-sm rounded-xl overflow-hidden border",children:[e.jsx("img",{src:u,alt:w,className:"w-full h-48 object-cover"}),e.jsxs("div",{className:"p-3 space-y-2",children:[e.jsx("p",{className:"font-medium text-sm",children:w}),b?e.jsxs("div",{className:"space-y-1",children:[e.jsx(M,{autoFocus:!0,placeholder:n("aiRecipe.cookingNotePlaceholder","分享一下今天的烹饪体验、技巧或感受..."),value:c,onChange:v=>h(v.target.value),rows:3,maxLength:500,className:"resize-none text-sm",disabled:s,onBlur:()=>l(!1)}),c.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[c.length,"/500"]})]}):e.jsx("button",{className:"w-full text-left",onClick:()=>l(!0),disabled:s,children:c?e.jsxs("p",{className:"text-sm text-foreground/80 flex items-start gap-1.5",children:[e.jsx(G,{className:"h-3.5 w-3.5 mt-0.5 shrink-0 text-primary"}),c]}):e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1.5",children:[e.jsx(G,{className:"h-3.5 w-3.5 shrink-0"}),n("aiRecipe.addCookingNote","点击添加烹饪心得...")]})})]})]}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsxs(y,{className:"w-full gap-2",onClick:()=>m(c),disabled:s,children:[e.jsx(Y,{className:"h-4 w-4"}),s?n("common.publishing","发布中…"):n("aiRecipe.publishToCommunity","发布到社区")]})})]})};export{Z as C,ae as P,re as R,te as u};
//# sourceMappingURL=PublishConfirmStep-0Yglv_km.js.map
