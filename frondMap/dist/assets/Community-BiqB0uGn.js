import{j as e}from"./vendor-ui-DmpovMYY.js";import{u as G,r as n}from"./vendor-react-iAJ0IrSD.js";import{u as H,bx as K,ax as X,ay as W,az as Y,V as Z,D as J,aE as ee,B as y,c as se,d as ae,e as te,aB as D,bi as re,av as le,aW as ne,aX as ie,aY as oe,aZ as ce,a_ as L,X as z,$ as de,bQ as me,L as R,a6 as S,s as v,b2 as ue,K as b}from"./index-Dqx1Dcau.js";import{c as he,d as xe,e as pe,f as fe}from"./useCommunityPosts-B9i5Q9ei.js";import{u as V}from"./useLocalizedContent-BN2IWylL.js";import{u as A}from"./vendor-i18n-DxKeo2S1.js";import{u as ge}from"./useActivities-BaxwyVD6.js";import{P as je}from"./PullToRefresh-BaUp_3Ai.js";import{u as ve}from"./vendor-query-D82cqPtt.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-6pZ9VDFn.js";const be=({post:s})=>{const{t:a}=A(),{user:c}=H(),m=G(),{getLocalizedField:p}=V(),N=he(),[i,d]=n.useState(!1),I=o=>{o.preventDefault(),o.stopPropagation(),c&&N.mutate({postId:s.id,liked:s.user_liked||!1})},u=()=>{m(`/community/${s.id}`)},w=o=>new DOMParser().parseFromString(o,"text/html").body.textContent||"",f=p(s,"content"),C=w(f),k=s.image_urls&&s.image_urls.length>0,P=!!s.video_url,g=k||P,h=s.image_urls?.length||0;return e.jsxs("div",{className:"group cursor-pointer rounded-lg overflow-hidden bg-card border border-border/50 hover:shadow-lg transition-all duration-300 hover:-translate-y-1",onClick:u,children:[g&&e.jsx("div",{className:"relative",children:k?e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden",children:[i?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:a("common.imageLoadError","图片加载失败")})}):e.jsx("img",{src:s.image_urls[0],alt:"",className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",onError:()=>d(!0)}),h>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full z-10 flex items-center gap-1",children:[e.jsx(K,{className:"h-3 w-3"}),e.jsx("span",{children:h})]})]}):P?e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden bg-black",children:[e.jsx("video",{src:s.video_url,className:"w-full h-full object-cover",preload:"metadata",muted:!0}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-white/30 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"w-0 h-0 border-l-[16px] border-l-white border-y-[10px] border-y-transparent ml-1"})})})]}):null}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:`text-sm font-medium line-clamp-2 leading-relaxed ${g?"":"min-h-[60px]"}`,children:C}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(X,{className:"h-5 w-5 flex-shrink-0",children:[e.jsx(W,{src:s.author?.avatar_url||void 0}),e.jsx(Y,{className:"text-[10px]",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:s.author?.display_name})]}),e.jsxs("button",{className:`flex items-center gap-1 text-xs ${s.user_liked?"text-red-500":"text-muted-foreground"} hover:text-red-500 transition-colors`,onClick:I,disabled:!c,children:[e.jsx(Z,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count||0})]})]})]})]})},ye=({trigger:s})=>{const{t:a}=A(),{getLocalizedField:c}=V(),m=xe(),{data:p}=ge(),[N,i]=n.useState(!1),[d,I]=n.useState(""),[u,w]=n.useState([]),[f,C]=n.useState(null),[k,P]=n.useState(""),[g,h]=n.useState(!1),o=n.useRef(null),_=n.useRef(null),T=async t=>{const r=t.target.files;if(!(!r||r.length===0)){if(u.length+r.length>9){S.error(a("community.maxImages","最多上传9张图片"));return}h(!0);try{const{data:{user:l}}=await v.auth.getUser();if(!l)throw new Error("Not authenticated");const j=[];for(const x of Array.from(r)){const U=x.name.split(".").pop(),E=`${l.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${U}`,{error:$}=await v.storage.from("community-posts").upload(E,x);if($)throw $;const{data:{publicUrl:Q}}=v.storage.from("community-posts").getPublicUrl(E);j.push(Q)}w(x=>[...x,...j])}catch(l){console.error("Upload error:",l),S.error(a("common.uploadError","上传失败"))}finally{h(!1),o.current&&(o.current.value="")}}},F=async t=>{const r=t.target.files?.[0];if(r){if(r.size>100*1024*1024){S.error(a("community.videoTooLarge","视频不能超过100MB"));return}h(!0);try{const{data:{user:l}}=await v.auth.getUser();if(!l)throw new Error("Not authenticated");const j=r.name.split(".").pop(),x=`${l.id}/${Date.now()}.${j}`,{error:U}=await v.storage.from("community-posts").upload(x,r);if(U)throw U;const{data:{publicUrl:E}}=v.storage.from("community-posts").getPublicUrl(x);C(E)}catch(l){console.error("Upload error:",l),S.error(a("common.uploadError","上传失败"))}finally{h(!1),_.current&&(_.current.value="")}}},q=t=>{w(r=>r.filter((l,j)=>j!==t))},B=()=>{C(null)},M=async()=>{if(!d.trim()){S.error(a("community.contentRequired","请输入内容"));return}await m.mutateAsync({content:d,image_urls:u,video_url:f||void 0,activity_id:k||void 0}),I(""),w([]),C(null),P(""),i(!1)},O=p?.filter(t=>t.status==="published")||[];return e.jsxs(J,{open:N,onOpenChange:i,children:[e.jsx(ee,{asChild:!0,children:s||e.jsx(y,{children:a("community.createPost","发布帖子")})}),e.jsxs(se,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(ae,{children:e.jsx(te,{children:a("community.createPost","发布帖子")})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:a("community.content","内容")}),e.jsx(re,{value:d,onChange:t=>I(t.target.value),placeholder:a("community.contentPlaceholder","分享你的想法..."),rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),a("community.linkActivity","关联活动")]}),e.jsxs(ne,{value:k||"none",onValueChange:t=>P(t==="none"?"":t),children:[e.jsx(ie,{children:e.jsx(oe,{placeholder:a("community.selectActivity","选择活动（可选）")})}),e.jsxs(ce,{children:[e.jsx(L,{value:"none",children:a("community.noActivity","不关联活动")}),O.map(t=>e.jsx(L,{value:t.id,children:c(t,"title")},t.id))]})]})]}),u.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:u.map((t,r)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden",children:[e.jsx("img",{src:t,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>q(r),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(z,{className:"h-3 w-3"})})]},r))}),f&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:f,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:B,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:o,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:T}),e.jsx("input",{ref:_,type:"file",accept:"video/*",className:"hidden",onChange:F}),e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>o.current?.click(),disabled:g||u.length>=9,children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),a("community.addImage","添加图片")]}),e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>_.current?.click(),disabled:g||!!f,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),a("community.addVideo","添加视频")]}),g&&e.jsx(R,{className:"h-4 w-4 animate-spin"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(y,{variant:"outline",onClick:()=>i(!1),children:a("common.cancel","取消")}),e.jsxs(y,{onClick:M,disabled:m.isPending||!d.trim(),children:[m.isPending&&e.jsx(R,{className:"h-4 w-4 mr-2 animate-spin"}),a("community.publish","发布")]})]})]})]})]})},Ne=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(b,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{className:"h-4 w-full"}),e.jsx(b,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5 rounded-full"}),e.jsx(b,{className:"h-3 w-16"})]}),e.jsx(b,{className:"h-4 w-10"})]})]})]}),De=()=>{const{t:s}=A(),a=ve(),{data:c,isLoading:m}=pe({status:"approved"}),{data:p}=fe(),N=n.useCallback(async()=>{await a.invalidateQueries({queryKey:["community-posts"]})},[a]);return e.jsx(je,{onRefresh:N,children:e.jsxs("div",{className:"container max-w-4xl mx-auto py-4 px-3 sm:px-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:s("nav.community","社区")}),p&&e.jsx(ye,{trigger:e.jsxs(y,{size:"sm",className:"gap-1.5",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.createPost","发布")})]})})]}),e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:m?Array.from({length:6}).map((i,d)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Ne,{})},d)):c&&c.length>0?c.map(i=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(be,{post:i})},i.id)):e.jsxs("div",{className:"col-span-2 text-center py-12 text-muted-foreground",children:[e.jsx("p",{children:s("community.noPosts","暂无帖子")}),p&&e.jsx("p",{className:"mt-2",children:s("community.beFirst","成为第一个发帖的人吧！")})]})})]})})};export{De as default};
//# sourceMappingURL=Community-BiqB0uGn.js.map
