import{p as Se,r as c,q as Ce,s as T,v as ee,j as e,b9 as De,b4 as Ee,aX as ke,ba as I,M as se,y as te,bf as Ae,an as ae,cd as ne,bQ as Re,aN as re,ak as Me,bF as ie,a_ as Oe}from"./vendor-react-3frukg7q.js";import{s as o,C as _,p as P,F as L,$,q as S,I as w,B as d,K as qe,L as Fe,M as Te,N as le,g as C,D as oe,c as ce,d as de,e as me,T as ue,S as Ie,a2 as Pe,a3 as Le,a4 as $e,a5 as Ke,a6 as He,V as xe,A as Qe,t as Be,v as ze,w as Ve,x as Xe,y as Je,z as Ge,E as We,U as D,X as i}from"./index-DBl0LkXN.js";import{S as Ye}from"./switch-DEwqu3Qs.js";import{S as f}from"./separator-BdVmvCyt.js";import{H as Ze,D as he}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CcYybVOv.js";const je=["pending","received","completed","cancelled"],os=()=>{const{t:s}=Se(),[K,pe]=c.useState(""),[y,H]=c.useState("all"),[E,k]=c.useState(null),[fe,g]=c.useState(!1),[ge,b]=c.useState(!1),[a,A]=c.useState(null),[v,Q]=c.useState(""),[h,B]=c.useState(""),[R,M]=c.useState(!1),[O,u]=c.useState(!1),[U,z]=c.useState(!1),j=Ce(),{data:V,isLoading:ve}=T({queryKey:["joinRequests"],queryFn:async()=>{const{data:t,error:n}=await o.from("join_requests").select("*").order("created_at",{ascending:!1});if(n)throw n;const l=t?.map(r=>r.invited_by_user_id).filter(Boolean)||[];let m={};if(l.length>0){const{data:r}=await o.from("profiles").select("id, display_name").in("id",l);r&&(m=r.reduce((x,N)=>(x[N.id]=N.display_name||"",x),{}))}return t?.map(r=>({...r,inviter_name:r.invited_by_user_id?m[r.invited_by_user_id]:null}))||[]}}),{data:q}=T({queryKey:["emailConfig","join_request"],queryFn:async()=>{const{data:t,error:n}=await o.from("email_config").select("*").eq("type","join_request").single();if(n)throw n;return t}}),{data:X}=T({queryKey:["siteSettings"],queryFn:async()=>{const{data:t,error:n}=await o.from("site_settings").select("logo_url").single();if(n)throw n;return t}});c.useEffect(()=>{const t=o.channel("join_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"join_requests"},()=>{j.invalidateQueries({queryKey:["joinRequests"]})}).subscribe();return()=>{o.removeChannel(t)}},[j]);const p=V?.filter(t=>{const n=K.toLowerCase(),l=t.name.toLowerCase().includes(n)||t.email.toLowerCase().includes(n)||t.restaurant_name.toLowerCase().includes(n)||t.phone.toLowerCase().includes(n),m=y==="all"||t.status===y;return l&&m}),Ne=async()=>{const t=prompt(s("joinUs.enterNewEmail"),q?.recipient_email);if(t)try{const{error:n}=await o.from("email_config").update({recipient_email:t}).eq("id",q?.id);if(n)throw n;i({title:s("common.success"),description:s("joinUs.emailUpdated")})}catch(n){console.error("Error updating email:",n),i({title:s("common.error"),description:s("joinUs.emailUpdateError"),variant:"destructive"})}},J=ee({mutationFn:async({id:t,status:n})=>{const{error:l}=await o.from("join_requests").update({status:n}).eq("id",t);if(l)throw l},onSuccess:()=>{j.invalidateQueries({queryKey:["joinRequests"]}),i({title:s("common.success"),description:s("joinUs.statusUpdated")})},onError:t=>{console.error("Error updating status:",t),i({title:s("common.error"),description:s("joinUs.statusUpdateError"),variant:"destructive"})}}),G=ee({mutationFn:async t=>{const{error:n}=await o.from("join_requests").delete().eq("id",t);if(n)throw n},onSuccess:()=>{j.invalidateQueries({queryKey:["joinRequests"]}),i({title:s("common.success"),description:s("joinUs.requestDeleted")}),k(null)},onError:t=>{console.error("Error deleting request:",t),i({title:s("common.error"),description:s("joinUs.deleteError"),variant:"destructive"})}}),we=()=>{if(!p||p.length===0){i({title:s("admin.noDataToExport"),variant:"destructive"});return}const t=[["Name","Email","Phone","Restaurant Name","Restaurant Address","Features","Invitation Code","Invited By","Status","Submitted Date"],...p.map(r=>[r.name,r.email,r.phone,r.restaurant_name,r.restaurant_address||"",Array.isArray(r.features_selected)?r.features_selected.join(", "):"",r.invitation_code||"",r.inviter_name||"",r.status||"pending",new Date(r.created_at).toLocaleString()])].map(r=>r.map(x=>`"${x}"`).join(",")).join(`
`),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),m=URL.createObjectURL(n);l.setAttribute("href",m),l.setAttribute("download",`join_requests_${new Date().toISOString()}.csv`),l.click(),URL.revokeObjectURL(m),i({title:s("admin.exportSuccess")})},F=t=>{switch(t){case"completed":return"default";case"received":return"secondary";case"cancelled":return"destructive";default:return"outline"}},W=t=>{A(t),Q(t.email),B(""),z(!1),g(!0)},ye=t=>{A(t),b(!0)},be=async()=>{if(!a||!v.trim()||!h.trim()){i({title:s("common.error"),description:s("joinUs.accountPasswordRequired"),variant:"destructive"});return}if(h.length<6){i({title:s("common.error"),description:s("auth.passwordTooShort"),variant:"destructive"});return}try{if(U){M(!0);const Ue=`【小熊市场】您的商家账号信息 - ${a.restaurant_name}`,_e="您的商家账号信息如下！",{data:Y,error:Z}=await o.functions.invoke("send-merchant-email",{body:{to:a.email,subject:Ue,content:_e,merchantName:a.name,account:v,password:h,logoUrl:X?.logo_url||null}});if(Z)throw Z;if(!Y.success)throw new Error(Y.error);await o.from("join_requests").update({email_sent_at:new Date().toISOString()}).eq("id",a.id),j.invalidateQueries({queryKey:["joinRequests"]}),i({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),g(!1);return}u(!0);const{data:t}=await o.auth.getSession();if(!t?.session){i({title:s("common.error"),description:s("auth.sessionExpired"),variant:"destructive"}),u(!1);return}const{data:n,error:l}=await o.functions.invoke("admin-create-user",{body:{email:v,password:h,displayName:a.name,phone:a.phone,role:"merchant"}});if(l){console.error("Create user function error:",l),i({title:s("common.error"),description:l.message||s("admin.createUserError"),variant:"destructive"}),u(!1);return}if(n?.error){console.error("Create user business error:",n.error),i({title:s("common.error"),description:n.error,variant:"destructive"}),u(!1);return}if(!n?.success||!n?.user){console.error("User creation failed - no user returned"),i({title:s("common.error"),description:s("admin.createUserError"),variant:"destructive"}),u(!1);return}i({title:s("common.success"),description:s("joinUs.merchantUserCreated")}),u(!1),M(!0);const m=`【小熊市场】您的商家账号已创建 - ${a.restaurant_name}`,r="您的商家账号已创建成功！",{data:x,error:N}=await o.functions.invoke("send-merchant-email",{body:{to:a.email,subject:m,content:r,merchantName:a.name,account:v,password:h,logoUrl:X?.logo_url||null}});if(N)throw N;if(!x.success)throw new Error(x.error);await o.from("join_requests").update({status:"received",email_sent_at:new Date().toISOString()}).eq("id",a.id),j.invalidateQueries({queryKey:["joinRequests"]}),i({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),g(!1)}catch(t){console.error("Error:",t),i({title:s("common.error"),description:t.message||s("joinUs.emailSendError"),variant:"destructive"})}finally{u(!1),M(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("joinUs.adminTitle")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:s("joinUs.adminDescription")})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(_,{children:[e.jsxs(P,{children:[e.jsx(L,{children:s("joinUs.recipientEmail")}),e.jsx($,{children:s("joinUs.recipientEmailDesc")})]}),e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{value:q?.recipient_email||"",readOnly:!0}),e.jsx(d,{onClick:Ne,children:s("common.edit")})]})})]}),e.jsxs(_,{children:[e.jsxs(P,{children:[e.jsx(L,{children:s("joinUs.totalRequests")}),e.jsx($,{children:s("joinUs.totalRequestsDesc")})]}),e.jsx(S,{children:e.jsx("div",{className:"text-3xl font-bold",children:V?.length||0})})]})]}),e.jsxs(_,{children:[e.jsxs(P,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(L,{children:s("joinUs.allRequests")}),e.jsx($,{children:s("joinUs.allRequestsDesc")})]}),e.jsxs(d,{onClick:we,variant:"outline",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),s("admin.exportCSV")]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(w,{placeholder:s("joinUs.searchPlaceholder"),value:K,onChange:t=>pe(t.target.value),className:"pl-10"})]}),e.jsxs(qe,{children:[e.jsx(Fe,{asChild:!0,children:e.jsxs(d,{variant:"outline",className:"gap-2",children:[e.jsx(ke,{className:"w-4 h-4"}),s(y==="all"?"admin.allStatus":`joinUs.status.${y}`)]})}),e.jsxs(Te,{align:"end",className:"bg-background",children:[e.jsx(le,{onClick:()=>H("all"),children:s("admin.allStatus")}),je.map(t=>e.jsx(le,{onClick:()=>H(t),children:s(`joinUs.status.${t}`)},t))]})]})]})]}),e.jsx(S,{children:ve?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):p&&p.length>0?e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:p.map(t=>e.jsxs(_,{className:"relative overflow-hidden hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx(C,{variant:F(t.status||"pending"),children:s(`joinUs.status.${t.status||"pending"}`)})}),e.jsxs(S,{className:"pt-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-semibold text-lg truncate pr-20",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mt-1",children:[e.jsx(I,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:t.restaurant_name})]})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(se,{className:"w-3.5 h-3.5 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"truncate",children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(te,{className:"w-3.5 h-3.5 text-muted-foreground flex-shrink-0"}),e.jsx("span",{children:t.phone})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground mb-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ae,{className:"w-3 h-3"}),e.jsx("span",{children:Ze(new Date(t.created_at),{addSuffix:!0})})]}),t.invitation_code&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ae,{className:"w-3 h-3"}),e.jsx("code",{className:"text-xs bg-muted px-1 py-0.5 rounded",children:t.invitation_code})]})]}),t.email_sent_at&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-green-600 dark:text-green-400 mb-4",children:[e.jsx(ne,{className:"w-3 h-3"}),e.jsx("span",{children:s("joinUs.emailSent","邮件已发送")})]}),e.jsx(f,{className:"my-3"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>ye(t),children:[e.jsx(Re,{className:"w-4 h-4 mr-1.5"}),s("common.viewDetails","查看详情")]}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>W(t),title:s("joinUs.sendEmail"),children:e.jsx(re,{className:"w-4 h-4"})}),e.jsx(d,{size:"sm",variant:"destructive",onClick:()=>k(t.id),disabled:G.isPending,children:e.jsx(Me,{className:"w-4 h-4"})})]})]})]},t.id))}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("joinUs.noRequests")})})]})]}),e.jsx(oe,{open:ge,onOpenChange:b,children:e.jsxs(ce,{className:"sm:max-w-[600px] max-h-[85vh]",children:[e.jsxs(de,{children:[e.jsxs(me,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),a?.restaurant_name]}),e.jsx(ue,{children:s("joinUs.requestDetail","申请详情")})]}),e.jsx(Ie,{className:"max-h-[60vh] pr-4",children:a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:s("joinUs.status")}),e.jsxs(Pe,{value:a.status||"pending",onValueChange:t=>{J.mutate({id:a.id,status:t}),A({...a,status:t})},disabled:J.isPending,children:[e.jsx(Le,{className:"w-[150px]",children:e.jsx($e,{children:e.jsx(C,{variant:F(a.status||"pending"),children:s(`joinUs.status.${a.status||"pending"}`)})})}),e.jsx(Ke,{children:je.map(t=>e.jsx(He,{value:t,children:e.jsx(C,{variant:F(t),children:s(`joinUs.status.${t}`)})},t))})]})]}),e.jsx(f,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:s("joinUs.contactInfo","联系信息")}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ie,{className:"w-4 h-4 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:a.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.name")})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(se,{className:"w-4 h-4 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("a",{href:`mailto:${a.email}`,className:"text-sm font-medium hover:underline",children:a.email}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.email")})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(te,{className:"w-4 h-4 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("a",{href:`tel:${a.phone}`,className:"text-sm font-medium hover:underline",children:a.phone}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.phone")})]})]})]})]}),e.jsx(f,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:s("joinUs.restaurantInfo","餐厅信息")}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(I,{className:"w-4 h-4 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:a.restaurant_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.restaurantName")})]})]}),a.restaurant_address&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Oe,{className:"w-4 h-4 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:a.restaurant_address}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.restaurantAddress")})]})]})]})]}),e.jsx(f,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:s("joinUs.featuresNeeded")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Array.isArray(a.features_selected)&&a.features_selected.map((t,n)=>e.jsx(C,{variant:"secondary",children:s(`joinUs.feature.${t}`)},n)),(!a.features_selected||a.features_selected.length===0)&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"-"})]})]}),a.invitation_code&&e.jsxs(e.Fragment,{children:[e.jsx(f,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:s("joinUs.invitationCode","邀请码")}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("code",{className:"text-sm bg-muted px-2 py-1 rounded",children:a.invitation_code})]}),a.inviter_name&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ie,{className:"w-4 h-4"}),s("joinUs.invitedBy","邀请人"),": ",a.inviter_name]})]})]})]}),e.jsx(f,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:s("joinUs.timestamps","时间信息")}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:s("joinUs.submittedAt")}),e.jsx("span",{children:he(new Date(a.created_at),"yyyy-MM-dd HH:mm")})]}),a.email_sent_at&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:s("joinUs.emailSentAt","邮件发送时间")}),e.jsxs("div",{className:"flex items-center gap-1.5 text-green-600 dark:text-green-400",children:[e.jsx(ne,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:he(new Date(a.email_sent_at),"yyyy-MM-dd HH:mm")})]})]})]})]})]})}),e.jsxs(xe,{className:"flex-row gap-2 sm:justify-between",children:[e.jsxs(d,{variant:"outline",onClick:()=>{b(!1),W(a)},children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),s("joinUs.sendEmail")]}),e.jsx(d,{onClick:()=>b(!1),children:s("common.close","关闭")})]})]})}),e.jsx(Qe,{open:E!==null,onOpenChange:t=>!t&&k(null),children:e.jsxs(Be,{children:[e.jsxs(ze,{children:[e.jsx(Ve,{children:s("joinUs.confirmDelete")}),e.jsx(Xe,{children:s("joinUs.confirmDeleteDescription")})]}),e.jsxs(Je,{children:[e.jsx(Ge,{children:s("common.cancel")}),e.jsx(We,{onClick:()=>E&&G.mutate(E),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s("common.delete")})]})]})}),e.jsx(oe,{open:fe,onOpenChange:g,children:e.jsxs(ce,{className:"sm:max-w-[500px]",children:[e.jsxs(de,{children:[e.jsx(me,{children:s("joinUs.sendAccountTitle")}),e.jsx(ue,{children:s("joinUs.sendAccountDescription",{name:a?.name})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(D,{htmlFor:"emailOnlyMode",className:"font-medium",children:s("joinUs.emailOnlyMode")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.emailOnlyModeDesc")})]}),e.jsx(Ye,{id:"emailOnlyMode",checked:U,onCheckedChange:z})]}),!U&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:["ℹ️ ",s("joinUs.createUserModeNote")]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:s("joinUs.emailRecipient")}),e.jsx(w,{value:a?.email||"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"account",children:s("joinUs.merchantAccount")}),e.jsx(w,{id:"account",value:v,onChange:t=>Q(t.target.value),placeholder:s("joinUs.merchantAccountPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"password",children:s("joinUs.merchantPassword")}),e.jsx(w,{id:"password",type:"text",value:h,onChange:t=>B(t.target.value),placeholder:s("joinUs.merchantPasswordPlaceholder")})]}),e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:["⚠️ ",s("joinUs.passwordSecurityNote")]})})]}),e.jsxs(xe,{children:[e.jsx(d,{variant:"outline",onClick:()=>g(!1),disabled:O||R,children:s("common.cancel")}),e.jsx(d,{onClick:be,disabled:O||R,children:s(O?"joinUs.creatingUser":R?"common.sending":U?"joinUs.sendEmailOnly":"joinUs.createAndSendEmail")})]})]})})]})};export{os as default};
//# sourceMappingURL=AdminJoinRequests-C5KM6W6U.js.map
