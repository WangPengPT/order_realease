import{p as ue,r as o,j as e,bl as ge,be as je,b7 as ve,aZ as pe,c4 as D,bh as u,bH as V,bZ as B,a4 as G,bu as U,bj as Ne,ak as O,cG as fe,aL as be,aK as we,bp as ye,bg as Ce,b6 as Pe,bo as ke,bF as _e,bI as Se,c8 as Fe,c1 as W,w as T}from"./vendor-react-5CWRUXey.js";import{B as m,C as w,w as y,I as Ae,a2 as J,a3 as K,a4 as R,a5 as Z,a6 as n,g,y as De,z as Te,E as Ie,F as ze,G as Ee,J as Le,K as He,L as Me,A as Ve,h as Be,i as Ge,ab as j,ac as v,ad as p,ae as N,k as $,n as d,s as C}from"./index-ffVqEBGu.js";import{u as Ue,a as Oe,b as We}from"./useCommunityPosts-BNL3yjf2.js";import{u as Je}from"./useLocalizedContent-B7sai0xn.js";import{P as Ke}from"./PostManagementDialog-ByAJP7sU.js";import{H as Re,p as Ze,I as $e,J as qe}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-hygftDOh.js";import"./separator-DctwcdiX.js";import"./useActivities-EM8x_Ly3.js";const ds=()=>{const{t:a,i18n:q}=ue(),{getLocalizedField:Q}=Je(),[I,X]=o.useState(""),[P,Y]=o.useState("all"),[k,ee]=o.useState("all"),[z,E]=o.useState(null),[_,S]=o.useState(null),[f,L]=o.useState("grid"),[H,M]=o.useState(null),{data:h,isLoading:se}=Ue({status:P!=="all"?P:void 0,moderation_status:k!=="all"?k:void 0,search:I||void 0}),b=Oe(),ae=We(),te=()=>{switch(q.language){case"zh":return qe;case"pt":return $e;default:return Ze}},re=s=>{switch(s){case"approved":return{label:a("admin.status.approved","已发布"),icon:D,className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/20"};case"pending":return{label:a("admin.status.pending","待审核"),icon:u,className:"bg-amber-500/10 text-amber-600 border-amber-500/20"};case"rejected":return{label:a("admin.status.rejected","已拒绝"),icon:B,className:"bg-red-500/10 text-red-600 border-red-500/20"};case"hidden":return{label:a("admin.status.hidden","已隐藏"),icon:V,className:"bg-gray-500/10 text-gray-600 border-gray-500/20"};default:return{label:s,icon:W,className:"bg-gray-500/10 text-gray-600 border-gray-500/20"}}},le=s=>{switch(s){case"approved":return{label:a("admin.moderation.approved","通过"),icon:G,className:"text-emerald-600"};case"flagged":return{label:a("admin.moderation.flagged","标记"),icon:U,className:"text-orange-500"};case"pending":return{label:a("admin.moderation.pending","待审"),icon:u,className:"text-muted-foreground"};default:return{label:s,icon:W,className:"text-muted-foreground"}}},F=(s,r)=>{switch(r){case"approve":b.mutate({id:s.id,status:"approved"});break;case"hide":b.mutate({id:s.id,status:"hidden"});break;case"unhide":b.mutate({id:s.id,status:"approved"});break;case"delete":S(s);break}},ie=()=>{_&&(ae.mutate(_.id),S(null))},ne=s=>{const r=document.createElement("div");return r.innerHTML=s,r.textContent||r.innerText||""},de=s=>new Promise((r,i)=>{const t=document.createElement("video"),l=document.createElement("canvas"),x=l.getContext("2d");t.preload="auto",t.muted=!0,t.playsInline=!0,t.crossOrigin="anonymous";let c=!1;const he=()=>{c||t.videoWidth===0||t.videoHeight===0||(l.width=t.videoWidth,l.height=t.videoHeight,x&&(x.drawImage(t,0,0,l.width,l.height),l.toBlob(A=>{A&&A.size>0?(c=!0,t.pause(),r(A)):i(new Error("Failed to create blob"))},"image/jpeg",.85)))};t.onloadedmetadata=()=>{l.width=t.videoWidth,l.height=t.videoHeight,t.currentTime=.1},t.onseeked=()=>{setTimeout(he,100)},t.onerror=()=>{i(new Error("Failed to load video"))},setTimeout(()=>{c||i(new Error("Timeout"))},15e3),t.src=s,t.load()}),ce=async s=>{if(s.video_url){M(s.id);try{T.info(a("admin.communityPosts.extractingCover","正在提取视频封面..."));const r=await de(s.video_url),{data:{user:i}}=await C.auth.getUser();if(!i)throw new Error("Not authenticated");const t=`covers/${s.id}-cover-${Date.now()}.jpg`,{error:l}=await C.storage.from("community-posts").upload(t,r);if(l)throw l;const{data:{publicUrl:x}}=C.storage.from("community-posts").getPublicUrl(t),c=[x,...s.image_urls||[]];await C.from("community_posts").update({image_urls:c}).eq("id",s.id),b.mutate({id:s.id,image_urls:c}),T.success(a("admin.communityPosts.coverGenerated","封面已生成"))}catch(r){console.error("Failed to generate cover:",r),T.error(a("admin.communityPosts.coverFailed","封面生成失败，请重试"))}finally{M(null)}}},oe=s=>s.video_url&&(!s.image_urls||s.image_urls.length===0),me=({post:s})=>{const r=re(s.status),i=le(s.moderation_status),t=r.icon,l=i.icon;return e.jsx(w,{className:"group overflow-hidden hover:shadow-md transition-all duration-200 border-border/60",children:e.jsxs(y,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border/40",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Ve,{className:"h-10 w-10 ring-2 ring-background shadow-sm",children:[e.jsx(Be,{src:s.author?.avatar_url||void 0}),e.jsx(Ge,{className:"bg-primary/10 text-primary font-medium",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(u,{className:"h-3 w-3"}),Re(new Date(s.created_at),{addSuffix:!0,locale:te()})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(p,{asChild:!0,children:e.jsx("div",{className:g("p-1.5 rounded-full",i.className),children:e.jsx(l,{className:"h-3.5 w-3.5"})})}),e.jsx(N,{side:"left",children:e.jsx("p",{children:i.label})})]})})})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("p",{className:"text-sm line-clamp-3 text-foreground/90",children:ne(s.content)}),(s.image_urls?.length>0||s.video_url)&&e.jsxs("div",{className:"flex items-center gap-3",children:[s.image_urls&&s.image_urls.length>0&&e.jsxs("div",{className:"flex -space-x-2",children:[s.image_urls.slice(0,3).map((x,c)=>e.jsx("div",{className:"h-12 w-12 rounded-lg overflow-hidden border-2 border-background shadow-sm",children:e.jsx("img",{src:x,alt:"",className:"w-full h-full object-cover"})},c)),s.image_urls.length>3&&e.jsx("div",{className:"h-12 w-12 rounded-lg bg-muted/80 border-2 border-background flex items-center justify-center shadow-sm",children:e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["+",s.image_urls.length-3]})})]}),s.video_url&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground bg-muted/50 px-2 py-1 rounded-full",children:[e.jsx(fe,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:a("admin.communityPosts.hasVideo","视频")})]}),oe(s)&&e.jsxs(m,{variant:"outline",size:"sm",className:"h-6 text-xs gap-1 text-orange-600 border-orange-300 hover:bg-orange-50",onClick:()=>ce(s),disabled:H===s.id,children:[H===s.id?e.jsx(be,{className:"h-3 w-3 animate-spin"}):e.jsx(we,{className:"h-3 w-3"}),a("admin.communityPosts.generateCover","生成封面")]})]})]}),s.activity&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ye,{className:"h-3.5 w-3.5 text-primary"}),e.jsx($,{variant:"secondary",className:"text-xs font-normal",children:Q(s.activity,"title")})]})]}),e.jsx("div",{className:"px-4 py-3 bg-muted/30 border-t border-border/40",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(Ce,{className:"h-3.5 w-3.5"}),s.likes_count]}),e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(Pe,{className:"h-3.5 w-3.5"}),s.comments_count]}),e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(ke,{className:"h-3.5 w-3.5"}),s.shares_count]})]}),e.jsxs($,{variant:"outline",className:g("text-xs border",r.className),children:[e.jsx(t,{className:"h-3 w-3 mr-1"}),r.label]})]})}),e.jsxs("div",{className:"flex items-center gap-1 p-2 border-t border-border/40 bg-background",children:[e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(p,{asChild:!0,children:e.jsxs(m,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:()=>E(s),children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("common.details","详情")})]})}),e.jsx(N,{children:e.jsx("p",{children:a("common.viewDetails","查看详情")})})]})}),s.status==="pending"||s.status==="flagged"?e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(p,{asChild:!0,children:e.jsxs(m,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50",onClick:()=>F(s,"approve"),children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.action.approve","发布")})]})}),e.jsx(N,{children:e.jsx("p",{children:a("admin.action.approve","发布")})})]})}):null,e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(p,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:g("flex-1 h-8",s.status==="hidden"?"text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50":"text-amber-600 hover:text-amber-700 hover:bg-amber-50"),onClick:()=>F(s,s.status==="hidden"?"unhide":"hide"),children:s.status==="hidden"?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.action.unhide","显示")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.action.hide","隐藏")})]})})}),e.jsx(N,{children:e.jsx("p",{children:s.status==="hidden"?a("admin.action.unhide","显示"):a("admin.action.hide","隐藏")})})]})}),e.jsx(j,{children:e.jsxs(v,{children:[e.jsx(p,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>F(s,"delete"),children:e.jsx(O,{className:"h-4 w-4"})})}),e.jsx(N,{children:e.jsx("p",{children:a("common.delete","删除")})})]})})]})]})})},xe=()=>e.jsx(w,{className:"overflow-hidden",children:e.jsxs(y,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border-b",children:[e.jsx(d,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{className:"h-4 w-24"}),e.jsx(d,{className:"h-3 w-16"})]})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx(d,{className:"h-4 w-full"}),e.jsx(d,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{className:"h-12 w-12 rounded-lg"}),e.jsx(d,{className:"h-12 w-12 rounded-lg"})]})]}),e.jsx("div",{className:"px-4 py-3 bg-muted/30 border-t",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx(d,{className:"h-4 w-24"}),e.jsx(d,{className:"h-5 w-16 rounded-full"})]})})]})});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:a("admin.communityPosts.title","帖子管理")}),e.jsx("p",{className:"text-muted-foreground text-sm mt-1",children:a("admin.communityPosts.subtitle","管理和审核社区帖子")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:f==="grid"?"secondary":"ghost",size:"icon",className:"h-9 w-9",onClick:()=>L("grid"),children:e.jsx(ge,{className:"h-4 w-4"})}),e.jsx(m,{variant:f==="list"?"secondary":"ghost",size:"icon",className:"h-9 w-9",onClick:()=>L("list"),children:e.jsx(je,{className:"h-4 w-4"})})]})]}),e.jsx(w,{className:"border-border/60",children:e.jsx(y,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ve,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ae,{placeholder:a("admin.communityPosts.searchPlaceholder","搜索内容..."),value:I,onChange:s=>X(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 text-muted-foreground hidden sm:block"}),e.jsxs(J,{value:P,onValueChange:Y,children:[e.jsx(K,{className:"w-[140px]",children:e.jsx(R,{placeholder:a("admin.status.all","所有状态")})}),e.jsxs(Z,{children:[e.jsx(n,{value:"all",children:a("admin.status.all","所有状态")}),e.jsx(n,{value:"approved",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-3.5 w-3.5 text-emerald-600"}),a("admin.status.approved","已发布")]})}),e.jsx(n,{value:"pending",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(u,{className:"h-3.5 w-3.5 text-amber-600"}),a("admin.status.pending","待审核")]})}),e.jsx(n,{value:"hidden",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-3.5 w-3.5 text-gray-500"}),a("admin.status.hidden","已隐藏")]})}),e.jsx(n,{value:"rejected",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-3.5 w-3.5 text-red-600"}),a("admin.status.rejected","已拒绝")]})})]})]}),e.jsxs(J,{value:k,onValueChange:ee,children:[e.jsx(K,{className:"w-[130px]",children:e.jsx(R,{placeholder:a("admin.moderation.all","所有审核")})}),e.jsxs(Z,{children:[e.jsx(n,{value:"all",children:a("admin.moderation.all","所有审核")}),e.jsx(n,{value:"pending",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(u,{className:"h-3.5 w-3.5 text-gray-500"}),a("admin.moderation.pending","待审")]})}),e.jsx(n,{value:"approved",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-3.5 w-3.5 text-emerald-600"}),a("admin.moderation.approved","通过")]})}),e.jsx(n,{value:"flagged",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-3.5 w-3.5 text-orange-500"}),a("admin.moderation.flagged","标记")]})})]})]})]})]})})}),h&&e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:e.jsxs("span",{children:[a("admin.communityPosts.total","共")," ",h.length," ",a("admin.communityPosts.posts","篇帖子")]})}),se?e.jsx("div",{className:g("grid gap-4",f==="grid"?"grid-cols-1 md:grid-cols-2 lg:grid-cols-3":"grid-cols-1"),children:Array.from({length:6}).map((s,r)=>e.jsx(xe,{},r))}):h&&h.length>0?e.jsx("div",{className:g("grid gap-4",f==="grid"?"grid-cols-1 md:grid-cols-2 lg:grid-cols-3":"grid-cols-1"),children:h.map(s=>e.jsx(me,{post:s},s.id))}):e.jsx(w,{className:"border-dashed",children:e.jsxs(y,{className:"py-16 text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4",children:e.jsx(Ne,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("h3",{className:"font-medium text-lg mb-1",children:a("admin.communityPosts.noPosts","暂无帖子")}),e.jsx("p",{className:"text-muted-foreground text-sm",children:a("admin.communityPosts.noPostsDesc","当前筛选条件下没有帖子")})]})}),e.jsx(Ke,{post:z,open:!!z,onOpenChange:s=>!s&&E(null)}),e.jsx(De,{open:!!_,onOpenChange:s=>!s&&S(null),children:e.jsxs(Te,{children:[e.jsxs(Ie,{children:[e.jsxs(ze,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5 text-destructive"}),a("common.confirmDelete","确认删除")]}),e.jsx(Ee,{children:a("admin.communityPosts.deleteWarning","删除后无法恢复，确定要删除这篇帖子吗？")})]}),e.jsxs(Le,{children:[e.jsx(He,{children:a("common.cancel","取消")}),e.jsx(Me,{onClick:ie,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:a("common.delete","删除")})]})]})})]})};export{ds as default};
//# sourceMappingURL=AdminCommunityPosts-CPHua23j.js.map
