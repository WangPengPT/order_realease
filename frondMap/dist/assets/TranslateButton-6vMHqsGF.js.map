{"version":3,"file":"TranslateButton-6vMHqsGF.js","sources":["../../src/components/TranslateButton.tsx"],"sourcesContent":["import { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Languages, Loader2, RotateCcw } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface TranslateButtonProps {\r\n  text: string;\r\n  className?: string;\r\n  label?: string;\r\n  onTranslation?: (translatedText: string | null) => void;\r\n}\r\n\r\n// Simple cache to store translations and avoid repeated API calls\r\nconst translationCache = new Map<string, string>();\r\n\r\nconst TranslateButton = ({ text, className, label, onTranslation }: TranslateButtonProps) => {\r\n  const { t, i18n } = useTranslation();\r\n  const [isTranslating, setIsTranslating] = useState(false);\r\n  const [translatedText, setTranslatedText] = useState<string | null>(null);\r\n  const [showTranslation, setShowTranslation] = useState(false);\r\n  const [lastTranslatedLang, setLastTranslatedLang] = useState<string | null>(null);\r\n\r\n  // Reset translation when language changes\r\n  const currentLang = i18n.language;\r\n  \r\n  // If language changed and we have a translation, reset it\r\n  if (lastTranslatedLang && lastTranslatedLang !== currentLang && showTranslation) {\r\n    setShowTranslation(false);\r\n    setTranslatedText(null);\r\n    onTranslation?.(null);\r\n  }\r\n\r\n  const handleTranslate = async () => {\r\n    // Get current language at call time, not render time\r\n    const targetLang = i18n.language;\r\n    const cacheKey = `${text.substring(0, 100)}_${targetLang}`;\r\n    \r\n    // If already showing translation for the same language, toggle back to original\r\n    if (showTranslation && lastTranslatedLang === targetLang) {\r\n      setShowTranslation(false);\r\n      onTranslation?.(null);\r\n      return;\r\n    }\r\n\r\n    // Check global cache\r\n    const cached = translationCache.get(cacheKey);\r\n    if (cached) {\r\n      setTranslatedText(cached);\r\n      setShowTranslation(true);\r\n      setLastTranslatedLang(targetLang);\r\n      onTranslation?.(cached);\r\n      return;\r\n    }\r\n\r\n    // Call translation API\r\n    setIsTranslating(true);\r\n    console.log('[TranslateButton] Calling translate-content with targetLang:', targetLang);\r\n    try {\r\n      const { data, error } = await supabase.functions.invoke('translate-content', {\r\n        body: { text, targetLang }\r\n      });\r\n      console.log('[TranslateButton] Response:', data, error);\r\n\r\n      if (error) {\r\n        console.error('Translation error:', error);\r\n        toast.error(t(\"translate.error\", \"翻译失败，请稍后重试\"));\r\n        return;\r\n      }\r\n\r\n      if (data?.translatedText) {\r\n        // Store in cache\r\n        translationCache.set(cacheKey, data.translatedText);\r\n        setTranslatedText(data.translatedText);\r\n        setShowTranslation(true);\r\n        setLastTranslatedLang(targetLang);\r\n        onTranslation?.(data.translatedText);\r\n      } else if (data?.error) {\r\n        toast.error(data.error);\r\n      }\r\n    } catch (err) {\r\n      console.error('Translation error:', err);\r\n      toast.error(t(\"translate.error\", \"翻译失败，请稍后重试\"));\r\n    } finally {\r\n      setIsTranslating(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Button\r\n      variant=\"ghost\"\r\n      size=\"sm\"\r\n      className={`gap-1.5 h-auto py-1 px-2 text-xs text-muted-foreground hover:text-foreground ${className || ''}`}\r\n      onClick={handleTranslate}\r\n      disabled={isTranslating}\r\n    >\r\n      {isTranslating ? (\r\n        <>\r\n          <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n          <span>{t(\"translate.translating\", \"翻译中...\")}</span>\r\n        </>\r\n      ) : showTranslation ? (\r\n        <>\r\n          <RotateCcw className=\"h-3 w-3\" />\r\n          <span>{t(\"translate.showOriginal\", \"显示原文\")}</span>\r\n        </>\r\n      ) : (\r\n        <>\r\n          <Languages className=\"h-3 w-3\" />\r\n          <span>{label || t(\"translate.button\", \"翻译\")}</span>\r\n        </>\r\n      )}\r\n    </Button>\r\n  );\r\n};\r\n\r\nexport default TranslateButton;\r\n"],"names":["translationCache","TranslateButton","text","className","label","onTranslation","t","i18n","useTranslation","isTranslating","setIsTranslating","useState","translatedText","setTranslatedText","showTranslation","setShowTranslation","lastTranslatedLang","setLastTranslatedLang","currentLang","handleTranslate","targetLang","cacheKey","cached","data","error","supabase","toast","err","jsx","Button","jsxs","Fragment","Loader2","RotateCcw","Languages"],"mappings":"2IAeA,MAAMA,MAAuB,IAEvBC,EAAkB,CAAC,CAAE,KAAAC,EAAM,UAAAC,EAAW,MAAAC,EAAO,cAAAC,KAA0C,CAC3F,KAAM,CAAE,EAAAC,EAAG,KAAAC,CAAK,EAAIC,EAAe,EAC7B,CAACC,EAAeC,CAAgB,EAAIC,WAAS,EAAK,EAClD,CAACC,EAAgBC,CAAiB,EAAIF,WAAwB,IAAI,EAClE,CAACG,EAAiBC,CAAkB,EAAIJ,WAAS,EAAK,EACtD,CAACK,EAAoBC,CAAqB,EAAIN,WAAwB,IAAI,EAG1EO,EAAcX,EAAK,SAGrBS,GAAsBA,IAAuBE,GAAeJ,IAC9DC,EAAmB,EAAK,EACxBF,EAAkB,IAAI,EACtBR,IAAgB,IAAI,GAGtB,MAAMc,EAAkB,SAAY,CAElC,MAAMC,EAAab,EAAK,SAClBc,EAAW,GAAGnB,EAAK,UAAU,EAAG,GAAG,CAAC,IAAIkB,CAAU,GAGpD,GAAAN,GAAmBE,IAAuBI,EAAY,CACxDL,EAAmB,EAAK,EACxBV,IAAgB,IAAI,EACpB,MACF,CAGM,MAAAiB,EAAStB,EAAiB,IAAIqB,CAAQ,EAC5C,GAAIC,EAAQ,CACVT,EAAkBS,CAAM,EACxBP,EAAmB,EAAI,EACvBE,EAAsBG,CAAU,EAChCf,IAAgBiB,CAAM,EACtB,MACF,CAGAZ,EAAiB,EAAI,EACb,QAAA,IAAI,+DAAgEU,CAAU,EAClF,GAAA,CACI,KAAA,CAAE,KAAAG,EAAM,MAAAC,CAAM,EAAI,MAAMC,EAAS,UAAU,OAAO,oBAAqB,CAC3E,KAAM,CAAE,KAAAvB,EAAM,WAAAkB,CAAW,CAAA,CAC1B,EAGD,GAFQ,QAAA,IAAI,8BAA+BG,EAAMC,CAAK,EAElDA,EAAO,CACD,QAAA,MAAM,qBAAsBA,CAAK,EACzCE,EAAM,MAAMpB,EAAE,kBAAmB,YAAY,CAAC,EAC9C,MACF,CAEIiB,GAAM,gBAESvB,EAAA,IAAIqB,EAAUE,EAAK,cAAc,EAClDV,EAAkBU,EAAK,cAAc,EACrCR,EAAmB,EAAI,EACvBE,EAAsBG,CAAU,EAChCf,IAAgBkB,EAAK,cAAc,GAC1BA,GAAM,OACTG,EAAA,MAAMH,EAAK,KAAK,QAEjBI,EAAK,CACJ,QAAA,MAAM,qBAAsBA,CAAG,EACvCD,EAAM,MAAMpB,EAAE,kBAAmB,YAAY,CAAC,CAAA,QAC9C,CACAI,EAAiB,EAAK,CACxB,CAAA,EAIA,OAAAkB,EAAA,IAACC,EAAA,CACC,QAAQ,QACR,KAAK,KACL,UAAW,gFAAgF1B,GAAa,EAAE,GAC1G,QAASgB,EACT,SAAUV,EAET,WAEGqB,EAAAA,KAAAC,EAAA,SAAA,CAAA,SAAA,CAACH,EAAAA,IAAAI,EAAA,CAAQ,UAAU,sBAAuB,CAAA,EACzCJ,EAAA,IAAA,OAAA,CAAM,SAAEtB,EAAA,wBAAyB,QAAQ,EAAE,CAC9C,CAAA,CAAA,EACEQ,EAEAgB,EAAA,KAAAC,EAAA,SAAA,CAAA,SAAA,CAACH,EAAAA,IAAAK,EAAA,CAAU,UAAU,SAAU,CAAA,EAC9BL,EAAA,IAAA,OAAA,CAAM,SAAEtB,EAAA,yBAA0B,MAAM,EAAE,CAAA,CAAA,CAC7C,EAGEwB,EAAAA,KAAAC,EAAA,SAAA,CAAA,SAAA,CAACH,EAAAA,IAAAM,EAAA,CAAU,UAAU,SAAU,CAAA,QAC9B,OAAM,CAAA,SAAA9B,GAASE,EAAE,mBAAoB,IAAI,EAAE,CAAA,EAC9C,CAAA,CAAA,CAIR"}