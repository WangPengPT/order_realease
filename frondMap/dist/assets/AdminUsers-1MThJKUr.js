import{c as ms,u as ee,o as ge,ac as Se,F as Ee,r as d,j as e,D as fe,aa as ke,B as p,a as Ne,b as ve,d as we,a6 as ye,a7 as H,I as Q,ag as te,ah as ne,ai as le,aj as ie,ak as B,a9 as hs,L as Y,s as v,p as xs,x as J,af as Ce,h as Fe,a1 as He,v as X,M as us,av as ps,aR as js,aS as Qe,aT as Xe,aU as $e,aM as K,a3 as Ae,a4 as ze,a5 as Me,R as Ue,T as qe,U as oe,V as me,W as he,Y as xe,Z as ue,$ as pe,as as _e,C as $,l as V,X as Ve,y as gs}from"./index-DDDDgwLZ.js";import{C as je}from"./checkbox-DbrPu41g.js";import{S as We}from"./separator-tCRYj1Nj.js";import{g as fs,h as Ns,i as vs,j as ws,k as ys,l as bs,m as _s}from"./useAdmin-BNC-r_JW.js";import{u as Cs}from"./useInfiniteScroll-Z7FOvEag.js";import{U as Le}from"./user-plus-DsMWy_rd.js";import{u as Ss}from"./useLocalizedContent-pbKMpp6T.js";import{S as Je}from"./search-C3gG7zdj.js";import{U as G}from"./users-CjxxyFa8.js";import{B as ce}from"./briefcase-ttDN4j8Z.js";import{S as Ye}from"./square-pen-CdbR6_qo.js";import{U as ks}from"./upload-CmJknLKR.js";import{T as Ze}from"./triangle-alert-D6c5GFzB.js";import{U as Rs}from"./UserProfileDialog-BWrKTb17.js";import{e as Ds}from"./exportUtils-HjLVYFQn.js";import{F as Us}from"./filter-B5t4nK-B.js";import{A as qs}from"./arrow-up-down-BamKLJgJ.js";import{A as Ls,a as Ts}from"./arrow-up-C2D4Qqca.js";import{D as Es}from"./download-D5LQbPDi.js";import{E as Fs}from"./eye-O3VAev3G.js";import"./arrow-left-C3d3SO1X.js";import"./clock-B3tZc-dd.js";import"./heart-C16IKnxm.js";import"./star-BjMDTe4R.js";import"./external-link-Cci2adBq.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=ms("UserCog",[["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m21.7 16.4-.9-.3",key:"12j9ji"}],["path",{d:"m15.2 13.9-.9-.3",key:"1fdjdi"}],["path",{d:"m16.6 18.7.3-.9",key:"heedtr"}],["path",{d:"m19.1 12.2.3-.9",key:"1af3ki"}],["path",{d:"m19.6 18.7-.4-1",key:"1x9vze"}],["path",{d:"m16.8 12.3-.4-1",key:"vqeiwj"}],["path",{d:"m14.3 16.6 1-.4",key:"1qlj63"}],["path",{d:"m20.7 13.8 1-.4",key:"1v5t8k"}]]),As=({trigger:a})=>{const{t:o}=ee(),{toast:j}=ge(),D=Se(),{isSupervisor:m}=Ee(),[i,U]=d.useState(!1),[l,F]=d.useState(!1),[c,w]=d.useState({email:"",password:"",displayName:"",phone:"",role:"merchant"}),x=async h=>{h.preventDefault(),F(!0);try{const{data:{session:g}}=await v.auth.getSession(),f=await fetch("https://tzdgqhwyzsxkxnncgzap.supabase.co/functions/v1/admin-create-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g==null?void 0:g.access_token}`},body:JSON.stringify({email:c.email,password:c.password,displayName:c.displayName,phone:c.phone,role:c.role})}),y=await f.json();if(!f.ok)throw new Error(y.error||"Failed to create user");j({title:o("common.success"),description:o("admin.userCreated")}),U(!1),w({email:"",password:"",displayName:"",phone:"",role:"merchant"}),D.invalidateQueries({queryKey:["admin-users"]})}catch(g){console.error("Error creating user:",g),j({title:o("common.error"),description:g.message||o("admin.createUserError"),variant:"destructive"})}finally{F(!1)}};return e.jsxs(fe,{open:i,onOpenChange:U,children:[e.jsx(ke,{asChild:!0,children:a||e.jsxs(p,{children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),o("admin.createUser")]})}),e.jsx(Ne,{className:"max-w-[90vw] sm:max-w-[500px]",children:e.jsxs("form",{onSubmit:x,children:[e.jsxs(ve,{children:[e.jsx(we,{children:o("admin.createNewUser")}),e.jsx(ye,{children:o("admin.createUserDescription")})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"email",children:o("auth.email")}),e.jsx(Q,{id:"email",type:"email",required:!0,value:c.email,onChange:h=>w({...c,email:h.target.value}),placeholder:"user@example.com"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"password",children:o("auth.password")}),e.jsx(Q,{id:"password",type:"password",required:!0,value:c.password,onChange:h=>w({...c,password:h.target.value}),placeholder:"••••••••",minLength:6})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"displayName",children:o("profile.displayName")}),e.jsx(Q,{id:"displayName",required:!0,value:c.displayName,onChange:h=>w({...c,displayName:h.target.value}),placeholder:o("profile.displayName")})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"phone",children:o("profile.phone")}),e.jsx(Q,{id:"phone",type:"tel",value:c.phone,onChange:h=>w({...c,phone:h.target.value}),placeholder:"+351 XXX XXX XXX"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"role",children:o("admin.role")}),m?e.jsx(Q,{id:"role",value:o("admin.merchant"),disabled:!0,className:"bg-muted"}):e.jsxs(te,{value:c.role,onValueChange:h=>w({...c,role:h}),children:[e.jsx(ne,{children:e.jsx(le,{})}),e.jsxs(ie,{children:[e.jsx(B,{value:"merchant",children:o("admin.merchant")}),e.jsx(B,{value:"supervisor",children:o("admin.supervisor")})]})]})]})]}),e.jsxs(hs,{children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>U(!1),disabled:l,children:o("common.cancel")}),e.jsxs(p,{type:"submit",disabled:l,children:[l&&e.jsx(Y,{className:"mr-2 h-4 w-4 animate-spin"}),o("admin.create")]})]})]})})]})},zs=({open:a,onOpenChange:o,merchantId:j,merchantName:D,userRole:m})=>{const{t:i}=ee(),{toast:U}=ge(),l=Se(),{localizeRestaurant:F}=Ss(),{user:c}=xs(),{isSupervisor:w}=Ee(),[x,h]=d.useState([]),[g,f]=d.useState(""),{data:y}=J({queryKey:["supervisorRestaurants",c==null?void 0:c.id],queryFn:async()=>{if(!c||!w)return null;const{data:t,error:N}=await v.from("merchant_restaurants").select("restaurant_id").eq("user_id",c.id);if(N)throw N;return(t==null?void 0:t.map(_=>_.restaurant_id))||[]},enabled:a&&w&&!!c}),{data:I,isLoading:r}=J({queryKey:["allRestaurants",y],queryFn:async()=>{let t=v.from("restaurants").select("*").order("name");w&&y&&y.length>0&&(t=t.in("id",y));const{data:N,error:_}=await t;if(_)throw _;return N},enabled:!w||w&&y!==void 0}),{data:n,isLoading:u}=J({queryKey:["merchantRestaurants",j],queryFn:async()=>{const{data:t,error:N}=await v.from("merchant_restaurants").select("restaurant_id").eq("user_id",j);if(N)throw N;return(t==null?void 0:t.map(_=>_.restaurant_id))||[]},enabled:a}),{data:S}=J({queryKey:["allRestaurantAssignments"],queryFn:async()=>{const{data:t,error:N}=await v.from("merchant_restaurants").select("restaurant_id, user_id");if(N)throw N;if(!t||t.length===0)return{};const _=[...new Set(t.map(E=>E.user_id))],{data:z}=await v.from("profiles").select("id, display_name").in("id",_),{data:O}=await v.from("user_roles").select("user_id, role").in("user_id",_),R=new Map((z==null?void 0:z.map(E=>[E.id,E.display_name]))||[]),A=new Map((O==null?void 0:O.map(E=>[E.user_id,E.role]))||[]),Z={};return t.forEach(E=>{Z[E.restaurant_id]||(Z[E.restaurant_id]=[]),Z[E.restaurant_id].push({userId:E.user_id,displayName:R.get(E.user_id)||"Unknown",role:A.get(E.user_id)||"user"})}),Z},enabled:a});d.useEffect(()=>{n&&h(n)},[n]);const q=Ce({mutationFn:async()=>{const{error:t}=await v.from("merchant_restaurants").delete().eq("user_id",j);if(t)throw t;if(x.length>0){const{error:N}=await v.from("merchant_restaurants").insert(x.map(_=>({user_id:j,restaurant_id:_})));if(N)throw N}},onSuccess:()=>{U({title:i("toast.merchantRestaurantsSaved"),description:i("toast.merchantRestaurantsDescription")}),l.invalidateQueries({queryKey:["merchantRestaurants"]}),l.invalidateQueries({queryKey:["adminUsers"]}),o(!1)},onError:t=>{console.error("Error saving merchant restaurants:",t),U({title:i("toast.merchantRestaurantsSaveFailed"),description:i("toast.merchantRestaurantsDescriptionFailed"),variant:"destructive"})}}),L=t=>{m==="merchant"?x.includes(t)?h([]):h([t]):h(N=>N.includes(t)?N.filter(_=>_!==t):[...N,t])},P=()=>{q.mutate()},T=r||u,k=I==null?void 0:I.filter(t=>g.trim()?F(t).name.toLowerCase().includes(g.toLowerCase())||t.address.toLowerCase().includes(g.toLowerCase()):!0);return e.jsx(fe,{open:a,onOpenChange:o,children:e.jsxs(Ne,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(ve,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-5 h-5"}),i(m==="merchant"?"merchant.manageRestaurants":"merchant.manageSupervisorRestaurants")]}),e.jsxs(ye,{children:[i("merchant.assignRestaurantsTo",{name:D}),m==="merchant"&&e.jsx("span",{className:"block mt-1 text-primary font-medium",children:i("merchant.merchantOnlyOne")}),e.jsx("span",{className:"block mt-1 text-muted-foreground text-xs",children:i("merchant.saveReminder")})]})]}),T?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(Y,{className:"w-6 h-6 animate-spin text-primary"})}):e.jsxs("div",{className:"flex flex-col flex-1 min-h-0",children:[e.jsxs("div",{className:"relative mb-4 flex-shrink-0",children:[e.jsx(Je,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(Q,{placeholder:i("merchant.searchRestaurants"),value:g,onChange:t=>f(t.target.value),className:"pl-9"})]}),e.jsx(He,{className:"flex-1 min-h-0 pr-4",children:e.jsx("div",{className:"space-y-3",children:k==null?void 0:k.map(t=>{var O;const N=x.includes(t.id),_=F(t),z=((O=S==null?void 0:S[t.id])==null?void 0:O.filter(R=>R.userId!==j))||[];return e.jsxs("div",{className:"flex items-start space-x-3 p-4 rounded-lg border hover:bg-accent/50 transition-all cursor-pointer",onClick:()=>L(t.id),children:[e.jsx(je,{checked:N,className:"mt-1"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 flex-wrap",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:_.name}),N&&e.jsx(X,{variant:"secondary",className:"text-xs",children:i("merchant.selected")})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(us,{className:"w-3 h-3"}),e.jsx("span",{className:"line-clamp-1",children:t.address})]}),t.type&&t.type.length>0&&e.jsx("div",{className:"flex gap-1 mt-2 flex-wrap",children:t.type.slice(0,2).map((R,A)=>e.jsx(X,{variant:"outline",className:"text-xs",children:R},A))}),z.length>0&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-2 flex-wrap",children:[e.jsx(ps,{className:"w-3 h-3 text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[i("merchant.assignedTo"),":"]}),e.jsxs(js,{children:[z.slice(0,3).map((R,A)=>e.jsxs(Qe,{children:[e.jsx(Xe,{asChild:!0,children:e.jsx(X,{variant:"outline",className:`text-xs ${R.role==="supervisor"?"border-blue-500/50 text-blue-600 dark:text-blue-400":"border-amber-500/50 text-amber-600 dark:text-amber-400"}`,children:R.displayName})}),e.jsx($e,{children:e.jsx("p",{children:R.role==="supervisor"?i("roles.supervisor"):i("roles.merchant")})})]},R.userId)),z.length>3&&e.jsxs(Qe,{children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(X,{variant:"outline",className:"text-xs",children:["+",z.length-3]})}),e.jsx($e,{children:e.jsx("div",{className:"space-y-1",children:z.slice(3).map(R=>e.jsxs("p",{children:[R.displayName," (",R.role==="supervisor"?i("roles.supervisor"):i("roles.merchant"),")"]},R.userId))})})]})]})]})]})]},t.id)})})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:m==="merchant"?i("merchant.selectedCountOne",{count:x.length}):i("merchant.selectedCountMulti",{count:x.length})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>o(!1),disabled:q.isPending,children:i("common.cancel")}),e.jsxs(p,{onClick:P,disabled:q.isPending,children:[q.isPending&&e.jsx(Y,{className:"w-4 h-4 mr-2 animate-spin"}),i("common.save")]})]})]})]})]})})},Ms=({merchantId:a,merchantName:o,trigger:j})=>{ee();const{toast:D}=ge(),m=Se(),[i,U]=d.useState(!1),[l,F]=d.useState(""),{data:c=[],isLoading:w}=J({queryKey:["supervisors"],queryFn:async()=>{const{data:r,error:n}=await v.from("user_roles").select("user_id").eq("role","supervisor");if(n)throw n;const u=r.map(L=>L.user_id);if(u.length===0)return[];const{data:S,error:q}=await v.from("profiles").select("id, display_name").in("id",u);if(q)throw q;return S},enabled:i}),{data:x=[]}=J({queryKey:["merchant-restaurants",a],queryFn:async()=>{const{data:r,error:n}=await v.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(n)throw n;return r.map(u=>u.restaurant_id)},enabled:i}),{data:h=[]}=J({queryKey:["merchant-supervisors",a],queryFn:async()=>{if(x.length===0)return[];const{data:r,error:n}=await v.from("merchant_restaurants").select("user_id, restaurant_id").in("restaurant_id",x).neq("user_id",a);if(n)throw n;const u=[...new Set(r.map(k=>k.user_id))];if(u.length===0)return[];const{data:S,error:q}=await v.from("user_roles").select("user_id").in("user_id",u).eq("role","supervisor");if(q)throw q;const L=S.map(k=>k.user_id);if(L.length===0)return[];const{data:P,error:T}=await v.from("profiles").select("id, display_name").in("id",L);if(T)throw T;return P},enabled:i&&x.length>0}),g=Ce({mutationFn:async r=>{if(x.length===0)throw new Error("该商家没有管理任何餐厅");const n=x.map(S=>({user_id:r,restaurant_id:S})),{error:u}=await v.from("merchant_restaurants").upsert(n,{onConflict:"user_id,restaurant_id"});if(u)throw u},onSuccess:()=>{D({title:"分配成功",description:"商家已成功分配给主管"}),m.invalidateQueries({queryKey:["merchant-supervisors"]}),F(""),U(!1)},onError:r=>{D({title:"分配失败",description:r.message,variant:"destructive"})}}),f=Ce({mutationFn:async r=>{const{error:n}=await v.from("merchant_restaurants").delete().eq("user_id",r).in("restaurant_id",x);if(n)throw n},onSuccess:()=>{D({title:"移除成功",description:"主管已从该商家移除"}),m.invalidateQueries({queryKey:["merchant-supervisors"]})},onError:r=>{D({title:"移除失败",description:r.message,variant:"destructive"})}}),y=()=>{l&&g.mutate(l)},I=r=>{f.mutate(r)};return e.jsxs(fe,{open:i,onOpenChange:U,children:[e.jsx(ke,{asChild:!0,children:j||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"分配主管"]})}),e.jsxs(Ne,{className:"max-w-md",children:[e.jsxs(ve,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5"}),"分配商家给主管"]}),e.jsxs(ye,{children:["为商家 ",e.jsx("strong",{children:o})," 分配主管"]})]}),e.jsxs("div",{className:"space-y-4",children:[h.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"当前主管"}),e.jsx("div",{className:"space-y-2",children:h.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm",children:r.display_name})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>I(r.id),disabled:f.isPending,children:"移除"})]},r.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"分配新主管"}),e.jsxs(te,{value:l,onValueChange:F,children:[e.jsx(ne,{children:e.jsx(le,{placeholder:"选择主管"})}),e.jsx(ie,{children:w?e.jsx("div",{className:"p-2 text-center",children:e.jsx(Y,{className:"w-4 h-4 animate-spin mx-auto"})}):c.length===0?e.jsx("div",{className:"p-2 text-center text-sm text-muted-foreground",children:"没有可用的主管"}):c.filter(r=>!h.find(n=>n.id===r.id)).map(r=>e.jsx(B,{value:r.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4 text-blue-500"}),r.display_name]})},r.id))})]})]}),x.length===0&&e.jsx(X,{variant:"secondary",className:"w-full justify-center",children:"该商家没有管理任何餐厅"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(p,{variant:"outline",onClick:()=>U(!1),children:"取消"}),e.jsx(p,{onClick:y,disabled:!l||g.isPending||x.length===0,children:g.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-4 h-4 mr-2 animate-spin"}),"分配中..."]}):"确认分配"})]})]})]})]})},Is=({supervisorId:a,supervisorName:o,trigger:j})=>{ee();const{toast:D}=ge(),m=Se(),[i,U]=d.useState(!1),[l,F]=d.useState([]),{data:c=[],isLoading:w}=J({queryKey:["all-merchants-with-restaurants"],queryFn:async()=>{const{data:r,error:n}=await v.from("user_roles").select("user_id").eq("role","merchant");if(n)throw n;const u=r.map(T=>T.user_id);if(u.length===0)return[];const{data:S,error:q}=await v.from("profiles").select("id, display_name, avatar_url").in("id",u);if(q)throw q;const{data:L,error:P}=await v.from("merchant_restaurants").select("user_id, restaurant_id, restaurants(name)").in("user_id",u);if(P)throw P;return S.map(T=>({...T,restaurants:L.filter(k=>k.user_id===T.id).map(k=>{var t;return{id:k.restaurant_id,name:((t=k.restaurants)==null?void 0:t.name)||"Unknown"}})}))},enabled:i}),{data:x=[],isLoading:h}=J({queryKey:["supervisor-managed-merchants",a],queryFn:async()=>{const{data:r,error:n}=await v.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(n)throw n;const u=r.map(k=>k.restaurant_id);if(u.length===0)return[];const{data:S,error:q}=await v.from("merchant_restaurants").select("user_id").in("restaurant_id",u).neq("user_id",a);if(q)throw q;const L=[...new Set(S.map(k=>k.user_id))];if(L.length===0)return[];const{data:P,error:T}=await v.from("user_roles").select("user_id").in("user_id",L).eq("role","merchant");if(T)throw T;return P.map(k=>k.user_id)},enabled:i});d.useState(()=>{x.length>0&&l.length===0&&F(x)});const g=Ce({mutationFn:async()=>{const{data:r,error:n}=await v.from("merchant_restaurants").select("user_id, restaurant_id").in("user_id",l);if(n)throw n;const{data:u,error:S}=await v.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(S)throw S;const q=u.map(t=>t.restaurant_id),L=r.map(t=>t.restaurant_id),P=L.filter(t=>!q.includes(t)),T=c.flatMap(t=>t.restaurants.map(N=>N.id)),k=q.filter(t=>T.includes(t)&&!L.includes(t));if(P.length>0){const t=P.map(_=>({user_id:a,restaurant_id:_})),{error:N}=await v.from("merchant_restaurants").upsert(t,{onConflict:"user_id,restaurant_id"});if(N)throw N}if(k.length>0){const{error:t}=await v.from("merchant_restaurants").delete().eq("user_id",a).in("restaurant_id",k);if(t)throw t}},onSuccess:()=>{D({title:"保存成功",description:"商家分配已更新"}),m.invalidateQueries({queryKey:["supervisor-managed-merchants"]}),m.invalidateQueries({queryKey:["merchant-restaurants"]}),U(!1)},onError:r=>{D({title:"保存失败",description:r.message,variant:"destructive"})}}),f=r=>{F(n=>n.includes(r)?n.filter(u=>u!==r):[...n,r])},y=()=>{g.mutate()},I=d.useState(!1);return!I[0]&&x.length>0&&(F(x),I[1](!0)),e.jsxs(fe,{open:i,onOpenChange:r=>{U(r),r&&F(x)},children:[e.jsx(ke,{asChild:!0,children:j||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"管理商家"]})}),e.jsxs(Ne,{className:"max-w-lg",children:[e.jsxs(ve,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-blue-500"}),"分配商家给主管"]}),e.jsxs(ye,{children:["选择要分配给 ",e.jsx("strong",{children:o})," 管理的商家"]})]}),e.jsxs("div",{className:"space-y-4",children:[w||h?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(Y,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ce,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"没有可分配的商家"})]}):e.jsx(He,{className:"h-[300px] pr-4",children:e.jsx("div",{className:"space-y-2",children:c.map(r=>{var n;return e.jsxs("div",{className:`flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition-colors ${l.includes(r.id)?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>f(r.id),children:[e.jsx(je,{checked:l.includes(r.id),onCheckedChange:()=>f(r.id)}),e.jsxs(Ae,{className:"h-10 w-10",children:[e.jsx(ze,{src:r.avatar_url||""}),e.jsx(Me,{className:"bg-emerald-100 text-emerald-700",children:((n=r.display_name)==null?void 0:n.charAt(0).toUpperCase())||"M"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r.display_name}),r.restaurants.length>0?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Fe,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:r.restaurants.map(u=>u.name).join(", ")})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"无餐厅"})]}),e.jsxs(X,{variant:"outline",className:"text-xs",children:[e.jsx(ce,{className:"w-3 h-3 mr-1"}),"商家"]})]},r.id)})})}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["已选择 ",l.length," 个商家"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>U(!1),children:"取消"}),e.jsx(p,{onClick:y,disabled:g.isPending,children:g.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):"保存"})]})]})]})]})]})},Ps=({merchant:a,trigger:o})=>{const{t:j}=ee(),[D,m]=d.useState(!1),[i,U]=d.useState(a.display_name),[l,F]=d.useState(a.phone||""),[c,w]=d.useState(null),[x,h]=d.useState(a.avatar_url||""),g=fs(),f=Ns(),y=r=>{var u;const n=(u=r.target.files)==null?void 0:u[0];if(n){if(n.size>2*1024*1024)return;w(n),h(URL.createObjectURL(n))}},I=async()=>{let r=a.avatar_url;if(c){const n=await f.mutateAsync({file:c,userId:a.id});n&&(r=n)}await g.mutateAsync({userId:a.id,display_name:i,phone:l||void 0,avatar_url:r||void 0}),m(!1)};return e.jsxs(fe,{open:D,onOpenChange:m,children:[e.jsx(ke,{asChild:!0,children:o||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"编辑资料"]})}),e.jsxs(Ne,{className:"max-w-[90vw] sm:max-w-[425px]",children:[e.jsxs(ve,{children:[e.jsx(we,{children:"编辑商家资料"}),e.jsx(ye,{children:"修改商家的个人信息和头像"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs(Ae,{className:"w-24 h-24",children:[e.jsx(ze,{src:x}),e.jsx(Me,{children:i==null?void 0:i.charAt(0).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx(Q,{type:"file",accept:"image/*",onChange:y,className:"hidden",id:"avatar-upload"}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>{var r;return(r=document.getElementById("avatar-upload"))==null?void 0:r.click()},children:[e.jsx(ks,{className:"w-4 h-4 mr-2"}),j("profile.uploadAvatar")]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"displayName",children:j("profile.displayName")}),e.jsx(Q,{id:"displayName",value:i,onChange:r=>U(r.target.value),placeholder:j("profile.displayName")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"phone",children:j("profile.phone")}),e.jsx(Q,{id:"phone",value:l,onChange:r=>F(r.target.value),placeholder:j("profile.phone")})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>m(!1),children:j("common.cancel")}),e.jsx(p,{onClick:I,disabled:g.isPending||f.isPending,children:g.isPending||f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-4 h-4 mr-2 animate-spin"}),j("common.loading")]}):j("common.save")})]})]})]})},Bs=({open:a,onOpenChange:o,userName:j,userId:D,userRole:m,onConfirm:i,isDeleting:U=!1})=>{const{t:l}=ee(),[F,c]=d.useState(1),[w,x]=d.useState(""),h=()=>{c(1),x(""),o(!1)},g=()=>{c(2)},f=()=>{w.toLowerCase()==="delete"&&i()};return e.jsx(Ue,{open:a,onOpenChange:y=>{y?o(y):h()},children:e.jsx(qe,{className:"max-w-[90vw] sm:max-w-[500px]",children:F===1?e.jsxs(e.Fragment,{children:[e.jsxs(oe,{children:[e.jsxs(me,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ze,{className:"h-5 w-5"}),l("admin.deleteUser")]}),e.jsxs(he,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:l("admin.deleteUserWarning")}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[l("admin.userName"),":"]})," ",j]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[l("admin.userRole"),":"]})," ",m]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:l("admin.deleteUserConsequences")}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:l("admin.deleteUserData1")}),e.jsx("li",{children:l("admin.deleteUserData2")}),e.jsx("li",{children:l("admin.deleteUserData3")}),e.jsx("li",{children:l("admin.deleteUserData4")})]})]}),m==="admin"&&e.jsx("div",{className:"bg-destructive/20 border border-destructive p-3 rounded-lg",children:e.jsxs("p",{className:"text-sm font-semibold text-destructive",children:["⚠️ ",l("admin.deleteAdminWarning")]})})]})]}),e.jsxs(xe,{children:[e.jsx(ue,{onClick:h,children:l("common.cancel")}),e.jsx(pe,{onClick:g,className:"bg-destructive hover:bg-destructive/90",children:l("common.continue")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(oe,{children:[e.jsxs(me,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(_e,{className:"h-5 w-5"}),l("admin.confirmDeleteUser")]}),e.jsxs(he,{className:"space-y-4 pt-4",children:[e.jsx("p",{className:"text-foreground font-medium",children:l("admin.finalDeleteWarning",{userName:j})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"delete-confirm",className:"text-sm font-medium",children:l("admin.typeDeleteToConfirm")}),e.jsx(Q,{id:"delete-confirm",value:w,onChange:y=>x(y.target.value),placeholder:"DELETE",className:"uppercase",autoComplete:"off"})]})]})]}),e.jsxs(xe,{children:[e.jsx(ue,{onClick:h,children:l("common.cancel")}),e.jsx(pe,{onClick:f,disabled:w.toLowerCase()!=="delete"||U,className:"bg-destructive hover:bg-destructive/90",children:l(U?"common.loading":"admin.deleteUser")})]})]})})})},xa=()=>{const{t:a}=ee(),{toast:o}=ge(),{isSupervisor:j,isAdmin:D}=Ee(),{data:m,isLoading:i}=vs(),U=ws(),l=ys(),F=bs(),c=_s(),[w,x]=d.useState(null),[h,g]=d.useState(""),[f,y]=d.useState([]),[I,r]=d.useState("user"),[n,u]=d.useState(""),[S,q]=d.useState("all"),[L,P]=d.useState("name"),[T,k]=d.useState("asc"),[t,N]=d.useState(null),[_,z]=d.useState({open:!1,userId:"",userName:"",userRole:""}),[O,R]=d.useState({open:!1,step:1,confirmText:""}),[A,Z]=d.useState({open:!1,userId:"",userName:"",currentRole:"",newRole:""}),[E,Ie]=d.useState({open:!1,merchantId:"",merchantName:"",userRole:"merchant"}),[be,Pe]=d.useState({open:!1,userId:"",userName:"",userRole:""}),Be=["user","merchant","supervisor","admin"],Ke=j?Be.filter(s=>s==="user"||s==="merchant"):Be,se=d.useMemo(()=>m?{total:m.length,admins:m.filter(s=>s.role==="admin").length,supervisors:m.filter(s=>s.role==="supervisor").length,merchants:m.filter(s=>s.role==="merchant").length,regularUsers:m.filter(s=>s.role==="user").length}:{total:0,admins:0,supervisors:0,merchants:0,regularUsers:0},[m]),M=d.useMemo(()=>{if(!m)return[];let s=m.filter(b=>{var ae,re;const C=n===""||b.display_name.toLowerCase().includes(n.toLowerCase())||((ae=b.phone)==null?void 0:ae.toLowerCase().includes(n.toLowerCase()))||((re=b.email)==null?void 0:re.toLowerCase().includes(n.toLowerCase())),W=S==="all"||b.role===S;return C&&W});return s.sort((b,C)=>{let W=0;if(L==="name")W=b.display_name.localeCompare(C.display_name);else if(L==="created"){const ae=new Date(b.auth_created_at||b.created_at).getTime(),re=new Date(C.auth_created_at||C.created_at).getTime();W=ae-re}else if(L==="lastLogin"){const ae=b.last_sign_in_at?new Date(b.last_sign_in_at).getTime():0,re=C.last_sign_in_at?new Date(C.last_sign_in_at).getTime():0;W=ae-re}return T==="asc"?W:-W}),s},[m,n,S,L,T]),{displayedData:Re,hasMore:Ge,reset:Oe,displayedCount:es,sentinelRef:ss}=Cs({data:M,initialItemsPerPage:30,incrementPerPage:30});d.useEffect(()=>{Oe()},[n,S,L,T,Oe]);const as=()=>{if(!m||m.length===0){o({title:a("common.error"),description:a("admin.noDataToExport"),variant:"destructive"});return}Ds(m),o({title:a("common.success"),description:a("admin.exportSuccess")})},rs=s=>{y(b=>b.includes(s)?b.filter(C=>C!==s):[...b,s])},ts=()=>{f.length===(M==null?void 0:M.length)?y([]):y((M==null?void 0:M.map(s=>s.id))||[])},ns=()=>{_.userId&&c.mutate(_.userId,{onSuccess:()=>{z({open:!1,userId:"",userName:"",userRole:""})},onError:()=>{z({open:!1,userId:"",userName:"",userRole:""})}})},ls=(s,b,C)=>{z({open:!0,userId:s,userName:b,userRole:C})},is=()=>{f.length===0||O.confirmText.toLowerCase()!=="delete"||l.mutate(f,{onSuccess:()=>{y([]),R({open:!1,step:1,confirmText:""})}})},cs=()=>{f.length!==0&&(F.mutate({userIds:f,role:I}),y([]))},ds=()=>{A.userId&&A.newRole&&U.mutate({userId:A.userId,role:A.newRole},{onSuccess:()=>{Z({open:!1,userId:"",userName:"",currentRole:"",newRole:""}),x(null),g("")}})},os=(s,b,C,W)=>{Z({open:!0,userId:s,userName:b,currentRole:C,newRole:W})},De=s=>{switch(s){case"admin":return"bg-primary text-primary-foreground hover:bg-primary/90";case"supervisor":return"bg-blue-500 text-white hover:bg-blue-600";case"merchant":return"bg-emerald-500 text-white hover:bg-emerald-600";default:return"bg-muted text-muted-foreground hover:bg-muted/80"}},de=s=>{switch(s){case"admin":return e.jsx(K,{className:"h-3.5 w-3.5"});case"supervisor":return e.jsx(K,{className:"h-3.5 w-3.5"});case"merchant":return e.jsx(ce,{className:"h-3.5 w-3.5"});default:return e.jsx(G,{className:"h-3.5 w-3.5"})}};return i?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:a("common.loading")})]})}):e.jsxs("div",{className:"space-y-6 w-full max-w-full overflow-x-hidden",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(Te,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:a("admin.userManagement")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.manageUserRoles")})]})]})}),j?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx($,{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200 dark:from-emerald-950/20 dark:to-emerald-900/20 dark:border-emerald-900/30",children:e.jsx(V,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:a("admin.managedMerchants")}),e.jsx("p",{className:"text-2xl font-bold",children:se.merchants})]}),e.jsx(ce,{className:"h-8 w-8 text-emerald-500"})]})})})}):e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3",children:[e.jsx($,{className:"bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.totalUsersLabel")}),e.jsx("p",{className:"text-xl font-bold",children:se.total})]}),e.jsx(G,{className:"h-6 w-6 text-primary/60 flex-shrink-0"})]})})}),e.jsx($,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 dark:from-red-950/20 dark:to-red-900/20 dark:border-red-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.adminsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:se.admins})]}),e.jsx(K,{className:"h-6 w-6 text-red-500 flex-shrink-0"})]})})}),e.jsx($,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200 dark:from-blue-950/20 dark:to-blue-900/20 dark:border-blue-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.supervisorsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:se.supervisors})]}),e.jsx(K,{className:"h-6 w-6 text-blue-500 flex-shrink-0"})]})})}),e.jsx($,{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200 dark:from-emerald-950/20 dark:to-emerald-900/20 dark:border-emerald-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.merchantsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:se.merchants})]}),e.jsx(ce,{className:"h-6 w-6 text-emerald-500 flex-shrink-0"})]})})}),e.jsx($,{className:"bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200 dark:from-gray-950/20 dark:to-gray-900/20 dark:border-gray-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.regularUsersLabel")}),e.jsx("p",{className:"text-xl font-bold",children:se.regularUsers})]}),e.jsx(G,{className:"h-6 w-6 text-gray-500 flex-shrink-0"})]})})})]}),e.jsx($,{children:e.jsx(V,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"relative",children:[e.jsx(Je,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Q,{placeholder:a("admin.searchUserPlaceholder"),value:n,onChange:s=>u(s.target.value),className:"pl-10 pr-10"}),n&&e.jsx(p,{variant:"ghost",size:"sm",className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7 p-0",onClick:()=>u(""),children:e.jsx(Ve,{className:"h-4 w-4"})})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[!j&&e.jsxs(te,{value:S,onValueChange:q,children:[e.jsxs(ne,{className:"w-full lg:w-[200px]",children:[e.jsx(Us,{className:"h-4 w-4 mr-2"}),e.jsx(le,{placeholder:a("admin.filterRole")})]}),e.jsxs(ie,{children:[e.jsx(B,{value:"all",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),a("admin.allRolesLabel")]})}),e.jsx(B,{value:"admin",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-red-500"}),a("admin.adminsLabel")]})}),e.jsx(B,{value:"supervisor",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-blue-500"}),a("admin.supervisorsLabel")]})}),e.jsx(B,{value:"merchant",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 text-emerald-500"}),a("admin.merchantsLabel")]})}),e.jsx(B,{value:"user",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 text-gray-500"}),a("admin.regularUsersLabel")]})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(te,{value:L,onValueChange:s=>P(s),children:[e.jsxs(ne,{className:"w-full lg:w-[160px]",children:[e.jsx(qs,{className:"h-4 w-4 mr-2"}),e.jsx(le,{})]}),e.jsxs(ie,{children:[e.jsx(B,{value:"name",children:a("admin.sortByName")}),e.jsx(B,{value:"created",children:a("admin.sortByCreated")}),e.jsx(B,{value:"lastLogin",children:a("admin.sortByLastLogin")})]})]}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>k(s=>s==="asc"?"desc":"asc"),title:a(T==="asc"?"admin.sortAsc":"admin.sortDesc"),children:T==="asc"?e.jsx(Ls,{className:"h-4 w-4"}):e.jsx(Ts,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[D&&e.jsx(As,{trigger:e.jsxs(p,{variant:"default",size:"default",children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:a("admin.createUser")}),e.jsx("span",{className:"sm:hidden",children:a("admin.create")})]})}),e.jsxs(p,{variant:"outline",onClick:as,children:[e.jsx(Es,{className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:a("admin.exportLabel")})]})]})]})]})})}),D&&f.length>0&&e.jsx($,{className:"border-primary/50 bg-primary/5",children:e.jsx(V,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{checked:!0,onCheckedChange:()=>y([])}),e.jsxs("span",{className:"font-semibold",children:["已选择 ",f.length," 个用户"]})]}),e.jsxs(p,{variant:"ghost",size:"sm",onClick:()=>y([]),children:[e.jsx(Ve,{className:"h-4 w-4 mr-1"}),"清除选择"]})]}),e.jsx(We,{}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"批量更改角色为："}),e.jsxs(te,{value:I,onValueChange:s=>r(s),children:[e.jsx(ne,{className:"w-full sm:w-[160px]",children:e.jsx(le,{})}),e.jsx(ie,{children:Ke.map(s=>e.jsx(B,{value:s,children:e.jsxs("div",{className:"flex items-center gap-2",children:[de(s),e.jsx("span",{className:"capitalize",children:s})]})},s))})]}),e.jsxs(p,{onClick:cs,size:"default",children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"应用"]})]}),e.jsxs(p,{variant:"destructive",size:"default",onClick:()=>R({open:!0,step:1,confirmText:""}),children:[e.jsx(_e,{className:"mr-2 h-4 w-4"}),"批量删除"]})]})]})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{checked:f.length===(M==null?void 0:M.length)&&M.length>0,onCheckedChange:ts}),e.jsx("span",{className:"font-medium text-sm",children:"全选"})]}),e.jsxs(X,{variant:"secondary",className:"text-xs",children:[es," / ",(M==null?void 0:M.length)||0]})]}),Re&&Re.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3",children:Re.map(s=>{var b;return e.jsx($,{className:`transition-all duration-200 ${t===s.id?"ring-2 ring-primary":"hover:shadow-md"} ${s.is_banned?"border-orange-300 bg-orange-50/50 dark:bg-orange-950/20":""}`,children:e.jsxs(V,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-4 py-2",children:[e.jsx(je,{checked:f.includes(s.id),onCheckedChange:()=>rs(s.id),onClick:C=>C.stopPropagation(),className:"h-5 w-5"}),e.jsxs(Ae,{className:"h-14 w-14 flex-shrink-0",children:[e.jsx(ze,{src:s.avatar_url||""}),e.jsx(Me,{className:"text-lg font-medium bg-primary/10 text-primary",children:((b=s.display_name)==null?void 0:b.charAt(0).toUpperCase())||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-base truncate",children:s.display_name}),s.is_banned&&e.jsx(X,{variant:"outline",className:"text-xs px-1.5 py-0.5 text-orange-500 border-orange-300",children:"已封禁"})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.email||s.phone||"未设置联系方式"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.last_sign_in_at?`最后登录: ${new Date(s.last_sign_in_at).toLocaleString("zh-CN")}`:"从未登录"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs(X,{className:`${De(s.role)} text-xs px-2.5 py-1`,children:[de(s.role),e.jsx("span",{className:"ml-1.5 capitalize",children:s.role})]}),e.jsx(p,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>N(t===s.id?null:s.id),children:e.jsx(gs,{className:`h-5 w-5 transition-transform ${t===s.id?"rotate-180":""}`})})]})]}),t===s.id&&e.jsxs("div",{className:"mt-3 pt-3 border-t space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"邮箱:"}),e.jsx("p",{className:"truncate",children:s.email||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"电话:"}),e.jsx("p",{className:"truncate",children:s.phone||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"创建时间:"}),e.jsx("p",{children:s.auth_created_at?new Date(s.auth_created_at).toLocaleDateString("zh-CN"):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"最后登录:"}),e.jsx("p",{children:s.last_sign_in_at?new Date(s.last_sign_in_at).toLocaleString("zh-CN"):"-"})]})]}),D&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(te,{value:w===s.id?h:"",onValueChange:C=>{x(s.id),g(C)},children:[e.jsx(ne,{className:"h-8 text-xs flex-1",children:e.jsx(le,{placeholder:"更改角色..."})}),e.jsx(ie,{children:Ke.filter(C=>C!==s.role).map(C=>e.jsx(B,{value:C,children:e.jsxs("div",{className:"flex items-center gap-2",children:[de(C),e.jsx("span",{className:"capitalize",children:C})]})},C))})]}),e.jsx(p,{size:"sm",className:"h-8 text-xs",onClick:()=>{w===s.id&&h&&os(s.id,s.display_name,s.role,h)},disabled:w!==s.id||!h,children:"确认"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>Pe({open:!0,userId:s.id,userName:s.display_name,userRole:s.role}),children:[e.jsx(Fs,{className:"mr-1.5 h-3.5 w-3.5"}),"查看资料"]}),j&&s.role==="merchant"&&e.jsx(Ps,{merchant:{id:s.id,display_name:s.display_name,phone:s.phone,avatar_url:s.avatar_url},trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(Ye,{className:"mr-1.5 h-3.5 w-3.5"}),"编辑资料"]})}),(s.role==="merchant"||s.role==="supervisor")&&e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>Ie({open:!0,merchantId:s.id,merchantName:s.display_name,userRole:s.role}),children:[e.jsx(Fe,{className:"mr-1.5 h-3.5 w-3.5"}),"餐厅"]}),D&&s.role==="merchant"&&e.jsx(Ms,{merchantId:s.id,merchantName:s.display_name,trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(Te,{className:"mr-1.5 h-3.5 w-3.5"}),"分配主管"]})}),D&&s.role==="supervisor"&&e.jsx(Is,{supervisorId:s.id,supervisorName:s.display_name,trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(G,{className:"mr-1.5 h-3.5 w-3.5"}),"管理商家"]})}),D&&s.role!=="admin"&&e.jsxs(p,{variant:"destructive",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>ls(s.id,s.display_name,s.role),children:[e.jsx(_e,{className:"mr-1.5 h-3.5 w-3.5"}),"删除"]})]})]})]})},s.id)})}):e.jsx($,{children:e.jsx(V,{className:"pt-12 pb-12",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(G,{className:"h-16 w-16 text-muted-foreground/50 mx-auto"}),e.jsx("h3",{className:"text-lg font-semibold",children:"未找到用户"}),e.jsx("p",{className:"text-muted-foreground",children:n||S!=="all"?"尝试调整搜索条件或筛选器":"还没有任何用户"})]})})}),Ge&&e.jsx("div",{ref:ss,className:"flex justify-center py-4",children:e.jsx(Y,{className:"h-6 w-6 animate-spin text-muted-foreground"})})]}),e.jsx(Ue,{open:A.open,onOpenChange:s=>{s||Z({open:!1,userId:"",userName:"",currentRole:"",newRole:""})},children:e.jsxs(qe,{className:"max-w-[90vw] sm:max-w-[500px]",children:[e.jsxs(oe,{children:[e.jsxs(me,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5 text-primary"}),"确认角色更改"]}),e.jsxs(he,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"用户："}),e.jsx("span",{className:"font-semibold text-foreground",children:A.userName})]}),e.jsx(We,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"当前角色："}),e.jsxs(X,{className:De(A.currentRole),children:[de(A.currentRole),e.jsx("span",{className:"ml-1.5 capitalize",children:A.currentRole})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"text-2xl text-primary",children:"↓"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"新角色："}),e.jsxs(X,{className:De(A.newRole),children:[de(A.newRole),e.jsx("span",{className:"ml-1.5 capitalize",children:A.newRole})]})]})]}),A.newRole==="admin"&&e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg flex gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-destructive text-sm",children:"⚠️ 警告：管理员权限"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"您即将授予该用户管理员权限。管理员可以管理所有用户、餐厅和活动，包括删除数据和分配角色。"})]})]}),A.currentRole==="admin"&&e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg flex gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-destructive text-sm",children:"⚠️ 警告：移除管理员权限"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"您即将移除该用户的管理员权限。该用户将失去对系统的完全访问权限。"})]})]}),e.jsx("p",{className:"text-sm text-center text-muted-foreground",children:"此操作将立即生效。确定要继续吗？"})]})]}),e.jsxs(xe,{children:[e.jsx(ue,{children:"取消"}),e.jsx(pe,{onClick:ds,className:"bg-primary",children:"确认更改"})]})]})}),e.jsx(zs,{open:E.open,onOpenChange:s=>Ie({...E,open:s}),merchantId:E.merchantId,merchantName:E.merchantName,userRole:E.userRole}),e.jsx(Bs,{open:_.open,onOpenChange:s=>{s||z({open:!1,userId:"",userName:"",userRole:""})},userName:_.userName,userId:_.userId,userRole:_.userRole,onConfirm:ns,isDeleting:c.isPending}),e.jsx(Ue,{open:O.open,onOpenChange:s=>{s||R({open:!1,step:1,confirmText:""})},children:e.jsx(qe,{className:"max-w-[90vw] sm:max-w-[500px]",children:O.step===1?e.jsxs(e.Fragment,{children:[e.jsxs(oe,{children:[e.jsxs(me,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ze,{className:"h-5 w-5"}),a("admin.batchDeleteTitle")]}),e.jsxs(he,{className:"space-y-4 pt-4",children:[e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg",children:e.jsx("p",{className:"font-semibold text-foreground",children:a("admin.batchDeleteStep1",{count:f.length})})}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:a("admin.deleteUserConsequences")}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:a("admin.deleteUserData1")}),e.jsx("li",{children:a("admin.deleteUserData2")}),e.jsx("li",{children:a("admin.deleteUserData3")}),e.jsx("li",{children:a("admin.deleteUserData4")})]})]})]})]}),e.jsxs(xe,{children:[e.jsx(ue,{onClick:()=>R({open:!1,step:1,confirmText:""}),children:a("common.cancel")}),e.jsx(pe,{onClick:()=>R(s=>({...s,step:2})),className:"bg-destructive hover:bg-destructive/90",children:a("common.continue")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(oe,{children:[e.jsxs(me,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(_e,{className:"h-5 w-5"}),a("admin.batchDeleteStep2Title")]}),e.jsxs(he,{className:"space-y-4 pt-4",children:[e.jsx("p",{className:"text-foreground font-medium",children:a("admin.batchDeleteStep2Desc",{count:f.length})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"batch-delete-confirm",className:"text-sm font-medium",children:a("admin.typeDeleteToConfirm")}),e.jsx(Q,{id:"batch-delete-confirm",value:O.confirmText,onChange:s=>R(b=>({...b,confirmText:s.target.value})),placeholder:"DELETE",className:"uppercase",autoComplete:"off"})]})]})]}),e.jsxs(xe,{children:[e.jsx(ue,{onClick:()=>R({open:!1,step:1,confirmText:""}),children:a("common.cancel")}),e.jsx(pe,{onClick:is,disabled:O.confirmText.toLowerCase()!=="delete"||l.isPending,className:"bg-destructive hover:bg-destructive/90",children:l.isPending?a("common.loading"):a("admin.deleteUser")})]})]})})}),e.jsx(Rs,{open:be.open,onOpenChange:s=>Pe(b=>({...b,open:s})),userId:be.userId,userName:be.userName,userRole:be.userRole})]})};export{xa as default};
