{"version":3,"file":"useRestaurants-B1x0T7kO.js","sources":["../../src/hooks/useRestaurants.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport i18n from \"i18next\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport interface Restaurant {\r\n  id: string;\r\n  name: string;\r\n  name_en?: string;\r\n  name_pt?: string;\r\n  address: string;\r\n  lat: number;\r\n  lng: number;\r\n  phone?: string | null;\r\n  opening_hours?: any;\r\n  type: string[];\r\n  type_en?: string[];\r\n  type_pt?: string[];\r\n  rating?: number;\r\n  description?: string | null;\r\n  description_en?: string | null;\r\n  description_pt?: string | null;\r\n  announcement_en?: string | null;\r\n  announcement_pt?: string | null;\r\n  announcement_zh?: string | null;\r\n  image_url?: string | null;\r\n  cover_image_url?: string | null;\r\n  website_url?: string | null;\r\n  show_website_button?: boolean;\r\n  visible?: boolean;\r\n  template?: string;\r\n  owner_avatar_url?: string | null;\r\n  owner_bio?: string | null;\r\n  owner_bio_en?: string | null;\r\n  owner_bio_pt?: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport const useRestaurants = (searchQuery?: string, typeFilter?: string) => {\r\n  return useQuery({\r\n    queryKey: [\"restaurants\", searchQuery, typeFilter],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from(\"restaurants\")\r\n        .select(\"*\")\r\n        .eq(\"visible\", true)\r\n        .order(\"rating\", { ascending: false });\r\n\r\n      if (searchQuery) {\r\n        query = query.or(`name.ilike.%${searchQuery}%,address.ilike.%${searchQuery}%`);\r\n      }\r\n\r\n      if (typeFilter) {\r\n        // Split multiple types by comma and search with OR logic\r\n        const types = typeFilter.split(',');\r\n        const orConditions = types.flatMap(type => [\r\n          `type.cs.{${type}}`,\r\n          `type_en.cs.{${type}}`,\r\n          `type_pt.cs.{${type}}`\r\n        ]);\r\n        query = query.or(orConditions.join(','));\r\n      }\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n      return data as Restaurant[];\r\n    },\r\n  });\r\n};\r\n\r\nexport const useRestaurant = (id: string) => {\r\n  return useQuery({\r\n    queryKey: [\"restaurant\", id],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"restaurants\")\r\n        .select(\"*\")\r\n        .eq(\"id\", id)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data as Restaurant;\r\n    },\r\n    enabled: !!id,\r\n  });\r\n};\r\n\r\nexport const useFavoriteIds = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"favorite-ids\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"favorites\")\r\n        .select(\"restaurant_id\")\r\n        .eq(\"user_id\", user.id);\r\n\r\n      if (error) throw error;\r\n      return data.map(f => f.restaurant_id);\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\n\r\n// Keep the old name for backwards compatibility but make it use the new one\r\nexport const useFavorites = useFavoriteIds;\r\n\r\nexport const useToggleFavorite = () => {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (restaurantId: string) => {\r\n      if (!user) throw new Error(\"Must be logged in\");\r\n\r\n      // Check if already favorited\r\n      const { data: existing } = await supabase\r\n        .from(\"favorites\")\r\n        .select(\"id\")\r\n        .eq(\"user_id\", user.id)\r\n        .eq(\"restaurant_id\", restaurantId)\r\n        .maybeSingle();\r\n\r\n      if (existing) {\r\n        // Remove favorite\r\n        const { error } = await supabase\r\n          .from(\"favorites\")\r\n          .delete()\r\n          .eq(\"id\", existing.id);\r\n\r\n        if (error) throw error;\r\n        return { action: \"removed\" };\r\n      } else {\r\n        // Add favorite\r\n        const { error } = await supabase\r\n          .from(\"favorites\")\r\n          .insert({\r\n            user_id: user.id,\r\n            restaurant_id: restaurantId,\r\n          });\r\n\r\n        if (error) throw error;\r\n        return { action: \"added\" };\r\n      }\r\n    },\r\n    onSuccess: (result) => {\r\n      queryClient.invalidateQueries({ queryKey: [\"favorites\"] });\r\n      toast.success(i18n.t(result.action === \"added\" ? \"toast.favoriteAdded\" : \"toast.favoriteRemoved\"));\r\n    },\r\n    onError: (error: any) => {\r\n      if (error.message === \"Must be logged in\") {\r\n        toast.error(i18n.t(\"toast.signInToFavorite\"));\r\n      } else {\r\n        toast.error(i18n.t(\"toast.favoritesUpdateFailed\"));\r\n      }\r\n    },\r\n  });\r\n};\r\n\r\nexport const useRestaurantTypes = () => {\r\n  return useQuery({\r\n    queryKey: [\"restaurant-types\", i18n.language],\r\n    queryFn: async () => {\r\n      const currentLang = i18n.language;\r\n      // Determine which field to use based on language\r\n      const typeField = currentLang === \"zh\" ? \"type\" : \r\n                       currentLang === \"pt\" ? \"type_pt\" : \r\n                       \"type_en\";\r\n      \r\n      const { data, error } = await supabase\r\n        .from(\"restaurants\")\r\n        .select(`type, type_en, type_pt`)\r\n        .order(\"type\");\r\n\r\n      if (error) throw error;\r\n      \r\n      // Get the appropriate type field based on language\r\n      const allTypes = data.flatMap(r => {\r\n        const types = r[typeField as keyof typeof r];\r\n        // Fallback to English if localized version doesn't exist\r\n        return types || r.type_en || r.type || [];\r\n      });\r\n      \r\n      const uniqueTypes = Array.from(new Set(allTypes)).sort();\r\n      return uniqueTypes;\r\n    },\r\n  });\r\n};\r\n"],"names":["useRestaurants","searchQuery","typeFilter","useQuery","query","supabase","orConditions","type","data","error","useRestaurant","id","useFavoriteIds","user","useAuth","f","useFavorites","useToggleFavorite","queryClient","useQueryClient","useMutation","restaurantId","existing","result","toast","i18n","useRestaurantTypes","currentLang","typeField","allTypes","r"],"mappings":"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"}