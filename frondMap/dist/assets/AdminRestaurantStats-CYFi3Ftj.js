import{bA as Z,p as ee,r as se,s as j,j as e,L as p,bk as ae,b5 as te,bc as F,b0 as W,bD as ne,bB as re,bS as $,aY as L,bb as I,bt as q,cC as ie,cD as le,cE as de,cF as ce,cG as me,cH as oe,cI as xe,cK as he}from"./vendor-react-87iFmKFJ.js";import{f as ue}from"./textFormatting-37JGiPHb.js";import{S as T,h as w,a7 as ge,a8 as je,a9 as pe,aa as fe,ab as _,C as l,n as d,m as f,E as N,a4 as A,V as z,W as H,X as K,B as E,s as b}from"./index-CH4FpCej.js";import{f as D}from"./paginatedQuery-nXwNybMX.js";import{d as Ne}from"./useRestaurants-CuLkQhYp.js";import{u as ve}from"./useLocalizedContent-CFh79NZC.js";import{s as S,W as G,D as m,f as B}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CQWbleDe.js";const Ae=()=>{const{id:n}=Z(),{t}=ee(),{localizeRestaurant:X}=ve(),[o,Y]=se.useState("30days"),Q=()=>{const s=new Date;switch(o){case"today":return B(s).toISOString();case"7days":return B(S(s,6)).toISOString();case"30days":return B(S(s,29)).toISOString();default:return null}},U=()=>{switch(o){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:h,isLoading:J}=Ne(n),x=Q(),{data:C=[],isLoading:ye}=j({queryKey:["restaurant-page-views",n,o],queryFn:async()=>await D("page_views","created_at",s=>(s=s.eq("page_type","restaurant").eq("target_id",n),x&&(s=s.gte("created_at",x)),s)),enabled:!!n}),{data:u=[],isLoading:we}=j({queryKey:["restaurant-comments",n,o],queryFn:async()=>{const s=await D("comments","id, user_id, content, rating_value, created_at",a=>(a=a.eq("target_type","restaurant").eq("target_id",n).order("created_at",{ascending:!1}),x&&(a=a.gte("created_at",x)),a));if(s&&s.length>0){const a=[...new Set(s.map(r=>r.user_id))],{data:i}=await b.rpc("get_public_profiles",{user_ids:a});return s.map(r=>({...r,profile:i?.find(c=>c.id===r.user_id)}))}return[]},enabled:!!n}),{data:v=[],isLoading:_e}=j({queryKey:["restaurant-favorites",n,o],queryFn:async()=>{const s=await D("favorites","user_id, created_at",a=>(a=a.eq("restaurant_id",n),x&&(a=a.gte("created_at",x)),a));if(s&&s.length>0){const a=s.map(r=>r.user_id),{data:i}=await b.rpc("get_public_profiles",{user_ids:a});return s.map(r=>({...r,profile:i?.find(c=>c.id===r.user_id)}))}return[]},enabled:!!n}),{data:y=[],isLoading:be}=j({queryKey:["restaurant-posts",n,o],queryFn:async()=>{const s=await D("community_posts","id, author_id, content, likes_count, comments_count, views_count, created_at, status",a=>(a=a.eq("restaurant_id",n).order("created_at",{ascending:!1}),x&&(a=a.gte("created_at",x)),a));if(s&&s.length>0){const a=[...new Set(s.map(r=>r.author_id))],{data:i}=await b.rpc("get_public_profiles",{user_ids:a});return s.map(r=>({...r,profile:i?.find(c=>c.id===r.author_id)}))}return[]},enabled:!!n}),{data:O=[]}=j({queryKey:["restaurant-activities",n],queryFn:async()=>{const{data:s,error:a}=await b.from("activity_restaurants").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            status
          )
        `).eq("restaurant_id",n);if(a)throw a;return s?.map(i=>i.activities).filter(Boolean)||[]},enabled:!!n}),P=(()=>{if(o==="all"){const a=new Date,i=S(a,29);return G({start:i,end:a}).map(c=>{const g=m(c,"yyyy-MM-dd"),R=C.filter(k=>m(new Date(k.created_at),"yyyy-MM-dd")===g).length;return{date:g,views:R}})}else{const s=U(),a=new Date,i=S(a,s-1);return G({start:i,end:a}).map(c=>{const g=m(c,"yyyy-MM-dd"),R=C.filter(k=>m(new Date(k.created_at),"yyyy-MM-dd")===g).length;return{date:g,views:R}})}})(),V=u.length>0?u.filter(s=>s.rating_value).reduce((s,a)=>s+(a.rating_value||0),0)/u.filter(s=>s.rating_value).length:0,M=h?X(h):null;return J?e.jsxs("div",{className:"space-y-6",children:[e.jsx(T,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(T,{className:"h-24"},s))}),e.jsx(T,{className:"h-64"})]}):!h||!M?e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"text-muted-foreground",children:t("error.notFound")})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(p,{to:"/admin/restaurant-stats",children:e.jsx(ae,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[h.image_url?e.jsx("img",{src:h.image_url,alt:M.name,className:"w-12 h-12 rounded-lg object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(te,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:ue(M.name)}),h.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(F,{className:"h-3 w-3 fill-amber-400 text-amber-400"}),e.jsx("span",{children:h.rating.toFixed(1)})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(ge,{value:o,onValueChange:s=>Y(s),children:[e.jsx(je,{className:"w-[140px]",children:e.jsx(pe,{})}),e.jsxs(fe,{children:[e.jsx(_,{value:"today",children:t("analytics.today","今日")}),e.jsx(_,{value:"7days",children:t("analytics.last7Days","近7天")}),e.jsx(_,{value:"30days",children:t("analytics.last30Days","近30天")}),e.jsx(_,{value:"all",children:t("analytics.allTime","所有时间")})]})]}),e.jsx(w,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(p,{to:`/restaurant/${n}`,target:"_blank",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),t("admin.preview","预览")]})}),e.jsx(w,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(p,{to:"/admin/restaurants",state:{editRestaurantId:n},children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),t("admin.edit","编辑")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx($,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.views","浏览量")}),e.jsx("p",{className:"text-2xl font-bold",children:C.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx(L,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.comments","评论")}),e.jsx("p",{className:"text-2xl font-bold",children:u.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg",children:e.jsx(I,{className:"h-5 w-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.favorites","收藏")}),e.jsx("p",{className:"text-2xl font-bold",children:v.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-500/10 rounded-lg",children:e.jsx(q,{className:"h-5 w-5 text-purple-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.posts","帖子")}),e.jsx("p",{className:"text-2xl font-bold",children:y.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/10 rounded-lg",children:e.jsx(F,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.avgRating","平均评分")}),e.jsx("p",{className:"text-2xl font-bold",children:V>0?V.toFixed(1):"-"})]})]})})})]}),e.jsxs(l,{children:[e.jsx(f,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),t("admin.viewTrend","浏览趋势")]})}),e.jsx(d,{children:e.jsx("div",{className:"h-[300px]",children:P.length>0?e.jsx(le,{width:"100%",height:"100%",children:e.jsxs(de,{data:P,children:[e.jsx(ce,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(me,{dataKey:"date",tickFormatter:s=>m(new Date(s),"MM/dd"),className:"text-xs"}),e.jsx(oe,{className:"text-xs"}),e.jsx(xe,{labelFormatter:s=>m(new Date(s),"yyyy-MM-dd"),contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(he,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,name:t("admin.views")})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:t("analytics.noData")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(l,{children:[e.jsxs(f,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-5 h-5"}),t("admin.recentComments","最近评论")]}),e.jsx(A,{children:t("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(u.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[u.slice(0,10).map(s=>e.jsxs("div",{className:"flex gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(z,{className:"h-8 w-8",children:[e.jsx(H,{src:s.profile?.avatar_url}),e.jsx(K,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),s.rating_value&&e.jsxs(E,{variant:"secondary",className:"text-xs",children:[e.jsx(F,{className:"h-3 w-3 mr-1 fill-amber-400 text-amber-400"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:m(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},s.id)),u.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:t("admin.noComments","暂无评论")})]})})]}),e.jsxs(l,{children:[e.jsxs(f,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),t("admin.recentFavorites","最近收藏")]}),e.jsx(A,{children:t("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(v.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:[v.slice(0,10).map((s,a)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(z,{className:"h-8 w-8",children:[e.jsx(H,{src:s.profile?.avatar_url}),e.jsx(K,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:m(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},a)),v.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:t("admin.noFavorites","暂无收藏")})]})})]}),e.jsxs(l,{children:[e.jsxs(f,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),t("admin.recentPosts","最近帖子")]}),e.jsx(A,{children:t("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(y.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[y.slice(0,10).map(s=>e.jsxs(p,{to:`/post/${s.id}`,className:"flex gap-3 p-3 bg-muted/50 rounded-lg hover:bg-muted/70 transition-colors block",children:[e.jsxs(z,{className:"h-8 w-8",children:[e.jsx(H,{src:s.profile?.avatar_url}),e.jsx(K,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),e.jsx(E,{variant:s.status==="approved"?"default":"secondary",className:"text-xs",children:s.status==="approved"?t("admin.published","已发布"):s.status})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content?.replace(/<[^>]*>/g,"")}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx($,{className:"h-3 w-3"}),s.views_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(I,{className:"h-3 w-3"}),s.likes_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-3 w-3"}),s.comments_count||0]}),e.jsx("span",{children:m(new Date(s.created_at),"MM-dd HH:mm")})]})]})]},s.id)),y.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:t("admin.noPosts","暂无帖子")})]})})]})]}),e.jsxs(l,{children:[e.jsx(f,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"}),t("admin.participatingActivities","参与的活动")]})}),e.jsx(d,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[O.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.title_zh||s.title_en}),e.jsx(E,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?t("admin.published","已发布"):t("admin.draft","草稿")})]}),e.jsx(w,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:e.jsx(p,{to:`/admin/activity-stats/${s.id}`,children:t("admin.viewStats","查看统计")})})]},s.id)),O.length===0&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:t("admin.noActivities","暂未参与活动")})]})})]})]})};export{Ae as default};
//# sourceMappingURL=AdminRestaurantStats-CYFi3Ftj.js.map
