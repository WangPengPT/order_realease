import{j as e}from"./vendor-ui-BO6fjm1h.js";import{r as S}from"./vendor-react-CrHRjzzo.js";import{s as k,B as T,bj as Z,q as f,R as u,a0 as h,b2 as J,T as j,Q as v,aL as R,bi as M,y as W,I as Y,aZ as B,a_ as K,a$ as Q,b0 as H,b1 as p,cO as I,k as _,$ as ee,bn as ae,bo as ie,bp as se}from"./index-H22t9J9U.js";import{T as te,a as re,b as $,c as N,d as ne,e as w}from"./table-BBKbJYH6.js";import{a as P,u as le}from"./vendor-query-EnOED-MY.js";import{u as ce}from"./vendor-i18n-DWR4v88Y.js";import{f as oe}from"./format-CJY1CPN0.js";import"./vendor-charts-C50LysBY.js";import"./vendor-supabase-QnE9GqXs.js";import"./startOfDay-IkT9CN03.js";const de=a=>{const r=a.split("@");return r.length>1?r[1]:""},z=a=>[".edu",".edu.pt",".edu.br",".edu.cn","iscte","estudantes","alunos","student","university","universidade","uni.",".ac."].some(s=>a.toLowerCase().includes(s)),me=(a,r,s,d=0,m=50)=>P({queryKey:["email-verification-logs",a,r,s,d,m],queryFn:async()=>{let t=k.from("email_verification_codes").select("*",{count:"exact"}).order("created_at",{ascending:!1});a==="verified"?t=t.eq("verified",!0):a==="expired"?t=t.eq("verified",!1).lt("expires_at",new Date().toISOString()):a==="pending"&&(t=t.eq("verified",!1).gte("expires_at",new Date().toISOString())),r&&(t=t.ilike("email",`%${r}%`)),s&&(t=t.ilike("email",`%@${s}`));const y=d*m,b=y+m-1;t=t.range(y,b);const{data:q,error:n,count:o}=await t;if(n)throw n;const g=new Date;return{logs:(q||[]).map(l=>{const C=de(l.email),x=new Date(l.expires_at);let c;return l.verified?c="verified":x<g?c="expired":c="pending",{id:l.id,email:l.email,verified:l.verified||!1,created_at:l.created_at||"",expires_at:l.expires_at,status:c,domain:C,isSchoolEmail:z(C)}}),totalCount:o||0,totalPages:Math.ceil((o||0)/m),currentPage:d}}}),xe=()=>P({queryKey:["email-verification-stats"],queryFn:async()=>{const{data:a,error:r}=await k.rpc("get_email_verification_stats");if(r)throw r;if(a&&typeof a=="object"&&"error"in a)throw new Error(String(a.error));const s=a;return{total:s.total||0,verified:s.verified||0,expired:s.expired||0,pending:s.pending||0,verificationRate:s.verificationRate||0}}}),fe=()=>P({queryKey:["email-domains"],queryFn:async()=>{const{data:a,error:r}=await k.rpc("get_email_domain_stats");if(r)throw r;return!a||!Array.isArray(a)?[]:a.map(s=>({domain:s.domain,count:s.count,isSchoolEmail:z(s.domain)}))}}),Ve=()=>{const{t:a,i18n:r}=ce(),s=le(),[d,m]=S.useState("all"),[t,y]=S.useState(""),[b,q]=S.useState(""),[n,o]=S.useState(0),g=50,{data:V,isLoading:l,refetch:C}=me(d,t,b,n,g),{data:x,isLoading:c}=xe(),{data:F}=fe(),L=V?.logs||[],D=V?.totalCount||0,E=V?.totalPages||0,O=()=>{switch(r.language){case"zh":return se;case"pt":return ie;default:return ae}},A=i=>i?oe(new Date(i),"yyyy-MM-dd HH:mm",{locale:O()}):"-",G=i=>{switch(i){case"verified":return e.jsxs(_,{className:"bg-green-500/10 text-green-600 hover:bg-green-500/20",children:[e.jsx(R,{className:"w-3 h-3 mr-1"}),a("admin.emailVerification.verified","已验证")]});case"expired":return e.jsxs(_,{variant:"destructive",className:"bg-red-500/10 text-red-600 hover:bg-red-500/20",children:[e.jsx(M,{className:"w-3 h-3 mr-1"}),a("admin.emailVerification.expired","已过期")]});case"pending":return e.jsxs(_,{variant:"secondary",className:"bg-yellow-500/10 text-yellow-600 hover:bg-yellow-500/20",children:[e.jsx(ee,{className:"w-3 h-3 mr-1"}),a("admin.emailVerification.pending","待验证")]})}},U=()=>{s.invalidateQueries({queryKey:["email-verification-logs"]}),s.invalidateQueries({queryKey:["email-verification-stats"]}),s.invalidateQueries({queryKey:["email-domains"]}),C()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:a("admin.emailVerification.title","邮箱验证管理")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.emailVerification.description","查看所有验证码发送记录和验证状态")})]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:U,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),a("common.refresh","刷新")]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(f,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:a("admin.emailVerification.totalSent","总发送数")}),e.jsx(J,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold",children:x?.total||0})})]}),e.jsxs(f,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:a("admin.emailVerification.verifiedCount","已验证")}),e.jsx(R,{className:"h-4 w-4 text-green-500"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-green-600",children:x?.verified||0})})]}),e.jsxs(f,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:a("admin.emailVerification.expiredCount","已过期未验证")}),e.jsx(M,{className:"h-4 w-4 text-red-500"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-red-600",children:x?.expired||0})})]}),e.jsxs(f,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:a("admin.emailVerification.verificationRate","验证成功率")}),e.jsx(R,{className:"h-4 w-4 text-blue-500"})]}),e.jsx(j,{children:c?e.jsx(v,{className:"h-8 w-16"}):e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[x?.verificationRate||0,"%"]})})]})]}),e.jsxs(f,{children:[e.jsx(u,{children:e.jsx(h,{className:"text-lg",children:a("admin.emailVerification.filters","筛选条件")})}),e.jsx(j,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Y,{placeholder:a("admin.emailVerification.searchPlaceholder","搜索邮箱..."),value:t,onChange:i=>{y(i.target.value),o(0)},className:"pl-10"})]}),e.jsxs(B,{value:d,onValueChange:i=>{m(i),o(0)},children:[e.jsx(K,{className:"w-full sm:w-40",children:e.jsx(Q,{placeholder:a("admin.emailVerification.allStatus","全部状态")})}),e.jsxs(H,{children:[e.jsx(p,{value:"all",children:a("admin.emailVerification.allStatus","全部状态")}),e.jsx(p,{value:"verified",children:a("admin.emailVerification.verified","已验证")}),e.jsx(p,{value:"expired",children:a("admin.emailVerification.expired","已过期")}),e.jsx(p,{value:"pending",children:a("admin.emailVerification.pending","待验证")})]})]}),e.jsxs(B,{value:b||"all",onValueChange:i=>{q(i==="all"?"":i),o(0)},children:[e.jsx(K,{className:"w-full sm:w-48",children:e.jsx(Q,{placeholder:a("admin.emailVerification.allDomains","全部域名")})}),e.jsxs(H,{children:[e.jsx(p,{value:"all",children:a("admin.emailVerification.allDomains","全部域名")}),F?.map(i=>e.jsxs(p,{value:i.domain,children:[i.isSchoolEmail&&e.jsx(I,{className:"w-3 h-3 inline mr-1"}),i.domain," (",i.count,")"]},i.domain))]})]})]})})]}),e.jsxs(f,{children:[e.jsx(u,{children:e.jsxs(h,{className:"text-lg flex items-center gap-2",children:[a("admin.emailVerification.records","验证记录"),e.jsx(_,{variant:"secondary",children:D})]})}),e.jsx(j,{children:l?e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((i,X)=>e.jsx(v,{className:"h-12 w-full"},X))}):L.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(te,{children:[e.jsx(re,{children:e.jsxs($,{children:[e.jsx(N,{children:a("admin.emailVerification.email","邮箱")}),e.jsx(N,{children:a("admin.emailVerification.status","状态")}),e.jsx(N,{children:a("admin.emailVerification.domain","域名")}),e.jsx(N,{children:a("admin.emailVerification.sentAt","发送时间")}),e.jsx(N,{children:a("admin.emailVerification.expiresAt","过期时间")})]})}),e.jsx(ne,{children:L.map(i=>e.jsxs($,{children:[e.jsx(w,{className:"font-medium",children:i.email}),e.jsx(w,{children:G(i.status)}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[i.isSchoolEmail&&e.jsx(I,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:i.domain})]})}),e.jsx(w,{className:"text-sm text-muted-foreground",children:A(i.created_at)}),e.jsx(w,{className:"text-sm text-muted-foreground",children:A(i.expires_at)})]},i.id))})]})}),E>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a("admin.emailVerification.showing","显示")," ",n*g+1," - ",Math.min((n+1)*g,D)," ",a("admin.emailVerification.of","共")," ",D]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{variant:"outline",size:"sm",onClick:()=>o(Math.max(0,n-1)),disabled:n===0,children:a("common.previous","上一页")}),e.jsx(T,{variant:"outline",size:"sm",onClick:()=>o(Math.min(E-1,n+1)),disabled:n>=E-1,children:a("common.next","下一页")})]})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("admin.emailVerification.noRecords","暂无记录")})})]})]})};export{Ve as default};
//# sourceMappingURL=AdminEmailVerification-kLF27cQT.js.map
