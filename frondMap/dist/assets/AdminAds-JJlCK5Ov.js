import{p as R,q as ae,s as te,v as A,r as p,j as e,bW as re,b1 as O,d0 as P,bz as ne,cX as ie,ak as le,bU as z,X as de}from"./vendor-react-BycBeP44.js";import{X as x,s as S,h as j,C as oe,n as ce,S as me,B as ue,D as xe,c as he,d as ge,e as pe,U as _,I as y,V as je,A as _e,q as ve,r as fe,t as ye,v as be,w as we,x as Ne,y as ke}from"./index-B82I__2U.js";import{T as De,a as Ae,b as B,c as v,d as Ce,e as f}from"./table-B7kvgjV9.js";import{S as $}from"./switch-BebVCsEQ.js";import{D as L}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CJSxlXC7.js";const C=()=>S.from("ads"),Se=()=>{const{t:a}=R(),d=ae(),T=te({queryKey:["ads"],queryFn:async()=>{const{data:r,error:n}=await C().select("*").order("sort_order",{ascending:!0}).order("created_at",{ascending:!1});if(n)throw n;return r}}),b=A({mutationFn:async r=>{const{error:n}=await C().insert(r);if(n)throw n},onSuccess:()=>{d.invalidateQueries({queryKey:["ads"]}),x({title:a("common.success"),description:a("admin.ads.createSuccess","广告创建成功")})},onError:r=>{x({title:a("common.error"),description:r.message,variant:"destructive"})}}),w=A({mutationFn:async({id:r,...n})=>{try{const{data:i,error:c}=await C().update(n).eq("id",r).select();if(c)throw c;return i}catch(i){if(i?.message?.includes("Failed to fetch"))return console.warn("Preview network issue, update likely succeeded:",r),null;throw i}},onMutate:async({id:r,...n})=>{await d.cancelQueries({queryKey:["ads"]});const i=d.getQueryData(["ads"]);return d.setQueryData(["ads"],c=>c?.map(m=>m.id===r?{...m,...n}:m)),{previousAds:i}},onError:(r,n,i)=>{i?.previousAds&&d.setQueryData(["ads"],i.previousAds),x({title:a("common.error"),description:r.message,variant:"destructive"})},onSuccess:()=>{x({title:a("common.success"),description:a("admin.ads.updateSuccess","广告更新成功")})},onSettled:()=>{d.invalidateQueries({queryKey:["ads"]})}}),I=A({mutationFn:async({id:r,is_active:n})=>{const{error:i}=await S.rpc("update_ad_status",{ad_id:r,new_is_active:n});if(i)throw i},onMutate:async({id:r,is_active:n})=>{await d.cancelQueries({queryKey:["ads"]});const i=d.getQueryData(["ads"]);return d.setQueryData(["ads"],c=>c?.map(m=>m.id===r?{...m,is_active:n}:m)),{previousAds:i}},onError:(r,n,i)=>{i?.previousAds&&d.setQueryData(["ads"],i.previousAds),x({title:a("common.error"),description:r.message,variant:"destructive"})},onSuccess:()=>{x({title:a("common.success"),description:a("admin.ads.updateSuccess","广告更新成功")})},onSettled:()=>{d.invalidateQueries({queryKey:["ads"]})}}),E=A({mutationFn:async r=>{const{error:n}=await C().delete().eq("id",r);if(n)throw n},onSuccess:()=>{d.invalidateQueries({queryKey:["ads"]}),x({title:a("common.success"),description:a("admin.ads.deleteSuccess","广告删除成功")})},onError:r=>{x({title:a("common.error"),description:r.message,variant:"destructive"})}});return{...T,createAd:b,updateAd:w,toggleAdStatus:I,deleteAd:E}},Te=375,Ie=112,Ee=672,Fe=112,ze=()=>{const{t:a}=R(),{data:d,isLoading:T,createAd:b,updateAd:w,toggleAdStatus:I,deleteAd:E}=Se(),[r,n]=p.useState(null),[i,c]=p.useState(!1),[m,F]=p.useState(null),[W,H]=p.useState(null),X=p.useRef(null),G=p.useRef(null),[l,u]=p.useState({name:"",image_url:"",mobile_image_url:"",desktop_image_url:"",link_url:"",sort_order:0,start_date:"",end_date:"",is_active:!0}),V=()=>{n(null),u({name:"",image_url:"",mobile_image_url:"",desktop_image_url:"",link_url:"",sort_order:0,start_date:"",end_date:"",is_active:!0}),c(!0)},J=s=>{n(s),u({name:s.name,image_url:s.image_url||"",mobile_image_url:s.mobile_image_url||"",desktop_image_url:s.desktop_image_url||"",link_url:s.link_url||"",sort_order:s.sort_order,start_date:s.start_date?s.start_date.slice(0,16):"",end_date:s.end_date?s.end_date.slice(0,16):"",is_active:s.is_active}),c(!0)},Y=async(s,t)=>{H(t);try{const o=s.name.split(".").pop(),g=`${t==="mobile_image_url"?"mobile":"desktop"}-${Date.now()}-${Math.random().toString(36).slice(2)}.${o}`,{error:N}=await S.storage.from("promo-images").upload(g,s);if(N)throw N;const{data:{publicUrl:k}}=S.storage.from("promo-images").getPublicUrl(g);u(D=>({...D,[t]:k})),x({title:a("common.success"),description:a("admin.ads.uploadSuccess","图片上传成功")})}catch(o){x({title:a("common.error"),description:o.message,variant:"destructive"})}finally{H(null)}},Z=async()=>{const s={name:l.name,image_url:l.mobile_image_url||l.desktop_image_url||null,mobile_image_url:l.mobile_image_url||null,desktop_image_url:l.desktop_image_url||null,link_url:l.link_url||null,sort_order:l.sort_order,start_date:l.start_date||null,end_date:l.end_date||null,is_active:l.is_active};try{r?await w.mutateAsync({id:r.id,...s}):await b.mutateAsync(s),c(!1)}catch(t){console.error("Ad save error:",t)}},ee=async s=>{await I.mutateAsync({id:s.id,is_active:!s.is_active})},se=async()=>{m&&(await E.mutateAsync(m.id),F(null))},q=s=>{if(!s.is_active)return!1;const t=new Date;return!(s.start_date&&new Date(s.start_date)>t||s.end_date&&new Date(s.end_date)<t)},M=(s,t,o,h,g,N)=>{const k=l[s],D=W===s,U=`${o}/${h}`;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{className:"flex items-center gap-1.5 text-sm",children:[N,t,e.jsxs("span",{className:"text-xs text-muted-foreground font-normal ml-1",children:["(",o," × ",h,"px)"]})]}),e.jsx("input",{ref:g,type:"file",accept:"image/*",className:"hidden",onChange:Q=>{const K=Q.target.files?.[0];K&&Y(K,s),g.current&&(g.current.value="")}}),k?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-full border border-border rounded-lg overflow-hidden bg-muted/30",style:{aspectRatio:U},children:e.jsx("img",{src:k,alt:"preview",className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"absolute top-1.5 right-1.5 flex gap-1",children:[e.jsx(j,{type:"button",variant:"secondary",size:"icon",className:"h-7 w-7 bg-background/80 backdrop-blur-sm",onClick:()=>g.current?.click(),disabled:D,children:e.jsx(z,{className:"h-3.5 w-3.5"})}),e.jsx(j,{type:"button",variant:"destructive",size:"icon",className:"h-7 w-7",onClick:()=>u(Q=>({...Q,[s]:""})),children:e.jsx(de,{className:"h-3.5 w-3.5"})})]})]}):e.jsx("div",{className:"w-full border-2 border-dashed border-border rounded-lg flex flex-col items-center justify-center gap-1.5 cursor-pointer hover:border-primary/50 hover:bg-muted/30 transition-colors",style:{aspectRatio:U},onClick:()=>g.current?.click(),children:D?e.jsx("p",{className:"text-xs text-muted-foreground",children:a("common.uploading","上传中...")}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.ads.clickToUpload","点击上传")}),e.jsxs("p",{className:"text-[10px] text-muted-foreground/70",children:[a("admin.ads.recommendedSize","推荐尺寸"),": ",o," × ",h,"px"]})]})})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:a("admin.ads.title","广告管理")}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:a("admin.ads.description","管理广告内容，包括名称、链接和图片")})]}),e.jsxs(j,{onClick:V,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),a("admin.ads.create","新建广告")]})]}),e.jsx(oe,{children:e.jsx(ce,{className:"p-0",children:T?e.jsx("div",{className:"p-6 space-y-3",children:[1,2,3].map(s=>e.jsx(me,{className:"h-16 w-full"},s))}):!d||d.length===0?e.jsx("div",{className:"p-12 text-center text-muted-foreground",children:a("admin.ads.empty","暂无广告")}):e.jsxs(De,{children:[e.jsx(Ae,{children:e.jsxs(B,{children:[e.jsx(v,{className:"w-16",children:a("common.sort","排序")}),e.jsx(v,{children:a("admin.ads.image","图片")}),e.jsx(v,{children:a("admin.ads.name","名称")}),e.jsx(v,{children:a("admin.ads.link","链接")}),e.jsx(v,{children:a("admin.ads.period","有效期")}),e.jsx(v,{children:a("admin.ads.status","状态")}),e.jsx(v,{className:"text-right",children:a("common.actions","操作")})]})}),e.jsx(Ce,{children:d.map(s=>{const t=s.mobile_image_url,o=s.desktop_image_url,h=t||o||s.image_url;return e.jsxs(B,{children:[e.jsx(f,{className:"text-muted-foreground",children:s.sort_order}),e.jsx(f,{children:e.jsxs("div",{className:"flex gap-1",children:[t&&e.jsxs("div",{className:"h-10 w-10 bg-muted rounded border overflow-hidden relative",title:"Mobile",children:[e.jsx("img",{src:t,alt:"M",className:"h-full w-full object-cover"}),e.jsx(O,{className:"absolute bottom-0.5 right-0.5 h-2.5 w-2.5 text-white drop-shadow"})]}),o&&e.jsxs("div",{className:"h-10 w-16 bg-muted rounded border overflow-hidden relative",title:"Desktop",children:[e.jsx("img",{src:o,alt:"D",className:"h-full w-full object-cover"}),e.jsx(P,{className:"absolute bottom-0.5 right-0.5 h-2.5 w-2.5 text-white drop-shadow"})]}),!t&&!o&&h&&e.jsx("div",{className:"h-10 w-16 bg-muted rounded border overflow-hidden",children:e.jsx("img",{src:h,alt:s.name,className:"h-full w-full object-cover"})}),!t&&!o&&!h&&e.jsx("div",{className:"h-10 w-16 bg-muted rounded flex items-center justify-center text-[10px] text-muted-foreground",children:a("common.noImage","无图片")})]})}),e.jsx(f,{className:"font-medium",children:s.name}),e.jsx(f,{children:s.link_url?e.jsxs("a",{href:s.link_url,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline text-sm flex items-center gap-1 max-w-[200px] truncate",children:[e.jsx(ne,{className:"h-3 w-3 shrink-0"}),e.jsx("span",{className:"truncate",children:s.link_url})]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"—"})}),e.jsx(f,{className:"text-sm text-muted-foreground",children:s.start_date||s.end_date?e.jsxs("div",{className:"space-y-0.5",children:[s.start_date&&e.jsx("div",{children:L(new Date(s.start_date),"yyyy-MM-dd HH:mm")}),s.end_date&&e.jsxs("div",{children:["~ ",L(new Date(s.end_date),"yyyy-MM-dd HH:mm")]})]}):e.jsx("span",{children:a("admin.ads.permanent","长期")})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{checked:s.is_active,onCheckedChange:()=>ee(s)}),e.jsx(ue,{variant:q(s)?"default":"secondary",children:q(s)?a("admin.ads.active","投放中"):a("admin.ads.inactive","未投放")})]})}),e.jsx(f,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>J(s),children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>F(s),children:e.jsx(le,{className:"h-4 w-4 text-destructive"})})]})})]},s.id)})})]})})}),e.jsx(xe,{open:i,onOpenChange:c,children:e.jsxs(he,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(ge,{children:e.jsx(pe,{children:r?a("admin.ads.edit","编辑广告"):a("admin.ads.create","新建广告")})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(_,{children:[a("admin.ads.name","名称")," *"]}),e.jsx(y,{value:l.name,onChange:s=>u(t=>({...t,name:s.target.value}))})]}),M("mobile_image_url",a("admin.ads.mobileImage","手机端图片"),Te,Ie,X,e.jsx(O,{className:"h-4 w-4"})),M("desktop_image_url",a("admin.ads.desktopImage","桌面/平板图片"),Ee,Fe,G,e.jsx(P,{className:"h-4 w-4"})),e.jsxs("div",{children:[e.jsx(_,{children:a("admin.ads.linkUrl","跳转链接")}),e.jsx(y,{value:l.link_url,onChange:s=>u(t=>({...t,link_url:s.target.value})),placeholder:"https://..."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(_,{children:a("common.sort","排序")}),e.jsx(y,{type:"number",value:l.sort_order,onChange:s=>u(t=>({...t,sort_order:parseInt(s.target.value)||0}))})]}),e.jsx("div",{className:"flex items-end gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{checked:l.is_active,onCheckedChange:s=>u(t=>({...t,is_active:s}))}),e.jsx(_,{children:a("admin.ads.enabled","启用")})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(_,{children:a("admin.ads.startDate","开始时间")}),e.jsx(y,{type:"datetime-local",value:l.start_date,onChange:s=>u(t=>({...t,start_date:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(_,{children:a("admin.ads.endDate","结束时间")}),e.jsx(y,{type:"datetime-local",value:l.end_date,onChange:s=>u(t=>({...t,end_date:s.target.value}))})]})]})]}),e.jsxs(je,{children:[e.jsx(j,{variant:"outline",onClick:()=>c(!1),children:a("common.cancel","取消")}),e.jsx(j,{onClick:Z,disabled:!l.name||b.isPending||w.isPending,children:a("common.save","保存")})]})]})}),e.jsx(_e,{open:!!m,onOpenChange:s=>!s&&F(null),children:e.jsxs(ve,{children:[e.jsxs(fe,{children:[e.jsx(ye,{children:a("common.confirmDelete","确认删除")}),e.jsxs(be,{children:[a("admin.ads.deleteConfirm","确定要删除广告"),' "',m?.name,'" ?']})]}),e.jsxs(we,{children:[e.jsx(Ne,{children:a("common.cancel","取消")}),e.jsx(ke,{onClick:se,children:a("common.delete","删除")})]})]})})]})};export{ze as default};
//# sourceMappingURL=AdminAds-JJlCK5Ov.js.map
