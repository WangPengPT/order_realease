import{p as le,r as m,j as e,bT as ce,ak as de,M as oe,y as U,am as me,bt as xe,bd as B,b0 as ue,be as he,ao as F,bb as H,W as g,aK as ge,bc as b,b5 as fe,w as V,bG as je,b_ as pe,L as v,bD as w}from"./vendor-react-87iFmKFJ.js";import{s as c,D as Ne,c as ve,d as O,i as _e,e as W,Z as G,V as be,S as f,W as we,X as ye,Y as De,A as Ce,ad as ke,r as Ae,t as Se,v as Re,w as qe,x as $e,y as Fe,z as Le,B as y,C as j,p}from"./index-C3xfGQgV.js";import{S as D}from"./separator-ZnoPDUxo.js";import{u as Te}from"./useLocalizedContent-CFh79NZC.js";import{H as K}from"./vendor-utils-vwQGbBim.js";function He({open:C,onOpenChange:X,userId:l,userName:Ee,userRole:N}){const{t:a}=le(),{getLocalizedField:o}=Te(),[Y,L]=m.useState(!0),[t,T]=m.useState(null),[Z,J]=m.useState(null),[r,Q]=m.useState({favoriteRestaurants:0,favoriteActivities:0,comments:0,ratings:0,addresses:0,restaurants:0}),[k,A]=m.useState(null),[u,x]=m.useState([]),[I,E]=m.useState(!1),[P,z]=m.useState(!1);m.useState(!1),m.useEffect(()=>{C&&l&&ee()},[C,l]);const ee=async()=>{L(!0);try{const{data:s,error:i}=await c.from("profiles").select("*").eq("id",l).maybeSingle();if(i)throw i;T(s);try{const{data:n}=await c.functions.invoke("get-user-emails",{body:{userIds:[l]}});n?.emails?.[l]&&J(n.emails[l])}catch(n){console.error("Error fetching email:",n)}const[d,_,S,R,q,$]=await Promise.all([c.from("favorites").select("id",{count:"exact",head:!0}).eq("user_id",l),c.from("subscriptions").select("id",{count:"exact",head:!0}).eq("user_id",l),c.from("comments").select("id",{count:"exact",head:!0}).eq("user_id",l),c.from("ratings").select("id",{count:"exact",head:!0}).eq("user_id",l),c.from("user_addresses").select("id",{count:"exact",head:!0}).eq("user_id",l),c.from("merchant_restaurants").select("id",{count:"exact",head:!0}).eq("user_id",l)]);Q({favoriteRestaurants:d.count||0,favoriteActivities:_.count||0,comments:S.count||0,ratings:R.count||0,addresses:q.count||0,restaurants:$.count||0})}catch(s){console.error("Error fetching user profile:",s)}finally{L(!1)}},se=async()=>{z(!0);try{const{error:s}=await c.from("profiles").update({avatar_url:null}).eq("id",l);if(s)throw s;T(i=>i&&{...i,avatar_url:null}),V.success(a("admin.avatarCleared","头像已清除"))}catch(s){console.error("Clear avatar error:",s),V.error(a("admin.avatarClearFailed","清除头像失败"))}finally{z(!1)}},h=async s=>{if(s){E(!0),A(s);try{switch(s){case"restaurants":{const{data:i}=await c.from("favorites").select("created_at, restaurants(id, name, name_en, name_pt, image_url, rating, type, type_en, type_pt)").eq("user_id",l).order("created_at",{ascending:!1});x(i?.map(d=>({...d.restaurants,favorited_at:d.created_at}))||[]);break}case"activities":{const{data:i}=await c.from("subscriptions").select("created_at, activities(id, title_zh, title_en, title_pt, image_url, start_date, end_date)").eq("user_id",l).order("created_at",{ascending:!1});x(i?.map(d=>({...d.activities,subscribed_at:d.created_at}))||[]);break}case"comments":{const{data:i}=await c.from("comments").select("id, content, target_type, target_id, rating_value, created_at").eq("user_id",l).order("created_at",{ascending:!1});if(i){const d=i.filter(n=>n.target_type==="restaurant").map(n=>n.target_id),_=i.filter(n=>n.target_type==="activity").map(n=>n.target_id),[S,R]=await Promise.all([d.length>0?c.from("restaurants").select("id, name, name_en, name_pt").in("id",d):{data:[]},_.length>0?c.from("activities").select("id, title_zh, title_en, title_pt").in("id",_):{data:[]}]),q=Object.fromEntries((S.data||[]).map(n=>[n.id,n])),$=Object.fromEntries((R.data||[]).map(n=>[n.id,n]));x(i.map(n=>({...n,target:n.target_type==="restaurant"?q[n.target_id]:$[n.target_id]})))}break}case"ratings":{const{data:i}=await c.from("ratings").select("id, rating_value, price_range, created_at, restaurants(id, name, name_en, name_pt)").eq("user_id",l).order("created_at",{ascending:!1});x(i?.map(d=>({...d,restaurant:d.restaurants}))||[]);break}case"addresses":{const{data:i}=await c.from("user_addresses").select("*").eq("user_id",l).order("is_default",{ascending:!1});x(i||[]);break}case"managedRestaurants":{const{data:i}=await c.from("merchant_restaurants").select("created_at, restaurants(id, name, name_en, name_pt, image_url, address)").eq("user_id",l).order("created_at",{ascending:!1});x(i?.map(d=>({...d.restaurants,assigned_at:d.created_at}))||[]);break}}}catch(i){console.error("Error fetching detail data:",i),x([])}finally{E(!1)}}},ae=s=>{switch(s){case"restaurants":return a("admin.restaurantFavorites");case"activities":return a("admin.activityFavorites");case"comments":return a("admin.commentsCount");case"ratings":return a("admin.ratingsCount");case"addresses":return a("admin.addressesCount");case"managedRestaurants":return a("admin.managedRestaurants");default:return""}},te=s=>{switch(s){case"admin":return"bg-primary text-primary-foreground";case"supervisor":return"bg-blue-500 text-white";case"merchant":return"bg-emerald-500 text-white";default:return"bg-muted text-muted-foreground"}},re=s=>{switch(s){case"admin":return e.jsx(F,{className:"h-3.5 w-3.5"});case"supervisor":return e.jsx(F,{className:"h-3.5 w-3.5"});case"merchant":return e.jsx(pe,{className:"h-3.5 w-3.5"});default:return e.jsx(je,{className:"h-3.5 w-3.5"})}},M=s=>s?new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}):"-",ie=s=>{s||(A(null),x([])),X(s)},ne=()=>{if(I)return e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(f,{className:"h-16 w-full"},s))});if(u.length===0)return e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("common.noDataFound")});switch(k){case"restaurants":return e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs(v,{to:`/restaurant/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsx("img",{src:s.image_url||"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=100&q=80",alt:o(s,"name"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:o(s,"type")})]}),s.rating&&e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(b,{className:"h-3.5 w-3.5 fill-yellow-500 text-yellow-500"}),s.rating.toFixed(1)]}),e.jsx(w,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"activities":return e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs(v,{to:`/activity/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:o(s,"title"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsx(w,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"comments":return e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs(v,{to:`/${s.target_type}/${s.target_id}`,target:"_blank",className:"block p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{variant:"outline",className:"text-xs",children:s.target_type==="restaurant"?a("common.restaurant"):a("common.activity")}),e.jsx("span",{className:"text-sm font-medium truncate",children:s.target&&(s.target_type==="restaurant"?o(s.target,"name"):o(s.target,"title"))})]}),s.rating_value&&e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(b,{className:"h-3.5 w-3.5 fill-yellow-500 text-yellow-500"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:K(new Date(s.created_at),{addSuffix:!0})})]},s.id))});case"ratings":return e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs(v,{to:`/restaurant/${s.restaurant?.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s.restaurant,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:K(new Date(s.created_at),{addSuffix:!0})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(b,{className:"h-4 w-4 fill-yellow-500 text-yellow-500"}),e.jsx("span",{className:"font-semibold",children:s.rating_value})]}),e.jsx(w,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"addresses":return e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium",children:s.label}),s.is_default&&e.jsx(y,{variant:"secondary",className:"text-xs",children:a("profile.defaultAddress")})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.street,", ",s.district&&`${s.district}, `,s.city]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.postal_code&&`${s.postal_code}, `,s.country]}),s.phone&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.phone_code," ",s.phone]})]},s.id))});case"managedRestaurants":return e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs(v,{to:`/restaurant/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:o(s,"name"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.address})]}),e.jsx(w,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});default:return null}};return e.jsx(Ne,{open:C,onOpenChange:ie,children:e.jsx(ve,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:k?e.jsxs(e.Fragment,{children:[e.jsx(O,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>{A(null),x([])},children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx(W,{children:ae(k)}),e.jsxs(G,{children:[t?.display_name," - ",u.length," ",a("common.items")]})]})]})}),e.jsx(be,{className:"max-h-[60vh] pr-4",children:ne()})]}):e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:[e.jsx(W,{children:a("admin.viewProfile")}),e.jsx(G,{children:a("admin.userProfileDetails")})]}),Y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(f,{className:"h-16 w-16 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-5 w-32"}),e.jsx(f,{className:"h-4 w-24"})]})]}),e.jsx(f,{className:"h-20 w-full"}),e.jsx(f,{className:"h-32 w-full"})]}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[e.jsxs(we,{className:"h-16 w-16 border-2 border-primary/20",children:[e.jsx(ye,{src:t.avatar_url||"",alt:t.display_name}),e.jsx(De,{className:"text-xl bg-primary/10 text-primary",children:t.display_name.charAt(0).toUpperCase()})]}),t.avatar_url&&e.jsxs(Ce,{children:[e.jsx(ke,{asChild:!0,children:e.jsxs("button",{className:"text-xs text-destructive hover:text-destructive/80 flex items-center gap-0.5 transition-colors",title:a("admin.clearAvatar","清除头像"),children:[e.jsx(de,{className:"h-3 w-3"}),a("admin.clearAvatar","清除头像")]})}),e.jsxs(Ae,{children:[e.jsxs(Se,{children:[e.jsx(Re,{children:a("admin.clearAvatarTitle","清除用户头像")}),e.jsx(qe,{children:a("admin.clearAvatarDesc","确定要清除该用户的头像吗？用户将显示默认头像，此操作不可撤销。")})]}),e.jsxs($e,{children:[e.jsx(Fe,{children:a("common.cancel","取消")}),e.jsx(Le,{onClick:se,disabled:P,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:P?a("common.processing","处理中…"):a("admin.clearAvatar","清除头像")})]})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-xl font-semibold",children:t.display_name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(y,{className:`${te(N)} gap-1`,children:[re(N),e.jsx("span",{className:"capitalize",children:N})]}),t.is_banned&&e.jsx(y,{variant:"destructive",children:a("admin.banned")})]})]})]}),e.jsx(D,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.contactInfo")}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:Z||"-"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(U,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:t.phone||"-"})]})]})]}),(t.full_name||t.nif||t.contact||t.address)&&e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.applicationInfo")}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[t.full_name&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.fullName")}),e.jsx("p",{children:t.full_name})]})]}),t.nif&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.nif")}),e.jsx("p",{children:t.nif})]})]}),t.contact&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(U,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.contactMethod")}),e.jsx("p",{children:t.contact})]})]}),t.address&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.address")}),e.jsx("p",{children:t.address})]})]})]})]})]}),e.jsx(D,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.accountInfo")}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.registrationTime")}),e.jsx("p",{children:M(t.created_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.languagePreference")}),e.jsx("p",{children:t.language_preference||"en"})]})]})]}),t.activity_terms_agreed&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-emerald-600",children:[e.jsx(F,{className:"h-4 w-4"}),e.jsxs("span",{children:[a("admin.agreedActivityTerms")," (",M(t.activity_terms_agreed_at),")"]})]}),t.is_banned&&t.ban_reason&&e.jsxs("div",{className:"p-3 bg-destructive/10 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-destructive font-medium",children:[a("admin.banReason"),":"]}),e.jsx("p",{className:"text-sm text-destructive/80",children:t.ban_reason})]})]}),e.jsx(D,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.userStats")}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(j,{className:`bg-muted/30 transition-colors ${r.favoriteRestaurants>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.favoriteRestaurants>0&&h("restaurants"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(H,{className:"h-4 w-4 mx-auto mb-1 text-red-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.favoriteRestaurants}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.restaurantFavorites")}),r.favoriteRestaurants>0&&e.jsx(g,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(j,{className:`bg-muted/30 transition-colors ${r.favoriteActivities>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.favoriteActivities>0&&h("activities"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(H,{className:"h-4 w-4 mx-auto mb-1 text-primary"}),e.jsx("p",{className:"text-lg font-semibold",children:r.favoriteActivities}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.activityFavorites")}),r.favoriteActivities>0&&e.jsx(g,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(j,{className:`bg-muted/30 transition-colors ${r.comments>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.comments>0&&h("comments"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(ge,{className:"h-4 w-4 mx-auto mb-1 text-blue-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.comments}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.commentsCount")}),r.comments>0&&e.jsx(g,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(j,{className:`bg-muted/30 transition-colors ${r.ratings>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.ratings>0&&h("ratings"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(b,{className:"h-4 w-4 mx-auto mb-1 text-yellow-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.ratings}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.ratingsCount")}),r.ratings>0&&e.jsx(g,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(j,{className:`bg-muted/30 transition-colors ${r.addresses>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.addresses>0&&h("addresses"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(B,{className:"h-4 w-4 mx-auto mb-1 text-emerald-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.addresses}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.addressesCount")}),r.addresses>0&&e.jsx(g,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),(N==="merchant"||N==="supervisor")&&e.jsx(j,{className:`bg-muted/30 transition-colors ${r.restaurants>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.restaurants>0&&h("managedRestaurants"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(fe,{className:"h-4 w-4 mx-auto mb-1 text-orange-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.restaurants}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.managedRestaurants")}),r.restaurants>0&&e.jsx(g,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})})]})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("common.noDataFound")})]})})})}export{He as U};
//# sourceMappingURL=UserProfileDialog-Ch2F2dcx.js.map
