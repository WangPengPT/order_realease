import{p as xe,r,ci as me,u as Ne,j as e,bT as ke,aW as Se,am as ve,aM as fe,cj as Ce,ck as Ae,aN as Re}from"./vendor-react-DImbKuZP.js";import{u as we,b as De,a4 as Ee,p as ae,q as ge,Y as Ie,J as Le,A as Oe,f as Te,h as We,i as Me,j as ze,k as Be,l as Pe,m as Xe,o as Ve}from"./index-_G3CuCzp.js";import{u as $e}from"./useAIChatHistory-BHmHvjAH.js";import{L as qe}from"./LocationPermissionDialog-BDLW4gbZ.js";import{E as He}from"./ExternalLinkConfirmDialog-C_70Xa0h.js";const re="https://tzdgqhwyzsxkxnncgzap.supabase.co",z="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",Je=["最近","附近","离我","距离","远近","近的","周边","周围","最近的","附近的","nearest","closest","nearby","near me","close to me","distance","around me","mais perto","próximo","perto de mim","distância","mais próximo"],Ue=()=>{const b="xiaoxiong_anonymous_user_id";let A=localStorage.getItem(b);return A||(A=`anon_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(b,A)),A},Qe=(b="ask-xiaoxiong")=>{const{i18n:A}=xe(),{user:D}=we(),{loadMessages:B,saveMessage:Z,clearHistory:G,isLoadingHistory:oe,historyLoaded:ie}=$e("xiaoxiong"),[X,q]=r.useState(""),[V,k]=r.useState([]),[H,J]=r.useState(!1),[E,Q]=r.useState(null),[le,U]=r.useState(!1),[j,I]=r.useState(null),R=r.useRef(null),ee=r.useRef(!1);r.useEffect(()=>{!D?.id||ee.current||(ee.current=!0,B().then(s=>{s.length>0&&k(s.map((g,u)=>({id:`history_${u}`,role:g.role,content:g.content})))}))},[D?.id,B]);const te=r.useCallback(()=>D?.id?D.id:Ue(),[D?.id]),se=r.useCallback(s=>{const g=s.toLowerCase();return Je.some(u=>g.includes(u))},[]),W=async(s,g)=>{const u=await fetch(`${re}/functions/v1/ask-xiaoxiong`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`,apikey:z},body:JSON.stringify({text:s.content,stream:!0,lat:E?.lat,lng:E?.lng}),signal:R.current?.signal});if(!u.ok)throw new Error(`Request failed with status: ${u.status}`);if(!u.body)throw new Error("No response body");const i=u.body.getReader(),f=new TextDecoder;let p="";for(;;){const{done:m,value:o}=await i.read();if(m)break;const h=f.decode(o,{stream:!0});p+=h;let l=p;l.startsWith('"')&&(l=l.slice(1)),l.endsWith('"')&&(l=l.slice(0,-1)),l=l.replace(/\\n/g,`
`),k(w=>w.map(N=>N.id===g?{...N,content:l}:N))}let c=p;c.startsWith('"')&&(c=c.slice(1)),c.endsWith('"')&&(c=c.slice(0,-1)),c=c.replace(/\\n/g,`
`),k(m=>m.map(o=>o.id===g?{...o,content:c,isStreaming:!1}:o))},ne=async(s,g)=>{const u=te(),i=await fetch(`${re}/functions/v1/xiaoxiong-agent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`,apikey:z},body:JSON.stringify({message:s.content,userId:u}),signal:R.current?.signal});if(!i.ok)throw new Error(`Request failed with status: ${i.status}`);if(!i.body)throw new Error("No response body");const f=i.body.getReader(),p=new TextDecoder;let c="";for(;;){const{done:m,value:o}=await f.read();if(m)break;const h=p.decode(o,{stream:!0});c+=h,me.flushSync(()=>{k(l=>l.map(w=>w.id===g?{...w,content:c}:w))}),await new Promise(l=>requestAnimationFrame(l))}k(m=>m.map(o=>o.id===g?{...o,isStreaming:!1}:o))},$=async(s,g,u)=>{const i=await fetch(`${re}/functions/v1/lovable-chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`,apikey:z},body:JSON.stringify({message:s.content,lat:E?.lat,lng:E?.lng,language:A.language,isFirstMessage:u}),signal:R.current?.signal});if(!i.ok){const o=await i.json().catch(()=>({}));throw new Error(o.error||`Request failed with status: ${i.status}`)}if(!i.body)throw new Error("No response body");const f=i.body.getReader(),p=new TextDecoder;let c="",m="";for(;;){const{done:o,value:h}=await f.read();if(o)break;m+=p.decode(h,{stream:!0});let l;for(;(l=m.indexOf(`
`))!==-1;){let w=m.slice(0,l);if(m=m.slice(l+1),w.endsWith("\r")&&(w=w.slice(0,-1)),w.startsWith(":")||w.trim()===""||!w.startsWith("data: "))continue;const N=w.slice(6).trim();if(N==="[DONE]")break;try{const Y=JSON.parse(N).choices?.[0]?.delta?.content;Y&&(c+=Y,me.flushSync(()=>{k(O=>O.map(T=>T.id===g?{...T,content:c}:T))}),await new Promise(O=>requestAnimationFrame(O)))}catch{}}}k(o=>o.map(h=>h.id===g?{...h,isStreaming:!1}:h))},L=async(s,g,u)=>{const i=V.filter(h=>h.content&&!h.isStreaming).map(h=>({role:h.role,content:h.content}));i.push({role:"user",content:s.content});const f=await fetch(`${re}/functions/v1/xiaoxiong-community`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`,apikey:z},body:JSON.stringify({messages:i,includeContext:!0,isFirstMessage:u}),signal:R.current?.signal});if(!f.ok){const h=await f.json().catch(()=>({}));throw new Error(h.error||`Request failed with status: ${f.status}`)}if(!f.body)throw new Error("No response body");const p=f.body.getReader(),c=new TextDecoder;let m="",o="";for(;;){const{done:h,value:l}=await p.read();if(h)break;o+=c.decode(l,{stream:!0});let w;for(;(w=o.indexOf(`
`))!==-1;){let N=o.slice(0,w);if(o=o.slice(w+1),N.endsWith("\r")&&(N=N.slice(0,-1)),N.startsWith(":")||N.trim()===""||!N.startsWith("data: "))continue;const S=N.slice(6).trim();if(S==="[DONE]")break;try{const O=JSON.parse(S).choices?.[0]?.delta?.content;O&&(m+=O,me.flushSync(()=>{k(T=>T.map(K=>K.id===g?{...K,content:m}:K))}),await new Promise(T=>requestAnimationFrame(T)))}catch{}}}k(h=>h.map(l=>l.id===g?{...l,isStreaming:!1}:l))},M=r.useCallback(async s=>{const g=V.length===0,u={id:Date.now().toString(),role:"user",content:s},i=(Date.now()+1).toString(),f={id:i,role:"assistant",content:"",isStreaming:!0};k(p=>[...p,u,f]),q(""),J(!0),Z("user",s),R.current&&R.current.abort(),R.current=new AbortController;try{b==="xiaoxiong-community"?await L(u,i,g):b==="lovable-ai"?await $(u,i,g):b==="xiaoxiong-agent"?await ne(u,i):await W(u,i)}catch(p){if(p instanceof Error&&p.name==="AbortError"){console.log("Request aborted");return}console.error("Ask API error:",p);const c=A.language==="zh"?"抱歉，暂时无法获取结果，请稀后再试":A.language==="pt"?"Desculpe, não foi possível obter resultados. Tente novamente mais tarde.":"Sorry, unable to get results. Please try again later.";k(m=>m.map(o=>o.id===i?{...o,content:c,isStreaming:!1}:o))}finally{J(!1),k(p=>{const c=p.find(m=>m.id===i);return c?.content&&Z("assistant",c.content),p})}},[b,E,A.language,te,V.length,Z]),ce=r.useCallback(()=>{U(!1),navigator.geolocation?.getCurrentPosition(s=>{Q({lat:s.coords.latitude,lng:s.coords.longitude}),j&&setTimeout(()=>{M(j),I(null)},100)},s=>{console.log("Location permission denied:",s.message),j&&(M(j),I(null))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},[j,M]),P=r.useCallback(async()=>{if(!X.trim()||H)return;const s=X.trim();if(!E&&se(s)){I(s),U(!0),q("");return}await M(s)},[X,H,E,se,M]),de=r.useCallback(s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),P())},[P]),ue=r.useCallback(()=>{R.current&&R.current.abort()},[]),_=r.useCallback(()=>{navigator.geolocation?.getCurrentPosition(s=>{Q({lat:s.coords.latitude,lng:s.coords.longitude})},s=>{console.log("Unable to get user location:",s.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5})},[]),F=r.useCallback(async()=>{await G(),k([])},[G]);return{input:X,setInput:q,messages:V,isLoading:H,isLoadingHistory:oe,showLocationDialog:le,setShowLocationDialog:U,pendingMessage:j,setPendingMessage:I,handleSubmit:P,handleKeyDown:de,handleLocationConfirm:ce,processMessage:M,abortRequest:ue,requestLocation:_,clearChat:F}},_e=()=>!!(window.webkit?.messageHandlers?.VoiceBridge||window.VoiceBridge),pe={start:()=>{const b=JSON.stringify({action:"start"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(b):window.VoiceBridge&&window.VoiceBridge.postMessage(b)},stop:()=>{const b=JSON.stringify({action:"stop"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(b):window.VoiceBridge&&window.VoiceBridge.postMessage(b)}},et=({messages:b,input:A,setInput:D,isLoading:B,isLoadingHistory:Z,showLocationDialog:G,setShowLocationDialog:oe,pendingMessage:ie,handleSubmit:X,handleKeyDown:q,handleLocationConfirm:V,processMessage:k,setPendingMessage:H,onClose:J,onClearChat:E,showBackButton:Q=!1,showHeader:le=!0,className:U})=>{const{i18n:j,t:I}=xe(),R=Ne(),{user:ee}=we(),{settings:te}=De(),{data:se}=Ee(),W=te?.logo_url,ne=se?.avatar_url,[$,L]=r.useState(!1),[M,ce]=r.useState(!1),[P,de]=r.useState(!1),[ue,_]=r.useState(!1),[F,s]=r.useState(null),[g,u]=r.useState(!1),i=r.useRef(null),f=r.useRef(null),p=r.useRef(null);r.useEffect(()=>{const t=window.SpeechRecognition||window.webkitSpeechRecognition;return ce(!!t),de(_e()),window.onSpeechResult=d=>{D(d),L(!1)},()=>{window.onSpeechResult=void 0}},[D]),r.useEffect(()=>{p.current?.scrollIntoView({behavior:"smooth"})},[b]),r.useEffect(()=>()=>{f.current&&f.current.stop()},[]);const c=()=>M||P,m=()=>{if(P){pe.start(),L(!0);return}const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t)return;f.current&&f.current.stop();const d=new t;f.current=d;const n={zh:"zh-CN",en:"en-US",pt:"pt-BR"};d.lang=n[j.language]||"zh-CN",d.continuous=!1,d.interimResults=!0,d.onstart=()=>L(!0),d.onresult=y=>{const a=Array.from(y.results).map(x=>x[0].transcript).join("");D(a)},d.onerror=()=>L(!1),d.onend=()=>L(!1),d.start()},o=()=>{if(P){pe.stop(),L(!1);return}f.current&&(f.current.stop(),L(!1))},h=()=>{$?o():m()},l=t=>{J?.(),R(t)},w=t=>{s(t),_(!0)},N=()=>{F&&Ve(F),_(!1),s(null)},S=t=>{const d=/\[([^\]]+)\]\(([^)]+)\)/g,n=[];let y=0,a,x=0;for(;(a=d.exec(t))!==null;){a.index>y&&n.push(e.jsx("span",{children:t.slice(y,a.index)},x++));const C=a[1],v=a[2];if(v.startsWith("/"))n.push(e.jsx("button",{onClick:()=>l(v),className:"text-primary hover:underline font-medium cursor-pointer",children:C},x++));else if(v.startsWith("!external:")){const he=v.slice(10);n.push(e.jsx("button",{onClick:()=>w(he),className:"text-primary hover:underline font-medium cursor-pointer",children:C},x++))}else v.startsWith("http://")||v.startsWith("https://")?n.push(e.jsx("button",{onClick:()=>w(v),className:"text-primary hover:underline font-medium cursor-pointer",children:C},x++)):n.push(e.jsx("a",{href:v,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline font-medium",children:C},x++));y=a.index+a[0].length}return y<t.length&&n.push(e.jsx("span",{children:t.slice(y)},x++)),n.length>0?n:[e.jsx("span",{children:t},"0")]},Y=t=>t.replace(/\*\*(.*?)\*\*/g,"$1"),O=(t,d=20)=>t.length<=d?t:t.slice(0,d)+"...",T=(t,d)=>{const n=x=>x.split("|").slice(1,-1).map(C=>Y(C.trim())),y=n(t[0]),a=t.slice(2).map(n);return e.jsx("div",{className:"overflow-x-auto my-2 max-w-full",children:e.jsxs("table",{className:"w-full text-xs border border-border rounded-md overflow-hidden table-fixed",children:[e.jsx("thead",{className:"bg-muted/60",children:e.jsx("tr",{children:y.map((x,C)=>e.jsx("th",{className:"px-2 py-2 text-left font-semibold border-b border-border truncate max-w-[100px]",title:x,children:S(O(x,15))},C))})}),e.jsx("tbody",{children:a.map((x,C)=>e.jsx("tr",{className:"border-b border-border last:border-0 hover:bg-muted/30 transition-colors",children:x.map((v,he)=>e.jsx("td",{className:"px-2 py-2 truncate max-w-[100px]",title:v,children:S(O(v,18))},he))},C))})]})},d)},K=t=>{const d=t.split(`
`),n=[];let y=0;for(;y<d.length;){const a=d[y];if(a.trim().startsWith("|")&&a.split("|").length>2){const x=[];for(;y<d.length&&d[y].trim().startsWith("|");)x.push(d[y]),y++;x.length>=2&&n.push(T(x,n.length));continue}if(a.startsWith("### "))n.push(e.jsx("h3",{className:"text-base font-semibold mt-3 mb-1",children:S(a.slice(4))},n.length));else if(a.startsWith("## "))n.push(e.jsx("h2",{className:"text-lg font-bold mt-4 mb-2",children:S(a.slice(3))},n.length));else if(a.startsWith("# "))n.push(e.jsx("h1",{className:"text-xl font-bold mt-4 mb-2",children:S(a.slice(2))},n.length));else if(a.includes("**")){const x=a.split(/\*\*(.*?)\*\*/g);n.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:x.map((C,v)=>v%2===1?e.jsx("strong",{className:"font-semibold",children:S(C)},v):S(C))},n.length))}else a.startsWith("- ")||a.startsWith("* ")?n.push(e.jsx("li",{className:"ml-4 mb-0.5 list-disc",children:S(a.slice(2))},n.length)):/^\d+\.\s/.test(a)?n.push(e.jsx("li",{className:"ml-4 mb-0.5 list-decimal",children:S(a.replace(/^\d+\.\s/,""))},n.length)):a.match(/^[-*_]{3,}$/)?n.push(e.jsx("hr",{className:"my-3 border-border"},n.length)):a.trim()===""?n.push(e.jsx("div",{className:"h-1"},n.length)):n.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:S(a)},n.length));y++}return n},be=()=>j.language==="zh"?"小熊AI助手":j.language==="pt"?"Assistente IA Xiaoxiong":"Xiaoxiong AI Assistant",je=()=>j.language==="zh"?"告诉小熊，你想吃什么...":j.language==="pt"?"Diga ao Xiaoxiong o que você quer comer...":"Tell Xiaoxiong what you want to eat...",ye=()=>j.language==="zh"?"你好，我是小熊，我来帮你推荐餐厅；比如：「我附近的寿司餐厅」":j.language==="pt"?"Olá, eu sou o Xiaoxiong, vou te ajudar a encontrar restaurantes; por exemplo: 「restaurantes de sushi perto de mim」":`Hi, I'm Xiaoxiong, I'll help you find restaurants; for example: "sushi restaurants near me"`;return e.jsxs("div",{className:ae("flex flex-col h-full bg-background overflow-hidden",U),children:[le&&e.jsxs("div",{className:"px-4 py-3 shrink-0 border-b flex items-center gap-2 bg-background sticky top-0 z-10",children:[Q&&e.jsx(ge,{variant:"ghost",size:"icon",onClick:J,className:"shrink-0",children:e.jsx(ke,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[W&&e.jsx("img",{src:W,alt:"Logo",className:"w-8 h-8 rounded-full object-cover"}),e.jsx("h1",{className:"text-base font-semibold",children:be()})]}),b.length>0&&ee?.id&&E&&e.jsx("button",{onClick:()=>u(!0),className:"p-1 hover:bg-muted rounded-md text-muted-foreground hover:text-primary transition-colors",title:I("aiRecipe.newChat","新对话"),children:e.jsx(Se,{className:"h-4 w-4"})})]}),e.jsx(Ie,{className:"flex-1 min-h-0 overflow-auto",ref:i,children:e.jsxs("div",{className:"p-4 space-y-4",children:[b.length===0&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:W&&e.jsx("img",{src:W,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:"flex-1 bg-muted rounded-lg px-3 py-2 text-sm",children:ye()})]}),b.map(t=>e.jsxs("div",{className:ae("flex gap-3",t.role==="user"&&"flex-row-reverse"),children:[t.role==="user"?e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:ne?e.jsx("img",{src:ne,alt:"User",className:"w-full h-full object-cover"}):e.jsx(ve,{className:"h-4 w-4"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:W&&e.jsx("img",{src:W,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:ae("flex-1 max-w-[85%] rounded-lg px-3 py-2 text-sm bg-muted"),children:t.role==="assistant"?e.jsxs(e.Fragment,{children:[t.content?e.jsx("div",{className:"prose-sm",children:K(t.content)}):e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(fe,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:j.language==="zh"?"思考中...":j.language==="pt"?"Pensando...":"Thinking..."})]}),t.isStreaming&&t.content&&e.jsx("span",{className:"inline-block w-1.5 h-4 bg-primary/50 animate-pulse ml-0.5 align-middle"})]}):t.content})]},t.id)),e.jsx("div",{ref:p})]})}),e.jsx("div",{className:"px-2 py-1.5 pb-[max(1.5rem,calc(env(safe-area-inset-bottom)+1rem))] md:pb-4 shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 rounded-full backdrop-blur-md border border-border/50 bg-muted/80 dark:bg-muted/60",children:[c()&&e.jsx(ge,{variant:"ghost",size:"icon",onClick:h,disabled:B,className:ae("bg-transparent hover:bg-transparent",$&&"text-destructive"),children:$?e.jsx(Ce,{className:"h-4 w-4"}):e.jsx(Ae,{className:"h-4 w-4"})}),e.jsx(Le,{value:A,onChange:t=>D(t.target.value),onKeyDown:q,placeholder:$?j.language==="zh"?"正在聆听...":"Listening...":je(),disabled:B,className:"flex-1 bg-transparent border-0 shadow-none focus-visible:ring-0 focus-visible:ring-offset-0"}),e.jsx(ge,{onClick:X,disabled:!A.trim()||B,size:"icon",variant:"ghost",className:"bg-transparent hover:bg-white/50 rounded-full",children:B?e.jsx(fe,{className:"h-4 w-4 animate-spin"}):e.jsx(Re,{className:"h-4 w-4"})})]})}),e.jsx(qe,{open:G,onOpenChange:t=>{oe(t),!t&&ie&&(k(ie),H(null))},onConfirm:V}),e.jsx(He,{open:ue,onOpenChange:_,onConfirm:N,url:F||void 0}),e.jsx(Oe,{open:g,onOpenChange:u,children:e.jsxs(Te,{children:[e.jsxs(We,{children:[e.jsx(Me,{children:I("aiRecipe.newChat","新对话")}),e.jsx(ze,{children:I("aiRecipe.newChatConfirm","开始新对话将清除当前聊天记录，确定吗？")})]}),e.jsxs(Be,{children:[e.jsx(Pe,{children:I("common.cancel","取消")}),e.jsx(Xe,{onClick:async()=>{await E?.()},children:I("common.confirm","确定")})]})]})})]})};export{et as X,Qe as u};
//# sourceMappingURL=XiaoxiongChatContent-BJj2c5pi.js.map
