{"version":3,"file":"useShopItems-D4m7rp_f.js","sources":["../../src/hooks/useShopItems.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { useTranslation } from \"react-i18next\";\r\n\r\nexport interface ShopItem {\r\n  id: string;\r\n  item_type: 'coupon' | 'physical' | 'badge';\r\n  coupon_template_id: string | null;\r\n  name_zh: string;\r\n  name_en: string;\r\n  name_pt: string;\r\n  description_zh: string | null;\r\n  description_en: string | null;\r\n  description_pt: string | null;\r\n  image_url: string | null;\r\n  points_cost: number;\r\n  stock: number | null;\r\n  per_user_limit: number;\r\n  limit_refresh_period: 'daily' | 'weekly' | 'monthly' | 'none';\r\n  is_active: boolean;\r\n  sort_order: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  coupon_templates?: {\r\n    id: string;\r\n    title_zh: string;\r\n    title_en: string;\r\n    title_pt: string;\r\n  } | null;\r\n}\r\n\r\nexport interface ShopPurchase {\r\n  id: string;\r\n  user_id: string;\r\n  shop_item_id: string;\r\n  points_spent: number;\r\n  user_coupon_id: string | null;\r\n  shipping_address_id: string | null;\r\n  status: 'completed' | 'pending_delivery' | 'delivered' | 'cancelled';\r\n  created_at: string;\r\n  shop_items?: ShopItem;\r\n  profiles?: {\r\n    id: string;\r\n    display_name: string;\r\n    avatar_url: string | null;\r\n  };\r\n  user_addresses?: {\r\n    id: string;\r\n    label: string;\r\n    street: string;\r\n    city: string;\r\n    country: string;\r\n    phone: string | null;\r\n  } | null;\r\n}\r\n\r\nexport interface UserPurchaseLimit {\r\n  id: string;\r\n  user_id: string;\r\n  shop_item_id: string;\r\n  purchase_count: number;\r\n  period_start: string;\r\n}\r\n\r\n// Hook to get all active shop items (for users)\r\nexport const useShopItems = () => {\r\n  return useQuery({\r\n    queryKey: ['shop-items'],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from('shop_items')\r\n        .select(`\r\n          *,\r\n          coupon_templates (\r\n            id,\r\n            title_zh,\r\n            title_en,\r\n            title_pt\r\n          )\r\n        `)\r\n        .eq('is_active', true)\r\n        .order('sort_order', { ascending: true });\r\n      \r\n      if (error) throw error;\r\n      return data as ShopItem[];\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to get all shop items (for admin)\r\nexport const useAllShopItems = () => {\r\n  return useQuery({\r\n    queryKey: ['all-shop-items'],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from('shop_items')\r\n        .select(`\r\n          *,\r\n          coupon_templates (\r\n            id,\r\n            title_zh,\r\n            title_en,\r\n            title_pt\r\n          )\r\n        `)\r\n        .order('sort_order', { ascending: true });\r\n      \r\n      if (error) throw error;\r\n      return data as ShopItem[];\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to get user's purchase limits for items\r\nexport const useUserPurchaseLimits = () => {\r\n  const { user } = useAuth();\r\n  \r\n  return useQuery({\r\n    queryKey: ['user-purchase-limits', user?.id],\r\n    queryFn: async () => {\r\n      if (!user?.id) return [];\r\n      \r\n      const { data, error } = await supabase\r\n        .from('user_purchase_limits')\r\n        .select('*')\r\n        .eq('user_id', user.id);\r\n      \r\n      if (error) throw error;\r\n      return data as UserPurchaseLimit[];\r\n    },\r\n    enabled: !!user?.id,\r\n  });\r\n};\r\n\r\n// Hook to get user's purchases\r\nexport const useUserPurchases = () => {\r\n  const { user } = useAuth();\r\n  \r\n  return useQuery({\r\n    queryKey: ['user-purchases', user?.id],\r\n    queryFn: async () => {\r\n      if (!user?.id) return [];\r\n      \r\n      const { data, error } = await supabase\r\n        .from('shop_purchases')\r\n        .select(`\r\n          *,\r\n          shop_items (*)\r\n        `)\r\n        .eq('user_id', user.id)\r\n        .order('created_at', { ascending: false });\r\n      \r\n      if (error) throw error;\r\n      return data as ShopPurchase[];\r\n    },\r\n    enabled: !!user?.id,\r\n  });\r\n};\r\n\r\n// Hook to get all purchases (admin)\r\nexport const useAllPurchases = () => {\r\n  return useQuery({\r\n    queryKey: ['all-purchases'],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from('shop_purchases')\r\n        .select(`\r\n          *,\r\n          shop_items (*),\r\n          user_addresses (\r\n            id,\r\n            label,\r\n            street,\r\n            city,\r\n            country,\r\n            phone\r\n          )\r\n        `)\r\n        .order('created_at', { ascending: false })\r\n        .limit(500);\r\n      \r\n      if (error) throw error;\r\n      \r\n      // Fetch profiles separately\r\n      const userIds = [...new Set(data.map(p => p.user_id))];\r\n      const { data: profiles } = await supabase\r\n        .from('profiles')\r\n        .select('id, display_name, avatar_url')\r\n        .in('id', userIds);\r\n      \r\n      const profileMap = new Map(profiles?.map(p => [p.id, p]) || []);\r\n      \r\n      return data.map(purchase => ({\r\n        ...purchase,\r\n        profiles: profileMap.get(purchase.user_id) || null,\r\n      })) as ShopPurchase[];\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to purchase an item\r\nexport const usePurchaseItem = () => {\r\n  const { t } = useTranslation();\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async ({ \r\n      itemId, \r\n      shippingAddressId \r\n    }: { \r\n      itemId: string; \r\n      shippingAddressId?: string;\r\n    }) => {\r\n      if (!user?.id) throw new Error('Not authenticated');\r\n      \r\n      const { data, error } = await supabase.rpc('purchase_shop_item', {\r\n        p_user_id: user.id,\r\n        p_item_id: itemId,\r\n        p_shipping_address_id: shippingAddressId || null,\r\n      });\r\n      \r\n      if (error) throw error;\r\n      \r\n      const result = data as { \r\n        success: boolean; \r\n        error?: string; \r\n        purchase_id?: string;\r\n        new_balance?: number;\r\n        user_coupon_id?: string;\r\n      };\r\n      \r\n      if (!result.success) {\r\n        throw new Error(result.error || 'Unknown error');\r\n      }\r\n      \r\n      return result;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['user-points'] });\r\n      queryClient.invalidateQueries({ queryKey: ['user-purchases'] });\r\n      queryClient.invalidateQueries({ queryKey: ['user-purchase-limits'] });\r\n      queryClient.invalidateQueries({ queryKey: ['shop-items'] });\r\n      queryClient.invalidateQueries({ queryKey: ['user-coupons'] });\r\n      queryClient.invalidateQueries({ queryKey: ['profiles'] });\r\n      \r\n      toast({\r\n        title: t('common.success'),\r\n        description: t('shop.purchaseSuccess'),\r\n      });\r\n    },\r\n    onError: (error: Error) => {\r\n      const errorMessages: Record<string, string> = {\r\n        'item_not_found': t('shop.errors.itemNotFound'),\r\n        'item_inactive': t('shop.errors.itemInactive'),\r\n        'out_of_stock': t('shop.errors.outOfStock'),\r\n        'insufficient_points': t('shop.errors.insufficientPoints'),\r\n        'limit_reached': t('shop.errors.limitReached'),\r\n        'address_required': t('shop.errors.addressRequired'),\r\n      };\r\n      \r\n      toast({\r\n        title: t('common.error'),\r\n        description: errorMessages[error.message] || t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to save shop item (create/update)\r\nexport const useSaveShopItem = () => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async (item: Partial<ShopItem> & { id?: string }) => {\r\n      const { id, coupon_templates, ...itemData } = item as any;\r\n      \r\n      if (id) {\r\n        const { error } = await supabase\r\n          .from('shop_items')\r\n          .update(itemData)\r\n          .eq('id', id);\r\n        if (error) throw error;\r\n      } else {\r\n        const { error } = await supabase\r\n          .from('shop_items')\r\n          .insert(itemData);\r\n        if (error) throw error;\r\n      }\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['shop-items'] });\r\n      queryClient.invalidateQueries({ queryKey: ['all-shop-items'] });\r\n      toast({\r\n        title: t('common.success'),\r\n        description: t('common.saved'),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t('common.error'),\r\n        description: t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to delete shop item\r\nexport const useDeleteShopItem = () => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async (itemId: string) => {\r\n      const { error } = await supabase\r\n        .from('shop_items')\r\n        .delete()\r\n        .eq('id', itemId);\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['shop-items'] });\r\n      queryClient.invalidateQueries({ queryKey: ['all-shop-items'] });\r\n      toast({\r\n        title: t('common.success'),\r\n        description: t('common.deleted'),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t('common.error'),\r\n        description: t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to update purchase status\r\nexport const useUpdatePurchaseStatus = () => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async ({ purchaseId, status }: { purchaseId: string; status: string }) => {\r\n      const { error } = await supabase\r\n        .from('shop_purchases')\r\n        .update({ status })\r\n        .eq('id', purchaseId);\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['all-purchases'] });\r\n      queryClient.invalidateQueries({ queryKey: ['user-purchases'] });\r\n      toast({\r\n        title: t('common.success'),\r\n        description: t('common.saved'),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t('common.error'),\r\n        description: t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to reset purchase limits for a specific user on an item\r\nexport const useResetItemPurchaseLimits = () => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async ({ itemId, userId }: { itemId: string; userId: string }) => {\r\n      // Delete purchase limit for this specific user and item\r\n      const { error: limitsError } = await supabase\r\n        .from('user_purchase_limits')\r\n        .delete()\r\n        .eq('shop_item_id', itemId)\r\n        .eq('user_id', userId);\r\n      \r\n      if (limitsError) throw limitsError;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['user-purchase-limits'] });\r\n      queryClient.invalidateQueries({ queryKey: ['item-purchase-limits'] });\r\n      queryClient.invalidateQueries({ queryKey: ['all-shop-items'] });\r\n      toast({\r\n        title: t('common.success'),\r\n        description: t('admin.shop.userLimitReset'),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t('common.error'),\r\n        description: t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n"],"names":["useShopItems","useQuery","data","error","supabase","useAllShopItems","useUserPurchaseLimits","user","useAuth","usePurchaseItem","t","useTranslation","queryClient","useQueryClient","useMutation","itemId","shippingAddressId","result","toast","errorMessages","useSaveShopItem","item","id","coupon_templates","itemData","useDeleteShopItem","useResetItemPurchaseLimits","userId","limitsError"],"mappings":"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"}