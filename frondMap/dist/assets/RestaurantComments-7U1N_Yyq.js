import{p as se,r as a,j as e,aM as De,dB as Pe,dC as Ue,w as G,c9 as ze,X as Z,u as Me,bf as Ee,c3 as $e,a$ as Q,bg as ie,dD as We,ak as ce,br as Be,bh as oe,aK as Ye,cf as Fe}from"./vendor-react-COnB1Bf9.js";import{B as j,s as J,g as ee,u as Oe,Z as He,G as qe,f as Ve,P as de,Q as me,R as ue,i as xe,a8 as he,I as ge,C as L,q as U,a2 as Ke,a3 as Xe,a4 as Ge,a5 as Qe,a6 as Ze,p as Je,A as pe,t as fe,v as je,w as ve,x as Ne,y as we,z as ye,E as be}from"./index-BPRrWp3s.js";import{u as es,a as ss,b as ts,R as as}from"./ReportDialog-lgW5J_zZ.js";import{u as ls}from"./useSensitiveWords-BA0fVY4d.js";import{H as ns}from"./vendor-utils-Z4kpnli5.js";const Ce=new Map,rs=({text:o,className:v,onTranslation:r})=>{const{t:d,i18n:t}=se(),[c,m]=a.useState(!1),[N,i]=a.useState(null),[y,x]=a.useState(!1),[f,w]=a.useState(null),k=t.language;f&&f!==k&&y&&(x(!1),i(null),r?.(null));const I=async()=>{const l=t.language,h=`${o.substring(0,100)}_${l}`;if(y&&f===l){x(!1),r?.(null);return}const g=Ce.get(h);if(g){i(g),x(!0),w(l),r?.(g);return}m(!0),console.log("[TranslateButton] Calling translate-content with targetLang:",l);try{const{data:u,error:b}=await J.functions.invoke("translate-content",{body:{text:o,targetLang:l}});if(console.log("[TranslateButton] Response:",u,b),b){console.error("Translation error:",b),G.error(d("translate.error","翻译失败，请稍后重试"));return}u?.translatedText?(Ce.set(h,u.translatedText),i(u.translatedText),x(!0),w(l),r?.(u.translatedText)):u?.error&&G.error(u.error)}catch(u){console.error("Translation error:",u),G.error(d("translate.error","翻译失败，请稍后重试"))}finally{m(!1)}};return e.jsx(j,{variant:"ghost",size:"sm",className:`gap-1.5 h-auto py-1 px-2 text-xs text-muted-foreground hover:text-foreground ${v||""}`,onClick:I,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"h-3 w-3 animate-spin"}),e.jsx("span",{children:d("translate.translating","翻译中...")})]}):y?e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"h-3 w-3"}),e.jsx("span",{children:d("translate.showOriginal","显示原文")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"h-3 w-3"}),e.jsx("span",{children:d("translate.button","翻译")})]})})},is=({text:o,className:v})=>{const[r,d]=a.useState(null);return e.jsxs("div",{className:v,children:[e.jsx("p",{className:"text-xs sm:text-sm text-foreground break-words",children:r||o}),e.jsx(rs,{text:o,onTranslation:d,className:"mt-0.5"})]})},cs=({imageUrl:o,isOpen:v,onClose:r})=>{const[d,t]=a.useState(!1),[c,m]=a.useState(!1),[N,i]=a.useState(null),[y,x]=a.useState(window.innerWidth),f=a.useRef(null);a.useEffect(()=>{if(v){const l=window.scrollY;return x(window.innerWidth),document.body.style.position="fixed",document.body.style.top=`-${l}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.overflow="",window.scrollTo(0,l)}}},[v]),a.useEffect(()=>{t(!1),m(!1)},[o]);const w=l=>{const h=l.currentTarget,g=h.naturalHeight/h.naturalWidth;t(g>1.5),m(!0)},k=l=>{l.target===l.currentTarget&&r()},I=l=>{if(!N)return;const h=l.changedTouches[0],g=Math.abs(h.clientY-N.y),u=f.current,b=u?Math.abs(u.scrollTop-N.scrollTop):0;g<15&&b<15&&(l.preventDefault(),r()),i(null)};return v?ze.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black",style:{left:0,right:0,top:0,bottom:0,width:"100vw",height:"100dvh",overflow:"hidden",margin:0,padding:0},children:[e.jsx(j,{variant:"ghost",size:"icon",className:"absolute top-4 right-4 z-10 text-white hover:bg-white/20",onClick:r,children:e.jsx(Z,{className:"h-6 w-6"})}),e.jsxs("div",{ref:f,className:"w-full h-full overflow-x-hidden overscroll-contain",style:{overflowY:d?"auto":"hidden",WebkitOverflowScrolling:"touch"},onClick:k,onTouchStart:l=>{i({y:l.touches[0].clientY,scrollTop:f.current?.scrollTop||0})},onTouchEnd:I,onMouseDown:l=>{i({y:l.clientY,scrollTop:f.current?.scrollTop||0})},onMouseUp:l=>{if(N){const h=Math.abs(l.clientY-N.y),g=f.current,u=g?Math.abs(g.scrollTop-N.scrollTop):0;h<10&&u<10&&r(),i(null)}},children:[!c&&e.jsx("img",{src:o,alt:"",onLoad:w,style:{position:"absolute",opacity:0,pointerEvents:"none"}}),c&&(d?e.jsx("img",{src:o,alt:"",draggable:!1,className:"select-none pointer-events-none",style:{display:"block",width:y,minWidth:"100vw",maxWidth:"100vw",height:"auto"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",onClick:r,children:e.jsx("img",{src:o,alt:"",draggable:!1,className:"max-w-full max-h-full object-contain select-none"})}))]})]}),document.body):null},ke=[{value:"0-5",label:"0-5€"},{value:"5-10",label:"5-10€"},{value:"10-15",label:"10-15€"},{value:"15-20",label:"15-20€"},{value:"20-25",label:"20-25€"},{value:"25-30",label:"25-30€"},{value:"30-40",label:"30-40€"},{value:"40-50",label:"40-50€"},{value:"50+",label:"50€+"}],Se=a.memo(({imageUrl:o,onPreview:v})=>{const{t:r}=se(),[d,t]=a.useState(!1),[c,m]=a.useState(!1),N=a.useCallback(i=>{const y=i.currentTarget,x=y.naturalHeight/y.naturalWidth;t(x>1.5),m(!0)},[]);return e.jsxs("div",{className:"relative mt-2 inline-block max-w-full sm:max-w-sm w-full",children:[e.jsx("img",{src:o,alt:"Comment attachment",className:"rounded-lg w-full max-h-[300px] sm:max-h-[400px] object-cover object-top cursor-pointer hover:opacity-90 transition-opacity",onClick:v,onLoad:N}),c&&d&&e.jsx(ee,{variant:"secondary",className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-1.5 py-0.5",children:r("community.longImage","长图")})]})});Se.displayName="CommentImage";const os=({restaurantId:o,targetId:v,targetType:r="restaurant"})=>{const d=v||o||"",{t}=se(),{user:c}=Oe(),{data:m}=He(),{isAdmin:N}=qe(),{toast:i}=Ve(),y=Me(),[x,f]=a.useState(""),[w,k]=a.useState(0),[I,l]=a.useState(0),[h,g]=a.useState(""),[u,b]=a.useState(null),[S,z]=a.useState(""),[M,E]=a.useState(null),[$,W]=a.useState(null),[B,Y]=a.useState(null),[F,O]=a.useState(null),[C,_]=a.useState(!1),[Te,te]=a.useState(!1),[H,q]=a.useState(null),[ae,A]=a.useState(null),{data:V,isLoading:Ie}=es(d,r),T=ss(),le=ts(),{checkContent:D}=ls(),P=a.useCallback(async s=>{try{const p=s.name.split(".").pop(),R=`${`${c?.id}-${Date.now()}.${p}`}`,{error:re,data:ds}=await J.storage.from("comment-images").upload(R,s);if(re)throw re;const{data:{publicUrl:Ae}}=J.storage.from("comment-images").getPublicUrl(R);return Ae}catch(p){return console.error("Error uploading image:",p),i({title:t("common.error"),description:t("restaurant.imageUploadFailed"),variant:"destructive"}),null}},[c,i,t]),ne=a.useCallback((s,p=!1)=>{const n=s.target.files?.[0];if(n){if(n.size>5*1024*1024){i({title:t("common.error"),description:t("restaurant.imageTooLarge"),variant:"destructive"});return}p?(Y(n),O(URL.createObjectURL(n))):(E(n),W(URL.createObjectURL(n)))}},[i,t]),K=a.useCallback((s=!1)=>{s?(Y(null),O(null)):(E(null),W(null))},[]),Re=a.useCallback(async()=>{if(!x.trim()||!c)return;if(m?.is_muted){i({title:t("common.error"),description:t("restaurant.youAreMuted"),variant:"destructive"});return}if(D(x).hasSensitive){i({title:t("common.error"),description:t("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}if(r==="restaurant"&&!w){i({title:t("common.hint","提示"),description:t("toast.pleaseSelectRating"),variant:"warning"});return}_(!0);let p;if(M){const n=await P(M);n&&(p=n)}await T.mutateAsync({targetId:d,targetType:r,content:x,ratingValue:r==="restaurant"?w:void 0,priceRange:r==="restaurant"&&h?h:void 0,imageUrl:p}),f(""),k(0),g(""),E(null),W(null),_(!1)},[x,c,m,r,w,i,t,M,P,T,o,h,D]),Le=a.useCallback(async s=>{if(!S.trim()||!c)return;if(m?.is_muted){i({title:t("common.error"),description:t("restaurant.youAreMuted"),variant:"destructive"});return}if(D(S).hasSensitive){i({title:t("common.error"),description:t("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}_(!0);let n;if(B){const R=await P(B);R&&(n=R)}await T.mutateAsync({targetId:d,targetType:r,content:S,parentId:s,imageUrl:n}),z(""),b(null),Y(null),O(null),_(!1)},[S,c,m,B,P,T,o,r,D,i,t]),_e=a.useCallback(async s=>{await le.mutateAsync(s),q(null)},[le]),X=a.memo(({comment:s,isReply:p=!1})=>e.jsxs("div",{className:`flex gap-2 sm:gap-3 ${p?"ml-8 sm:ml-12 mt-3":""}`,children:[e.jsxs(de,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(me,{src:s.profiles?.avatar_url}),e.jsx(ue,{className:"text-xs sm:text-sm",children:s.profiles?.display_name?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-xs sm:text-sm truncate",children:s.profiles?.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0",children:ns(new Date(s.created_at),{addSuffix:!0})}),s.edited&&e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:["(",t("restaurant.edited"),")"]}),c?.id===s.user_id&&s.moderation_status==="pending"&&e.jsxs(ee,{variant:"outline",className:"text-yellow-600 border-yellow-500 bg-yellow-50 dark:bg-yellow-950/30 text-xs py-0 h-5",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1"}),t("restaurant.commentPending","审核中")]}),c?.id===s.user_id&&s.moderation_status==="flagged"&&e.jsxs(ee,{variant:"outline",className:"text-destructive border-destructive bg-destructive/10 text-xs py-0 h-5",children:[e.jsx($e,{className:"w-3 h-3 mr-1"}),t("restaurant.commentFailed","发送失败")]})]}),!p&&s.rating_value&&e.jsxs("div",{className:"flex items-center gap-3 mt-1 mb-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(n=>e.jsx(Q,{className:xe("w-4 h-4",n<=s.rating_value?"fill-accent text-accent":"text-muted-foreground")},n))}),s.price_range&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(ie,{className:"w-3 h-3"}),e.jsx("span",{children:ke.find(n=>n.value===s.price_range)?.label})]})]}),e.jsx(is,{text:s.content,className:"mt-1"}),s.image_url&&e.jsx(Se,{imageUrl:s.image_url,onPreview:()=>A(s.image_url)}),e.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-2",children:[!p&&c&&!m?.is_muted&&e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>b(s.id),className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(We,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:t("restaurant.reply")})]}),(c?.id===s.user_id||N)&&e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>q(s.id),className:"h-7 text-xs text-destructive hover:text-destructive px-2 sm:px-3",children:[e.jsx(ce,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:t("common.delete")})]}),c?.id!==s.user_id&&e.jsx(as,{targetType:"comment",targetId:s.id,onLoginRequired:()=>te(!0),trigger:e.jsxs(j,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Be,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:t("report.title")})]})})]}),u===s.id&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(he,{value:S,onChange:n=>z(n.target.value),placeholder:t("restaurant.writeReply"),className:"min-h-[80px] text-sm"}),F&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:F,alt:"Preview",className:"w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>A(F)}),e.jsx(j,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>K(!0),children:e.jsx(Z,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex sm:flex-col gap-2",children:[e.jsx(j,{size:"sm",onClick:()=>Le(s.id),disabled:!S.trim()||C,className:"text-xs",children:t(C?"common.loading":"restaurant.reply")}),e.jsx(ge,{type:"file",accept:"image/*",onChange:n=>ne(n,!0),className:"hidden",id:`reply-image-${s.id}`,disabled:C}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>document.getElementById(`reply-image-${s.id}`)?.click(),disabled:C,className:"text-xs sm:px-3",children:[e.jsx(oe,{className:"h-4 w-4 sm:mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:t("restaurant.addImage")})]}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>{b(null),z(""),K(!0)},className:"text-xs",children:t("common.cancel")})]})]})}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3",children:s.replies.map(n=>e.jsx(X,{comment:n,isReply:!0},n.id))})]})]}));return X.displayName="CommentItem",Ie?e.jsx("div",{className:"text-center py-8",children:t("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"w-4 sm:w-5 h-4 sm:h-5"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold",children:[t("restaurant.reviews")," (",V?.length||0,")"]})]}),c?m?.is_muted?e.jsx(L,{className:"border-yellow-300 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(U,{className:"py-4 sm:py-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex items-center gap-3 text-yellow-600 dark:text-yellow-400",children:[e.jsx(Fe,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:t("restaurant.youAreMutedNotice")})]})})}):e.jsx(L,{children:e.jsx(U,{className:"pt-4 sm:pt-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex gap-2 sm:gap-3",children:[e.jsxs(de,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(me,{src:m?.avatar_url||void 0}),e.jsx(ue,{className:"text-xs sm:text-sm",children:m?.display_name?.charAt(0).toUpperCase()||c?.email?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 space-y-2 sm:space-y-3 min-w-0",children:[r==="restaurant"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-accent"}),"评分 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onMouseEnter:()=>l(s),onMouseLeave:()=>l(0),onClick:()=>k(s),className:"transition-transform hover:scale-110",children:e.jsx(Q,{className:xe("w-7 h-7 cursor-pointer transition-colors",s<=(I||w)?"fill-accent text-accent":"text-muted-foreground hover:text-accent")})},s)),w>0&&e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",w,"/5)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4"}),t("restaurant.priceRange")]}),e.jsxs(Ke,{value:h,onValueChange:g,children:[e.jsx(Xe,{className:"w-full",children:e.jsx(Ge,{placeholder:t("restaurant.selectPriceRange")})}),e.jsx(Qe,{className:"bg-background",children:ke.map(s=>e.jsx(Ze,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsx(he,{value:x,onChange:s=>f(s.target.value),placeholder:t("restaurant.writeComment"),className:"min-h-[80px] sm:min-h-[100px] text-sm"}),$&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:$,alt:"Preview",className:"w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>A($)}),e.jsx(j,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>K(!1),children:e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(ge,{type:"file",accept:"image/*",onChange:s=>ne(s,!1),className:"hidden",id:"comment-image",disabled:C}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>document.getElementById("comment-image")?.click(),disabled:C,className:"text-xs",children:[e.jsx(oe,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:t("restaurant.addImage")})]}),e.jsx(j,{onClick:Re,disabled:!x.trim()||T.isPending||C,size:"sm",className:"text-xs",children:C||T.isPending?t("common.loading"):t("restaurant.postComment")})]})]})]})})}):e.jsx(L,{children:e.jsx(U,{className:"py-4 sm:py-6 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:t("restaurant.signInToComment")})}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:V?.map(s=>e.jsx(L,{children:e.jsx(Je,{className:"p-3 sm:p-6",children:e.jsx(X,{comment:s})})},s.id))}),V?.length===0&&e.jsx(L,{children:e.jsx(U,{className:"py-8 sm:py-12 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:t("restaurant.noComments")})})]}),e.jsx(pe,{open:Te,onOpenChange:te,children:e.jsxs(fe,{children:[e.jsxs(je,{children:[e.jsx(ve,{children:t("activities.loginRequired")}),e.jsx(Ne,{children:t("activities.loginRequiredMessage")})]}),e.jsxs(we,{children:[e.jsx(ye,{children:t("common.cancel")}),e.jsx(be,{onClick:()=>y("/auth"),children:t("activities.goToLogin")})]})]})}),e.jsx(pe,{open:!!H,onOpenChange:s=>!s&&q(null),children:e.jsxs(fe,{className:"max-w-sm",children:[e.jsxs(je,{children:[e.jsx("div",{className:"mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(ce,{className:"h-7 w-7 text-destructive"})}),e.jsx(ve,{className:"text-center",children:t("restaurant.deleteComment")}),e.jsx(Ne,{className:"text-center",children:t("restaurant.confirmDelete")})]}),e.jsxs(we,{className:"sm:justify-center gap-2",children:[e.jsx(ye,{className:"sm:w-24",children:t("common.cancel")}),e.jsx(be,{onClick:()=>H&&_e(H),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 sm:w-24",children:t("common.delete")})]})]})}),e.jsx(cs,{imageUrl:ae||"",isOpen:!!ae,onClose:()=>A(null)})]})},ps=Object.freeze(Object.defineProperty({__proto__:null,default:os},Symbol.toStringTag,{value:"Module"}));export{os as R,rs as T,ps as a};
//# sourceMappingURL=RestaurantComments-7U1N_Yyq.js.map
