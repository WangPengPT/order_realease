import{s as m,q as l,p as y,v as _,w as u}from"./vendor-react-DwI6ZJq7.js";import{u as f,s as i}from"./index-C7QjDrm6.js";const w=t=>{const{user:r}=f();return m({queryKey:["community-posts",t],queryFn:async()=>{let e=i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt),
          post_restaurants(
            restaurant:restaurants(id, name, name_en, name_pt)
          )
        `);t?.sortBy==="popular"?e=e.order("likes_count",{ascending:!1}).order("created_at",{ascending:!1}):e=e.order("weight",{ascending:!1}).order("created_at",{ascending:!1}),t?.authorId&&(e=e.eq("author_id",t.authorId)),t?.status&&(e=e.eq("status",t.status)),t?.limit&&(e=e.limit(t.limit)),t?.postType&&t.postType!=="all"&&(e=e.eq("post_type",t.postType));const{data:s,error:a}=await e;if(a)throw a;const n=s?.map(o=>({...o,restaurants:o.post_restaurants?.map(d=>d.restaurant).filter(Boolean)||[]}));if(r&&n){const o=n.map(c=>c.id),{data:d}=await i.from("post_likes").select("post_id").eq("user_id",r.id).in("post_id",o),p=new Set(d?.map(c=>c.post_id)||[]);return n.map(c=>({...c,user_liked:p.has(c.id)}))}return n}})},v=t=>{const{user:r}=f();return m({queryKey:["community-post",t],queryFn:async()=>{const{data:e,error:s}=await i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt),
          post_restaurants(
            restaurant:restaurants(id, name, name_en, name_pt)
          )
        `).eq("id",t).single();if(s)throw s;const a={...e,restaurants:e.post_restaurants?.map(n=>n.restaurant).filter(Boolean)||[]};if(r){const{data:n}=await i.from("post_likes").select("id").eq("post_id",t).eq("user_id",r.id).maybeSingle();return{...a,user_liked:!!n}}return a},enabled:!!t})},g=()=>{const t=l(),{t:r}=y();return _({mutationFn:async e=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");const{data:a,error:n}=await i.from("community_posts").insert({author_id:s.id,content:e.content,image_urls:e.image_urls||[],video_url:e.video_url||null,activity_id:e.activity_id||null,restaurant_id:null,status:"pending",moderation_status:"pending"}).select().single();if(n)throw n;if(e.restaurant_ids&&e.restaurant_ids.length>0){const{error:o}=await i.from("post_restaurants").insert(e.restaurant_ids.map(d=>({post_id:a.id,restaurant_id:d})));o&&console.error("Failed to insert post restaurants:",o)}try{await i.functions.invoke("moderate-post",{body:{post_id:a.id,content:e.content,user_id:s.id,image_urls:e.image_urls||[],video_url:e.video_url||null,sensitive_word_detected:e.sensitive_word_detected||!1}})}catch(o){console.error("Moderation call failed:",o)}return a},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["has-posted-today"]}),u.success(r("community.postSuccess","帖子发布成功"))},onError:e=>{console.error("Create post error:",e),u.error(r("community.postError","发布失败"))}})},k=()=>{const t=l(),{t:r}=y();return _({mutationFn:async e=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");const{data:a,error:n}=await i.from("community_posts").update({content:e.content,image_urls:e.image_urls||[],video_url:e.video_url??null,activity_id:e.activity_id??null,status:"pending",moderation_status:"pending",risk_score:null,risk_reasons:null,ai_reviewed_at:null}).eq("id",e.id).eq("author_id",s.id).select().single();if(n)throw n;if(await i.from("post_restaurants").delete().eq("post_id",e.id),e.restaurant_ids&&e.restaurant_ids.length>0){const{error:o}=await i.from("post_restaurants").insert(e.restaurant_ids.map(d=>({post_id:e.id,restaurant_id:d})));o&&console.error("Failed to update post restaurants:",o)}try{await i.functions.invoke("moderate-post",{body:{post_id:a.id,content:e.content,user_id:s.id,image_urls:e.image_urls||[],video_url:e.video_url||null,sensitive_word_detected:e.sensitive_word_detected||!1}})}catch(o){console.error("Moderation call failed:",o)}return a},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["community-post"]}),t.invalidateQueries({queryKey:["admin-community-posts"]}),u.success(r("community.editSuccess","帖子已更新，等待审核"))},onError:e=>{console.error("Edit post error:",e),u.error(r("community.editError","编辑失败"))}})},K=()=>{const t=l(),{t:r}=y();return _({mutationFn:async({id:e,...s})=>{const{data:a,error:n}=await i.from("community_posts").update(s).eq("id",e).select().single();if(n)throw n;return a},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["community-post"]}),t.invalidateQueries({queryKey:["admin-community-posts"]}),u.success(r("common.saved","保存成功"))},onError:e=>{console.error("Update post error:",e),u.error(r("common.error","操作失败"))}})},Q=()=>{const t=l(),{t:r}=y();return _({mutationFn:async e=>{const{error:s}=await i.from("community_posts").delete().eq("id",e);if(s)throw s},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["admin-community-posts"]}),u.success(r("common.deleted","删除成功"))},onError:e=>{console.error("Delete post error:",e),u.error(r("common.error","操作失败"))}})},S=()=>{const t=l();return _({mutationFn:async({postId:r,liked:e})=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");if(e){const{error:a}=await i.from("post_likes").delete().eq("post_id",r).eq("user_id",s.id);if(a)throw a}else{const{error:a}=await i.from("post_likes").insert({post_id:r,user_id:s.id});if(a)throw a}},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["community-post"]})}})},C=()=>{const t=l(),{t:r}=y();return _({mutationFn:async e=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:a}=await i.from("post_shares").insert({post_id:e,user_id:s.id});if(a)throw a},onSuccess:()=>{t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["community-post"]}),u.success(r("community.shared","分享成功"))}})},E=()=>{const{user:t}=f();return m({queryKey:["can-create-post",t?.id],queryFn:async()=>!!t,enabled:!0})},F=()=>{const{user:t}=f();return m({queryKey:["merchant-restaurant",t?.id],queryFn:async()=>{if(!t)return null;const{data:r}=await i.from("merchant_restaurants").select("restaurant_id, restaurants:restaurant_id(id, name, name_en, name_pt)").eq("user_id",t.id).limit(1).maybeSingle();return r?.restaurants||null},enabled:!!t})},P=()=>{const{user:t}=f();return m({queryKey:["has-posted-today",t?.id],queryFn:async()=>{if(!t)return!1;const r=new Date;r.setHours(0,0,0,0);const e=r.toISOString(),{count:s,error:a}=await i.from("community_posts").select("id",{count:"exact",head:!0}).eq("author_id",t.id).gte("created_at",e);if(a)throw a;return(s??0)>0},enabled:!!t})},b=t=>m({queryKey:["admin-community-posts",t],queryFn:async()=>{let r=i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt)
        `).order("created_at",{ascending:!1});t?.status&&(r=r.eq("status",t.status)),t?.moderation_status&&(r=r.eq("moderation_status",t.moderation_status)),t?.post_type&&(r=r.eq("post_type",t.post_type)),t?.search&&(r=r.ilike("content",`%${t.search}%`));const{data:e,error:s}=await r;if(s)throw s;return e}});export{S as a,Q as b,k as c,b as d,K as e,C as f,g,F as h,P as i,E as j,v as k,w as u};
//# sourceMappingURL=useCommunityPosts-CLuoFC0C.js.map
