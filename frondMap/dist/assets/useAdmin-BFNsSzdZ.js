import{s as w,q as g,v as p}from"./vendor-react-C7F4V4j9.js";import{u as C,s as a,f as _}from"./index-BgP4kwZT.js";import{i as o}from"./vendor-i18n-jtdHZIRR.js";const R=async t=>{const{data:i}=await a.from("user_roles").select("role").eq("user_id",t).single();return i?.role},A=()=>{const{user:t}=C();return w({queryKey:["admin-users",t?.id],queryFn:async()=>{if(!t)return[];const i=async()=>{const m=[];let S=0;const F=1e3;let q=!0;for(;q;){const{data:v,error:E}=await a.from("profiles").select("*").order("created_at",{ascending:!1}).range(S*F,(S+1)*F-1);if(E)throw E;v&&v.length>0?(m.push(...v),q=v.length===F,S++):q=!1}return m},s=async()=>{const m=[];let S=0;const F=1e3;let q=!0;for(;q;){const{data:v,error:E}=await a.from("user_roles").select("user_id, role").range(S*F,(S+1)*F-1);if(E)throw E;v&&v.length>0?(m.push(...v),q=v.length===F,S++):q=!1}return m},[e,r,u,l]=await Promise.all([i(),s(),a.auth.getSession(),a.from("user_roles").select("role").eq("user_id",t.id).single()]),f={};r.forEach(m=>{f[m.user_id]=m.role});let d={},n={},c={};if(u.data?.session?.access_token)try{const m=await a.functions.invoke("get-user-emails",{headers:{Authorization:`Bearer ${u.data.session.access_token}`}});m.data?.emails&&(d=m.data.emails),m.data?.createdAt&&(n=m.data.createdAt),m.data?.lastSignIn&&(c=m.data.lastSignIn)}catch(m){console.error("Failed to fetch user data:",m)}const y=e.map(m=>({...m,role:f[m.id]||"user",email:d[m.id]||"",auth_created_at:n[m.id]||m.created_at,last_sign_in_at:c[m.id]||null}));if(l.data?.role==="supervisor"){const{data:m,error:S}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);if(S)throw S;if(!m||m.length===0)return[];const F=m.map(b=>b.restaurant_id),{data:q,error:v}=await a.from("merchant_restaurants").select("user_id, restaurant_id").in("restaurant_id",F);if(v)throw v;if(!q||q.length===0)return[];const E=[...new Set(q.map(b=>b.user_id).filter(b=>b!==t.id))];if(E.length===0)return[];const U=E.filter(b=>f[b]==="merchant");return y.filter(b=>U.includes(b.id))}return y},staleTime:3e4})},Q=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async({userId:s,role:e})=>{const{error:r}=await a.from("user_roles").upsert({user_id:s,role:e},{onConflict:"user_id"});if(r)throw r},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),i.invalidateQueries({queryKey:["user-roles"]}),t({title:o.t("common.success"),description:o.t("toast.roleChanged")})},onError:s=>{console.error("Role change error:",s),t({title:o.t("common.error"),description:s.message||o.t("toast.roleChangeFailed"),variant:"destructive"})}})},P=()=>{const{user:t}=C();return w({queryKey:["admin-restaurants",t?.id],queryFn:async()=>{if(!t)return[];if(await R(t.id)==="supervisor"){const{data:e,error:r}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);if(r)throw r;const u=e?.map(d=>d.restaurant_id)||[];if(u.length===0)return[];const{data:l,error:f}=await a.from("restaurants").select("*").in("id",u).order("rating",{ascending:!1});if(f)throw f;return l||[]}else{const{data:e,error:r}=await a.from("restaurants").select("*").order("rating",{ascending:!1});if(r)throw r;return e||[]}},enabled:!!t})},$=()=>w({queryKey:["operation-logs"],queryFn:async()=>{const{data:t,error:i}=await a.from("operation_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(i)throw i;return await Promise.all((t||[]).map(async e=>{const{data:r}=await a.from("profiles").select("display_name").eq("id",e.user_id).single();return{...e,user_name:r?.display_name||"Unknown User"}}))}}),k=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async({userId:s,display_name:e,phone:r,avatar_url:u})=>{const{data:l,error:f}=await a.from("profiles").update({display_name:e,phone:r,avatar_url:u}).eq("id",s).select().single();if(f)throw f;return l},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.profileUpdated")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.profileUpdateFailed"),variant:"destructive"})}})},O=()=>{const{toast:t}=_();return p({mutationFn:async({file:i,userId:s})=>{const e=i.name.split(".").pop(),r=`${Date.now()}.${e}`,u=`${s}/${r}`,{error:l}=await a.storage.from("avatars").upload(u,i,{upsert:!0});if(l)throw l;const{data:{publicUrl:f}}=a.storage.from("avatars").getPublicUrl(u);return f},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.avatarUploadFailed"),variant:"destructive"})}})},x=()=>{const{user:t}=C();return w({queryKey:["admin-stats",t?.id],queryFn:async()=>{if(!t)return{totalUsers:0,totalRestaurants:0,totalActivities:0,totalComments:0};if(await R(t.id)==="supervisor"){const{data:f}=await a.from("merchant_restaurants").select("restaurant_id, user_id").eq("user_id",t.id),d=f?.map(m=>m.restaurant_id)||[],c=(Array.from(new Set(f?.map(m=>m.user_id)))||[]).length,y=d.length;let h=0;if(d.length>0){const{count:m}=await a.from("comments").select("*",{count:"exact",head:!0}).eq("target_type","restaurant").in("target_id",d);h=m||0}return{totalUsers:c,totalRestaurants:y,totalActivities:0,totalComments:h}}const[e,r,u,l]=await Promise.all([a.from("profiles").select("*",{count:"exact",head:!0}),a.from("restaurants").select("*",{count:"exact",head:!0}),a.from("activities").select("*",{count:"exact",head:!0}),a.from("comments").select("*",{count:"exact",head:!0})]);return{totalUsers:e.count||0,totalRestaurants:r.count||0,totalActivities:u.count||0,totalComments:l.count||0}}})},z=()=>{const{user:t}=C();return w({queryKey:["top-restaurants",t?.id],queryFn:async()=>{if(!t)return[];const s=await R(t.id)==="supervisor";let e=a.from("restaurants").select("id, name, rating").order("rating",{ascending:!1,nullsFirst:!1}).limit(10);if(s){const{data:f}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id),d=f?.map(n=>n.restaurant_id)||[];if(d.length===0)return[];e=a.from("restaurants").select("id, name, rating").in("id",d).order("rating",{ascending:!1,nullsFirst:!1}).limit(10)}const{data:r,error:u}=await e;if(u)throw u;return await Promise.all((r||[]).map(async f=>{const{count:d}=await a.from("comments").select("*",{count:"exact",head:!0}).eq("target_id",f.id).eq("target_type","restaurant");return{name:f.name,rating:f.rating||0,comments:d||0}}))}})},j=()=>{const{user:t}=C();return w({queryKey:["restaurant-rating-trends",t?.id],queryFn:async()=>{if(!t)return[];const s=await R(t.id)==="supervisor";let e=[],r={};if(s){const{data:n}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);e=n?.map(c=>c.restaurant_id)||[]}else{const{data:n}=await a.from("restaurants").select("id, name").order("rating",{ascending:!1,nullsFirst:!1}).limit(5);e=n?.map(c=>c.id)||[],n?.forEach(c=>{r[c.id]=c.name})}if(e.length===0)return[];const{data:u}=await a.from("comments").select("target_id, rating_value, created_at").eq("target_type","restaurant").in("target_id",e).not("rating_value","is",null).order("created_at",{ascending:!0});if(!u||u.length===0)return[];if(Object.keys(r).length===0){const{data:n}=await a.from("restaurants").select("id, name").in("id",e);n?.forEach(c=>{r[c.id]=c.name})}const l={};u.forEach(n=>{const c=new Date(n.created_at),y=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;l[n.target_id]||(l[n.target_id]={}),l[n.target_id][y]||(l[n.target_id][y]={sum:0,count:0}),l[n.target_id][y].sum+=n.rating_value,l[n.target_id][y].count+=1});const f=new Set;return Object.values(l).forEach(n=>{Object.keys(n).forEach(c=>f.add(c))}),Array.from(f).sort().map(n=>{const c={month:n};return Object.keys(l).forEach(y=>{const h=l[y][n],m=h?(h.sum/h.count).toFixed(1):null;c[r[y]||y]=m}),c})}})},T=()=>{const{user:t}=C();return w({queryKey:["restaurant-comment-trends",t?.id],queryFn:async()=>{if(!t)return[];const s=await R(t.id)==="supervisor";let e=[],r={};if(s){const{data:n}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);e=n?.map(c=>c.restaurant_id)||[]}else{const{data:n}=await a.from("restaurants").select("id, name").order("rating",{ascending:!1,nullsFirst:!1}).limit(5);e=n?.map(c=>c.id)||[],n?.forEach(c=>{r[c.id]=c.name})}if(e.length===0)return[];const{data:u}=await a.from("comments").select("target_id, created_at").eq("target_type","restaurant").in("target_id",e).order("created_at",{ascending:!0});if(!u||u.length===0)return[];if(Object.keys(r).length===0){const{data:n}=await a.from("restaurants").select("id, name").in("id",e);n?.forEach(c=>{r[c.id]=c.name})}const l={};u.forEach(n=>{const c=new Date(n.created_at),y=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;l[n.target_id]||(l[n.target_id]={}),l[n.target_id][y]=(l[n.target_id][y]||0)+1});const f=new Set;return Object.values(l).forEach(n=>{Object.keys(n).forEach(c=>f.add(c))}),Array.from(f).sort().map(n=>{const c={month:n};return Object.keys(l).forEach(y=>{const h=l[y][n]||0;c[r[y]||y]=h}),c})}})},B=()=>w({queryKey:["activity-engagement"],queryFn:async()=>{const{data:t,error:i}=await a.from("activities").select("id, title_en").order("created_at",{ascending:!1}).limit(10);if(i)throw i;return await Promise.all((t||[]).map(async e=>{const[r,u]=await Promise.all([a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",e.id),a.from("comments").select("*",{count:"exact",head:!0}).eq("target_id",e.id).eq("target_type","activity")]);return{name:e.title_en,subscribers:r.count||0,comments:u.count||0}}))}}),W=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{await a.from("activity_restaurants").delete().eq("activity_id",s);const{error:e}=await a.from("activities").delete().eq("id",s);if(e)throw e},onSuccess:()=>{i.invalidateQueries({queryKey:["activities"]}),i.invalidateQueries({queryKey:["admin-activities"]}),t({title:o.t("common.success"),description:o.t("toast.activityDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.activityDeleteFailed"),variant:"destructive"})}})},L=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{const{error:e}=await a.from("restaurants").delete().eq("id",s);if(e)throw e},onSuccess:()=>{i.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.restaurantDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.restaurantDeleteFailed"),variant:"destructive"})}})},N=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{console.log("Calling delete-account edge function for userId:",s);const{data:e,error:r}=await a.functions.invoke("delete-account",{body:{userId:s}});if(console.log("Delete-account response:",{data:e,error:r}),r)throw console.error("Delete-account error:",r),r;if(e?.error)throw console.error("Delete-account data error:",e.error),new Error(e.error);return e},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.userDeleted")})},onError:s=>{console.error("useDeleteUser onError:",s),t({title:o.t("common.error"),description:s?.message||o.t("toast.userDeleteFailed"),variant:"destructive"})}})},Y=()=>{const{toast:t}=_(),i=g(),{user:s}=C();return p({mutationFn:async({userId:e,banReason:r})=>{const{error:u}=await a.from("profiles").update({is_banned:!0,ban_reason:r||null,banned_at:new Date().toISOString(),banned_by:s?.id}).eq("id",e);if(u)throw u},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.userBanned")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userBanFailed"),variant:"destructive"})}})},I=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{const{error:e}=await a.from("profiles").update({is_banned:!1,ban_reason:null,banned_at:null,banned_by:null}).eq("id",s);if(e)throw e},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),i.invalidateQueries({queryKey:["banned-users"]}),t({title:o.t("common.success"),description:o.t("toast.userUnbanned")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userUnbanFailed"),variant:"destructive"})}})},V=()=>{const{toast:t}=_(),i=g(),{user:s}=C();return p({mutationFn:async({userId:e,muteReason:r,mutedUntil:u})=>{const{error:l}=await a.from("profiles").update({is_muted:!0,mute_reason:r||null,muted_at:new Date().toISOString(),muted_by:s?.id,muted_until:u||null}).eq("id",e);if(l)throw l;const{data:f}=await a.from("profiles").select("language_preference").eq("id",e).single(),d=f?.language_preference||"en";let n="";if(u){const h=new Date(u);d==="zh"?n=`禁言至: ${h.toLocaleDateString("zh-CN")}`:d==="pt"?n=`Silenciado até: ${h.toLocaleDateString("pt-PT")}`:n=`Muted until: ${h.toLocaleDateString("en-US")}`}else d==="zh"?n="永久禁言":d==="pt"?n="Silenciamento permanente":n="Permanent mute";let c="",y="";d==="zh"?(c="账号已被禁言",y=`${n}。原因: ${r||"违反社区规则"}`):d==="pt"?(c="Conta silenciada",y=`${n}. Motivo: ${r||"Violação das regras da comunidade"}`):(c="Account muted",y=`${n}. Reason: ${r||"Community guidelines violation"}`),await a.from("notifications").insert({user_id:e,type:"activity_update",title:c,content:y,link:"/profile"})},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),i.invalidateQueries({queryKey:["muted-users"]}),t({title:o.t("common.success"),description:o.t("toast.userMuted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userMuteFailed"),variant:"destructive"})}})},G=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{const{data:e}=await a.from("profiles").select("language_preference").eq("id",s).single(),{error:r}=await a.from("profiles").update({is_muted:!1,mute_reason:null,muted_at:null,muted_by:null,muted_until:null}).eq("id",s);if(r)throw r;const u=e?.language_preference||"en";let l="",f="";u==="zh"?(l="禁言已解除",f="您的账号禁言已被解除，现在可以正常发表评论了。"):u==="pt"?(l="Silenciamento removido",f="O silenciamento da sua conta foi removido. Você pode comentar novamente."):(l="Mute lifted",f="Your account mute has been lifted. You can now post comments again."),await a.from("notifications").insert({user_id:s,type:"activity_update",title:l,content:f,link:"/profile"})},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),i.invalidateQueries({queryKey:["muted-users"]}),t({title:o.t("common.success"),description:o.t("toast.userUnmuted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userUnmuteFailed"),variant:"destructive"})}})},H=()=>w({queryKey:["banned-users"],queryFn:async()=>{const{data:t,error:i}=await a.from("profiles").select("*").eq("is_banned",!0).order("banned_at",{ascending:!1});if(i)throw i;const{data:s}=await a.from("user_roles").select("user_id, role"),e={};return s?.forEach(r=>{e[r.user_id]=r.role}),(t||[]).map(r=>({...r,role:e[r.id]||"user"}))}}),J=()=>w({queryKey:["muted-users"],queryFn:async()=>{const{data:t,error:i}=await a.from("profiles").select("*").eq("is_muted",!0).order("muted_at",{ascending:!1});if(i)throw i;const{data:s}=await a.from("user_roles").select("user_id, role"),e={};return s?.forEach(r=>{e[r.user_id]=r.role}),(t||[]).map(r=>({...r,role:e[r.id]||"user"}))}}),X=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{const e=s.map(async r=>{const{error:u}=await a.functions.invoke("delete-account",{body:{userId:r}});if(u)throw u});await Promise.all(e)},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.usersDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.usersDeleteFailed"),variant:"destructive"})}})},Z=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{const{error:e}=await a.from("restaurants").delete().in("id",s);if(e)throw e},onSuccess:()=>{i.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.restaurantsDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.restaurantsDeleteFailed"),variant:"destructive"})}})},tt=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async s=>{await a.from("activity_restaurants").delete().in("activity_id",s);const{error:e}=await a.from("activities").delete().in("id",s);if(e)throw e},onSuccess:()=>{i.invalidateQueries({queryKey:["activities"]}),t({title:o.t("common.success"),description:o.t("toast.activitiesDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.activitiesDeleteFailed"),variant:"destructive"})}})},et=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async({userIds:s,role:e})=>{const r=s.map(l=>({user_id:l,role:e})),{error:u}=await a.from("user_roles").upsert(r,{onConflict:"user_id"});if(u)throw u},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.rolesChanged")})},onError:s=>{console.error("Batch role change error:",s),t({title:o.t("common.error"),description:s.message||o.t("toast.rolesChangeFailed"),variant:"destructive"})}})},rt=()=>{const{toast:t}=_(),i=g();return p({mutationFn:async({restaurantId:s,visible:e})=>{const{error:r}=await a.from("restaurants").update({visible:e}).eq("id",s);if(r)throw r},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-restaurants"]}),i.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.visibilityUpdated")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.visibilityUpdateFailed"),variant:"destructive"})}})},st=()=>w({queryKey:["activity-share-trends"],queryFn:async()=>{const{data:t}=await a.from("activities").select("id, title_zh, title_en, title_pt").eq("visible",!0).limit(10);if(!t||t.length===0)return[];const i=t.map(d=>d.id),s={};t.forEach(d=>{s[d.id]=d.title_zh||d.title_en});const{data:e}=await a.from("activity_shares").select("activity_id, created_at").in("activity_id",i).order("created_at",{ascending:!0});if(!e||e.length===0)return[];const r={};e.forEach(d=>{const n=new Date(d.created_at),c=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`;r[d.activity_id]||(r[d.activity_id]={}),r[d.activity_id][c]=(r[d.activity_id][c]||0)+1});const u=new Set;Object.values(r).forEach(d=>{Object.keys(d).forEach(n=>u.add(n))});const l=Array.from(u).sort(),f=Object.keys(r);return l.map(d=>{const n={month:d};return f.forEach(c=>{const y=r[c][d]||0,h=s[c]?.substring(0,15)||c;n[h]=y}),n})}}),at=()=>w({queryKey:["activity-share-stats"],queryFn:async()=>{const{data:t}=await a.from("activities").select("id, title_zh, title_en, title_pt").eq("visible",!0);return!t||t.length===0?[]:(await Promise.all(t.map(async s=>{const{count:e}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",s.id);return{id:s.id,name:(s.title_zh||s.title_en).substring(0,15),shares:e||0}}))).sort((s,e)=>e.shares-s.shares).slice(0,10)}});export{J as A,z as a,B as b,j as c,T as d,st as e,at as f,k as g,O as h,A as i,Q as j,X as k,et as l,N as m,P as n,L as o,Z as p,rt as q,W as r,tt as s,$ as t,x as u,Y as v,I as w,V as x,G as y,H as z};
//# sourceMappingURL=useAdmin-BFNsSzdZ.js.map
