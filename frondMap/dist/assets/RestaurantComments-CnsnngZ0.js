import{r as t,j as e,p as we,u as De,bc as Ue,cb as Le,ba as O,be as se,dQ as Pe,ak as ae,bA as Te,X as te,bg as le,aK as ze,bn as Me,bf as Ee}from"./vendor-react-uzPisSBl.js";import{B as V,u as $e,a3 as Be,M as qe,z as Fe,s as ne,V as re,W as ie,X as ce,g as oe,h as m,ad as me,I as de,C as N,n as S,a7 as He,a8 as Oe,a9 as Ve,aa as We,ab as Xe,m as Ke,A as xe,q as ue,r as he,t as pe,v as ge,w as je,x as ve,y as fe}from"./index-DMJMYAbQ.js";import{u as Qe,a as Ge,b as Je,R as Ye}from"./ReportDialog-CSdhLs41.js";import{u as Ze}from"./useSensitiveWords-d8qNHo7t.js";import{T as es}from"./TranslateButton-BxIGQqeD.js";import{I as ss}from"./ImagePreviewModal-BJ7U4vyA.js";import{H as as}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-BoRSXImz.js";import"./input-otp-vc7dto_N.js";const ts=({text:d,className:v})=>{const[r,h]=t.useState(null);return e.jsxs("div",{className:v,children:[e.jsx("p",{className:"text-xs sm:text-sm text-foreground break-words",children:r||d}),e.jsx(es,{text:d,onTranslation:h,className:"mt-0.5"})]})},Ne=[{value:"0-5",label:"0-5€"},{value:"5-10",label:"5-10€"},{value:"10-15",label:"10-15€"},{value:"15-20",label:"15-20€"},{value:"20-25",label:"20-25€"},{value:"25-30",label:"25-30€"},{value:"30-40",label:"30-40€"},{value:"40-50",label:"40-50€"},{value:"50+",label:"50€+"}],be=t.memo(({imageUrl:d,onPreview:v})=>{const{t:r}=we(),[h,a]=t.useState(!1),[n,o]=t.useState(!1),R=t.useCallback(i=>{const w=i.currentTarget,x=w.naturalHeight/w.naturalWidth;a(x>1.5),o(!0)},[]);return e.jsxs("div",{className:"relative mt-2 inline-block max-w-full sm:max-w-sm w-full",children:[e.jsx("img",{src:d,alt:"Comment attachment",className:"rounded-lg w-full max-h-[300px] sm:max-h-[400px] object-cover object-top cursor-pointer hover:opacity-90 transition-opacity",onClick:v,onLoad:R}),n&&h&&e.jsx(V,{variant:"secondary",className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-1.5 py-0.5",children:r("community.longImage","长图")})]})});be.displayName="CommentImage";const gs=({restaurantId:d,targetId:v,targetType:r="restaurant"})=>{const h=v||d||"",{t:a}=we(),{user:n}=$e(),{data:o}=Be(),{isAdmin:R}=qe(),{toast:i}=Fe(),w=De(),[x,W]=t.useState(""),[p,X]=t.useState(0),[Ce,K]=t.useState(0),[b,Q]=t.useState(""),[ye,A]=t.useState(null),[g,_]=t.useState(""),[D,U]=t.useState(null),[L,P]=t.useState(null),[T,z]=t.useState(null),[M,E]=t.useState(null),[u,C]=t.useState(!1),[ke,G]=t.useState(!1),[$,B]=t.useState(null),[J,y]=t.useState(null),{data:q,isLoading:Ie}=Qe(h,r),j=Ge(),Y=Je(),{checkContent:k}=Ze(),I=t.useCallback(async s=>{try{const c=s.name.split(".").pop(),f=`${`${n?.id}-${Date.now()}.${c}`}`,{error:ee,data:ls}=await ne.storage.from("comment-images").upload(f,s);if(ee)throw ee;const{data:{publicUrl:_e}}=ne.storage.from("comment-images").getPublicUrl(f);return _e}catch(c){return console.error("Error uploading image:",c),i({title:a("common.error"),description:a("restaurant.imageUploadFailed"),variant:"destructive"}),null}},[n,i,a]),Z=t.useCallback((s,c=!1)=>{const l=s.target.files?.[0];if(l){if(l.size>5*1024*1024){i({title:a("common.error"),description:a("restaurant.imageTooLarge"),variant:"destructive"});return}c?(z(l),E(URL.createObjectURL(l))):(U(l),P(URL.createObjectURL(l)))}},[i,a]),F=t.useCallback((s=!1)=>{s?(z(null),E(null)):(U(null),P(null))},[]),Se=t.useCallback(async()=>{if(!x.trim()||!n)return;if(o?.is_muted){i({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(k(x).hasSensitive){i({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}if(r==="restaurant"&&!p){i({title:a("common.hint","提示"),description:a("toast.pleaseSelectRating"),variant:"warning"});return}C(!0);let c;if(D){const l=await I(D);l&&(c=l)}await j.mutateAsync({targetId:h,targetType:r,content:x,ratingValue:r==="restaurant"?p:void 0,priceRange:r==="restaurant"&&b?b:void 0,imageUrl:c}),W(""),X(0),Q(""),U(null),P(null),C(!1)},[x,n,o,r,p,i,a,D,I,j,d,b,k]),Re=t.useCallback(async s=>{if(!g.trim()||!n)return;if(o?.is_muted){i({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(k(g).hasSensitive){i({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}C(!0);let l;if(T){const f=await I(T);f&&(l=f)}await j.mutateAsync({targetId:h,targetType:r,content:g,parentId:s,imageUrl:l}),_(""),A(null),z(null),E(null),C(!1)},[g,n,o,T,I,j,d,r,k,i,a]),Ae=t.useCallback(async s=>{await Y.mutateAsync(s),B(null)},[Y]),H=t.memo(({comment:s,isReply:c=!1})=>e.jsxs("div",{className:`flex gap-2 sm:gap-3 ${c?"ml-8 sm:ml-12 mt-3":""}`,children:[e.jsxs(re,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(ie,{src:s.profiles?.avatar_url}),e.jsx(ce,{className:"text-xs sm:text-sm",children:s.profiles?.display_name?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-xs sm:text-sm truncate",children:s.profiles?.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0",children:as(new Date(s.created_at),{addSuffix:!0})}),s.edited&&e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:["(",a("restaurant.edited"),")"]}),n?.id===s.user_id&&s.moderation_status==="pending"&&e.jsxs(V,{variant:"outline",className:"text-yellow-600 border-yellow-500 bg-yellow-50 dark:bg-yellow-950/30 text-xs py-0 h-5",children:[e.jsx(Ue,{className:"w-3 h-3 mr-1"}),a("restaurant.commentPending","审核中")]}),n?.id===s.user_id&&s.moderation_status==="flagged"&&e.jsxs(V,{variant:"outline",className:"text-destructive border-destructive bg-destructive/10 text-xs py-0 h-5",children:[e.jsx(Le,{className:"w-3 h-3 mr-1"}),a("restaurant.commentFailed","发送失败")]})]}),!c&&s.rating_value&&e.jsxs("div",{className:"flex items-center gap-3 mt-1 mb-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(l=>e.jsx(O,{className:oe("w-4 h-4",l<=s.rating_value?"fill-accent text-accent":"text-muted-foreground")},l))}),s.price_range&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(se,{className:"w-3 h-3"}),e.jsx("span",{children:Ne.find(l=>l.value===s.price_range)?.label})]})]}),e.jsx(ts,{text:s.content,className:"mt-1"}),s.image_url&&e.jsx(be,{imageUrl:s.image_url,onPreview:()=>y(s.image_url)}),e.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-2",children:[!c&&n&&!o?.is_muted&&e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>A(s.id),className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Pe,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("restaurant.reply")})]}),(n?.id===s.user_id||R)&&e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>B(s.id),className:"h-7 text-xs text-destructive hover:text-destructive px-2 sm:px-3",children:[e.jsx(ae,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("common.delete")})]}),n?.id!==s.user_id&&e.jsx(Ye,{targetType:"comment",targetId:s.id,onLoginRequired:()=>G(!0),trigger:e.jsxs(m,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Te,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("report.title")})]})})]}),ye===s.id&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(me,{value:g,onChange:l=>_(l.target.value),placeholder:a("restaurant.writeReply"),className:"min-h-[80px] text-sm"}),M&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:M,alt:"Preview",className:"w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>y(M)}),e.jsx(m,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>F(!0),children:e.jsx(te,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex sm:flex-col gap-2",children:[e.jsx(m,{size:"sm",onClick:()=>Re(s.id),disabled:!g.trim()||u,className:"text-xs",children:a(u?"common.loading":"restaurant.reply")}),e.jsx(de,{type:"file",accept:"image/*",onChange:l=>Z(l,!0),className:"hidden",id:`reply-image-${s.id}`,disabled:u}),e.jsxs(m,{size:"sm",variant:"outline",onClick:()=>document.getElementById(`reply-image-${s.id}`)?.click(),disabled:u,className:"text-xs sm:px-3",children:[e.jsx(le,{className:"h-4 w-4 sm:mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(m,{size:"sm",variant:"outline",onClick:()=>{A(null),_(""),F(!0)},className:"text-xs",children:a("common.cancel")})]})]})}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3",children:s.replies.map(l=>e.jsx(H,{comment:l,isReply:!0},l.id))})]})]}));return H.displayName="CommentItem",Ie?e.jsx("div",{className:"text-center py-8",children:a("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"w-4 sm:w-5 h-4 sm:h-5"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold",children:[a("restaurant.reviews")," (",q?.length||0,")"]})]}),n?o?.is_muted?e.jsx(N,{className:"border-yellow-300 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(S,{className:"py-4 sm:py-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex items-center gap-3 text-yellow-600 dark:text-yellow-400",children:[e.jsx(Me,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:a("restaurant.youAreMutedNotice")})]})})}):e.jsx(N,{children:e.jsx(S,{className:"pt-4 sm:pt-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex gap-2 sm:gap-3",children:[e.jsxs(re,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(ie,{src:o?.avatar_url||void 0}),e.jsx(ce,{className:"text-xs sm:text-sm",children:o?.display_name?.charAt(0).toUpperCase()||n?.email?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 space-y-2 sm:space-y-3 min-w-0",children:[r==="restaurant"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4 text-accent"}),a("restaurant.rating")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onMouseEnter:()=>K(s),onMouseLeave:()=>K(0),onClick:()=>X(s),className:"transition-transform hover:scale-110",children:e.jsx(O,{className:oe("w-7 h-7 cursor-pointer transition-colors",s<=(Ce||p)?"fill-accent text-accent":"text-muted-foreground hover:text-accent")})},s)),p>0&&e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",p,"/5)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"}),a("restaurant.priceRange")]}),e.jsxs(He,{value:b,onValueChange:Q,children:[e.jsx(Oe,{className:"w-full",children:e.jsx(Ve,{placeholder:a("restaurant.selectPriceRange")})}),e.jsx(We,{className:"bg-background",children:Ne.map(s=>e.jsx(Xe,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsx(me,{value:x,onChange:s=>W(s.target.value),placeholder:a("restaurant.writeComment"),className:"min-h-[80px] sm:min-h-[100px] text-sm"}),L&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:L,alt:"Preview",className:"w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>y(L)}),e.jsx(m,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>F(!1),children:e.jsx(te,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(de,{type:"file",accept:"image/*",onChange:s=>Z(s,!1),className:"hidden",id:"comment-image",disabled:u}),e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>document.getElementById("comment-image")?.click(),disabled:u,className:"text-xs",children:[e.jsx(le,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(m,{onClick:Se,disabled:!x.trim()||j.isPending||u,size:"sm",className:"text-xs",children:u||j.isPending?a("common.loading"):a("restaurant.postComment")})]})]})]})})}):e.jsx(N,{children:e.jsx(S,{className:"py-4 sm:py-6 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:e.jsx(Ee,{i18nKey:"restaurant.signInToComment",components:{login:e.jsx("a",{href:"/auth",className:"text-primary hover:underline font-medium"})}})})}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:q?.map(s=>e.jsx(N,{children:e.jsx(Ke,{className:"p-3 sm:p-6",children:e.jsx(H,{comment:s})})},s.id))}),q?.length===0&&e.jsx(N,{children:e.jsx(S,{className:"py-8 sm:py-12 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.noComments")})})]}),e.jsx(xe,{open:ke,onOpenChange:G,children:e.jsxs(ue,{children:[e.jsxs(he,{children:[e.jsx(pe,{children:a("activities.loginRequired")}),e.jsx(ge,{children:a("activities.loginRequiredMessage")})]}),e.jsxs(je,{children:[e.jsx(ve,{children:a("common.cancel")}),e.jsx(fe,{onClick:()=>w("/auth"),children:a("activities.goToLogin")})]})]})}),e.jsx(xe,{open:!!$,onOpenChange:s=>!s&&B(null),children:e.jsxs(ue,{className:"max-w-sm",children:[e.jsxs(he,{children:[e.jsx("div",{className:"mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(ae,{className:"h-7 w-7 text-destructive"})}),e.jsx(pe,{className:"text-center",children:a("restaurant.deleteComment")}),e.jsx(ge,{className:"text-center",children:a("restaurant.confirmDelete")})]}),e.jsxs(je,{className:"sm:justify-center gap-2",children:[e.jsx(ve,{className:"sm:w-24",children:a("common.cancel")}),e.jsx(fe,{onClick:()=>$&&Ae($),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 sm:w-24",children:a("common.delete")})]})]})}),e.jsx(ss,{imageUrl:J||"",isOpen:!!J,onClose:()=>y(null)})]})};export{gs as default};
//# sourceMappingURL=RestaurantComments-CnsnngZ0.js.map
