import{j as e}from"./vendor-ui-DAmPMpEA.js";import{r as A,L as R}from"./vendor-react-iAJ0IrSD.js";import{c as B,n as D,s as g,aj as re,C,k as M,r as p,a1 as q,X as I,I as ne,j as ie,t as le,ac as de,B as x,Y as U,Z as $,_ as K,U as V,D as ce,a as oe,b as me,d as he,$ as xe,S as ue}from"./index-Do1W_89N.js";import{C as O}from"./checkbox-Do5gfcxP.js";import{T as pe,a as ge,b as T}from"./tabs-cuGeNK5n.js";import{T as je,a as ve,b as X,c as N,d as fe,e as _}from"./table-Bc8sHo2y.js";import{a as Ne,u as E,b as L}from"./vendor-query-BlSVl3IQ.js";import{u as _e}from"./useLocalizedContent-tJ7i_ycU.js";import{u as ye}from"./vendor-i18n-DxKeo2S1.js";import{T as we}from"./triangle-alert-DbNBpwMv.js";import{S as be}from"./search-DsePuv7P.js";import{E as Y}from"./external-link-CmznQ2n3.js";import{E as ke}from"./eye-BYP9cNA5.js";import{S as Ce}from"./star-DGsfeJZk.js";import{f as z}from"./format-DMNSJgyu.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-KNAP0qdW.js";import"./startOfDay-D6pD3B6q.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=B("ArchiveRestore",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h2",key:"tvwodi"}],["path",{d:"M20 8v11a2 2 0 0 1-2 2h-2",key:"1gkqxj"}],["path",{d:"m9 15 3-3 3 3",key:"1pd0qc"}],["path",{d:"M12 12v9",key:"192myk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=B("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=B("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]),Se=(a="pending")=>Ne({queryKey:["admin-comments",a],queryFn:async()=>{let i=g.from("comments").select("*").is("parent_id",null).order("created_at",{ascending:!1}).limit(200);a==="archived"?i=i.eq("archived",!0):(i=i.or("archived.is.null,archived.eq.false"),a==="pending"?i=i.in("moderation_status",["pending","flagged"]):a==="approved"?i=i.eq("moderation_status","approved"):a==="rejected"&&(i=i.eq("moderation_status","rejected")));const{data:t,error:l}=await i;if(l)throw l;if(!t||t.length===0)return[];const c=[...new Set(t.map(n=>n.user_id))],{data:y}=await g.rpc("get_public_profiles",{user_ids:c}),o=new Map((y||[]).map(n=>[n.id,{display_name:n.display_name,avatar_url:n.avatar_url}])),h=t.filter(n=>n.target_type==="restaurant").map(n=>n.target_id),r=t.filter(n=>n.target_type==="activity").map(n=>n.target_id),f=new Map,j=new Map;if(h.length>0){const{data:n}=await g.from("restaurants").select("id, name, name_en, name_pt").in("id",h);n?.forEach(d=>{f.set(d.id,{name:d.name,name_en:d.name_en||void 0,name_pt:d.name_pt||void 0})})}if(r.length>0){const{data:n}=await g.from("activities").select("id, title_zh, title_en, title_pt").in("id",r);n?.forEach(d=>{j.set(d.id,{title_zh:d.title_zh,title_en:d.title_en,title_pt:d.title_pt})})}return t.map(n=>{let d="",w,b;if(n.target_type==="restaurant"){const u=f.get(n.target_id);d=u?.name||"Unknown Restaurant",w=u?.name_en,b=u?.name_pt}else if(n.target_type==="activity"){const u=j.get(n.target_id);d=u?.title_zh||"Unknown Activity",w=u?.title_en,b=u?.title_pt}return{...n,risk_reasons:Array.isArray(n.risk_reasons)?n.risk_reasons:[],profiles:o.get(n.user_id),target_name:d,target_name_en:w,target_name_pt:b}})}}),Ae=()=>{const{toast:a}=D(),i=E();return L({mutationFn:async({commentId:t,action:l})=>{const{data:{user:c}}=await g.auth.getUser();if(!c)throw new Error("Not authenticated");const y={approve:"approved",reject:"rejected",flag:"flagged"},{error:o}=await g.from("comments").update({moderation_status:y[l],reviewed_by:c.id,reviewed_at:new Date().toISOString()}).eq("id",t);if(o)throw o},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-comments"]}),a({title:"审核完成",description:"评论状态已更新"})},onError:()=>{a({title:"操作失败",description:"无法更新评论状态",variant:"destructive"})}})},qe=()=>{const{toast:a}=D(),i=E();return L({mutationFn:async({commentIds:t,action:l})=>{const{data:{user:c}}=await g.auth.getUser();if(!c)throw new Error("Not authenticated");const y={approve:"approved",reject:"rejected"},{error:o}=await g.from("comments").update({moderation_status:y[l],reviewed_by:c.id,reviewed_at:new Date().toISOString()}).in("id",t);if(o)throw o},onSuccess:(t,l)=>{i.invalidateQueries({queryKey:["admin-comments"]}),a({title:"批量审核完成",description:`已${l.action==="approve"?"通过":"拒绝"} ${l.commentIds.length} 条评论`})},onError:()=>{a({title:"批量操作失败",description:"无法更新评论状态",variant:"destructive"})}})},Ie=()=>{const{toast:a}=D(),i=E();return L({mutationFn:async({commentId:t,archived:l})=>{const{error:c}=await g.from("comments").update({archived:l}).eq("id",t);if(c)throw c},onSuccess:(t,l)=>{i.invalidateQueries({queryKey:["admin-comments"]}),a({title:l.archived?"已归档":"已取消归档",description:l.archived?"评论已移至归档":"评论已恢复到列表"})},onError:()=>{a({title:"操作失败",description:"无法更新归档状态",variant:"destructive"})}})},Te=()=>{const{toast:a}=D(),i=E();return L({mutationFn:async({commentIds:t,archived:l})=>{const{error:c}=await g.from("comments").update({archived:l}).in("id",t);if(c)throw c},onSuccess:(t,l)=>{i.invalidateQueries({queryKey:["admin-comments"]}),a({title:l.archived?"批量归档完成":"批量取消归档完成",description:`已${l.archived?"归档":"恢复"} ${l.commentIds.length} 条评论`})},onError:()=>{a({title:"批量操作失败",description:"无法更新归档状态",variant:"destructive"})}})},G=a=>a<=30?"bg-green-500/10 text-green-600 border-green-500/20":a<=60?"bg-yellow-500/10 text-yellow-600 border-yellow-500/20":"bg-red-500/10 text-red-600 border-red-500/20",J=a=>{switch(a){case"approved":return e.jsx(p,{variant:"outline",className:"bg-green-500/10 text-green-600 border-green-500/20",children:"已通过"});case"pending":return e.jsx(p,{variant:"outline",className:"bg-yellow-500/10 text-yellow-600 border-yellow-500/20",children:"待审核"});case"flagged":return e.jsx(p,{variant:"outline",className:"bg-orange-500/10 text-orange-600 border-orange-500/20",children:"已标记"});case"rejected":return e.jsx(p,{variant:"outline",className:"bg-red-500/10 text-red-600 border-red-500/20",children:"已拒绝"});default:return e.jsx(p,{variant:"secondary",children:a})}},W=a=>({spam:"垃圾信息",offensive:"不当言论",harassment:"骚扰攻击",fake_review:"虚假评论",flooding:"刷屏",irrelevant:"无关内容",sensitive_word_detected:"敏感词",parse_error:"解析错误"})[a]||a,Ge=()=>{const{t:a,i18n:i}=ye();_e();const[t,l]=A.useState("pending"),[c,y]=A.useState(""),[o,h]=A.useState([]),[r,f]=A.useState(null),{data:j,isLoading:n}=Se(t),d=Ae(),w=qe(),b=Ie(),u=Te(),k=j?.filter(s=>{if(!c)return!0;const m=c.toLowerCase();return s.content.toLowerCase().includes(m)||s.profiles?.display_name?.toLowerCase().includes(m)||s.target_name?.toLowerCase().includes(m)}),ee=s=>{h(s?k?.map(m=>m.id)||[]:[])},se=(s,m)=>{h(m?S=>[...S,s]:S=>S.filter(ae=>ae!==s))},F=s=>{o.length!==0&&w.mutate({commentIds:o,action:s},{onSuccess:()=>h([])})},te=s=>{o.length!==0&&u.mutate({commentIds:o,archived:s},{onSuccess:()=>h([])})},P=s=>s.target_type==="restaurant"?`/restaurant/${s.target_id}`:s.target_type==="activity"?`/activity/${s.target_id}`:"#",Q=s=>i.language==="en"&&s.target_name_en?s.target_name_en:i.language==="pt"&&s.target_name_pt?s.target_name_pt:s.target_name||"",v={total:j?.length||0,pending:j?.filter(s=>s.moderation_status==="pending").length||0,flagged:j?.filter(s=>s.moderation_status==="flagged").length||0,approved:j?.filter(s=>s.moderation_status==="approved").length||0,rejected:j?.filter(s=>s.moderation_status==="rejected").length||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(re,{className:"h-6 w-6"}),a("admin.comments.title","评论管理")]}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.comments.description","审核和管理用户评论，防止恶意内容")})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(C,{children:e.jsxs(M,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:v.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"总评论"})]})}),e.jsx(C,{className:"border-yellow-500/20",children:e.jsxs(M,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:v.pending}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"待审核"})]})}),e.jsx(C,{className:"border-orange-500/20",children:e.jsxs(M,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:v.flagged}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已标记"})]})}),e.jsx(C,{className:"border-green-500/20",children:e.jsxs(M,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:v.approved}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已通过"})]})}),e.jsx(C,{className:"border-red-500/20",children:e.jsxs(M,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:v.rejected}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已拒绝"})]})})]}),e.jsxs(pe,{value:t,onValueChange:s=>{l(s),h([])},className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs(ge,{children:[e.jsxs(T,{value:"pending",className:"gap-1",children:[e.jsx(we,{className:"h-4 w-4"}),"待审核",v.pending+v.flagged>0&&e.jsx(p,{variant:"secondary",className:"ml-1 h-5 px-1.5",children:v.pending+v.flagged})]}),e.jsxs(T,{value:"approved",className:"gap-1",children:[e.jsx(q,{className:"h-4 w-4"}),"已通过"]}),e.jsxs(T,{value:"rejected",className:"gap-1",children:[e.jsx(I,{className:"h-4 w-4"}),"已拒绝"]}),e.jsxs(T,{value:"archived",className:"gap-1",children:[e.jsx(H,{className:"h-4 w-4"}),"已归档"]})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ne,{placeholder:a("admin.comments.search","搜索评论..."),value:c,onChange:s=>y(s.target.value),className:"pl-9"})]})]}),e.jsxs(C,{children:[e.jsxs(ie,{children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2",children:e.jsxs("div",{children:[e.jsxs(le,{children:[t==="pending"&&"审核评论列表",t==="approved"&&"已通过评论",t==="rejected"&&"已拒绝评论",t==="archived"&&"已归档评论"]}),e.jsxs(de,{children:[t==="pending"&&"待审核和已标记的评论，需要人工审核处理",t==="approved"&&"已审核通过的评论",t==="rejected"&&"已拒绝的评论，不会显示给用户",t==="archived"&&"已归档的评论，用于保持列表简洁"]})]})}),o.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mt-4 p-2 bg-muted rounded-lg flex-wrap",children:[e.jsxs("span",{className:"text-sm",children:["已选择 ",o.length," 项"]}),t==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>F("approve"),disabled:w.isPending,children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"批量通过"]}),e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>F("reject"),disabled:w.isPending,children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"批量拒绝"]})]}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>te(t!=="archived"),disabled:u.isPending,children:t==="archived"?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"批量恢复"]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-4 w-4 mr-1"}),"批量归档"]})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>h([]),children:"取消选择"})]})]}),e.jsx(M,{children:n?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"加载中..."}):k&&k.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(je,{children:[e.jsx(ve,{children:e.jsxs(X,{children:[e.jsx(N,{className:"w-12",children:e.jsx(O,{checked:k.length>0&&o.length===k.length,onCheckedChange:ee})}),e.jsx(N,{className:"w-16",children:"风险"}),e.jsx(N,{children:"评论内容"}),e.jsx(N,{children:"用户"}),e.jsx(N,{children:"目标"}),e.jsx(N,{children:"状态"}),e.jsx(N,{children:"时间"}),e.jsx(N,{className:"text-right",children:"操作"})]})}),e.jsx(fe,{children:k.map(s=>e.jsxs(X,{className:s.risk_score>60?"bg-red-500/5":s.risk_score>30?"bg-yellow-500/5":"",children:[e.jsx(_,{children:e.jsx(O,{checked:o.includes(s.id),onCheckedChange:m=>se(s.id,m)})}),e.jsx(_,{children:e.jsx(p,{variant:"outline",className:G(s.risk_score),children:s.risk_score})}),e.jsxs(_,{className:"max-w-xs",children:[e.jsx("div",{className:"truncate",title:s.content,children:s.content}),s.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:s.risk_reasons.map((m,S)=>e.jsx(p,{variant:"secondary",className:"text-xs",children:W(m)},S))})]}),e.jsx(_,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{className:"h-6 w-6",children:[e.jsx($,{src:s.profiles?.avatar_url}),e.jsx(K,{children:e.jsx(V,{className:"h-3 w-3"})})]}),e.jsx("span",{className:"text-sm truncate max-w-[100px]",children:s.profiles?.display_name||"Unknown"})]})}),e.jsx(_,{children:e.jsxs(R,{to:P(s),className:"flex items-center gap-1 text-sm hover:underline text-primary",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:Q(s)}),e.jsx(Y,{className:"h-3 w-3"})]})}),e.jsx(_,{children:J(s.moderation_status)}),e.jsx(_,{className:"text-sm text-muted-foreground",children:z(new Date(s.created_at),"MM-dd HH:mm")}),e.jsx(_,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>f(s),title:"查看详情",children:e.jsx(ke,{className:"h-4 w-4"})}),t==="pending"&&s.moderation_status!=="approved"&&e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>d.mutate({commentId:s.id,action:"approve"}),disabled:d.isPending,title:"通过",className:"text-green-600 hover:text-green-700",children:e.jsx(q,{className:"h-4 w-4"})}),t==="pending"&&s.moderation_status!=="rejected"&&e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>d.mutate({commentId:s.id,action:"reject"}),disabled:d.isPending,title:"拒绝",className:"text-red-600 hover:text-red-700",children:e.jsx(I,{className:"h-4 w-4"})}),e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>b.mutate({commentId:s.id,archived:t!=="archived"}),disabled:b.isPending,title:t==="archived"?"恢复":"归档",className:"text-muted-foreground hover:text-foreground",children:t==="archived"?e.jsx(Z,{className:"h-4 w-4"}):e.jsx(H,{className:"h-4 w-4"})})]})})]},s.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:c?"没有找到匹配的评论":"暂无评论"})})]})]}),e.jsx(ce,{open:!!r,onOpenChange:()=>f(null),children:e.jsxs(oe,{className:"max-w-2xl",children:[e.jsxs(me,{children:[e.jsx(he,{children:"评论详情"}),e.jsx(xe,{children:"查看评论完整信息和 AI 分析结果"})]}),r&&e.jsx(ue,{className:"max-h-[60vh]",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[e.jsxs(U,{children:[e.jsx($,{src:r.profiles?.avatar_url}),e.jsx(K,{children:e.jsx(V,{className:"h-4 w-4"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.profiles?.display_name||"Unknown"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:z(new Date(r.created_at),"yyyy-MM-dd HH:mm:ss")})]}),r.rating_value&&e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[e.jsx(Ce,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),e.jsx("span",{children:r.rating_value})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论内容"}),e.jsx("div",{className:"p-3 bg-muted rounded-lg whitespace-pre-wrap",children:r.content})]}),r.image_url&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论图片"}),e.jsx("img",{src:r.image_url,alt:"Comment",className:"max-w-full h-auto rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论目标"}),e.jsxs(R,{to:P(r),className:"flex items-center gap-2 p-3 bg-muted rounded-lg hover:bg-muted/80",children:[e.jsxs("span",{children:[r.target_type==="restaurant"?"餐厅":"活动",":"]}),e.jsx("span",{className:"text-primary",children:Q(r)}),e.jsx(Y,{className:"h-4 w-4"})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4"}),"AI 分析结果"]}),e.jsxs("div",{className:"p-3 bg-muted rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"风险评分:"}),e.jsxs(p,{variant:"outline",className:G(r.risk_score),children:[r.risk_score,"/100"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"审核状态:"}),J(r.moderation_status)]}),r.risk_reasons.length>0&&e.jsxs("div",{children:[e.jsx("span",{children:"检测问题:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:r.risk_reasons.map((s,m)=>e.jsx(p,{variant:"secondary",children:W(s)},m))})]}),r.ai_reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["AI 审核时间: ",z(new Date(r.ai_reviewed_at),"yyyy-MM-dd HH:mm:ss")]}),r.reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["人工审核时间: ",z(new Date(r.reviewed_at),"yyyy-MM-dd HH:mm:ss")]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[r.moderation_status!=="approved"&&e.jsxs(x,{onClick:()=>{d.mutate({commentId:r.id,action:"approve"},{onSuccess:()=>f(null)})},disabled:d.isPending,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"通过"]}),r.moderation_status!=="rejected"&&e.jsxs(x,{variant:"destructive",onClick:()=>{d.mutate({commentId:r.id,action:"reject"},{onSuccess:()=>f(null)})},disabled:d.isPending,children:[e.jsx(I,{className:"h-4 w-4 mr-2"}),"拒绝"]}),e.jsx(x,{variant:"outline",onClick:()=>f(null),children:"关闭"})]})]})})]})})]})};export{Ge as default};
//# sourceMappingURL=AdminComments-DIvHWBCv.js.map
