import{u as me,p as xe,r as n,j as e,ba as L,be as ue,bs as he,bt as pe,aw as fe,ay as ge,bg as T,bf as Q,bi as ve}from"./vendor-react-DImbKuZP.js";import{f as X}from"./textFormatting-C5ODvpSJ.js";import{I as be,J as je,q as p,B as o,C as J,Y as Ne,s as we}from"./index-_G3CuCzp.js";import{P as ye,a as ke,b as Ce}from"./popover-CLT125d5.js";import{u as Re,b as Se}from"./useRestaurants-DXIIBXS_.js";import{c as Fe,g as ze}from"./geolocation-YPf7LJYy.js";import{u as Le,R as Te}from"./useActivityRestaurantCounts-lIkBRCs4.js";import{u as _e}from"./useLocalizedContent-B2SRIfSp.js";import{u as Me}from"./useActivities-B-dkIh_c.js";import{l as $e}from"./xiaoxiong-logo-clean-D2n3VLi4.js";import{L as Ae}from"./LocationPermissionDialog-BDLW4gbZ.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-vwQGbBim.js";import"./vendor-supabase-CRxszhSs.js";import"./vendor-map-CvE3ASYw.js";import"./map-icon-DR07RZr_.js";const W=({restaurant:y,language:t})=>{const[m,k]=n.useState(999),j=n.useRef(null),h=y.type.slice(0,3).map((r,d)=>({key:`type-${d}`,label:r,variant:"secondary",color:void 0}));n.useEffect(()=>{const r=()=>{if(!j.current)return;const N=j.current,u=Array.from(N.querySelectorAll(".tag-badge"));if(u.length===0){setTimeout(r,50);return}const f=u[0]?.offsetTop;let l=u.length;for(let g=0;g<u.length;g++)if(u[g].offsetTop>f){l=g;break}l<u.length&&(l=Math.max(1,l-1)),k(l)};k(999);const d=setTimeout(r,100);return window.addEventListener("resize",r),()=>{clearTimeout(d),window.removeEventListener("resize",r)}},[h.length,y.id]);const _=h.slice(0,m),x=h.length>m;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{ref:j,className:"flex gap-1.5 flex-wrap flex-1",children:_.map(r=>e.jsx(o,{variant:r.variant,className:"text-xs font-medium whitespace-nowrap tag-badge",style:r.color?{backgroundColor:r.color,color:"white"}:void 0,children:r.label},r.key))}),x&&e.jsxs(ye,{children:[e.jsx(ke,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"sm",className:"h-6 px-2 text-muted-foreground hover:text-foreground flex-shrink-0",children:e.jsx(ve,{className:"h-4 w-4"})})}),e.jsx(Ce,{className:"w-80",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:h.map(r=>e.jsx(o,{variant:r.variant,className:"text-xs font-medium",style:r.color?{backgroundColor:r.color,color:"white"}:void 0,children:r.label},r.key))})})]})]})},Ke=()=>{const y=me(),{t,i18n:m}=xe(),{toast:k}=be(),{localizeRestaurant:j}=_e(),[h,_]=n.useState(""),[x,r]=n.useState([]),[d,N]=n.useState(null),[u,f]=n.useState([]),[l,g]=n.useState(null),[i,Y]=n.useState(null),[M,Z]=n.useState(!1),[C,G]=n.useState(!1),[R,H]=n.useState(!1),v=n.useRef(null),S=n.useRef(null),$=n.useRef({}),[q,K]=n.useState(null),[A,ee]=n.useState(!1),[se,E]=n.useState(!1),[D,ae]=n.useState(!1),{data:te,isLoading:re}=Re(h,x.length>0?x.join(","):void 0),{data:F=[]}=Se(),{data:ne=[]}=Me(),{data:le={}}=Le(),w=ne.filter(s=>(le[s.id]||0)>0),P=s=>{r(a=>a.includes(s)?a.filter(c=>c!==s):[...a,s])},V=()=>{E(!0)},ie=async()=>{E(!1);try{const s=await ze();Y({lat:s.coords.latitude,lng:s.coords.longitude}),k({title:t("restaurants.locationEnabled"),description:t("restaurants.sortByDistance")})}catch(s){console.error("Location error:",s)}},z=s=>{g(s),s&&!i&&V()},U=async s=>{if(d===s)N(null),f([]);else{N(s);const{data:a,error:c}=await we.from("activity_restaurants").select("restaurant_id").eq("activity_id",s);c?(console.error("Error fetching activity restaurants:",c),f([])):f(a.map(de=>de.restaurant_id))}},O=te?.map(s=>{const a=j(s);if(i){const c=Fe(i.lat,i.lng,s.lat,s.lng);return{...a,distance:c}}return a})||[],I=d?O.filter(s=>u.includes(s.id)):O,b=l&&i?I.filter(s=>s.distance&&s.distance<=l).sort((s,a)=>(s.distance||0)-(a.distance||0)):i?I.sort((s,a)=>(s.distance||0)-(a.distance||0)):I.sort((s,a)=>(a.rating||0)-(s.rating||0)),B=s=>{y(`/restaurant/${s.id}`)},oe=s=>{K(s.id);const a=$.current[s.id];a&&a.scrollIntoView({behavior:"smooth",block:"center"})},ce=()=>{const s=document.getElementById("map-container");if(s)if(M)document.exitFullscreen&&document.exitFullscreen();else{if(v.current){const a=v.current.getCenter(),c=v.current.getZoom();S.current={center:[a.lng,a.lat],zoom:c}}s.requestFullscreen&&s.requestFullscreen()}};return n.useEffect(()=>{const s=()=>{const a=!!document.fullscreenElement;Z(a),!a&&S.current&&v.current&&setTimeout(()=>{v.current?.jumpTo({center:S.current.center,zoom:S.current.zoom})},100)};return document.addEventListener("fullscreenchange",s),()=>{document.removeEventListener("fullscreenchange",s)}},[]),e.jsxs("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:[e.jsxs("div",{className:"container mx-auto max-w-7xl lg:h-[100dvh] lg:flex lg:flex-col",children:[e.jsxs("div",{className:"mb-6 flex-shrink-0 text-left",children:[e.jsx("h1",{className:"text-4xl font-bold mb-2 text-primary",children:t("nav.mapView")}),e.jsx("p",{className:"text-muted-foreground",children:t("map.subtitle")})]}),e.jsxs("div",{className:"mb-6 space-y-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"flex-1 max-w-md",children:e.jsx(je,{placeholder:t("restaurants.search"),value:h,onChange:s=>_(s.target.value),className:"h-11 bg-background/60 backdrop-blur-sm border-primary/20 focus:border-primary"})}),e.jsxs("div",{className:"flex gap-2 md:contents",children:[e.jsxs(p,{variant:i?"default":"outline",onClick:i?void 0:V,className:"flex-1 md:flex-initial gap-2 h-11 md:px-6",children:[e.jsx(L,{className:`w-4 h-4 ${i?"animate-pulse":""}`}),e.jsx("span",{className:"md:hidden",children:t("restaurants.getLocationMobile")}),e.jsx("span",{className:"hidden md:inline",children:t(i?"restaurants.locationEnabled":"restaurants.getLocation")})]}),e.jsxs(p,{variant:A?"default":"outline",onClick:()=>ee(!A),className:"flex-1 md:flex-initial gap-2 h-11 md:px-6",children:[e.jsx(ue,{className:"w-4 h-4"}),t("restaurants.filter")]})]})]}),A&&e.jsxs("div",{className:"space-y-3 bg-card/50 backdrop-blur-sm rounded-lg p-4 border border-border/50 animate-fade-in",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-sm font-semibold text-foreground",children:[t("restaurants.restaurantTypes"),":"]}),x.length>0&&e.jsx(o,{variant:"outline",className:"cursor-pointer hover:bg-destructive hover:text-destructive-foreground hover:scale-105 transition-all duration-200 px-2 py-0 text-xs h-5",onClick:()=>r([]),children:t("common.actions.clearFilter")}),F.length>8&&e.jsx(p,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-primary hover:text-primary/80 ml-auto hidden sm:flex transition-all duration-200",onClick:()=>G(!C),children:t(C?"common.showLess":"common.showMore")})]}),e.jsxs("div",{className:"relative overflow-hidden",children:[e.jsx("div",{className:`hidden sm:flex gap-2 flex-wrap transition-all duration-300 ease-out ${C?"animate-expand-height":""}`,children:(C?F:F.slice(0,8)).map((s,a)=>e.jsx(o,{variant:x.includes(s)?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap hover:scale-105 active:animate-tag-select ${x.includes(s)?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>P(s),children:s},s))}),e.jsxs("div",{className:"sm:hidden relative -mx-1 px-1",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory scroll-smooth",children:F.map((s,a)=>e.jsx(o,{variant:x.includes(s)?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap flex-shrink-0 snap-start hover:scale-105 active:animate-tag-select ${x.includes(s)?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>P(s),children:s},s))}),e.jsx("div",{className:"absolute left-0 top-0 bottom-2 w-4 bg-gradient-to-r from-card via-card/60 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-2 w-4 bg-gradient-to-l from-card via-card/60 to-transparent pointer-events-none"})]})]})]}),w.length>0&&e.jsxs("div",{className:"space-y-2 pt-1 border-t border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-sm font-semibold text-foreground",children:[t("nav.activities"),":"]}),d&&e.jsx(o,{variant:"outline",className:"cursor-pointer hover:bg-destructive hover:text-destructive-foreground hover:scale-105 transition-all duration-200 px-2 py-0 text-xs h-5",onClick:()=>{N(null),f([])},children:t("common.actions.clearFilter")}),w.length>8&&e.jsx(p,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-primary hover:text-primary/80 ml-auto hidden sm:flex transition-all duration-200",onClick:()=>H(!R),children:t(R?"common.showLess":"common.showMore")})]}),e.jsxs("div",{className:"relative overflow-hidden",children:[e.jsx("div",{className:`hidden sm:flex gap-2 flex-wrap transition-all duration-300 ease-out ${R?"animate-expand-height":""}`,children:(R?w:w.slice(0,8)).map((s,a)=>{const c=m.language==="zh"?s.badge_text_zh||s.title_zh:m.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(o,{variant:d===s.id?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap hover:scale-105 active:animate-tag-select ${d===s.id?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>U(s.id),children:c},s.id)})}),e.jsxs("div",{className:"sm:hidden relative -mx-1 px-1",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory scroll-smooth",children:w.map((s,a)=>{const c=m.language==="zh"?s.badge_text_zh||s.title_zh:m.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(o,{variant:d===s.id?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap flex-shrink-0 snap-start hover:scale-105 active:animate-tag-select ${d===s.id?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>U(s.id),children:c},s.id)})}),e.jsx("div",{className:"absolute left-0 top-0 bottom-2 w-4 bg-gradient-to-r from-card via-card/60 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-2 w-4 bg-gradient-to-l from-card via-card/60 to-transparent pointer-events-none"})]})]})]})]}),i&&e.jsxs("div",{className:"flex gap-2 flex-wrap items-center bg-muted/30 backdrop-blur-sm rounded-lg p-3 border border-primary/10",children:[e.jsxs("span",{className:"text-sm font-semibold text-primary",children:[t("restaurants.radius"),":"]}),e.jsx(o,{variant:l===null?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>z(null),children:t("restaurants.allRestaurants")}),e.jsx(o,{variant:l===5?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>z(5),children:t("restaurants.radius5km")}),e.jsx(o,{variant:l===10?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>z(10),children:t("restaurants.radius10km")}),e.jsx(o,{variant:l===20?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>z(20),children:t("restaurants.radius20km")})]})]}),!re&&b&&e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6 lg:flex-1 lg:min-h-0 lg:overflow-hidden",children:[e.jsx("div",{className:`w-full lg:flex-1 transition-all duration-300 ease-in-out ${D?"h-0 overflow-hidden lg:h-full":"h-[400px] lg:h-full"}`,children:e.jsxs("div",{id:"map-container",className:`${M?"fixed inset-0 z-50 bg-background":"w-full h-full"} rounded-xl overflow-hidden shadow-2xl border border-primary/10 relative group`,children:[e.jsx(p,{variant:"secondary",size:"icon",className:"absolute bottom-4 right-4 z-10 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity",onClick:ce,children:M?e.jsx(he,{className:"w-5 h-5"}):e.jsx(pe,{className:"w-5 h-5"})}),e.jsxs("div",{className:"h-full relative",children:[e.jsx(Te,{restaurants:b,onRestaurantClick:B,userLocation:i,radiusFilter:l,onMarkerClick:oe,showViewDetailsButton:!0,onMapInit:s=>{v.current=s}}),e.jsxs("div",{className:"absolute bottom-4 left-4 z-10 pointer-events-none flex items-center gap-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg",children:[e.jsx("img",{src:$e,alt:"Xiaoxiong Market Logo",className:"h-6 w-6 object-contain"}),e.jsx("span",{className:"text-sm font-semibold text-foreground whitespace-nowrap",children:m.language==="zh"?"小熊市场":"Xiaoxiong Market"})]})]})]})}),e.jsx(p,{variant:"outline",size:"sm",className:"lg:hidden flex items-center justify-center gap-2 -mt-3 mb-1",onClick:()=>ae(!D),children:D?e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"w-4 h-4"}),t("map.showMap")]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-4 h-4"}),t("map.hideMap")]})}),e.jsxs("div",{className:"w-full lg:w-[420px] flex flex-col lg:min-h-0 lg:h-full",children:[e.jsxs("div",{className:"mb-4 pb-4 border-b border-border flex-shrink-0",children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(T,{className:"w-6 h-6 text-primary"}),t("restaurants.title"),e.jsx(o,{variant:"secondary",className:"ml-2",children:b.length})]}),i&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-2 flex items-center gap-1.5",children:[e.jsx(L,{className:"w-4 h-4"}),t("restaurants.sortedByDistance")]})]}),b.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(T,{className:"w-16 h-16 text-muted-foreground/40 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-2",children:t("restaurants.noResults")}),e.jsx("p",{className:"text-muted-foreground max-w-xs",children:t("restaurants.noResultsDesc")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"lg:hidden space-y-3 pb-4",children:b.map(s=>e.jsx(J,{ref:a=>$.current[s.id]=a,className:`p-5 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-primary/40 border-2 bg-gradient-to-br from-card to-card/50 backdrop-blur-sm ${q===s.id?"border-primary ring-2 ring-primary ring-offset-2":"border-transparent"}`,onClick:()=>B(s),children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-foreground line-clamp-1 flex-1",children:X(s.name)}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full w-fit",children:[e.jsx(L,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.distance<1?`${(s.distance*1e3).toFixed(0)} m`:`${s.distance.toFixed(1)} km`})]})]}),s.rating>0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full flex-shrink-0",children:[e.jsx(Q,{className:"w-4 h-4",style:{fill:"#016450",color:"#016450"}}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.rating})]})]}),s.type&&s.type.length>0&&e.jsx(W,{restaurant:s,language:m.language}),e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(T,{className:"w-4 h-4 mt-0.5 flex-shrink-0 text-primary/60"}),e.jsx("span",{className:"line-clamp-2",children:s.address})]})]})},s.id))}),e.jsx(Ne,{className:"hidden lg:block lg:flex-1 pr-4",children:e.jsx("div",{className:"space-y-3 pb-4",children:b.map(s=>e.jsx(J,{ref:a=>$.current[s.id]=a,className:`p-5 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-primary/40 border-2 bg-gradient-to-br from-card to-card/50 backdrop-blur-sm ${q===s.id?"border-primary ring-2 ring-primary ring-offset-2":"border-transparent"}`,onClick:()=>B(s),children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-foreground line-clamp-1 flex-1",children:X(s.name)}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full w-fit",children:[e.jsx(L,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.distance<1?`${(s.distance*1e3).toFixed(0)} m`:`${s.distance.toFixed(1)} km`})]})]}),s.rating>0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full flex-shrink-0",children:[e.jsx(Q,{className:"w-4 h-4",style:{fill:"#016450",color:"#016450"}}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.rating})]})]}),s.type&&s.type.length>0&&e.jsx(W,{restaurant:s,language:m.language}),e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(T,{className:"w-4 h-4 mt-0.5 flex-shrink-0 text-primary/60"}),e.jsx("span",{className:"line-clamp-2",children:s.address})]})]})},s.id))})})]})]})]})]}),e.jsx(Ae,{open:se,onOpenChange:E,onConfirm:ie})]})};export{Ke as default};
//# sourceMappingURL=Map-YKXH7Zwz.js.map
