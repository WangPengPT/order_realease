import{j as e}from"./vendor-ui-DmpovMYY.js";import{s as i,i as A,w as k,R as T,aM as M,x as O,I as w,B as m,q as me,j as ue,a6 as he,a7 as je,G as xe,a8 as pe,a9 as X,aZ as ge,P as fe,r as ve,g as we,J as q,aU as ye,aV as Ue,aW as be,aX as Ne,aY as Se,ba as Ce,f as De,a$ as _e,ag as Ee,ah as Re,ai as Ae,aj as ke,ak as Te,al as Me,am as Oe,an as qe,D as Fe,b as Pe,c as Le,d as $e,ay as Ie,az as N,aB as Ke,aF as r}from"./index-CLDmU-vQ.js";import{T as Qe,a as Be,b as Y,c as u,d as He,e as h}from"./table-CnxcD3-A.js";import{u as Ve,a as F,b as Z}from"./vendor-query-D82cqPtt.js";import{r as c}from"./vendor-react-iAJ0IrSD.js";import{S as ze}from"./switch-DKEYFIv7.js";import{u as Je}from"./vendor-i18n-DxKeo2S1.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-6pZ9VDFn.js";const ee=["pending","received","completed","cancelled"],rs=()=>{const{t:s}=Je(),[P,se]=c.useState(""),[y,L]=c.useState("all"),[S,C]=c.useState(null),[ae,f]=c.useState(!1),[o,te]=c.useState(null),[v,$]=c.useState(""),[j,I]=c.useState(""),[D,_]=c.useState(!1),[E,d]=c.useState(!1),[U,K]=c.useState(!1),x=Ve(),{data:Q,isLoading:re}=F({queryKey:["joinRequests"],queryFn:async()=>{const{data:a,error:t}=await i.from("join_requests").select("*").order("created_at",{ascending:!1});if(t)throw t;return a}}),{data:R}=F({queryKey:["emailConfig","join_request"],queryFn:async()=>{const{data:a,error:t}=await i.from("email_config").select("*").eq("type","join_request").single();if(t)throw t;return a}}),{data:B}=F({queryKey:["siteSettings"],queryFn:async()=>{const{data:a,error:t}=await i.from("site_settings").select("logo_url").single();if(t)throw t;return a}});c.useEffect(()=>{const a=i.channel("join_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"join_requests"},()=>{x.invalidateQueries({queryKey:["joinRequests"]})}).subscribe();return()=>{i.removeChannel(a)}},[x]);const p=Q?.filter(a=>{const t=P.toLowerCase(),n=a.name.toLowerCase().includes(t)||a.email.toLowerCase().includes(t)||a.restaurant_name.toLowerCase().includes(t)||a.phone.toLowerCase().includes(t),g=y==="all"||a.status===y;return n&&g}),ne=async()=>{const a=prompt(s("joinUs.enterNewEmail"),R?.recipient_email);if(a)try{const{error:t}=await i.from("email_config").update({recipient_email:a}).eq("id",R?.id);if(t)throw t;r({title:s("common.success"),description:s("joinUs.emailUpdated")})}catch(t){console.error("Error updating email:",t),r({title:s("common.error"),description:s("joinUs.emailUpdateError"),variant:"destructive"})}},H=Z({mutationFn:async({id:a,status:t})=>{const{error:n}=await i.from("join_requests").update({status:t}).eq("id",a);if(n)throw n},onSuccess:()=>{x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.statusUpdated")})},onError:a=>{console.error("Error updating status:",a),r({title:s("common.error"),description:s("joinUs.statusUpdateError"),variant:"destructive"})}}),V=Z({mutationFn:async a=>{const{error:t}=await i.from("join_requests").delete().eq("id",a);if(t)throw t},onSuccess:()=>{x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.requestDeleted")}),C(null)},onError:a=>{console.error("Error deleting request:",a),r({title:s("common.error"),description:s("joinUs.deleteError"),variant:"destructive"})}}),ie=()=>{if(!p||p.length===0){r({title:s("admin.noDataToExport"),variant:"destructive"});return}const a=[["Name","Email","Phone","Restaurant Name","Restaurant Address","Features","Status","Submitted Date"],...p.map(l=>[l.name,l.email,l.phone,l.restaurant_name,l.restaurant_address||"",Array.isArray(l.features_selected)?l.features_selected.join(", "):"",l.status||"pending",new Date(l.created_at).toLocaleString()])].map(l=>l.map(b=>`"${b}"`).join(",")).join(`
`),t=new Blob([a],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),g=URL.createObjectURL(t);n.setAttribute("href",g),n.setAttribute("download",`join_requests_${new Date().toISOString()}.csv`),n.click(),URL.revokeObjectURL(g),r({title:s("admin.exportSuccess")})},z=a=>{switch(a){case"completed":return"default";case"received":return"secondary";case"cancelled":return"destructive";default:return"outline"}},oe=a=>{te(a),$(a.email),I(""),K(!1),f(!0)},le=async()=>{if(!o||!v.trim()||!j.trim()){r({title:s("common.error"),description:s("joinUs.accountPasswordRequired"),variant:"destructive"});return}if(j.length<6){r({title:s("common.error"),description:s("auth.passwordTooShort"),variant:"destructive"});return}try{if(U){_(!0);const ce=`【小熊市场】您的商家账号信息 - ${o.restaurant_name}`,de="您的商家账号信息如下！",{data:G,error:W}=await i.functions.invoke("send-merchant-email",{body:{to:o.email,subject:ce,content:de,merchantName:o.name,account:v,password:j,logoUrl:B?.logo_url||null}});if(W)throw W;if(!G.success)throw new Error(G.error);await i.from("join_requests").update({email_sent_at:new Date().toISOString()}).eq("id",o.id),x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),f(!1);return}d(!0);const{data:a}=await i.auth.getSession();if(!a?.session){r({title:s("common.error"),description:s("auth.sessionExpired"),variant:"destructive"}),d(!1);return}const{data:t,error:n}=await i.functions.invoke("admin-create-user",{body:{email:v,password:j,displayName:o.name,phone:o.phone,role:"merchant"}});if(n){console.error("Create user function error:",n),r({title:s("common.error"),description:n.message||s("admin.createUserError"),variant:"destructive"}),d(!1);return}if(t?.error){console.error("Create user business error:",t.error),r({title:s("common.error"),description:t.error,variant:"destructive"}),d(!1);return}if(!t?.success||!t?.user){console.error("User creation failed - no user returned"),r({title:s("common.error"),description:s("admin.createUserError"),variant:"destructive"}),d(!1);return}r({title:s("common.success"),description:s("joinUs.merchantUserCreated")}),d(!1),_(!0);const g=`【小熊市场】您的商家账号已创建 - ${o.restaurant_name}`,l="您的商家账号已创建成功！",{data:b,error:J}=await i.functions.invoke("send-merchant-email",{body:{to:o.email,subject:g,content:l,merchantName:o.name,account:v,password:j,logoUrl:B?.logo_url||null}});if(J)throw J;if(!b.success)throw new Error(b.error);await i.from("join_requests").update({status:"received",email_sent_at:new Date().toISOString()}).eq("id",o.id),x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),f(!1)}catch(a){console.error("Error:",a),r({title:s("common.error"),description:a.message||s("joinUs.emailSendError"),variant:"destructive"})}finally{d(!1),_(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("joinUs.adminTitle")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:s("joinUs.adminDescription")})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(A,{children:[e.jsxs(k,{children:[e.jsx(T,{children:s("joinUs.recipientEmail")}),e.jsx(M,{children:s("joinUs.recipientEmailDesc")})]}),e.jsx(O,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{value:R?.recipient_email||"",readOnly:!0}),e.jsx(m,{onClick:ne,children:s("common.edit")})]})})]}),e.jsxs(A,{children:[e.jsxs(k,{children:[e.jsx(T,{children:s("joinUs.totalRequests")}),e.jsx(M,{children:s("joinUs.totalRequestsDesc")})]}),e.jsx(O,{children:e.jsx("div",{className:"text-3xl font-bold",children:Q?.length||0})})]})]}),e.jsxs(A,{children:[e.jsxs(k,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(T,{children:s("joinUs.allRequests")}),e.jsx(M,{children:s("joinUs.allRequestsDesc")})]}),e.jsxs(m,{onClick:ie,variant:"outline",children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),s("admin.exportCSV")]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(w,{placeholder:s("joinUs.searchPlaceholder"),value:P,onChange:a=>se(a.target.value),className:"pl-10"})]}),e.jsxs(he,{children:[e.jsx(je,{asChild:!0,children:e.jsxs(m,{variant:"outline",className:"gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),s(y==="all"?"admin.allStatus":`joinUs.status.${y}`)]})}),e.jsxs(pe,{align:"end",className:"bg-background",children:[e.jsx(X,{onClick:()=>L("all"),children:s("admin.allStatus")}),ee.map(a=>e.jsx(X,{onClick:()=>L(a),children:s(`joinUs.status.${a}`)},a))]})]})]})]}),e.jsx(O,{children:re?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):p&&p.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Qe,{children:[e.jsx(Be,{children:e.jsxs(Y,{children:[e.jsx(u,{children:s("joinUs.name")}),e.jsx(u,{children:s("joinUs.contact")}),e.jsx(u,{children:s("joinUs.restaurant")}),e.jsx(u,{children:s("joinUs.featuresNeeded")}),e.jsx(u,{children:s("joinUs.status")}),e.jsx(u,{children:s("joinUs.submittedAt")}),e.jsx(u,{className:"text-right",children:s("common.actions")})]})}),e.jsx(He,{children:p.map(a=>e.jsxs(Y,{children:[e.jsx(h,{className:"font-medium",children:a.name}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ge,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`mailto:${a.email}`,className:"hover:underline",children:a.email})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fe,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`tel:${a.phone}`,className:"hover:underline",children:a.phone})]})]})}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ve,{className:"w-3 h-3 text-muted-foreground"}),a.restaurant_name]}),a.restaurant_address&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(we,{className:"w-3 h-3"}),a.restaurant_address]})]})}),e.jsx(h,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:Array.isArray(a.features_selected)&&a.features_selected.map((t,n)=>e.jsx(q,{variant:"secondary",children:s(`joinUs.feature.${t}`)},n))})}),e.jsx(h,{children:e.jsxs(ye,{value:a.status||"pending",onValueChange:t=>H.mutate({id:a.id,status:t}),disabled:H.isPending,children:[e.jsx(Ue,{className:"w-[130px]",children:e.jsx(be,{children:e.jsx(q,{variant:z(a.status||"pending"),children:s(`joinUs.status.${a.status||"pending"}`)})})}),e.jsx(Ne,{children:ee.map(t=>e.jsx(Se,{value:t,children:e.jsx(q,{variant:z(t),children:s(`joinUs.status.${t}`)})},t))})]})}),e.jsx(h,{className:"text-sm text-muted-foreground",children:Ce(new Date(a.created_at),{addSuffix:!0})}),e.jsx(h,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>oe(a),title:s("joinUs.sendEmail"),children:e.jsx(De,{className:"w-4 h-4"})}),e.jsx(m,{size:"sm",variant:"destructive",onClick:()=>C(a.id),disabled:V.isPending,children:e.jsx(_e,{className:"w-4 h-4"})})]})})]},a.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("joinUs.noRequests")})})]})]}),e.jsx(Ee,{open:S!==null,onOpenChange:a=>!a&&C(null),children:e.jsxs(Re,{children:[e.jsxs(Ae,{children:[e.jsx(ke,{children:s("joinUs.confirmDelete")}),e.jsx(Te,{children:s("joinUs.confirmDeleteDescription")})]}),e.jsxs(Me,{children:[e.jsx(Oe,{children:s("common.cancel")}),e.jsx(qe,{onClick:()=>S&&V.mutate(S),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s("common.delete")})]})]})}),e.jsx(Fe,{open:ae,onOpenChange:f,children:e.jsxs(Pe,{className:"sm:max-w-[500px]",children:[e.jsxs(Le,{children:[e.jsx($e,{children:s("joinUs.sendAccountTitle")}),e.jsx(Ie,{children:s("joinUs.sendAccountDescription",{name:o?.name})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(N,{htmlFor:"emailOnlyMode",className:"font-medium",children:s("joinUs.emailOnlyMode")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.emailOnlyModeDesc")})]}),e.jsx(ze,{id:"emailOnlyMode",checked:U,onCheckedChange:K})]}),!U&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:["ℹ️ ",s("joinUs.createUserModeNote")]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:s("joinUs.emailRecipient")}),e.jsx(w,{value:o?.email||"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"account",children:s("joinUs.merchantAccount")}),e.jsx(w,{id:"account",value:v,onChange:a=>$(a.target.value),placeholder:s("joinUs.merchantAccountPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"password",children:s("joinUs.merchantPassword")}),e.jsx(w,{id:"password",type:"text",value:j,onChange:a=>I(a.target.value),placeholder:s("joinUs.merchantPasswordPlaceholder")})]}),e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:["⚠️ ",s("joinUs.passwordSecurityNote")]})})]}),e.jsxs(Ke,{children:[e.jsx(m,{variant:"outline",onClick:()=>f(!1),disabled:E||D,children:s("common.cancel")}),e.jsx(m,{onClick:le,disabled:E||D,children:s(E?"joinUs.creatingUser":D?"common.sending":U?"joinUs.sendEmailOnly":"joinUs.createAndSendEmail")})]})]})})]})};export{rs as default};
//# sourceMappingURL=AdminJoinRequests-CpN80XQP.js.map
