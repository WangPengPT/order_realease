import{p as Ee,q as Oe,r as d,s as H,v as K,j as e,ai as ie,bS as Be,aL as P,a4 as Ae,bI as Ve,bj as He,bM as je,bs as Ke,ak as Qe,aM as Q,bz as Ge,al as pe,bx as $e,dM as We,bF as Xe,b1 as Ye,bg as Je,c5 as Ze,b3 as es,dN as ss,bo as ts,dO as ns}from"./vendor-react-Hsdnn-sD.js";import{u as as,j as is,D as G,Y as ls,B as o,d as $,f as W,g as X,W as r,I as w,a8 as Y,a2 as R,a3 as F,a5 as q,a6 as m,a4 as J,X as Z,C as ee,v as ge,M as fe,k as se,$ as rs,w as te,V as ve,s as h}from"./index-Bhoi9VDh.js";import{T as ne,a as ae,b as g,c as C}from"./tabs-Bf0AlTta.js";import{T as cs,a as os,b as _e,c as L,d as ds,e as M}from"./table-AIoEu4UD.js";import{D as ye}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-BVdpxhZP.js";const ms=["Bell","Megaphone","Gift","Star","Heart","AlertCircle","Info","PartyPopper","Sparkles","Trophy"],hs={Bell:ie,Megaphone:We,Gift:Xe,Star:Ye,Heart:Je,AlertCircle:Ze,Info:es,PartyPopper:ss,Sparkles:ts,Trophy:ns},E=({name:t,className:T})=>{const z=hs[t]||ie;return e.jsx(z,{className:T})};function ys(){const{t,i18n:T}=Ee(),{user:z}=as(),{toast:b}=is(),O=Oe(),[Ne,k]=d.useState(!1),[we,S]=d.useState(!1),[be,I]=d.useState(!1),[D,le]=d.useState(null),[u,re]=d.useState(null),[l,Ce]=d.useState(null),[B,ce]=d.useState("zh"),[Te,ze]=d.useState("templates"),[i,c]=d.useState({title_zh:"",title_en:"",title_pt:"",content_zh:"",content_en:"",content_pt:"",icon:"Bell",image_url:"",link:"",status:"draft"}),[n,y]=d.useState({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),{data:ke=[],isLoading:Se}=H({queryKey:["notification-templates"],queryFn:async()=>{const{data:s,error:a}=await h.from("notification_templates").select("*").order("created_at",{ascending:!1});if(a)throw a;return s}}),{data:Ie=[],isLoading:De}=H({queryKey:["notification-send-records"],queryFn:async()=>{const{data:s,error:a}=await h.from("notification_send_records").select("*").order("sent_at",{ascending:!1});if(a)throw a;return s}}),{data:Ue=[]}=H({queryKey:["all-users-for-notification"],queryFn:async()=>{const{data:s,error:a}=await h.from("profiles").select("id, display_name").order("display_name");if(a)throw a;return s}}),A=K({mutationFn:async s=>{if(s.id){const{error:a}=await h.from("notification_templates").update({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon,image_url:s.image_url||null,link:s.link||null,status:s.status}).eq("id",s.id);if(a)throw a}else{const{error:a}=await h.from("notification_templates").insert({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon,image_url:s.image_url||null,link:s.link||null,status:s.status,created_by:z?.id});if(a)throw a}},onSuccess:()=>{O.invalidateQueries({queryKey:["notification-templates"]}),k(!1),de(),b({title:t("common.success"),description:t(D?"common.updated":"common.created")})},onError:s=>{b({title:t("common.error"),description:s.message,variant:"destructive"})}}),oe=K({mutationFn:async s=>{const{error:a}=await h.from("notification_templates").delete().eq("id",s);if(a)throw a},onSuccess:()=>{O.invalidateQueries({queryKey:["notification-templates"]}),b({title:t("common.success"),description:t("common.deleted")})}}),V=K({mutationFn:async()=>{if(!u)throw new Error("No template selected");let s=[];const a=async()=>{const j=[];let N=0;const v=1e3;for(;;){const{data:p,error:_}=await h.from("profiles").select("id").range(N*v,(N+1)*v-1);if(_)throw _;if(p&&p.length>0){if(j.push(...p.map(U=>U.id)),p.length<v)break;N++}else break}return j},x=async j=>{const N=[];let v=0;const p=1e3;for(;;){const{data:_,error:U}=await h.from("user_roles").select("user_id").eq("role",j).range(v*p,(v+1)*p-1);if(U)throw U;if(_&&_.length>0){if(N.push(..._.map(Me=>Me.user_id)),_.length<p)break;v++}else break}return N};if(n.targetType==="all")s=await a();else if(n.targetType==="role"){const j=n.targetRole;s=await x(j)}else s=n.targetUserIds;if(s.length===0)throw new Error("No users to send to");const qe=s.map(j=>({user_id:j,type:"activity_update",title:f(u,"title"),content:f(u,"content"),link:u.link})),{error:ue}=await h.from("notifications").insert(qe);if(ue)throw ue;const Le=n.targetType==="role"?n.targetRole:null,{error:xe}=await h.from("notification_send_records").insert({template_id:u.id,title:f(u,"title"),content:f(u,"content"),target_type:n.targetType,target_role:Le,target_user_ids:n.targetType==="specific"?n.targetUserIds:null,sent_count:s.length,sent_by:z?.id});if(xe)throw xe;return s.length},onSuccess:s=>{O.invalidateQueries({queryKey:["notification-send-records"]}),S(!1),re(null),y({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),b({title:t("common.success"),description:t("admin.notificationsSent",{count:s})||`已发送 ${s} 条通知`})},onError:s=>{b({title:t("common.error"),description:s.message,variant:"destructive"})}}),f=(s,a)=>{const x=T.language;return a==="title"?x==="zh"?s.title_zh:x==="pt"?s.title_pt:s.title_en:x==="zh"?s.content_zh:x==="pt"?s.content_pt:s.content_en},de=()=>{c({title_zh:"",title_en:"",title_pt:"",content_zh:"",content_en:"",content_pt:"",icon:"Bell",image_url:"",link:"",status:"draft"}),le(null)},Pe=s=>{le(s),c({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon||"Bell",image_url:s.image_url||"",link:s.link||"",status:s.status}),k(!0)},me=s=>{re(s),S(!0)},Re=s=>{Ce(s),ce(T.language),I(!0)},he=(s,a)=>({title:a==="zh"?s.title_zh:a==="pt"?s.title_pt:s.title_en,content:a==="zh"?s.content_zh:a==="pt"?s.content_pt:s.content_en}),Fe=Ue.filter(s=>s.display_name?.toLowerCase().includes(n.userSearch.toLowerCase()));return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ie,{className:"h-6 w-6"}),t("admin.notifications","发送通知")]}),e.jsx("p",{className:"text-muted-foreground",children:t("admin.notificationsDesc","管理通知模板和发送站内通知")})]})}),e.jsxs(ne,{value:Te,onValueChange:ze,children:[e.jsxs(ae,{children:[e.jsx(g,{value:"templates",children:t("admin.templates","模板管理")}),e.jsx(g,{value:"records",children:t("admin.sendRecords","发送记录")})]}),e.jsxs(C,{value:"templates",className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(G,{open:Ne,onOpenChange:s=>{k(s),s||de()},children:[e.jsx(ls,{asChild:!0,children:e.jsxs(o,{children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),t("admin.createTemplate","创建模板")]})}),e.jsxs($,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(W,{children:e.jsx(X,{children:D?t("admin.editTemplate","编辑模板"):t("admin.createTemplate","创建模板")})}),e.jsxs(ne,{defaultValue:"zh",className:"w-full",children:[e.jsxs(ae,{className:"grid w-full grid-cols-3",children:[e.jsx(g,{value:"zh",children:"中文"}),e.jsx(g,{value:"en",children:"English"}),e.jsx(g,{value:"pt",children:"Português"})]}),e.jsxs(C,{value:"zh",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(w,{value:i.title_zh,onChange:s=>c({...i,title_zh:s.target.value}),placeholder:"通知标题"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Y,{value:i.content_zh,onChange:s=>c({...i,content_zh:s.target.value}),placeholder:"通知内容",rows:4})]})]}),e.jsxs(C,{value:"en",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(w,{value:i.title_en,onChange:s=>c({...i,title_en:s.target.value}),placeholder:"Notification Title"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Y,{value:i.content_en,onChange:s=>c({...i,content_en:s.target.value}),placeholder:"Notification Content",rows:4})]})]}),e.jsxs(C,{value:"pt",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(w,{value:i.title_pt,onChange:s=>c({...i,title_pt:s.target.value}),placeholder:"Título da Notificação"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Y,{value:i.content_pt,onChange:s=>c({...i,content_pt:s.target.value}),placeholder:"Conteúdo da Notificação",rows:4})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("admin.icon","图标")}),e.jsxs(R,{value:i.icon,onValueChange:s=>c({...i,icon:s}),children:[e.jsx(F,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{name:i.icon,className:"h-4 w-4"}),e.jsx("span",{children:i.icon})]})}),e.jsx(q,{children:ms.map(s=>e.jsx(m,{value:s,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{name:s,className:"h-4 w-4"}),e.jsx("span",{children:s})]})},s))})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.status")}),e.jsxs(R,{value:i.status,onValueChange:s=>c({...i,status:s}),children:[e.jsx(F,{children:e.jsx(J,{})}),e.jsxs(q,{children:[e.jsx(m,{value:"draft",children:t("common.draft","草稿")}),e.jsx(m,{value:"published",children:t("common.published","已发布")})]})]})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("admin.imageUrl","图片URL（可选）")}),e.jsx(w,{value:i.image_url,onChange:s=>c({...i,image_url:s.target.value}),placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("admin.link","链接（可选）")}),e.jsx(w,{value:i.link,onChange:s=>c({...i,link:s.target.value}),placeholder:"/activity/xxx"})]}),e.jsxs(Z,{children:[e.jsx(o,{variant:"outline",onClick:()=>k(!1),children:t("common.cancel")}),e.jsxs(o,{onClick:()=>A.mutate({...i,id:D?.id}),disabled:A.isPending||!i.title_zh||!i.content_zh,children:[A.isPending&&e.jsx(P,{className:"h-4 w-4 mr-2 animate-spin"}),t(D?"common.save":"common.create")]})]})]})]})}),Se?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(P,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:ke.map(s=>e.jsxs(ee,{children:[e.jsxs(ge,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(fe,{className:"text-lg",children:f(s,"title")}),e.jsx(se,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"h-3 w-3 mr-1"}),t("common.published","已发布")]}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"h-3 w-3 mr-1"}),t("common.draft","草稿")]})})]}),e.jsx(rs,{className:"line-clamp-2",children:f(s,"content")})]}),e.jsxs(te,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-4",children:[e.jsx(E,{name:s.icon||"Bell",className:"h-4 w-4"}),e.jsx("span",{children:s.icon||"Bell"}),s.image_url&&e.jsx(He,{className:"h-4 w-4 ml-2"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>Re(s),children:[e.jsx(je,{className:"h-4 w-4 mr-1"}),t("common.preview","预览")]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>Pe(s),children:[e.jsx(Ke,{className:"h-4 w-4 mr-1"}),t("common.edit")]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>oe.mutate(s.id),disabled:oe.isPending,children:[e.jsx(Qe,{className:"h-4 w-4 mr-1"}),t("common.delete")]}),s.status==="published"&&e.jsxs(o,{size:"sm",onClick:()=>me(s),children:[e.jsx(Q,{className:"h-4 w-4 mr-1"}),t("common.send","发送")]})]})]})]},s.id))})]}),e.jsx(C,{value:"records",children:e.jsxs(ee,{children:[e.jsx(ge,{children:e.jsx(fe,{children:t("admin.sendRecords","发送记录")})}),e.jsx(te,{children:De?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(P,{className:"h-8 w-8 animate-spin"})}):e.jsxs(cs,{children:[e.jsx(os,{children:e.jsxs(_e,{children:[e.jsx(L,{children:t("common.title")}),e.jsx(L,{children:t("admin.targetType","发送对象")}),e.jsx(L,{children:t("admin.sentCount","发送数量")}),e.jsx(L,{children:t("admin.sentAt","发送时间")})]})}),e.jsx(ds,{children:Ie.map(s=>e.jsxs(_e,{children:[e.jsx(M,{className:"font-medium",children:s.title}),e.jsx(M,{children:e.jsx(se,{variant:"outline",children:s.target_type==="all"?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"h-3 w-3 mr-1"}),t("admin.allUsers","全部用户")]}):s.target_type==="role"?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),s.target_role]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),t("admin.specificUsers","指定用户")]})})}),e.jsx(M,{children:s.sent_count}),e.jsx(M,{children:ye(new Date(s.sent_at),"yyyy-MM-dd HH:mm")})]},s.id))})]})})]})})]}),e.jsx(G,{open:we,onOpenChange:S,children:e.jsxs($,{className:"max-w-md",children:[e.jsxs(W,{children:[e.jsx(X,{children:t("admin.sendNotification","发送通知")}),e.jsx(ve,{children:u&&f(u,"title")})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("admin.targetType","发送对象")}),e.jsxs(R,{value:n.targetType,onValueChange:s=>y({...n,targetType:s}),children:[e.jsx(F,{children:e.jsx(J,{})}),e.jsxs(q,{children:[e.jsx(m,{value:"all",children:t("admin.allUsers","全部用户")}),e.jsx(m,{value:"role",children:t("admin.byRole","按身份")}),e.jsx(m,{value:"specific",children:t("admin.specificUsers","指定用户")})]})]})]}),n.targetType==="role"&&e.jsxs("div",{children:[e.jsx(r,{children:t("admin.selectRole","选择身份")}),e.jsxs(R,{value:n.targetRole,onValueChange:s=>y({...n,targetRole:s}),children:[e.jsx(F,{children:e.jsx(J,{placeholder:t("admin.selectRole")})}),e.jsxs(q,{children:[e.jsx(m,{value:"user",children:t("common.user","用户")}),e.jsx(m,{value:"merchant",children:t("common.merchant","商家")}),e.jsx(m,{value:"supervisor",children:t("common.supervisor","主管")}),e.jsx(m,{value:"admin",children:t("common.admin","管理员")})]})]})]}),n.targetType==="specific"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:t("admin.selectUsers","选择用户")}),e.jsx(w,{placeholder:t("admin.searchUsers","搜索用户..."),value:n.userSearch,onChange:s=>y({...n,userSearch:s.target.value})}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-md p-2 space-y-1",children:Fe.slice(0,20).map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-muted rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:n.targetUserIds.includes(s.id),onChange:a=>{a.target.checked?y({...n,targetUserIds:[...n.targetUserIds,s.id]}):y({...n,targetUserIds:n.targetUserIds.filter(x=>x!==s.id)})}}),e.jsx("span",{className:"text-sm",children:s.display_name})]},s.id))}),n.targetUserIds.length>0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.selectedUsersCount",{count:n.targetUserIds.length})})]})]}),e.jsxs(Z,{children:[e.jsx(o,{variant:"outline",onClick:()=>S(!1),children:t("common.cancel")}),e.jsxs(o,{onClick:()=>V.mutate(),disabled:V.isPending||n.targetType==="role"&&!n.targetRole||n.targetType==="specific"&&n.targetUserIds.length===0,children:[V.isPending&&e.jsx(P,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx(Q,{className:"h-4 w-4 mr-2"}),t("common.send","发送")]})]})]})}),e.jsx(G,{open:be,onOpenChange:I,children:e.jsxs($,{className:"max-w-lg",children:[e.jsxs(W,{children:[e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5"}),t("admin.previewNotification","预览通知")]}),e.jsx(ve,{children:t("admin.previewNotificationDesc","查看不同语言版本的通知内容")})]}),l&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(ne,{value:B,onValueChange:s=>ce(s),children:e.jsxs(ae,{className:"grid w-full grid-cols-3",children:[e.jsx(g,{value:"zh",children:"中文"}),e.jsx(g,{value:"en",children:"English"}),e.jsx(g,{value:"pt",children:"Português"})]})}),e.jsx(ee,{className:"border-2",children:e.jsx(te,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(E,{name:l.icon||"Bell",className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("h4",{className:"font-semibold text-base",children:he(l,B).title}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:he(l,B).content}),l.image_url&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:l.image_url,alt:"Notification",className:"rounded-md max-h-40 object-cover"})}),l.link&&e.jsxs("div",{className:"mt-2 flex items-center gap-1 text-sm text-primary",children:[e.jsx($e,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate",children:l.link})]})]})]})})}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:[t("common.status"),":"]}),e.jsx(se,{variant:l.status==="published"?"default":"secondary",className:"text-xs",children:l.status==="published"?t("common.published","已发布"):t("common.draft","草稿")})]}),e.jsxs("div",{children:[t("common.createdAt"),": ",ye(new Date(l.created_at),"yyyy-MM-dd HH:mm")]})]})]}),e.jsxs(Z,{children:[e.jsx(o,{variant:"outline",onClick:()=>I(!1),children:t("common.close","关闭")}),l?.status==="published"&&e.jsxs(o,{onClick:()=>{I(!1),me(l)},children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),t("common.send","发送")]})]})]})})]})}export{ys as default};
//# sourceMappingURL=AdminNotifications-BsVV1W2r.js.map
