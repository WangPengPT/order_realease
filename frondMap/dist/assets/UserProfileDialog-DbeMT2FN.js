import{j as e}from"./vendor-ui-DmpovMYY.js";import{r as u,L as v}from"./vendor-react-iAJ0IrSD.js";import{s as l,D as se,c as te,d as z,B as ae,aR as re,e as T,aA as B,S as ne,K as g,ax as ie,ay as ce,az as le,k as b,a$ as de,W as oe,av as me,Y as xe,bq as A,q as f,P as p,V as M,a4 as j,bd as ue,r as w,p as he,G as ge,at as fe,b5 as pe,bY as y,bb as U}from"./index-Dqx1Dcau.js";import{S as L}from"./separator-C34PJkpq.js";import{u as je}from"./useLocalizedContent-BN2IWylL.js";import{u as Ne}from"./vendor-i18n-DxKeo2S1.js";function Ce({open:k,onOpenChange:V,userId:i,userName:ve,userRole:N}){const{t}=Ne(),{getLocalizedField:o}=je(),[O,E]=u.useState(!0),[d,H]=u.useState(null),[Y,G]=u.useState(null),[a,K]=u.useState({favoriteRestaurants:0,favoriteActivities:0,comments:0,ratings:0,addresses:0,restaurants:0}),[D,C]=u.useState(null),[x,m]=u.useState([]),[W,F]=u.useState(!1);u.useEffect(()=>{k&&i&&J()},[k,i]);const J=async()=>{E(!0);try{const{data:s,error:n}=await l.from("profiles").select("*").eq("id",i).maybeSingle();if(n)throw n;H(s);try{const{data:r}=await l.functions.invoke("get-user-emails",{body:{userIds:[i]}});r?.emails?.[i]&&G(r.emails[i])}catch(r){console.error("Error fetching email:",r)}const[c,_,S,R,q,$]=await Promise.all([l.from("favorites").select("id",{count:"exact",head:!0}).eq("user_id",i),l.from("subscriptions").select("id",{count:"exact",head:!0}).eq("user_id",i),l.from("comments").select("id",{count:"exact",head:!0}).eq("user_id",i),l.from("ratings").select("id",{count:"exact",head:!0}).eq("user_id",i),l.from("user_addresses").select("id",{count:"exact",head:!0}).eq("user_id",i),l.from("merchant_restaurants").select("id",{count:"exact",head:!0}).eq("user_id",i)]);K({favoriteRestaurants:c.count||0,favoriteActivities:_.count||0,comments:S.count||0,ratings:R.count||0,addresses:q.count||0,restaurants:$.count||0})}catch(s){console.error("Error fetching user profile:",s)}finally{E(!1)}},h=async s=>{if(s){F(!0),C(s);try{switch(s){case"restaurants":{const{data:n}=await l.from("favorites").select("created_at, restaurants(id, name, name_en, name_pt, image_url, rating, type, type_en, type_pt)").eq("user_id",i).order("created_at",{ascending:!1});m(n?.map(c=>({...c.restaurants,favorited_at:c.created_at}))||[]);break}case"activities":{const{data:n}=await l.from("subscriptions").select("created_at, activities(id, title_zh, title_en, title_pt, image_url, start_date, end_date)").eq("user_id",i).order("created_at",{ascending:!1});m(n?.map(c=>({...c.activities,subscribed_at:c.created_at}))||[]);break}case"comments":{const{data:n}=await l.from("comments").select("id, content, target_type, target_id, rating_value, created_at").eq("user_id",i).order("created_at",{ascending:!1});if(n){const c=n.filter(r=>r.target_type==="restaurant").map(r=>r.target_id),_=n.filter(r=>r.target_type==="activity").map(r=>r.target_id),[S,R]=await Promise.all([c.length>0?l.from("restaurants").select("id, name, name_en, name_pt").in("id",c):{data:[]},_.length>0?l.from("activities").select("id, title_zh, title_en, title_pt").in("id",_):{data:[]}]),q=Object.fromEntries((S.data||[]).map(r=>[r.id,r])),$=Object.fromEntries((R.data||[]).map(r=>[r.id,r]));m(n.map(r=>({...r,target:r.target_type==="restaurant"?q[r.target_id]:$[r.target_id]})))}break}case"ratings":{const{data:n}=await l.from("ratings").select("id, rating_value, price_range, created_at, restaurants(id, name, name_en, name_pt)").eq("user_id",i).order("created_at",{ascending:!1});m(n?.map(c=>({...c,restaurant:c.restaurants}))||[]);break}case"addresses":{const{data:n}=await l.from("user_addresses").select("*").eq("user_id",i).order("is_default",{ascending:!1});m(n||[]);break}case"managedRestaurants":{const{data:n}=await l.from("merchant_restaurants").select("created_at, restaurants(id, name, name_en, name_pt, image_url, address)").eq("user_id",i).order("created_at",{ascending:!1});m(n?.map(c=>({...c.restaurants,assigned_at:c.created_at}))||[]);break}}}catch(n){console.error("Error fetching detail data:",n),m([])}finally{F(!1)}}},Q=s=>{switch(s){case"restaurants":return t("admin.restaurantFavorites");case"activities":return t("admin.activityFavorites");case"comments":return t("admin.commentsCount");case"ratings":return t("admin.ratingsCount");case"addresses":return t("admin.addressesCount");case"managedRestaurants":return t("admin.managedRestaurants");default:return""}},X=s=>{switch(s){case"admin":return"bg-primary text-primary-foreground";case"supervisor":return"bg-blue-500 text-white";case"merchant":return"bg-emerald-500 text-white";default:return"bg-muted text-muted-foreground"}},Z=s=>{switch(s){case"admin":return e.jsx(A,{className:"h-3.5 w-3.5"});case"supervisor":return e.jsx(A,{className:"h-3.5 w-3.5"});case"merchant":return e.jsx(pe,{className:"h-3.5 w-3.5"});default:return e.jsx(fe,{className:"h-3.5 w-3.5"})}},P=s=>s?new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}):"-",I=s=>{s||(C(null),m([])),V(s)},ee=()=>{if(W)return e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(g,{className:"h-16 w-full"},s))});if(x.length===0)return e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:t("common.noDataFound")});switch(D){case"restaurants":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(v,{to:`/restaurant/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsx("img",{src:s.image_url||"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=100&q=80",alt:o(s,"name"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:o(s,"type")})]}),s.rating&&e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(w,{className:"h-3.5 w-3.5 fill-yellow-500 text-yellow-500"}),s.rating.toFixed(1)]}),e.jsx(y,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"activities":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(v,{to:`/activity/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:o(s,"title"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsx(y,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"comments":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(v,{to:`/${s.target_type}/${s.target_id}`,target:"_blank",className:"block p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"outline",className:"text-xs",children:s.target_type==="restaurant"?t("common.restaurant"):t("common.activity")}),e.jsx("span",{className:"text-sm font-medium truncate",children:s.target&&(s.target_type==="restaurant"?o(s.target,"name"):o(s.target,"title"))})]}),s.rating_value&&e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(w,{className:"h-3.5 w-3.5 fill-yellow-500 text-yellow-500"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:U(new Date(s.created_at),{addSuffix:!0})})]},s.id))});case"ratings":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(v,{to:`/restaurant/${s.restaurant?.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s.restaurant,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:U(new Date(s.created_at),{addSuffix:!0})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(w,{className:"h-4 w-4 fill-yellow-500 text-yellow-500"}),e.jsx("span",{className:"font-semibold",children:s.rating_value})]}),e.jsx(y,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"addresses":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium",children:s.label}),s.is_default&&e.jsx(b,{variant:"secondary",className:"text-xs",children:t("profile.defaultAddress")})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.street,", ",s.district&&`${s.district}, `,s.city]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.postal_code&&`${s.postal_code}, `,s.country]}),s.phone&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.phone_code," ",s.phone]})]},s.id))});case"managedRestaurants":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(v,{to:`/restaurant/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:o(s,"name"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.address})]}),e.jsx(y,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});default:return null}};return e.jsx(se,{open:k,onOpenChange:I,children:e.jsx(te,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:D?e.jsxs(e.Fragment,{children:[e.jsx(z,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>{C(null),m([])},children:e.jsx(re,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx(T,{children:Q(D)}),e.jsxs(B,{children:[d?.display_name," - ",x.length," ",t("common.items")]})]})]})}),e.jsx(ne,{className:"max-h-[60vh] pr-4",children:ee()})]}):e.jsxs(e.Fragment,{children:[e.jsxs(z,{children:[e.jsx(T,{children:t("admin.viewProfile")}),e.jsx(B,{children:t("admin.userProfileDetails")})]}),O?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(g,{className:"h-16 w-16 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{className:"h-5 w-32"}),e.jsx(g,{className:"h-4 w-24"})]})]}),e.jsx(g,{className:"h-20 w-full"}),e.jsx(g,{className:"h-32 w-full"})]}):d?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(ie,{className:"h-16 w-16 border-2 border-primary/20",children:[e.jsx(ce,{src:d.avatar_url||"",alt:d.display_name}),e.jsx(le,{className:"text-xl bg-primary/10 text-primary",children:d.display_name.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-xl font-semibold",children:d.display_name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{className:`${X(N)} gap-1`,children:[Z(N),e.jsx("span",{className:"capitalize",children:N})]}),d.is_banned&&e.jsx(b,{variant:"destructive",children:t("admin.banned")})]})]})]}),e.jsx(L,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:t("admin.contactInfo")}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:Y||"-"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:d.phone||"-"})]})]})]}),e.jsx(L,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:t("admin.accountInfo")}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:t("admin.registrationTime")}),e.jsx("p",{children:P(d.created_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:t("admin.languagePreference")}),e.jsx("p",{children:d.language_preference||"en"})]})]})]}),d.activity_terms_agreed&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-emerald-600",children:[e.jsx(A,{className:"h-4 w-4"}),e.jsxs("span",{children:[t("admin.agreedActivityTerms")," (",P(d.activity_terms_agreed_at),")"]})]}),d.is_banned&&d.ban_reason&&e.jsxs("div",{className:"p-3 bg-destructive/10 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-destructive font-medium",children:[t("admin.banReason"),":"]}),e.jsx("p",{className:"text-sm text-destructive/80",children:d.ban_reason})]})]}),e.jsx(L,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:t("admin.userStats")}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(f,{className:`bg-muted/30 transition-colors ${a.favoriteRestaurants>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>a.favoriteRestaurants>0&&h("restaurants"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(M,{className:"h-4 w-4 mx-auto mb-1 text-red-500"}),e.jsx("p",{className:"text-lg font-semibold",children:a.favoriteRestaurants}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.restaurantFavorites")}),a.favoriteRestaurants>0&&e.jsx(j,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(f,{className:`bg-muted/30 transition-colors ${a.favoriteActivities>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>a.favoriteActivities>0&&h("activities"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(M,{className:"h-4 w-4 mx-auto mb-1 text-primary"}),e.jsx("p",{className:"text-lg font-semibold",children:a.favoriteActivities}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.activityFavorites")}),a.favoriteActivities>0&&e.jsx(j,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(f,{className:`bg-muted/30 transition-colors ${a.comments>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>a.comments>0&&h("comments"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(ue,{className:"h-4 w-4 mx-auto mb-1 text-blue-500"}),e.jsx("p",{className:"text-lg font-semibold",children:a.comments}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.commentsCount")}),a.comments>0&&e.jsx(j,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(f,{className:`bg-muted/30 transition-colors ${a.ratings>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>a.ratings>0&&h("ratings"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(w,{className:"h-4 w-4 mx-auto mb-1 text-yellow-500"}),e.jsx("p",{className:"text-lg font-semibold",children:a.ratings}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.ratingsCount")}),a.ratings>0&&e.jsx(j,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(f,{className:`bg-muted/30 transition-colors ${a.addresses>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>a.addresses>0&&h("addresses"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(he,{className:"h-4 w-4 mx-auto mb-1 text-emerald-500"}),e.jsx("p",{className:"text-lg font-semibold",children:a.addresses}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.addressesCount")}),a.addresses>0&&e.jsx(j,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),(N==="merchant"||N==="supervisor")&&e.jsx(f,{className:`bg-muted/30 transition-colors ${a.restaurants>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>a.restaurants>0&&h("managedRestaurants"),children:e.jsxs(p,{className:"p-3 text-center relative",children:[e.jsx(ge,{className:"h-4 w-4 mx-auto mb-1 text-orange-500"}),e.jsx("p",{className:"text-lg font-semibold",children:a.restaurants}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.managedRestaurants")}),a.restaurants>0&&e.jsx(j,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})})]})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:t("common.noDataFound")})]})})})}export{Ce as U};
//# sourceMappingURL=UserProfileDialog-DbeMT2FN.js.map
