import{p as L,r as N,j as e,cb as j,a_ as K,aM as M,u as U,q as B,b1 as D,en as O,cp as z,an as H}from"./vendor-react-BQzJ6E-_.js";import{D as V,c as $,d as E,e as Y,T as G,U as J,a2 as W,a3 as X,a4 as Z,a5 as ee,a6 as se,V as ae,B as P,u as te,b as ne,G as ie,C as b,q as w,p as re,F as ce,$ as le,g as k}from"./index-CvGChxBf.js";import{e as oe}from"./usePoints-DXPkDQ2K.js";import{d as de,e as me,f as he}from"./useShopItems-BG8Inwwa.js";import{u as T}from"./useLocalizedContent-CInskQbp.js";import{u as ue,P as pe}from"./PointsHistoryDialog-CPX-Yvon.js";import{P as xe}from"./PullToRefresh-CdvIsQfg.js";import{F as je}from"./FeatureDisabledPage-BWieIMQC.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-vwQGbBim.js";import"./vendor-supabase-Bm_2ig-Q.js";import"./tabs-CvD2Ockf.js";const ge=({open:a,onOpenChange:p,item:t,userPoints:d})=>{const{t:n}=L(),{getLocalizedField:m}=T(),{data:g=[]}=ue(),i=de(),[r,y]=N.useState(""),h=t.item_type==="physical",v=d-t.points_cost,_=async()=>{await i.mutateAsync({itemId:t.id,shippingAddressId:h?r:void 0}),p(!1)},f=!h||r;return e.jsx(V,{open:a,onOpenChange:p,children:e.jsxs($,{className:"sm:max-w-md",children:[e.jsxs(E,{children:[e.jsx(Y,{children:n("shop.confirmPurchase")}),e.jsx(G,{children:n("shop.confirmPurchaseDesc")})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-start gap-4 p-4 bg-secondary/30 rounded-lg",children:[t.image_url&&e.jsx("img",{src:t.image_url,alt:String(m(t,"name")),className:"w-16 h-16 rounded-lg object-cover"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold",children:m(t,"name")}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:m(t,"description")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:n("shop.currentPoints")}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(j,{className:"w-4 h-4 text-accent"}),e.jsx("span",{className:"font-medium",children:d})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:n("shop.pointsCost")}),e.jsxs("span",{className:"flex items-center gap-1 text-destructive",children:[e.jsx("span",{children:"-"}),e.jsx(j,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:t.points_cost})]})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:n("shop.afterPurchase")}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(j,{className:"w-4 h-4 text-accent"}),e.jsx("span",{className:"font-bold",children:v})]})]})]}),h&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),n("shop.selectAddress")]}),g.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:n("shop.noAddresses")}):e.jsxs(W,{value:r,onValueChange:y,children:[e.jsx(X,{children:e.jsx(Z,{placeholder:n("shop.selectAddressPlaceholder")})}),e.jsx(ee,{children:g.map(l=>e.jsx(se,{value:l.id,children:e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-medium",children:l.label}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[l.street,", ",l.city]})]})},l.id))})]})]})]}),e.jsxs(ae,{className:"gap-2 sm:gap-0",children:[e.jsx(P,{variant:"outline",onClick:()=>p(!1),children:n("common.cancel")}),e.jsx(P,{onClick:_,disabled:!f||i.isPending,children:i.isPending?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 mr-2 animate-spin"}),n("common.processing")]}):n("shop.confirmPurchaseBtn")})]})]})})},Te=()=>{const{t:a}=L(),p=U(),{user:t}=te(),{getLocalizedField:d}=T(),{settings:n,isLoading:m}=ne(),{isAdmin:g}=ie(),i=B(),{data:r=0,isLoading:y}=oe(),{data:h=[],isLoading:v}=me(),{data:_=[]}=he(),[f,l]=N.useState(null),[I,C]=N.useState(!1),A=N.useCallback(async()=>{i.removeQueries({queryKey:["shop-items"]}),i.removeQueries({queryKey:["user-points"]}),i.removeQueries({queryKey:["user-purchase-limits"]}),await Promise.all([i.invalidateQueries({queryKey:["shop-items"]}),i.invalidateQueries({queryKey:["user-points"]}),i.invalidateQueries({queryKey:["user-purchase-limits"]})])},[i]),q=s=>{switch(s){case"coupon":return e.jsx(H,{className:"w-5 h-5"});case"physical":return e.jsx(z,{className:"w-5 h-5"});case"badge":return e.jsx(O,{className:"w-5 h-5"});default:return e.jsx(D,{className:"w-5 h-5"})}},F=s=>{switch(s){case"coupon":return a("shop.itemType.coupon");case"physical":return a("shop.itemType.physical");case"badge":return a("shop.itemType.badge");default:return s}},S=s=>{const c=_.find(x=>x.shop_item_id===s.id);if(!c)return s.per_user_limit;const o=new Date(c.period_start),u=new Date;if(s.limit_refresh_period==="daily"&&o.toDateString()!==u.toDateString())return s.per_user_limit;if(s.limit_refresh_period==="weekly"){const x=new Date(u.getTime()-6048e5);if(o<x)return s.per_user_limit}return s.limit_refresh_period==="monthly"&&(o.getMonth()!==u.getMonth()||o.getFullYear()!==u.getFullYear())?s.per_user_limit:Math.max(0,s.per_user_limit-c.purchase_count)},R=s=>!(!t||r<s.points_cost||s.stock!==null&&s.stock<=0||S(s)<=0),Q=s=>{if(!t){p("/auth");return}l(s),C(!0)};return!m&&n?.shop_enabled===!1&&!g?e.jsx(je,{}):v||m?e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4",children:e.jsx("div",{className:"container mx-auto max-w-6xl",children:e.jsx("div",{className:"text-center",children:a("common.loading")})})}):e.jsx(xe,{onRefresh:A,children:e.jsxs("div",{className:"min-h-screen bg-secondary/20 py-4 md:py-8 px-3 md:px-4",children:[e.jsxs("div",{className:"container mx-auto max-w-6xl",children:[e.jsx("div",{className:"mb-6 md:mb-8",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-foreground mb-2",children:a("shop.title")}),e.jsx("p",{className:"text-muted-foreground",children:a("shop.description")})]}),t&&e.jsx(b,{className:"md:w-auto",children:e.jsxs(w,{className:"p-4 flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"w-6 h-6 text-accent"}),e.jsx("span",{className:"text-2xl font-bold text-foreground",children:y?"...":r}),e.jsx("span",{className:"text-muted-foreground",children:a("shop.points")})]}),e.jsx(pe,{})]})})]})}),h.length===0?e.jsx(b,{children:e.jsxs(w,{className:"py-12 text-center",children:[e.jsx(D,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:a("shop.noItems")})]})}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6",children:h.map(s=>{const c=s.stock!==null&&s.stock<=0,o=S(s),u=o<=0,x=r<s.points_cost;return e.jsxs(b,{className:`overflow-hidden ${c?"opacity-60":""}`,children:[s.image_url&&e.jsx("div",{className:"aspect-video overflow-hidden bg-secondary/30",children:e.jsx("img",{src:s.image_url,alt:String(d(s,"name")),className:"w-full h-full object-cover"})}),e.jsx(re,{className:"pb-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(ce,{className:"text-lg line-clamp-1",children:d(s,"name")}),e.jsx(le,{className:"line-clamp-2 mt-1",children:d(s,"description")})]}),e.jsxs(k,{variant:"secondary",className:"flex items-center gap-1 shrink-0",children:[q(s.item_type),e.jsx("span",{className:"hidden sm:inline",children:F(s.item_type)})]})]})}),e.jsxs(w,{className:"pt-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(j,{className:"w-4 h-4 text-accent"}),e.jsx("span",{className:"font-bold text-lg",children:s.points_cost}),e.jsx("span",{className:"text-muted-foreground text-sm",children:a("shop.points")})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.stock!==null?c?e.jsx(k,{variant:"destructive",children:a("shop.soldOut")}):e.jsxs("span",{children:[a("shop.stock"),": ",s.stock]}):e.jsx("span",{children:a("shop.unlimited")})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mb-3",children:[s.limit_refresh_period==="none"?e.jsx("span",{children:a("shop.limitTotal",{count:s.per_user_limit})}):e.jsx("span",{children:a(`shop.limit.${s.limit_refresh_period}`,{count:s.per_user_limit})}),t&&!c&&e.jsxs("span",{className:"ml-2",children:["(",a("shop.remaining"),": ",o,")"]})]}),e.jsx(P,{className:"w-full",disabled:!R(s),onClick:()=>Q(s),children:a(t?c?"shop.soldOut":u?"shop.limitReached":x?"shop.insufficientPoints":"shop.purchase":"shop.loginToPurchase")})]})]},s.id)})})]}),f&&e.jsx(ge,{open:I,onOpenChange:C,item:f,userPoints:r})]})})};export{Te as default};
//# sourceMappingURL=Shop-DwGFUHx4.js.map
