import{p as O,r as u,s as te,j as e,ca as ge,aL as le,bK as Ye,w as T,br as Je,u as Xe,q as Ze,bN as es,am as fe,L as ss,b8 as as,cO as ts,b7 as is,cP as ns,ak as ls,al as ve,bd as _e,c4 as rs}from"./vendor-react-Hsdnn-sD.js";import{D as re,Y as ds,B as N,d as de,f as ce,g as oe,V as ue,S as cs,k as M,s as m,W as ie,I as Fe,a2 as B,a3 as I,a4 as V,a5 as $,a6 as p,X as Te,C as Z,v as ee,M as se,w as ae,A as ye,h as Ne,i as De,y as be,z as we,E as Ce,F as Se,G as Ae,J as ke,K as Le,L as Ee}from"./index-BBlUwNPi.js";import{S as Q}from"./separator-DxIIE6Pb.js";import{u as He}from"./useLocalizedContent-D-CDxH29.js";import{h as qe,i as os,j as us,k as ms}from"./useCoupons-BaK8wKvt.js";import{C as ne}from"./checkbox-BKNjhlbA.js";import{D as F}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-BVdpxhZP.js";const xs=({templateId:l,children:_})=>{O();const{getLocalizedField:s}=He(),[w,t]=u.useState(!1),{data:h,isLoading:A}=qe(l),{data:r,isLoading:H}=te({queryKey:["allActivitiesForCoupon"],queryFn:async()=>{const{data:d,error:c}=await m.from("activities").select("id, title_zh, title_en, title_pt, start_date, end_date, visible").eq("visible",!0).order("start_date",{ascending:!1});if(c)throw c;return d},enabled:w}),f=os(),v=us(),x=new Set(h?.map(d=>d.activity_id)||[]),z=async(d,c)=>{c?await v.mutateAsync({templateId:l,activityId:d}):await f.mutateAsync({templateId:l,activityId:d})},L=A||H,k=f.isPending||v.isPending;return e.jsxs(re,{open:w,onOpenChange:t,children:[e.jsx(ds,{asChild:!0,children:_||e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"管理关联活动"]})}),e.jsxs(de,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:"管理关联活动"}),e.jsx(ue,{children:"选择要关联到此优惠券模板的活动。一个优惠券可以关联多个活动。"})]}),e.jsx(cs,{className:"flex-1 pr-4",children:L?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(le,{className:"w-6 h-6 animate-spin"})}):e.jsx("div",{className:"space-y-2",children:r&&r.length>0?r.map(d=>{const c=x.has(d.id);return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(ne,{checked:c,onCheckedChange:()=>z(d.id,c),disabled:k}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s(d,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[F(new Date(d.start_date),"yyyy-MM-dd"),d.end_date&&` ~ ${F(new Date(d.end_date),"yyyy-MM-dd")}`]})]})]}),c&&e.jsxs(M,{variant:"secondary",className:"ml-2",children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),"已关联"]})]},d.id)}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"暂无可关联的活动"})})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["已关联 ",x.size," 个活动"]}),e.jsx(N,{variant:"outline",onClick:()=>t(!1),children:"关闭"})]})]})]})};function ps({open:l,onOpenChange:_,couponCode:s,onSuccess:w}){const{t}=O(),[h,A]=u.useState(!1),r=()=>s.is_active?s.user_coupons?.some(C=>C.used_at)?"used":"available":"expired",{register:H,handleSubmit:f,watch:v,setValue:x,reset:z,formState:{errors:L}}=Ye({defaultValues:{usage_limit:s.usage_limit,status:r()}});u.useEffect(()=>{z({usage_limit:s.usage_limit,status:r()})},[s,z]);const k=v("status"),d=async c=>{A(!0);try{const{error:C}=await m.from("coupon_codes").update({usage_limit:c.usage_limit,is_active:c.status!=="expired"}).eq("id",s.id);if(C)throw C;if(s.user_coupons&&s.user_coupons.length>0){if(c.status==="used"){const{error:E}=await m.from("user_coupons").update({used_at:new Date().toISOString()}).eq("coupon_code_id",s.id).is("used_at",null);if(E)throw E}else if(c.status==="available"){const{error:E}=await m.from("user_coupons").update({used_at:null}).eq("coupon_code_id",s.id);if(E)throw E}}T.success(t("admin.couponCode.updateSuccess")),w(),_(!1)}catch(C){console.error("Error updating coupon code:",C),T.error(t("admin.couponCode.updateError"))}finally{A(!1)}};return e.jsx(re,{open:l,onOpenChange:_,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:t("admin.couponCode.editTitle")}),e.jsxs(ue,{children:[t("admin.couponCode.editDescription"),": ",e.jsx("code",{className:"font-mono font-semibold",children:s.code})]})]}),e.jsxs("form",{onSubmit:f(d),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"usage_limit",children:t("admin.couponCode.usageLimit")}),e.jsx(Fe,{id:"usage_limit",type:"number",min:"1",...H("usage_limit",{required:t("admin.couponCode.usageLimitRequired"),min:{value:1,message:t("admin.couponCode.usageLimitMin")},valueAsNumber:!0})}),L.usage_limit&&e.jsx("p",{className:"text-sm text-destructive",children:L.usage_limit.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.couponCode.usageLimitHint")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(B,{value:k,onValueChange:c=>x("status",c),children:[e.jsx(I,{children:e.jsx(V,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs($,{children:[e.jsx(p,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(p,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(p,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[k==="available"&&t("admin.couponCode.statusAvailableHint"),k==="used"&&t("admin.couponCode.statusUsedHint"),k==="expired"&&t("admin.couponCode.statusExpiredHint")]})]}),e.jsxs(Te,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>_(!1),disabled:h,children:t("common.cancel")}),e.jsxs(N,{type:"submit",disabled:h,children:[h&&e.jsx(le,{className:"mr-2 h-4 w-4 animate-spin"}),t("common.save")]})]})]})]})})}function hs({open:l,onOpenChange:_,selectedCodeIds:s,onSuccess:w}){const{t}=O(),[h,A]=u.useState(!1),[r,H]=u.useState("available"),f=async()=>{if(s.length!==0){A(!0);try{const{error:v}=await m.from("coupon_codes").update({is_active:r!=="expired"}).in("id",s);if(v)throw v;if(r==="used"){const{error:x}=await m.from("user_coupons").update({used_at:new Date().toISOString()}).in("coupon_code_id",s).is("used_at",null);if(x)throw x}else if(r==="available"){const{error:x}=await m.from("user_coupons").update({used_at:null}).in("coupon_code_id",s);if(x)throw x}T.success(t("admin.couponCode.batchUpdateSuccess",{count:s.length})),w(),_(!1)}catch(v){console.error("Error batch updating coupon codes:",v),T.error(t("admin.couponCode.batchUpdateError"))}finally{A(!1)}}};return e.jsx(re,{open:l,onOpenChange:_,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:t("admin.couponCode.batchEditTitle")}),e.jsx(ue,{children:t("admin.couponCode.batchEditDescription",{count:s.length})})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(B,{value:r,onValueChange:v=>H(v),children:[e.jsx(I,{children:e.jsx(V,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs($,{children:[e.jsx(p,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(p,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(p,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r==="available"&&t("admin.couponCode.statusAvailableHint"),r==="used"&&t("admin.couponCode.statusUsedHint"),r==="expired"&&t("admin.couponCode.statusExpiredHint")]})]})}),e.jsxs(Te,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>_(!1),disabled:h,children:t("common.cancel")}),e.jsxs(N,{onClick:f,disabled:h,children:[h&&e.jsx(le,{className:"mr-2 h-4 w-4 animate-spin"}),t("admin.couponCode.batchUpdate")]})]})]})})}const Ss=()=>{const{id:l}=Je(),_=Xe(),{t:s}=O(),{getLocalizedField:w}=He(),t=Ze(),[h,A]=u.useState(""),[r,H]=u.useState("all"),[f,v]=u.useState("all"),[x,z]=u.useState("all"),[L,k]=u.useState(null),[d,c]=u.useState(null),[C,E]=u.useState(!1),[D,U]=u.useState(new Set),[Me,me]=u.useState(!1),[ze,W]=u.useState(!1),[R,xe]=u.useState(!1),{data:n,isLoading:Ue}=te({queryKey:["couponTemplate",l],queryFn:async()=>{const{data:a,error:i}=await m.from("coupon_templates").select("*").eq("id",l).single();if(i)throw i;return a},enabled:!!l}),{data:G,isLoading:Pe}=qe(l),{data:K,isLoading:Be}=ms(l),{data:S,isLoading:Ie}=te({queryKey:["templateCouponCodes",l],queryFn:async()=>{const{data:a,error:i}=await m.from("coupon_codes").select(`
          *,
          user_coupons(
            id,
            user_id,
            claimed_at,
            used_at,
            source
          )
        `).eq("template_id",l).order("created_at",{ascending:!1});if(i)throw i;const j=(a||[]).map(o=>o.id),{data:P}=await m.from("coupon_usage_history").select("user_coupon_id, used_by_user_id, restaurant_id").in("coupon_code_id",j),J=[...new Set((P||[]).map(o=>o.used_by_user_id))],{data:X}=await m.from("profiles").select("id, display_name, avatar_url").in("id",J),b=(X||[]).reduce((o,g)=>(o[g.id]={display_name:g.display_name,avatar_url:g.avatar_url},o),{}),pe=[...new Set((P||[]).filter(o=>o.restaurant_id).map(o=>o.restaurant_id))];let he={};if(pe.length>0){const{data:o}=await m.from("restaurants").select("id, name, name_en, name_pt").in("id",pe);he=(o||[]).reduce((g,y)=>(g[y.id]={name:y.name,name_en:y.name_en,name_pt:y.name_pt},g),{})}const je=(P||[]).reduce((o,g)=>(g.user_coupon_id&&(o[g.user_coupon_id]={used_by_merchant:b[g.used_by_user_id]||null,used_at_restaurant:g.restaurant_id&&he[g.restaurant_id]||null}),o),{});return await Promise.all((a||[]).map(async o=>{const g=await Promise.all((o.user_coupons||[]).map(async y=>{if(!y.user_id)return{...y,profiles:{id:"",display_name:"Unknown",avatar_url:null},...je[y.id]};const{data:Ge}=await m.from("profiles").select("id, display_name, avatar_url").eq("id",y.user_id).maybeSingle();return{...y,profiles:Ge||{id:y.user_id,display_name:"Unknown",avatar_url:null},...je[y.id]}}));return{...o,user_coupons:g}}))},enabled:!!l}),q=u.useMemo(()=>S?S.filter(a=>{const i=h.toLowerCase(),j=h===""||a.code.toLowerCase().includes(i)||a.user_coupons.some(b=>b.profiles.display_name.toLowerCase().includes(i)),P=r==="all"||r==="active"&&a.is_active||r==="inactive"&&!a.is_active,J=f==="all"||f==="unclaimed"&&a.user_coupons.length===0||f==="claimed"&&a.user_coupons.length>0&&a.user_coupons.every(b=>!b.used_at)||f==="used"&&a.user_coupons.some(b=>b.used_at),X=x==="all"||x==="share"&&a.user_coupons.some(b=>b.source==="share")||x==="other"&&a.user_coupons.some(b=>b.source!=="share");return j&&P&&J&&X}):[],[S,h,r,f,x]),Y=S?.length||0,Ve=S?.reduce((a,i)=>a+i.used_count,0)||0,$e=S?.reduce((a,i)=>a+i.user_coupons.length,0)||0,Ke=a=>{U(i=>{const j=new Set(i);return j.has(a)?j.delete(a):j.add(a),j})},Qe=()=>{D.size===q.length?U(new Set):U(new Set(q.map(a=>a.id)))},Oe=()=>{U(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",l]})},We=async()=>{if(D.size!==0){xe(!0);try{const a=Array.from(D),{error:i}=await m.from("user_coupons").delete().in("coupon_code_id",a);if(i)throw i;const{error:j}=await m.from("coupon_codes").delete().in("id",a);if(j)throw j;T.success(s("admin.couponCode.batchDeleteSuccess",{count:a.length})),U(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",l]}),W(!1)}catch(a){console.error("Error batch deleting coupon codes:",a),T.error(s("admin.couponCode.batchDeleteError"))}finally{xe(!1)}}},Re=async a=>{E(!0);try{const{error:i}=await m.from("user_coupons").delete().eq("coupon_code_id",a);if(i)throw i;const{error:j}=await m.from("coupon_codes").delete().eq("id",a);if(j)throw j;T.success(s("admin.couponDetail.deleteSuccess")),t.invalidateQueries({queryKey:["templateCouponCodes",l]}),c(null)}catch(i){console.error("Error deleting coupon code:",i),T.error(s("admin.couponDetail.deleteError"))}finally{E(!1)}};return Ue?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center py-12",children:s("admin.couponDetail.loading")})}):n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(N,{variant:"ghost",onClick:()=>_("/admin/coupons"),className:"mb-4",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),s("admin.couponDetail.backToList")]}),e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(fe,{className:"w-8 h-8"}),s("admin.couponDetail.title")]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-lg",children:s("admin.couponDetail.templateInfo")})}),e.jsxs(ae,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s("admin.couponDetail.linkedActivities")}),Pe?e.jsx("p",{className:"text-sm",children:s("admin.couponDetail.loading")}):G&&G.length>0?e.jsx("div",{className:"space-y-2",children:G.map(a=>e.jsx(ss,{to:`/activity/${a.activity_id}`,className:"block text-primary hover:underline",children:w(a.activities,"title")},a.activity_id))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.noLinkedActivities")})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(xs,{templateId:l}),!n.visible&&e.jsx(M,{variant:"secondary",children:s("admin.couponDetail.hidden")}),!n.is_active&&e.jsx(M,{variant:"secondary",children:s("admin.couponDetail.inactive")}),n.is_active&&e.jsx(M,{children:s("admin.couponDetail.active")})]})]}),e.jsx(Q,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s("admin.couponDetail.titleLabel")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.chinese"),"："]}),n.title_zh]}),e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.english"),"："]}),n.title_en]}),e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.portuguese"),"："]}),n.title_pt]})]})]}),(n.description_zh||n.description_en||n.description_pt)&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s("admin.couponDetail.descriptionLabel")}),e.jsxs("div",{className:"space-y-1 text-sm",children:[n.description_zh&&e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.chinese"),"："]}),n.description_zh]}),n.description_en&&e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.english"),"："]}),n.description_en]}),n.description_pt&&e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.portuguese"),"："]}),n.description_pt]})]})]})]}),e.jsx(Q,{}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.discountType")}),e.jsx("p",{className:"font-medium",children:n.discount_type==="percentage"?s("admin.couponDetail.percentageDiscount"):s("admin.couponDetail.fixedAmount")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.discountValue")}),e.jsx("p",{className:"font-medium text-primary text-lg",children:n.discount_type==="percentage"?`${n.discount_value}%`:`€${n.discount_value}`})]}),n.min_order_amount&&n.min_order_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.minOrderAmount")}),e.jsxs("p",{className:"font-medium",children:["€",n.min_order_amount]})]}),n.max_discount_amount&&n.max_discount_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.maxDiscountAmount")}),e.jsxs("p",{className:"font-medium",children:["€",n.max_discount_amount]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.generated")}),e.jsxs("p",{className:"font-medium",children:[Y," ",s("admin.couponDetail.units")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.claimed")}),e.jsxs("p",{className:"font-medium",children:[$e," ",s("admin.couponDetail.times")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.used")}),e.jsxs("p",{className:"font-medium",children:[Ve," ",s("admin.couponDetail.times")]})]})]}),e.jsx(Q,{}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.validPeriod")}),e.jsxs("p",{className:"font-medium",children:[F(new Date(n.valid_from),"yyyy-MM-dd"),n.valid_until?` - ${F(new Date(n.valid_until),"yyyy-MM-dd")}`:` - ${s("admin.couponDetail.unlimited")}`]})]})]})})]})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(ts,{className:"h-4 w-4"}),s("admin.couponDetail.generatedCoupons")," (",Y,")"]}),S&&S.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Fe,{placeholder:s("admin.couponDetail.searchPlaceholder"),value:h,onChange:a=>A(a.target.value),className:"pl-9"})]}),e.jsxs(B,{value:r,onValueChange:a=>H(a),children:[e.jsx(I,{children:e.jsx(V,{placeholder:s("admin.couponDetail.statusFilter")})}),e.jsxs($,{children:[e.jsx(p,{value:"all",children:s("admin.couponDetail.allStatus")}),e.jsx(p,{value:"active",children:s("admin.couponDetail.statusActive")}),e.jsx(p,{value:"inactive",children:s("admin.couponDetail.statusInactive")})]})]}),e.jsxs(B,{value:f,onValueChange:a=>v(a),children:[e.jsx(I,{children:e.jsx(V,{placeholder:s("admin.couponDetail.usageFilter")})}),e.jsxs($,{children:[e.jsx(p,{value:"all",children:s("admin.couponDetail.usageAll")}),e.jsx(p,{value:"unclaimed",children:s("admin.couponDetail.usageUnclaimed")}),e.jsx(p,{value:"claimed",children:s("admin.couponDetail.usageClaimed")}),e.jsx(p,{value:"used",children:s("admin.couponDetail.usageUsed")})]})]}),e.jsxs(B,{value:x,onValueChange:a=>z(a),children:[e.jsx(I,{children:e.jsx(V,{placeholder:s("admin.couponDetail.sourceFilter")})}),e.jsxs($,{children:[e.jsx(p,{value:"all",children:s("admin.couponDetail.sourceAll")}),e.jsx(p,{value:"share",children:s("admin.couponDetail.sourceShare")}),e.jsx(p,{value:"other",children:s("admin.couponDetail.sourceOther")})]})]})]})]})}),e.jsx(ae,{children:Ie?e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.loading")}):!S||S.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.noCouponsYet")}):q.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.noMatchingCoupons")}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{id:"selectAll",checked:D.size===q.length&&q.length>0,onCheckedChange:Qe}),e.jsx("label",{htmlFor:"selectAll",className:"text-sm cursor-pointer",children:s("admin.couponCode.selectAll")})]}),D.size>0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:s("admin.couponCode.selectedCount",{count:D.size})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>me(!0),children:s("admin.couponCode.batchEditStatus")}),e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>W(!0),children:s("admin.couponCode.batchDelete")})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[q.length," / ",Y]})]})]}),q.map(a=>e.jsxs("div",{className:`rounded-lg border bg-card p-4 ${D.has(a.id)?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{checked:D.has(a.id),onCheckedChange:()=>Ke(a.id)}),e.jsx("div",{className:"w-12 h-12 rounded bg-primary/10 flex items-center justify-center",children:e.jsx(fe,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("code",{className:"font-mono font-semibold text-base",children:a.code}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s("admin.couponDetail.generatedAt"),"：",F(new Date(a.created_at),"yyyy-MM-dd HH:mm")]}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("admin.couponDetail.usage"),"：",a.used_count," / ",a.usage_limit]}),e.jsx(M,{variant:a.is_active?"default":"secondary",children:a.is_active?s("admin.couponDetail.activated"):s("admin.couponDetail.deactivated")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>k(a),title:s("admin.couponDetail.edit"),children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>c(a.id),title:s("admin.couponDetail.delete"),children:e.jsx(ls,{className:"h-4 w-4 text-destructive"})})]})]}),a.user_coupons.length>0?e.jsxs("div",{className:"space-y-2 pt-3 border-t",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:s("admin.couponDetail.claimedUsers")}),a.user_coupons.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-md bg-secondary/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ye,{className:"h-10 w-10",children:[e.jsx(Ne,{src:i.profiles.avatar_url||void 0}),e.jsx(De,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.profiles.display_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("admin.couponDetail.claimedAt"),"：",F(new Date(i.claimed_at),"yyyy-MM-dd HH:mm")]}),i.source&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("admin.couponDetail.source"),"：",i.source==="share"?s("admin.couponDetail.sourceShare"):i.source]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(M,{variant:i.used_at?"default":"secondary",children:i.used_at?`${s("admin.couponDetail.usedAt")} ${F(new Date(i.used_at),"MM-dd HH:mm")}`:s("admin.couponDetail.unused")}),i.used_at&&i.used_by_merchant&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(_e,{className:"h-3 w-3"}),e.jsxs("span",{children:[s("admin.couponDetail.verifiedBy"),"：",i.used_by_merchant.display_name]}),i.used_at_restaurant&&e.jsxs("span",{className:"text-primary",children:["@ ",w(i.used_at_restaurant,"name")]})]})]})]},i.id))]}):e.jsx("p",{className:"text-sm text-muted-foreground pt-3 border-t",children:s("admin.couponDetail.noClaims")})]},a.id))]})})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(rs,{className:"h-4 w-4"}),s("admin.couponDetail.usageHistory")," (",K?.length||0,")"]})}),e.jsx(ae,{children:Be?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:s("admin.couponDetail.loading")}):!K||K.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:s("admin.couponDetail.noUsageHistory")}):e.jsx("div",{className:"space-y-3",children:K.map(a=>e.jsxs("div",{className:"flex items-start gap-4 p-4 border rounded-lg",children:[e.jsxs(ye,{className:"h-10 w-10",children:[a.used_by_profile?.avatar_url?e.jsx(Ne,{src:a.used_by_profile.avatar_url}):null,e.jsx(De,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium",children:a.used_by_profile?.display_name||s("common.unknown")}),e.jsx("span",{className:"text-muted-foreground",children:s("admin.couponDetail.verifiedCoupon")}),a.coupon_code&&e.jsx(M,{variant:"outline",className:"font-mono text-xs",children:a.coupon_code})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground flex-wrap",children:[e.jsx("span",{children:F(new Date(a.used_at),"yyyy-MM-dd HH:mm:ss")}),a.restaurant&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"h-3 w-3"}),w(a.restaurant,"name")]})]}),a.notes&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[s("admin.couponDetail.notes"),": ",a.notes]})]})]},a.id))})})]})]})]}),L&&e.jsx(ps,{open:!!L,onOpenChange:a=>!a&&k(null),couponCode:L,onSuccess:()=>{t.invalidateQueries({queryKey:["templateCouponCodes",l]})}}),e.jsx(hs,{open:Me,onOpenChange:me,selectedCodeIds:Array.from(D),onSuccess:Oe}),e.jsx(be,{open:!!d,onOpenChange:a=>!a&&c(null),children:e.jsxs(we,{children:[e.jsxs(Ce,{children:[e.jsx(Se,{children:s("admin.couponDetail.deleteConfirmTitle")}),e.jsx(Ae,{children:s("admin.couponDetail.deleteConfirmDesc")})]}),e.jsxs(ke,{children:[e.jsx(Le,{disabled:C,children:s("common.cancel")}),e.jsx(Ee,{onClick:()=>d&&Re(d),disabled:C,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s(C?"admin.couponDetail.deleting":"admin.couponDetail.confirmDelete")})]})]})}),e.jsx(be,{open:ze,onOpenChange:W,children:e.jsxs(we,{children:[e.jsxs(Ce,{children:[e.jsx(Se,{children:s("admin.couponCode.batchDeleteTitle")}),e.jsx(Ae,{children:s("admin.couponCode.batchDeleteDescription",{count:D.size})})]}),e.jsxs(ke,{children:[e.jsx(Le,{disabled:R,children:s("common.cancel")}),e.jsx(Ee,{onClick:We,disabled:R,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s(R?"common.deleting":"common.delete")})]})]})})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:s("admin.couponDetail.templateNotFound")}),e.jsx(N,{onClick:()=>_("/admin/coupons"),children:s("admin.couponDetail.backToList")})]})})};export{Ss as default};
//# sourceMappingURL=AdminCouponDetail-DWuTAa9w.js.map
