import{c as P,x as le,o as H,ac as L,af as B,v as j,u as de,r as I,j as e,aw as ce,C as S,m as A,t as p,a8 as T,X as z,I as oe,l as he,w as me,ao as xe,B as g,a3 as V,a4 as O,a5 as X,av as G,f as J,D as ue,b as ge,d as pe,e as je,a6 as ve,a1 as fe}from"./index-QLT-vsIo.js";import{C as W}from"./checkbox-pu4GXP_T.js";import{T as Ne,a as _e,b as D}from"./tabs-Dr4DNDA4.js";import{T as we,a as ye,b as Y,c as y,d as be,e as b}from"./table-BUNOYfDe.js";import{u as ke}from"./useLocalizedContent-8mQ1Oy6B.js";import{T as Ce}from"./triangle-alert-DpmgubYR.js";import{S as Me}from"./search-D8_ehTre.js";import{E as Z}from"./external-link-D6D2PATS.js";import{E as Se}from"./eye-Bp2H6Qcy.js";import{S as Ae}from"./star-B7FUfuhE.js";import{f as E}from"./format-Dpeb5NTb.js";import"./startOfDay-CaII_qte.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=P("ArchiveRestore",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h2",key:"tvwodi"}],["path",{d:"M20 8v11a2 2 0 0 1-2 2h-2",key:"1gkqxj"}],["path",{d:"m9 15 3-3 3 3",key:"1pd0qc"}],["path",{d:"M12 12v9",key:"192myk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=P("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=P("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]),Ie=(r="pending")=>le({queryKey:["admin-comments",r],queryFn:async()=>{let i=j.from("comments").select("*").is("parent_id",null).order("created_at",{ascending:!1}).limit(200);r==="archived"?i=i.eq("archived",!0):(i=i.or("archived.is.null,archived.eq.false"),r==="pending"?i=i.in("moderation_status",["pending","flagged"]):r==="approved"?i=i.eq("moderation_status","approved"):r==="rejected"&&(i=i.eq("moderation_status","rejected")));const{data:t,error:l}=await i;if(l)throw l;if(!t||t.length===0)return[];const h=[...new Set(t.map(a=>a.user_id))],{data:k}=await j.rpc("get_public_profiles",{user_ids:h}),m=new Map((k||[]).map(a=>[a.id,{display_name:a.display_name,avatar_url:a.avatar_url}])),u=t.filter(a=>a.target_type==="restaurant").map(a=>a.target_id),n=t.filter(a=>a.target_type==="activity").map(a=>a.target_id),N=new Map,o=new Map;if(u.length>0){const{data:a}=await j.from("restaurants").select("id, name, name_en, name_pt").in("id",u);a==null||a.forEach(d=>{N.set(d.id,{name:d.name,name_en:d.name_en||void 0,name_pt:d.name_pt||void 0})})}if(n.length>0){const{data:a}=await j.from("activities").select("id, title_zh, title_en, title_pt").in("id",n);a==null||a.forEach(d=>{o.set(d.id,{title_zh:d.title_zh,title_en:d.title_en,title_pt:d.title_pt})})}return t.map(a=>{let d="",C,M;if(a.target_type==="restaurant"){const c=N.get(a.target_id);d=(c==null?void 0:c.name)||"Unknown Restaurant",C=c==null?void 0:c.name_en,M=c==null?void 0:c.name_pt}else if(a.target_type==="activity"){const c=o.get(a.target_id);d=(c==null?void 0:c.title_zh)||"Unknown Activity",C=c==null?void 0:c.title_en,M=c==null?void 0:c.title_pt}return{...a,risk_reasons:Array.isArray(a.risk_reasons)?a.risk_reasons:[],profiles:m.get(a.user_id),target_name:d,target_name_en:C,target_name_pt:M}})}}),Te=()=>{const{toast:r}=H(),i=L();return B({mutationFn:async({commentId:t,action:l})=>{const{data:{user:h}}=await j.auth.getUser();if(!h)throw new Error("Not authenticated");const k={approve:"approved",reject:"rejected",flag:"flagged"},{error:m}=await j.from("comments").update({moderation_status:k[l],reviewed_by:h.id,reviewed_at:new Date().toISOString()}).eq("id",t);if(m)throw m},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-comments"]}),r({title:"审核完成",description:"评论状态已更新"})},onError:()=>{r({title:"操作失败",description:"无法更新评论状态",variant:"destructive"})}})},ze=()=>{const{toast:r}=H(),i=L();return B({mutationFn:async({commentIds:t,action:l})=>{const{data:{user:h}}=await j.auth.getUser();if(!h)throw new Error("Not authenticated");const k={approve:"approved",reject:"rejected"},{error:m}=await j.from("comments").update({moderation_status:k[l],reviewed_by:h.id,reviewed_at:new Date().toISOString()}).in("id",t);if(m)throw m},onSuccess:(t,l)=>{i.invalidateQueries({queryKey:["admin-comments"]}),r({title:"批量审核完成",description:`已${l.action==="approve"?"通过":"拒绝"} ${l.commentIds.length} 条评论`})},onError:()=>{r({title:"批量操作失败",description:"无法更新评论状态",variant:"destructive"})}})},De=()=>{const{toast:r}=H(),i=L();return B({mutationFn:async({commentId:t,archived:l})=>{const{error:h}=await j.from("comments").update({archived:l}).eq("id",t);if(h)throw h},onSuccess:(t,l)=>{i.invalidateQueries({queryKey:["admin-comments"]}),r({title:l.archived?"已归档":"已取消归档",description:l.archived?"评论已移至归档":"评论已恢复到列表"})},onError:()=>{r({title:"操作失败",description:"无法更新归档状态",variant:"destructive"})}})},Ee=()=>{const{toast:r}=H(),i=L();return B({mutationFn:async({commentIds:t,archived:l})=>{const{error:h}=await j.from("comments").update({archived:l}).in("id",t);if(h)throw h},onSuccess:(t,l)=>{i.invalidateQueries({queryKey:["admin-comments"]}),r({title:l.archived?"批量归档完成":"批量取消归档完成",description:`已${l.archived?"归档":"恢复"} ${l.commentIds.length} 条评论`})},onError:()=>{r({title:"批量操作失败",description:"无法更新归档状态",variant:"destructive"})}})},se=r=>r<=30?"bg-green-500/10 text-green-600 border-green-500/20":r<=60?"bg-yellow-500/10 text-yellow-600 border-yellow-500/20":"bg-red-500/10 text-red-600 border-red-500/20",te=r=>{switch(r){case"approved":return e.jsx(p,{variant:"outline",className:"bg-green-500/10 text-green-600 border-green-500/20",children:"已通过"});case"pending":return e.jsx(p,{variant:"outline",className:"bg-yellow-500/10 text-yellow-600 border-yellow-500/20",children:"待审核"});case"flagged":return e.jsx(p,{variant:"outline",className:"bg-orange-500/10 text-orange-600 border-orange-500/20",children:"已标记"});case"rejected":return e.jsx(p,{variant:"outline",className:"bg-red-500/10 text-red-600 border-red-500/20",children:"已拒绝"});default:return e.jsx(p,{variant:"secondary",children:r})}},ae=r=>({spam:"垃圾信息",offensive:"不当言论",harassment:"骚扰攻击",fake_review:"虚假评论",flooding:"刷屏",irrelevant:"无关内容",sensitive_word_detected:"敏感词",parse_error:"解析错误"})[r]||r,Xe=()=>{var $,K;const{t:r,i18n:i}=de();ke();const[t,l]=I.useState("pending"),[h,k]=I.useState(""),[m,u]=I.useState([]),[n,N]=I.useState(null),{data:o,isLoading:a}=Ie(t),d=Te(),C=ze(),M=De(),c=Ee(),_=o==null?void 0:o.filter(s=>{var f,w,q;if(!h)return!0;const x=h.toLowerCase();return s.content.toLowerCase().includes(x)||((w=(f=s.profiles)==null?void 0:f.display_name)==null?void 0:w.toLowerCase().includes(x))||((q=s.target_name)==null?void 0:q.toLowerCase().includes(x))}),re=s=>{u(s?(_==null?void 0:_.map(x=>x.id))||[]:[])},ne=(s,x)=>{u(x?f=>[...f,s]:f=>f.filter(w=>w!==s))},Q=s=>{m.length!==0&&C.mutate({commentIds:m,action:s},{onSuccess:()=>u([])})},ie=s=>{m.length!==0&&c.mutate({commentIds:m,archived:s},{onSuccess:()=>u([])})},R=s=>s.target_type==="restaurant"?`/restaurant/${s.target_id}`:s.target_type==="activity"?`/activity/${s.target_id}`:"#",U=s=>i.language==="en"&&s.target_name_en?s.target_name_en:i.language==="pt"&&s.target_name_pt?s.target_name_pt:s.target_name||"",v={total:(o==null?void 0:o.length)||0,pending:(o==null?void 0:o.filter(s=>s.moderation_status==="pending").length)||0,flagged:(o==null?void 0:o.filter(s=>s.moderation_status==="flagged").length)||0,approved:(o==null?void 0:o.filter(s=>s.moderation_status==="approved").length)||0,rejected:(o==null?void 0:o.filter(s=>s.moderation_status==="rejected").length)||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ce,{className:"h-6 w-6"}),r("admin.comments.title","评论管理")]}),e.jsx("p",{className:"text-muted-foreground",children:r("admin.comments.description","审核和管理用户评论，防止恶意内容")})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(S,{children:e.jsxs(A,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:v.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"总评论"})]})}),e.jsx(S,{className:"border-yellow-500/20",children:e.jsxs(A,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:v.pending}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"待审核"})]})}),e.jsx(S,{className:"border-orange-500/20",children:e.jsxs(A,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:v.flagged}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已标记"})]})}),e.jsx(S,{className:"border-green-500/20",children:e.jsxs(A,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:v.approved}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已通过"})]})}),e.jsx(S,{className:"border-red-500/20",children:e.jsxs(A,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:v.rejected}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已拒绝"})]})})]}),e.jsxs(Ne,{value:t,onValueChange:s=>{l(s),u([])},className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs(_e,{children:[e.jsxs(D,{value:"pending",className:"gap-1",children:[e.jsx(Ce,{className:"h-4 w-4"}),"待审核",v.pending+v.flagged>0&&e.jsx(p,{variant:"secondary",className:"ml-1 h-5 px-1.5",children:v.pending+v.flagged})]}),e.jsxs(D,{value:"approved",className:"gap-1",children:[e.jsx(T,{className:"h-4 w-4"}),"已通过"]}),e.jsxs(D,{value:"rejected",className:"gap-1",children:[e.jsx(z,{className:"h-4 w-4"}),"已拒绝"]}),e.jsxs(D,{value:"archived",className:"gap-1",children:[e.jsx(F,{className:"h-4 w-4"}),"已归档"]})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(Me,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(oe,{placeholder:r("admin.comments.search","搜索评论..."),value:h,onChange:s=>k(s.target.value),className:"pl-9"})]})]}),e.jsxs(S,{children:[e.jsxs(he,{children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2",children:e.jsxs("div",{children:[e.jsxs(me,{children:[t==="pending"&&"审核评论列表",t==="approved"&&"已通过评论",t==="rejected"&&"已拒绝评论",t==="archived"&&"已归档评论"]}),e.jsxs(xe,{children:[t==="pending"&&"待审核和已标记的评论，需要人工审核处理",t==="approved"&&"已审核通过的评论",t==="rejected"&&"已拒绝的评论，不会显示给用户",t==="archived"&&"已归档的评论，用于保持列表简洁"]})]})}),m.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mt-4 p-2 bg-muted rounded-lg flex-wrap",children:[e.jsxs("span",{className:"text-sm",children:["已选择 ",m.length," 项"]}),t==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>Q("approve"),disabled:C.isPending,children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"批量通过"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>Q("reject"),disabled:C.isPending,children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),"批量拒绝"]})]}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>ie(t!=="archived"),disabled:c.isPending,children:t==="archived"?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),"批量恢复"]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"批量归档"]})}),e.jsx(g,{size:"sm",variant:"ghost",onClick:()=>u([]),children:"取消选择"})]})]}),e.jsx(A,{children:a?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"加载中..."}):_&&_.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(we,{children:[e.jsx(ye,{children:e.jsxs(Y,{children:[e.jsx(y,{className:"w-12",children:e.jsx(W,{checked:_.length>0&&m.length===_.length,onCheckedChange:re})}),e.jsx(y,{className:"w-16",children:"风险"}),e.jsx(y,{children:"评论内容"}),e.jsx(y,{children:"用户"}),e.jsx(y,{children:"目标"}),e.jsx(y,{children:"状态"}),e.jsx(y,{children:"时间"}),e.jsx(y,{className:"text-right",children:"操作"})]})}),e.jsx(be,{children:_.map(s=>{var x,f;return e.jsxs(Y,{className:s.risk_score>60?"bg-red-500/5":s.risk_score>30?"bg-yellow-500/5":"",children:[e.jsx(b,{children:e.jsx(W,{checked:m.includes(s.id),onCheckedChange:w=>ne(s.id,w)})}),e.jsx(b,{children:e.jsx(p,{variant:"outline",className:se(s.risk_score),children:s.risk_score})}),e.jsxs(b,{className:"max-w-xs",children:[e.jsx("div",{className:"truncate",title:s.content,children:s.content}),s.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:s.risk_reasons.map((w,q)=>e.jsx(p,{variant:"secondary",className:"text-xs",children:ae(w)},q))})]}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{className:"h-6 w-6",children:[e.jsx(O,{src:(x=s.profiles)==null?void 0:x.avatar_url}),e.jsx(X,{children:e.jsx(G,{className:"h-3 w-3"})})]}),e.jsx("span",{className:"text-sm truncate max-w-[100px]",children:((f=s.profiles)==null?void 0:f.display_name)||"Unknown"})]})}),e.jsx(b,{children:e.jsxs(J,{to:R(s),className:"flex items-center gap-1 text-sm hover:underline text-primary",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:U(s)}),e.jsx(Z,{className:"h-3 w-3"})]})}),e.jsx(b,{children:te(s.moderation_status)}),e.jsx(b,{className:"text-sm text-muted-foreground",children:E(new Date(s.created_at),"MM-dd HH:mm")}),e.jsx(b,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(g,{size:"icon",variant:"ghost",onClick:()=>N(s),title:"查看详情",children:e.jsx(Se,{className:"h-4 w-4"})}),t==="pending"&&s.moderation_status!=="approved"&&e.jsx(g,{size:"icon",variant:"ghost",onClick:()=>d.mutate({commentId:s.id,action:"approve"}),disabled:d.isPending,title:"通过",className:"text-green-600 hover:text-green-700",children:e.jsx(T,{className:"h-4 w-4"})}),t==="pending"&&s.moderation_status!=="rejected"&&e.jsx(g,{size:"icon",variant:"ghost",onClick:()=>d.mutate({commentId:s.id,action:"reject"}),disabled:d.isPending,title:"拒绝",className:"text-red-600 hover:text-red-700",children:e.jsx(z,{className:"h-4 w-4"})}),e.jsx(g,{size:"icon",variant:"ghost",onClick:()=>M.mutate({commentId:s.id,archived:t!=="archived"}),disabled:M.isPending,title:t==="archived"?"恢复":"归档",className:"text-muted-foreground hover:text-foreground",children:t==="archived"?e.jsx(ee,{className:"h-4 w-4"}):e.jsx(F,{className:"h-4 w-4"})})]})})]},s.id)})})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:h?"没有找到匹配的评论":"暂无评论"})})]})]}),e.jsx(ue,{open:!!n,onOpenChange:()=>N(null),children:e.jsxs(ge,{className:"max-w-2xl",children:[e.jsxs(pe,{children:[e.jsx(je,{children:"评论详情"}),e.jsx(ve,{children:"查看评论完整信息和 AI 分析结果"})]}),n&&e.jsx(fe,{className:"max-h-[60vh]",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[e.jsxs(V,{children:[e.jsx(O,{src:($=n.profiles)==null?void 0:$.avatar_url}),e.jsx(X,{children:e.jsx(G,{className:"h-4 w-4"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:((K=n.profiles)==null?void 0:K.display_name)||"Unknown"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:E(new Date(n.created_at),"yyyy-MM-dd HH:mm:ss")})]}),n.rating_value&&e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[e.jsx(Ae,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),e.jsx("span",{children:n.rating_value})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论内容"}),e.jsx("div",{className:"p-3 bg-muted rounded-lg whitespace-pre-wrap",children:n.content})]}),n.image_url&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论图片"}),e.jsx("img",{src:n.image_url,alt:"Comment",className:"max-w-full h-auto rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论目标"}),e.jsxs(J,{to:R(n),className:"flex items-center gap-2 p-3 bg-muted rounded-lg hover:bg-muted/80",children:[e.jsxs("span",{children:[n.target_type==="restaurant"?"餐厅":"活动",":"]}),e.jsx("span",{className:"text-primary",children:U(n)}),e.jsx(Z,{className:"h-4 w-4"})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),"AI 分析结果"]}),e.jsxs("div",{className:"p-3 bg-muted rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"风险评分:"}),e.jsxs(p,{variant:"outline",className:se(n.risk_score),children:[n.risk_score,"/100"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"审核状态:"}),te(n.moderation_status)]}),n.risk_reasons.length>0&&e.jsxs("div",{children:[e.jsx("span",{children:"检测问题:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:n.risk_reasons.map((s,x)=>e.jsx(p,{variant:"secondary",children:ae(s)},x))})]}),n.ai_reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["AI 审核时间: ",E(new Date(n.ai_reviewed_at),"yyyy-MM-dd HH:mm:ss")]}),n.reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["人工审核时间: ",E(new Date(n.reviewed_at),"yyyy-MM-dd HH:mm:ss")]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[n.moderation_status!=="approved"&&e.jsxs(g,{onClick:()=>{d.mutate({commentId:n.id,action:"approve"},{onSuccess:()=>N(null)})},disabled:d.isPending,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"通过"]}),n.moderation_status!=="rejected"&&e.jsxs(g,{variant:"destructive",onClick:()=>{d.mutate({commentId:n.id,action:"reject"},{onSuccess:()=>N(null)})},disabled:d.isPending,children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"拒绝"]}),e.jsx(g,{variant:"outline",onClick:()=>N(null),children:"关闭"})]})]})})]})})]})};export{Xe as default};
