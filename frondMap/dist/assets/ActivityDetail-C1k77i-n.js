import{c as ks,j as e,d as o,C as O,e as X,f as U,r as c,u as oe,D as we,t as be,a4 as ye,a5 as Ce,S as Q,a6 as Qe,a7 as Me,n as R,a8 as ie,a9 as es,B as N,K as J,y as ss,aa as Ss,a3 as Fe,A as _s,E as Ls,F as Ds,G as P,J as ze,z as I,w as Ts,x as As,h as Is,k as Es,ab as Ps,ac as T,L as K,o as $e,b as Rs,$ as Ms,a0 as Fs,a1 as zs,a2 as $s,q as Oe,M as He,N as Os,O as Hs,Q as Bs,R as Us,T as qs,U as Gs,V as Ws,W as Xs}from"./index-DwrhXWM3.js";import{S as Be}from"./separator-CNTWHrNk.js";import{C as Js,a as Vs,b as Zs}from"./collapsible-BTupzeaG.js";import{C as Ys,p as Ue}from"./xiaoxiong-logo-v3-Ck1s8SbX.js";import{c as Ks,d as Qs,a as ea,e as sa,f as aa,g as ta,h as ra,b as na}from"./useActivities-Cd0_l4-w.js";import{u as ia,a as la,b as oa}from"./useActivityParticipation-CDLNqZ-6.js";import{u as as}from"./useLocalizedContent-Csh5LJrs.js";import ca from"./RestaurantComments-DulzAymY.js";import{m as W}from"./mapbox-gl-CX9xSvRx.js";import{m as da}from"./map-icon-DR07RZr_.js";import{C as qe}from"./checkbox-BtP1VOhp.js";import{R as ma}from"./ReportDialog-Cx1XkpRD.js";import{A as ha}from"./ActivityTermsAgreement-CqyVJRKt.js";import{T as ua,a as xa,b as ge,c as fe}from"./tabs-DJpjTeDe.js";import{u as pa,a as ga}from"./useGlobalHandbook-CH5BINAM.js";import{R as je}from"./RichTextEditor-D_Dn_4vW.js";import{B as ve}from"./book-open-Dz0b_DSD.js";import{S as fa}from"./save-C5DHsL2M.js";import{S as ja}from"./square-pen-DqUDspQ2.js";import{L as Na}from"./LocationPermissionDialog-Db3QYruD.js";import{u as ts}from"./use-mobile-BAoiu2BO.js";import{a as va,u as wa}from"./externalLinks-CJaMGLdE.js";import{C as ba}from"./circle-check-big-BOsVXEx4.js";import{G as le}from"./gift-uDZJF6Ux.js";import{S as $}from"./share-2-ZEtejNPC.js";import{M as ne}from"./message-circle-cHjzR6BQ.js";import{L as ya}from"./link-2-CcOJZSng.js";import{g as Ca,c as ka,N as Ne}from"./geolocation-DTCM05Xm.js";import{u as Sa,a as _a,b as La,c as Da}from"./useCoupons-BtkxeQeY.js";import{C as Ta}from"./chevron-left-vFbBE41j.js";import{S as Ge}from"./shield-alert-DKpglNTb.js";import{F as Aa}from"./file-pen-DyX8aJh0.js";import{F as We}from"./file-text-aMSoy-OB.js";import{U as Xe}from"./utensils-crossed-Ddi7JSRn.js";import{S as Je}from"./shopping-bag-CQSmC7bM.js";import{U as Ve}from"./users-BJ0tey1w.js";import{F as Ia}from"./forward-QGYQxYlk.js";import{H as Ze}from"./heart-CaMSA8jY.js";import{S as Ea}from"./star-D5FH4An7.js";import{f as Ye}from"./format-BrDZPov3.js";import"./index-CLs7u5X_.js";import"./useSensitiveWords-CEt0JnjP.js";import"./trash-2-BpBngrWz.js";import"./image-D_6oqjpi.js";import"./volume-x-BxIK6Z37.js";import"./input-otp-Dvj-bJql.js";import"./plus-oULWhB69.js";import"./useActivityRules-whE0nyAk.js";import"./circle-alert-Ca69ZvVh.js";import"./isEqual-D_z53ADz.js";import"./startOfDay-C97cAIwM.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=ks("Instagram",[["rect",{width:"20",height:"20",x:"2",y:"2",rx:"5",ry:"5",key:"2e1cvw"}],["path",{d:"M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z",key:"9exkf1"}],["line",{x1:"17.5",x2:"17.51",y1:"6.5",y2:"6.5",key:"r4j83e"}]]),Ra=()=>e.jsxs("div",{className:"min-h-screen bg-secondary/20 pb-8",children:[e.jsxs("div",{className:"relative h-[33vh] overflow-hidden",children:[e.jsx(o,{className:"w-full h-full rounded-none"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent"}),e.jsx("div",{className:"absolute top-4 left-4",children:e.jsx(o,{className:"h-10 w-10 rounded-md"})}),e.jsxs("div",{className:"absolute top-4 right-4 flex gap-2",children:[e.jsx(o,{className:"h-10 w-10 rounded-md"}),e.jsx(o,{className:"h-10 w-10 rounded-md"})]})]}),e.jsxs("div",{className:"container mx-auto px-4 -mt-20 relative z-10",children:[e.jsx(O,{className:"shadow-large",children:e.jsxs(X,{children:[e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx(o,{className:"h-6 w-16 rounded-full"}),e.jsx(o,{className:"h-6 w-20 rounded-full"}),e.jsx(o,{className:"h-6 w-24 rounded-full"})]}),e.jsx(o,{className:"h-9 w-3/4 mb-4"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mb-4",children:[e.jsx(o,{className:"h-5 w-24"}),e.jsx(o,{className:"h-5 w-20"}),e.jsx(o,{className:"h-5 w-28"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(o,{className:"h-5 w-5 flex-shrink-0"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"h-4 w-32"}),e.jsx(o,{className:"h-4 w-40"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(o,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"h-4 w-20"}),e.jsx(o,{className:"h-4 w-32"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(o,{className:"h-10 w-28 rounded-md"}),e.jsx(o,{className:"h-10 w-32 rounded-md"}),e.jsx(o,{className:"h-10 w-24 rounded-md"})]})]})}),e.jsxs(O,{className:"mt-6 shadow-large",children:[e.jsx(X,{children:e.jsx(o,{className:"h-6 w-36"})}),e.jsxs(U,{className:"space-y-3",children:[e.jsx(o,{className:"h-4 w-full"}),e.jsx(o,{className:"h-4 w-full"}),e.jsx(o,{className:"h-4 w-5/6"}),e.jsx(o,{className:"h-4 w-4/5"})]})]}),e.jsxs(O,{className:"mt-6 shadow-large",children:[e.jsx(X,{children:e.jsx(o,{className:"h-6 w-28"})}),e.jsxs(U,{className:"space-y-2",children:[e.jsx(o,{className:"h-4 w-full"}),e.jsx(o,{className:"h-4 w-3/4"})]})]}),e.jsxs(O,{className:"mt-6 shadow-large",children:[e.jsxs(X,{className:"flex flex-row items-center justify-between",children:[e.jsx(o,{className:"h-6 w-40"}),e.jsx(o,{className:"h-5 w-24"})]}),e.jsxs(U,{children:[e.jsx(o,{className:"h-[200px] w-full rounded-lg mb-4"}),e.jsx("div",{className:"space-y-3",children:[1,2,3].map(n=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsx(o,{className:"h-16 w-16 rounded-lg flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(o,{className:"h-5 w-40"}),e.jsx(o,{className:"h-4 w-full"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{className:"h-5 w-16 rounded-full"}),e.jsx(o,{className:"h-5 w-12"})]})]})]},n))})]})]})]})]}),rs=c.memo(({restaurants:n,onMarkerClick:u})=>{const j=c.useRef(null),s=c.useRef(null),r=c.useRef([]),[A,b]=c.useState(!1),i=c.useRef(null);return c.useEffect(()=>{if(!j.current||s.current)return;const f="pk.eyJ1IjoieGlhb3hpb25nMTIzIiwiYSI6ImNtNTFjOXliYjF1Y2IyaXM4bnNzMGxvdnkifQ.mPcWqH7ndIrjEqlWIJVk8g";W.accessToken=f;const p=n.reduce((x,h)=>x+Number(h.restaurants.lat||0),0)/n.length,d=n.reduce((x,h)=>x+Number(h.restaurants.lng||0),0)/n.length;return s.current=new W.Map({container:j.current,style:"mapbox://styles/mapbox/light-v11",center:[d,p],zoom:12,cooperativeGestures:!0,doubleClickZoom:!1}),s.current.addControl(new W.NavigationControl,"top-right"),s.current.on("load",()=>{b(!0)}),()=>{var x;r.current.forEach(h=>h.remove()),r.current=[],i.current&&(i.current.remove(),i.current=null),(x=s.current)==null||x.remove(),s.current=null,b(!1)}},[]),c.useEffect(()=>{if(!s.current||!A||n.length===0)return;(()=>{var p;if(r.current.forEach(d=>d.remove()),r.current=[],i.current&&(i.current.remove(),i.current=null),n.forEach(d=>{const x=Number(d.restaurants.lat),h=Number(d.restaurants.lng);if(isNaN(x)||isNaN(h))return;const v=document.createElement("div");v.className="p-3 min-w-[200px]",v.innerHTML=`
          <div class="space-y-2">
            <h3 class="font-bold text-base text-foreground">${d.restaurants.name}</h3>
            <p class="text-xs text-muted-foreground">${d.restaurants.address}</p>
          </div>
        `;const l=new W.Popup({offset:25,closeButton:!0,closeOnClick:!1,closeOnMove:!1,maxWidth:"300px"}).setLngLat([h,x]).setDOMContent(v),m=document.createElement("div");m.className="custom-marker",m.style.backgroundImage=`url(${da})`,m.style.width="40px",m.style.height="40px",m.style.backgroundSize="contain",m.style.backgroundRepeat="no-repeat",m.style.backgroundPosition="center",m.style.cursor="pointer";const w=new W.Marker({element:m,draggable:!1}).setLngLat([h,x]).addTo(s.current),y=w.getElement();y.style.cursor="pointer";const g=_=>{_.stopPropagation(),_.preventDefault(),i.current&&i.current!==l&&i.current.remove(),l.addTo(s.current),i.current=l,s.current.easeTo({center:[h,x],zoom:17,duration:800}),u&&u(d.restaurant_id)};y.addEventListener("click",g,!0),l.on("close",()=>{i.current===l&&(i.current=null)}),r.current.push(w)}),n.length>1){const d=new W.LngLatBounds;n.forEach(x=>{const h=Number(x.restaurants.lat),v=Number(x.restaurants.lng);!isNaN(h)&&!isNaN(v)&&d.extend([v,h])}),(p=s.current)==null||p.fitBounds(d,{padding:50,maxZoom:14})}})()},[n,A,u]),n.length===0?null:e.jsx("div",{ref:j,className:"w-full h-[350px] rounded-lg"})});rs.displayName="ActivityParticipationMap";const Ma=({open:n,onOpenChange:u,restaurants:j,participatingRestaurantIds:s,onConfirm:r,isPending:A,isParticipating:b})=>{const{t:i}=oe(),{localizeRestaurant:f}=as(),[p,d]=c.useState([]);c.useEffect(()=>{n&&d(s)},[n,s]);const x=l=>{d(m=>m.includes(l)?m.filter(w=>w!==l):[...m,l])},h=()=>{p.length===j.length?d([]):d(j.map(l=>l.id))},v=()=>{r(p)};return e.jsx(we,{open:n,onOpenChange:u,children:e.jsxs(be,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(ye,{children:[e.jsxs(Ce,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"选择参与的餐厅"]}),e.jsx(Qe,{children:"勾选要参与活动的餐厅，取消勾选将退出活动"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b",children:[e.jsx(qe,{id:"select-all",checked:p.length===j.length,onCheckedChange:h}),e.jsxs(Me,{htmlFor:"select-all",className:"cursor-pointer font-semibold",children:["全选/取消全选 (",p.length,"/",j.length,")"]})]}),e.jsx("div",{className:"space-y-3",children:j.map(l=>{const m=f(l),w=p.includes(l.id),y=s.includes(l.id);return e.jsx(O,{className:`transition-all ${w?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,children:e.jsx(U,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(qe,{id:l.id,checked:w,onCheckedChange:()=>x(l.id)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(Me,{htmlFor:l.id,className:"cursor-pointer flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold truncate",children:m.name}),y&&e.jsxs(R,{variant:"secondary",className:"text-xs",children:[e.jsx(ie,{className:"w-3 h-3 mr-1"}),"已参与"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:l.address}),m.type&&m.type.length>0&&e.jsx("div",{className:"flex gap-1 mt-1 flex-wrap",children:m.type.slice(0,2).map((g,_)=>e.jsx(R,{variant:"outline",className:"text-xs",children:g},_))})]})]})})},l.id)})})]}),e.jsxs(es,{children:[e.jsx(N,{variant:"outline",onClick:()=>u(!1),disabled:A,children:i("common.cancel")}),e.jsx(N,{onClick:v,disabled:A,children:A?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),i("common.loading")]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"确认 (",p.length,")"]})})]})]})})},Ke=({children:n})=>{const{t:u,i18n:j}=oe(),{isAdmin:s}=ss(),{data:r,isLoading:A}=pa(),b=ga(),[i,f]=c.useState(!1),[p,d]=c.useState(!1),[x,h]=c.useState("zh"),[v,l]=c.useState(""),[m,w]=c.useState(""),[y,g]=c.useState("");c.useEffect(()=>{r&&(l(r.content_zh),w(r.content_en),g(r.content_pt))},[r]);const _=()=>{if(!r)return"";const V=j.language;return V==="zh"?r.content_zh||r.content_en||r.content_pt||"":V==="pt"?r.content_pt||r.content_en||r.content_zh||"":r.content_en||r.content_zh||r.content_pt||""},L=r&&(r.content_zh||r.content_en||r.content_pt),ee=async()=>{if(r)try{await b.mutateAsync({id:r.id,content_zh:v,content_en:m,content_pt:y}),Fe({title:u("common.success"),description:u("activities.handbook.updateSuccess")}),d(!1)}catch{Fe({title:u("common.error"),description:u("activities.handbook.updateError"),variant:"destructive"})}};return e.jsxs(we,{open:i,onOpenChange:f,children:[e.jsx(Ss,{asChild:!0,children:n}),e.jsxs(be,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ye,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-5 h-5 text-primary"}),e.jsx(Ce,{children:u("activities.handbook.title")})]})}),A?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{className:"w-6 h-6 animate-spin text-primary"})}):p&&s?e.jsx("div",{className:"space-y-4",children:e.jsxs(ua,{value:x,onValueChange:h,children:[e.jsxs(xa,{className:"grid w-full grid-cols-3",children:[e.jsx(ge,{value:"zh",children:"中文"}),e.jsx(ge,{value:"en",children:"English"}),e.jsx(ge,{value:"pt",children:"Português"})]}),e.jsx(fe,{value:"zh",className:"mt-4",children:e.jsx(je,{value:v,onChange:l,placeholder:"请输入中文活动手册内容..."})}),e.jsx(fe,{value:"en",className:"mt-4",children:e.jsx(je,{value:m,onChange:w,placeholder:"Enter English activity handbook content..."})}),e.jsx(fe,{value:"pt",className:"mt-4",children:e.jsx(je,{value:y,onChange:g,placeholder:"Digite o conteúdo do manual da atividade em português..."})})]})}):e.jsx("div",{className:"space-y-4",children:L?e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:_()}}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ve,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:u("activities.handbook.empty")}),s&&e.jsx("p",{className:"text-sm mt-2",children:u("activities.handbook.addPrompt")})]})}),e.jsx(es,{className:"gap-2 sm:gap-0",children:p?e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",onClick:()=>d(!1),children:u("common.cancel")}),e.jsxs(N,{onClick:ee,disabled:b.isPending,children:[b.isPending?e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(fa,{className:"w-4 h-4 mr-2"}),u("common.save")]})]}):s&&e.jsxs(N,{onClick:()=>d(!0),children:[e.jsx(ja,{className:"w-4 h-4 mr-2"}),u(L?"common.edit":"activities.handbook.add")]})})]})]})},Fa=({open:n,onOpenChange:u,activityTitle:j,activityId:s,onShareComplete:r,isProcessing:A=!1,hasAlreadyClaimed:b=!1})=>{const{t:i}=oe(),f=ts(),[p,d]=c.useState(!1),[x,h]=c.useState(!1);c.useEffect(()=>{h(typeof navigator<"u"&&!!navigator.share&&typeof navigator.canShare=="function")},[]);const v=async()=>{try{await navigator.clipboard.writeText(window.location.href),I.success(i("common.linkCopied")),d(!0)}catch(y){console.error("Error copying link:",y),I.error(i("common.shareError"))}},l=y=>{const g=encodeURIComponent(window.location.href),_=encodeURIComponent(`${j} - Xiaoxiong Market`);let L="";switch(y){case"whatsapp":L=`https://wa.me/?text=${_}%20${g}`;break;case"facebook":L=`https://www.facebook.com/sharer/sharer.php?u=${g}`;break;case"twitter":L=`https://twitter.com/intent/tweet?text=${_}&url=${g}`;break;case"telegram":L=`https://t.me/share/url?url=${g}&text=${_}`;break;case"linkedin":L=`https://www.linkedin.com/sharing/share-offsite/?url=${g}`;break;case"reddit":L=`https://reddit.com/submit?url=${g}&title=${_}`;break;case"line":L=`https://social-plugins.line.me/lineit/share?url=${g}`;break;case"wechat":v(),I.info(i("sharing.copiedForWeChat"));return;case"instagram":v(),I.info(i("sharing.copiedForInstagram"));return;default:return}va()?window.location.href=L:window.open(L,"_blank","noopener,noreferrer"),d(!0)},m=async()=>{const y={title:j,text:`${j} - Xiaoxiong Market`,url:window.location.href};try{navigator.share&&navigator.canShare&&navigator.canShare(y)?(await navigator.share(y),d(!0)):v()}catch(g){g.name!=="AbortError"&&(console.error("Error sharing:",g),I.error(i("common.shareError")))}},w=()=>{p&&r()};return e.jsx(we,{open:n,onOpenChange:u,children:e.jsxs(be,{className:"sm:max-w-md",children:[e.jsxs(ye,{children:[e.jsxs(Ce,{className:"flex items-center gap-2",children:[b?e.jsx(ba,{className:"w-5 h-5 text-primary"}):e.jsx(le,{className:"w-5 h-5 text-primary"}),i("shareDialog.title")]}),e.jsx(Qe,{className:"space-y-2",children:b?e.jsx("p",{className:"text-primary font-medium",children:i("shareDialog.alreadyShared")}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:i("shareDialog.description")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i("shareDialog.hint")})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col gap-2",children:f&&x?e.jsxs(N,{onClick:m,className:"w-full",variant:"default",children:[e.jsx($,{className:"w-4 h-4 mr-2"}),i("sharing.shareToApps")]}):e.jsxs(_s,{children:[e.jsx(Ls,{asChild:!0,children:e.jsxs(N,{className:"w-full",variant:"default",children:[e.jsx($,{className:"w-4 h-4 mr-2"}),i("sharing.selectPlatform")]})}),e.jsxs(Ds,{className:"w-56",children:[x&&e.jsxs(e.Fragment,{children:[e.jsxs(P,{onClick:m,children:[e.jsx($,{className:"w-4 h-4 mr-2"}),i("sharing.systemShare")]}),e.jsx(ze,{})]}),e.jsxs(P,{onClick:()=>l("wechat"),children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"WeChat"]}),e.jsxs(P,{onClick:()=>l("instagram"),children:[e.jsx(Pa,{className:"w-4 h-4 mr-2"}),"Instagram"]}),e.jsxs(P,{onClick:()=>l("whatsapp"),children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"WhatsApp"]}),e.jsxs(P,{onClick:()=>l("facebook"),children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"Facebook"]}),e.jsxs(P,{onClick:()=>l("twitter"),children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"X (Twitter)"]}),e.jsxs(P,{onClick:()=>l("telegram"),children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Telegram"]}),e.jsxs(P,{onClick:()=>l("linkedin"),children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"LinkedIn"]}),e.jsxs(P,{onClick:()=>l("line"),children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"LINE"]}),e.jsxs(P,{onClick:()=>l("reddit"),children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"Reddit"]}),e.jsx(ze,{}),e.jsxs(P,{onClick:v,children:[e.jsx(ya,{className:"w-4 h-4 mr-2"}),i("common.copyLink")]})]})]})}),!b&&e.jsx(N,{onClick:w,disabled:!p||A,className:"w-full",variant:p?"default":"secondary",children:A?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),i("shareDialog.claiming")]}):p?e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),i("shareDialog.confirmButton")]}):i("shareDialog.shareFirst")})]})]})})},Rt=()=>{var Pe;const{id:n}=Ts(),u=As(),j=Is(),{t:s}=oe(),{user:r}=Es(),{isMerchant:A,isSupervisor:b,isAdmin:i}=ss(),{data:f}=Ps(),{localizeActivity:p,localizeRestaurant:d,currentLang:x}=as();ts();const[h,v]=T.useState(!1),[l,m]=T.useState(!1),[w,y]=T.useState(null),[g,_]=T.useState(!1),[L,ee]=T.useState(!1),[V,ce]=T.useState(!1),[ns,ke]=T.useState(!1),[de,is]=T.useState(!0),[ls,me]=T.useState(!1),[os,he]=T.useState(!1),[cs,Se]=T.useState(!1),[ds,ue]=T.useState(!1);wa({pageType:"activity",targetId:n});const{data:se=[]}=Sa(n),{data:q=!1}=_a(n),{data:xe}=La(),_e=Da(),H=se.length>0||!!xe,ms=T.useCallback(a=>{j(`/restaurant/${a}`,{state:{fromActivity:n}})},[j,n]),Le=((Pe=u.state)==null?void 0:Pe.from)==="admin"?"/admin/activities":"/activities",{data:t,isLoading:hs}=Ks(n),{data:F,isLoading:us}=Qs(n),{data:xs=[]}=ea(),ps=xs.map(a=>a.activity_id),{data:gs=0}=sa(n),{data:fs=0}=aa(n),ae=ta(),{data:C}=ra(t==null?void 0:t.creator_id),pe=na(),{data:M=[]}=ia(),{data:B=[]}=la(n),z=oa(),k=t?p(t):null,De=t?ps.includes(t.id):!1,Z=A||b,js=c.useCallback(()=>{!r||!t||pe.mutate(t.id)},[r,t,pe]),te=M.filter(a=>B.includes(a.id)).length,Y=te>0;M.length,te>0&&te<M.length;const Ns=c.useCallback(()=>{if(!(!t||!Z||M.length===0))if(b)ce(!0);else if(Y)for(const a of M)B.includes(a.id)&&z.mutate({activityId:t.id,restaurantId:a.id});else for(const a of M)z.mutate({activityId:t.id,restaurantId:a.id})},[t,Z,M,b,Y,B,z]),vs=c.useCallback(a=>{if(!t)return;const S=a.filter(E=>!B.includes(E)),D=B.filter(E=>!a.includes(E));S.forEach(E=>{z.mutate({activityId:t.id,restaurantId:E})}),D.forEach(E=>{z.mutate({activityId:t.id,restaurantId:E})}),ce(!1)},[t,B,z]),ws=c.useCallback(()=>{he(!0)},[]),bs=c.useCallback(async()=>{he(!1),ee(!0);try{const a=await Ca();y({lat:a.coords.latitude,lng:a.coords.longitude}),_(!0),I.success(s("map.locationEnabled"))}catch(a){console.error("Location error:",a),_(!1)}finally{ee(!1)}},[s]);c.useCallback(()=>{y(null),_(!1)},[]),T.useEffect(()=>{if(r&&H&&!q&&de){const a=setTimeout(()=>{is(!1)},3e3);return()=>clearTimeout(a)}},[r,H,q,de]);const Te=c.useCallback(async()=>{try{await navigator.clipboard.writeText(window.location.href),I.success(s("common.linkCopied"))}catch(a){console.error("Error copying link:",a),I.error(s("common.shareError"))}},[s]),Ae=c.useCallback(async()=>{if(!t||!k)return;const a={title:k.title,text:`${k.title} - Xiaoxiong Market

${k.content.replace(/<[^>]*>/g,"").substring(0,200)}...`,url:window.location.href};try{navigator.share&&typeof navigator.canShare=="function"&&navigator.canShare(a)?(await navigator.share(a),I.success(s("common.shareSuccess"))):Te()}catch(S){S.name!=="AbortError"&&(console.error("Error sharing:",S),I.error(s("common.shareError")))}},[t,k,Te,s]),ys=c.useCallback(()=>{if(!(!t||!k)){if(!r){ue(!0);return}H?me(!0):(Ae(),ae.mutateAsync({activityId:n,userId:r.id}).catch(()=>{}))}},[t,k,r,H,Ae,ae,n]),Cs=c.useCallback(async()=>{if(!(!t||!r)){Se(!0);try{await ae.mutateAsync({activityId:n,userId:r.id});const a=se.length>0?se[0]:xe;a&&(await _e.mutateAsync({templateId:a.id,activityId:n,source:"share"}),I.success(s("coupon.claimSuccess"))),me(!1)}catch(a){console.error("Error claiming coupon:",a),I.error(s("common.error"))}finally{Se(!1)}}},[t,r,ae,n,se,xe,_e,s]),G=c.useMemo(()=>{if(!F)return[];const a=F.map(S=>{if(w){const D=ka(w.lat,w.lng,Number(S.restaurants.lat),Number(S.restaurants.lng));return{...S,distance:D}}return{...S,distance:void 0}});return g&&w?a.sort((S,D)=>S.distance!==void 0&&D.distance!==void 0?S.distance-D.distance:0):a.sort((S,D)=>{const E=Number(S.restaurants.rating)||0;return(Number(D.restaurants.rating)||0)-E})},[F,g,w]);if(hs)return e.jsx(Ra,{});if(!t||!k||t.status==="draft"&&!i)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl text-muted-foreground",children:s("error.notFound")}),e.jsx(N,{asChild:!0,className:"mt-4",children:e.jsx(K,{to:Le,children:s("common.back")})})]})});const Ie=new Date(t.start_date),re=t.end_date?new Date(t.end_date):null,Ee=re?new Date<=re:new Date>=Ie;return e.jsxs("div",{className:"min-h-screen bg-secondary/20",children:[e.jsxs("div",{className:"relative h-[33vh] overflow-hidden",children:[t.media_type==="video"&&t.video_url?e.jsx("video",{src:t.video_url,poster:t.image_url||void 0,className:"w-full h-full object-cover",muted:!0,loop:!0,playsInline:!0,autoPlay:!0}):e.jsx("img",{src:t.image_url||"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=1200&q=80",alt:k.title,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent"}),e.jsx(N,{asChild:!0,variant:"secondary",size:"icon",className:"absolute top-4 left-4",children:e.jsx(K,{to:Le,children:e.jsx(Ta,{className:"w-5 h-5"})})}),r&&Z&&f&&!f.activity_terms_agreed&&e.jsxs(K,{to:"/profile?tab=activities",className:"absolute top-4 left-16 bg-destructive/95 backdrop-blur-sm text-destructive-foreground text-xs px-3 py-1.5 rounded-full shadow-lg whitespace-nowrap animate-pulse flex items-center gap-1.5 hover:bg-destructive transition-colors",children:[e.jsx(Ge,{className:"w-3.5 h-3.5"}),s("activities.termsNotAgreed")]}),e.jsxs("div",{className:"absolute top-4 right-4 flex gap-2 items-start",children:[t.status==="draft"&&i&&e.jsxs(R,{variant:"outline",className:"bg-amber-500/90 text-white border-amber-600",children:[e.jsx(Aa,{className:"w-3 h-3 mr-1"}),s("admin.activities.draftPreview")]}),t.pinned&&e.jsx(R,{className:"bg-accent",children:s("activities.pinned")}),e.jsx(ma,{targetType:"activity",targetId:t.id,onLoginRequired:()=>ue(!0),trigger:e.jsx(N,{variant:"secondary",size:"icon",className:"shadow-lg",children:e.jsx(Ge,{className:"w-5 h-5"})})}),e.jsxs("div",{className:"relative",children:[e.jsxs(N,{variant:"secondary",size:"icon",className:"shadow-lg relative",onClick:ys,children:[e.jsx($,{className:"w-5 h-5"}),H&&!q&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-primary text-primary-foreground rounded-full w-4 h-4 flex items-center justify-center",children:e.jsx(le,{className:"w-2.5 h-2.5"})}),H&&q&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center",children:e.jsx(ie,{className:"w-2.5 h-2.5"})})]}),r&&H&&!q&&de&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-primary/95 backdrop-blur-sm text-primary-foreground text-xs px-3 py-1.5 rounded-full shadow-lg whitespace-nowrap animate-pulse z-10",children:[e.jsx(le,{className:"w-3 h-3 inline mr-1"}),s("activities.shareToGetCoupon")]})]})]})]}),e.jsx("div",{className:"container mx-auto max-w-6xl px-4 -mt-20 relative z-10 pb-12",children:e.jsxs(O,{className:"shadow-large",children:[e.jsxs(X,{className:"relative",children:[e.jsx("div",{className:"hidden sm:block absolute top-4 right-4",children:e.jsx(Ke,{children:e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(We,{className:"w-4 h-4"}),s("activities.handbook.button")]})})}),e.jsxs("div",{className:"flex flex-col gap-4 sm:pr-32",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(R,{variant:Ee?"default":"secondary",children:s(Ee?"activities.ongoing":"activities.ended")}),t.repeat_mode&&t.repeat_mode!=="none"&&t.repeat_mode!=="days_before"&&e.jsx(R,{variant:"outline",children:s(`activities.repeat.${t.repeat_mode}`)}),t.service_type&&e.jsxs(R,{variant:"outline",className:"flex items-center gap-1.5",children:[t.service_type==="dine_in"&&e.jsx(Xe,{className:"w-3.5 h-3.5"}),t.service_type==="takeaway"&&e.jsx(Je,{className:"w-3.5 h-3.5"}),t.service_type==="both"&&e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"w-3.5 h-3.5"}),e.jsx(Je,{className:"w-3.5 h-3.5"})]}),s(`activities.serviceType.${t.service_type}`)]}),e.jsx("div",{className:"sm:hidden",children:e.jsx(Ke,{children:e.jsxs(N,{variant:"outline",size:"sm",className:"gap-1.5 h-7 px-2",children:[e.jsx(We,{className:"w-3.5 h-3.5"}),s("activities.handbook.button")]})})})]}),e.jsx($e,{className:"text-3xl",children:k.title}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap gap-x-6 gap-y-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Rs,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[Ye(Ie,"PPP"),re&&` - ${Ye(re,"PPP")}`]})]}),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Ve,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[gs," ",s("activities.subscribersCount")]})]}),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Ia,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[fs," ",s("activities.shareCount")]})]}),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Q,{className:"w-4 h-4 shrink-0"}),e.jsxs("span",{children:[(F==null?void 0:F.length)||0," ",s("activities.restaurantsParticipating")]})]}),e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx(Ys,{className:"w-4 h-4 shrink-0"}),e.jsx("span",{children:s("activities.creatorLabel")}),C!=null&&C.isAdmin?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("img",{src:Ue,alt:"Platform",className:"w-4 h-4 rounded-full object-contain"}),e.jsx("span",{className:"font-medium",children:s("activities.createdByPlatform")})]}):C!=null&&C.restaurant?e.jsxs(K,{to:`/restaurant/${C.restaurant.id}`,className:"flex items-center gap-1",onClick:a=>a.stopPropagation(),children:[C.avatar_url?e.jsxs(Ms,{className:"w-4 h-4",children:[e.jsx(Fs,{src:C.avatar_url,alt:"Creator"}),e.jsx(zs,{className:"text-[8px]",children:C.restaurant.name.charAt(0)})]}):e.jsx("div",{className:"w-4 h-4 rounded-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-[8px] font-medium",children:C.restaurant.name.charAt(0)})}),e.jsx("span",{className:"text-primary font-medium hover:underline",children:(()=>{const a=$s.language;return a==="zh"?C.restaurant.name:a==="pt"?C.restaurant.name_pt||C.restaurant.name_en||C.restaurant.name:C.restaurant.name_en||C.restaurant.name})()})]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("img",{src:Ue,alt:"Platform",className:"w-4 h-4 rounded-full object-contain"}),e.jsx("span",{className:"font-medium",children:s("activities.createdByPlatform")})]})]})]}),r&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full sm:w-auto",children:[Z&&M.length>0&&(f!=null&&f.activity_terms_agreed?e.jsx(N,{onClick:Ns,disabled:z.isPending,size:"lg",variant:Y?"outline":"default",className:"w-full sm:w-auto",children:b?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"选择参与的餐厅"]}):Y?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"退出活动"]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"参与活动"]})}):e.jsx(N,{onClick:()=>ke(!0),size:"lg",variant:"outline",className:"w-full sm:w-auto text-muted-foreground",children:s("activities.agreeTermsFirst")})),e.jsx(N,{onClick:js,disabled:pe.isPending,size:"lg",variant:De?"outline":"secondary",className:"w-full sm:w-auto",children:De?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2 fill-current"}),s("activities.favorited")||"已收藏"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),s("activities.favorite")||"收藏活动"]})})]}),!r&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s("activities.signInToJoin")}),e.jsxs("p",{className:"text-xs text-muted-foreground/80 flex items-center gap-1.5",children:[e.jsx(Ve,{className:"w-3.5 h-3.5"}),s("activities.signInToJoinHint")]})]})]})]}),e.jsxs(U,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:s("activities.about")}),e.jsx("div",{className:`prose prose-sm max-w-none text-muted-foreground\r
                  prose-headings:text-foreground prose-headings:font-semibold\r
                  prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg\r
                  prose-p:leading-relaxed prose-p:my-3\r
                  prose-strong:text-foreground prose-strong:font-semibold\r
                  prose-ul:my-3 prose-ol:my-3\r
                  prose-li:my-1\r
                  prose-a:text-primary prose-a:no-underline hover:prose-a:underline\r
                  [&_*]:!text-inherit [&_span[style*='color']]:!text-muted-foreground`,dangerouslySetInnerHTML:{__html:k.content}})]}),k.usage_instructions&&e.jsxs(e.Fragment,{children:[e.jsx(Be,{}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(ve,{className:"w-6 h-6 text-primary"}),s("activities.usageInstructions")]}),e.jsx("div",{className:`prose prose-sm max-w-none text-muted-foreground\r
                      prose-headings:text-foreground prose-headings:font-semibold\r
                      prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg\r
                      prose-p:leading-relaxed prose-p:my-3\r
                      prose-strong:text-foreground prose-strong:font-semibold\r
                      prose-ul:my-3 prose-ol:my-3\r
                      prose-li:my-1\r
                      prose-a:text-primary prose-a:no-underline hover:prose-a:underline`,dangerouslySetInnerHTML:{__html:k.usage_instructions}})]})]}),e.jsx(Be,{}),us?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{className:"w-6 h-6 animate-spin text-primary"})}):F&&F.length>0?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Js,{open:h,onOpenChange:v,children:e.jsxs(O,{className:"border-primary/20 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden",children:[e.jsx(X,{className:"pb-3",children:e.jsx(Vs,{asChild:!0,children:e.jsxs("div",{className:"flex items-center justify-between cursor-pointer group",children:[e.jsxs($e,{className:"text-lg font-semibold flex items-center gap-2 transition-colors duration-200 group-hover:text-primary",children:[e.jsx(Q,{className:"w-5 h-5 transition-transform duration-300 group-hover:scale-110"}),s("activities.participatingRestaurants")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{variant:"secondary",className:"transition-opacity duration-200",children:s(h?"common.showLess":"common.showDetails")}),e.jsx("div",{className:"transition-transform duration-300 ease-in-out",style:{transform:h?"rotate(180deg)":"rotate(0deg)"},children:e.jsx(Oe,{className:"w-5 h-5 text-muted-foreground group-hover:text-primary"})})]})]})})}),e.jsx(Zs,{className:"overflow-hidden transition-all duration-500 ease-in-out data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",children:e.jsxs(U,{className:"pt-0 pb-6 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-end",children:g?e.jsxs(R,{variant:"default",className:"flex items-center gap-1.5",children:[e.jsx(Ne,{className:"w-3.5 h-3.5"}),s("activities.sortByLocationEnabled")]}):e.jsxs(N,{variant:"outline",size:"sm",onClick:ws,disabled:L,children:[L?e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(Ne,{className:"w-4 h-4 mr-2"}),s("activities.enableLocationSort")]})}),e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:(l?G:G.slice(0,6)).map((a,S)=>{const D=d(a.restaurants);return e.jsx(O,{className:"overflow-hidden hover:shadow-lg transition-all duration-300 opacity-0 animate-fade-in h-full flex flex-col",style:{animationDelay:`${S*50}ms`,animationFillMode:"forwards"},children:e.jsxs(K,{to:`/restaurant/${a.restaurant_id}`,state:{fromActivity:t.id},className:"flex flex-col h-full",children:[e.jsxs("div",{className:"relative h-40 overflow-hidden flex-shrink-0",children:[e.jsx("img",{src:a.restaurants.image_url||"https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&q=80",alt:D.name,className:"w-full h-full object-cover transition-transform hover:scale-105"}),D.type&&D.type.length>0&&e.jsx("div",{className:"absolute top-2 left-2 flex flex-wrap gap-1",children:D.type.slice(0,3).map((E,Re)=>e.jsx(R,{className:"bg-primary",children:E},Re))})]}),e.jsxs(U,{className:"pt-4 pb-4 flex flex-col flex-grow",children:[e.jsx("h3",{className:"font-semibold text-lg mb-2 line-clamp-1",children:D.name}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-3",children:[e.jsx(He,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-1",children:a.restaurants.address})]}),e.jsxs("div",{className:"flex items-center justify-between mt-auto pt-3 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ea,{className:`w-4 h-4 ${a.restaurants.rating?"fill-accent text-accent":"text-muted-foreground"}`}),a.restaurants.rating?e.jsx("span",{className:"font-semibold text-sm",children:a.restaurants.rating.toFixed(1)}):e.jsxs("span",{className:"text-xs text-muted-foreground text-center whitespace-nowrap",children:[s("restaurant.noRatingLine1"),e.jsx("br",{}),s("restaurant.noRatingLine2")]})]}),a.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ne,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"font-semibold text-sm text-foreground",children:[a.distance.toFixed(1)," km"]})]})]})]})]})},a.id)})}),G.length>6&&!l&&e.jsxs(N,{variant:"outline",className:"w-full hover:bg-primary hover:text-primary-foreground transition-all duration-200",onClick:()=>m(!0),children:[e.jsx(Oe,{className:"w-4 h-4 mr-2"}),"查看更多 (",G.length-6," 个餐厅)"]})]})})]})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2 mb-4",children:[e.jsx(He,{className:"w-6 h-6"}),s("activities.participatingRestaurants")," (",G.length,")"]}),e.jsx(rs,{restaurants:G,onMarkerClick:ms})]})]}):null,e.jsx(ca,{restaurantId:t.id,targetType:"activity"})]})]})}),b&&e.jsx(Ma,{open:V,onOpenChange:ce,restaurants:M,participatingRestaurantIds:B,onConfirm:vs,isPending:z.isPending,isParticipating:Y}),Z&&e.jsx(ha,{isAgreed:(f==null?void 0:f.activity_terms_agreed)||!1,agreedAt:(f==null?void 0:f.activity_terms_agreed_at)||null,open:ns,onOpenChange:ke}),e.jsx(Fa,{open:ls,onOpenChange:me,activityTitle:(k==null?void 0:k.title)||"",activityId:n,onShareComplete:Cs,isProcessing:cs,hasAlreadyClaimed:q}),e.jsx(Na,{open:os,onOpenChange:he,onConfirm:bs}),e.jsx(Os,{open:ds,onOpenChange:ue,children:e.jsxs(Hs,{children:[e.jsxs(Bs,{children:[e.jsx(Us,{children:s("activities.loginRequired")}),e.jsx(qs,{children:s("activities.loginRequiredMessage")})]}),e.jsxs(Gs,{children:[e.jsx(Ws,{children:s("common.cancel")}),e.jsx(Xs,{onClick:()=>j("/auth"),children:s("activities.goToLogin")})]})]})})]})};export{Rt as default};
