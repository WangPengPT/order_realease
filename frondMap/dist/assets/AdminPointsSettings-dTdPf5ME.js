import{u as M,r,j as e,B as v,C as N,l as C,w,ao as T,m as _,a7 as I,I as P,av as z,G as i,s as x}from"./index-J_eLqhtQ.js";import{c as G,d as V}from"./usePoints-p39Dm9Ce.js";import{A as Z,a as J}from"./alert-DSxFnBIZ.js";import{S as K}from"./save-DaEXKFnX.js";import{I as Q}from"./info-DtJpcRWM.js";import{S as W}from"./settings-Dd68edFU.js";import{R as E}from"./refresh-cw-CO5Wf9Je.js";import{S as X}from"./search-DysiiJNQ.js";const oe=()=>{const{t:s}=M(),{data:o,isLoading:H}=G(),f=V(),[l,S]=r.useState(""),[c,j]=r.useState(""),[q,b]=r.useState(!1),[h,F]=r.useState(""),[L,k]=r.useState(!1),[D,R]=r.useState(!1),[m,d]=r.useState(null);if(r.useState(()=>{if(o){const t=o.find(n=>n.key==="comment_points"),a=o.find(n=>n.key==="min_comment_length");t&&S(t.value),a&&j(a.value)}}),o&&!l&&!c){const t=o.find(n=>n.key==="comment_points"),a=o.find(n=>n.key==="min_comment_length");t&&!l&&S(t.value),a&&!c&&j(a.value)}const O=async()=>{try{await Promise.all([f.mutateAsync({key:"comment_points",value:l}),f.mutateAsync({key:"min_comment_length",value:c})]),i.success(s("admin.pointsSettings.saveSuccess","设置已保存")),b(!1)}catch{i.error(s("admin.pointsSettings.saveFailed","保存失败"))}},U=(t,a)=>{t(a),b(!0)},$=async()=>{if(!h.trim()){i.error(s("admin.pointsSettings.enterEmailOrId","请输入邮箱或用户ID"));return}R(!0),d(null);try{const t=h.trim();if(t.includes("@")){const{data:n,error:u}=await x.functions.invoke("get-user-emails");if(u)throw u;const y=(n==null?void 0:n.emails)||{},g=Object.keys(y).find(p=>{var A;return((A=y[p])==null?void 0:A.toLowerCase())===t.toLowerCase()});if(g){const{data:p}=await x.from("profiles").select("display_name").eq("id",g).single();d({id:g,email:y[g],display_name:(p==null?void 0:p.display_name)||"未知用户"}),i.success(s("admin.pointsSettings.userFound","找到用户"))}else i.error(s("admin.pointsSettings.userNotFound","未找到该邮箱对应的用户"))}else{const{data:n,error:u}=await x.from("profiles").select("id, display_name").eq("id",t).single();if(u||!n){i.error(s("admin.pointsSettings.userNotFound","未找到该用户ID"));return}d({id:n.id,email:"(已通过ID查找)",display_name:n.display_name||"未知用户"}),i.success(s("admin.pointsSettings.userFound","找到用户"))}}catch(t){console.error("Search error:",t),i.error(s("admin.pointsSettings.searchFailed","搜索失败"))}finally{R(!1)}},B=async()=>{if(!m){i.error(s("admin.pointsSettings.searchUserFirst","请先搜索用户"));return}k(!0);try{const t=new Date().toISOString().split("T")[0],{error:a,count:n}=await x.from("points_transactions").delete().eq("user_id",m.id).eq("type","comment").gte("created_at",t).lt("created_at",`${t}T23:59:59.999Z`);if(a)throw a;n===0?i.info(s("admin.pointsSettings.noRecordFound","该用户今日无评论积分记录")):i.success(s("admin.pointsSettings.resetSuccess","已重置用户每日评论积分")),F(""),d(null)}catch(t){console.error("Reset error:",t),i.error(s("admin.pointsSettings.resetFailed","重置失败"))}finally{k(!1)}};return H?e.jsx("div",{className:"p-6",children:s("common.loading")}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:s("admin.pointsSettings.title","积分设置")}),e.jsx("p",{className:"text-muted-foreground",children:s("admin.pointsSettings.description","配置积分系统的相关参数")})]}),e.jsxs(v,{onClick:O,disabled:!q||f.isPending,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),s("common.save","保存")]})]}),e.jsxs(Z,{children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(J,{children:s("admin.pointsSettings.info","修改设置后将立即生效，影响所有用户的积分获取规则。")})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),s("admin.pointsSettings.commentSettings","评论积分设置")]}),e.jsx(T,{children:s("admin.pointsSettings.commentSettingsDesc","配置用户通过评论获取积分的规则")})]}),e.jsx(_,{className:"space-y-6",children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"commentPoints",children:s("admin.pointsSettings.commentPoints","评论积分数")}),e.jsx(P,{id:"commentPoints",type:"number",min:"0",value:l,onChange:t=>U(S,t.target.value),placeholder:"5"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.pointsSettings.commentPointsHelp","用户发表有效评论可获得的积分数量（每日仅限一次）")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"minCommentLength",children:s("admin.pointsSettings.minCommentLength","最小评论长度")}),e.jsx(P,{id:"minCommentLength",type:"number",min:"0",value:c,onChange:t=>U(j,t.target.value),placeholder:"10"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.pointsSettings.minCommentLengthHelp","评论需达到的最小字符数才能获得积分")})]})]})})]}),e.jsxs(N,{children:[e.jsx(C,{children:e.jsx(w,{children:s("admin.pointsSettings.rulesPreview","规则预览")})}),e.jsx(_,{children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:["• ",s("admin.pointsSettings.rule1","用户发表评论，评论长度需 ≥")," ",e.jsx("strong",{children:c||"10"})," ",s("admin.pointsSettings.characters","个字符")]}),e.jsxs("p",{children:["• ",s("admin.pointsSettings.rule2","评论通过审核后获得")," ",e.jsx("strong",{children:l||"5"})," ",s("admin.pointsSettings.points","积分")]}),e.jsxs("p",{children:["• ",s("admin.pointsSettings.rule3","每位用户每天仅可通过评论获得一次积分奖励")]})]})})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5"}),s("admin.pointsSettings.testTools","测试工具")]}),e.jsx(T,{children:s("admin.pointsSettings.testToolsDesc","用于测试积分系统的管理员工具")})]}),e.jsx(_,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(I,{children:s("admin.pointsSettings.resetDailyComment","重置用户每日评论积分")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{value:h,onChange:t=>{F(t.target.value),d(null)},placeholder:s("admin.pointsSettings.emailOrIdPlaceholder","输入邮箱或用户ID"),className:"flex-1"}),e.jsxs(v,{onClick:$,disabled:D||!h.trim(),variant:"outline",children:[e.jsx(X,{className:`h-4 w-4 mr-2 ${D?"animate-spin":""}`}),s("admin.pointsSettings.search","搜索")]})]}),m&&e.jsxs("div",{className:"p-3 bg-muted rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:m.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:m.email}),e.jsx("p",{className:"text-xs text-muted-foreground font-mono",children:m.id})]})]}),e.jsxs(v,{onClick:B,disabled:L,variant:"destructive",size:"sm",children:[e.jsx(E,{className:`h-4 w-4 mr-2 ${L?"animate-spin":""}`}),s("admin.pointsSettings.reset","重置")]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.pointsSettings.resetHelp","删除用户今日的评论积分记录，使其可以再次通过评论获得积分")})]})})]})]})};export{oe as default};
