import{k as S,p as w,s as i,i as h,ad as g,ae as p,a2 as o}from"./index-OzGmxN22.js";const F=async t=>{const{data:n}=await i.from("user_roles").select("role").eq("user_id",t).single();return n==null?void 0:n.role},$=()=>{const{user:t}=S();return w({queryKey:["admin-users",t==null?void 0:t.id],queryFn:async()=>{var v,E,C,K,U;if(!t)return[];const[n,r,e,a]=await Promise.all([i.from("profiles").select("*").order("created_at",{ascending:!1}),i.from("user_roles").select("user_id, role"),i.auth.getSession(),i.from("user_roles").select("role").eq("user_id",t.id).single()]);if(n.error)throw n.error;const u=n.data||[],d=r.data||[],l={};d.forEach(y=>{l[y.user_id]=y.role});let m={},s={},c={};if((E=(v=e.data)==null?void 0:v.session)!=null&&E.access_token)try{const y=await i.functions.invoke("get-user-emails",{headers:{Authorization:`Bearer ${e.data.session.access_token}`}});(C=y.data)!=null&&C.emails&&(m=y.data.emails),(K=y.data)!=null&&K.createdAt&&(s=y.data.createdAt),(U=y.data)!=null&&U.lastSignIn&&(c=y.data.lastSignIn)}catch(y){console.error("Failed to fetch user data:",y)}const f=u.map(y=>({...y,role:l[y.id]||"user",email:m[y.id]||"",auth_created_at:s[y.id]||y.created_at,last_sign_in_at:c[y.id]||null})),_=a.data;if((_==null?void 0:_.role)==="supervisor"){const{data:y,error:D}=await i.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);if(D)throw D;if(!y||y.length===0)return[];const R=y.map(q=>q.restaurant_id),{data:b,error:M}=await i.from("merchant_restaurants").select("user_id, restaurant_id").in("restaurant_id",R);if(M)throw M;if(!b||b.length===0)return[];const A=[...new Set(b.map(q=>q.user_id).filter(q=>q!==t.id))];if(A.length===0)return[];const Q=A.filter(q=>l[q]==="merchant");return f.filter(q=>Q.includes(q.id))}return f},staleTime:3e4})},O=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async({userId:r,role:e})=>{const{error:a}=await i.from("user_roles").upsert({user_id:r,role:e},{onConflict:"user_id"});if(a)throw a},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["user-roles"]}),t({title:o.t("common.success"),description:o.t("toast.roleChanged")})},onError:r=>{console.error("Role change error:",r),t({title:o.t("common.error"),description:r.message||o.t("toast.roleChangeFailed"),variant:"destructive"})}})},P=()=>{const{user:t}=S();return w({queryKey:["admin-restaurants",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];if(await F(t.id)==="supervisor"){const{data:e,error:a}=await i.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);if(a)throw a;const u=(e==null?void 0:e.map(m=>m.restaurant_id))||[];if(u.length===0)return[];const{data:d,error:l}=await i.from("restaurants").select("*").in("id",u).order("rating",{ascending:!1});if(l)throw l;return d||[]}else{const{data:e,error:a}=await i.from("restaurants").select("*").order("rating",{ascending:!1});if(a)throw a;return e||[]}},enabled:!!t})},x=()=>w({queryKey:["operation-logs"],queryFn:async()=>{const{data:t,error:n}=await i.from("operation_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(n)throw n;return await Promise.all((t||[]).map(async e=>{const{data:a}=await i.from("profiles").select("display_name").eq("id",e.user_id).single();return{...e,user_name:(a==null?void 0:a.display_name)||"Unknown User"}}))}}),j=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async({userId:r,display_name:e,phone:a,avatar_url:u})=>{const{data:d,error:l}=await i.from("profiles").update({display_name:e,phone:a,avatar_url:u}).eq("id",r).select().single();if(l)throw l;return d},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.profileUpdated")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.profileUpdateFailed"),variant:"destructive"})}})},z=()=>{const{toast:t}=h();return p({mutationFn:async({file:n,userId:r})=>{const e=n.name.split(".").pop(),a=`${Date.now()}.${e}`,u=`${r}/${a}`,{error:d}=await i.storage.from("avatars").upload(u,n,{upsert:!0});if(d)throw d;const{data:{publicUrl:l}}=i.storage.from("avatars").getPublicUrl(u);return l},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.avatarUploadFailed"),variant:"destructive"})}})},T=()=>{const{user:t}=S();return w({queryKey:["admin-stats",t==null?void 0:t.id],queryFn:async()=>{if(!t)return{totalUsers:0,totalRestaurants:0,totalActivities:0,totalComments:0};if(await F(t.id)==="supervisor"){const{data:l}=await i.from("merchant_restaurants").select("restaurant_id, user_id").eq("user_id",t.id),m=(l==null?void 0:l.map(v=>v.restaurant_id))||[],c=(Array.from(new Set(l==null?void 0:l.map(v=>v.user_id)))||[]).length,f=m.length;let _=0;if(m.length>0){const{count:v}=await i.from("comments").select("*",{count:"exact",head:!0}).eq("target_type","restaurant").in("target_id",m);_=v||0}return{totalUsers:c,totalRestaurants:f,totalActivities:0,totalComments:_}}const[e,a,u,d]=await Promise.all([i.from("profiles").select("*",{count:"exact",head:!0}),i.from("restaurants").select("*",{count:"exact",head:!0}),i.from("activities").select("*",{count:"exact",head:!0}),i.from("comments").select("*",{count:"exact",head:!0})]);return{totalUsers:e.count||0,totalRestaurants:a.count||0,totalActivities:u.count||0,totalComments:d.count||0}}})},B=()=>{const{user:t}=S();return w({queryKey:["top-restaurants",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const r=await F(t.id)==="supervisor";let e=i.from("restaurants").select("id, name, rating").order("rating",{ascending:!1,nullsFirst:!1}).limit(10);if(r){const{data:l}=await i.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id),m=(l==null?void 0:l.map(s=>s.restaurant_id))||[];if(m.length===0)return[];e=i.from("restaurants").select("id, name, rating").in("id",m).order("rating",{ascending:!1,nullsFirst:!1}).limit(10)}const{data:a,error:u}=await e;if(u)throw u;return await Promise.all((a||[]).map(async l=>{const{count:m}=await i.from("comments").select("*",{count:"exact",head:!0}).eq("target_id",l.id).eq("target_type","restaurant");return{name:l.name,rating:l.rating||0,comments:m||0}}))}})},W=()=>{const{user:t}=S();return w({queryKey:["restaurant-rating-trends",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const r=await F(t.id)==="supervisor";let e=[],a={};if(r){const{data:s}=await i.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);e=(s==null?void 0:s.map(c=>c.restaurant_id))||[]}else{const{data:s}=await i.from("restaurants").select("id, name").order("rating",{ascending:!1,nullsFirst:!1}).limit(5);e=(s==null?void 0:s.map(c=>c.id))||[],s==null||s.forEach(c=>{a[c.id]=c.name})}if(e.length===0)return[];const{data:u}=await i.from("comments").select("target_id, rating_value, created_at").eq("target_type","restaurant").in("target_id",e).not("rating_value","is",null).order("created_at",{ascending:!0});if(!u||u.length===0)return[];if(Object.keys(a).length===0){const{data:s}=await i.from("restaurants").select("id, name").in("id",e);s==null||s.forEach(c=>{a[c.id]=c.name})}const d={};u.forEach(s=>{const c=new Date(s.created_at),f=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;d[s.target_id]||(d[s.target_id]={}),d[s.target_id][f]||(d[s.target_id][f]={sum:0,count:0}),d[s.target_id][f].sum+=s.rating_value,d[s.target_id][f].count+=1});const l=new Set;return Object.values(d).forEach(s=>{Object.keys(s).forEach(c=>l.add(c))}),Array.from(l).sort().map(s=>{const c={month:s};return Object.keys(d).forEach(f=>{const _=d[f][s],v=_?(_.sum/_.count).toFixed(1):null;c[a[f]||f]=v}),c})}})},L=()=>{const{user:t}=S();return w({queryKey:["restaurant-comment-trends",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const r=await F(t.id)==="supervisor";let e=[],a={};if(r){const{data:s}=await i.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);e=(s==null?void 0:s.map(c=>c.restaurant_id))||[]}else{const{data:s}=await i.from("restaurants").select("id, name").order("rating",{ascending:!1,nullsFirst:!1}).limit(5);e=(s==null?void 0:s.map(c=>c.id))||[],s==null||s.forEach(c=>{a[c.id]=c.name})}if(e.length===0)return[];const{data:u}=await i.from("comments").select("target_id, created_at").eq("target_type","restaurant").in("target_id",e).order("created_at",{ascending:!0});if(!u||u.length===0)return[];if(Object.keys(a).length===0){const{data:s}=await i.from("restaurants").select("id, name").in("id",e);s==null||s.forEach(c=>{a[c.id]=c.name})}const d={};u.forEach(s=>{const c=new Date(s.created_at),f=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;d[s.target_id]||(d[s.target_id]={}),d[s.target_id][f]=(d[s.target_id][f]||0)+1});const l=new Set;return Object.values(d).forEach(s=>{Object.keys(s).forEach(c=>l.add(c))}),Array.from(l).sort().map(s=>{const c={month:s};return Object.keys(d).forEach(f=>{const _=d[f][s]||0;c[a[f]||f]=_}),c})}})},N=()=>w({queryKey:["activity-engagement"],queryFn:async()=>{const{data:t,error:n}=await i.from("activities").select("id, title_en").order("created_at",{ascending:!1}).limit(10);if(n)throw n;return await Promise.all((t||[]).map(async e=>{const[a,u]=await Promise.all([i.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",e.id),i.from("comments").select("*",{count:"exact",head:!0}).eq("target_id",e.id).eq("target_type","activity")]);return{name:e.title_en,subscribers:a.count||0,comments:u.count||0}}))}}),Y=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{await i.from("activity_restaurants").delete().eq("activity_id",r);const{error:e}=await i.from("activities").delete().eq("id",r);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["activities"]}),n.invalidateQueries({queryKey:["admin-activities"]}),t({title:o.t("common.success"),description:o.t("toast.activityDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.activityDeleteFailed"),variant:"destructive"})}})},I=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{const{error:e}=await i.from("restaurants").delete().eq("id",r);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.restaurantDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.restaurantDeleteFailed"),variant:"destructive"})}})},V=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{console.log("Calling delete-account edge function for userId:",r);const{data:e,error:a}=await i.functions.invoke("delete-account",{body:{userId:r}});if(console.log("Delete-account response:",{data:e,error:a}),a)throw console.error("Delete-account error:",a),a;if(e!=null&&e.error)throw console.error("Delete-account data error:",e.error),new Error(e.error);return e},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.userDeleted")})},onError:r=>{console.error("useDeleteUser onError:",r),t({title:o.t("common.error"),description:(r==null?void 0:r.message)||o.t("toast.userDeleteFailed"),variant:"destructive"})}})},G=()=>{const{toast:t}=h(),n=g(),{user:r}=S();return p({mutationFn:async({userId:e,banReason:a})=>{const{error:u}=await i.from("profiles").update({is_banned:!0,ban_reason:a||null,banned_at:new Date().toISOString(),banned_by:r==null?void 0:r.id}).eq("id",e);if(u)throw u},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.userBanned")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userBanFailed"),variant:"destructive"})}})},H=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{const{error:e}=await i.from("profiles").update({is_banned:!1,ban_reason:null,banned_at:null,banned_by:null}).eq("id",r);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["banned-users"]}),t({title:o.t("common.success"),description:o.t("toast.userUnbanned")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userUnbanFailed"),variant:"destructive"})}})},J=()=>{const{toast:t}=h(),n=g(),{user:r}=S();return p({mutationFn:async({userId:e,muteReason:a,mutedUntil:u})=>{const{error:d}=await i.from("profiles").update({is_muted:!0,mute_reason:a||null,muted_at:new Date().toISOString(),muted_by:r==null?void 0:r.id,muted_until:u||null}).eq("id",e);if(d)throw d;const{data:l}=await i.from("profiles").select("language_preference").eq("id",e).single(),m=(l==null?void 0:l.language_preference)||"en";let s="";if(u){const _=new Date(u);m==="zh"?s=`禁言至: ${_.toLocaleDateString("zh-CN")}`:m==="pt"?s=`Silenciado até: ${_.toLocaleDateString("pt-PT")}`:s=`Muted until: ${_.toLocaleDateString("en-US")}`}else m==="zh"?s="永久禁言":m==="pt"?s="Silenciamento permanente":s="Permanent mute";let c="",f="";m==="zh"?(c="账号已被禁言",f=`${s}。原因: ${a||"违反社区规则"}`):m==="pt"?(c="Conta silenciada",f=`${s}. Motivo: ${a||"Violação das regras da comunidade"}`):(c="Account muted",f=`${s}. Reason: ${a||"Community guidelines violation"}`),await i.from("notifications").insert({user_id:e,type:"activity_update",title:c,content:f,link:"/profile"})},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["muted-users"]}),t({title:o.t("common.success"),description:o.t("toast.userMuted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userMuteFailed"),variant:"destructive"})}})},X=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{const{data:e}=await i.from("profiles").select("language_preference").eq("id",r).single(),{error:a}=await i.from("profiles").update({is_muted:!1,mute_reason:null,muted_at:null,muted_by:null,muted_until:null}).eq("id",r);if(a)throw a;const u=(e==null?void 0:e.language_preference)||"en";let d="",l="";u==="zh"?(d="禁言已解除",l="您的账号禁言已被解除，现在可以正常发表评论了。"):u==="pt"?(d="Silenciamento removido",l="O silenciamento da sua conta foi removido. Você pode comentar novamente."):(d="Mute lifted",l="Your account mute has been lifted. You can now post comments again."),await i.from("notifications").insert({user_id:r,type:"activity_update",title:d,content:l,link:"/profile"})},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["muted-users"]}),t({title:o.t("common.success"),description:o.t("toast.userUnmuted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userUnmuteFailed"),variant:"destructive"})}})},Z=()=>w({queryKey:["banned-users"],queryFn:async()=>{const{data:t,error:n}=await i.from("profiles").select("*").eq("is_banned",!0).order("banned_at",{ascending:!1});if(n)throw n;const{data:r}=await i.from("user_roles").select("user_id, role"),e={};return r==null||r.forEach(a=>{e[a.user_id]=a.role}),(t||[]).map(a=>({...a,role:e[a.id]||"user"}))}}),tt=()=>w({queryKey:["muted-users"],queryFn:async()=>{const{data:t,error:n}=await i.from("profiles").select("*").eq("is_muted",!0).order("muted_at",{ascending:!1});if(n)throw n;const{data:r}=await i.from("user_roles").select("user_id, role"),e={};return r==null||r.forEach(a=>{e[a.user_id]=a.role}),(t||[]).map(a=>({...a,role:e[a.id]||"user"}))}}),et=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{const e=r.map(async a=>{const{error:u}=await i.functions.invoke("delete-account",{body:{userId:a}});if(u)throw u});await Promise.all(e)},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.usersDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.usersDeleteFailed"),variant:"destructive"})}})},rt=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{const{error:e}=await i.from("restaurants").delete().in("id",r);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.restaurantsDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.restaurantsDeleteFailed"),variant:"destructive"})}})},st=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async r=>{await i.from("activity_restaurants").delete().in("activity_id",r);const{error:e}=await i.from("activities").delete().in("id",r);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["activities"]}),t({title:o.t("common.success"),description:o.t("toast.activitiesDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.activitiesDeleteFailed"),variant:"destructive"})}})},at=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async({userIds:r,role:e})=>{const a=r.map(d=>({user_id:d,role:e})),{error:u}=await i.from("user_roles").upsert(a,{onConflict:"user_id"});if(u)throw u},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.rolesChanged")})},onError:r=>{console.error("Batch role change error:",r),t({title:o.t("common.error"),description:r.message||o.t("toast.rolesChangeFailed"),variant:"destructive"})}})},nt=()=>{const{toast:t}=h(),n=g();return p({mutationFn:async({restaurantId:r,visible:e})=>{const{error:a}=await i.from("restaurants").update({visible:e}).eq("id",r);if(a)throw a},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-restaurants"]}),n.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.visibilityUpdated")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.visibilityUpdateFailed"),variant:"destructive"})}})},it=()=>w({queryKey:["activity-share-trends"],queryFn:async()=>{const{data:t}=await i.from("activities").select("id, title_zh, title_en, title_pt").eq("visible",!0).limit(10);if(!t||t.length===0)return[];const n=t.map(m=>m.id),r={};t.forEach(m=>{r[m.id]=m.title_zh||m.title_en});const{data:e}=await i.from("activity_shares").select("activity_id, created_at").in("activity_id",n).order("created_at",{ascending:!0});if(!e||e.length===0)return[];const a={};e.forEach(m=>{const s=new Date(m.created_at),c=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`;a[m.activity_id]||(a[m.activity_id]={}),a[m.activity_id][c]=(a[m.activity_id][c]||0)+1});const u=new Set;Object.values(a).forEach(m=>{Object.keys(m).forEach(s=>u.add(s))});const d=Array.from(u).sort(),l=Object.keys(a);return d.map(m=>{const s={month:m};return l.forEach(c=>{var v;const f=a[c][m]||0,_=((v=r[c])==null?void 0:v.substring(0,15))||c;s[_]=f}),s})}}),ot=()=>w({queryKey:["activity-share-stats"],queryFn:async()=>{const{data:t}=await i.from("activities").select("id, title_zh, title_en, title_pt").eq("visible",!0);return!t||t.length===0?[]:(await Promise.all(t.map(async r=>{const{count:e}=await i.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",r.id);return{id:r.id,name:(r.title_zh||r.title_en).substring(0,15),shares:e||0}}))).sort((r,e)=>e.shares-r.shares).slice(0,10)}});export{tt as A,B as a,N as b,W as c,L as d,it as e,ot as f,j as g,z as h,$ as i,O as j,et as k,at as l,V as m,P as n,I as o,rt as p,nt as q,Y as r,st as s,x as t,T as u,G as v,H as w,J as x,X as y,Z as z};
