import{s as ae,q as I,v as z,p as ne,r as M,j as e,aJ as re,by as ie,a4 as A,X as T,dX as R,b7 as de,dY as P,al as Q,L as U,bx as $,bM as ce,b1 as le,ck as me}from"./vendor-react-Hsdnn-sD.js";import{j as E,s as p,C as k,w as S,k as g,I as oe,v as he,M as xe,$ as ue,B as x,A as K,h as O,i as V,D as ge,d as pe,f as je,g as ve,V as fe,S as _e}from"./index-DNQsNrYF.js";import{C as X}from"./checkbox-3JW9vGeb.js";import{T as Ne,a as we,b as L}from"./tabs-ChHCVzdT.js";import{T as ye,a as be,b as J,c as _,d as Ce,e as N}from"./table-DO2rzFzK.js";import{u as ke}from"./useLocalizedContent-D-CDxH29.js";import{D as q}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-BVdpxhZP.js";const Se=(s="pending")=>ae({queryKey:["admin-comments",s],queryFn:async()=>{let n=p.from("comments").select("*").is("parent_id",null).order("created_at",{ascending:!1}).limit(200);s==="archived"?n=n.eq("archived",!0):(n=n.or("archived.is.null,archived.eq.false"),s==="pending"?n=n.in("moderation_status",["pending","flagged"]):s==="approved"?n=n.eq("moderation_status","approved"):s==="rejected"&&(n=n.eq("moderation_status","rejected")));const{data:a,error:d}=await n;if(d)throw d;if(!a||a.length===0)return[];const l=[...new Set(a.map(i=>i.user_id))],{data:w}=await p.rpc("get_public_profiles",{user_ids:l}),m=new Map((w||[]).map(i=>[i.id,{display_name:i.display_name,avatar_url:i.avatar_url}])),h=a.filter(i=>i.target_type==="restaurant").map(i=>i.target_id),r=a.filter(i=>i.target_type==="activity").map(i=>i.target_id),f=new Map,j=new Map;if(h.length>0){const{data:i}=await p.from("restaurants").select("id, name, name_en, name_pt").in("id",h);i?.forEach(c=>{f.set(c.id,{name:c.name,name_en:c.name_en||void 0,name_pt:c.name_pt||void 0})})}if(r.length>0){const{data:i}=await p.from("activities").select("id, title_zh, title_en, title_pt").in("id",r);i?.forEach(c=>{j.set(c.id,{title_zh:c.title_zh,title_en:c.title_en,title_pt:c.title_pt})})}return a.map(i=>{let c="",y,b;if(i.target_type==="restaurant"){const u=f.get(i.target_id);c=u?.name||"Unknown Restaurant",y=u?.name_en,b=u?.name_pt}else if(i.target_type==="activity"){const u=j.get(i.target_id);c=u?.title_zh||"Unknown Activity",y=u?.title_en,b=u?.title_pt}return{...i,risk_reasons:Array.isArray(i.risk_reasons)?i.risk_reasons:[],profiles:m.get(i.user_id),target_name:c,target_name_en:y,target_name_pt:b}})}}),De=()=>{const{toast:s}=E(),n=I();return z({mutationFn:async({commentId:a,action:d})=>{const{data:{user:l}}=await p.auth.getUser();if(!l)throw new Error("Not authenticated");const w={approve:"approved",reject:"rejected",flag:"flagged"},{error:m}=await p.from("comments").update({moderation_status:w[d],reviewed_by:l.id,reviewed_at:new Date().toISOString()}).eq("id",a);if(m)throw m},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-comments"]}),s({title:"审核完成",description:"评论状态已更新"})},onError:()=>{s({title:"操作失败",description:"无法更新评论状态",variant:"destructive"})}})},Me=()=>{const{toast:s}=E(),n=I();return z({mutationFn:async({commentIds:a,action:d})=>{const{data:{user:l}}=await p.auth.getUser();if(!l)throw new Error("Not authenticated");const w={approve:"approved",reject:"rejected"},{error:m}=await p.from("comments").update({moderation_status:w[d],reviewed_by:l.id,reviewed_at:new Date().toISOString()}).in("id",a);if(m)throw m},onSuccess:(a,d)=>{n.invalidateQueries({queryKey:["admin-comments"]}),s({title:"批量审核完成",description:`已${d.action==="approve"?"通过":"拒绝"} ${d.commentIds.length} 条评论`})},onError:()=>{s({title:"批量操作失败",description:"无法更新评论状态",variant:"destructive"})}})},Ae=()=>{const{toast:s}=E(),n=I();return z({mutationFn:async({commentId:a,archived:d})=>{const{error:l}=await p.from("comments").update({archived:d}).eq("id",a);if(l)throw l},onSuccess:(a,d)=>{n.invalidateQueries({queryKey:["admin-comments"]}),s({title:d.archived?"已归档":"已取消归档",description:d.archived?"评论已移至归档":"评论已恢复到列表"})},onError:()=>{s({title:"操作失败",description:"无法更新归档状态",variant:"destructive"})}})},Te=()=>{const{toast:s}=E(),n=I();return z({mutationFn:async({commentIds:a,archived:d})=>{const{error:l}=await p.from("comments").update({archived:d}).in("id",a);if(l)throw l},onSuccess:(a,d)=>{n.invalidateQueries({queryKey:["admin-comments"]}),s({title:d.archived?"批量归档完成":"批量取消归档完成",description:`已${d.archived?"归档":"恢复"} ${d.commentIds.length} 条评论`})},onError:()=>{s({title:"批量操作失败",description:"无法更新归档状态",variant:"destructive"})}})},Y=s=>s<=30?"bg-green-500/10 text-green-600 border-green-500/20":s<=60?"bg-yellow-500/10 text-yellow-600 border-yellow-500/20":"bg-red-500/10 text-red-600 border-red-500/20",G=(s,n)=>{switch(s){case"approved":return e.jsx(g,{variant:"outline",className:"bg-green-500/10 text-green-600 border-green-500/20",children:n("admin.comments.status.approved")});case"pending":return e.jsx(g,{variant:"outline",className:"bg-yellow-500/10 text-yellow-600 border-yellow-500/20",children:n("admin.comments.status.pending")});case"flagged":return e.jsx(g,{variant:"outline",className:"bg-orange-500/10 text-orange-600 border-orange-500/20",children:n("admin.comments.status.flagged")});case"rejected":return e.jsx(g,{variant:"outline",className:"bg-red-500/10 text-red-600 border-red-500/20",children:n("admin.comments.status.rejected")});default:return e.jsx(g,{variant:"secondary",children:s})}},W=(s,n)=>{const a={spam:"admin.comments.risk.spam",offensive:"admin.comments.risk.offensive",harassment:"admin.comments.risk.harassment",fake_review:"admin.comments.risk.fake_review",flooding:"admin.comments.risk.flooding",irrelevant:"admin.comments.risk.irrelevant",sensitive_word_detected:"admin.comments.risk.sensitive_word_detected",parse_error:"admin.comments.risk.parse_error"};return a[s]?n(a[s]):s},Qe=()=>{const{t:s,i18n:n}=ne();ke();const[a,d]=M.useState("pending"),[l,w]=M.useState(""),[m,h]=M.useState([]),[r,f]=M.useState(null),{data:j,isLoading:i}=Se(a),c=De(),y=Me(),b=Ae(),u=Te(),C=j?.filter(t=>{if(!l)return!0;const o=l.toLowerCase();return t.content.toLowerCase().includes(o)||t.profiles?.display_name?.toLowerCase().includes(o)||t.target_name?.toLowerCase().includes(o)}),Z=t=>{h(t?C?.map(o=>o.id)||[]:[])},ee=(t,o)=>{h(o?D=>[...D,t]:D=>D.filter(te=>te!==t))},H=t=>{m.length!==0&&y.mutate({commentIds:m,action:t},{onSuccess:()=>h([])})},se=t=>{m.length!==0&&u.mutate({commentIds:m,archived:t},{onSuccess:()=>h([])})},B=t=>t.target_type==="restaurant"?`/restaurant/${t.target_id}`:t.target_type==="activity"?`/activity/${t.target_id}`:"#",F=t=>n.language==="en"&&t.target_name_en?t.target_name_en:n.language==="pt"&&t.target_name_pt?t.target_name_pt:t.target_name||"",v={total:j?.length||0,pending:j?.filter(t=>t.moderation_status==="pending").length||0,flagged:j?.filter(t=>t.moderation_status==="flagged").length||0,approved:j?.filter(t=>t.moderation_status==="approved").length||0,rejected:j?.filter(t=>t.moderation_status==="rejected").length||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(re,{className:"h-6 w-6"}),s("admin.comments.title","评论管理")]}),e.jsx("p",{className:"text-muted-foreground",children:s("admin.comments.description","审核和管理用户评论，防止恶意内容")})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(k,{children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:v.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("admin.comments.totalComments")})]})}),e.jsx(k,{className:"border-yellow-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:v.pending}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("admin.comments.pendingReview")})]})}),e.jsx(k,{className:"border-orange-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:v.flagged}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("admin.comments.flagged")})]})}),e.jsx(k,{className:"border-green-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:v.approved}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("admin.comments.approved")})]})}),e.jsx(k,{className:"border-red-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:v.rejected}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("admin.comments.rejected")})]})})]}),e.jsxs(Ne,{value:a,onValueChange:t=>{d(t),h([])},className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs(we,{children:[e.jsxs(L,{value:"pending",className:"gap-1",children:[e.jsx(ie,{className:"h-4 w-4"}),s("admin.comments.pendingReview"),v.pending+v.flagged>0&&e.jsx(g,{variant:"secondary",className:"ml-1 h-5 px-1.5",children:v.pending+v.flagged})]}),e.jsxs(L,{value:"approved",className:"gap-1",children:[e.jsx(A,{className:"h-4 w-4"}),s("admin.comments.approved")]}),e.jsxs(L,{value:"rejected",className:"gap-1",children:[e.jsx(T,{className:"h-4 w-4"}),s("admin.comments.rejected")]}),e.jsxs(L,{value:"archived",className:"gap-1",children:[e.jsx(R,{className:"h-4 w-4"}),s("admin.comments.archived")]})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(de,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(oe,{placeholder:s("admin.comments.search"),value:l,onChange:t=>w(t.target.value),className:"pl-9"})]})]}),e.jsxs(k,{children:[e.jsxs(he,{children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2",children:e.jsxs("div",{children:[e.jsxs(xe,{children:[a==="pending"&&s("admin.comments.reviewList"),a==="approved"&&s("admin.comments.approvedList"),a==="rejected"&&s("admin.comments.rejectedList"),a==="archived"&&s("admin.comments.archivedList")]}),e.jsxs(ue,{children:[a==="pending"&&s("admin.comments.reviewListDesc"),a==="approved"&&s("admin.comments.approvedListDesc"),a==="rejected"&&s("admin.comments.rejectedListDesc"),a==="archived"&&s("admin.comments.archivedListDesc")]})]})}),m.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mt-4 p-2 bg-muted rounded-lg flex-wrap",children:[e.jsx("span",{className:"text-sm",children:s("admin.comments.selectedCount",{count:m.length})}),a==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>H("approve"),disabled:y.isPending,children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),s("admin.comments.batchApprove")]}),e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>H("reject"),disabled:y.isPending,children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),s("admin.comments.batchReject")]})]}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>se(a!=="archived"),disabled:u.isPending,children:a==="archived"?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"h-4 w-4 mr-1"}),s("admin.comments.batchRestore")]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),s("admin.comments.batchArchive")]})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>h([]),children:s("admin.comments.cancelSelection")})]})]}),e.jsx(S,{children:i?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("admin.comments.loading")}):C&&C.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(ye,{children:[e.jsx(be,{children:e.jsxs(J,{children:[e.jsx(_,{className:"w-12",children:e.jsx(X,{checked:C.length>0&&m.length===C.length,onCheckedChange:Z})}),e.jsx(_,{className:"w-16",children:s("admin.comments.risk")}),e.jsx(_,{children:s("admin.comments.content")}),e.jsx(_,{children:s("admin.comments.user")}),e.jsx(_,{children:s("admin.comments.target")}),e.jsx(_,{children:s("admin.comments.status")}),e.jsx(_,{children:s("admin.comments.time")}),e.jsx(_,{className:"text-right",children:s("admin.comments.actions")})]})}),e.jsx(Ce,{children:C.map(t=>e.jsxs(J,{className:t.risk_score>60?"bg-red-500/5":t.risk_score>30?"bg-yellow-500/5":"",children:[e.jsx(N,{children:e.jsx(X,{checked:m.includes(t.id),onCheckedChange:o=>ee(t.id,o)})}),e.jsx(N,{children:e.jsx(g,{variant:"outline",className:Y(t.risk_score),children:t.risk_score})}),e.jsxs(N,{className:"max-w-xs",children:[e.jsx("div",{className:"truncate",title:t.content,children:t.content}),t.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:t.risk_reasons.map((o,D)=>e.jsx(g,{variant:"secondary",className:"text-xs",children:W(o,s)},D))})]}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(K,{className:"h-6 w-6",children:[e.jsx(O,{src:t.profiles?.avatar_url}),e.jsx(V,{children:e.jsx(Q,{className:"h-3 w-3"})})]}),e.jsx("span",{className:"text-sm truncate max-w-[100px]",children:t.profiles?.display_name||"Unknown"})]})}),e.jsx(N,{children:e.jsxs(U,{to:B(t),className:"flex items-center gap-1 text-sm hover:underline text-primary",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:F(t)}),e.jsx($,{className:"h-3 w-3"})]})}),e.jsx(N,{children:G(t.moderation_status,s)}),e.jsx(N,{className:"text-sm text-muted-foreground",children:q(new Date(t.created_at),"MM-dd HH:mm")}),e.jsx(N,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>f(t),title:s("admin.comments.viewDetails"),children:e.jsx(ce,{className:"h-4 w-4"})}),a==="pending"&&t.moderation_status!=="approved"&&e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>c.mutate({commentId:t.id,action:"approve"}),disabled:c.isPending,title:s("admin.comments.approve"),className:"text-green-600 hover:text-green-700",children:e.jsx(A,{className:"h-4 w-4"})}),a==="pending"&&t.moderation_status!=="rejected"&&e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>c.mutate({commentId:t.id,action:"reject"}),disabled:c.isPending,title:s("admin.comments.reject"),className:"text-red-600 hover:text-red-700",children:e.jsx(T,{className:"h-4 w-4"})}),e.jsx(x,{size:"icon",variant:"ghost",onClick:()=>b.mutate({commentId:t.id,archived:a!=="archived"}),disabled:b.isPending,title:s(a==="archived"?"admin.comments.restore":"admin.comments.archive"),className:"text-muted-foreground hover:text-foreground",children:a==="archived"?e.jsx(P,{className:"h-4 w-4"}):e.jsx(R,{className:"h-4 w-4"})})]})})]},t.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s(l?"admin.comments.noMatchingComments":"admin.comments.noComments")})})]})]}),e.jsx(ge,{open:!!r,onOpenChange:()=>f(null),children:e.jsxs(pe,{className:"max-w-2xl",children:[e.jsxs(je,{children:[e.jsx(ve,{children:s("admin.comments.commentDetails")}),e.jsx(fe,{children:s("admin.comments.commentDetailsDesc")})]}),r&&e.jsx(_e,{className:"max-h-[60vh]",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[e.jsxs(K,{children:[e.jsx(O,{src:r.profiles?.avatar_url}),e.jsx(V,{children:e.jsx(Q,{className:"h-4 w-4"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.profiles?.display_name||"Unknown"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:q(new Date(r.created_at),"yyyy-MM-dd HH:mm:ss")})]}),r.rating_value&&e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[e.jsx(le,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),e.jsx("span",{children:r.rating_value})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:s("admin.comments.commentContent")}),e.jsx("div",{className:"p-3 bg-muted rounded-lg whitespace-pre-wrap",children:r.content})]}),r.image_url&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:s("admin.comments.commentImage")}),e.jsx("img",{src:r.image_url,alt:"Comment",className:"max-w-full h-auto rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:s("admin.comments.commentTarget")}),e.jsxs(U,{to:B(r),className:"flex items-center gap-2 p-3 bg-muted rounded-lg hover:bg-muted/80",children:[e.jsxs("span",{children:[r.target_type==="restaurant"?s("admin.comments.restaurant"):s("admin.comments.activity"),":"]}),e.jsx("span",{className:"text-primary",children:F(r)}),e.jsx($,{className:"h-4 w-4"})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),s("admin.comments.aiAnalysis")]}),e.jsxs("div",{className:"p-3 bg-muted rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[s("admin.comments.riskScore"),":"]}),e.jsxs(g,{variant:"outline",className:Y(r.risk_score),children:[r.risk_score,"/100"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[s("admin.comments.moderationStatus"),":"]}),G(r.moderation_status,s)]}),r.risk_reasons.length>0&&e.jsxs("div",{children:[e.jsxs("span",{children:[s("admin.comments.issuesDetected"),":"]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:r.risk_reasons.map((t,o)=>e.jsx(g,{variant:"secondary",children:W(t,s)},o))})]}),r.ai_reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s("admin.comments.aiReviewTime"),": ",q(new Date(r.ai_reviewed_at),"yyyy-MM-dd HH:mm:ss")]}),r.reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s("admin.comments.manualReviewTime"),": ",q(new Date(r.reviewed_at),"yyyy-MM-dd HH:mm:ss")]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[r.moderation_status!=="approved"&&e.jsxs(x,{onClick:()=>{c.mutate({commentId:r.id,action:"approve"},{onSuccess:()=>f(null)})},disabled:c.isPending,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),s("admin.comments.approve")]}),r.moderation_status!=="rejected"&&e.jsxs(x,{variant:"destructive",onClick:()=>{c.mutate({commentId:r.id,action:"reject"},{onSuccess:()=>f(null)})},disabled:c.isPending,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),s("admin.comments.reject")]}),e.jsx(x,{variant:"outline",onClick:()=>f(null),children:s("admin.comments.close")})]})]})})]})})]})};export{Qe as default};
//# sourceMappingURL=AdminComments--z_Kk0Sx.js.map
