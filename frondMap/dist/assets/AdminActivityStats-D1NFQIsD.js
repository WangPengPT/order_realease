import{x as $,u as ee,r as se,q as N,j as e,d as u,B as ae,L as te,b as re,ah as ie,ai as ne,aj as le,ak as ce,al as v,C as d,f as o,S as de,e as w,p as _,a1 as S,a2 as C,a3 as L,o as oe,s as h}from"./index-DjxB8hoH.js";import{c as me,d as xe}from"./useActivities-DmtiFPaO.js";import{u as he}from"./useLocalizedContent-qVyUbtVE.js";import{C as ue}from"./chevron-left-BVUAV8vX.js";import{E as pe}from"./eye-jy74Z629.js";import{H as k}from"./heart-CSEpI_yt.js";import{S as T}from"./share-2-Daq7pjix.js";import{S as F}from"./star-BbfM7Axl.js";import{M as R}from"./message-circle-BueMiKYp.js";import{T as je}from"./trending-up-Bt5d3ZDd.js";import{R as fe,L as ge,C as ye,X as Ne,Y as ve,T as we,b as _e}from"./LineChart-Cb0Xkix_.js";import{f}from"./format-0Ztyy0_D.js";import{s as q}from"./subDays-djY9yzJX.js";import{s as D}from"./startOfDay-DwrePYsk.js";import"./isEqual-B3G6uj_h.js";const ze=()=>{const{id:c}=$(),{t:r}=ee(),{getLocalizedField:I}=he(),[x,K]=se.useState("30days"),V=()=>{const s=new Date;switch(x){case"today":return D(s).toISOString();case"7days":return D(q(s,6)).toISOString();case"30days":return D(q(s,29)).toISOString();default:return null}},z=()=>{switch(x){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:A,isLoading:E}=me(c),{data:H=[]}=xe(c),m=V(),{data:g=[],isLoading:O}=N({queryKey:["activity-subscribers",c,x],queryFn:async()=>{let s=h.from("subscriptions").select("user_id, created_at").eq("activity_id",c).order("created_at",{ascending:!1});m&&(s=s.gte("created_at",m));const{data:t,error:a}=await s;if(a)throw a;if(t&&t.length>0){const i=t.map(l=>l.user_id),{data:n}=await h.rpc("get_public_profiles",{user_ids:i});return t.map(l=>({...l,profile:n==null?void 0:n.find(j=>j.id===l.user_id)}))}return[]},enabled:!!c}),{data:y=[],isLoading:U}=N({queryKey:["activity-sharers",c,x],queryFn:async()=>{let s=h.from("activity_shares").select("user_id, created_at").eq("activity_id",c).order("created_at",{ascending:!1});m&&(s=s.gte("created_at",m));const{data:t,error:a}=await s;if(a)throw a;if(t&&t.length>0){const i=t.map(l=>l.user_id),{data:n}=await h.rpc("get_public_profiles",{user_ids:i});return t.map(l=>({...l,profile:n==null?void 0:n.find(j=>j.id===l.user_id)}))}return[]},enabled:!!c}),{data:p=[],isLoading:B}=N({queryKey:["activity-comments",c,x],queryFn:async()=>{let s=h.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_id",c).eq("target_type","activity").order("created_at",{ascending:!1});m&&(s=s.gte("created_at",m));const{data:t,error:a}=await s;if(a)throw a;if(t&&t.length>0){const i=[...new Set(t.map(l=>l.user_id))],{data:n}=await h.rpc("get_public_profiles",{user_ids:i});return t.map(l=>({...l,profile:n==null?void 0:n.find(j=>j.id===l.user_id)}))}return[]},enabled:!!c}),{data:M=[],isLoading:W}=N({queryKey:["activity-page-views",c,x],queryFn:async()=>{let s=h.from("page_views").select("created_at").eq("target_id",c).eq("page_type","activity");m&&(s=s.gte("created_at",m));const{data:t,error:a}=await s;if(a)throw a;return t||[]},enabled:!!c}),X=(()=>{const s=new Map,t=z();for(let a=t-1;a>=0;a--){const i=f(q(new Date,a),"MM-dd");s.set(i,0)}return M.forEach(a=>{const i=f(new Date(a.created_at),"MM-dd");s.has(i)&&s.set(i,(s.get(i)||0)+1)}),Array.from(s.entries()).map(([a,i])=>({date:a,views:i}))})(),Y=M.length,G=g.length,P=y.length,b=p.filter(s=>s.rating_value!==null),Q=b.length>0?(b.reduce((s,t)=>s+(t.rating_value||0),0)/b.length).toFixed(1):"0.0",J=p.length;if(E)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(u,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(u,{className:"h-32"},s))})]});if(!A)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:r("common.notFound")})});const Z=I(A,"title");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ae,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(te,{to:"/admin/activity-stats",children:e.jsx(ue,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:r("admin.activityStats")}),e.jsx("p",{className:"text-muted-foreground",children:Z})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-12 sm:ml-0",children:[e.jsx(re,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(ie,{value:x,onValueChange:s=>K(s),children:[e.jsx(ne,{className:"w-[140px]",children:e.jsx(le,{})}),e.jsxs(ce,{children:[e.jsx(v,{value:"today",children:r("analytics.today")}),e.jsx(v,{value:"7days",children:r("analytics.last7Days")}),e.jsx(v,{value:"30days",children:r("analytics.last30Days","近30天")}),e.jsx(v,{value:"all",children:r("analytics.allTime","所有时间")})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(d,{children:e.jsxs(o,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:r("analytics.pageViews")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Y})]})}),e.jsx(d,{children:e.jsxs(o,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(k,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:r("activities.favorites")})]}),e.jsx("p",{className:"text-2xl font-bold",children:G})]})}),e.jsx(d,{children:e.jsxs(o,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(T,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:r("activities.shares")})]}),e.jsx("p",{className:"text-2xl font-bold",children:P})]})}),e.jsx(d,{children:e.jsxs(o,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:r("restaurant.rating")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Q})]})}),e.jsx(d,{children:e.jsxs(o,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:r("restaurant.comments")})]}),e.jsx("p",{className:"text-2xl font-bold",children:J})]})}),e.jsx(d,{children:e.jsxs(o,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:r("activities.participatingRestaurants")})]}),e.jsx("p",{className:"text-2xl font-bold",children:H.length})]})})]}),e.jsxs(d,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5"}),r("analytics.viewTrend")]})}),e.jsx(o,{children:e.jsx("div",{className:"h-[300px]",children:W?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(u,{className:"h-full w-full"})}):e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(ge,{data:X,children:[e.jsx(ye,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(Ne,{dataKey:"date",className:"text-xs",tick:{fontSize:11}}),e.jsx(ve,{className:"text-xs",tick:{fontSize:11}}),e.jsx(we,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(_e,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1})]})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(d,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),r("admin.sharersList","分享用户")," (",y.length,")"]})}),e.jsx(o,{children:U?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(u,{className:"h-12 w-full"},s))}):y.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:y.map((s,t)=>{var a,i,n,l;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:(a=s.profile)==null?void 0:a.avatar_url}),e.jsx(L,{children:((n=(i=s.profile)==null?void 0:i.display_name)==null?void 0:n.charAt(0))||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:((l=s.profile)==null?void 0:l.display_name)||r("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:f(new Date(s.created_at),"yyyy-MM-dd")})]},t)})}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:r("analytics.noData")})})]}),e.jsxs(d,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"}),r("admin.subscribersList","收藏用户")," (",g.length,")"]})}),e.jsx(o,{children:O?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(u,{className:"h-12 w-full"},s))}):g.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:g.map((s,t)=>{var a,i,n,l;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:(a=s.profile)==null?void 0:a.avatar_url}),e.jsx(L,{children:((n=(i=s.profile)==null?void 0:i.display_name)==null?void 0:n.charAt(0))||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:((l=s.profile)==null?void 0:l.display_name)||r("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:f(new Date(s.created_at),"yyyy-MM-dd")})]},t)})}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:r("analytics.noData")})})]})]}),e.jsxs(d,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5"}),r("admin.commentsAndRatings","评论与评分")," (",p.length,")"]})}),e.jsx(o,{children:B?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(u,{className:"h-20 w-full"},s))}):p.length>0?e.jsx("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:p.map(s=>{var t,a,i,n;return e.jsxs("div",{className:"p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:(t=s.profile)==null?void 0:t.avatar_url}),e.jsx(L,{children:((i=(a=s.profile)==null?void 0:a.display_name)==null?void 0:i.charAt(0))||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:((n=s.profile)==null?void 0:n.display_name)||r("common.anonymous")}),s.rating_value&&e.jsxs(oe,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(F,{className:"w-3 h-3 fill-current"}),s.rating_value]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:f(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3",children:s.content})]},s.id)})}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:r("analytics.noData")})})]})]})};export{ze as default};
