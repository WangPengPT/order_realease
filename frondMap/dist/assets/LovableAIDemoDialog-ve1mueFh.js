import{r as a,j as e,bk as w,aM as D,am as J,ak as R,aN as H,c8 as X}from"./vendor-react-DO-hMdHk.js";import{D as U,c as B,d as F,e as Y,S as Z,B as k,I as _}from"./index-C2w_dG6n.js";function G({open:h,onOpenChange:A}){const[l,o]=a.useState([]),[u,N]=a.useState(""),[c,f]=a.useState(!1),[m,O]=a.useState(null),p=a.useRef(null),i=a.useRef(null);a.useEffect(()=>{h&&!m&&navigator.geolocation?.getCurrentPosition(s=>{O({lat:s.coords.latitude,lng:s.coords.longitude})},s=>{console.log("Unable to get user location:",s.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5})},[h,m]),a.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[l]);const E=async s=>{if(s.preventDefault(),!u.trim()||c)return;const r={role:"user",content:u.trim()};o(t=>[...t,r]),N(""),f(!0);const T={role:"assistant",content:""};o(t=>[...t,T]);try{i.current=new AbortController;const t=await fetch("https://tzdgqhwyzsxkxnncgzap.supabase.co/functions/v1/lovable-chat",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw"},body:JSON.stringify({messages:[...l,r],lat:m?.lat,lng:m?.lng}),signal:i.current.signal});if(!t.ok){const g=await t.json().catch(()=>({}));throw new Error(g.error||`请求失败: ${t.status}`)}const x=t.body?.getReader();if(!x)throw new Error("无法读取响应流");const d=new TextDecoder;let n="";for(;;){const{done:g,value:z}=await x.read();if(g)break;n+=d.decode(z,{stream:!0});const y=n.split(`
`);n=y.pop()||"";for(const I of y){if(!I.startsWith("data: "))continue;const v=I.slice(6).trim();if(v!=="[DONE]")try{const S=JSON.parse(v).choices?.[0]?.delta?.content;S&&(X.flushSync(()=>{o(j=>{const b=[...j],C=b[b.length-1];return C?.role==="assistant"&&(C.content+=S),b})}),await new Promise(j=>requestAnimationFrame(j)))}catch{}}}}catch(t){if(t.name==="AbortError")return;o(x=>{const d=[...x],n=d[d.length-1];return n?.role==="assistant"&&(n.content=`错误: ${t.message}`),d})}finally{f(!1),i.current=null}},L=()=>{i.current?.abort(),o([]),f(!1)},M=s=>{s||i.current?.abort(),A(s)},$=s=>{let r=s.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre class="bg-muted p-2 rounded my-2 overflow-x-auto text-sm"><code>$2</code></pre>').replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm">$1</code>').replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" class="text-primary underline">$1</a>').replace(/\n/g,"<br />");return e.jsx("span",{dangerouslySetInnerHTML:{__html:r}})};return e.jsx(U,{open:h,onOpenChange:M,children:e.jsxs(B,{className:"max-w-2xl h-[600px] flex flex-col p-0",children:[e.jsx(F,{className:"p-4 pb-2 border-b",children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-5 w-5 text-purple-500"}),"Lovable AI 测试"]})}),e.jsx(Z,{className:"flex-1 p-4",ref:p,children:e.jsxs("div",{className:"space-y-4",children:[l.length===0&&e.jsxs("div",{className:"text-center text-muted-foreground py-8",children:[e.jsx(w,{className:"h-12 w-12 mx-auto mb-4 text-purple-500/50"}),e.jsx("p",{children:"发送消息开始测试 Lovable AI"}),e.jsx("p",{className:"text-sm mt-2",children:"使用 google/gemini-3-flash-preview 模型"})]}),l.map((s,r)=>e.jsxs("div",{className:`flex gap-3 ${s.role==="user"?"justify-end":"justify-start"}`,children:[s.role==="assistant"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0",children:e.jsx(w,{className:"h-4 w-4 text-purple-500"})}),e.jsx("div",{className:`max-w-[80%] rounded-lg px-4 py-2 ${s.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,children:s.role==="assistant"?e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none",children:s.content?$(s.content):e.jsx(D,{className:"h-4 w-4 animate-spin"})}):e.jsx("p",{className:"whitespace-pre-wrap",children:s.content})}),s.role==="user"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(J,{className:"h-4 w-4 text-primary"})})]},r))]})}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("form",{onSubmit:E,className:"flex gap-2",children:[e.jsx(k,{type:"button",variant:"outline",size:"icon",onClick:L,disabled:l.length===0&&!c,children:e.jsx(R,{className:"h-4 w-4"})}),e.jsx(_,{value:u,onChange:s=>N(s.target.value),placeholder:"输入消息测试 Lovable AI...",disabled:c,className:"flex-1"}),e.jsx(k,{type:"submit",disabled:!u.trim()||c,children:c?e.jsx(D,{className:"h-4 w-4 animate-spin"}):e.jsx(H,{className:"h-4 w-4"})})]})})]})})}export{G as L};
//# sourceMappingURL=LovableAIDemoDialog-ve1mueFh.js.map
