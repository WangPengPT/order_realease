import{p as B,bH as X,bL as Y,j as s,bP as E,d$ as L,c4 as $,w as p,r as x,bw as Z,c2 as T,b4 as w}from"./vendor-react-COnB1Bf9.js";import{D as ss,c as es,d as as,e as ns,T as ts,I as q,a8 as rs,B as j,C as S,p as P,F as C,q as D,s as is,g as cs}from"./index-T7L6ozN1.js";import{T as _,a as F,b as y,c as i,d as H,e as c}from"./table-C1iD4Vcy.js";import{T as os,a as ls,b as R,c as A}from"./tabs-fhdByuMp.js";import{a as ds,b as ms}from"./usePoints-C7UE1qt0.js";import{F as hs,a as k,b as G,c as I,d as M,e as U}from"./form-D1jHscGM.js";import{N as xs,T as us,O as ps,D as js}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CK3nEoYK.js";const gs=xs({amount:us().min(1,"积分数量必须大于0"),reason:ps().min(1,"请填写原因")}),fs=({open:a,onOpenChange:l,user:d,type:t})=>{const{t:n}=B(),m=ds(),h=X({resolver:Y(gs),defaultValues:{amount:10,reason:""}}),g=async r=>{if(!d)return;const u=t==="deduct"?-r.amount:r.amount;try{const o=await m.mutateAsync({userId:d.id,amount:u,reason:r.reason});o.success?(p.success(n(t==="grant"?"admin.points.grantSuccess":"admin.points.deductSuccess")),h.reset(),l(!1)):p.error(o.error||n("common.error"))}catch(o){console.error("Error modifying points:",o),p.error(n("common.error"))}};return d?s.jsx(ss,{open:a,onOpenChange:l,children:s.jsxs(es,{children:[s.jsxs(as,{children:[s.jsx(ns,{className:"flex items-center gap-2",children:t==="grant"?s.jsxs(s.Fragment,{children:[s.jsx(E,{className:"h-5 w-5 text-green-500"}),n("admin.points.grantPoints")]}):s.jsxs(s.Fragment,{children:[s.jsx(L,{className:"h-5 w-5 text-red-500"}),n("admin.points.deductPoints")]})}),s.jsxs(ts,{children:[n("admin.points.targetUser"),": ",s.jsx("strong",{children:d.display_name}),s.jsx("br",{}),n("admin.points.currentPoints"),": ",s.jsx("strong",{children:d.points})]})]}),s.jsx(hs,{...h,children:s.jsxs("form",{onSubmit:h.handleSubmit(g),className:"space-y-4",children:[s.jsx(k,{control:h.control,name:"amount",render:({field:r})=>s.jsxs(G,{children:[s.jsx(I,{children:n("admin.points.amount")}),s.jsx(M,{children:s.jsxs("div",{className:"relative",children:[s.jsx($,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(q,{type:"number",className:"pl-10",min:1,...r,onChange:u=>r.onChange(parseInt(u.target.value)||0)})]})}),s.jsx(U,{})]})}),s.jsx(k,{control:h.control,name:"reason",render:({field:r})=>s.jsxs(G,{children:[s.jsxs(I,{children:[n("admin.points.reason")," *"]}),s.jsx(M,{children:s.jsx(rs,{...r,placeholder:n(t==="grant"?"admin.points.grantReasonPlaceholder":"admin.points.deductReasonPlaceholder"),rows:3})}),s.jsx(U,{})]})}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(j,{type:"button",variant:"outline",onClick:()=>l(!1),children:n("common.cancel")}),s.jsx(j,{type:"submit",disabled:m.isPending,variant:t==="deduct"?"destructive":"default",children:m.isPending?n("common.processing"):n(t==="grant"?"admin.points.confirmGrant":"admin.points.confirmDeduct")})]})]})})]})}):null},_s=()=>{const{t:a}=B(),{data:l,isLoading:d}=ms(),[t,n]=x.useState(""),[m,h]=x.useState([]),[g,r]=x.useState(!1),[u,o]=x.useState(!1),[z,N]=x.useState(null),[O,b]=x.useState("grant"),v=async()=>{if(!t.trim()){p.error(a("admin.points.enterSearchTerm"));return}r(!0);try{const{data:e,error:f}=await is.from("profiles").select("id, display_name, avatar_url, points").or(`display_name.ilike.%${t}%,id.eq.${t.match(/^[0-9a-f-]{36}$/i)?t:"00000000-0000-0000-0000-000000000000"}`).limit(20);if(f)throw f;h(e||[])}catch(e){console.error("Search error:",e),p.error(a("common.error"))}finally{r(!1)}},Q=e=>{N(e),b("grant"),o(!0)},V=e=>{N(e),b("deduct"),o(!0)},K=e=>{switch(e){case"comment":return a("admin.points.typeComment");case"admin_grant":return a("admin.points.typeAdminGrant");case"admin_deduct":return a("admin.points.typeAdminDeduct");case"purchase":return a("admin.points.typePurchase");case"refund":return a("admin.points.typeRefund");case"expire":return a("admin.points.typeExpire");default:return e}},J=(e,f)=>{const W=f>0;return s.jsx(cs,{variant:W?"default":"secondary",children:K(e)})};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold",children:a("admin.points.title")}),s.jsx("p",{className:"text-muted-foreground",children:a("admin.points.description")})]}),s.jsxs(os,{defaultValue:"users",className:"space-y-4",children:[s.jsxs(ls,{children:[s.jsxs(R,{value:"users",className:"flex items-center gap-2",children:[s.jsx(Z,{className:"h-4 w-4"}),a("admin.points.userManagement")]}),s.jsxs(R,{value:"history",className:"flex items-center gap-2",children:[s.jsx(T,{className:"h-4 w-4"}),a("admin.points.transactionHistory")]})]}),s.jsx(A,{value:"users",className:"space-y-4",children:s.jsxs(S,{children:[s.jsx(P,{children:s.jsxs(C,{className:"flex items-center gap-2",children:[s.jsx(w,{className:"h-5 w-5"}),a("admin.points.searchUser")]})}),s.jsxs(D,{children:[s.jsxs("div",{className:"flex gap-2",children:[s.jsx(q,{placeholder:a("admin.points.searchPlaceholder"),value:t,onChange:e=>n(e.target.value),onKeyDown:e=>e.key==="Enter"&&v()}),s.jsxs(j,{onClick:v,disabled:g,children:[s.jsx(w,{className:"h-4 w-4 mr-2"}),a("common.search")]})]}),m.length>0&&s.jsx("div",{className:"mt-4",children:s.jsxs(_,{children:[s.jsx(F,{children:s.jsxs(y,{children:[s.jsx(i,{children:a("admin.points.user")}),s.jsx(i,{children:a("admin.points.currentPoints")}),s.jsx(i,{className:"text-right",children:a("common.actions")})]})}),s.jsx(H,{children:m.map(e=>s.jsxs(y,{children:[s.jsx(c,{children:s.jsxs("div",{className:"flex items-center gap-3",children:[e.avatar_url?s.jsx("img",{src:e.avatar_url,alt:e.display_name,className:"w-8 h-8 rounded-full object-cover"}):s.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center",children:e.display_name?.charAt(0).toUpperCase()}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:e.display_name}),s.jsx("div",{className:"text-xs text-muted-foreground",children:e.id})]})]})}),s.jsx(c,{children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx($,{className:"h-4 w-4 text-amber-500"}),s.jsx("span",{className:"font-semibold",children:e.points})]})}),s.jsx(c,{className:"text-right",children:s.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.jsxs(j,{variant:"outline",size:"sm",onClick:()=>Q(e),children:[s.jsx(E,{className:"h-4 w-4 mr-1"}),a("admin.points.grant")]}),s.jsxs(j,{variant:"outline",size:"sm",onClick:()=>V(e),children:[s.jsx(L,{className:"h-4 w-4 mr-1"}),a("admin.points.deduct")]})]})})]},e.id))})]})}),m.length===0&&t&&!g&&s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("admin.points.noResults")})]})]})}),s.jsx(A,{value:"history",children:s.jsxs(S,{children:[s.jsx(P,{children:s.jsxs(C,{className:"flex items-center gap-2",children:[s.jsx(T,{className:"h-5 w-5"}),a("admin.points.recentTransactions")]})}),s.jsx(D,{children:d?s.jsx("div",{className:"text-center py-8",children:a("common.loading")}):l&&l.length>0?s.jsxs(_,{children:[s.jsx(F,{children:s.jsxs(y,{children:[s.jsx(i,{children:a("admin.points.time")}),s.jsx(i,{children:a("admin.points.user")}),s.jsx(i,{children:a("admin.points.type")}),s.jsx(i,{children:a("admin.points.amount")}),s.jsx(i,{children:a("admin.points.balance")}),s.jsx(i,{children:a("admin.points.reason")})]})}),s.jsx(H,{children:l.map(e=>s.jsxs(y,{children:[s.jsx(c,{className:"text-sm",children:js(new Date(e.created_at),"yyyy-MM-dd HH:mm")}),s.jsx(c,{children:s.jsx("div",{className:"font-medium",children:e.profiles?.display_name||e.user_id})}),s.jsx(c,{children:J(e.type,e.amount)}),s.jsx(c,{children:s.jsxs("span",{className:e.amount>0?"text-green-600":"text-red-600",children:[e.amount>0?"+":"",e.amount]})}),s.jsx(c,{children:e.balance_after}),s.jsx(c,{className:"text-sm text-muted-foreground max-w-[200px] truncate",children:e.reason||"-"})]},e.id))})]}):s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("admin.points.noTransactions")})})]})})]}),s.jsx(fs,{open:u,onOpenChange:o,user:z,type:O})]})};export{_s as default};
//# sourceMappingURL=AdminPoints-B5KYLtT5.js.map
