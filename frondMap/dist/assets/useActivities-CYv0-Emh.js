import{s as c,q as _,v as b}from"./vendor-react-87iFmKFJ.js";import{u as p,s as a,E as f}from"./index-C3xfGQgV.js";import{i as d}from"./vendor-i18n-AOdgFpXS.js";const w=()=>c({queryKey:["activities"],queryFn:async()=>{const{data:t,error:s}=await a.from("activities").select("*").eq("status","published").order("pinned",{ascending:!1}).order("sort_order",{ascending:!0}).order("start_date",{ascending:!1});if(s)throw s;return await Promise.all((t||[]).map(async r=>{const{count:n}=await a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",r.id),{count:i}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",r.id),{data:o}=await a.rpc("get_activity_creator_info",{creator_user_id:r.creator_id}),u=o;return{...r,subscriber_count:n||0,share_count:i||0,creator:{isAdmin:u?.isAdmin??!0,restaurant:u?.restaurant??null,avatar_url:u?.avatar_url??null}}}))}}),q=()=>c({queryKey:["admin-activities"],queryFn:async()=>{const{data:t,error:s}=await a.from("activities").select("*").order("pinned",{ascending:!1}).order("sort_order",{ascending:!0}).order("start_date",{ascending:!1});if(s)throw s;return await Promise.all((t||[]).map(async r=>{const{count:n}=await a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",r.id),{count:i}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",r.id),{data:o}=await a.rpc("get_activity_creator_info",{creator_user_id:r.creator_id}),u=o;return{...r,subscriber_count:n||0,share_count:i||0,creator:{isAdmin:u?.isAdmin??!0,restaurant:u?.restaurant??null,avatar_url:u?.avatar_url??null}}}))}}),g=t=>c({queryKey:["activity",t],queryFn:async()=>{const{data:s,error:e}=await a.from("activities").select("*").eq("id",t).single();if(e)throw e;return s},enabled:!!t}),A=t=>c({queryKey:["activityRestaurants",t],queryFn:async()=>{const{data:s,error:e}=await a.from("activity_restaurants").select("*").eq("activity_id",t);if(e)throw e;if(!s||s.length===0)return[];const r=s.map(o=>o.restaurant_id),{data:n,error:i}=await a.from("restaurants").select("id, name, name_en, name_pt, type, type_en, type_pt, address, image_url, rating, lat, lng, website_url, show_takeaway_button, show_booking_button").in("id",r);if(i)throw i;return s.map(o=>({...o,restaurants:n?.find(u=>u.id===o.restaurant_id)||{id:o.restaurant_id,name:"",name_en:null,name_pt:null,type:[],type_en:null,type_pt:null,address:"",image_url:null,rating:null,lat:null,lng:null,website_url:null,show_takeaway_button:null,show_booking_button:null}}))},enabled:!!t}),C=()=>{const{user:t}=p();return c({queryKey:["subscriptions",t?.id],queryFn:async()=>{if(!t)return[];const{data:s,error:e}=await a.from("subscriptions").select("*").eq("user_id",t.id).order("created_at",{ascending:!1});if(e)throw e;return(await Promise.all((s||[]).map(async n=>{const{data:i}=await a.from("activities").select("*").eq("id",n.activity_id).eq("status","published").maybeSingle();return{...n,activity:i}}))).filter(n=>n.activity!==null)},enabled:!!t})},K=()=>{const{user:t}=p(),{toast:s}=f(),e=_();return b({mutationFn:async r=>{if(!t)throw new Error("User not authenticated");const{data:n}=await a.from("subscriptions").select("id").eq("activity_id",r).eq("user_id",t.id).maybeSingle();if(n){const{error:i}=await a.from("subscriptions").delete().eq("id",n.id);if(i)throw i;return{action:"unsubscribed",activityId:r}}else{const{error:i}=await a.from("subscriptions").insert({activity_id:r,user_id:t.id});if(i)throw i;return{action:"subscribed",activityId:r}}},onMutate:async r=>{await e.cancelQueries({queryKey:["activities"]}),await e.cancelQueries({queryKey:["subscriptions"]});const n=e.getQueryData(["activities"]),i=e.getQueryData(["subscriptions",t?.id]),u=(e.getQueryData(["subscriptions",t?.id])||[]).some(l=>l.activity_id===r);return e.setQueryData(["activities"],l=>l&&l.map(y=>y.id===r?{...y,subscriber_count:(y.subscriber_count||0)+(u?-1:1)}:y)),{previousActivities:n,previousSubscriptions:i}},onSuccess:r=>{e.invalidateQueries({queryKey:["subscriptions"]}),s({title:r.action==="subscribed"?d.t("toast.subscribed"):d.t("toast.unsubscribed"),description:r.action==="subscribed"?d.t("toast.subscribedDesc"):d.t("toast.unsubscribedDesc")})},onError:(r,n,i)=>{i?.previousActivities&&e.setQueryData(["activities"],i.previousActivities),i?.previousSubscriptions&&e.setQueryData(["subscriptions",t?.id],i.previousSubscriptions),s({title:d.t("common.error"),description:d.t("toast.subscriptionFailed"),variant:"destructive"})}})},Q=t=>c({queryKey:["subscriberCount",t],queryFn:async()=>{const{count:s,error:e}=await a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",t);if(e)throw e;return s||0},enabled:!!t}),S=t=>c({queryKey:["shareCount",t],queryFn:async()=>{const{count:s,error:e}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",t);if(e)throw e;return s||0},enabled:!!t}),F=()=>{const t=_();return b({mutationFn:async({activityId:s,userId:e})=>{const{error:r}=await a.from("activity_shares").insert({activity_id:s,user_id:e});if(r)throw r},onSuccess:(s,e)=>{t.invalidateQueries({queryKey:["shareCount",e.activityId]}),t.invalidateQueries({queryKey:["hasShared",e.activityId]}),t.invalidateQueries({queryKey:["activities"]})}})},x=t=>c({queryKey:["activityCreator",t],queryFn:async()=>{if(!t)return null;const{data:s}=await a.rpc("get_activity_creator_info",{creator_user_id:t}),e=s;return{isAdmin:e?.isAdmin??!0,restaurant:e?.restaurant??null,avatar_url:e?.avatar_url??null}},enabled:!!t});export{C as a,g as b,A as c,Q as d,S as e,F as f,x as g,K as h,q as i,w as u};
//# sourceMappingURL=useActivities-CYv0-Emh.js.map
