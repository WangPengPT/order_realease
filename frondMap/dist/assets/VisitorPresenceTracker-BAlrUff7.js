import{r as o}from"./vendor-react-5CWRUXey.js";import{u as v,s as a}from"./index-ffVqEBGu.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-hygftDOh.js";const u="location_cache",m=()=>{const e="visitor_id";let t=localStorage.getItem(e);return t||(t=crypto.randomUUID(),localStorage.setItem(e,t)),t},p=()=>{try{const e=sessionStorage.getItem(u);if(e){const t=JSON.parse(e);return{country:t.country||null,city:t.city||null,ip:t.ip||null}}}catch{}return null},g=e=>{try{sessionStorage.setItem(u,JSON.stringify(e))}catch{}},I=async()=>{const e=p();if(e)return e;try{const{data:t,error:n}=await a.functions.invoke("get-location");if(n)return console.error("Failed to fetch location:",n),{country:null,city:null,ip:null};const r={country:t?.country||null,city:t?.city||null,ip:t?.ip||null};return(r.country||r.city)&&g(r),r}catch(t){return console.error("Failed to fetch location data:",t),{country:null,city:null,ip:null}}},S=()=>{const{user:e}=v(),t=o.useRef(null),n=o.useRef(null),r=o.useRef(null);o.useEffect(()=>{if(e?.id)return;const c=m(),l=async()=>{const d=await I();n.current=d;const i=a.channel("online-visitors",{config:{presence:{key:c}}});i.on("presence",{event:"sync"},()=>{i.presenceState()}).subscribe(async h=>{h==="SUBSCRIBED"&&await i.track({visitor_id:c,online_at:new Date().toISOString(),country:n.current?.country,city:n.current?.city})}),t.current=i},y=2e3;r.current=setTimeout(l,y);const f=setInterval(()=>{t.current&&t.current.track({visitor_id:c,online_at:new Date().toISOString(),country:n.current?.country,city:n.current?.city})},6e4),s=()=>{document.visibilityState==="visible"&&t.current&&t.current.track({visitor_id:c,online_at:new Date().toISOString(),country:n.current?.country,city:n.current?.city})};return document.addEventListener("visibilitychange",s),()=>{r.current&&clearTimeout(r.current),clearInterval(f),document.removeEventListener("visibilitychange",s),t.current&&(t.current.untrack(),a.removeChannel(t.current))}},[e?.id])},R=()=>(S(),null);export{R as VisitorPresenceTracker,R as default};
//# sourceMappingURL=VisitorPresenceTracker-BAlrUff7.js.map
