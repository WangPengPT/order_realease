{"version":3,"file":"useAIChatHistory-BHmHvjAH.js","sources":["../../src/hooks/useAIChatHistory.ts"],"sourcesContent":["import { useState, useEffect, useCallback } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\n\r\ntype Message = { role: \"user\" | \"assistant\"; content: string };\r\n\r\nexport const useAIChatHistory = (chatType: string = \"what_to_eat\") => {\r\n  const { user } = useAuth();\r\n  const [isLoadingHistory, setIsLoadingHistory] = useState(false);\r\n  const [historyLoaded, setHistoryLoaded] = useState(false);\r\n\r\n  const loadMessages = useCallback(async (): Promise<Message[]> => {\r\n    if (!user?.id) return [];\r\n    setIsLoadingHistory(true);\r\n    try {\r\n      const query = supabase\r\n        .from(\"ai_chat_messages\")\r\n        .select(\"role, content, created_at\")\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"created_at\", { ascending: true })\r\n        .limit(200);\r\n      // Filter by chat_type (column added via migration, not yet in generated types)\r\n      (query as any).eq(\"chat_type\", chatType);\r\n      const { data, error } = await query;\r\n\r\n      if (error) {\r\n        console.error(\"Load chat history error:\", error);\r\n        return [];\r\n      }\r\n      setHistoryLoaded(true);\r\n      return (data || []).map(d => ({ role: d.role as \"user\" | \"assistant\", content: d.content }));\r\n    } catch (err) {\r\n      console.error(\"Load chat history error:\", err);\r\n      return [];\r\n    } finally {\r\n      setIsLoadingHistory(false);\r\n    }\r\n  }, [user?.id, chatType]);\r\n\r\n  const saveMessage = useCallback(async (role: \"user\" | \"assistant\", content: string) => {\r\n    if (!user?.id || !content.trim()) return;\r\n    try {\r\n      await (supabase\r\n        .from(\"ai_chat_messages\") as any)\r\n        .insert({ user_id: user.id, role, content, chat_type: chatType });\r\n    } catch (err) {\r\n      console.error(\"Save chat message error:\", err);\r\n    }\r\n  }, [user?.id, chatType]);\r\n\r\n  const clearHistory = useCallback(async () => {\r\n    if (!user?.id) return;\r\n    try {\r\n      const delQuery = supabase\r\n        .from(\"ai_chat_messages\")\r\n        .delete()\r\n        .eq(\"user_id\", user.id);\r\n      (delQuery as any).eq(\"chat_type\", chatType);\r\n      await delQuery;\r\n    } catch (err) {\r\n      console.error(\"Clear chat history error:\", err);\r\n    }\r\n  }, [user?.id, chatType]);\r\n\r\n  return { loadMessages, saveMessage, clearHistory, isLoadingHistory, historyLoaded };\r\n};\r\n"],"names":["useAIChatHistory","chatType","user","useAuth","isLoadingHistory","setIsLoadingHistory","useState","historyLoaded","setHistoryLoaded","loadMessages","useCallback","query","supabase","data","error","d","err","saveMessage","role","content","clearHistory","delQuery"],"mappings":"8FAMa,MAAAA,EAAmB,CAACC,EAAmB,gBAAkB,CAC9D,KAAA,CAAE,KAAAC,GAASC,IACX,CAACC,EAAkBC,CAAmB,EAAIC,WAAS,EAAK,EACxD,CAACC,EAAeC,CAAgB,EAAIF,WAAS,EAAK,EAElDG,EAAeC,EAAAA,YAAY,SAAgC,CAC/D,GAAI,CAACR,GAAM,GAAI,MAAO,GACtBG,EAAoB,EAAI,EACpB,GAAA,CACI,MAAAM,EAAQC,EACX,KAAK,kBAAkB,EACvB,OAAO,2BAA2B,EAClC,GAAG,UAAWV,EAAK,EAAE,EACrB,MAAM,aAAc,CAAE,UAAW,GAAM,EACvC,MAAM,GAAG,EAEXS,EAAc,GAAG,YAAaV,CAAQ,EACvC,KAAM,CAAE,KAAAY,EAAM,MAAAC,CAAM,EAAI,MAAMH,EAE9B,OAAIG,GACM,QAAA,MAAM,2BAA4BA,CAAK,EACxC,KAETN,EAAiB,EAAI,GACbK,GAAQ,CAAA,GAAI,IAAUE,IAAA,CAAE,KAAMA,EAAE,KAA8B,QAASA,EAAE,OAAA,EAAU,SACpFC,EAAK,CACJ,eAAA,MAAM,2BAA4BA,CAAG,EACtC,EAAC,QACR,CACAX,EAAoB,EAAK,CAC3B,CACC,EAAA,CAACH,GAAM,GAAID,CAAQ,CAAC,EAEjBgB,EAAcP,EAAAA,YAAY,MAAOQ,EAA4BC,IAAoB,CACrF,GAAI,GAACjB,GAAM,IAAM,CAACiB,EAAQ,KAAQ,GAC9B,GAAA,CACF,MAAOP,EACJ,KAAK,kBAAkB,EACvB,OAAO,CAAE,QAASV,EAAK,GAAI,KAAAgB,EAAM,QAAAC,EAAS,UAAWlB,CAAU,CAAA,QAC3De,EAAK,CACJ,QAAA,MAAM,2BAA4BA,CAAG,CAC/C,CACC,EAAA,CAACd,GAAM,GAAID,CAAQ,CAAC,EAEjBmB,EAAeV,EAAAA,YAAY,SAAY,CACvC,GAACR,GAAM,GACP,GAAA,CACI,MAAAmB,EAAWT,EACd,KAAK,kBAAkB,EACvB,OACA,EAAA,GAAG,UAAWV,EAAK,EAAE,EACvBmB,EAAiB,GAAG,YAAapB,CAAQ,EACpC,MAAAoB,QACCL,EAAK,CACJ,QAAA,MAAM,4BAA6BA,CAAG,CAChD,CACC,EAAA,CAACd,GAAM,GAAID,CAAQ,CAAC,EAEvB,MAAO,CAAE,aAAAQ,EAAc,YAAAQ,EAAa,aAAAG,EAAc,iBAAAhB,EAAkB,cAAAG,CAAc,CACpF"}