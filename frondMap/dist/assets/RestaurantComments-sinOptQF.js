import{c as Ie,u as De,p as _e,ad as Ue,F as Pe,o as Le,a as ze,r as i,v as Q,j as e,a3 as ee,a4 as se,a5 as ae,au as Ee,t as te,g as le,B as o,as as ie,al as ne,X as re,I as ce,aw as Me,C as w,m as R,ag as $e,ah as Fe,ai as Te,aj as Ve,ak as Be,l as qe,R as me,T as de,U as oe,V as xe,W as ue,Y as he,Z as pe,$ as ge}from"./index-QLT-vsIo.js";import{u as He,a as Oe,b as We,D as je,R as Xe}from"./ReportDialog-7mfydoX7.js";import{d as Ye}from"./useSensitiveWords-DEz8--7k.js";import{C as Ze}from"./clock-BrXCpyQ1.js";import{C as Ge}from"./circle-alert-D7u-J5e_.js";import{S as V}from"./star-B7FUfuhE.js";import{S as Je}from"./shield-alert-C_JtyZd-.js";import{I as ve}from"./image-DDGwSh6z.js";import{V as Ke}from"./volume-x-CnrTznLX.js";import"./input-otp-CKNhrBzK.js";import"./plus-D1vlSUZG.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=Ie("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),Ne=[{value:"0-5",label:"0-5€"},{value:"5-10",label:"5-10€"},{value:"10-15",label:"10-15€"},{value:"15-20",label:"15-20€"},{value:"20-25",label:"20-25€"},{value:"25-30",label:"25-30€"},{value:"30-40",label:"30-40€"},{value:"40-50",label:"40-50€"},{value:"50+",label:"50€+"}],os=({restaurantId:N,targetType:x="restaurant"})=>{var J,K;const{t:a}=De(),{user:t}=_e(),{data:l}=Ue(),{isAdmin:fe}=Pe(),{toast:m}=Le(),we=ze(),[p,B]=i.useState(""),[g,q]=i.useState(0),[Ce,H]=i.useState(0),[C,O]=i.useState(""),[ye,A]=i.useState(null),[j,I]=i.useState(""),[D,_]=i.useState(null),[W,U]=i.useState(null),[P,L]=i.useState(null),[X,z]=i.useState(null),[h,y]=i.useState(!1),[be,Y]=i.useState(!1),[E,M]=i.useState(null),{data:u,isLoading:ke}=He(N,x),v=Oe(),Z=We(),{checkContent:b}=Ye(),k=i.useCallback(async s=>{try{const c=s.name.split(".").pop(),d=`${`${t==null?void 0:t.id}-${Date.now()}.${c}`}`,{error:f,data:T}=await Q.storage.from("comment-images").upload(d,s);if(f)throw f;const{data:{publicUrl:S}}=Q.storage.from("comment-images").getPublicUrl(d);return S}catch(c){return console.error("Error uploading image:",c),m({title:a("common.error"),description:a("restaurant.imageUploadFailed"),variant:"destructive"}),null}},[t,m,a]),G=i.useCallback((s,c=!1)=>{var d;const n=(d=s.target.files)==null?void 0:d[0];if(n){if(n.size>5*1024*1024){m({title:a("common.error"),description:a("restaurant.imageTooLarge"),variant:"destructive"});return}c?(L(n),z(URL.createObjectURL(n))):(_(n),U(URL.createObjectURL(n)))}},[m,a]),$=i.useCallback((s=!1)=>{s?(L(null),z(null)):(_(null),U(null))},[]),Se=i.useCallback(async()=>{if(!p.trim()||!t)return;if(l!=null&&l.is_muted){m({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(b(p).hasSensitive){m({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}if(x==="restaurant"&&!g){m({title:a("common.hint","提示"),description:a("toast.pleaseSelectRating"),variant:"warning"});return}y(!0);let c;if(D){const n=await k(D);n&&(c=n)}await v.mutateAsync({targetId:N,targetType:x,content:p,ratingValue:x==="restaurant"?g:void 0,priceRange:x==="restaurant"&&C?C:void 0,imageUrl:c}),B(""),q(0),O(""),_(null),U(null),y(!1)},[p,t,l,x,g,m,a,D,k,v,N,C,b]),Re=i.useCallback(async s=>{if(!j.trim()||!t)return;if(l!=null&&l.is_muted){m({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(b(j).hasSensitive){m({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}y(!0);let n;if(P){const d=await k(P);d&&(n=d)}await v.mutateAsync({targetId:N,targetType:x,content:j,parentId:s,imageUrl:n}),I(""),A(null),L(null),z(null),y(!1)},[j,t,l,P,k,v,N,x,b,m,a]),Ae=i.useCallback(async s=>{await Z.mutateAsync(s),M(null)},[Z]),F=i.memo(({comment:s,isReply:c=!1})=>{var n,d,f,T,S;return e.jsxs("div",{className:`flex gap-2 sm:gap-3 ${c?"ml-8 sm:ml-12 mt-3":""}`,children:[e.jsxs(ee,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(se,{src:(n=s.profiles)==null?void 0:n.avatar_url}),e.jsx(ae,{className:"text-xs sm:text-sm",children:((f=(d=s.profiles)==null?void 0:d.display_name)==null?void 0:f.charAt(0).toUpperCase())||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-xs sm:text-sm truncate",children:(T=s.profiles)==null?void 0:T.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0",children:Ee(new Date(s.created_at),{addSuffix:!0})}),s.edited&&e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:["(",a("restaurant.edited"),")"]}),(t==null?void 0:t.id)===s.user_id&&s.moderation_status==="pending"&&e.jsxs(te,{variant:"outline",className:"text-yellow-600 border-yellow-500 bg-yellow-50 dark:bg-yellow-950/30 text-xs py-0 h-5",children:[e.jsx(Ze,{className:"w-3 h-3 mr-1"}),a("restaurant.commentPending","审核中")]}),(t==null?void 0:t.id)===s.user_id&&s.moderation_status==="flagged"&&e.jsxs(te,{variant:"outline",className:"text-destructive border-destructive bg-destructive/10 text-xs py-0 h-5",children:[e.jsx(Ge,{className:"w-3 h-3 mr-1"}),a("restaurant.commentFailed","发送失败")]})]}),!c&&s.rating_value&&e.jsxs("div",{className:"flex items-center gap-3 mt-1 mb-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(r=>e.jsx(V,{className:le("w-4 h-4",r<=s.rating_value?"fill-accent text-accent":"text-muted-foreground")},r))}),s.price_range&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(je,{className:"w-3 h-3"}),e.jsx("span",{children:(S=Ne.find(r=>r.value===s.price_range))==null?void 0:S.label})]})]}),e.jsx("p",{className:"text-xs sm:text-sm mt-1 text-foreground break-words",children:s.content}),s.image_url&&e.jsx("img",{src:s.image_url,alt:"Comment attachment",className:"mt-2 rounded-lg max-w-full sm:max-w-sm w-full"}),e.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-2",children:[!c&&t&&!(l!=null&&l.is_muted)&&e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>A(s.id),className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Qe,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("restaurant.reply")})]}),((t==null?void 0:t.id)===s.user_id||fe)&&e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>M(s.id),className:"h-7 text-xs text-destructive hover:text-destructive px-2 sm:px-3",children:[e.jsx(ie,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("common.delete")})]}),(t==null?void 0:t.id)!==s.user_id&&e.jsx(Xe,{targetType:"comment",targetId:s.id,onLoginRequired:()=>Y(!0),trigger:e.jsxs(o,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Je,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("report.title")})]})})]}),ye===s.id&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ne,{value:j,onChange:r=>I(r.target.value),placeholder:a("restaurant.writeReply"),className:"min-h-[80px] text-sm"}),X&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:X,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(o,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>$(!0),children:e.jsx(re,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex sm:flex-col gap-2",children:[e.jsx(o,{size:"sm",onClick:()=>Re(s.id),disabled:!j.trim()||h,className:"text-xs",children:a(h?"common.loading":"restaurant.reply")}),e.jsx(ce,{type:"file",accept:"image/*",onChange:r=>G(r,!0),className:"hidden",id:`reply-image-${s.id}`,disabled:h}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>{var r;return(r=document.getElementById(`reply-image-${s.id}`))==null?void 0:r.click()},disabled:h,className:"text-xs sm:px-3",children:[e.jsx(ve,{className:"h-4 w-4 sm:mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(o,{size:"sm",variant:"outline",onClick:()=>{A(null),I(""),$(!0)},className:"text-xs",children:a("common.cancel")})]})]})}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3",children:s.replies.map(r=>e.jsx(F,{comment:r,isReply:!0},r.id))})]})]})});return F.displayName="CommentItem",ke?e.jsx("div",{className:"text-center py-8",children:a("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 sm:w-5 h-4 sm:h-5"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold",children:[a("restaurant.reviews")," (",(u==null?void 0:u.length)||0,")"]})]}),t?l!=null&&l.is_muted?e.jsx(w,{className:"border-yellow-300 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(R,{className:"py-4 sm:py-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex items-center gap-3 text-yellow-600 dark:text-yellow-400",children:[e.jsx(Ke,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:a("restaurant.youAreMutedNotice")})]})})}):e.jsx(w,{children:e.jsx(R,{className:"pt-4 sm:pt-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex gap-2 sm:gap-3",children:[e.jsxs(ee,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(se,{src:(l==null?void 0:l.avatar_url)||void 0}),e.jsx(ae,{className:"text-xs sm:text-sm",children:((J=l==null?void 0:l.display_name)==null?void 0:J.charAt(0).toUpperCase())||((K=t==null?void 0:t.email)==null?void 0:K.charAt(0).toUpperCase())||"U"})]}),e.jsxs("div",{className:"flex-1 space-y-2 sm:space-y-3 min-w-0",children:[x==="restaurant"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4 text-accent"}),"评分 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onMouseEnter:()=>H(s),onMouseLeave:()=>H(0),onClick:()=>q(s),className:"transition-transform hover:scale-110",children:e.jsx(V,{className:le("w-7 h-7 cursor-pointer transition-colors",s<=(Ce||g)?"fill-accent text-accent":"text-muted-foreground hover:text-accent")})},s)),g>0&&e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",g,"/5)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(je,{className:"w-4 h-4"}),a("restaurant.priceRange")]}),e.jsxs($e,{value:C,onValueChange:O,children:[e.jsx(Fe,{className:"w-full",children:e.jsx(Te,{placeholder:a("restaurant.selectPriceRange")})}),e.jsx(Ve,{className:"bg-background",children:Ne.map(s=>e.jsx(Be,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsx(ne,{value:p,onChange:s=>B(s.target.value),placeholder:a("restaurant.writeComment"),className:"min-h-[80px] sm:min-h-[100px] text-sm"}),W&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:W,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(o,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>$(!1),children:e.jsx(re,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(ce,{type:"file",accept:"image/*",onChange:s=>G(s,!1),className:"hidden",id:"comment-image",disabled:h}),e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{var s;return(s=document.getElementById("comment-image"))==null?void 0:s.click()},disabled:h,className:"text-xs",children:[e.jsx(ve,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(o,{onClick:Se,disabled:!p.trim()||v.isPending||h,size:"sm",className:"text-xs",children:h||v.isPending?a("common.loading"):a("restaurant.postComment")})]})]})]})})}):e.jsx(w,{children:e.jsx(R,{className:"py-4 sm:py-6 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.signInToComment")})}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:u==null?void 0:u.map(s=>e.jsx(w,{children:e.jsx(qe,{className:"p-3 sm:p-6",children:e.jsx(F,{comment:s})})},s.id))}),(u==null?void 0:u.length)===0&&e.jsx(w,{children:e.jsx(R,{className:"py-8 sm:py-12 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.noComments")})})]}),e.jsx(me,{open:be,onOpenChange:Y,children:e.jsxs(de,{children:[e.jsxs(oe,{children:[e.jsx(xe,{children:a("activities.loginRequired")}),e.jsx(ue,{children:a("activities.loginRequiredMessage")})]}),e.jsxs(he,{children:[e.jsx(pe,{children:a("common.cancel")}),e.jsx(ge,{onClick:()=>we("/auth"),children:a("activities.goToLogin")})]})]})}),e.jsx(me,{open:!!E,onOpenChange:s=>!s&&M(null),children:e.jsxs(de,{className:"max-w-sm",children:[e.jsxs(oe,{children:[e.jsx("div",{className:"mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(ie,{className:"h-7 w-7 text-destructive"})}),e.jsx(xe,{className:"text-center",children:a("restaurant.deleteComment")}),e.jsx(ue,{className:"text-center",children:a("restaurant.confirmDelete")})]}),e.jsxs(he,{className:"sm:justify-center gap-2",children:[e.jsx(pe,{className:"sm:w-24",children:a("common.cancel")}),e.jsx(ge,{onClick:()=>E&&Ae(E),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 sm:w-24",children:a("common.delete")})]})]})})]})};export{os as default};
