import{p as de,r as o,ci as oe,u as fe,j as e,bU as pe,am as xe,aM as le,cj as we,ck as be,aN as je}from"./vendor-react-DP7WA3kK.js";import{u as ye,b as Ne,Z as ke,i as G,B as ie,S as Se,I as ve,o as Ce}from"./index-CWtKsrnp.js";import{L as Re}from"./LocationPermissionDialog-DYdSvubz.js";import{E as Ae}from"./ExternalLinkConfirmDialog-DkSOJblm.js";const Q="https://tzdgqhwyzsxkxnncgzap.supabase.co",M="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",Ie=["最近","附近","离我","距离","远近","近的","周边","周围","最近的","附近的","nearest","closest","nearby","near me","close to me","distance","around me","mais perto","próximo","perto de mim","distância","mais próximo"],Ee=()=>{const w="xiaoxiong_anonymous_user_id";let R=localStorage.getItem(w);return R||(R=`anon_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,localStorage.setItem(w,R)),R},ze=(w="ask-xiaoxiong")=>{const{i18n:R}=de(),{user:T}=ye(),[O,U]=o.useState(""),[X,S]=o.useState([]),[$,F]=o.useState(!1),[L,K]=o.useState(null),[ee,P]=o.useState(!1),[W,V]=o.useState(null),A=o.useRef(null),v=o.useCallback(()=>T?.id?T.id:Ee(),[T?.id]),Y=o.useCallback(n=>{const f=n.toLowerCase();return Ie.some(h=>f.includes(h))},[]),te=async(n,f)=>{const h=await fetch(`${Q}/functions/v1/ask-xiaoxiong`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M}`,apikey:M},body:JSON.stringify({text:n.content,stream:!0,lat:L?.lat,lng:L?.lng}),signal:A.current?.signal});if(!h.ok)throw new Error(`Request failed with status: ${h.status}`);if(!h.body)throw new Error("No response body");const i=h.body.getReader(),y=new TextDecoder;let d="";for(;;){const{done:p,value:r}=await i.read();if(p)break;const u=y.decode(r,{stream:!0});d+=u;let l=d;l.startsWith('"')&&(l=l.slice(1)),l.endsWith('"')&&(l=l.slice(0,-1)),l=l.replace(/\\n/g,`
`),S(x=>x.map(b=>b.id===f?{...b,content:l}:b))}let m=d;m.startsWith('"')&&(m=m.slice(1)),m.endsWith('"')&&(m=m.slice(0,-1)),m=m.replace(/\\n/g,`
`),S(p=>p.map(r=>r.id===f?{...r,content:m,isStreaming:!1}:r))},se=async(n,f)=>{const h=v(),i=await fetch(`${Q}/functions/v1/xiaoxiong-agent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M}`,apikey:M},body:JSON.stringify({message:n.content,userId:h}),signal:A.current?.signal});if(!i.ok)throw new Error(`Request failed with status: ${i.status}`);if(!i.body)throw new Error("No response body");const y=i.body.getReader(),d=new TextDecoder;let m="";for(;;){const{done:p,value:r}=await y.read();if(p)break;const u=d.decode(r,{stream:!0});m+=u,oe.flushSync(()=>{S(l=>l.map(x=>x.id===f?{...x,content:m}:x))}),await new Promise(l=>requestAnimationFrame(l))}S(p=>p.map(r=>r.id===f?{...r,isStreaming:!1}:r))},z=async(n,f,h)=>{const i=await fetch(`${Q}/functions/v1/lovable-chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M}`,apikey:M},body:JSON.stringify({message:n.content,lat:L?.lat,lng:L?.lng,language:R.language,isFirstMessage:h}),signal:A.current?.signal});if(!i.ok){const r=await i.json().catch(()=>({}));throw new Error(r.error||`Request failed with status: ${i.status}`)}if(!i.body)throw new Error("No response body");const y=i.body.getReader(),d=new TextDecoder;let m="",p="";for(;;){const{done:r,value:u}=await y.read();if(r)break;p+=d.decode(u,{stream:!0});let l;for(;(l=p.indexOf(`
`))!==-1;){let x=p.slice(0,l);if(p=p.slice(l+1),x.endsWith("\r")&&(x=x.slice(0,-1)),x.startsWith(":")||x.trim()===""||!x.startsWith("data: "))continue;const b=x.slice(6).trim();if(b==="[DONE]")break;try{const N=JSON.parse(b).choices?.[0]?.delta?.content;N&&(m+=N,oe.flushSync(()=>{S(B=>B.map(E=>E.id===f?{...E,content:m}:E))}),await new Promise(B=>requestAnimationFrame(B)))}catch{}}}S(r=>r.map(u=>u.id===f?{...u,isStreaming:!1}:u))},Z=async(n,f,h)=>{const i=X.filter(u=>u.content&&!u.isStreaming).map(u=>({role:u.role,content:u.content}));i.push({role:"user",content:n.content});const y=await fetch(`${Q}/functions/v1/xiaoxiong-community`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M}`,apikey:M},body:JSON.stringify({messages:i,includeContext:!0,isFirstMessage:h}),signal:A.current?.signal});if(!y.ok){const u=await y.json().catch(()=>({}));throw new Error(u.error||`Request failed with status: ${y.status}`)}if(!y.body)throw new Error("No response body");const d=y.body.getReader(),m=new TextDecoder;let p="",r="";for(;;){const{done:u,value:l}=await d.read();if(u)break;r+=m.decode(l,{stream:!0});let x;for(;(x=r.indexOf(`
`))!==-1;){let b=r.slice(0,x);if(r=r.slice(x+1),b.endsWith("\r")&&(b=b.slice(0,-1)),b.startsWith(":")||b.trim()===""||!b.startsWith("data: "))continue;const _=b.slice(6).trim();if(_==="[DONE]")break;try{const B=JSON.parse(_).choices?.[0]?.delta?.content;B&&(p+=B,oe.flushSync(()=>{S(E=>E.map(H=>H.id===f?{...H,content:p}:H))}),await new Promise(E=>requestAnimationFrame(E)))}catch{}}}S(u=>u.map(l=>l.id===f?{...l,isStreaming:!1}:l))},I=o.useCallback(async n=>{const f=X.length===0,h={id:Date.now().toString(),role:"user",content:n},i=(Date.now()+1).toString(),y={id:i,role:"assistant",content:"",isStreaming:!0};S(d=>[...d,h,y]),U(""),F(!0),A.current&&A.current.abort(),A.current=new AbortController;try{w==="xiaoxiong-community"?await Z(h,i,f):w==="lovable-ai"?await z(h,i,f):w==="xiaoxiong-agent"?await se(h,i):await te(h,i)}catch(d){if(d instanceof Error&&d.name==="AbortError"){console.log("Request aborted");return}console.error("Ask API error:",d);const m=R.language==="zh"?"抱歉，暂时无法获取结果，请稀后再试":R.language==="pt"?"Desculpe, não foi possível obter resultados. Tente novamente mais tarde.":"Sorry, unable to get results. Please try again later.";S(p=>p.map(r=>r.id===i?{...r,content:m,isStreaming:!1}:r))}finally{F(!1)}},[w,L,R.language,v,X.length]),D=o.useCallback(()=>{P(!1),navigator.geolocation?.getCurrentPosition(n=>{K({lat:n.coords.latitude,lng:n.coords.longitude}),W&&setTimeout(()=>{I(W),V(null)},100)},n=>{console.log("Location permission denied:",n.message),W&&(I(W),V(null))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},[W,I]),J=o.useCallback(async()=>{if(!O.trim()||$)return;const n=O.trim();if(!L&&Y(n)){V(n),P(!0),U("");return}await I(n)},[O,$,L,Y,I]),ne=o.useCallback(n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),J())},[J]),q=o.useCallback(()=>{A.current&&A.current.abort()},[]),ae=o.useCallback(()=>{navigator.geolocation?.getCurrentPosition(n=>{K({lat:n.coords.latitude,lng:n.coords.longitude})},n=>{console.log("Unable to get user location:",n.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5})},[]);return{input:O,setInput:U,messages:X,isLoading:$,showLocationDialog:ee,setShowLocationDialog:P,pendingMessage:W,setPendingMessage:V,handleSubmit:J,handleKeyDown:ne,handleLocationConfirm:D,processMessage:I,abortRequest:q,requestLocation:ae}},Oe=()=>!!(window.webkit?.messageHandlers?.VoiceBridge||window.VoiceBridge),ce={start:()=>{const w=JSON.stringify({action:"start"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(w):window.VoiceBridge&&window.VoiceBridge.postMessage(w)},stop:()=>{const w=JSON.stringify({action:"stop"});window.webkit?.messageHandlers?.VoiceBridge?window.webkit.messageHandlers.VoiceBridge.postMessage(w):window.VoiceBridge&&window.VoiceBridge.postMessage(w)}},Be=({messages:w,input:R,setInput:T,isLoading:O,showLocationDialog:U,setShowLocationDialog:X,pendingMessage:S,handleSubmit:$,handleKeyDown:F,handleLocationConfirm:L,processMessage:K,setPendingMessage:ee,onClose:P,showBackButton:W=!1,showHeader:V=!0,className:A})=>{const{i18n:v}=de(),Y=fe(),{settings:te}=Ne(),{data:se}=ke(),z=te?.logo_url,Z=se?.avatar_url,[I,D]=o.useState(!1),[J,ne]=o.useState(!1),[q,ae]=o.useState(!1),[n,f]=o.useState(!1),[h,i]=o.useState(null),y=o.useRef(null),d=o.useRef(null),m=o.useRef(null);o.useEffect(()=>{const t=window.SpeechRecognition||window.webkitSpeechRecognition;return ne(!!t),ae(Oe()),window.onSpeechResult=c=>{T(c),D(!1)},()=>{window.onSpeechResult=void 0}},[T]),o.useEffect(()=>{m.current?.scrollIntoView({behavior:"smooth"})},[w]),o.useEffect(()=>()=>{d.current&&d.current.stop()},[]);const p=()=>J||q,r=()=>{if(q){ce.start(),D(!0);return}const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t)return;d.current&&d.current.stop();const c=new t;d.current=c;const s={zh:"zh-CN",en:"en-US",pt:"pt-BR"};c.lang=s[v.language]||"zh-CN",c.continuous=!1,c.interimResults=!0,c.onstart=()=>D(!0),c.onresult=j=>{const a=Array.from(j.results).map(g=>g[0].transcript).join("");T(a)},c.onerror=()=>D(!1),c.onend=()=>D(!1),c.start()},u=()=>{if(q){ce.stop(),D(!1);return}d.current&&(d.current.stop(),D(!1))},l=()=>{I?u():r()},x=t=>{P?.(),Y(t)},b=t=>{i(t),f(!0)},_=()=>{h&&Ce(h),f(!1),i(null)},N=t=>{const c=/\[([^\]]+)\]\(([^)]+)\)/g,s=[];let j=0,a,g=0;for(;(a=c.exec(t))!==null;){a.index>j&&s.push(e.jsx("span",{children:t.slice(j,a.index)},g++));const C=a[1],k=a[2];if(k.startsWith("/"))s.push(e.jsx("button",{onClick:()=>x(k),className:"text-primary hover:underline font-medium cursor-pointer",children:C},g++));else if(k.startsWith("!external:")){const re=k.slice(10);s.push(e.jsx("button",{onClick:()=>b(re),className:"text-primary hover:underline font-medium cursor-pointer",children:C},g++))}else k.startsWith("http://")||k.startsWith("https://")?s.push(e.jsx("button",{onClick:()=>b(k),className:"text-primary hover:underline font-medium cursor-pointer",children:C},g++)):s.push(e.jsx("a",{href:k,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline font-medium",children:C},g++));j=a.index+a[0].length}return j<t.length&&s.push(e.jsx("span",{children:t.slice(j)},g++)),s.length>0?s:[e.jsx("span",{children:t},"0")]},B=t=>t.replace(/\*\*(.*?)\*\*/g,"$1"),E=(t,c=20)=>t.length<=c?t:t.slice(0,c)+"...",H=(t,c)=>{const s=g=>g.split("|").slice(1,-1).map(C=>B(C.trim())),j=s(t[0]),a=t.slice(2).map(s);return e.jsx("div",{className:"overflow-x-auto my-2 max-w-full",children:e.jsxs("table",{className:"w-full text-xs border border-border rounded-md overflow-hidden table-fixed",children:[e.jsx("thead",{className:"bg-muted/60",children:e.jsx("tr",{children:j.map((g,C)=>e.jsx("th",{className:"px-2 py-2 text-left font-semibold border-b border-border truncate max-w-[100px]",title:g,children:N(E(g,15))},C))})}),e.jsx("tbody",{children:a.map((g,C)=>e.jsx("tr",{className:"border-b border-border last:border-0 hover:bg-muted/30 transition-colors",children:g.map((k,re)=>e.jsx("td",{className:"px-2 py-2 truncate max-w-[100px]",title:k,children:N(E(k,18))},re))},C))})]})},c)},ue=t=>{const c=t.split(`
`),s=[];let j=0;for(;j<c.length;){const a=c[j];if(a.trim().startsWith("|")&&a.split("|").length>2){const g=[];for(;j<c.length&&c[j].trim().startsWith("|");)g.push(c[j]),j++;g.length>=2&&s.push(H(g,s.length));continue}if(a.startsWith("### "))s.push(e.jsx("h3",{className:"text-base font-semibold mt-3 mb-1",children:N(a.slice(4))},s.length));else if(a.startsWith("## "))s.push(e.jsx("h2",{className:"text-lg font-bold mt-4 mb-2",children:N(a.slice(3))},s.length));else if(a.startsWith("# "))s.push(e.jsx("h1",{className:"text-xl font-bold mt-4 mb-2",children:N(a.slice(2))},s.length));else if(a.includes("**")){const g=a.split(/\*\*(.*?)\*\*/g);s.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:g.map((C,k)=>k%2===1?e.jsx("strong",{className:"font-semibold",children:N(C)},k):N(C))},s.length))}else a.startsWith("- ")||a.startsWith("* ")?s.push(e.jsx("li",{className:"ml-4 mb-0.5 list-disc",children:N(a.slice(2))},s.length)):/^\d+\.\s/.test(a)?s.push(e.jsx("li",{className:"ml-4 mb-0.5 list-decimal",children:N(a.replace(/^\d+\.\s/,""))},s.length)):a.match(/^[-*_]{3,}$/)?s.push(e.jsx("hr",{className:"my-3 border-border"},s.length)):a.trim()===""?s.push(e.jsx("div",{className:"h-1"},s.length)):s.push(e.jsx("p",{className:"mb-1 leading-relaxed",children:N(a)},s.length));j++}return s},he=()=>v.language==="zh"?"小熊AI助手":v.language==="pt"?"Assistente IA Xiaoxiong":"Xiaoxiong AI Assistant",me=()=>v.language==="zh"?"告诉小熊，你想吃什么...":v.language==="pt"?"Diga ao Xiaoxiong o que você quer comer...":"Tell Xiaoxiong what you want to eat...",ge=()=>v.language==="zh"?"你好，我是小熊，我来帮你推荐餐厅；比如：「我附近的寿司餐厅」":v.language==="pt"?"Olá, eu sou o Xiaoxiong, vou te ajudar a encontrar restaurantes; por exemplo: 「restaurantes de sushi perto de mim」":`Hi, I'm Xiaoxiong, I'll help you find restaurants; for example: "sushi restaurants near me"`;return e.jsxs("div",{className:G("flex flex-col h-full bg-background overflow-hidden",A),children:[V&&e.jsxs("div",{className:"px-4 py-3 shrink-0 border-b flex items-center gap-2 bg-background sticky top-0 z-10",children:[W&&e.jsx(ie,{variant:"ghost",size:"icon",onClick:P,className:"shrink-0",children:e.jsx(pe,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[z&&e.jsx("img",{src:z,alt:"Logo",className:"w-8 h-8 rounded-full object-cover"}),e.jsx("h1",{className:"text-base font-semibold",children:he()})]})]}),e.jsx(Se,{className:"flex-1 min-h-0 overflow-auto",ref:y,children:e.jsxs("div",{className:"p-4 space-y-4",children:[w.length===0&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:z&&e.jsx("img",{src:z,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:"flex-1 bg-muted rounded-lg px-3 py-2 text-sm",children:ge()})]}),w.map(t=>e.jsxs("div",{className:G("flex gap-3",t.role==="user"&&"flex-row-reverse"),children:[t.role==="user"?e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:Z?e.jsx("img",{src:Z,alt:"User",className:"w-full h-full object-cover"}):e.jsx(xe,{className:"h-4 w-4"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0 overflow-hidden",children:z&&e.jsx("img",{src:z,alt:"Xiaoxiong",className:"w-full h-full object-cover"})}),e.jsx("div",{className:G("flex-1 max-w-[85%] rounded-lg px-3 py-2 text-sm bg-muted"),children:t.role==="assistant"?e.jsxs(e.Fragment,{children:[t.content?e.jsx("div",{className:"prose-sm",children:ue(t.content)}):e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(le,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:v.language==="zh"?"思考中...":v.language==="pt"?"Pensando...":"Thinking..."})]}),t.isStreaming&&t.content&&e.jsx("span",{className:"inline-block w-1.5 h-4 bg-primary/50 animate-pulse ml-0.5 align-middle"})]}):t.content})]},t.id)),e.jsx("div",{ref:m})]})}),e.jsx("div",{className:"px-2 py-1.5 pb-[max(1.5rem,calc(env(safe-area-inset-bottom)+1rem))] md:pb-4 shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 rounded-full backdrop-blur-md border border-border/50 bg-muted/80 dark:bg-muted/60",children:[p()&&e.jsx(ie,{variant:"ghost",size:"icon",onClick:l,disabled:O,className:G("bg-transparent hover:bg-transparent",I&&"text-destructive"),children:I?e.jsx(we,{className:"h-4 w-4"}):e.jsx(be,{className:"h-4 w-4"})}),e.jsx(ve,{value:R,onChange:t=>T(t.target.value),onKeyDown:F,placeholder:I?v.language==="zh"?"正在聆听...":"Listening...":me(),disabled:O,className:"flex-1 bg-transparent border-0 shadow-none focus-visible:ring-0 focus-visible:ring-offset-0"}),e.jsx(ie,{onClick:$,disabled:!R.trim()||O,size:"icon",variant:"ghost",className:"bg-transparent hover:bg-white/50 rounded-full",children:O?e.jsx(le,{className:"h-4 w-4 animate-spin"}):e.jsx(je,{className:"h-4 w-4"})})]})}),e.jsx(Re,{open:U,onOpenChange:t=>{X(t),!t&&S&&(K(S),ee(null))},onConfirm:L}),e.jsx(Ae,{open:n,onOpenChange:f,onConfirm:_,url:h||void 0})]})};export{Be as X,ze as u};
//# sourceMappingURL=XiaoxiongChatContent-coNISpga.js.map
