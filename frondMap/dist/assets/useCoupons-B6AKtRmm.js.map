{"version":3,"file":"useCoupons-B6AKtRmm.js","sources":["../../src/hooks/useCoupons.ts"],"sourcesContent":["import { useEffect } from \"react\";\r\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport i18n from \"@/i18n/config\";\r\n\r\n// 优惠券模板\r\nexport interface CouponTemplate {\r\n  id: string;\r\n  activity_id: string | null; // 通用分享优惠券可以不关联活动\r\n  title_zh: string;\r\n  title_en: string;\r\n  title_pt: string;\r\n  description_zh?: string | null;\r\n  description_en?: string | null;\r\n  description_pt?: string | null;\r\n  discount_type: \"percentage\" | \"fixed_amount\";\r\n  discount_value: number;\r\n  min_order_amount?: number | null;\r\n  max_discount_amount?: number | null;\r\n  valid_from: string;\r\n  valid_until?: string | null;\r\n  is_active: boolean;\r\n  visible: boolean;\r\n  auto_link_activities: boolean;\r\n  refresh_mode?: \"none\" | \"weekly\" | \"monthly\" | \"yearly\" | null;\r\n  duration_days?: number | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\n// 子优惠券\r\nexport interface CouponCode {\r\n  id: string;\r\n  template_id: string;\r\n  code: string;\r\n  usage_limit: number;\r\n  used_count: number;\r\n  is_active: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n  coupon_templates?: CouponTemplate;\r\n}\r\n\r\n// 用户领取记录\r\nexport interface UserCoupon {\r\n  id: string;\r\n  user_id: string;\r\n  coupon_code_id: string;\r\n  activity_id: string | null; // 通用分享优惠券可以不关联活动\r\n  source: string;\r\n  claimed_at: string;\r\n  used_at?: string | null;\r\n  restaurant_id?: string | null;\r\n  notes?: string | null;\r\n  created_at: string;\r\n  coupon_codes?: CouponCode;\r\n}\r\n\r\n// 获取所有优惠券模板（管理员）\r\nexport const useCouponTemplates = () => {\r\n  return useQuery({\r\n    queryKey: [\"couponTemplates\"],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_templates\")\r\n        .select(\"*\")\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data as CouponTemplate[];\r\n    },\r\n  });\r\n};\r\n\r\n// 获取单个优惠券模板\r\nexport const useCouponTemplate = (id: string) => {\r\n  return useQuery({\r\n    queryKey: [\"couponTemplate\", id],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_templates\")\r\n        .select(\"*\")\r\n        .eq(\"id\", id)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data as CouponTemplate;\r\n    },\r\n    enabled: !!id,\r\n  });\r\n};\r\n\r\n// 获取模板的所有子优惠券（管理员）\r\nexport const useTemplateCouponCodes = (templateId: string) => {\r\n  return useQuery({\r\n    queryKey: [\"templateCouponCodes\", templateId],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_codes\")\r\n        .select(\"*\")\r\n        .eq(\"template_id\", templateId)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data as CouponCode[];\r\n    },\r\n    enabled: !!templateId,\r\n  });\r\n};\r\n\r\n// 获取单个子优惠券的所有用户领取记录（管理员）\r\nexport const useCouponCodeUsers = (codeId: string) => {\r\n  return useQuery({\r\n    queryKey: [\"couponCodeUsers\", codeId],\r\n    queryFn: async () => {\r\n      // 首先获取用户优惠券记录\r\n      const { data: userCoupons, error } = await supabase\r\n        .from(\"user_coupons\")\r\n        .select(\"*\")\r\n        .eq(\"coupon_code_id\", codeId)\r\n        .order(\"claimed_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      if (!userCoupons || userCoupons.length === 0) return [];\r\n\r\n      // 获取有 user_id 的用户 profile 信息\r\n      const userIds = userCoupons.filter(uc => uc.user_id).map(uc => uc.user_id);\r\n      \r\n      let profilesMap: Record<string, { display_name: string; avatar_url: string | null }> = {};\r\n      \r\n      if (userIds.length > 0) {\r\n        // Use secure function to get only public profile data\r\n        const { data: profiles } = await supabase\r\n          .rpc(\"get_public_profiles\", { user_ids: userIds });\r\n        \r\n        if (profiles) {\r\n          profilesMap = profiles.reduce((acc: Record<string, { display_name: string; avatar_url: string | null }>, p: { id: string; display_name: string; avatar_url: string }) => {\r\n            acc[p.id] = { display_name: p.display_name, avatar_url: p.avatar_url };\r\n            return acc;\r\n          }, {} as Record<string, { display_name: string; avatar_url: string | null }>);\r\n        }\r\n      }\r\n\r\n      // 合并 profile 信息\r\n      return userCoupons.map(uc => ({\r\n        ...uc,\r\n        profiles: uc.user_id ? profilesMap[uc.user_id] || null : null\r\n      }));\r\n    },\r\n    enabled: !!codeId,\r\n  });\r\n};\r\n\r\n// 获取用户已领取的优惠券 - 带实时更新\r\nexport const useUserCoupons = () => {\r\n  const { user } = useAuth();\r\n  const queryClient = useQueryClient();\r\n\r\n  // 实时监听优惠券状态变化\r\n  useEffect(() => {\r\n    if (!user) return;\r\n\r\n    const channel = supabase\r\n      .channel('user-coupons-changes')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'user_coupons',\r\n          filter: `user_id=eq.${user.id}`\r\n        },\r\n        () => {\r\n          // 当优惠券状态变化时刷新数据\r\n          queryClient.invalidateQueries({ queryKey: [\"userCoupons\", user.id] });\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [user, queryClient]);\r\n\r\n  return useQuery({\r\n    queryKey: [\"userCoupons\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"user_coupons\")\r\n        .select(`\r\n          *,\r\n          coupon_codes (\r\n            *,\r\n            coupon_templates (*)\r\n          )\r\n        `)\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"claimed_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data as UserCoupon[];\r\n    },\r\n    enabled: !!user,\r\n    staleTime: 1000 * 30, // 30秒内不会重新获取\r\n    gcTime: 1000 * 60 * 5, // 5分钟缓存\r\n  });\r\n};\r\n\r\n// 获取活动的可用优惠券模板（通过多对多关系表）\r\nexport const useActivityCouponTemplates = (activityId: string) => {\r\n  return useQuery({\r\n    queryKey: [\"activityCouponTemplates\", activityId],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_template_activities\")\r\n        .select(`\r\n          coupon_templates (*)\r\n        `)\r\n        .eq(\"activity_id\", activityId);\r\n\r\n      if (error) throw error;\r\n      \r\n      // 过滤活跃且可见的优惠券模板\r\n      const templates = (data || [])\r\n        .map(item => item.coupon_templates)\r\n        .filter(template => template && template.is_active && template.visible) as CouponTemplate[];\r\n      \r\n      return templates;\r\n    },\r\n    enabled: !!activityId,\r\n  });\r\n};\r\n\r\n// 检查用户是否已通过分享获得该活动的优惠券\r\nexport const useHasSharedCoupon = (activityId: string) => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"hasSharedCoupon\", activityId, user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return false;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"user_coupons\")\r\n        .select(\"id\")\r\n        .eq(\"user_id\", user.id)\r\n        .eq(\"activity_id\", activityId)\r\n        .eq(\"source\", \"share\")\r\n        .maybeSingle();\r\n\r\n      if (error) throw error;\r\n      return !!data;\r\n    },\r\n    enabled: !!user && !!activityId,\r\n  });\r\n};\r\n\r\n// 获取通用分享优惠券模板（不关联活动）\r\nexport const useGlobalShareCouponTemplate = () => {\r\n  return useQuery({\r\n    queryKey: [\"globalShareCouponTemplate\"],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_templates\")\r\n        .select(\"*\")\r\n        .is(\"activity_id\", null)\r\n        .eq(\"is_active\", true)\r\n        .maybeSingle();\r\n\r\n      if (error) throw error;\r\n      return data as CouponTemplate | null;\r\n    },\r\n  });\r\n};\r\n\r\n// 根据优惠券代码查询优惠券详情（merchant、supervisor、admin使用）\r\nexport const useQueryCouponByCode = (code: string) => {\r\n  return useQuery({\r\n    queryKey: [\"queryCouponByCode\", code],\r\n    queryFn: async () => {\r\n      if (!code) return null;\r\n\r\n      // 首先查询优惠券基础信息\r\n      const { data: couponData, error: couponError } = await supabase\r\n        .from(\"coupon_codes\")\r\n        .select(`\r\n          *,\r\n          coupon_templates (*),\r\n          user_coupons (\r\n            id,\r\n            user_id,\r\n            claimed_at,\r\n            used_at,\r\n            source,\r\n            claimed_email\r\n          )\r\n        `)\r\n        .eq(\"code\", code.trim().toUpperCase())\r\n        .maybeSingle();\r\n\r\n      if (couponError) throw couponError;\r\n      if (!couponData) return null;\r\n\r\n      // 获取所有有 user_id 的用户信息\r\n      const userIds = couponData.user_coupons\r\n        ?.filter((uc: any) => uc.user_id)\r\n        .map((uc: any) => uc.user_id) || [];\r\n\r\n      let profilesMap: Record<string, { display_name: string }> = {};\r\n      \r\n      if (userIds.length > 0) {\r\n        // Use secure function to get only public profile data\r\n        const { data: profiles } = await supabase\r\n          .rpc(\"get_public_profiles\", { user_ids: userIds });\r\n        \r\n        if (profiles) {\r\n          profilesMap = profiles.reduce((acc: Record<string, { display_name: string }>, p: { id: string; display_name: string }) => {\r\n            acc[p.id] = { display_name: p.display_name };\r\n            return acc;\r\n          }, {} as Record<string, { display_name: string }>);\r\n        }\r\n      }\r\n\r\n      // 将 profile 信息合并到 user_coupons\r\n      const userCouponsWithProfiles = couponData.user_coupons?.map((uc: any) => ({\r\n        ...uc,\r\n        profiles: uc.user_id ? profilesMap[uc.user_id] || null : null\r\n      })) || [];\r\n\r\n      return {\r\n        ...couponData,\r\n        user_coupons: userCouponsWithProfiles\r\n      };\r\n    },\r\n    enabled: !!code && code.trim().length > 0,\r\n  });\r\n};\r\n\r\n// 生成并领取优惠券（用户分享时调用）\r\nexport const useClaimCouponFromTemplate = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      templateId,\r\n      activityId,\r\n      source = \"share\",\r\n    }: {\r\n      templateId: string;\r\n      activityId?: string | null; // 通用分享优惠券可以不关联活动\r\n      source?: \"claim\" | \"share\";\r\n    }) => {\r\n      if (!user) throw new Error(\"User not authenticated\");\r\n\r\n      // 获取用户邮箱用于防刷券检查\r\n      const userEmail = user.email;\r\n\r\n      // 检查该邮箱是否已通过分享领取过同一活动的优惠券（防止删号重注册刷券）\r\n      if (source === \"share\" && userEmail && activityId) {\r\n        const { data: existingCoupon } = await supabase\r\n          .from(\"user_coupons\")\r\n          .select(\"id\")\r\n          .eq(\"claimed_email\", userEmail)\r\n          .eq(\"activity_id\", activityId)\r\n          .eq(\"source\", \"share\")\r\n          .maybeSingle();\r\n\r\n        if (existingCoupon) {\r\n          throw new Error(\"EMAIL_ALREADY_CLAIMED\");\r\n        }\r\n      }\r\n\r\n      // 1. 生成优惠码\r\n      const { data: codeData, error: codeError } = await supabase.rpc(\r\n        \"generate_coupon_code\",\r\n        { template_id_param: templateId }\r\n      );\r\n\r\n      if (codeError) throw codeError;\r\n      const generatedCode = codeData as string;\r\n\r\n      // 2. 创建子优惠券\r\n      const { data: couponCodeData, error: couponCodeError } = await supabase\r\n        .from(\"coupon_codes\")\r\n        .insert({\r\n          template_id: templateId,\r\n          code: generatedCode,\r\n          usage_limit: 1,\r\n          used_count: 0,\r\n          is_active: true,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (couponCodeError) throw couponCodeError;\r\n\r\n      // 3. 创建用户领取记录（包含邮箱用于防刷券）\r\n      const { data: userCouponData, error: userCouponError } = await supabase\r\n        .from(\"user_coupons\")\r\n        .insert({\r\n          user_id: user.id,\r\n          coupon_code_id: couponCodeData.id,\r\n          activity_id: activityId || null,\r\n          source,\r\n          claimed_email: userEmail || null, // 记录邮箱用于防刷券\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (userCouponError) throw userCouponError;\r\n\r\n      return { userCoupon: userCouponData, couponCode: couponCodeData };\r\n    },\r\n    onSuccess: (_, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: [\"userCoupons\"] });\r\n      if (variables.activityId) {\r\n        queryClient.invalidateQueries({\r\n          queryKey: [\"hasSharedCoupon\", variables.activityId],\r\n        });\r\n      }\r\n      toast({\r\n        title: i18n.t(\"coupon.claimSuccess\"),\r\n        description: i18n.t(\"coupon.claimSuccessDescription\"),\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      // 检查是否是重复领取的错误（包括邮箱重复领取）\r\n      const isDuplicateError = error?.message?.includes('user_coupons_share_once_per_activity') || \r\n                               error?.message?.includes('idx_user_coupons_email') ||\r\n                               error?.message === 'EMAIL_ALREADY_CLAIMED' ||\r\n                               error?.code === '23505';\r\n      \r\n      // 如果是邮箱重复领取，显示特定提示\r\n      if (error?.message === 'EMAIL_ALREADY_CLAIMED') {\r\n        toast({\r\n          title: i18n.t(\"coupon.alreadyClaimed\"),\r\n          description: i18n.t(\"coupon.emailAlreadyClaimed\"),\r\n          variant: \"destructive\",\r\n        });\r\n        return;\r\n      }\r\n      \r\n      // 只有非重复领取的错误才显示提示\r\n      if (!isDuplicateError) {\r\n        toast({\r\n          title: i18n.t(\"common.error\"),\r\n          description: error.message || \"领取失败\",\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    },\r\n  });\r\n};\r\n\r\n// 使用优惠券\r\nexport const useUseCoupon = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      userCouponId,\r\n      restaurantId,\r\n      notes,\r\n    }: {\r\n      userCouponId: string;\r\n      restaurantId?: string;\r\n      notes?: string;\r\n    }) => {\r\n      const { data, error } = await supabase\r\n        .from(\"user_coupons\")\r\n        .update({\r\n          used_at: new Date().toISOString(),\r\n          restaurant_id: restaurantId || null,\r\n          notes: notes || null,\r\n        })\r\n        .eq(\"id\", userCouponId)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"userCoupons\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"优惠券已使用\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 管理员：创建/更新优惠券模板\r\nexport const useSaveCouponTemplate = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (template: Partial<CouponTemplate>) => {\r\n      if (template.id) {\r\n        // 更新\r\n        const { id, created_at, updated_at, ...updateData } = template;\r\n        const { data, error } = await supabase\r\n          .from(\"coupon_templates\")\r\n          .update(updateData as any)\r\n          .eq(\"id\", id)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        return data;\r\n      } else {\r\n        // 创建\r\n        const { id, created_at, updated_at, ...insertData } = template;\r\n        const { data, error } = await supabase\r\n          .from(\"coupon_templates\")\r\n          .insert(insertData as any)\r\n          .select()\r\n          .single();\r\n\r\n        if (error) throw error;\r\n        return data;\r\n      }\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"couponTemplates\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"优惠券模板保存成功\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 管理员：删除优惠券模板\r\nexport const useDeleteCouponTemplate = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (templateId: string) => {\r\n      const { error } = await supabase\r\n        .from(\"coupon_templates\")\r\n        .delete()\r\n        .eq(\"id\", templateId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"couponTemplates\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"优惠券模板删除成功\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 管理员：删除用户优惠券记录\r\nexport const useDeleteUserCoupon = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (userCouponId: string) => {\r\n      const { error } = await supabase\r\n        .from(\"user_coupons\")\r\n        .delete()\r\n        .eq(\"id\", userCouponId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"couponCodeUsers\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"优惠券记录删除成功\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 管理员：更新用户优惠券记录\r\nexport const useUpdateUserCoupon = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ \r\n      id, \r\n      updates \r\n    }: { \r\n      id: string; \r\n      updates: Partial<UserCoupon> \r\n    }) => {\r\n      const { error } = await supabase\r\n        .from(\"user_coupons\")\r\n        .update(updates)\r\n        .eq(\"id\", id);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"couponCodeUsers\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"优惠券记录更新成功\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 获取优惠券模板关联的活动列表\r\nexport const useTemplateActivities = (templateId: string) => {\r\n  return useQuery({\r\n    queryKey: [\"templateActivities\", templateId],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_template_activities\")\r\n        .select(`\r\n          activity_id,\r\n          activities (\r\n            id,\r\n            title_zh,\r\n            title_en,\r\n            title_pt,\r\n            start_date,\r\n            end_date,\r\n            visible\r\n          )\r\n        `)\r\n        .eq(\"coupon_template_id\", templateId);\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    },\r\n    enabled: !!templateId,\r\n  });\r\n};\r\n\r\n// 添加优惠券模板和活动的关联\r\nexport const useAddTemplateActivity = () => {\r\n  const queryClient = useQueryClient();\r\n  const { toast } = useToast();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ \r\n      templateId, \r\n      activityId \r\n    }: { \r\n      templateId: string; \r\n      activityId: string;\r\n    }) => {\r\n      const { error } = await supabase\r\n        .from(\"coupon_template_activities\")\r\n        .insert({\r\n          coupon_template_id: templateId,\r\n          activity_id: activityId,\r\n        });\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: (_, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: [\"templateActivities\", variables.templateId] });\r\n      queryClient.invalidateQueries({ queryKey: [\"activityCouponTemplates\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"活动关联添加成功\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 删除优惠券模板和活动的关联\r\nexport const useRemoveTemplateActivity = () => {\r\n  const queryClient = useQueryClient();\r\n  const { toast } = useToast();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ \r\n      templateId, \r\n      activityId \r\n    }: { \r\n      templateId: string; \r\n      activityId: string;\r\n    }) => {\r\n      const { error } = await supabase\r\n        .from(\"coupon_template_activities\")\r\n        .delete()\r\n        .eq(\"coupon_template_id\", templateId)\r\n        .eq(\"activity_id\", activityId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: (_, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: [\"templateActivities\", variables.templateId] });\r\n      queryClient.invalidateQueries({ queryKey: [\"activityCouponTemplates\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"活动关联移除成功\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 获取优惠券使用历史记录\r\nexport interface CouponUsageHistory {\r\n  id: string;\r\n  user_coupon_id: string | null;\r\n  coupon_code_id: string;\r\n  used_by_user_id: string;\r\n  restaurant_id: string | null;\r\n  used_at: string;\r\n  notes: string | null;\r\n  created_at: string;\r\n  used_by_profile?: {\r\n    display_name: string;\r\n    avatar_url: string | null;\r\n  };\r\n  restaurant?: {\r\n    name: string;\r\n    name_en: string | null;\r\n    name_pt: string | null;\r\n  };\r\n}\r\n\r\nexport const useCouponUsageHistory = (couponCodeId: string) => {\r\n  return useQuery({\r\n    queryKey: [\"couponUsageHistory\", couponCodeId],\r\n    queryFn: async () => {\r\n      if (!couponCodeId) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_usage_history\")\r\n        .select(\"*\")\r\n        .eq(\"coupon_code_id\", couponCodeId)\r\n        .order(\"used_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      if (!data || data.length === 0) return [];\r\n\r\n      // 获取核销人信息\r\n      const userIds = [...new Set(data.map(h => h.used_by_user_id))];\r\n      const { data: profiles } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, display_name, avatar_url\")\r\n        .in(\"id\", userIds);\r\n\r\n      const profilesMap = (profiles || []).reduce((acc, p) => {\r\n        acc[p.id] = { display_name: p.display_name, avatar_url: p.avatar_url };\r\n        return acc;\r\n      }, {} as Record<string, { display_name: string; avatar_url: string | null }>);\r\n\r\n      // 获取餐厅信息\r\n      const restaurantIds = [...new Set(data.filter(h => h.restaurant_id).map(h => h.restaurant_id as string))];\r\n      let restaurantsMap: Record<string, { name: string; name_en: string | null; name_pt: string | null }> = {};\r\n      \r\n      if (restaurantIds.length > 0) {\r\n        const { data: restaurants } = await supabase\r\n          .from(\"restaurants\")\r\n          .select(\"id, name, name_en, name_pt\")\r\n          .in(\"id\", restaurantIds);\r\n        \r\n        restaurantsMap = (restaurants || []).reduce((acc, r) => {\r\n          acc[r.id] = { name: r.name, name_en: r.name_en, name_pt: r.name_pt };\r\n          return acc;\r\n        }, {} as Record<string, { name: string; name_en: string | null; name_pt: string | null }>);\r\n      }\r\n\r\n      return data.map(h => ({\r\n        ...h,\r\n        used_by_profile: profilesMap[h.used_by_user_id] || null,\r\n        restaurant: h.restaurant_id ? restaurantsMap[h.restaurant_id] || null : null,\r\n      })) as CouponUsageHistory[];\r\n    },\r\n    enabled: !!couponCodeId,\r\n  });\r\n};\r\n\r\n// 获取模板下所有子优惠券的使用历史\r\nexport const useTemplateUsageHistory = (templateId: string) => {\r\n  return useQuery({\r\n    queryKey: [\"templateUsageHistory\", templateId],\r\n    queryFn: async () => {\r\n      if (!templateId) return [];\r\n\r\n      // 先获取该模板下的所有 coupon_code_id\r\n      const { data: codes, error: codesError } = await supabase\r\n        .from(\"coupon_codes\")\r\n        .select(\"id\")\r\n        .eq(\"template_id\", templateId);\r\n\r\n      if (codesError) throw codesError;\r\n      if (!codes || codes.length === 0) return [];\r\n\r\n      const codeIds = codes.map(c => c.id);\r\n\r\n      // 获取使用历史\r\n      const { data, error } = await supabase\r\n        .from(\"coupon_usage_history\")\r\n        .select(\"*\")\r\n        .in(\"coupon_code_id\", codeIds)\r\n        .order(\"used_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      if (!data || data.length === 0) return [];\r\n\r\n      // 获取核销人信息\r\n      const userIds = [...new Set(data.map(h => h.used_by_user_id))];\r\n      const { data: profiles } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, display_name, avatar_url\")\r\n        .in(\"id\", userIds);\r\n\r\n      const profilesMap = (profiles || []).reduce((acc, p) => {\r\n        acc[p.id] = { display_name: p.display_name, avatar_url: p.avatar_url };\r\n        return acc;\r\n      }, {} as Record<string, { display_name: string; avatar_url: string | null }>);\r\n\r\n      // 获取餐厅信息\r\n      const restaurantIds = [...new Set(data.filter(h => h.restaurant_id).map(h => h.restaurant_id as string))];\r\n      let restaurantsMap: Record<string, { name: string; name_en: string | null; name_pt: string | null }> = {};\r\n      \r\n      if (restaurantIds.length > 0) {\r\n        const { data: restaurants } = await supabase\r\n          .from(\"restaurants\")\r\n          .select(\"id, name, name_en, name_pt\")\r\n          .in(\"id\", restaurantIds);\r\n        \r\n        restaurantsMap = (restaurants || []).reduce((acc, r) => {\r\n          acc[r.id] = { name: r.name, name_en: r.name_en, name_pt: r.name_pt };\r\n          return acc;\r\n        }, {} as Record<string, { name: string; name_en: string | null; name_pt: string | null }>);\r\n      }\r\n\r\n      // 获取优惠码信息\r\n      const { data: codesInfo } = await supabase\r\n        .from(\"coupon_codes\")\r\n        .select(\"id, code\")\r\n        .in(\"id\", codeIds);\r\n\r\n      const codesMap = (codesInfo || []).reduce((acc, c) => {\r\n        acc[c.id] = c.code;\r\n        return acc;\r\n      }, {} as Record<string, string>);\r\n\r\n      return data.map(h => ({\r\n        ...h,\r\n        used_by_profile: profilesMap[h.used_by_user_id] || null,\r\n        restaurant: h.restaurant_id ? restaurantsMap[h.restaurant_id] || null : null,\r\n        coupon_code: codesMap[h.coupon_code_id] || null,\r\n      }));\r\n    },\r\n    enabled: !!templateId,\r\n  });\r\n};\r\n"],"names":["useCouponTemplates","useQuery","data","error","supabase","useUserCoupons","user","useAuth","queryClient","useQueryClient","useEffect","channel","useActivityCouponTemplates","activityId","item","template","useHasSharedCoupon","useGlobalShareCouponTemplate","useQueryCouponByCode","code","couponData","couponError","userIds","uc","profilesMap","profiles","acc","p","userCouponsWithProfiles","useClaimCouponFromTemplate","toast","useToast","useMutation","templateId","source","userEmail","existingCoupon","codeData","codeError","generatedCode","couponCodeData","couponCodeError","userCouponData","userCouponError","_","variables","i18n","isDuplicateError","useSaveCouponTemplate","id","created_at","updated_at","updateData","insertData","useDeleteCouponTemplate","useTemplateActivities","useAddTemplateActivity","useRemoveTemplateActivity","useTemplateUsageHistory","codes","codesError","codeIds","c","h","restaurantIds","restaurantsMap","restaurants","r","codesInfo","codesMap"],"mappings":"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"}