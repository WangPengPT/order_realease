import{u as te,r as u,y as d,j as e,D as ae,d as re,e as M,B as ne,f as B,a9 as T,S as ie,n as f,a6 as ce,a7 as le,a8 as de,x as w,as as oe,P as me,k as xe,aM as E,C as p,p as j,F as N,aw as ue,M as he,m as ge,i as _,av as U}from"./index-tBrG_sQo.js";import{S as F}from"./separator-Bhf_yabo.js";import{u as fe}from"./useLocalizedContent-C8cRpYbI.js";import{A as pe}from"./arrow-left-BRevGK83.js";import{C as je}from"./clock-CfDFVEuU.js";import{H}from"./heart-D_Hvwpsh.js";import{S as y}from"./star-DGUzKXpx.js";import{U as Ne}from"./users-CKOtRTM7.js";import{B as ve}from"./briefcase-zV3Ca8Ih.js";import{E as k}from"./external-link-DPrEJ_xT.js";function Ae({open:D,onOpenChange:O,userId:i,userName:_e,userRole:v}){const{t:a}=te(),{getLocalizedField:o}=fe(),[V,L]=u.useState(!0),[c,G]=u.useState(null),[J,K]=u.useState(null),[r,Q]=u.useState({favoriteRestaurants:0,favoriteActivities:0,comments:0,ratings:0,addresses:0,restaurants:0}),[C,S]=u.useState(null),[x,m]=u.useState([]),[W,P]=u.useState(!1);u.useEffect(()=>{D&&i&&X()},[D,i]);const X=async()=>{var s;L(!0);try{const{data:t,error:l}=await d.from("profiles").select("*").eq("id",i).maybeSingle();if(l)throw l;G(t);try{const{data:g}=await d.functions.invoke("get-user-emails",{body:{userIds:[i]}});(s=g==null?void 0:g.emails)!=null&&s[i]&&K(g.emails[i])}catch(g){console.error("Error fetching email:",g)}const[b,R,$,q,A,n]=await Promise.all([d.from("favorites").select("id",{count:"exact",head:!0}).eq("user_id",i),d.from("subscriptions").select("id",{count:"exact",head:!0}).eq("user_id",i),d.from("comments").select("id",{count:"exact",head:!0}).eq("user_id",i),d.from("ratings").select("id",{count:"exact",head:!0}).eq("user_id",i),d.from("user_addresses").select("id",{count:"exact",head:!0}).eq("user_id",i),d.from("merchant_restaurants").select("id",{count:"exact",head:!0}).eq("user_id",i)]);Q({favoriteRestaurants:b.count||0,favoriteActivities:R.count||0,comments:$.count||0,ratings:q.count||0,addresses:A.count||0,restaurants:n.count||0})}catch(t){console.error("Error fetching user profile:",t)}finally{L(!1)}},h=async s=>{if(s){P(!0),S(s);try{switch(s){case"restaurants":{const{data:t}=await d.from("favorites").select("created_at, restaurants(id, name, name_en, name_pt, image_url, rating, type, type_en, type_pt)").eq("user_id",i).order("created_at",{ascending:!1});m((t==null?void 0:t.map(l=>({...l.restaurants,favorited_at:l.created_at})))||[]);break}case"activities":{const{data:t}=await d.from("subscriptions").select("created_at, activities(id, title_zh, title_en, title_pt, image_url, start_date, end_date)").eq("user_id",i).order("created_at",{ascending:!1});m((t==null?void 0:t.map(l=>({...l.activities,subscribed_at:l.created_at})))||[]);break}case"comments":{const{data:t}=await d.from("comments").select("id, content, target_type, target_id, rating_value, created_at").eq("user_id",i).order("created_at",{ascending:!1});if(t){const l=t.filter(n=>n.target_type==="restaurant").map(n=>n.target_id),b=t.filter(n=>n.target_type==="activity").map(n=>n.target_id),[R,$]=await Promise.all([l.length>0?d.from("restaurants").select("id, name, name_en, name_pt").in("id",l):{data:[]},b.length>0?d.from("activities").select("id, title_zh, title_en, title_pt").in("id",b):{data:[]}]),q=Object.fromEntries((R.data||[]).map(n=>[n.id,n])),A=Object.fromEntries(($.data||[]).map(n=>[n.id,n]));m(t.map(n=>({...n,target:n.target_type==="restaurant"?q[n.target_id]:A[n.target_id]})))}break}case"ratings":{const{data:t}=await d.from("ratings").select("id, rating_value, price_range, created_at, restaurants(id, name, name_en, name_pt)").eq("user_id",i).order("created_at",{ascending:!1});m((t==null?void 0:t.map(l=>({...l,restaurant:l.restaurants})))||[]);break}case"addresses":{const{data:t}=await d.from("user_addresses").select("*").eq("user_id",i).order("is_default",{ascending:!1});m(t||[]);break}case"managedRestaurants":{const{data:t}=await d.from("merchant_restaurants").select("created_at, restaurants(id, name, name_en, name_pt, image_url, address)").eq("user_id",i).order("created_at",{ascending:!1});m((t==null?void 0:t.map(l=>({...l.restaurants,assigned_at:l.created_at})))||[]);break}}}catch(t){console.error("Error fetching detail data:",t),m([])}finally{P(!1)}}},Y=s=>{switch(s){case"restaurants":return a("admin.restaurantFavorites");case"activities":return a("admin.activityFavorites");case"comments":return a("admin.commentsCount");case"ratings":return a("admin.ratingsCount");case"addresses":return a("admin.addressesCount");case"managedRestaurants":return a("admin.managedRestaurants");default:return""}},Z=s=>{switch(s){case"admin":return"bg-primary text-primary-foreground";case"supervisor":return"bg-blue-500 text-white";case"merchant":return"bg-emerald-500 text-white";default:return"bg-muted text-muted-foreground"}},I=s=>{switch(s){case"admin":return e.jsx(E,{className:"h-3.5 w-3.5"});case"supervisor":return e.jsx(E,{className:"h-3.5 w-3.5"});case"merchant":return e.jsx(ve,{className:"h-3.5 w-3.5"});default:return e.jsx(Ne,{className:"h-3.5 w-3.5"})}},z=s=>s?new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}):"-",ee=s=>{s||(S(null),m([])),O(s)},se=()=>{if(W)return e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(f,{className:"h-16 w-full"},s))});if(x.length===0)return e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("common.noDataFound")});switch(C){case"restaurants":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(_,{to:`/restaurant/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsx("img",{src:s.image_url||"https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=100&q=80",alt:o(s,"name"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:o(s,"type")})]}),s.rating&&e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(y,{className:"h-3.5 w-3.5 fill-yellow-500 text-yellow-500"}),s.rating.toFixed(1)]}),e.jsx(k,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"activities":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(_,{to:`/activity/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:o(s,"title"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(s.start_date).toLocaleDateString(),s.end_date&&` - ${new Date(s.end_date).toLocaleDateString()}`]})]}),e.jsx(k,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});case"comments":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(_,{to:`/${s.target_type}/${s.target_id}`,target:"_blank",className:"block p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{variant:"outline",className:"text-xs",children:s.target_type==="restaurant"?a("common.restaurant"):a("common.activity")}),e.jsx("span",{className:"text-sm font-medium truncate",children:s.target&&(s.target_type==="restaurant"?o(s.target,"name"):o(s.target,"title"))})]}),s.rating_value&&e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(y,{className:"h-3.5 w-3.5 fill-yellow-500 text-yellow-500"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:U(new Date(s.created_at),{addSuffix:!0})})]},s.id))});case"ratings":return e.jsx("div",{className:"space-y-2",children:x.map(s=>{var t;return e.jsxs(_,{to:`/restaurant/${(t=s.restaurant)==null?void 0:t.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s.restaurant,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:U(new Date(s.created_at),{addSuffix:!0})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"h-4 w-4 fill-yellow-500 text-yellow-500"}),e.jsx("span",{className:"font-semibold",children:s.rating_value})]}),e.jsx(k,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id)})});case"addresses":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium",children:s.label}),s.is_default&&e.jsx(w,{variant:"secondary",className:"text-xs",children:a("profile.defaultAddress")})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.street,", ",s.district&&`${s.district}, `,s.city]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.postal_code&&`${s.postal_code}, `,s.country]}),s.phone&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.phone_code," ",s.phone]})]},s.id))});case"managedRestaurants":return e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs(_,{to:`/restaurant/${s.id}`,target:"_blank",className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 transition-colors",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:o(s,"name"),className:"w-12 h-12 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:o(s,"name")}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.address})]}),e.jsx(k,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]},s.id))});default:return null}};return e.jsx(ae,{open:D,onOpenChange:ee,children:e.jsx(re,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:C?e.jsxs(e.Fragment,{children:[e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>{S(null),m([])},children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx(B,{children:Y(C)}),e.jsxs(T,{children:[c==null?void 0:c.display_name," - ",x.length," ",a("common.items")]})]})]})}),e.jsx(ie,{className:"max-h-[60vh] pr-4",children:se()})]}):e.jsxs(e.Fragment,{children:[e.jsxs(M,{children:[e.jsx(B,{children:a("admin.viewProfile")}),e.jsx(T,{children:a("admin.userProfileDetails")})]}),V?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(f,{className:"h-16 w-16 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-5 w-32"}),e.jsx(f,{className:"h-4 w-24"})]})]}),e.jsx(f,{className:"h-20 w-full"}),e.jsx(f,{className:"h-32 w-full"})]}):c?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(ce,{className:"h-16 w-16 border-2 border-primary/20",children:[e.jsx(le,{src:c.avatar_url||"",alt:c.display_name}),e.jsx(de,{className:"text-xl bg-primary/10 text-primary",children:c.display_name.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-xl font-semibold",children:c.display_name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(w,{className:`${Z(v)} gap-1`,children:[I(v),e.jsx("span",{className:"capitalize",children:v})]}),c.is_banned&&e.jsx(w,{variant:"destructive",children:a("admin.banned")})]})]})]}),e.jsx(F,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.contactInfo")}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:J||"-"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:c.phone||"-"})]})]})]}),e.jsx(F,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.accountInfo")}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.registrationTime")}),e.jsx("p",{children:z(c.created_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-muted-foreground text-xs",children:a("admin.languagePreference")}),e.jsx("p",{children:c.language_preference||"en"})]})]})]}),c.activity_terms_agreed&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-emerald-600",children:[e.jsx(E,{className:"h-4 w-4"}),e.jsxs("span",{children:[a("admin.agreedActivityTerms")," (",z(c.activity_terms_agreed_at),")"]})]}),c.is_banned&&c.ban_reason&&e.jsxs("div",{className:"p-3 bg-destructive/10 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-destructive font-medium",children:[a("admin.banReason"),":"]}),e.jsx("p",{className:"text-sm text-destructive/80",children:c.ban_reason})]})]}),e.jsx(F,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:a("admin.userStats")}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(p,{className:`bg-muted/30 transition-colors ${r.favoriteRestaurants>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.favoriteRestaurants>0&&h("restaurants"),children:e.jsxs(j,{className:"p-3 text-center relative",children:[e.jsx(H,{className:"h-4 w-4 mx-auto mb-1 text-red-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.favoriteRestaurants}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.restaurantFavorites")}),r.favoriteRestaurants>0&&e.jsx(N,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(p,{className:`bg-muted/30 transition-colors ${r.favoriteActivities>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.favoriteActivities>0&&h("activities"),children:e.jsxs(j,{className:"p-3 text-center relative",children:[e.jsx(H,{className:"h-4 w-4 mx-auto mb-1 text-primary"}),e.jsx("p",{className:"text-lg font-semibold",children:r.favoriteActivities}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.activityFavorites")}),r.favoriteActivities>0&&e.jsx(N,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(p,{className:`bg-muted/30 transition-colors ${r.comments>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.comments>0&&h("comments"),children:e.jsxs(j,{className:"p-3 text-center relative",children:[e.jsx(ue,{className:"h-4 w-4 mx-auto mb-1 text-blue-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.comments}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.commentsCount")}),r.comments>0&&e.jsx(N,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(p,{className:`bg-muted/30 transition-colors ${r.ratings>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.ratings>0&&h("ratings"),children:e.jsxs(j,{className:"p-3 text-center relative",children:[e.jsx(y,{className:"h-4 w-4 mx-auto mb-1 text-yellow-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.ratings}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.ratingsCount")}),r.ratings>0&&e.jsx(N,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),e.jsx(p,{className:`bg-muted/30 transition-colors ${r.addresses>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.addresses>0&&h("addresses"),children:e.jsxs(j,{className:"p-3 text-center relative",children:[e.jsx(he,{className:"h-4 w-4 mx-auto mb-1 text-emerald-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.addresses}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.addressesCount")}),r.addresses>0&&e.jsx(N,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})}),(v==="merchant"||v==="supervisor")&&e.jsx(p,{className:`bg-muted/30 transition-colors ${r.restaurants>0?"cursor-pointer hover:bg-muted/50":""}`,onClick:()=>r.restaurants>0&&h("managedRestaurants"),children:e.jsxs(j,{className:"p-3 text-center relative",children:[e.jsx(ge,{className:"h-4 w-4 mx-auto mb-1 text-orange-500"}),e.jsx("p",{className:"text-lg font-semibold",children:r.restaurants}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.managedRestaurants")}),r.restaurants>0&&e.jsx(N,{className:"h-3 w-3 absolute top-2 right-2 text-muted-foreground"})]})})]})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("common.noDataFound")})]})})})}export{Ae as U};
