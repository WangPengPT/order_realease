{"version":3,"file":"useActivityParticipation-C62ux2L1.js","sources":["../../src/hooks/useActivityParticipation.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport i18n from \"i18next\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\n\r\n// Get restaurants managed by merchant\r\nexport const useMerchantRestaurants = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"merchantRestaurants\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"merchant_restaurants\")\r\n        .select(`\r\n          restaurant_id,\r\n          restaurants:restaurant_id (\r\n            id,\r\n            name,\r\n            name_en,\r\n            name_pt,\r\n            address,\r\n            image_url,\r\n            lat,\r\n            lng,\r\n            rating,\r\n            type,\r\n            type_en,\r\n            type_pt,\r\n            phone,\r\n            website_url,\r\n            description,\r\n            description_en,\r\n            description_pt,\r\n            opening_hours,\r\n            show_website_button,\r\n            created_at,\r\n            updated_at\r\n          )\r\n        `)\r\n        .eq(\"user_id\", user.id);\r\n\r\n      if (error) throw error;\r\n      return data?.map(mr => mr.restaurants).filter(Boolean) || [];\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\n\r\n// Get participating restaurants for a merchant/supervisor in an activity\r\nexport const useMyParticipatingRestaurants = (activityId: string) => {\r\n  const { user } = useAuth();\r\n  const { data: myRestaurants = [] } = useMerchantRestaurants();\r\n\r\n  return useQuery({\r\n    queryKey: [\"myParticipatingRestaurants\", activityId, user?.id],\r\n    queryFn: async () => {\r\n      if (!user || myRestaurants.length === 0) return [];\r\n\r\n      const restaurantIds = myRestaurants.map(r => r.id);\r\n      \r\n      const { data, error } = await supabase\r\n        .from(\"activity_restaurants\")\r\n        .select(\"restaurant_id\")\r\n        .eq(\"activity_id\", activityId)\r\n        .in(\"restaurant_id\", restaurantIds);\r\n\r\n      if (error) throw error;\r\n      return data?.map(ar => ar.restaurant_id) || [];\r\n    },\r\n    enabled: !!user && !!activityId && myRestaurants.length > 0,\r\n  });\r\n};\r\n\r\n// Check if user has agreed to activity terms\r\nexport const useCheckActivityTermsAgreement = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"activityTermsAgreement\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return false;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"activity_terms_agreed\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (error) return false;\r\n      return data?.activity_terms_agreed || false;\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\n\r\n// Toggle restaurant participation in activity\r\nexport const useToggleRestaurantParticipation = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ \r\n      activityId, \r\n      restaurantId,\r\n      skipTermsCheck = false \r\n    }: { \r\n      activityId: string; \r\n      restaurantId: string;\r\n      skipTermsCheck?: boolean;\r\n    }) => {\r\n      if (!user) throw new Error(\"User not authenticated\");\r\n\r\n      // Check if user has agreed to activity terms before joining (not for leaving)\r\n      if (!skipTermsCheck) {\r\n        const { data: profile } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"activity_terms_agreed\")\r\n          .eq(\"id\", user.id)\r\n          .single();\r\n\r\n        // Check if this is an \"add\" action (not removing)\r\n        const { data: existing } = await supabase\r\n          .from(\"activity_restaurants\")\r\n          .select(\"id\")\r\n          .eq(\"activity_id\", activityId)\r\n          .eq(\"restaurant_id\", restaurantId)\r\n          .maybeSingle();\r\n\r\n        if (!existing && !profile?.activity_terms_agreed) {\r\n          throw new Error(\"TERMS_NOT_AGREED\");\r\n        }\r\n      }\r\n\r\n      // Check if restaurant is already participating\r\n      const { data: existing } = await supabase\r\n        .from(\"activity_restaurants\")\r\n        .select(\"id\")\r\n        .eq(\"activity_id\", activityId)\r\n        .eq(\"restaurant_id\", restaurantId)\r\n        .maybeSingle();\r\n\r\n      if (existing) {\r\n        // Remove participation\r\n        const { error } = await supabase\r\n          .from(\"activity_restaurants\")\r\n          .delete()\r\n          .eq(\"id\", existing.id);\r\n\r\n        if (error) throw error;\r\n        return { action: \"removed\" };\r\n      } else {\r\n        // Add participation\r\n        const { error } = await supabase\r\n          .from(\"activity_restaurants\")\r\n          .insert({\r\n            activity_id: activityId,\r\n            restaurant_id: restaurantId,\r\n          });\r\n\r\n        if (error) throw error;\r\n        return { action: \"added\" };\r\n      }\r\n    },\r\n    onSuccess: (result) => {\r\n      queryClient.invalidateQueries({ queryKey: [\"activityRestaurants\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"myParticipatingRestaurants\"] });\r\n      toast({\r\n        title: i18n.t(result.action === \"added\" ? \"toast.restaurantJoined\" : \"toast.restaurantLeft\"),\r\n        description: i18n.t(result.action === \"added\" ? \"toast.restaurantJoinedDesc\" : \"toast.restaurantLeftDesc\"),\r\n      });\r\n    },\r\n    onError: (error: Error) => {\r\n      if (error.message === \"TERMS_NOT_AGREED\") {\r\n        toast({\r\n          title: i18n.t(\"toast.termsNotAgreed\"),\r\n          description: i18n.t(\"toast.termsNotAgreedDesc\"),\r\n          variant: \"destructive\",\r\n        });\r\n      } else {\r\n        toast({\r\n          title: i18n.t(\"toast.participationUpdateFailed\"),\r\n          description: i18n.t(\"toast.participationUpdateFailedDesc\"),\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    },\r\n  });\r\n};\r\n"],"names":["useMerchantRestaurants","user","useAuth","useQuery","data","error","supabase","mr","useMyParticipatingRestaurants","activityId","myRestaurants","restaurantIds","r","ar","useToggleRestaurantParticipation","toast","useToast","queryClient","useQueryClient","useMutation","restaurantId","skipTermsCheck","profile","existing","result","i18n"],"mappings":"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"}