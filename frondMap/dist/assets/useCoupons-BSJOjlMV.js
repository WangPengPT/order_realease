import{p as _,k as g,ad as f,r as E,s as i,i as v,ae as q,a2 as c}from"./index-CJcx5ZXn.js";const A=()=>_({queryKey:["couponTemplates"],queryFn:async()=>{const{data:e,error:s}=await i.from("coupon_templates").select("*").order("created_at",{ascending:!1});if(s)throw s;return e}}),T=()=>{const{user:e}=g(),s=f();return E.useEffect(()=>{if(!e)return;const a=i.channel("user-coupons-changes").on("postgres_changes",{event:"*",schema:"public",table:"user_coupons",filter:`user_id=eq.${e.id}`},()=>{s.invalidateQueries({queryKey:["userCoupons",e.id]})}).subscribe();return()=>{i.removeChannel(a)}},[e,s]),_({queryKey:["userCoupons",e==null?void 0:e.id],queryFn:async()=>{if(!e)return[];const{data:a,error:t}=await i.from("user_coupons").select(`
          *,
          coupon_codes (
            *,
            coupon_templates (*)
          )
        `).eq("user_id",e.id).order("claimed_at",{ascending:!1});if(t)throw t;return a},enabled:!!e,staleTime:1e3*30,gcTime:1e3*60*5})},S=e=>_({queryKey:["activityCouponTemplates",e],queryFn:async()=>{const{data:s,error:a}=await i.from("coupon_template_activities").select(`
          coupon_templates (*)
        `).eq("activity_id",e);if(a)throw a;return(s||[]).map(o=>o.coupon_templates).filter(o=>o&&o.is_active&&o.visible)},enabled:!!e}),K=e=>{const{user:s}=g();return _({queryKey:["hasSharedCoupon",e,s==null?void 0:s.id],queryFn:async()=>{if(!s)return!1;const{data:a,error:t}=await i.from("user_coupons").select("id").eq("user_id",s.id).eq("activity_id",e).eq("source","share").maybeSingle();if(t)throw t;return!!a},enabled:!!s&&!!e})},D=()=>_({queryKey:["globalShareCouponTemplate"],queryFn:async()=>{const{data:e,error:s}=await i.from("coupon_templates").select("*").is("activity_id",null).eq("is_active",!0).maybeSingle();if(s)throw s;return e}}),F=e=>_({queryKey:["queryCouponByCode",e],queryFn:async()=>{var u,p;if(!e)return null;const{data:s,error:a}=await i.from("coupon_codes").select(`
          *,
          coupon_templates (*),
          user_coupons (
            id,
            user_id,
            claimed_at,
            used_at,
            source,
            claimed_email
          )
        `).eq("code",e.trim().toUpperCase()).maybeSingle();if(a)throw a;if(!s)return null;const t=((u=s.user_coupons)==null?void 0:u.filter(r=>r.user_id).map(r=>r.user_id))||[];let o={};if(t.length>0){const{data:r}=await i.rpc("get_public_profiles",{user_ids:t});r&&(o=r.reduce((y,m)=>(y[m.id]={display_name:m.display_name},y),{}))}const d=((p=s.user_coupons)==null?void 0:p.map(r=>({...r,profiles:r.user_id&&o[r.user_id]||null})))||[];return{...s,user_coupons:d}},enabled:!!e&&e.trim().length>0}),Q=()=>{const{user:e}=g(),{toast:s}=v(),a=f();return q({mutationFn:async({templateId:t,activityId:o,source:d="share"})=>{if(!e)throw new Error("User not authenticated");const u=e.email;if(d==="share"&&u&&o){const{data:l}=await i.from("user_coupons").select("id").eq("claimed_email",u).eq("activity_id",o).eq("source","share").maybeSingle();if(l)throw new Error("EMAIL_ALREADY_CLAIMED")}const{data:p,error:r}=await i.rpc("generate_coupon_code",{template_id_param:t});if(r)throw r;const y=p,{data:m,error:w}=await i.from("coupon_codes").insert({template_id:t,code:y,usage_limit:1,used_count:0,is_active:!0}).select().single();if(w)throw w;const{data:h,error:n}=await i.from("user_coupons").insert({user_id:e.id,coupon_code_id:m.id,activity_id:o||null,source:d,claimed_email:u||null}).select().single();if(n)throw n;return{userCoupon:h,couponCode:m}},onSuccess:(t,o)=>{a.invalidateQueries({queryKey:["userCoupons"]}),o.activityId&&a.invalidateQueries({queryKey:["hasSharedCoupon",o.activityId]}),s({title:c.t("coupon.claimSuccess"),description:c.t("coupon.claimSuccessDescription")})},onError:t=>{var d,u;const o=((d=t==null?void 0:t.message)==null?void 0:d.includes("user_coupons_share_once_per_activity"))||((u=t==null?void 0:t.message)==null?void 0:u.includes("idx_user_coupons_email"))||(t==null?void 0:t.message)==="EMAIL_ALREADY_CLAIMED"||(t==null?void 0:t.code)==="23505";if((t==null?void 0:t.message)==="EMAIL_ALREADY_CLAIMED"){s({title:c.t("coupon.alreadyClaimed"),description:c.t("coupon.emailAlreadyClaimed"),variant:"destructive"});return}o||s({title:c.t("common.error"),description:t.message||"领取失败",variant:"destructive"})}})},M=()=>{const{toast:e}=v(),s=f();return q({mutationFn:async a=>{if(a.id){const{id:t,created_at:o,updated_at:d,...u}=a,{data:p,error:r}=await i.from("coupon_templates").update(u).eq("id",t).select().single();if(r)throw r;return p}else{const{id:t,created_at:o,updated_at:d,...u}=a,{data:p,error:r}=await i.from("coupon_templates").insert(u).select().single();if(r)throw r;return p}},onSuccess:()=>{s.invalidateQueries({queryKey:["couponTemplates"]}),e({title:c.t("common.success"),description:"优惠券模板保存成功"})},onError:a=>{e({title:c.t("common.error"),description:a.message,variant:"destructive"})}})},L=()=>{const{toast:e}=v(),s=f();return q({mutationFn:async a=>{const{error:t}=await i.from("coupon_templates").delete().eq("id",a);if(t)throw t},onSuccess:()=>{s.invalidateQueries({queryKey:["couponTemplates"]}),e({title:c.t("common.success"),description:"优惠券模板删除成功"})},onError:a=>{e({title:c.t("common.error"),description:a.message,variant:"destructive"})}})},U=e=>_({queryKey:["templateActivities",e],queryFn:async()=>{const{data:s,error:a}=await i.from("coupon_template_activities").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            start_date,
            end_date,
            visible
          )
        `).eq("coupon_template_id",e);if(a)throw a;return s||[]},enabled:!!e}),x=()=>{const e=f(),{toast:s}=v();return q({mutationFn:async({templateId:a,activityId:t})=>{const{error:o}=await i.from("coupon_template_activities").insert({coupon_template_id:a,activity_id:t});if(o)throw o},onSuccess:(a,t)=>{e.invalidateQueries({queryKey:["templateActivities",t.templateId]}),e.invalidateQueries({queryKey:["activityCouponTemplates"]}),s({title:c.t("common.success"),description:"活动关联添加成功"})},onError:a=>{s({title:c.t("common.error"),description:a.message,variant:"destructive"})}})},R=()=>{const e=f(),{toast:s}=v();return q({mutationFn:async({templateId:a,activityId:t})=>{const{error:o}=await i.from("coupon_template_activities").delete().eq("coupon_template_id",a).eq("activity_id",t);if(o)throw o},onSuccess:(a,t)=>{e.invalidateQueries({queryKey:["templateActivities",t.templateId]}),e.invalidateQueries({queryKey:["activityCouponTemplates"]}),s({title:c.t("common.success"),description:"活动关联移除成功"})},onError:a=>{s({title:c.t("common.error"),description:a.message,variant:"destructive"})}})},H=e=>_({queryKey:["templateUsageHistory",e],queryFn:async()=>{if(!e)return[];const{data:s,error:a}=await i.from("coupon_codes").select("id").eq("template_id",e);if(a)throw a;if(!s||s.length===0)return[];const t=s.map(n=>n.id),{data:o,error:d}=await i.from("coupon_usage_history").select("*").in("coupon_code_id",t).order("used_at",{ascending:!1});if(d)throw d;if(!o||o.length===0)return[];const u=[...new Set(o.map(n=>n.used_by_user_id))],{data:p}=await i.from("profiles").select("id, display_name, avatar_url").in("id",u),r=(p||[]).reduce((n,l)=>(n[l.id]={display_name:l.display_name,avatar_url:l.avatar_url},n),{}),y=[...new Set(o.filter(n=>n.restaurant_id).map(n=>n.restaurant_id))];let m={};if(y.length>0){const{data:n}=await i.from("restaurants").select("id, name, name_en, name_pt").in("id",y);m=(n||[]).reduce((l,C)=>(l[C.id]={name:C.name,name_en:C.name_en,name_pt:C.name_pt},l),{})}const{data:w}=await i.from("coupon_codes").select("id, code").in("id",t),h=(w||[]).reduce((n,l)=>(n[l.id]=l.code,n),{});return o.map(n=>({...n,used_by_profile:r[n.used_by_user_id]||null,restaurant:n.restaurant_id&&m[n.restaurant_id]||null,coupon_code:h[n.coupon_code_id]||null}))},enabled:!!e});export{K as a,D as b,Q as c,T as d,M as e,A as f,L as g,U as h,x as i,R as j,H as k,F as l,S as u};
