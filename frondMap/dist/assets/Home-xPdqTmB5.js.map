{"version":3,"file":"Home-xPdqTmB5.js","sources":["../../src/components/AskXiaoxiongDialog.tsx","../../src/components/HomeMapSection.tsx","../../src/components/MobileHeroSection.tsx","../../src/hooks/useRecentActivities.ts","../../src/components/RecentActivitiesSection.tsx","../../src/pages/Home.tsx"],"sourcesContent":["import { useState, useRef, useEffect } from \"react\";\r\nimport { flushSync } from \"react-dom\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { MessageCircle, Send, Loader2, User, Mic, MicOff } from \"lucide-react\";\r\nimport { useProfile } from \"@/hooks/useProfile\";\r\nimport { Avatar, AvatarImage, AvatarFallback } from \"@/components/ui/avatar\";\r\n\r\n// TypeScript declarations for Web Speech API\r\ninterface SpeechRecognitionEvent extends Event {\r\n  results: SpeechRecognitionResultList;\r\n}\r\n\r\ninterface SpeechRecognitionErrorEvent extends Event {\r\n  error: string;\r\n}\r\n\r\ninterface SpeechRecognition extends EventTarget {\r\n  lang: string;\r\n  continuous: boolean;\r\n  interimResults: boolean;\r\n  onstart: ((this: SpeechRecognition, ev: Event) => void) | null;\r\n  onresult: ((this: SpeechRecognition, ev: SpeechRecognitionEvent) => void) | null;\r\n  onerror: ((this: SpeechRecognition, ev: SpeechRecognitionErrorEvent) => void) | null;\r\n  onend: ((this: SpeechRecognition, ev: Event) => void) | null;\r\n  start(): void;\r\n  stop(): void;\r\n}\r\n\r\ndeclare global {\r\n  interface Window {\r\n    SpeechRecognition: new () => SpeechRecognition;\r\n    webkitSpeechRecognition: new () => SpeechRecognition;\r\n    // Native voice bridge for iOS/Android\r\n    webkit?: {\r\n      messageHandlers: {\r\n        VoiceBridge?: {\r\n          postMessage: (message: string) => void;\r\n        };\r\n      };\r\n    };\r\n    VoiceBridge?: {\r\n      postMessage: (message: string) => void;\r\n    };\r\n    onSpeechResult?: (text: string) => void;\r\n  }\r\n}\r\n\r\n// Check for native voice bridge support\r\nconst hasNativeVoiceBridge = (): boolean => {\r\n  return !!(\r\n    (window.webkit?.messageHandlers?.VoiceBridge) || \r\n    window.VoiceBridge\r\n  );\r\n};\r\n\r\n// Native voice bridge utility\r\nconst NativeVoice = {\r\n  start: () => {\r\n    const message = JSON.stringify({ action: \"start\" });\r\n    if (window.webkit?.messageHandlers?.VoiceBridge) {\r\n      window.webkit.messageHandlers.VoiceBridge.postMessage(message);\r\n    } else if (window.VoiceBridge) {\r\n      window.VoiceBridge.postMessage(message);\r\n    }\r\n  },\r\n  stop: () => {\r\n    const message = JSON.stringify({ action: \"stop\" });\r\n    if (window.webkit?.messageHandlers?.VoiceBridge) {\r\n      window.webkit.messageHandlers.VoiceBridge.postMessage(message);\r\n    } else if (window.VoiceBridge) {\r\n      window.VoiceBridge.postMessage(message);\r\n    }\r\n  }\r\n};\r\nimport { useSiteSettings } from \"@/hooks/useSiteSettings\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport logoFallback from \"@/assets/xiaoxiong-logo-christmas.png\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport LocationPermissionDialog from \"@/components/LocationPermissionDialog\";\r\nimport ExternalLinkConfirmDialog from \"@/components/ExternalLinkConfirmDialog\";\r\nimport { openExternalUrl } from \"@/lib/externalLinks\";\r\n\r\ninterface AskXiaoxiongDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  provider?: \"ask-xiaoxiong\" | \"xiaoxiong-agent\" | \"lovable-ai\";\r\n}\r\n\r\ninterface Message {\r\n  id: string;\r\n  role: \"user\" | \"assistant\";\r\n  content: string;\r\n  isStreaming?: boolean;\r\n}\r\n\r\nconst SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;\r\nconst SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;\r\n\r\n// Location-related keywords in multiple languages\r\nconst LOCATION_KEYWORDS = [\r\n  // 中文\r\n  \"最近\", \"附近\", \"离我\", \"距离\", \"远近\", \"近的\", \"周边\", \"周围\", \"最近的\", \"附近的\",\r\n  // 英文\r\n  \"nearest\", \"closest\", \"nearby\", \"near me\", \"close to me\", \"distance\", \"around me\",\r\n  // 葡萄牙语\r\n  \"mais perto\", \"próximo\", \"perto de mim\", \"distância\", \"mais próximo\"\r\n];\r\n\r\n// Get or create a random user ID for non-logged-in users\r\nconst getAnonymousUserId = (): string => {\r\n  const storageKey = \"xiaoxiong_anonymous_user_id\";\r\n  let anonymousId = localStorage.getItem(storageKey);\r\n  if (!anonymousId) {\r\n    anonymousId = `anon_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;\r\n    localStorage.setItem(storageKey, anonymousId);\r\n  }\r\n  return anonymousId;\r\n};\r\n\r\nconst AskXiaoxiongDialog = ({ open, onOpenChange, provider = \"ask-xiaoxiong\" }: AskXiaoxiongDialogProps) => {\r\n  const { i18n } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const { settings } = useSiteSettings();\r\n  const { user } = useAuth();\r\n  const isMobile = useIsMobile();\r\n  const { data: profile } = useProfile();\r\n  const logoUrl = settings?.logo_url || logoFallback;\r\n  const [input, setInput] = useState(\"\");\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);\r\n  const [showLocationDialog, setShowLocationDialog] = useState(false);\r\n  const [pendingMessage, setPendingMessage] = useState<string | null>(null);\r\n  const [isListening, setIsListening] = useState(false);\r\n  const [speechSupported, setSpeechSupported] = useState(false);\r\n  const [nativeVoiceSupported, setNativeVoiceSupported] = useState(false);\r\n  \r\n  const [externalLinkDialogOpen, setExternalLinkDialogOpen] = useState(false);\r\n  const [pendingExternalLink, setPendingExternalLink] = useState<string | null>(null);\r\n  const abortControllerRef = useRef<AbortController | null>(null);\r\n  const scrollAreaRef = useRef<HTMLDivElement>(null);\r\n  const recognitionRef = useRef<SpeechRecognition | null>(null);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Determine if voice input should be shown based on device type and settings\r\n  const shouldShowVoiceInput = (): boolean => {\r\n    // Support either Web Speech API or native voice bridge\r\n    if (!speechSupported && !nativeVoiceSupported) return false;\r\n    \r\n    // Check screen width to determine device type\r\n    const screenWidth = typeof window !== 'undefined' ? window.innerWidth : 1024;\r\n    const isTablet = screenWidth >= 768 && screenWidth < 1024;\r\n    const isDesktop = screenWidth >= 1024;\r\n    \r\n    if (isMobile) {\r\n      return settings?.voice_input_mobile !== false;\r\n    } else if (isTablet) {\r\n      return settings?.voice_input_tablet !== false;\r\n    } else if (isDesktop) {\r\n      return settings?.voice_input_desktop !== false;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  // Get user ID for agent provider\r\n  const getUserId = (): string => {\r\n    if (user?.id) {\r\n      return user.id;\r\n    }\r\n    return getAnonymousUserId();\r\n  };\r\n\r\n  // Check for speech recognition support (Web Speech API and native bridge)\r\n  useEffect(() => {\r\n    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\r\n    setSpeechSupported(!!SpeechRecognition);\r\n    setNativeVoiceSupported(hasNativeVoiceBridge());\r\n    \r\n    // Register global callback for native voice recognition\r\n    window.onSpeechResult = (text: string) => {\r\n      setInput(text);\r\n      setIsListening(false);\r\n    };\r\n    \r\n    return () => {\r\n      // Cleanup global callback\r\n      window.onSpeechResult = undefined;\r\n    };\r\n  }, []);\r\n\r\n  // Monitor visualViewport for iOS WebView embedded browsers\r\n  // Tracks both height AND offsetTop to handle keyboard show/hide correctly\r\n  useEffect(() => {\r\n    if (!open || !isMobile) return;\r\n    \r\n    // Save current scroll position to restore later\r\n    const savedScrollY = window.scrollY;\r\n    const savedScrollX = window.scrollX;\r\n    \r\n    // Prevent body scrolling when dialog is open\r\n    const originalOverflow = document.body.style.overflow;\r\n    const originalPosition = document.body.style.position;\r\n    const originalTop = document.body.style.top;\r\n    const originalWidth = document.body.style.width;\r\n    \r\n    // Lock body scroll while preserving position\r\n    document.body.style.overflow = 'hidden';\r\n    document.body.style.position = 'fixed';\r\n    document.body.style.top = `-${savedScrollY}px`;\r\n    document.body.style.width = '100%';\r\n    \r\n    const updateViewport = () => {\r\n      const viewport = window.visualViewport;\r\n      if (viewport) {\r\n        // Height of visible area (from top of viewport to keyboard)\r\n        const vh = viewport.height;\r\n        // Offset from top of layout viewport (changes when keyboard pushes content)\r\n        const offsetTop = viewport.offsetTop || 0;\r\n        \r\n        document.documentElement.style.setProperty('--visual-viewport-height', `${vh}px`);\r\n        document.documentElement.style.setProperty('--visual-viewport-offset-top', `${offsetTop}px`);\r\n      } else {\r\n        // Fallback for browsers without visualViewport\r\n        document.documentElement.style.setProperty('--visual-viewport-height', `${window.innerHeight}px`);\r\n        document.documentElement.style.setProperty('--visual-viewport-offset-top', '0px');\r\n      }\r\n    };\r\n    \r\n    // Set initial values\r\n    updateViewport();\r\n    \r\n    // Listen for viewport changes (keyboard show/hide, address bar, rotation)\r\n    window.visualViewport?.addEventListener('resize', updateViewport);\r\n    window.visualViewport?.addEventListener('scroll', updateViewport);\r\n    window.addEventListener('resize', updateViewport);\r\n    window.addEventListener('orientationchange', updateViewport);\r\n    \r\n    return () => {\r\n      // Restore original body styles\r\n      document.body.style.overflow = originalOverflow;\r\n      document.body.style.position = originalPosition;\r\n      document.body.style.top = originalTop;\r\n      document.body.style.width = originalWidth;\r\n      \r\n      // Restore scroll position\r\n      window.scrollTo(savedScrollX, savedScrollY);\r\n      \r\n      // Cleanup event listeners\r\n      window.visualViewport?.removeEventListener('resize', updateViewport);\r\n      window.visualViewport?.removeEventListener('scroll', updateViewport);\r\n      window.removeEventListener('resize', updateViewport);\r\n      window.removeEventListener('orientationchange', updateViewport);\r\n      document.documentElement.style.removeProperty('--visual-viewport-height');\r\n      document.documentElement.style.removeProperty('--visual-viewport-offset-top');\r\n    };\r\n  }, [open, isMobile]);\r\n\r\n  // Get user location when dialog opens\r\n  useEffect(() => {\r\n    if (open && !userLocation) {\r\n      navigator.geolocation?.getCurrentPosition(\r\n        (position) => {\r\n          setUserLocation({\r\n            lat: position.coords.latitude,\r\n            lng: position.coords.longitude,\r\n          });\r\n        },\r\n        (error) => {\r\n          console.log(\"Unable to get user location:\", error.message);\r\n        },\r\n        { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 }\r\n      );\r\n    }\r\n  }, [open, userLocation]);\r\n\r\n  // Cleanup speech recognition when dialog closes\r\n  useEffect(() => {\r\n    if (!open && recognitionRef.current) {\r\n      recognitionRef.current.stop();\r\n      setIsListening(false);\r\n    }\r\n  }, [open]);\r\n\r\n  // Auto scroll to bottom when new messages arrive\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [messages]);\r\n\r\n  const handleSubmitAskXiaoxiong = async (userMessage: Message, assistantMessageId: string) => {\r\n    const response = await fetch(`${SUPABASE_URL}/functions/v1/ask-xiaoxiong`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\r\n        'apikey': SUPABASE_ANON_KEY,\r\n      },\r\n      body: JSON.stringify({ \r\n        text: userMessage.content, \r\n        stream: true,\r\n        lat: userLocation?.lat,\r\n        lng: userLocation?.lng,\r\n      }),\r\n      signal: abortControllerRef.current?.signal,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Request failed with status: ${response.status}`);\r\n    }\r\n\r\n    if (!response.body) {\r\n      throw new Error('No response body');\r\n    }\r\n\r\n    const reader = response.body.getReader();\r\n    const decoder = new TextDecoder();\r\n    let accumulatedResult = \"\";\r\n\r\n    while (true) {\r\n      const { done, value } = await reader.read();\r\n      \r\n      if (done) {\r\n        break;\r\n      }\r\n\r\n      const chunk = decoder.decode(value, { stream: true });\r\n      accumulatedResult += chunk;\r\n      \r\n      // Clean up the result for display\r\n      let cleanResult = accumulatedResult;\r\n      if (cleanResult.startsWith('\"')) {\r\n        cleanResult = cleanResult.slice(1);\r\n      }\r\n      if (cleanResult.endsWith('\"')) {\r\n        cleanResult = cleanResult.slice(0, -1);\r\n      }\r\n      cleanResult = cleanResult.replace(/\\\\n/g, '\\n');\r\n      \r\n      // Update the assistant message\r\n      setMessages((prev) =>\r\n        prev.map((msg) =>\r\n          msg.id === assistantMessageId\r\n            ? { ...msg, content: cleanResult }\r\n            : msg\r\n        )\r\n      );\r\n    }\r\n\r\n    // Final cleanup\r\n    let finalResult = accumulatedResult;\r\n    if (finalResult.startsWith('\"')) {\r\n      finalResult = finalResult.slice(1);\r\n    }\r\n    if (finalResult.endsWith('\"')) {\r\n      finalResult = finalResult.slice(0, -1);\r\n    }\r\n    finalResult = finalResult.replace(/\\\\n/g, '\\n');\r\n    \r\n    setMessages((prev) =>\r\n      prev.map((msg) =>\r\n        msg.id === assistantMessageId\r\n          ? { ...msg, content: finalResult, isStreaming: false }\r\n          : msg\r\n      )\r\n    );\r\n  };\r\n\r\n  const handleSubmitXiaoxiongAgent = async (userMessage: Message, assistantMessageId: string) => {\r\n    const userId = getUserId();\r\n    const requestStartTime = Date.now();\r\n    console.log(`[前端-Agent] ⏱️ 开始发送请求: ${new Date().toISOString()}`);\r\n    \r\n    const response = await fetch(`${SUPABASE_URL}/functions/v1/xiaoxiong-agent`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\r\n        'apikey': SUPABASE_ANON_KEY,\r\n      },\r\n      body: JSON.stringify({ \r\n        message: userMessage.content, \r\n        userId,\r\n      }),\r\n      signal: abortControllerRef.current?.signal,\r\n    });\r\n\r\n    const responseTime = Date.now() - requestStartTime;\r\n    console.log(`[前端-Agent] ⏱️ 收到响应头: ${new Date().toISOString()}, 耗时: ${responseTime}ms`);\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Request failed with status: ${response.status}`);\r\n    }\r\n\r\n    if (!response.body) {\r\n      throw new Error('No response body');\r\n    }\r\n\r\n    const reader = response.body.getReader();\r\n    const decoder = new TextDecoder();\r\n    let accumulatedResult = \"\";\r\n    let firstChunkReceived = false;\r\n    let chunkCount = 0;\r\n\r\n    while (true) {\r\n      const { done, value } = await reader.read();\r\n      \r\n      if (done) {\r\n        console.log(`[前端-Agent] ⏱️ 流结束: ${new Date().toISOString()}, 总耗时: ${Date.now() - requestStartTime}ms, 共 ${chunkCount} 个数据块`);\r\n        break;\r\n      }\r\n\r\n      chunkCount++;\r\n      const chunk = decoder.decode(value, { stream: true });\r\n      accumulatedResult += chunk;\r\n      \r\n      if (!firstChunkReceived) {\r\n        firstChunkReceived = true;\r\n        const ttfb = Date.now() - requestStartTime;\r\n        console.log(`[前端-Agent] ⏱️ 首个数据块 (TTFB): ${new Date().toISOString()}, 耗时: ${ttfb}ms, 大小: ${chunk.length} 字符`);\r\n      }\r\n      \r\n      // 使用 flushSync 强制同步渲染，绕过 React 18 批量更新\r\n      flushSync(() => {\r\n        setMessages((prev) =>\r\n          prev.map((msg) =>\r\n            msg.id === assistantMessageId\r\n              ? { ...msg, content: accumulatedResult }\r\n              : msg\r\n          )\r\n        );\r\n      });\r\n      \r\n      // 等待浏览器渲染帧，确保每个字符都能显示\r\n      await new Promise(resolve => requestAnimationFrame(resolve));\r\n    }\r\n\r\n    // Mark streaming as complete\r\n    setMessages((prev) =>\r\n      prev.map((msg) =>\r\n        msg.id === assistantMessageId\r\n          ? { ...msg, isStreaming: false }\r\n          : msg\r\n      )\r\n    );\r\n  };\r\n\r\n  const handleSubmitLovableAI = async (userMessage: Message, assistantMessageId: string) => {\r\n    const requestStartTime = Date.now();\r\n    console.log(`[前端-LovableAI] ⏱️ 开始发送请求: ${new Date().toISOString()}`);\r\n    \r\n    const response = await fetch(`${SUPABASE_URL}/functions/v1/lovable-chat`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,\r\n        'apikey': SUPABASE_ANON_KEY,\r\n      },\r\n      body: JSON.stringify({ \r\n        message: userMessage.content,\r\n        lat: userLocation?.lat,\r\n        lng: userLocation?.lng,\r\n        language: i18n.language,\r\n      }),\r\n      signal: abortControllerRef.current?.signal,\r\n    });\r\n\r\n    const responseTime = Date.now() - requestStartTime;\r\n    console.log(`[前端-LovableAI] ⏱️ 收到响应头: ${new Date().toISOString()}, 耗时: ${responseTime}ms`);\r\n\r\n    if (!response.ok) {\r\n      const errorData = await response.json().catch(() => ({}));\r\n      throw new Error(errorData.error || `Request failed with status: ${response.status}`);\r\n    }\r\n\r\n    if (!response.body) {\r\n      throw new Error('No response body');\r\n    }\r\n\r\n    const reader = response.body.getReader();\r\n    const decoder = new TextDecoder();\r\n    let accumulatedResult = \"\";\r\n    let textBuffer = \"\";\r\n    let firstChunkReceived = false;\r\n\r\n    while (true) {\r\n      const { done, value } = await reader.read();\r\n      \r\n      if (done) {\r\n        console.log(`[前端-LovableAI] ⏱️ 流结束: ${new Date().toISOString()}, 总耗时: ${Date.now() - requestStartTime}ms`);\r\n        break;\r\n      }\r\n\r\n      textBuffer += decoder.decode(value, { stream: true });\r\n\r\n      if (!firstChunkReceived) {\r\n        firstChunkReceived = true;\r\n        const ttfb = Date.now() - requestStartTime;\r\n        console.log(`[前端-LovableAI] ⏱️ 首个数据块 (TTFB): ${new Date().toISOString()}, 耗时: ${ttfb}ms`);\r\n      }\r\n\r\n      // Parse SSE lines\r\n      let newlineIndex: number;\r\n      while ((newlineIndex = textBuffer.indexOf(\"\\n\")) !== -1) {\r\n        let line = textBuffer.slice(0, newlineIndex);\r\n        textBuffer = textBuffer.slice(newlineIndex + 1);\r\n\r\n        if (line.endsWith(\"\\r\")) line = line.slice(0, -1);\r\n        if (line.startsWith(\":\") || line.trim() === \"\") continue;\r\n        if (!line.startsWith(\"data: \")) continue;\r\n\r\n        const jsonStr = line.slice(6).trim();\r\n        if (jsonStr === \"[DONE]\") break;\r\n\r\n        try {\r\n          const parsed = JSON.parse(jsonStr);\r\n          const content = parsed.choices?.[0]?.delta?.content as string | undefined;\r\n          if (content) {\r\n            accumulatedResult += content;\r\n            \r\n            // Use flushSync for immediate rendering\r\n            flushSync(() => {\r\n              setMessages((prev) =>\r\n                prev.map((msg) =>\r\n                  msg.id === assistantMessageId\r\n                    ? { ...msg, content: accumulatedResult }\r\n                    : msg\r\n                )\r\n              );\r\n            });\r\n            \r\n            await new Promise(resolve => requestAnimationFrame(resolve));\r\n          }\r\n        } catch {\r\n          // 忽略解析失败的行，继续处理下一行\r\n        }\r\n      }\r\n    }\r\n\r\n    // Mark streaming as complete\r\n    setMessages((prev) =>\r\n      prev.map((msg) =>\r\n        msg.id === assistantMessageId\r\n          ? { ...msg, isStreaming: false }\r\n          : msg\r\n      )\r\n    );\r\n  };\r\n\r\n  // Check if message needs location info\r\n  const needsLocationInfo = (message: string): boolean => {\r\n    const lowerMessage = message.toLowerCase();\r\n    return LOCATION_KEYWORDS.some(keyword => lowerMessage.includes(keyword));\r\n  };\r\n\r\n  // Process and send message to AI\r\n  const processMessage = async (messageContent: string) => {\r\n    const userMessage: Message = {\r\n      id: Date.now().toString(),\r\n      role: \"user\",\r\n      content: messageContent,\r\n    };\r\n\r\n    const assistantMessageId = (Date.now() + 1).toString();\r\n    const assistantMessage: Message = {\r\n      id: assistantMessageId,\r\n      role: \"assistant\",\r\n      content: \"\",\r\n      isStreaming: true,\r\n    };\r\n\r\n    setMessages((prev) => [...prev, userMessage, assistantMessage]);\r\n    setInput(\"\");\r\n    setIsLoading(true);\r\n\r\n    // Cancel any ongoing request\r\n    if (abortControllerRef.current) {\r\n      abortControllerRef.current.abort();\r\n    }\r\n    abortControllerRef.current = new AbortController();\r\n\r\n    try {\r\n      if (provider === \"lovable-ai\") {\r\n        await handleSubmitLovableAI(userMessage, assistantMessageId);\r\n      } else if (provider === \"xiaoxiong-agent\") {\r\n        await handleSubmitXiaoxiongAgent(userMessage, assistantMessageId);\r\n      } else {\r\n        await handleSubmitAskXiaoxiong(userMessage, assistantMessageId);\r\n      }\r\n    } catch (err) {\r\n      if (err instanceof Error && err.name === 'AbortError') {\r\n        console.log('Request aborted');\r\n        return;\r\n      }\r\n      console.error(\"Ask API error:\", err);\r\n      const errorMessage =\r\n        i18n.language === \"zh\"\r\n          ? \"抱歉，暂时无法获取结果，请稍后再试\"\r\n          : i18n.language === \"pt\"\r\n          ? \"Desculpe, não foi possível obter resultados. Tente novamente mais tarde.\"\r\n          : \"Sorry, unable to get results. Please try again later.\";\r\n      \r\n      setMessages((prev) =>\r\n        prev.map((msg) =>\r\n          msg.id === assistantMessageId\r\n            ? { ...msg, content: errorMessage, isStreaming: false }\r\n            : msg\r\n        )\r\n      );\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Handle location permission confirmation\r\n  const handleLocationConfirm = () => {\r\n    setShowLocationDialog(false);\r\n    navigator.geolocation?.getCurrentPosition(\r\n      (position) => {\r\n        setUserLocation({\r\n          lat: position.coords.latitude,\r\n          lng: position.coords.longitude,\r\n        });\r\n        // Process pending message after getting location\r\n        if (pendingMessage) {\r\n          setTimeout(() => {\r\n            processMessage(pendingMessage);\r\n            setPendingMessage(null);\r\n          }, 100);\r\n        }\r\n      },\r\n      (error) => {\r\n        console.log(\"Location permission denied:\", error.message);\r\n        // Still process message even without location\r\n        if (pendingMessage) {\r\n          processMessage(pendingMessage);\r\n          setPendingMessage(null);\r\n        }\r\n      },\r\n      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }\r\n    );\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    if (!input.trim() || isLoading) return;\r\n\r\n    const messageContent = input.trim();\r\n\r\n    // Check if location is needed but not available\r\n    if (!userLocation && needsLocationInfo(messageContent)) {\r\n      setPendingMessage(messageContent);\r\n      setShowLocationDialog(true);\r\n      setInput(\"\");\r\n      return;\r\n    }\r\n\r\n    await processMessage(messageContent);\r\n  };\r\n\r\n  const handleKeyDown = (e: React.KeyboardEvent) => {\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSubmit();\r\n    }\r\n  };\r\n\r\n  // Voice input handling\r\n  const startListening = () => {\r\n    // Prefer native voice bridge if available (in native apps)\r\n    if (nativeVoiceSupported) {\r\n      NativeVoice.start();\r\n      setIsListening(true);\r\n      return;\r\n    }\r\n\r\n    // Fallback to Web Speech API\r\n    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\r\n    if (!SpeechRecognition) {\r\n      console.log(\"Speech recognition not supported\");\r\n      return;\r\n    }\r\n\r\n    // Stop any existing recognition\r\n    if (recognitionRef.current) {\r\n      recognitionRef.current.stop();\r\n    }\r\n\r\n    const recognition = new SpeechRecognition();\r\n    recognitionRef.current = recognition;\r\n\r\n    // Set language based on current i18n language\r\n    const langMap: Record<string, string> = {\r\n      zh: \"zh-CN\",\r\n      en: \"en-US\",\r\n      pt: \"pt-BR\",\r\n    };\r\n    recognition.lang = langMap[i18n.language] || \"zh-CN\";\r\n    recognition.continuous = false;\r\n    recognition.interimResults = true;\r\n\r\n    recognition.onstart = () => {\r\n      setIsListening(true);\r\n    };\r\n\r\n    recognition.onresult = (event) => {\r\n      const transcript = Array.from(event.results)\r\n        .map((result) => result[0].transcript)\r\n        .join(\"\");\r\n      setInput(transcript);\r\n    };\r\n\r\n    recognition.onerror = (event) => {\r\n      console.log(\"Speech recognition error:\", event.error);\r\n      setIsListening(false);\r\n    };\r\n\r\n    recognition.onend = () => {\r\n      setIsListening(false);\r\n    };\r\n\r\n    recognition.start();\r\n  };\r\n\r\n  const stopListening = () => {\r\n    // Stop native voice if using native bridge\r\n    if (nativeVoiceSupported) {\r\n      NativeVoice.stop();\r\n      setIsListening(false);\r\n      return;\r\n    }\r\n    \r\n    // Stop Web Speech API\r\n    if (recognitionRef.current) {\r\n      recognitionRef.current.stop();\r\n      setIsListening(false);\r\n    }\r\n  };\r\n\r\n  const toggleListening = () => {\r\n    if (isListening) {\r\n      stopListening();\r\n    } else {\r\n      startListening();\r\n    }\r\n  };\r\n\r\n  const handleClose = () => {\r\n    if (abortControllerRef.current) {\r\n      abortControllerRef.current.abort();\r\n    }\r\n    onOpenChange(false);\r\n  };\r\n\r\n  const handleLinkClick = (href: string) => {\r\n    handleClose();\r\n    navigate(href);\r\n  };\r\n\r\n  // Handle external link click - show confirmation dialog\r\n  const handleExternalLinkClick = (url: string) => {\r\n    setPendingExternalLink(url);\r\n    setExternalLinkDialogOpen(true);\r\n  };\r\n\r\n  // Confirm external link navigation\r\n  const confirmExternalLink = () => {\r\n    if (pendingExternalLink) {\r\n      openExternalUrl(pendingExternalLink);\r\n    }\r\n    setExternalLinkDialogOpen(false);\r\n    setPendingExternalLink(null);\r\n  };\r\n\r\n  // Parse text with links: [text](/path), [text](!external:url) or [text](url)\r\n  const parseTextWithLinks = (text: string): JSX.Element[] => {\r\n    const linkRegex = /\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\r\n    const parts: JSX.Element[] = [];\r\n    let lastIndex = 0;\r\n    let match;\r\n    let keyIndex = 0;\r\n\r\n    while ((match = linkRegex.exec(text)) !== null) {\r\n      if (match.index > lastIndex) {\r\n        parts.push(<span key={keyIndex++}>{text.slice(lastIndex, match.index)}</span>);\r\n      }\r\n\r\n      const linkText = match[1];\r\n      const href = match[2];\r\n\r\n      if (href.startsWith(\"/\")) {\r\n        // Internal link - direct navigation\r\n        parts.push(\r\n          <button\r\n            key={keyIndex++}\r\n            onClick={() => handleLinkClick(href)}\r\n            className=\"text-primary hover:underline font-medium cursor-pointer\"\r\n          >\r\n            {linkText}\r\n          </button>\r\n        );\r\n      } else if (href.startsWith(\"!external:\")) {\r\n        // External link with !external: prefix - show confirmation dialog\r\n        const actualUrl = href.slice(\"!external:\".length);\r\n        parts.push(\r\n          <button\r\n            key={keyIndex++}\r\n            onClick={() => handleExternalLinkClick(actualUrl)}\r\n            className=\"text-primary hover:underline font-medium cursor-pointer\"\r\n          >\r\n            {linkText}\r\n          </button>\r\n        );\r\n      } else if (href.startsWith(\"http://\") || href.startsWith(\"https://\")) {\r\n        // Regular external URL - also show confirmation dialog for iOS compatibility\r\n        parts.push(\r\n          <button\r\n            key={keyIndex++}\r\n            onClick={() => handleExternalLinkClick(href)}\r\n            className=\"text-primary hover:underline font-medium cursor-pointer\"\r\n          >\r\n            {linkText}\r\n          </button>\r\n        );\r\n      } else {\r\n        // Other links - render as regular anchor (unlikely case)\r\n        parts.push(\r\n          <a\r\n            key={keyIndex++}\r\n            href={href}\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"text-primary hover:underline font-medium\"\r\n          >\r\n            {linkText}\r\n          </a>\r\n        );\r\n      }\r\n\r\n      lastIndex = match.index + match[0].length;\r\n    }\r\n\r\n    if (lastIndex < text.length) {\r\n      parts.push(<span key={keyIndex++}>{text.slice(lastIndex)}</span>);\r\n    }\r\n\r\n    return parts.length > 0 ? parts : [<span key=\"0\">{text}</span>];\r\n  };\r\n\r\n  // Remove bold markers from text\r\n  const removeBoldMarkers = (text: string): string => {\r\n    return text.replace(/\\*\\*(.*?)\\*\\*/g, '$1');\r\n  };\r\n\r\n  // Truncate text if too long\r\n  const truncateText = (text: string, maxLength: number = 20): string => {\r\n    if (text.length <= maxLength) return text;\r\n    return text.slice(0, maxLength) + '...';\r\n  };\r\n\r\n  // Render a markdown table\r\n  const renderTable = (tableLines: string[], key: number) => {\r\n    const parseRow = (line: string) =>\r\n      line\r\n        .split(\"|\")\r\n        .slice(1, -1)\r\n        .map((cell) => removeBoldMarkers(cell.trim()));\r\n\r\n    const headers = parseRow(tableLines[0]);\r\n    // Skip separator line (index 1), parse data rows\r\n    const rows = tableLines.slice(2).map(parseRow);\r\n\r\n    return (\r\n      <div key={key} className=\"overflow-x-auto my-2 max-w-full\">\r\n        <table className=\"w-full text-xs border border-border rounded-md overflow-hidden table-fixed\">\r\n          <thead className=\"bg-muted/60\">\r\n            <tr>\r\n              {headers.map((header, i) => (\r\n                <th\r\n                  key={i}\r\n                  className=\"px-2 py-2 text-left font-semibold border-b border-border truncate max-w-[100px]\"\r\n                  title={header}\r\n                >\r\n                  {parseTextWithLinks(truncateText(header, 15))}\r\n                </th>\r\n              ))}\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {rows.map((row, rowIndex) => (\r\n              <tr\r\n                key={rowIndex}\r\n                className=\"border-b border-border last:border-0 hover:bg-muted/30 transition-colors\"\r\n              >\r\n                {row.map((cell, cellIndex) => (\r\n                  <td \r\n                    key={cellIndex} \r\n                    className=\"px-2 py-2 truncate max-w-[100px]\"\r\n                    title={cell}\r\n                  >\r\n                    {parseTextWithLinks(truncateText(cell, 18))}\r\n                  </td>\r\n                ))}\r\n              </tr>\r\n            ))}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const renderMarkdown = (content: string) => {\r\n    const lines = content.split(\"\\n\");\r\n    const elements: JSX.Element[] = [];\r\n    let i = 0;\r\n\r\n    while (i < lines.length) {\r\n      const line = lines[i];\r\n\r\n      // Detect table: starts with | and contains multiple |\r\n      if (line.trim().startsWith(\"|\") && line.split(\"|\").length > 2) {\r\n        const tableLines: string[] = [];\r\n\r\n        // Collect all consecutive table lines\r\n        while (i < lines.length && lines[i].trim().startsWith(\"|\")) {\r\n          tableLines.push(lines[i]);\r\n          i++;\r\n        }\r\n\r\n        // Need at least header + separator + 1 data row, but render even with just header + separator\r\n        if (tableLines.length >= 2) {\r\n          elements.push(renderTable(tableLines, elements.length));\r\n        }\r\n        continue;\r\n      }\r\n\r\n      // Existing markdown rendering logic\r\n      if (line.startsWith(\"### \")) {\r\n        elements.push(\r\n          <h3 key={elements.length} className=\"text-base font-semibold mt-3 mb-1\">\r\n            {parseTextWithLinks(line.slice(4))}\r\n          </h3>\r\n        );\r\n      } else if (line.startsWith(\"## \")) {\r\n        elements.push(\r\n          <h2 key={elements.length} className=\"text-lg font-bold mt-4 mb-2\">\r\n            {parseTextWithLinks(line.slice(3))}\r\n          </h2>\r\n        );\r\n      } else if (line.startsWith(\"# \")) {\r\n        elements.push(\r\n          <h1 key={elements.length} className=\"text-xl font-bold mt-4 mb-2\">\r\n            {parseTextWithLinks(line.slice(2))}\r\n          </h1>\r\n        );\r\n      } else if (line.includes(\"**\")) {\r\n        const parts = line.split(/\\*\\*(.*?)\\*\\*/g);\r\n        elements.push(\r\n          <p key={elements.length} className=\"mb-1 leading-relaxed\">\r\n            {parts.map((part, idx) =>\r\n              idx % 2 === 1 ? (\r\n                <strong key={idx} className=\"font-semibold\">\r\n                  {parseTextWithLinks(part)}\r\n                </strong>\r\n              ) : (\r\n                parseTextWithLinks(part)\r\n              )\r\n            )}\r\n          </p>\r\n        );\r\n      } else if (line.startsWith(\"- \") || line.startsWith(\"* \")) {\r\n        elements.push(\r\n          <li key={elements.length} className=\"ml-4 mb-0.5 list-disc\">\r\n            {parseTextWithLinks(line.slice(2))}\r\n          </li>\r\n        );\r\n      } else if (/^\\d+\\.\\s/.test(line)) {\r\n        elements.push(\r\n          <li key={elements.length} className=\"ml-4 mb-0.5 list-decimal\">\r\n            {parseTextWithLinks(line.replace(/^\\d+\\.\\s/, \"\"))}\r\n          </li>\r\n        );\r\n      } else if (line.match(/^[-*_]{3,}$/)) {\r\n        elements.push(<hr key={elements.length} className=\"my-3 border-border\" />);\r\n      } else if (line.trim() === \"\") {\r\n        elements.push(<div key={elements.length} className=\"h-1\" />);\r\n      } else {\r\n        elements.push(\r\n          <p key={elements.length} className=\"mb-1 leading-relaxed\">\r\n            {parseTextWithLinks(line)}\r\n          </p>\r\n        );\r\n      }\r\n\r\n      i++;\r\n    }\r\n\r\n    return elements;\r\n  };\r\n\r\n  const getTitle = () => {\r\n    if (i18n.language === \"zh\") return \"小熊AI助手\";\r\n    if (i18n.language === \"pt\") return \"Assistente IA Xiaoxiong\";\r\n    return \"Xiaoxiong AI Assistant\";\r\n  };\r\n\r\n  const getPlaceholder = () => {\r\n    if (i18n.language === \"zh\") return \"告诉小熊，你想吃什么...\";\r\n    if (i18n.language === \"pt\") return \"Diga ao Xiaoxiong o que você quer comer...\";\r\n    return \"Tell Xiaoxiong what you want to eat...\";\r\n  };\r\n\r\n  const getWelcomeMessage = () => {\r\n    if (i18n.language === \"zh\") return \"你好，我是小熊，我来帮你推荐餐厅；比如：「我附近的寿司餐厅」\";\r\n    if (i18n.language === \"pt\") return \"Olá, eu sou o Xiaoxiong, vou te ajudar a encontrar restaurantes; por exemplo: 「restaurantes de sushi perto de mim」\";\r\n    return \"Hi, I'm Xiaoxiong, I'll help you find restaurants; for example: \\\"sushi restaurants near me\\\"\";\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent \r\n        className={cn(\r\n          \"flex flex-col p-0 gap-0 overflow-hidden bg-background\",\r\n          // Mobile: full screen with fixed positioning\r\n          isMobile \r\n            ? \"fixed w-full max-w-full rounded-none\" \r\n            : \"sm:max-w-lg sm:h-[70vh] sm:max-h-[70vh] sm:rounded-lg\"\r\n        )}\r\n        style={isMobile ? { \r\n          // Use CSS variables for height and top position, calculated from visualViewport\r\n          height: 'var(--visual-viewport-height, 100vh)',\r\n          maxHeight: 'var(--visual-viewport-height, 100vh)',\r\n          // Position follows visualViewport offset (changes when keyboard pushes content)\r\n          position: 'fixed',\r\n          top: 'var(--visual-viewport-offset-top, 0px)',\r\n          left: 0,\r\n          right: 0,\r\n          bottom: 'auto',\r\n          // Critical: disable all transforms that radix dialog uses for centering\r\n          transform: 'none',\r\n        } : undefined}\r\n      >\r\n        <DialogHeader className=\"px-4 py-3 shrink-0 bg-white/60 dark:bg-gray-900/60 backdrop-blur-md border-b border-white/30 dark:border-white/20 shadow-[0_1px_3px_rgba(0,0,0,0.05)]\">\r\n          {/* iOS-style glass top bar */}\r\n          <DialogTitle className=\"flex items-center gap-3 text-base font-semibold\">\r\n            <div className=\"w-11 h-11 rounded-full bg-white dark:bg-gray-800 flex items-center justify-center overflow-hidden shadow-sm border border-white/50 dark:border-white/30\">\r\n              <img src={logoUrl} alt=\"Logo\" className=\"w-8 h-8 object-contain\" />\r\n            </div>\r\n            <span className=\"text-foreground\">{getTitle()}</span>\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        {/* Chat Messages Area - Scrollable, min-h-0 ensures flex shrinking works on iOS */}\r\n        <ScrollArea className=\"flex-1 min-h-0 overflow-hidden\" ref={scrollAreaRef}>\r\n          <div className=\"p-4 space-y-4\">\r\n            {/* Welcome message */}\r\n            {messages.length === 0 && (\r\n              <div className=\"flex gap-3\">\r\n                <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\r\n                  <img src={logoUrl} alt=\"AI\" className=\"w-5 h-5 object-contain\" />\r\n                </div>\r\n                <div className=\"flex-1 bg-muted/50 rounded-2xl rounded-tl-sm px-4 py-3 text-sm\">\r\n                  {getWelcomeMessage()}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Messages */}\r\n            {messages.map((message) => (\r\n              <div\r\n                key={message.id}\r\n                className={cn(\r\n                  \"flex gap-3\",\r\n                  message.role === \"user\" && \"flex-row-reverse\"\r\n                )}\r\n              >\r\n                {message.role === \"user\" ? (\r\n                  <Avatar className=\"w-8 h-8 shrink-0\">\r\n                    {profile?.avatar_url ? (\r\n                      <AvatarImage src={profile.avatar_url} alt=\"User avatar\" />\r\n                    ) : null}\r\n                    <AvatarFallback className=\"bg-secondary/50 text-foreground\">\r\n                      <User className=\"h-4 w-4\" />\r\n                    </AvatarFallback>\r\n                  </Avatar>\r\n                ) : (\r\n                  <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\r\n                    <img src={logoUrl} alt=\"AI\" className=\"w-7 h-7 object-contain\" />\r\n                  </div>\r\n                )}\r\n                <div\r\n                  className={cn(\r\n                    \"flex-1 max-w-[85%] rounded-2xl px-4 py-3 text-sm\",\r\n                    message.role === \"user\"\r\n                      ? \"bg-secondary/50 text-foreground rounded-tr-sm border border-border/50\"\r\n                      : \"bg-muted/50 rounded-tl-sm\"\r\n                  )}\r\n                >\r\n                  {message.role === \"assistant\" ? (\r\n                    <>\r\n                      {message.content ? (\r\n                        <div className=\"prose-sm\">\r\n                          {renderMarkdown(message.content)}\r\n                        </div>\r\n                      ) : (\r\n                        <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                          <span>\r\n                            {i18n.language === \"zh\"\r\n                              ? \"思考中...\"\r\n                              : i18n.language === \"pt\"\r\n                              ? \"Pensando...\"\r\n                              : \"Thinking...\"}\r\n                          </span>\r\n                        </div>\r\n                      )}\r\n                      {message.isStreaming && message.content && (\r\n                        <span className=\"inline-block w-1.5 h-4 bg-primary/50 animate-pulse ml-0.5 align-middle\" />\r\n                      )}\r\n                    </>\r\n                  ) : (\r\n                    message.content\r\n                  )}\r\n                </div>\r\n              </div>\r\n            ))}\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        {/* Input Section - Fixed at bottom, never shrinks */}\r\n        <div className=\"p-4 pb-[max(1rem,env(safe-area-inset-bottom))] bg-background shrink-0\">\r\n          <div className=\"group flex items-center gap-3 bg-secondary/50 backdrop-blur-sm px-5 py-3.5 rounded-full shadow-sm hover:shadow-md hover:bg-secondary/70 transition-all duration-300 border border-border/50\">\r\n            {/* Voice Input Button */}\r\n            {shouldShowVoiceInput() && (\r\n              <button\r\n                onClick={toggleListening}\r\n                disabled={isLoading}\r\n                className={cn(\r\n                  \"shrink-0 transition-all duration-200\",\r\n                  isListening && \"text-destructive animate-pulse\"\r\n                )}\r\n                title={\r\n                  i18n.language === \"zh\"\r\n                    ? isListening ? \"停止录音\" : \"语音输入\"\r\n                    : i18n.language === \"pt\"\r\n                    ? isListening ? \"Parar gravação\" : \"Entrada de voz\"\r\n                    : isListening ? \"Stop recording\" : \"Voice input\"\r\n                }\r\n              >\r\n                {isListening ? (\r\n                  <MicOff className=\"h-5 w-5\" />\r\n                ) : (\r\n                  <Mic className=\"h-5 w-5 text-muted-foreground group-hover:text-foreground transition-colors\" />\r\n                )}\r\n              </button>\r\n            )}\r\n            \r\n            <input\r\n              value={input}\r\n              onChange={(e) => setInput(e.target.value)}\r\n              onKeyDown={handleKeyDown}\r\n              placeholder={\r\n                isListening\r\n                  ? i18n.language === \"zh\"\r\n                    ? \"正在聆听...\"\r\n                    : i18n.language === \"pt\"\r\n                    ? \"Ouvindo...\"\r\n                    : \"Listening...\"\r\n                  : getPlaceholder()\r\n              }\r\n              disabled={isLoading}\r\n              className=\"flex-1 bg-transparent border-0 outline-none text-sm text-foreground placeholder:text-muted-foreground group-hover:placeholder:text-foreground/60 transition-colors\"\r\n              autoFocus\r\n            />\r\n            <button\r\n              onClick={handleSubmit}\r\n              disabled={!input.trim() || isLoading}\r\n              className={cn(\r\n                \"shrink-0 transition-all duration-200\",\r\n                input.trim() && !isLoading \r\n                  ? \"text-primary hover:text-primary/80\" \r\n                  : \"text-muted-foreground/60\"\r\n              )}\r\n            >\r\n              {isLoading ? (\r\n                <Loader2 className=\"h-5 w-5 animate-spin\" />\r\n              ) : (\r\n                <Send className=\"h-5 w-5\" />\r\n              )}\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Location Permission Dialog */}\r\n        <LocationPermissionDialog\r\n          open={showLocationDialog}\r\n          onOpenChange={(open) => {\r\n            setShowLocationDialog(open);\r\n            if (!open && pendingMessage) {\r\n              // User cancelled, still process message without location\r\n              processMessage(pendingMessage);\r\n              setPendingMessage(null);\r\n            }\r\n          }}\r\n          onConfirm={handleLocationConfirm}\r\n        />\r\n\r\n        {/* External Link Confirm Dialog */}\r\n        <ExternalLinkConfirmDialog\r\n          open={externalLinkDialogOpen}\r\n          onOpenChange={setExternalLinkDialogOpen}\r\n          onConfirm={confirmExternalLink}\r\n          url={pendingExternalLink || undefined}\r\n        />\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default AskXiaoxiongDialog;\r\n","import { useState, useEffect, useRef } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\r\nimport { Navigation, Maximize, Minimize, MapPin, Star, MoreHorizontal, Filter, ChevronUp, ChevronDown } from \"lucide-react\";\r\nimport { useRestaurants, useRestaurantTypes } from \"@/hooks/useRestaurants\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { calculateDistance, getUserLocation } from \"@/lib/geolocation\";\r\nimport RestaurantMap from \"@/components/RestaurantMap\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { useLocalizedContent } from \"@/hooks/useLocalizedContent\";\r\nimport mapboxgl from \"mapbox-gl\";\r\nimport { useActivities } from \"@/hooks/useActivities\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useActivityRestaurantCounts } from \"@/hooks/useActivityRestaurantCounts\";\r\nimport logoIcon from \"@/assets/xiaoxiong-logo-clean.png\";\r\nimport LocationPermissionDialog from \"@/components/LocationPermissionDialog\";\r\n\r\nconst MapRestaurantTags = ({ restaurant, language }: { \r\n  restaurant: any; \r\n  language: string;\r\n}) => {\r\n  const [visibleCount, setVisibleCount] = useState(999);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  \r\n  const allTags = restaurant.type.slice(0, 3).map((type: string, idx: number) => ({ \r\n    key: `type-${idx}`, \r\n    label: type, \r\n    variant: \"secondary\" as const,\r\n    color: undefined \r\n  }));\r\n  \r\n  useEffect(() => {\r\n    const checkOverflow = () => {\r\n      if (!containerRef.current) return;\r\n      \r\n      const container = containerRef.current;\r\n      const badges = Array.from(container.querySelectorAll('.tag-badge')) as HTMLElement[];\r\n      \r\n      if (badges.length === 0) {\r\n        setTimeout(checkOverflow, 50);\r\n        return;\r\n      }\r\n      \r\n      const firstBadgeTop = badges[0]?.offsetTop;\r\n      let lastVisibleIndex = badges.length;\r\n      \r\n      for (let i = 0; i < badges.length; i++) {\r\n        if (badges[i].offsetTop > firstBadgeTop) {\r\n          lastVisibleIndex = i;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      if (lastVisibleIndex < badges.length) {\r\n        lastVisibleIndex = Math.max(1, lastVisibleIndex - 1);\r\n      }\r\n      \r\n      setVisibleCount(lastVisibleIndex);\r\n    };\r\n    \r\n    setVisibleCount(999);\r\n    const timer = setTimeout(checkOverflow, 100);\r\n    \r\n    window.addEventListener('resize', checkOverflow);\r\n    return () => {\r\n      clearTimeout(timer);\r\n      window.removeEventListener('resize', checkOverflow);\r\n    };\r\n  }, [allTags.length, restaurant.id]);\r\n  \r\n  const visibleTags = allTags.slice(0, visibleCount);\r\n  const hasMore = allTags.length > visibleCount;\r\n  \r\n  return (\r\n    <div className=\"flex items-center gap-2\">\r\n      <div ref={containerRef} className=\"flex gap-1.5 flex-wrap flex-1\">\r\n        {visibleTags.map((tag) => (\r\n          <Badge \r\n            key={tag.key} \r\n            variant={tag.variant}\r\n            className=\"text-xs font-medium whitespace-nowrap tag-badge\"\r\n            style={tag.color ? { backgroundColor: tag.color, color: 'white' } : undefined}\r\n          >\r\n            {tag.label}\r\n          </Badge>\r\n        ))}\r\n      </div>\r\n      {hasMore && (\r\n        <Popover>\r\n          <PopoverTrigger asChild>\r\n            <Button variant=\"ghost\" size=\"sm\" className=\"h-6 px-2 text-muted-foreground hover:text-foreground flex-shrink-0\">\r\n              <MoreHorizontal className=\"h-4 w-4\" />\r\n            </Button>\r\n          </PopoverTrigger>\r\n          <PopoverContent className=\"w-80\">\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {allTags.map((tag) => (\r\n                <Badge \r\n                  key={tag.key} \r\n                  variant={tag.variant}\r\n                  className=\"text-xs font-medium\"\r\n                  style={tag.color ? { backgroundColor: tag.color, color: 'white' } : undefined}\r\n                >\r\n                  {tag.label}\r\n                </Badge>\r\n              ))}\r\n            </div>\r\n          </PopoverContent>\r\n        </Popover>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst HomeMapSection = () => {\r\n  const navigate = useNavigate();\r\n  const { t, i18n } = useTranslation();\r\n  const { toast } = useToast();\r\n  const { localizeRestaurant } = useLocalizedContent();\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [selectedTypes, setSelectedTypes] = useState<string[]>([]);\r\n  const [selectedActivity, setSelectedActivity] = useState<string | null>(null);\r\n  const [activityRestaurantIds, setActivityRestaurantIds] = useState<string[]>([]);\r\n  const [radiusFilter, setRadiusFilter] = useState<number | null>(null);\r\n  const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);\r\n  const [isFullscreen, setIsFullscreen] = useState(false);\r\n  const [showAllTypes, setShowAllTypes] = useState(false);\r\n  const [showAllActivities, setShowAllActivities] = useState(false);\r\n  const mapRef = useRef<mapboxgl.Map | null>(null);\r\n  const savedMapState = useRef<{ center: [number, number]; zoom: number } | null>(null);\r\n  const restaurantRefs = useRef<{ [key: string]: HTMLDivElement | null }>({});\r\n  const [selectedRestaurantId, setSelectedRestaurantId] = useState<string | null>(null);\r\n  const [showFilters, setShowFilters] = useState(false);\r\n  const [showLocationDialog, setShowLocationDialog] = useState(false);\r\n  const [isMapCollapsed, setIsMapCollapsed] = useState(false);\r\n  const [isMobileListExpanded, setIsMobileListExpanded] = useState(false);\r\n\r\n  const MOBILE_DEFAULT_VISIBLE = 4;\r\n\r\n  const { data: restaurants, isLoading } = useRestaurants(searchQuery, selectedTypes.length > 0 ? selectedTypes.join(',') : undefined);\r\n  const { data: restaurantTypes = [] } = useRestaurantTypes();\r\n  const { data: activities = [] } = useActivities();\r\n  const { data: activityRestaurantCounts = {} } = useActivityRestaurantCounts();\r\n\r\n  const activitiesWithRestaurants = activities.filter(activity => (activityRestaurantCounts[activity.id] || 0) > 0);\r\n\r\n  const handleTypeFilter = (type: string) => {\r\n    setSelectedTypes(prev => {\r\n      if (prev.includes(type)) {\r\n        return prev.filter(t => t !== type);\r\n      } else {\r\n        return [...prev, type];\r\n      }\r\n    });\r\n  };\r\n\r\n  const handleRequestLocation = () => {\r\n    setShowLocationDialog(true);\r\n  };\r\n\r\n  const requestLocation = async () => {\r\n    setShowLocationDialog(false);\r\n    try {\r\n      const position = await getUserLocation();\r\n      setUserLocation({\r\n        lat: position.coords.latitude,\r\n        lng: position.coords.longitude,\r\n      });\r\n      toast({\r\n        title: t(\"restaurants.locationEnabled\"),\r\n        description: t(\"restaurants.sortByDistance\"),\r\n      });\r\n    } catch (error: any) {\r\n      console.error(\"Location error:\", error);\r\n    }\r\n  };\r\n\r\n  const handleRadiusChange = (radius: number | null) => {\r\n    setRadiusFilter(radius);\r\n    if (radius && !userLocation) {\r\n      handleRequestLocation();\r\n    }\r\n  };\r\n\r\n  const handleActivityFilter = async (activityId: string) => {\r\n    if (selectedActivity === activityId) {\r\n      setSelectedActivity(null);\r\n      setActivityRestaurantIds([]);\r\n    } else {\r\n      setSelectedActivity(activityId);\r\n      const { data, error } = await supabase\r\n        .from(\"activity_restaurants\")\r\n        .select(\"restaurant_id\")\r\n        .eq(\"activity_id\", activityId);\r\n      \r\n      if (error) {\r\n        console.error(\"Error fetching activity restaurants:\", error);\r\n        setActivityRestaurantIds([]);\r\n      } else {\r\n        setActivityRestaurantIds(data.map(ar => ar.restaurant_id));\r\n      }\r\n    }\r\n  };\r\n\r\n  const processedRestaurants = restaurants?.map(restaurant => {\r\n    const localized = localizeRestaurant(restaurant);\r\n    if (userLocation) {\r\n      const distance = calculateDistance(\r\n        userLocation.lat,\r\n        userLocation.lng,\r\n        restaurant.lat,\r\n        restaurant.lng\r\n      );\r\n      return { ...localized, distance };\r\n    }\r\n    return localized;\r\n  }) || [];\r\n\r\n  const activityFilteredRestaurants = selectedActivity \r\n    ? processedRestaurants.filter(r => activityRestaurantIds.includes(r.id)) \r\n    : processedRestaurants;\r\n\r\n  const filteredRestaurants = radiusFilter && userLocation\r\n    ? activityFilteredRestaurants\r\n        .filter(r => r.distance && r.distance <= radiusFilter)\r\n        .sort((a, b) => (a.distance || 0) - (b.distance || 0))\r\n    : userLocation \r\n      ? activityFilteredRestaurants.sort((a, b) => (a.distance || 0) - (b.distance || 0))\r\n      : activityFilteredRestaurants.sort((a, b) => (b.rating || 0) - (a.rating || 0));\r\n\r\n  const handleRestaurantClick = (restaurant: any) => {\r\n    navigate(`/restaurant/${restaurant.id}`);\r\n  };\r\n\r\n  const handleMarkerClick = (restaurant: any) => {\r\n    setSelectedRestaurantId(restaurant.id);\r\n    \r\n    const restaurantElement = restaurantRefs.current[restaurant.id];\r\n    if (restaurantElement) {\r\n      restaurantElement.scrollIntoView({ \r\n        behavior: 'smooth', \r\n        block: 'center'\r\n      });\r\n    }\r\n  };\r\n\r\n  const toggleFullscreen = () => {\r\n    const mapContainer = document.getElementById('home-map-container');\r\n    if (!mapContainer) return;\r\n\r\n    if (!isFullscreen) {\r\n      if (mapRef.current) {\r\n        const center = mapRef.current.getCenter();\r\n        const zoom = mapRef.current.getZoom();\r\n        savedMapState.current = { center: [center.lng, center.lat], zoom };\r\n      }\r\n      if (mapContainer.requestFullscreen) {\r\n        mapContainer.requestFullscreen();\r\n      }\r\n    } else {\r\n      if (document.exitFullscreen) {\r\n        document.exitFullscreen();\r\n      }\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const handleFullscreenChange = () => {\r\n      const isNowFullscreen = !!document.fullscreenElement;\r\n      setIsFullscreen(isNowFullscreen);\r\n      \r\n      if (!isNowFullscreen && savedMapState.current && mapRef.current) {\r\n        setTimeout(() => {\r\n          mapRef.current?.jumpTo({\r\n            center: savedMapState.current!.center,\r\n            zoom: savedMapState.current!.zoom,\r\n          });\r\n        }, 100);\r\n      }\r\n    };\r\n\r\n    document.addEventListener('fullscreenchange', handleFullscreenChange);\r\n    return () => {\r\n      document.removeEventListener('fullscreenchange', handleFullscreenChange);\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"animate-fade-in\">\r\n      {/* Header - Left aligned */}\r\n      <div className=\"text-left mb-6\">\r\n        <h2 className=\"text-xl sm:text-2xl font-bold text-foreground mb-2 sm:mb-3\">\r\n          {t(\"nav.mapView\")}\r\n        </h2>\r\n        <p className=\"text-sm sm:text-base text-muted-foreground\">{t(\"map.subtitle\")}</p>\r\n      </div>\r\n        \r\n      {/* Search and Filters - Left aligned */}\r\n      <div className=\"mb-6 space-y-4\">\r\n        <div className=\"flex flex-col md:flex-row gap-3\">\r\n          <div className=\"flex-1 max-w-md\">\r\n            <Input\r\n              placeholder={t(\"restaurants.search\")}\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              className=\"h-11 bg-background/60 backdrop-blur-sm border-primary/20 focus:border-primary\"\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"flex gap-2 md:contents\">\r\n            <Button\r\n              variant={userLocation ? \"default\" : \"outline\"}\r\n              onClick={userLocation ? undefined : handleRequestLocation}\r\n              className=\"flex-1 md:flex-initial gap-2 h-11 md:px-6\"\r\n            >\r\n              <Navigation className={`w-4 h-4 ${userLocation ? 'animate-pulse' : ''}`} />\r\n              <span className=\"md:hidden\">{t(\"restaurants.getLocationMobile\")}</span>\r\n              <span className=\"hidden md:inline\">{userLocation ? t(\"restaurants.locationEnabled\") : t(\"restaurants.getLocation\")}</span>\r\n            </Button>\r\n\r\n            <Button\r\n              variant={showFilters ? \"default\" : \"outline\"}\r\n              onClick={() => setShowFilters(!showFilters)}\r\n              className=\"flex-1 md:flex-initial gap-2 h-11 md:px-6\"\r\n            >\r\n              <Filter className=\"w-4 h-4\" />\r\n              {t(\"restaurants.filter\")}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Filters Container */}\r\n        {showFilters && (\r\n          <div className=\"space-y-3 bg-card/50 backdrop-blur-sm rounded-lg p-4 border border-border/50 animate-fade-in\">\r\n            {/* Type Filters Section */}\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center gap-2 flex-wrap\">\r\n                <span className=\"text-sm font-semibold text-foreground\">{t(\"restaurants.restaurantTypes\")}:</span>\r\n                {selectedTypes.length > 0 && (\r\n                  <Badge\r\n                    variant=\"outline\"\r\n                    className=\"cursor-pointer hover:bg-destructive hover:text-destructive-foreground hover:scale-105 transition-all duration-200 px-2 py-0 text-xs h-5\"\r\n                    onClick={() => setSelectedTypes([])}>\r\n                    {t(\"common.actions.clearFilter\")}\r\n                  </Badge>\r\n                )}\r\n                {restaurantTypes.length > 8 && (\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"h-5 px-2 text-xs text-primary hover:text-primary/80 ml-auto hidden sm:flex transition-all duration-200\"\r\n                    onClick={() => setShowAllTypes(!showAllTypes)}\r\n                  >\r\n                    {showAllTypes ? t(\"common.showLess\") : t(\"common.showMore\")}\r\n                  </Button>\r\n                )}\r\n              </div>\r\n              <div className=\"relative overflow-hidden\">\r\n                <div className={`hidden sm:flex gap-2 flex-wrap transition-all duration-300 ease-out ${showAllTypes ? 'animate-expand-height' : ''}`}>\r\n                  {(showAllTypes ? restaurantTypes : restaurantTypes.slice(0, 8)).map((type, index) => (\r\n                    <Badge\r\n                      key={type}\r\n                      variant={selectedTypes.includes(type) ? \"default\" : \"secondary\"}\r\n                      className={`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap hover:scale-105 active:animate-tag-select ${selectedTypes.includes(type) ? 'ring-2 ring-primary/30 shadow-sm' : ''}`}\r\n                      style={{ animationDelay: `${index * 30}ms` }}\r\n                      onClick={() => handleTypeFilter(type)}\r\n                    >\r\n                      {type}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n                <div className=\"sm:hidden relative -mx-1 px-1\">\r\n                  <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory scroll-smooth\">\r\n                    {restaurantTypes.map((type, index) => (\r\n                      <Badge\r\n                        key={type}\r\n                        variant={selectedTypes.includes(type) ? \"default\" : \"secondary\"}\r\n                        className={`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap flex-shrink-0 snap-start hover:scale-105 active:animate-tag-select ${selectedTypes.includes(type) ? 'ring-2 ring-primary/30 shadow-sm' : ''}`}\r\n                        style={{ animationDelay: `${index * 30}ms` }}\r\n                        onClick={() => handleTypeFilter(type)}\r\n                      >\r\n                        {type}\r\n                      </Badge>\r\n                    ))}\r\n                  </div>\r\n                  <div className=\"absolute left-0 top-0 bottom-2 w-4 bg-gradient-to-r from-card via-card/60 to-transparent pointer-events-none\" />\r\n                  <div className=\"absolute right-0 top-0 bottom-2 w-4 bg-gradient-to-l from-card via-card/60 to-transparent pointer-events-none\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Activity Filters Section */}\r\n            {activitiesWithRestaurants.length > 0 && (\r\n              <div className=\"space-y-2 pt-1 border-t border-border/30\">\r\n                <div className=\"flex items-center gap-2 flex-wrap\">\r\n                  <span className=\"text-sm font-semibold text-foreground\">{t(\"nav.activities\")}:</span>\r\n                  {selectedActivity && (\r\n                    <Badge\r\n                      variant=\"outline\"\r\n                      className=\"cursor-pointer hover:bg-destructive hover:text-destructive-foreground hover:scale-105 transition-all duration-200 px-2 py-0 text-xs h-5\"\r\n                      onClick={() => {\r\n                        setSelectedActivity(null);\r\n                        setActivityRestaurantIds([]);\r\n                      }}>\r\n                      {t(\"common.actions.clearFilter\")}\r\n                    </Badge>\r\n                  )}\r\n                  {activitiesWithRestaurants.length > 8 && (\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      className=\"h-5 px-2 text-xs text-primary hover:text-primary/80 ml-auto hidden sm:flex transition-all duration-200\"\r\n                      onClick={() => setShowAllActivities(!showAllActivities)}\r\n                    >\r\n                      {showAllActivities ? t(\"common.showLess\") : t(\"common.showMore\")}\r\n                    </Button>\r\n                  )}\r\n                </div>\r\n                <div className=\"relative overflow-hidden\">\r\n                  <div className={`hidden sm:flex gap-2 flex-wrap transition-all duration-300 ease-out ${showAllActivities ? 'animate-expand-height' : ''}`}>\r\n                    {(showAllActivities ? activitiesWithRestaurants : activitiesWithRestaurants.slice(0, 8)).map((activity, index) => {\r\n                      const activityLabel = i18n.language === 'zh' \r\n                        ? (activity.badge_text_zh || activity.title_zh)\r\n                        : i18n.language === 'pt' \r\n                        ? (activity.badge_text_pt || activity.title_pt)\r\n                        : (activity.badge_text_en || activity.title_en);\r\n                      return (\r\n                        <Badge\r\n                          key={activity.id}\r\n                          variant={selectedActivity === activity.id ? \"default\" : \"secondary\"}\r\n                          className={`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap hover:scale-105 active:animate-tag-select ${selectedActivity === activity.id ? 'ring-2 ring-primary/30 shadow-sm' : ''}`}\r\n                          style={{ animationDelay: `${index * 30}ms` }}\r\n                          onClick={() => handleActivityFilter(activity.id)}\r\n                        >\r\n                          {activityLabel}\r\n                        </Badge>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                  <div className=\"sm:hidden relative -mx-1 px-1\">\r\n                    <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory scroll-smooth\">\r\n                      {activitiesWithRestaurants.map((activity, index) => {\r\n                        const activityLabel = i18n.language === 'zh' \r\n                          ? (activity.badge_text_zh || activity.title_zh)\r\n                          : i18n.language === 'pt' \r\n                          ? (activity.badge_text_pt || activity.title_pt)\r\n                          : (activity.badge_text_en || activity.title_en);\r\n                        return (\r\n                          <Badge\r\n                            key={activity.id}\r\n                            variant={selectedActivity === activity.id ? \"default\" : \"secondary\"}\r\n                            className={`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap flex-shrink-0 snap-start hover:scale-105 active:animate-tag-select ${selectedActivity === activity.id ? 'ring-2 ring-primary/30 shadow-sm' : ''}`}\r\n                            style={{ animationDelay: `${index * 30}ms` }}\r\n                            onClick={() => handleActivityFilter(activity.id)}\r\n                          >\r\n                            {activityLabel}\r\n                          </Badge>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                    <div className=\"absolute left-0 top-0 bottom-2 w-4 bg-gradient-to-r from-card via-card/60 to-transparent pointer-events-none\" />\r\n                    <div className=\"absolute right-0 top-0 bottom-2 w-4 bg-gradient-to-l from-card via-card/60 to-transparent pointer-events-none\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Radius Filter */}\r\n        {userLocation && (\r\n          <div className=\"flex gap-2 flex-wrap items-center bg-muted/30 backdrop-blur-sm rounded-lg p-3 border border-primary/10\">\r\n            <span className=\"text-sm font-semibold text-primary\">{t(\"restaurants.radius\")}:</span>\r\n            <Badge\r\n              variant={radiusFilter === null ? \"default\" : \"secondary\"}\r\n              className=\"cursor-pointer hover:scale-105 transition-transform\"\r\n              onClick={() => handleRadiusChange(null)}\r\n            >\r\n              {t(\"restaurants.allRestaurants\")}\r\n            </Badge>\r\n            <Badge\r\n              variant={radiusFilter === 5 ? \"default\" : \"secondary\"}\r\n              className=\"cursor-pointer hover:scale-105 transition-transform\"\r\n              onClick={() => handleRadiusChange(5)}\r\n            >\r\n              {t(\"restaurants.radius5km\")}\r\n            </Badge>\r\n            <Badge\r\n              variant={radiusFilter === 10 ? \"default\" : \"secondary\"}\r\n              className=\"cursor-pointer hover:scale-105 transition-transform\"\r\n              onClick={() => handleRadiusChange(10)}\r\n            >\r\n              {t(\"restaurants.radius10km\")}\r\n            </Badge>\r\n            <Badge\r\n              variant={radiusFilter === 20 ? \"default\" : \"secondary\"}\r\n              className=\"cursor-pointer hover:scale-105 transition-transform\"\r\n              onClick={() => handleRadiusChange(20)}\r\n            >\r\n              {t(\"restaurants.radius20km\")}\r\n            </Badge>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Map and List Layout */}\r\n      {!isLoading && filteredRestaurants && (\r\n        <div className=\"flex flex-col lg:flex-row gap-6\">\r\n          {/* Map */}\r\n          <div className={`w-full lg:flex-1 transition-all duration-300 ease-in-out ${isMapCollapsed ? 'h-0 overflow-hidden lg:h-[500px]' : 'h-[400px] lg:h-[500px]'}`}>\r\n            <div id=\"home-map-container\" className={`${isFullscreen ? 'fixed inset-0 z-50 bg-background' : 'w-full h-full'} rounded-xl overflow-hidden shadow-2xl border border-primary/10 relative group`}>\r\n              <Button\r\n                variant=\"secondary\"\r\n                size=\"icon\"\r\n                className=\"absolute bottom-4 right-4 z-10 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                onClick={toggleFullscreen}\r\n              >\r\n                {isFullscreen ? (\r\n                  <Minimize className=\"w-5 h-5\" />\r\n                ) : (\r\n                  <Maximize className=\"w-5 h-5\" />\r\n                )}\r\n              </Button>\r\n              <div className=\"h-full relative\">\r\n                <RestaurantMap\r\n                  restaurants={filteredRestaurants}\r\n                  onRestaurantClick={handleRestaurantClick}\r\n                  userLocation={userLocation}\r\n                  radiusFilter={radiusFilter}\r\n                  onMarkerClick={handleMarkerClick}\r\n                  showViewDetailsButton={true}\r\n                  onMapInit={(mapInstance) => {\r\n                    mapRef.current = mapInstance;\r\n                  }}\r\n                />\r\n                <div className=\"absolute bottom-4 left-4 z-10 pointer-events-none flex items-center gap-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg\">\r\n                  <img \r\n                    src={logoIcon} \r\n                    alt=\"Xiaoxiong Market Logo\" \r\n                    className=\"h-6 w-6 object-contain\"\r\n                  />\r\n                  <span className=\"text-sm font-semibold text-foreground whitespace-nowrap\">\r\n                    {i18n.language === 'zh' ? '小熊市场' : 'Xiaoxiong Market'}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Mobile Map Toggle Button */}\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            className=\"lg:hidden flex items-center justify-center gap-2 -mt-3 mb-1\"\r\n            onClick={() => setIsMapCollapsed(!isMapCollapsed)}\r\n          >\r\n            {isMapCollapsed ? (\r\n              <>\r\n                <ChevronDown className=\"w-4 h-4\" />\r\n                {t(\"map.showMap\")}\r\n              </>\r\n            ) : (\r\n              <>\r\n                <ChevronUp className=\"w-4 h-4\" />\r\n                {t(\"map.hideMap\")}\r\n              </>\r\n            )}\r\n          </Button>\r\n\r\n          {/* Restaurant List Sidebar */}\r\n          <div className=\"w-full lg:w-[420px] flex flex-col\">\r\n            <div className=\"mb-4 pb-4 border-b border-border\">\r\n              <h2 className=\"text-xl sm:text-2xl font-bold text-foreground flex items-center gap-2\">\r\n                <MapPin className=\"w-6 h-6 text-primary\" />\r\n                {t(\"restaurants.title\")}\r\n                <Badge variant=\"secondary\" className=\"ml-2\">{filteredRestaurants.length}</Badge>\r\n              </h2>\r\n              {userLocation && (\r\n                <p className=\"text-sm text-muted-foreground mt-2 flex items-center gap-1.5\">\r\n                  <Navigation className=\"w-4 h-4\" />\r\n                  {t(\"restaurants.sortedByDistance\")}\r\n                </p>\r\n              )}\r\n            </div>\r\n            \r\n            {filteredRestaurants.length === 0 ? (\r\n              <div className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n                <MapPin className=\"w-16 h-16 text-muted-foreground/40 mb-4\" />\r\n                <h3 className=\"text-xl font-semibold text-foreground mb-2\">\r\n                  {t(\"restaurants.noResults\")}\r\n                </h3>\r\n                <p className=\"text-muted-foreground max-w-xs\">\r\n                  {t(\"restaurants.noResultsDesc\")}\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <>\r\n                <div className=\"lg:hidden space-y-3 pb-4\">\r\n                  {(isMobileListExpanded \r\n                    ? filteredRestaurants \r\n                    : filteredRestaurants.slice(0, MOBILE_DEFAULT_VISIBLE)\r\n                  ).map((restaurant) => (\r\n                    <Card\r\n                      key={restaurant.id}\r\n                      ref={(el) => restaurantRefs.current[restaurant.id] = el}\r\n                      className={`p-5 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-primary/40 border-2 bg-gradient-to-br from-card to-card/50 backdrop-blur-sm ${\r\n                        selectedRestaurantId === restaurant.id \r\n                          ? 'border-primary ring-2 ring-primary ring-offset-2' \r\n                          : 'border-transparent'\r\n                      }`}\r\n                      onClick={() => handleRestaurantClick(restaurant)}\r\n                    >\r\n                      <div className=\"flex flex-col gap-3\">\r\n                        <div className=\"flex items-start justify-between gap-2\">\r\n                          <div className=\"flex flex-col gap-2\">\r\n                            <h3 className=\"font-bold text-lg text-foreground line-clamp-1 flex-1\">\r\n                              {restaurant.name}\r\n                            </h3>\r\n                            {restaurant.distance !== undefined && (\r\n                              <div className=\"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full w-fit\">\r\n                                <Navigation className=\"w-4 h-4 text-primary\" />\r\n                                <span className=\"font-bold text-sm text-primary\">\r\n                                  {restaurant.distance < 1 \r\n                                    ? `${(restaurant.distance * 1000).toFixed(0)} m` \r\n                                    : `${restaurant.distance.toFixed(1)} km`}\r\n                                </span>\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                          {restaurant.rating > 0 && (\r\n                            <div className=\"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full flex-shrink-0\">\r\n                              <Star className=\"w-4 h-4\" style={{ fill: '#016450', color: '#016450' }} />\r\n                              <span className=\"font-bold text-sm text-primary\">{restaurant.rating}</span>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        \r\n                        {restaurant.type && restaurant.type.length > 0 && (\r\n                          <MapRestaurantTags \r\n                            restaurant={restaurant} \r\n                            language={i18n.language}\r\n                          />\r\n                        )}\r\n                        \r\n                        <div className=\"flex items-start gap-2 text-sm text-muted-foreground\">\r\n                          <MapPin className=\"w-4 h-4 mt-0.5 flex-shrink-0 text-primary/60\" />\r\n                          <span className=\"line-clamp-2\">{restaurant.address}</span>\r\n                        </div>\r\n                      </div>\r\n                    </Card>\r\n                  ))}\r\n                  \r\n                  {filteredRestaurants.length > MOBILE_DEFAULT_VISIBLE && (\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"w-full mt-2 gap-2\"\r\n                      onClick={() => setIsMobileListExpanded(!isMobileListExpanded)}\r\n                    >\r\n                      {isMobileListExpanded ? (\r\n                        <>\r\n                          <ChevronUp className=\"w-4 h-4\" />\r\n                          {t(\"map.collapseList\")}\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <ChevronDown className=\"w-4 h-4\" />\r\n                          {t(\"map.showAllRestaurants\", { count: filteredRestaurants.length })}\r\n                        </>\r\n                      )}\r\n                    </Button>\r\n                  )}\r\n                </div>\r\n                \r\n                <ScrollArea className=\"hidden lg:block h-[420px] pr-4\">\r\n                  <div className=\"space-y-3 pb-4\">\r\n                    {filteredRestaurants.map((restaurant) => (\r\n                      <Card\r\n                        key={restaurant.id}\r\n                        ref={(el) => restaurantRefs.current[restaurant.id] = el}\r\n                        className={`p-5 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-primary/40 border-2 bg-gradient-to-br from-card to-card/50 backdrop-blur-sm ${\r\n                          selectedRestaurantId === restaurant.id \r\n                            ? 'border-primary ring-2 ring-primary ring-offset-2' \r\n                            : 'border-transparent'\r\n                        }`}\r\n                        onClick={() => handleRestaurantClick(restaurant)}\r\n                      >\r\n                        <div className=\"flex flex-col gap-3\">\r\n                          <div className=\"flex items-start justify-between gap-2\">\r\n                            <div className=\"flex flex-col gap-2\">\r\n                              <h3 className=\"font-bold text-lg text-foreground line-clamp-1 flex-1\">\r\n                                {restaurant.name}\r\n                              </h3>\r\n                              {restaurant.distance !== undefined && (\r\n                                <div className=\"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full w-fit\">\r\n                                  <Navigation className=\"w-4 h-4 text-primary\" />\r\n                                  <span className=\"font-bold text-sm text-primary\">\r\n                                    {restaurant.distance < 1 \r\n                                      ? `${(restaurant.distance * 1000).toFixed(0)} m` \r\n                                      : `${restaurant.distance.toFixed(1)} km`}\r\n                                  </span>\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                            {restaurant.rating > 0 && (\r\n                              <div className=\"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full flex-shrink-0\">\r\n                                <Star className=\"w-4 h-4\" style={{ fill: '#016450', color: '#016450' }} />\r\n                                <span className=\"font-bold text-sm text-primary\">{restaurant.rating}</span>\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        \r\n                          {restaurant.type && restaurant.type.length > 0 && (\r\n                            <MapRestaurantTags \r\n                              restaurant={restaurant} \r\n                              language={i18n.language}\r\n                            />\r\n                          )}\r\n                          \r\n                          <div className=\"flex items-start gap-2 text-sm text-muted-foreground\">\r\n                            <MapPin className=\"w-4 h-4 mt-0.5 flex-shrink-0 text-primary/60\" />\r\n                            <span className=\"line-clamp-2\">{restaurant.address}</span>\r\n                          </div>\r\n                        </div>\r\n                      </Card>\r\n                    ))}\r\n                  </div>\r\n                </ScrollArea>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <LocationPermissionDialog\r\n        open={showLocationDialog}\r\n        onOpenChange={setShowLocationDialog}\r\n        onConfirm={requestLocation}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default HomeMapSection;\r\n","import { memo, useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link } from \"react-router-dom\";\r\nimport { ShoppingBag, CalendarCheck, MessageCircle, Search, Info } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport mapIcon from \"@/assets/map-icon.png\";\r\nimport { useActiveHomepageTemplates } from \"@/hooks/useHomepageTemplates\";\r\nimport { useNavigationSettings } from \"@/hooks/useNavigationSettings\";\r\nimport { useSiteSettings } from \"@/hooks/useSiteSettings\";\r\nimport { openExternalUrl } from \"@/lib/externalLinks\";\r\nimport ExternalLinkConfirmDialog from \"@/components/ExternalLinkConfirmDialog\";\r\n\r\ninterface MobileHeroSectionProps {\r\n  stats: { order_count: number; reserve_count: number } | null;\r\n  onAskXiaoxiong: () => void;\r\n}\r\n\r\nconst MobileHeroSection = memo(({ stats, onAskXiaoxiong }: MobileHeroSectionProps) => {\r\n  const { t, i18n } = useTranslation();\r\n  const { data: templates } = useActiveHomepageTemplates();\r\n  const { buttons } = useNavigationSettings();\r\n  const { settings } = useSiteSettings();\r\n  const currentLang = i18n.language;\r\n  \r\n  // State for external link confirmation dialog\r\n  const [showExternalLinkDialog, setShowExternalLinkDialog] = useState(false);\r\n  \r\n  // Check if About Us button should be shown\r\n  const showAboutUsButton = settings?.about_us_button_mobile !== false;\r\n\r\n  // Find demo button from navigation settings\r\n  const demoButton = buttons?.find(\r\n    (btn) => btn.label_zh === \"演示\" || btn.link?.includes(\"v.xiaoxiong.pt\")\r\n  );\r\n\r\n  // Check if demo button should be shown\r\n  const showDemoButton = demoButton && \r\n    demoButton.enabled !== false && \r\n    demoButton.visible !== false && \r\n    demoButton.show_on_mobile !== false;\r\n\r\n  // Get localized demo button label\r\n  const getDemoLabel = () => {\r\n    if (!demoButton) return t(\"home.hero.demo\", \"前往演示\");\r\n    if (currentLang === \"zh\") return demoButton.label_zh;\r\n    if (currentLang === \"pt\") return demoButton.label_pt;\r\n    return demoButton.label_en;\r\n  };\r\n\r\n  // Get localized text from active template\r\n  const getLocalizedText = (field: string) => {\r\n    if (!templates || templates.length === 0) return \"\";\r\n    const template = templates[0];\r\n    const langSuffix = currentLang === \"zh\" ? \"_zh\" : currentLang === \"pt\" ? \"_pt\" : \"_en\";\r\n    return (template as any)[`${field}${langSuffix}`] || \"\";\r\n  };\r\n\r\n  const title = getLocalizedText(\"title\") || t(\"home.hero.title\");\r\n  const description = getLocalizedText(\"description\") || t(\"home.hero.description\");\r\n  const chatButtonText = getLocalizedText(\"subtitle_button_text\") || t(\"home.hero.subtitle\");\r\n\r\n  // Handle demo button click - show confirmation dialog\r\n  const handleDemoClick = () => {\r\n    setShowExternalLinkDialog(true);\r\n  };\r\n\r\n  // Handle confirmation - open external URL with iOS WebView compatibility\r\n  const handleConfirmExternalLink = () => {\r\n    if (demoButton?.link) {\r\n      openExternalUrl(demoButton.link);\r\n    }\r\n    setShowExternalLinkDialog(false);\r\n  };\r\n\r\n  return (\r\n    <section className=\"min-h-[55vh] flex flex-col bg-secondary/20\">\r\n      {/* Header Area - Brand + Demo Button */}\r\n      <div className=\"pt-20 px-4\">\r\n        {/* Top Row: Brand Name + Demo Button */}\r\n        <div className=\"flex items-center justify-between mb-3\">\r\n          {/* Brand Name with Icon */}\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-xl font-bold text-foreground\">\r\n              {t(\"home.hero.brandName\")}\r\n            </span>\r\n            <img \r\n              src={mapIcon} \r\n              alt=\"map icon\" \r\n              width={28}\r\n              height={28}\r\n              loading=\"eager\"\r\n              decoding=\"async\"\r\n              className=\"w-7 h-7 object-contain flex-shrink-0\" \r\n            />\r\n          </div>\r\n\r\n          {/* About Us Button */}\r\n          {showAboutUsButton && (\r\n            <Link\r\n              to=\"/about-us\"\r\n              className=\"flex items-center gap-1.5 px-3 py-1.5 text-sm bg-background/80 backdrop-blur-sm rounded-full border border-border/50 shadow-sm hover:bg-background transition-colors\"\r\n            >\r\n              <Info className=\"w-4 h-4 text-primary\" />\r\n              <span className=\"text-foreground/80\">\r\n                {t(\"nav.aboutUs\", \"关于我们\")}\r\n              </span>\r\n            </Link>\r\n          )}\r\n        </div>\r\n\r\n        {/* Stats Row: Delivery + Booking */}\r\n        {stats && (\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"flex items-center gap-1.5\">\r\n              <ShoppingBag className=\"w-4 h-4 text-primary\" />\r\n              <span className=\"text-sm text-muted-foreground\">{t(\"home.stats.delivery\")}</span>\r\n              <span className=\"font-bold text-foreground text-sm\">{stats.order_count}</span>\r\n            </div>\r\n            <div className=\"flex items-center gap-1.5\">\r\n              <CalendarCheck className=\"w-4 h-4 text-accent\" />\r\n              <span className=\"text-sm text-muted-foreground\">{t(\"home.stats.reservation\")}</span>\r\n              <span className=\"font-bold text-foreground text-sm\">{stats.reserve_count}</span>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Content Area - Title, Description, Chat Button */}\r\n      <div className=\"flex-1 flex flex-col items-center justify-center px-4 py-8\">\r\n        <div className=\"max-w-md mx-auto text-center space-y-4\">\r\n          {/* Title */}\r\n          <h1 className=\"text-2xl sm:text-3xl font-bold text-foreground leading-tight\">\r\n            {title}\r\n          </h1>\r\n          \r\n          {/* Description */}\r\n          <p className=\"text-sm sm:text-base text-muted-foreground max-w-sm mx-auto\">\r\n            {description}\r\n          </p>\r\n          \r\n          {/* Chat Button - Ask Xiaoxiong */}\r\n          <div className=\"pt-4\">\r\n            <button \r\n              onClick={onAskXiaoxiong}\r\n              className=\"group flex items-center gap-3 bg-secondary/50 backdrop-blur-sm text-foreground px-5 py-3.5 rounded-full shadow-sm hover:shadow-md hover:bg-secondary/70 transition-all duration-300 cursor-text border border-border/50 mx-auto\"\r\n            >\r\n              <MessageCircle className=\"w-5 h-5 text-primary group-hover:text-primary/80 transition-colors\" />\r\n              <span className=\"text-sm text-muted-foreground group-hover:text-foreground transition-colors\">\r\n                {chatButtonText}\r\n              </span>\r\n              <Search className=\"w-4 h-4 text-muted-foreground/60 ml-2\" />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* External Link Confirmation Dialog */}\r\n      <ExternalLinkConfirmDialog\r\n        open={showExternalLinkDialog}\r\n        onOpenChange={setShowExternalLinkDialog}\r\n        onConfirm={handleConfirmExternalLink}\r\n        url={demoButton?.link}\r\n      />\r\n    </section>\r\n  );\r\n});\r\n\r\nMobileHeroSection.displayName = \"MobileHeroSection\";\r\n\r\nexport default MobileHeroSection;\r\n","import { useMemo } from \"react\";\r\nimport { useActivities, Activity, ActivityCreator } from \"@/hooks/useActivities\";\r\nimport { addDays, isSameDay, getDay, getDate, getMonth, startOfDay } from \"date-fns\";\r\n\r\n// Extended Activity type with creator\r\ntype ActivityWithExtras = Activity & { creator: ActivityCreator; share_count?: number };\r\n\r\ninterface DateRange {\r\n  start: number;\r\n  end: number;\r\n}\r\n\r\n// Type guard to check if value is a valid DateRange array\r\nconst isDateRangeArray = (value: unknown): value is DateRange[] => {\r\n  if (!value || !Array.isArray(value)) return false;\r\n  return value.every(item => \r\n    typeof item === 'object' && \r\n    item !== null &&\r\n    'start' in item && \r\n    'end' in item &&\r\n    typeof item.start === 'number' &&\r\n    typeof item.end === 'number'\r\n  );\r\n};\r\n\r\n// Check if activity is valid on a specific date\r\nconst isActivityValidOnDate = (activity: ActivityWithExtras, targetDate: Date): boolean => {\r\n  const startDate = startOfDay(new Date(activity.start_date));\r\n  const endDate = activity.end_date ? startOfDay(new Date(activity.end_date)) : null;\r\n  const target = startOfDay(targetDate);\r\n  \r\n  // Check if within valid period\r\n  if (target < startDate) return false;\r\n  if (endDate && target > endDate) return false;\r\n  \r\n  const repeatMode = activity.repeat_mode || \"none\";\r\n  \r\n  switch (repeatMode) {\r\n    case \"none\":\r\n      // Only valid on start date\r\n      return isSameDay(startDate, target);\r\n      \r\n    case \"daily\":\r\n      // Valid every day\r\n      return true;\r\n      \r\n    case \"weekly\":\r\n      // Check weekday (0-6, Sunday = 0)\r\n      const targetWeekday = getDay(target);\r\n      // Need to fetch repeat_weekday from the raw data\r\n      const weekday = (activity as any).repeat_weekday;\r\n      return weekday === targetWeekday;\r\n      \r\n    case \"monthly\":\r\n      // Check day of month ranges\r\n      const targetDayOfMonth = getDate(target);\r\n      const monthRanges = (activity as any).repeat_month_day;\r\n      if (!isDateRangeArray(monthRanges)) return false;\r\n      return monthRanges.some(range => \r\n        targetDayOfMonth >= range.start && targetDayOfMonth <= range.end\r\n      );\r\n      \r\n    case \"yearly\":\r\n      // Check month and day of year\r\n      const targetMonth = getMonth(target) + 1; // 1-12\r\n      const targetDay = getDate(target);\r\n      const yearlyMonth = (activity as any).repeat_yearly_month;\r\n      const yearlyDay = (activity as any).repeat_yearly_day;\r\n      return yearlyMonth === targetMonth && yearlyDay === targetDay;\r\n             \r\n    default:\r\n      return false;\r\n  }\r\n};\r\n\r\n// Get sort weight for activity (lower = higher priority)\r\nconst getActivitySortWeight = (activity: ActivityWithExtras): number => {\r\n  const repeatMode = activity.repeat_mode || \"none\";\r\n  switch (repeatMode) {\r\n    case \"none\": return 0;      // Dated activities first\r\n    case \"weekly\": return 1;\r\n    case \"monthly\": return 2;\r\n    case \"yearly\": return 3;\r\n    case \"daily\": return 4;     // Daily activities last\r\n    default: return 5;\r\n  }\r\n};\r\n\r\nexport interface ActivityWithDayLabel extends ActivityWithExtras {\r\n  dayLabel: \"today\" | \"tomorrow\" | \"dayAfterTomorrow\";\r\n}\r\n\r\nexport const useRecentActivities = () => {\r\n  const { data: activities, isLoading } = useActivities();\r\n  \r\n  const recentActivities = useMemo(() => {\r\n    if (!activities) return { today: [], tomorrow: [], dayAfterTomorrow: [] };\r\n    \r\n    const today = new Date();\r\n    const tomorrow = addDays(today, 1);\r\n    const dayAfterTomorrow = addDays(today, 2);\r\n    \r\n    const filterAndSort = (date: Date): ActivityWithExtras[] => {\r\n      return activities\r\n        .filter(a => a.visible && a.status === \"published\")\r\n        .filter(a => isActivityValidOnDate(a, date))\r\n        .sort((a, b) => {\r\n          // Sort by type weight first\r\n          const weightDiff = getActivitySortWeight(a) - getActivitySortWeight(b);\r\n          if (weightDiff !== 0) return weightDiff;\r\n          \r\n          // Then by pinned and sort_order\r\n          if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;\r\n          return (a.sort_order || 0) - (b.sort_order || 0);\r\n        });\r\n    };\r\n    \r\n    return {\r\n      today: filterAndSort(today),\r\n      tomorrow: filterAndSort(tomorrow),\r\n      dayAfterTomorrow: filterAndSort(dayAfterTomorrow),\r\n    };\r\n  }, [activities]);\r\n  \r\n  // Combine all recent activities (deduplicated, with day label)\r\n  const allRecentActivities = useMemo((): ActivityWithDayLabel[] => {\r\n    const seen = new Set<string>();\r\n    const combined: ActivityWithDayLabel[] = [];\r\n    \r\n    // Add today's activities\r\n    recentActivities.today.forEach(activity => {\r\n      if (!seen.has(activity.id)) {\r\n        seen.add(activity.id);\r\n        combined.push({ ...activity, dayLabel: \"today\" });\r\n      }\r\n    });\r\n    \r\n    // Add tomorrow's activities\r\n    recentActivities.tomorrow.forEach(activity => {\r\n      if (!seen.has(activity.id)) {\r\n        seen.add(activity.id);\r\n        combined.push({ ...activity, dayLabel: \"tomorrow\" });\r\n      }\r\n    });\r\n    \r\n    // Add day after tomorrow's activities\r\n    recentActivities.dayAfterTomorrow.forEach(activity => {\r\n      if (!seen.has(activity.id)) {\r\n        seen.add(activity.id);\r\n        combined.push({ ...activity, dayLabel: \"dayAfterTomorrow\" });\r\n      }\r\n    });\r\n    \r\n    // Sort combined list\r\n    return combined.sort((a, b) => {\r\n      const weightDiff = getActivitySortWeight(a) - getActivitySortWeight(b);\r\n      if (weightDiff !== 0) return weightDiff;\r\n      if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;\r\n      return (a.sort_order || 0) - (b.sort_order || 0);\r\n    });\r\n  }, [recentActivities]);\r\n  \r\n  return {\r\n    recentActivities,\r\n    allRecentActivities,\r\n    isLoading,\r\n    hasActivities: allRecentActivities.length > 0,\r\n  };\r\n};\r\n","import { memo, useMemo, useState, useEffect } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useNavigate } from \"react-router-dom\";\r\nimport { ArrowRight, Calendar, UtensilsCrossed, ShoppingBag } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { useRecentActivities, ActivityWithDayLabel } from \"@/hooks/useRecentActivities\";\r\nimport { useLocalizedContent } from \"@/hooks/useLocalizedContent\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\n// Get responsive display count based on window width\r\nconst useResponsiveCount = () => {\r\n  const [count, setCount] = useState(4);\r\n  \r\n  useEffect(() => {\r\n    const updateCount = () => {\r\n      const width = window.innerWidth;\r\n      if (width < 640) {\r\n        setCount(2);\r\n      } else if (width < 1024) {\r\n        setCount(3);\r\n      } else {\r\n        setCount(4);\r\n      }\r\n    };\r\n    \r\n    updateCount();\r\n    window.addEventListener(\"resize\", updateCount);\r\n    return () => window.removeEventListener(\"resize\", updateCount);\r\n  }, []);\r\n  \r\n  return count;\r\n};\r\n\r\n// Activity Card Component\r\nconst ActivityCard = memo(({ \r\n  activity, \r\n  dayLabel \r\n}: { \r\n  activity: ActivityWithDayLabel; \r\n  dayLabel: string;\r\n}) => {\r\n  const navigate = useNavigate();\r\n  const { t } = useTranslation();\r\n  const { getLocalizedField } = useLocalizedContent();\r\n  \r\n  const title = getLocalizedField(activity, \"title\");\r\n  \r\n  const serviceTypeLabel = useMemo(() => {\r\n    switch (activity.service_type) {\r\n      case \"dine_in\":\r\n        return t(\"activities.serviceType.dine_in\");\r\n      case \"takeaway\":\r\n        return t(\"activities.serviceType.takeaway\");\r\n      case \"both\":\r\n        return t(\"activities.serviceType.both\");\r\n      default:\r\n        return \"\";\r\n    }\r\n  }, [activity.service_type, t]);\r\n  \r\n  const handleClick = () => {\r\n    navigate(`/activity/${activity.id}`);\r\n  };\r\n  \r\n  return (\r\n    <Card \r\n      className=\"group cursor-pointer overflow-hidden hover:shadow-lg transition-all duration-300 border-border/50 bg-card\"\r\n      onClick={handleClick}\r\n    >\r\n      {/* Image Container */}\r\n      <div className=\"relative aspect-[16/10] overflow-hidden bg-muted\">\r\n        {activity.image_url ? (\r\n          <img \r\n            src={activity.image_url} \r\n            alt={title}\r\n            className=\"w-full h-full object-cover group-hover:scale-105 transition-transform duration-300\"\r\n            loading=\"lazy\"\r\n          />\r\n        ) : (\r\n          <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-primary/20 to-primary/5\">\r\n            <Calendar className=\"w-12 h-12 text-primary/40\" />\r\n          </div>\r\n        )}\r\n        \r\n        {/* Day Badge */}\r\n        <Badge \r\n          className={cn(\r\n            \"absolute top-2 left-2 text-xs font-medium\",\r\n            dayLabel === t(\"home.recentActivities.today\") \r\n              ? \"bg-primary text-primary-foreground\" \r\n              : \"bg-secondary text-secondary-foreground\"\r\n          )}\r\n        >\r\n          {dayLabel}\r\n        </Badge>\r\n        \r\n        {/* Pinned Badge */}\r\n        {activity.pinned && (\r\n          <Badge \r\n            className=\"absolute top-2 right-2 text-xs bg-accent text-accent-foreground\"\r\n          >\r\n            {t(\"activities.pinned\")}\r\n          </Badge>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Content */}\r\n      <div className=\"p-3 space-y-2\">\r\n        <h3 className=\"font-medium text-sm leading-tight line-clamp-2 text-foreground group-hover:text-primary transition-colors\">\r\n          {title}\r\n        </h3>\r\n        \r\n        <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\r\n          {activity.service_type === \"dine_in\" && (\r\n            <UtensilsCrossed className=\"w-3 h-3 flex-shrink-0\" />\r\n          )}\r\n          {activity.service_type === \"takeaway\" && (\r\n            <ShoppingBag className=\"w-3 h-3 flex-shrink-0\" />\r\n          )}\r\n          {activity.service_type === \"both\" && (\r\n            <>\r\n              <UtensilsCrossed className=\"w-3 h-3 flex-shrink-0\" />\r\n              <ShoppingBag className=\"w-3 h-3 flex-shrink-0\" />\r\n            </>\r\n          )}\r\n          <span className=\"truncate\">{serviceTypeLabel}</span>\r\n        </div>\r\n      </div>\r\n    </Card>\r\n  );\r\n});\r\nActivityCard.displayName = \"ActivityCard\";\r\n\r\n// Loading Skeleton\r\nconst LoadingSkeleton = memo(() => {\r\n  const displayCount = useResponsiveCount();\r\n  \r\n  return (\r\n    <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4\">\r\n      {Array.from({ length: displayCount }).map((_, i) => (\r\n        <Card key={i} className=\"overflow-hidden\">\r\n          <Skeleton className=\"aspect-[16/10] w-full\" />\r\n          <div className=\"p-3 space-y-2\">\r\n            <Skeleton className=\"h-4 w-full\" />\r\n            <Skeleton className=\"h-3 w-2/3\" />\r\n          </div>\r\n        </Card>\r\n      ))}\r\n    </div>\r\n  );\r\n});\r\nLoadingSkeleton.displayName = \"LoadingSkeleton\";\r\n\r\n// Main Component\r\nconst RecentActivitiesSection = memo(() => {\r\n  const { t } = useTranslation();\r\n  const { allRecentActivities, isLoading, hasActivities } = useRecentActivities();\r\n  const displayCount = useResponsiveCount();\r\n  const [showAll, setShowAll] = useState(false);\r\n  \r\n  // Get day label for display\r\n  const getDayLabel = (dayKey: \"today\" | \"tomorrow\" | \"dayAfterTomorrow\") => {\r\n    switch (dayKey) {\r\n      case \"today\":\r\n        return t(\"home.recentActivities.today\");\r\n      case \"tomorrow\":\r\n        return t(\"home.recentActivities.tomorrow\");\r\n      case \"dayAfterTomorrow\":\r\n        return t(\"home.recentActivities.dayAfterTomorrow\");\r\n      default:\r\n        return \"\";\r\n    }\r\n  };\r\n  \r\n  // Slice activities to display count or show all\r\n  const displayedActivities = useMemo(() => {\r\n    if (showAll) {\r\n      return allRecentActivities;\r\n    }\r\n    return allRecentActivities.slice(0, displayCount);\r\n  }, [allRecentActivities, displayCount, showAll]);\r\n  \r\n  const hasMore = allRecentActivities.length > displayCount;\r\n  \r\n  // Don't render if no activities and not loading\r\n  if (!isLoading && !hasActivities) {\r\n    return null;\r\n  }\r\n  \r\n  return (\r\n    <section className=\"py-8 sm:py-12 px-4 bg-secondary/20\">\r\n      <div className=\"container mx-auto max-w-7xl\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between mb-6\">\r\n          <h2 className=\"text-xl sm:text-2xl font-bold text-foreground\">\r\n            {t(\"home.recentActivities.title\")}\r\n          </h2>\r\n          \r\n          {hasMore && !showAll && (\r\n            <Button \r\n              variant=\"ghost\" \r\n              size=\"sm\" \r\n              className=\"text-primary hover:text-primary/80\"\r\n              onClick={() => setShowAll(true)}\r\n            >\r\n              <span className=\"flex items-center gap-1\">\r\n                {t(\"home.recentActivities.viewAll\")}\r\n                <ArrowRight className=\"w-4 h-4\" />\r\n              </span>\r\n            </Button>\r\n          )}\r\n          \r\n          {showAll && (\r\n            <Button \r\n              variant=\"ghost\" \r\n              size=\"sm\" \r\n              className=\"text-muted-foreground hover:text-foreground\"\r\n              onClick={() => setShowAll(false)}\r\n            >\r\n              <span className=\"flex items-center gap-1\">\r\n                {t(\"home.recentActivities.collapse\")}\r\n              </span>\r\n            </Button>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Content */}\r\n        {isLoading ? (\r\n          <LoadingSkeleton />\r\n        ) : (\r\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4\">\r\n            {displayedActivities.map((activity) => (\r\n              <ActivityCard \r\n                key={activity.id} \r\n                activity={activity}\r\n                dayLabel={getDayLabel(activity.dayLabel)}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </section>\r\n  );\r\n});\r\nRecentActivitiesSection.displayName = \"RecentActivitiesSection\";\r\n\r\nexport default RecentActivitiesSection;\r\n","import { Button } from \"@/components/ui/button\";\r\nimport { MapPin, Search, Star, Calendar, Store, ArrowRight, ShoppingBag, CalendarCheck, Smartphone, Download, MessageCircle } from \"lucide-react\";\r\nimport { Link } from \"react-router-dom\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Card } from \"@/components/ui/card\";\r\n// Hero images served from public folder for LCP optimization (discoverable in initial HTML)\r\nconst sushiRamenHero = \"/images/sushi-ramen-hero.jpg\";\r\nconst sushiRamenMobile = \"/images/sushi-ramen-mobile.jpg\";\r\nimport mapIcon from \"@/assets/map-icon.png\";\r\nimport googlePlayBadge from \"@/assets/google-play-badge-new.png\";\r\nimport appStoreBadge from \"@/assets/app-store-badge.svg\";\r\nimport { useState, useEffect, memo, useCallback, useRef } from \"react\";\r\nimport { useActiveHomepageTemplates, HomepageTemplate } from \"@/hooks/useHomepageTemplates\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { usePageView } from \"@/hooks/usePageView\";\r\nimport { HomeSkeleton } from \"@/components/skeletons\";\r\nimport { isIOSWebView, isInWebView, isCapacitorApp, isIOSDevice } from \"@/lib/externalLinks\";\r\nimport AskXiaoxiongDialog from \"@/components/AskXiaoxiongDialog\";\r\nimport { PullToRefresh } from \"@/components/PullToRefresh\";\r\nimport { useQueryClient } from \"@tanstack/react-query\";\r\nimport { useSiteSettings } from \"@/hooks/useSiteSettings\";\r\nimport HomeMapSection from \"@/components/HomeMapSection\";\r\nimport MobileHeroSection from \"@/components/MobileHeroSection\";\r\nimport RecentActivitiesSection from \"@/components/RecentActivitiesSection\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport useEnvironment from \"@/hooks/useEnvironment\";\r\n// Memoized Stats Display Component\r\nconst StatsDisplay = memo(({ stats, t }: { stats: { order_count: number; reserve_count: number }; t: (key: string) => string }) => (\r\n  <div className=\"absolute top-16 sm:top-20 left-3 z-20\">\r\n    <div className=\"gap-4 w-fit flex-col flex items-start justify-start\">\r\n      <div className=\"flex items-center gap-4\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <ShoppingBag className=\"w-4 h-4 text-primary\" />\r\n          <span className=\"text-sm text-white/90 drop-shadow-md\">{t(\"home.stats.delivery\")}</span>\r\n          <span className=\"font-bold text-white text-sm drop-shadow-md\">{stats.order_count}</span>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <CalendarCheck className=\"w-4 h-4 text-accent\" />\r\n          <span className=\"text-sm text-white/90 drop-shadow-md\">{t(\"home.stats.reservation\")}</span>\r\n          <span className=\"font-bold text-white text-sm drop-shadow-md\">{stats.reserve_count}</span>\r\n        </div>\r\n      </div>\r\n      \r\n      <div className=\"flex items-center gap-2\">\r\n        <span className=\"text-xl sm:text-2xl font-bold text-white drop-shadow-md\">\r\n          {t(\"home.hero.brandName\")}\r\n        </span>\r\n        <img \r\n          src={mapIcon} \r\n          alt=\"map icon\" \r\n          width={32}\r\n          height={32}\r\n          loading=\"eager\"\r\n          decoding=\"async\"\r\n          className=\"w-7 sm:w-8 h-7 sm:h-8 object-contain flex-shrink-0\" \r\n        />\r\n      </div>\r\n    </div>\r\n  </div>\r\n));\r\nStatsDisplay.displayName = \"StatsDisplay\";\r\n\r\n\r\n// Hook to determine if we should use lightweight mode for better performance\r\nconst useLightweightMode = (): boolean => {\r\n  const isMobile = window.innerWidth < 640;\r\n  const isDesktop = window.innerWidth >= 1024;\r\n  const connection = (navigator as any).connection;\r\n  \r\n  // Detection for iOS environments\r\n  const isCapacitor = isCapacitorApp();\r\n  const isWebView = isInWebView();\r\n  const isIOS = isIOSDevice();\r\n  \r\n  // Desktop: only use lightweight mode if user explicitly enabled data saver\r\n  if (isDesktop) {\r\n    if (connection?.saveData) return true;\r\n    return false; // Desktop always loads video by default\r\n  }\r\n  \r\n  // Mobile/Tablet: WebView environments use lightweight mode\r\n  // But exclude Capacitor native apps (user's own app should play videos)\r\n  if (isWebView && !isCapacitor) {\r\n    return true;\r\n  }\r\n  \r\n  // Check for slow network or data saver (mobile/tablet)\r\n  if (connection) {\r\n    if (connection.saveData) return true;\r\n    if (connection.effectiveType === '2g' || connection.effectiveType === 'slow-2g') return true;\r\n  }\r\n  \r\n  // Mobile low memory devices (< 2GB) - reduced threshold\r\n  if (isMobile && (navigator as any).deviceMemory && (navigator as any).deviceMemory < 2) return true;\r\n  \r\n  return false;\r\n};\r\n\r\n// Hero Slide Component\r\nconst HeroSlide = memo(({ \r\n  template, \r\n  isActive, \r\n  currentLang, \r\n  t,\r\n  onContentReady,\r\n  onAskXiaoxiong\r\n}: { \r\n  template: HomepageTemplate; \r\n  isActive: boolean;\r\n  currentLang: string;\r\n  t: (key: string) => string;\r\n  onContentReady?: () => void;\r\n  onAskXiaoxiong?: () => void;\r\n}) => {\r\n  const [postersLoaded, setPostersLoaded] = useState<Record<string, boolean>>({});\r\n  const [videosReady, setVideosReady] = useState<Record<string, boolean>>({});\r\n  const [videoErrors, setVideoErrors] = useState<Record<string, boolean>>({});\r\n  const [imagesLoaded, setImagesLoaded] = useState<Record<string, boolean>>({\r\n    mobile: true,\r\n    tablet: true, \r\n    desktop: true\r\n  });\r\n  // Control when to start loading videos - only after image is ready\r\n  const [shouldLoadVideo, setShouldLoadVideo] = useState(false);\r\n  const isLightweight = useLightweightMode();\r\n  \r\n  // Video refs for iOS Safari fix\r\n  const mobileVideoRef = useRef<HTMLVideoElement>(null);\r\n  const tabletVideoRef = useRef<HTMLVideoElement>(null);\r\n  const desktopVideoRef = useRef<HTMLVideoElement>(null);\r\n  \r\n  const getLocalizedText = (field: string) => {\r\n    const langSuffix = currentLang === \"zh\" ? \"_zh\" : currentLang === \"pt\" ? \"_pt\" : \"_en\";\r\n    return (template as any)[`${field}${langSuffix}`] || \"\";\r\n  };\r\n\r\n  const getDeviceType = () => {\r\n    if (window.innerWidth < 640) return 'mobile';\r\n    if (window.innerWidth < 1024) return 'tablet';\r\n    return 'desktop';\r\n  };\r\n\r\n  const getOverlayOpacity = () => {\r\n    const deviceType = getDeviceType();\r\n    \r\n    if (deviceType === 'mobile' && template.mobile_overlay_opacity !== null) {\r\n      return template.mobile_overlay_opacity;\r\n    }\r\n    if (deviceType === 'tablet' && template.tablet_overlay_opacity !== null) {\r\n      return template.tablet_overlay_opacity;\r\n    }\r\n    if (deviceType === 'desktop' && template.desktop_overlay_opacity !== null) {\r\n      return template.desktop_overlay_opacity;\r\n    }\r\n    \r\n    return template.overlay_opacity ?? 30;\r\n  };\r\n\r\n  const getOverlayStyle = () => {\r\n    const baseOpacity = getOverlayOpacity();\r\n    const direction = template.overlay_gradient_direction || 'to-b';\r\n    \r\n    const normalizeOpacity = (value: number | null | undefined, defaultValue: number) => {\r\n      if (value === null || value === undefined) return defaultValue / 100;\r\n      return value > 1 ? value / 100 : value;\r\n    };\r\n    \r\n    const normalizedBaseOpacity = baseOpacity > 1 ? baseOpacity / 100 : baseOpacity;\r\n    \r\n    const fromOpacity = normalizeOpacity(template.overlay_gradient_from_opacity, 30) * normalizedBaseOpacity;\r\n    const viaOpacity = normalizeOpacity(template.overlay_gradient_via_opacity, 25) * normalizedBaseOpacity;\r\n    const toOpacity = normalizeOpacity(template.overlay_gradient_to_opacity, 40) * normalizedBaseOpacity;\r\n\r\n    const directionMap: Record<string, string> = {\r\n      'to-t': 'to top',\r\n      'to-b': 'to bottom',\r\n      'to-l': 'to left',\r\n      'to-r': 'to right',\r\n      'to-tl': 'to top left',\r\n      'to-tr': 'to top right',\r\n      'to-bl': 'to bottom left',\r\n      'to-br': 'to bottom right'\r\n    };\r\n\r\n    const cssDirection = directionMap[direction] || 'to bottom';\r\n\r\n    const colorMap: Record<string, string> = {\r\n      'black': '0, 0, 0',\r\n      'white': '255, 255, 255',\r\n      'background': '0, 0, 0',\r\n      'foreground': '255, 255, 255',\r\n      'primary': '1, 100, 80',\r\n      'secondary': '240, 240, 240'\r\n    };\r\n\r\n    const fromColor = colorMap[template.overlay_gradient_from || 'black'] || '0, 0, 0';\r\n    const viaColor = colorMap[template.overlay_gradient_via || 'black'] || '0, 0, 0';\r\n    const toColor = colorMap[template.overlay_gradient_to || 'black'] || '0, 0, 0';\r\n\r\n    return {\r\n      background: `linear-gradient(${cssDirection}, rgba(${fromColor}, ${fromOpacity}), rgba(${viaColor}, ${viaOpacity}), rgba(${toColor}, ${toOpacity}))`\r\n    };\r\n  };\r\n\r\n  const mobileImg = template.mobile_image_url || sushiRamenMobile;\r\n  const tabletImg = template.tablet_image_url || template.desktop_image_url || sushiRamenHero;\r\n  const desktopImg = template.desktop_image_url || sushiRamenHero;\r\n  const blurAmount = template.background_blur || 0;\r\n\r\n  // Per-device media type (fallback to global media_type for backwards compatibility)\r\n  const desktopMediaType = (template as any).desktop_media_type || template.media_type || 'image';\r\n  const tabletMediaType = (template as any).tablet_media_type || template.media_type || 'image';\r\n  const mobileMediaType = (template as any).mobile_media_type || template.media_type || 'image';\r\n\r\n  // In lightweight mode (WebView), always treat as image to avoid video loading overhead\r\n  const isDesktopVideo = desktopMediaType === 'video' && !isLightweight;\r\n  const isTabletVideo = tabletMediaType === 'video' && !isLightweight;\r\n  const isMobileVideo = mobileMediaType === 'video' && !isLightweight;\r\n  \r\n  const mobileVideo = isMobileVideo ? template.mobile_video_url : null;\r\n  const tabletVideo = isTabletVideo ? (template.tablet_video_url || template.desktop_video_url) : null;\r\n  const desktopVideo = isDesktopVideo ? template.desktop_video_url : null;\r\n\r\n  // Preload only current device's poster image to prevent flash\r\n  useEffect(() => {\r\n    const deviceType = getDeviceType();\r\n    const currentImage = deviceType === 'mobile' ? mobileImg \r\n      : deviceType === 'tablet' ? tabletImg : desktopImg;\r\n    \r\n    if (currentImage) {\r\n      const img = new Image();\r\n      img.onload = () => {\r\n        setPostersLoaded(prev => ({ ...prev, [deviceType]: true }));\r\n        setImagesLoaded(prev => ({ ...prev, [deviceType]: true }));\r\n        // Image is ready - notify parent and start loading video\r\n        if (isActive) {\r\n          onContentReady?.();\r\n          // Start loading video after image is displayed (with slight delay for smoother UX)\r\n          setTimeout(() => setShouldLoadVideo(true), 100);\r\n        }\r\n      };\r\n      img.src = currentImage;\r\n    }\r\n  }, [mobileImg, tabletImg, desktopImg, isActive, onContentReady]);\r\n\r\n  // Also enable video loading when slide becomes active (for carousel navigation)\r\n  useEffect(() => {\r\n    if (isActive && postersLoaded[getDeviceType()]) {\r\n      setShouldLoadVideo(true);\r\n    }\r\n  }, [isActive, postersLoaded]);\r\n\r\n  const handleVideoCanPlay = (device: string) => {\r\n    setVideosReady(prev => ({ ...prev, [device]: true }));\r\n  };\r\n\r\n  const handleVideoError = (device: string, error: any) => {\r\n    console.error(`[HeroSlide] Video error on ${device}:`, error);\r\n    setVideoErrors(prev => ({ ...prev, [device]: true }));\r\n  };\r\n\r\n  // iOS Safari video autoplay fix - programmatically set muted and trigger play\r\n  useEffect(() => {\r\n    if (!shouldLoadVideo || !isActive) return;\r\n    \r\n    const isIOS = isIOSDevice();\r\n    if (!isIOS) return;\r\n\r\n    const deviceType = getDeviceType();\r\n    const videoRef = deviceType === 'mobile' ? mobileVideoRef \r\n      : deviceType === 'tablet' ? tabletVideoRef : desktopVideoRef;\r\n    \r\n    const video = videoRef.current;\r\n    if (!video) return;\r\n\r\n    // For iOS, we need to programmatically ensure muted is set and call play()\r\n    const attemptPlay = async () => {\r\n      try {\r\n        video.muted = true;\r\n        video.playsInline = true;\r\n        // Set webkit-playsinline for older iOS versions\r\n        video.setAttribute('webkit-playsinline', 'true');\r\n        \r\n        await video.play();\r\n        console.log(`[HeroSlide] iOS video play successful on ${deviceType}`);\r\n      } catch (err) {\r\n        console.error(`[HeroSlide] iOS video play failed on ${deviceType}:`, err);\r\n        // Mark as error so we show the fallback image\r\n        setVideoErrors(prev => ({ ...prev, [deviceType]: true }));\r\n      }\r\n    };\r\n\r\n    // Small delay to ensure video element is ready\r\n    const timer = setTimeout(attemptPlay, 150);\r\n    return () => clearTimeout(timer);\r\n  }, [shouldLoadVideo, isActive]);\r\n\r\n  return (\r\n    <div className={cn(\r\n      \"absolute inset-0 w-full h-full transition-opacity duration-1000\",\r\n      isActive ? \"opacity-100 z-10\" : \"opacity-0 z-0\"\r\n    )}>\r\n      {/* 背景媒体 */}\r\n      <div className=\"absolute inset-0 w-full h-full\">\r\n        {/* Mobile: Per-device media type */}\r\n        <div className=\"absolute inset-0 w-full h-full sm:hidden\">\r\n          {!imagesLoaded.mobile && (\r\n            <div className=\"absolute inset-0 w-full h-full bg-muted animate-pulse z-20\" />\r\n          )}\r\n          {isMobileVideo && mobileVideo ? (\r\n            <>\r\n              <img \r\n                src={mobileImg} \r\n                alt=\"Background\" \r\n                className={cn(\r\n                  \"absolute inset-0 w-full h-full object-cover object-center z-10 transition-opacity duration-500\",\r\n                  videosReady.mobile && !videoErrors.mobile ? \"opacity-0 pointer-events-none\" : \"opacity-100\"\r\n                )}\r\n                style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n              />\r\n              {shouldLoadVideo && !videoErrors.mobile && (\r\n                <video\r\n                  ref={mobileVideoRef}\r\n                  src={mobileVideo}\r\n                  autoPlay\r\n                  loop\r\n                  muted\r\n                  playsInline\r\n                  // @ts-ignore - webkit-playsinline for iOS Safari\r\n                  webkit-playsinline=\"true\"\r\n                  preload=\"auto\"\r\n                  onCanPlay={() => handleVideoCanPlay('mobile')}\r\n                  onError={(e) => handleVideoError('mobile', e)}\r\n                  className=\"absolute inset-0 w-full h-full object-cover object-center\"\r\n                  style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n                />\r\n              )}\r\n            </>\r\n          ) : (\r\n            <img \r\n              src={mobileImg} \r\n              alt=\"Background\" \r\n              className={cn(\r\n                \"absolute inset-0 w-full h-full object-cover object-center transition-opacity duration-500\",\r\n                imagesLoaded.mobile ? \"opacity-100\" : \"opacity-0\"\r\n              )}\r\n              style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n            />\r\n          )}\r\n        </div>\r\n        \r\n        {/* Tablet: Per-device media type */}\r\n        <div className=\"absolute inset-0 w-full h-full hidden sm:block lg:hidden\">\r\n          {!imagesLoaded.tablet && (\r\n            <div className=\"absolute inset-0 w-full h-full bg-muted animate-pulse z-20\" />\r\n          )}\r\n          {isTabletVideo && tabletVideo ? (\r\n            <>\r\n              <img \r\n                src={tabletImg} \r\n                alt=\"Background\" \r\n                className={cn(\r\n                  \"absolute inset-0 w-full h-full object-cover object-center z-10 transition-opacity duration-500\",\r\n                  videosReady.tablet && !videoErrors.tablet ? \"opacity-0 pointer-events-none\" : \"opacity-100\"\r\n                )}\r\n                style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n              />\r\n              {shouldLoadVideo && !videoErrors.tablet && (\r\n                <video\r\n                  ref={tabletVideoRef}\r\n                  src={tabletVideo}\r\n                  autoPlay\r\n                  loop\r\n                  muted\r\n                  playsInline\r\n                  // @ts-ignore - webkit-playsinline for iOS Safari\r\n                  webkit-playsinline=\"true\"\r\n                  preload=\"auto\"\r\n                  onCanPlay={() => handleVideoCanPlay('tablet')}\r\n                  onError={(e) => handleVideoError('tablet', e)}\r\n                  className=\"absolute inset-0 w-full h-full object-cover object-center\"\r\n                  style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n                />\r\n              )}\r\n            </>\r\n          ) : (\r\n            <img \r\n              src={tabletImg} \r\n              alt=\"Background\" \r\n              className={cn(\r\n                \"absolute inset-0 w-full h-full object-cover object-center transition-opacity duration-500\",\r\n                imagesLoaded.tablet ? \"opacity-100\" : \"opacity-0\"\r\n              )}\r\n              style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n            />\r\n          )}\r\n        </div>\r\n        \r\n        {/* Desktop: Per-device media type */}\r\n        <div className=\"absolute inset-0 w-full h-full hidden lg:block\">\r\n          {!imagesLoaded.desktop && (\r\n            <div className=\"absolute inset-0 w-full h-full bg-muted animate-pulse z-20\" />\r\n          )}\r\n          {isDesktopVideo && desktopVideo ? (\r\n            <>\r\n              <img \r\n                src={desktopImg} \r\n                alt=\"Background\" \r\n                className={cn(\r\n                  \"absolute inset-0 w-full h-full object-cover object-center z-10 transition-opacity duration-500\",\r\n                  videosReady.desktop && !videoErrors.desktop ? \"opacity-0 pointer-events-none\" : \"opacity-100\"\r\n                )}\r\n                style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n              />\r\n              {shouldLoadVideo && !videoErrors.desktop && (\r\n                <video\r\n                  ref={desktopVideoRef}\r\n                  src={desktopVideo}\r\n                  autoPlay\r\n                  loop\r\n                  muted\r\n                  playsInline\r\n                  // @ts-ignore - webkit-playsinline for iOS Safari\r\n                  webkit-playsinline=\"true\"\r\n                  preload=\"auto\"\r\n                  onCanPlay={() => handleVideoCanPlay('desktop')}\r\n                  onError={(e) => handleVideoError('desktop', e)}\r\n                  className=\"absolute inset-0 w-full h-full object-cover object-center\"\r\n                  style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n                />\r\n              )}\r\n            </>\r\n          ) : (\r\n            <img \r\n              src={desktopImg} \r\n              alt=\"Background\" \r\n              fetchPriority=\"high\"\r\n              loading=\"eager\"\r\n              decoding=\"async\"\r\n              className={cn(\r\n                \"absolute inset-0 w-full h-full object-cover object-center transition-opacity duration-500\",\r\n                imagesLoaded.desktop ? \"opacity-100\" : \"opacity-0\"\r\n              )}\r\n              style={{ filter: blurAmount > 0 ? `blur(${blurAmount}px)` : undefined }}\r\n            />\r\n          )}\r\n        </div>\r\n        <div className=\"absolute inset-0 w-full h-full\" style={getOverlayStyle()} />\r\n      </div>\r\n\r\n      {/* 内容 */}\r\n      <div className=\"relative z-10 container mx-auto px-4 sm:px-6 flex items-center justify-center min-h-screen\">\r\n        <div className=\"max-w-4xl mx-auto text-center space-y-4 sm:space-y-8 animate-fade-in w-full\">\r\n          <h1 className=\"text-3xl sm:text-5xl md:text-7xl font-bold text-white leading-tight px-4 drop-shadow-[0_2px_8px_rgba(0,0,0,0.8)]\">\r\n            {getLocalizedText(\"title\") || t(\"home.hero.title\")}\r\n          </h1>\r\n          \r\n          <p className=\"text-sm sm:text-xl md:text-2xl text-white/95 max-w-2xl mx-auto px-4 drop-shadow-[0_2px_6px_rgba(0,0,0,0.7)]\">\r\n            {getLocalizedText(\"description\") || t(\"home.hero.description\")}\r\n          </p>\r\n          \r\n          {template.subtitle_button_text_zh && (\r\n            <div className=\"flex justify-center\">\r\n              <button \r\n                onClick={onAskXiaoxiong}\r\n                className=\"group flex items-center gap-3 bg-white/20 backdrop-blur-xl text-white px-5 sm:px-7 py-3.5 sm:py-4 rounded-full shadow-[0_8px_32px_rgba(0,0,0,0.12)] hover:shadow-[0_16px_48px_rgba(0,0,0,0.2)] hover:bg-white/30 transition-all duration-300 cursor-text border border-white/40\"\r\n              >\r\n                <MessageCircle className=\"w-5 h-5 text-white/90 group-hover:text-white transition-colors drop-shadow-sm\" />\r\n                <span className=\"text-sm sm:text-base text-primary group-hover:text-primary/80 transition-colors drop-shadow-sm font-medium\">\r\n                  {getLocalizedText(\"subtitle_button_text\") || t(\"home.hero.subtitle\")}\r\n                </span>\r\n                <Search className=\"w-4 h-4 text-white/60 ml-2 drop-shadow-sm\" />\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\nHeroSlide.displayName = \"HeroSlide\";\r\n\r\nconst Home = () => {\r\n  const { t, i18n } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  const { settings: siteSettings } = useSiteSettings();\r\n  const { data: templates, isLoading: isLoadingTemplates, refetch: refetchTemplates } = useActiveHomepageTemplates();\r\n  const [currentIndex, setCurrentIndex] = useState(0);\r\n  const [stats, setStats] = useState<{ order_count: number; reserve_count: number } | null>(null);\r\n  const timerRef = useRef<NodeJS.Timeout | null>(null);\r\n  const [firstSlideReady, setFirstSlideReady] = useState(false);\r\n  const [askDialogOpen, setAskDialogOpen] = useState(false);\r\n  \r\n  // Mobile/WebView detection for conditional layout\r\n  const isMobile = useIsMobile();\r\n  const { isWebView } = useEnvironment();\r\n  const showMobileLayout = isMobile || isWebView;\r\n  \r\n  // Check if AI assistant is enabled and get provider\r\n  const isAIAssistantEnabled = siteSettings?.ai_assistant_enabled !== false;\r\n  const aiProvider = (siteSettings?.ai_provider || \"ask-xiaoxiong\") as \"ask-xiaoxiong\" | \"xiaoxiong-agent\" | \"lovable-ai\";\r\n  \r\n  // Handler for when the first slide's content is ready\r\n  const handleContentReady = useCallback(() => {\r\n    setFirstSlideReady(true);\r\n  }, []);\r\n\r\n  // Track page view\r\n  usePageView({ pageType: \"home\" });\r\n\r\n  const fetchStats = useCallback(async () => {\r\n    try {\r\n      const response = await fetch(\"https://v.xiaoxiong.pt/api/get_info\");\r\n      const result = await response.json();\r\n      if (result) {\r\n        setStats({\r\n          order_count: result.order_count || 0,\r\n          reserve_count: result.reserve_count || 0\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to fetch stats:\", error);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchStats();\r\n  }, [fetchStats]);\r\n\r\n  // Pull-to-refresh handler\r\n  const handleRefresh = useCallback(async () => {\r\n    await Promise.all([\r\n      refetchTemplates(),\r\n      fetchStats(),\r\n      queryClient.invalidateQueries({ queryKey: ['restaurants'] }),\r\n      queryClient.invalidateQueries({ queryKey: ['activities'] })\r\n    ]);\r\n  }, [refetchTemplates, fetchStats, queryClient]);\r\n\r\n  // Auto-rotate carousel\r\n  useEffect(() => {\r\n    if (!templates || templates.length <= 1) return;\r\n\r\n    const currentTemplate = templates[currentIndex];\r\n    const duration = currentTemplate?.duration || 5000;\r\n\r\n    timerRef.current = setTimeout(() => {\r\n      setCurrentIndex((prev) => (prev + 1) % templates.length);\r\n    }, duration);\r\n\r\n    return () => {\r\n      if (timerRef.current) clearTimeout(timerRef.current);\r\n    };\r\n  }, [templates, currentIndex]);\r\n\r\n  const goToSlide = useCallback((index: number) => {\r\n    if (timerRef.current) clearTimeout(timerRef.current);\r\n    setCurrentIndex(index);\r\n  }, []);\r\n\r\n  const goToPrev = useCallback(() => {\r\n    if (!templates) return;\r\n    if (timerRef.current) clearTimeout(timerRef.current);\r\n    setCurrentIndex((prev) => (prev - 1 + templates.length) % templates.length);\r\n  }, [templates]);\r\n\r\n  const goToNext = useCallback(() => {\r\n    if (!templates) return;\r\n    if (timerRef.current) clearTimeout(timerRef.current);\r\n    setCurrentIndex((prev) => (prev + 1) % templates.length);\r\n  }, [templates]);\r\n\r\n  const currentLang = i18n.language;\r\n  const showControls = templates && templates.length > 1;\r\n\r\n  return (\r\n    <PullToRefresh onRefresh={handleRefresh}>\r\n      <div className=\"min-h-screen\">\r\n        {/* Hero Section - Conditional Layout */}\r\n        {showMobileLayout ? (\r\n          // Mobile/WebView: Simplified hero without background\r\n          <MobileHeroSection \r\n            stats={stats} \r\n            onAskXiaoxiong={() => setAskDialogOpen(true)} \r\n          />\r\n        ) : (\r\n          // Desktop: Full carousel with background media\r\n          <section className=\"relative h-screen flex items-start overflow-hidden bg-background\">\r\n            {/* 统计数据显示 - 左上角 */}\r\n            {stats && <StatsDisplay stats={stats} t={t} />}\r\n\r\n            {/* Carousel Slides */}\r\n            <div className={cn(\r\n              \"absolute inset-0 w-full h-full transition-opacity duration-500\",\r\n              firstSlideReady ? \"opacity-100\" : \"opacity-0\"\r\n            )}>\r\n              {templates?.map((template, index) => (\r\n                <HeroSlide\r\n                  key={template.id}\r\n                  template={template}\r\n                  isActive={index === currentIndex}\r\n                  currentLang={currentLang}\r\n                  t={t}\r\n                  onContentReady={index === 0 ? handleContentReady : undefined}\r\n                  onAskXiaoxiong={() => setAskDialogOpen(true)}\r\n                />\r\n              ))}\r\n            </div>\r\n\r\n            {/* Loading state - show skeleton until content is actually ready */}\r\n            <div \r\n              className={cn(\r\n                \"absolute inset-0 w-full h-full z-20 transition-opacity duration-500\",\r\n                (isLoadingTemplates || !firstSlideReady) ? \"opacity-100\" : \"opacity-0 pointer-events-none\"\r\n              )}\r\n            >\r\n              <HomeSkeleton />\r\n            </div>\r\n\r\n            {/* Fallback if no templates (only after loading completes) */}\r\n            {!isLoadingTemplates && (!templates || templates.length === 0) && (\r\n              <div className=\"absolute inset-0 w-full h-full\">\r\n                <img \r\n                  src={sushiRamenMobile} \r\n                  alt=\"Background\" \r\n                  fetchPriority=\"high\"\r\n                  loading=\"eager\"\r\n                  decoding=\"async\"\r\n                  className=\"absolute inset-0 w-full h-full object-cover object-center sm:hidden\"\r\n                />\r\n                <img \r\n                  src={sushiRamenHero} \r\n                  alt=\"Background\" \r\n                  fetchPriority=\"high\"\r\n                  loading=\"eager\"\r\n                  decoding=\"async\"\r\n                  className=\"absolute inset-0 w-full h-full object-cover object-center hidden sm:block\"\r\n                />\r\n                <div className=\"absolute inset-0 w-full h-full bg-gradient-to-b from-black/30 via-black/25 to-black/40\" />\r\n                <div className=\"relative z-10 container mx-auto px-4 sm:px-6 flex items-center min-h-screen\">\r\n                  <div className=\"max-w-4xl mx-auto text-center space-y-4 sm:space-y-8 animate-fade-in w-full\">\r\n                    <h1 className=\"text-3xl sm:text-5xl md:text-7xl font-bold text-white leading-tight px-4 drop-shadow-[0_2px_8px_rgba(0,0,0,0.8)]\">\r\n                      {t(\"home.hero.title\")}\r\n                    </h1>\r\n                    <p className=\"text-sm sm:text-xl md:text-2xl text-white/95 max-w-2xl mx-auto px-4 drop-shadow-[0_2px_6px_rgba(0,0,0,0.7)]\">\r\n                      {t(\"home.hero.description\")}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Carousel Controls - Dot Indicators Only */}\r\n            {showControls && (\r\n              <div className=\"absolute bottom-8 left-1/2 -translate-x-1/2 z-30 flex gap-2\">\r\n                {templates.map((_, index) => (\r\n                  <button\r\n                    key={index}\r\n                    onClick={() => goToSlide(index)}\r\n                    className={cn(\r\n                      \"w-3 h-3 rounded-full transition-all duration-300\",\r\n                      index === currentIndex \r\n                        ? \"bg-white w-8\" \r\n                        : \"bg-white/50 hover:bg-white/70\"\r\n                    )}\r\n                    aria-label={`Go to slide ${index + 1}`}\r\n                  />\r\n                ))}\r\n              </div>\r\n            )}\r\n          </section>\r\n        )}\r\n\r\n      {/* Recent Activities Section */}\r\n      <RecentActivitiesSection />\r\n\r\n      {/* Map Section */}\r\n      <section className=\"py-12 sm:py-20 px-4 bg-secondary/20\">\r\n        <div className=\"container mx-auto max-w-7xl\">\r\n          <HomeMapSection />\r\n        </div>\r\n      </section>\r\n\r\n      {/* App Download Section - Hidden in WebView/Native App */}\r\n      {!isInWebView() && !isCapacitorApp() && (\r\n      <section className=\"py-16 sm:py-24 px-4 relative overflow-hidden\">\r\n        {/* Background with soft edges using mask */}\r\n        <div \r\n          className=\"absolute inset-0 bg-gradient-to-br from-primary/5 via-primary/3 to-primary/8\"\r\n          style={{\r\n            maskImage: 'radial-gradient(ellipse 80% 70% at 50% 50%, black 40%, transparent 100%)',\r\n            WebkitMaskImage: 'radial-gradient(ellipse 80% 70% at 50% 50%, black 40%, transparent 100%)',\r\n          }}\r\n        />\r\n        \r\n        {/* Decorative elements */}\r\n        <div className=\"absolute top-1/4 left-1/4 w-72 h-72 bg-primary/8 rounded-full blur-3xl\" />\r\n        <div className=\"absolute bottom-1/4 right-1/4 w-96 h-96 bg-primary/5 rounded-full blur-3xl\" />\r\n        \r\n        <div className=\"container mx-auto max-w-5xl relative z-10\">\r\n          <div className=\"flex flex-col items-center justify-center gap-8\">\r\n            \r\n            {/* Content */}\r\n            <div className=\"text-center max-w-md\">\r\n              <div className=\"inline-flex items-center gap-2 bg-primary/10 text-primary text-sm font-medium px-4 py-2 rounded-full mb-4\">\r\n                <Smartphone className=\"w-4 h-4\" />\r\n                <span>Mobile App</span>\r\n              </div>\r\n              <h3 className=\"text-2xl sm:text-3xl md:text-4xl font-bold text-foreground mb-4\">\r\n                {t(\"home.app.title\")}\r\n              </h3>\r\n              <p className=\"text-base sm:text-lg text-muted-foreground mb-8 leading-relaxed\">\r\n                {t(\"home.app.description\")}\r\n              </p>\r\n              <div className=\"flex flex-col items-center gap-4\">\r\n                <div className=\"flex flex-col sm:flex-row items-center justify-center gap-4\">\r\n                  {/* App Store */}\r\n                  <a \r\n                    href=\"https://apps.apple.com/cn/app/xiaoxiong/id6755481369\" \r\n                    target=\"_blank\" \r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"relative group\"\r\n                  >\r\n                    <div className=\"absolute -inset-2 bg-gradient-to-r from-primary via-primary-glow to-primary rounded-2xl blur-lg opacity-40 group-hover:opacity-70 transition-opacity\" />\r\n                    <div className=\"relative bg-black hover:bg-gray-900 h-[52px] sm:h-[56px] w-[160px] sm:w-[180px] rounded-xl transition-all hover:scale-105 shadow-2xl hover:shadow-primary/30 border border-white/10 flex items-center justify-center\">\r\n                      <img \r\n                        src={appStoreBadge} \r\n                        alt=\"Download on the App Store\" \r\n                        className=\"h-8 sm:h-9\"\r\n                      />\r\n                    </div>\r\n                  </a>\r\n                  \r\n                  {/* Google Play */}\r\n                  <a \r\n                    href=\"https://play.google.com/store/apps/details?id=com.xiaoxiong.market\" \r\n                    target=\"_blank\" \r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"relative group\"\r\n                  >\r\n                    <div className=\"absolute -inset-2 bg-gradient-to-r from-primary via-primary-glow to-primary rounded-2xl blur-lg opacity-40 group-hover:opacity-70 transition-opacity\" />\r\n                    <div className=\"relative bg-black hover:bg-gray-900 h-[52px] sm:h-[56px] w-[160px] sm:w-[180px] rounded-xl transition-all hover:scale-105 shadow-2xl hover:shadow-primary/30 border border-white/10 flex items-center justify-center\">\r\n                      <img \r\n                        src={googlePlayBadge} \r\n                        alt=\"Get it on Google Play\" \r\n                        className=\"h-12 sm:h-14\"\r\n                      />\r\n                    </div>\r\n                  </a>\r\n                </div>\r\n                \r\n                {/* Download hint */}\r\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                  <Download className=\"w-4 h-4 animate-bounce\" />\r\n                  <span>{t(\"home.app.downloadNow\")}</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n      )}\r\n\r\n      {/* CTA Section */}\r\n      <section className=\"py-16 sm:py-20 px-4 bg-gradient-to-r from-primary/90 to-primary relative overflow-hidden rounded-3xl mx-4 sm:mx-8 lg:mx-16 mb-8\">\r\n        <div className=\"absolute inset-0 bg-grid-pattern opacity-10\" />\r\n        <div className=\"absolute top-0 right-0 w-64 sm:w-96 h-64 sm:h-96 bg-white/10 rounded-full blur-3xl\" />\r\n        <div className=\"absolute bottom-0 left-0 w-64 sm:w-96 h-64 sm:h-96 bg-white/10 rounded-full blur-3xl\" />\r\n        \r\n        <div className=\"container mx-auto max-w-4xl text-center relative z-10\">\r\n          <h2 className=\"text-3xl sm:text-4xl md:text-5xl font-bold text-primary-foreground mb-4 sm:mb-6 px-4\">\r\n            {t(\"home.cta.title\")}\r\n          </h2>\r\n          <p className=\"text-base sm:text-xl text-primary-foreground/90 mb-6 sm:mb-8 max-w-2xl mx-auto px-4\">\r\n            {t(\"home.cta.description\")}\r\n          </p>\r\n          <div className=\"flex justify-center\">\r\n            <Button size=\"lg\" variant=\"secondary\" asChild className=\"text-base sm:text-lg shadow-xl hover:shadow-2xl\">\r\n              <Link to=\"/join-us\">\r\n                <Store className=\"mr-2 w-4 sm:w-5 h-4 sm:h-5\" />\r\n                {t(\"home.cta.button\")}\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      {/* Ask Xiaoxiong Dialog - conditionally rendered based on settings */}\r\n      {isAIAssistantEnabled && (\r\n        <AskXiaoxiongDialog open={askDialogOpen} onOpenChange={setAskDialogOpen} provider={aiProvider} />\r\n      )}\r\n      </div>\r\n    </PullToRefresh>\r\n  );\r\n};\r\n\r\nexport default Home;\r\n"],"names":["hasNativeVoiceBridge","NativeVoice","message","SUPABASE_URL","SUPABASE_ANON_KEY","LOCATION_KEYWORDS","getAnonymousUserId","storageKey","anonymousId","AskXiaoxiongDialog","open","onOpenChange","provider","i18n","useTranslation","navigate","useNavigate","settings","useSiteSettings","user","useAuth","isMobile","useIsMobile","profile","useProfile","logoUrl","logoFallback","input","setInput","useState","messages","setMessages","isLoading","setIsLoading","userLocation","setUserLocation","showLocationDialog","setShowLocationDialog","pendingMessage","setPendingMessage","isListening","setIsListening","speechSupported","setSpeechSupported","nativeVoiceSupported","setNativeVoiceSupported","externalLinkDialogOpen","setExternalLinkDialogOpen","pendingExternalLink","setPendingExternalLink","abortControllerRef","useRef","scrollAreaRef","recognitionRef","messagesEndRef","shouldShowVoiceInput","screenWidth","isTablet","isDesktop","getUserId","useEffect","SpeechRecognition","text","savedScrollY","savedScrollX","originalOverflow","originalPosition","originalTop","originalWidth","updateViewport","viewport","vh","offsetTop","position","error","handleSubmitAskXiaoxiong","userMessage","assistantMessageId","response","reader","decoder","accumulatedResult","done","value","chunk","cleanResult","prev","msg","finalResult","handleSubmitXiaoxiongAgent","userId","requestStartTime","responseTime","firstChunkReceived","chunkCount","ttfb","flushSync","resolve","handleSubmitLovableAI","errorData","textBuffer","newlineIndex","line","jsonStr","content","needsLocationInfo","lowerMessage","keyword","processMessage","messageContent","assistantMessage","err","errorMessage","handleLocationConfirm","handleSubmit","handleKeyDown","e","startListening","recognition","langMap","event","transcript","result","stopListening","toggleListening","handleClose","handleLinkClick","href","handleExternalLinkClick","url","confirmExternalLink","openExternalUrl","parseTextWithLinks","linkRegex","parts","lastIndex","match","keyIndex","jsx","linkText","actualUrl","removeBoldMarkers","truncateText","maxLength","renderTable","tableLines","key","parseRow","cell","headers","rows","jsxs","header","i","row","rowIndex","cellIndex","renderMarkdown","lines","elements","part","idx","getTitle","getPlaceholder","getWelcomeMessage","Dialog","DialogContent","cn","DialogHeader","DialogTitle","ScrollArea","Avatar","AvatarImage","AvatarFallback","User","Fragment","Loader2","MicOff","Mic","Send","LocationPermissionDialog","ExternalLinkConfirmDialog","MapRestaurantTags","restaurant","language","visibleCount","setVisibleCount","containerRef","allTags","type","checkOverflow","container","badges","firstBadgeTop","lastVisibleIndex","timer","visibleTags","hasMore","tag","Badge","Popover","PopoverTrigger","Button","MoreHorizontal","PopoverContent","HomeMapSection","t","toast","useToast","localizeRestaurant","useLocalizedContent","searchQuery","setSearchQuery","selectedTypes","setSelectedTypes","selectedActivity","setSelectedActivity","activityRestaurantIds","setActivityRestaurantIds","radiusFilter","setRadiusFilter","isFullscreen","setIsFullscreen","showAllTypes","setShowAllTypes","showAllActivities","setShowAllActivities","mapRef","savedMapState","restaurantRefs","selectedRestaurantId","setSelectedRestaurantId","showFilters","setShowFilters","isMapCollapsed","setIsMapCollapsed","isMobileListExpanded","setIsMobileListExpanded","MOBILE_DEFAULT_VISIBLE","restaurants","useRestaurants","restaurantTypes","useRestaurantTypes","activities","useActivities","activityRestaurantCounts","useActivityRestaurantCounts","activitiesWithRestaurants","activity","handleTypeFilter","handleRequestLocation","requestLocation","getUserLocation","handleRadiusChange","radius","handleActivityFilter","activityId","data","supabase","ar","processedRestaurants","localized","distance","calculateDistance","activityFilteredRestaurants","r","filteredRestaurants","a","handleRestaurantClick","handleMarkerClick","restaurantElement","toggleFullscreen","mapContainer","center","zoom","handleFullscreenChange","isNowFullscreen","Input","Navigation","Filter","index","activityLabel","Minimize","Maximize","RestaurantMap","mapInstance","logoIcon","ChevronDown","ChevronUp","MapPin","Card","el","Star","MobileHeroSection","memo","stats","onAskXiaoxiong","templates","useActiveHomepageTemplates","buttons","useNavigationSettings","currentLang","showExternalLinkDialog","setShowExternalLinkDialog","showAboutUsButton","demoButton","btn","getLocalizedText","field","title","description","chatButtonText","handleConfirmExternalLink","mapIcon","Link","Info","ShoppingBag","CalendarCheck","MessageCircle","Search","isDateRangeArray","item","isActivityValidOnDate","targetDate","startDate","startOfDay","endDate","target","isSameDay","targetWeekday","getDay","targetDayOfMonth","getDate","monthRanges","range","targetMonth","getMonth","targetDay","yearlyMonth","yearlyDay","getActivitySortWeight","useRecentActivities","recentActivities","useMemo","today","tomorrow","addDays","dayAfterTomorrow","filterAndSort","date","b","weightDiff","allRecentActivities","seen","combined","useResponsiveCount","count","setCount","updateCount","width","ActivityCard","dayLabel","getLocalizedField","serviceTypeLabel","handleClick","Calendar","UtensilsCrossed","LoadingSkeleton","displayCount","_","Skeleton","RecentActivitiesSection","hasActivities","showAll","setShowAll","getDayLabel","dayKey","displayedActivities","ArrowRight","sushiRamenHero","sushiRamenMobile","StatsDisplay","useLightweightMode","connection","isCapacitor","isCapacitorApp","isWebView","isInWebView","HeroSlide","template","isActive","onContentReady","postersLoaded","setPostersLoaded","videosReady","setVideosReady","videoErrors","setVideoErrors","imagesLoaded","setImagesLoaded","shouldLoadVideo","setShouldLoadVideo","isLightweight","mobileVideoRef","tabletVideoRef","desktopVideoRef","getDeviceType","getOverlayOpacity","deviceType","getOverlayStyle","baseOpacity","direction","normalizeOpacity","defaultValue","normalizedBaseOpacity","fromOpacity","viaOpacity","toOpacity","cssDirection","colorMap","fromColor","viaColor","toColor","mobileImg","tabletImg","desktopImg","blurAmount","desktopMediaType","tabletMediaType","mobileMediaType","isDesktopVideo","isTabletVideo","isMobileVideo","mobileVideo","tabletVideo","desktopVideo","currentImage","img","handleVideoCanPlay","device","handleVideoError","isIOSDevice","video","Home","queryClient","useQueryClient","siteSettings","isLoadingTemplates","refetchTemplates","currentIndex","setCurrentIndex","setStats","timerRef","firstSlideReady","setFirstSlideReady","askDialogOpen","setAskDialogOpen","useEnvironment","showMobileLayout","isAIAssistantEnabled","aiProvider","handleContentReady","useCallback","usePageView","fetchStats","handleRefresh","duration","goToSlide","showControls","PullToRefresh","HomeSkeleton","Smartphone","appStoreBadge","googlePlayBadge","Download","Store"],"mappings":"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"}