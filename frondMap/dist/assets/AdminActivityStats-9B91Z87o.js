import{r as J,j as e}from"./vendor-react-core-BErlw7p5.js";import{c as ee,L as se}from"./vendor-router-CLK0c9aH.js";import{g as h,B as ae,X as te,Y as re,Z as ie,$ as le,a0 as N,C as c,j as d,h as v,p as w,N as C,O as S,P as L,o as ne,s as x}from"./index-kEIDKiMZ.js";import{b as ce,c as de}from"./useActivities-DrndOeGI.js";import{u as oe}from"./useLocalizedContent-DqTgPnyL.js";import{a as _}from"./vendor-query-BS0wY7WL.js";import{u as me}from"./vendor-i18n-CqcxoxDo.js";import{O as xe,e as he,ae as ue,H as k,Q as T,u as F,q as R,w as pe,aH as je}from"./vendor-icons-C2Bicc1E.js";import{R as fe,L as ge,C as ye,X as Ne,Y as ve,T as we,b as _e}from"./vendor-charts-C2PWrzKy.js";import{C as f,s as q,c as D}from"./vendor-date-fYlqblcl.js";import"./vendor-editor-BdQcs4B3.js";import"./vendor-misc-DH4LiFnZ.js";import"./vendor-ui-other-CPTlx-W2.js";import"./vendor-supabase-Clrw0GhO.js";import"./vendor-ui-dialog-Sv_VEL0d.js";import"./vendor-ui-dropdown-DwTcg2UT.js";const Ve=()=>{const{id:i}=ee(),{t}=me(),{getLocalizedField:I}=oe(),[m,H]=J.useState("30days"),K=()=>{const s=new Date;switch(m){case"today":return D(s).toISOString();case"7days":return D(q(s,6)).toISOString();case"30days":return D(q(s,29)).toISOString();default:return null}},O=()=>{switch(m){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:A,isLoading:V}=ce(i),{data:z=[]}=de(i),o=K(),{data:g=[],isLoading:E}=_({queryKey:["activity-subscribers",i,m],queryFn:async()=>{let s=x.from("subscriptions").select("user_id, created_at").eq("activity_id",i).order("created_at",{ascending:!1});o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;if(a&&a.length>0){const n=a.map(l=>l.user_id),{data:p}=await x.rpc("get_public_profiles",{user_ids:n});return a.map(l=>({...l,profile:p?.find(j=>j.id===l.user_id)}))}return[]},enabled:!!i}),{data:y=[],isLoading:U}=_({queryKey:["activity-sharers",i,m],queryFn:async()=>{let s=x.from("activity_shares").select("user_id, created_at").eq("activity_id",i).order("created_at",{ascending:!1});o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;if(a&&a.length>0){const n=a.map(l=>l.user_id),{data:p}=await x.rpc("get_public_profiles",{user_ids:n});return a.map(l=>({...l,profile:p?.find(j=>j.id===l.user_id)}))}return[]},enabled:!!i}),{data:u=[],isLoading:B}=_({queryKey:["activity-comments",i,m],queryFn:async()=>{let s=x.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_id",i).eq("target_type","activity").order("created_at",{ascending:!1});o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;if(a&&a.length>0){const n=[...new Set(a.map(l=>l.user_id))],{data:p}=await x.rpc("get_public_profiles",{user_ids:n});return a.map(l=>({...l,profile:p?.find(j=>j.id===l.user_id)}))}return[]},enabled:!!i}),{data:M=[],isLoading:X}=_({queryKey:["activity-page-views",i,m],queryFn:async()=>{let s=x.from("page_views").select("created_at").eq("target_id",i).eq("page_type","activity");o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;return a||[]},enabled:!!i}),Y=(()=>{const s=new Map,a=O();for(let r=a-1;r>=0;r--){const n=f(q(new Date,r),"MM-dd");s.set(n,0)}return M.forEach(r=>{const n=f(new Date(r.created_at),"MM-dd");s.has(n)&&s.set(n,(s.get(n)||0)+1)}),Array.from(s.entries()).map(([r,n])=>({date:r,views:n}))})(),P=M.length,Q=g.length,W=y.length,b=u.filter(s=>s.rating_value!==null),G=b.length>0?(b.reduce((s,a)=>s+(a.rating_value||0),0)/b.length).toFixed(1):"0.0",Z=u.length;if(V)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(h,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(h,{className:"h-32"},s))})]});if(!A)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:t("common.notFound")})});const $=I(A,"title");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ae,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(se,{to:"/admin/activity-stats",children:e.jsx(xe,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:t("admin.activityStats")}),e.jsx("p",{className:"text-muted-foreground",children:$})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-12 sm:ml-0",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(te,{value:m,onValueChange:s=>H(s),children:[e.jsx(re,{className:"w-[140px]",children:e.jsx(ie,{})}),e.jsxs(le,{children:[e.jsx(N,{value:"today",children:t("analytics.today")}),e.jsx(N,{value:"7days",children:t("analytics.last7Days")}),e.jsx(N,{value:"30days",children:t("analytics.last30Days","近30天")}),e.jsx(N,{value:"all",children:t("analytics.allTime","所有时间")})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("analytics.pageViews")})]}),e.jsx("p",{className:"text-2xl font-bold",children:P})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(k,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.favorites")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Q})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(T,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.shares")})]}),e.jsx("p",{className:"text-2xl font-bold",children:W})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("restaurant.rating")})]}),e.jsx("p",{className:"text-2xl font-bold",children:G})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("restaurant.comments")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Z})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.participatingRestaurants")})]}),e.jsx("p",{className:"text-2xl font-bold",children:z.length})]})})]}),e.jsxs(c,{children:[e.jsx(v,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5"}),t("analytics.viewTrend")]})}),e.jsx(d,{children:e.jsx("div",{className:"h-[300px]",children:X?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(h,{className:"h-full w-full"})}):e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(ge,{data:Y,children:[e.jsx(ye,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(Ne,{dataKey:"date",className:"text-xs",tick:{fontSize:11}}),e.jsx(ve,{className:"text-xs",tick:{fontSize:11}}),e.jsx(we,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(_e,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1})]})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(c,{children:[e.jsx(v,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),t("admin.sharersList","分享用户")," (",y.length,")"]})}),e.jsx(d,{children:U?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(h,{className:"h-12 w-full"},s))}):y.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:y.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(C,{className:"h-8 w-8",children:[e.jsx(S,{src:s.profile?.avatar_url}),e.jsx(L,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:f(new Date(s.created_at),"yyyy-MM-dd")})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]}),e.jsxs(c,{children:[e.jsx(v,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"}),t("admin.subscribersList","收藏用户")," (",g.length,")"]})}),e.jsx(d,{children:E?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(h,{className:"h-12 w-full"},s))}):g.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:g.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(C,{className:"h-8 w-8",children:[e.jsx(S,{src:s.profile?.avatar_url}),e.jsx(L,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:f(new Date(s.created_at),"yyyy-MM-dd")})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]})]}),e.jsxs(c,{children:[e.jsx(v,{children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5"}),t("admin.commentsAndRatings","评论与评分")," (",u.length,")"]})}),e.jsx(d,{children:B?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(h,{className:"h-20 w-full"},s))}):u.length>0?e.jsx("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:u.map(s=>e.jsxs("div",{className:"p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(C,{className:"h-8 w-8",children:[e.jsx(S,{src:s.profile?.avatar_url}),e.jsx(L,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),s.rating_value&&e.jsxs(ne,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(F,{className:"w-3 h-3 fill-current"}),s.rating_value]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:f(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3",children:s.content})]},s.id))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]})]})};export{Ve as default};
//# sourceMappingURL=AdminActivityStats-9B91Z87o.js.map
