{"version":3,"file":"PostDetail-C8AECvAM.js","sources":["../../src/pages/PostDetail.tsx"],"sourcesContent":["import { useParams, useNavigate } from \"react-router-dom\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useCallback, useEffect, useRef } from \"react\";\r\nimport { useQueryClient } from \"@tanstack/react-query\";\r\nimport { ArrowLeft, Loader2 } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport PostCard from \"@/components/community/PostCard\";\r\nimport RecipeDetailContent from \"@/components/community/recipe/RecipeDetailContent\";\r\nimport RestaurantComments from \"@/components/RestaurantComments\";\r\nimport { useCommunityPost } from \"@/hooks/useCommunityPosts\";\r\nimport { PullToRefresh } from \"@/components/PullToRefresh\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\ninterface ExtendedPost {\r\n  post_type?: string;\r\n  [key: string]: any;\r\n}\r\n\r\nconst PostDetail = () => {\r\n  const { id } = useParams<{ id: string }>();\r\n  const { t } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const queryClient = useQueryClient();\r\n  const { data: post, isLoading, error } = useCommunityPost(id || \"\");\r\n  const viewTracked = useRef(false);\r\n\r\n  // Increment view count once when post is loaded\r\n  useEffect(() => {\r\n    if (id && post && !viewTracked.current) {\r\n      viewTracked.current = true;\r\n      supabase.rpc('increment_post_views', { post_id: id }).then(({ error }) => {\r\n        if (error) console.error('Failed to increment views:', error);\r\n      });\r\n    }\r\n  }, [id, post]);\r\n\r\n  // Pull-to-refresh handler - clears cache and forces fresh data\r\n  const handleRefresh = useCallback(async () => {\r\n    // Clear caches first\r\n    queryClient.removeQueries({ queryKey: ['community-post', id] });\r\n    queryClient.removeQueries({ queryKey: ['comments', id] });\r\n    \r\n    // Refetch with fresh data\r\n    await Promise.all([\r\n      queryClient.invalidateQueries({ queryKey: ['community-post', id] }),\r\n      queryClient.invalidateQueries({ queryKey: ['comments', id] }),\r\n    ]);\r\n  }, [queryClient, id]);\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"container max-w-2xl mx-auto py-6 px-4 flex justify-center\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error || !post) {\r\n    return (\r\n      <div className=\"container max-w-2xl mx-auto py-6 px-4\">\r\n        <div className=\"text-center py-12\">\r\n          <p className=\"text-muted-foreground\">\r\n            {t(\"community.postNotFound\", \"帖子不存在或已被删除\")}\r\n          </p>\r\n          <Button\r\n            variant=\"outline\"\r\n            className=\"mt-4\"\r\n            onClick={() => navigate(\"/community\")}\r\n          >\r\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n            {t(\"community.backToList\", \"返回社区\")}\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <PullToRefresh onRefresh={handleRefresh}>\r\n      <div className=\"container max-w-2xl mx-auto py-6 px-4\">\r\n        {/* Back Button */}\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"mb-4\"\r\n          onClick={() => navigate(\"/community\")}\r\n        >\r\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n          {t(\"community.backToList\", \"返回社区\")}\r\n        </Button>\r\n\r\n        {/* Post Content - Recipe or Regular */}\r\n        {(post as ExtendedPost).post_type === 'recipe' ? (\r\n          <RecipeDetailContent post={post as any} />\r\n        ) : (\r\n          <PostCard post={post} showActions isDetailPage />\r\n        )}\r\n\r\n        {/* Comments Section */}\r\n        <div className=\"mt-6\">\r\n          <RestaurantComments\r\n            targetId={post.id}\r\n            targetType=\"post\"\r\n          />\r\n        </div>\r\n      </div>\r\n    </PullToRefresh>\r\n  );\r\n};\r\n\r\nexport default PostDetail;\r\n"],"names":["PostDetail","id","useParams","t","useTranslation","navigate","useNavigate","queryClient","useQueryClient","post","isLoading","error","useCommunityPost","viewTracked","useRef","useEffect","supabase","handleRefresh","useCallback","jsx","Loader2","jsxs","Button","ArrowLeft","PullToRefresh","RecipeDetailContent","PostCard","RestaurantComments"],"mappings":"iqCAkBA,MAAMA,GAAa,IAAM,CACjB,KAAA,CAAE,GAAAC,GAAOC,IACT,CAAE,EAAAC,GAAMC,IACRC,EAAWC,IACXC,EAAcC,IACd,CAAE,KAAMC,EAAM,UAAAC,EAAW,MAAAC,GAAUC,EAAiBX,GAAM,EAAE,EAC5DY,EAAcC,SAAO,EAAK,EAGhCC,EAAAA,UAAU,IAAM,CACVd,GAAMQ,GAAQ,CAACI,EAAY,UAC7BA,EAAY,QAAU,GACtBG,EAAS,IAAI,uBAAwB,CAAE,QAASf,EAAI,EAAE,KAAK,CAAC,CAAE,MAAAU,CAAAA,IAAY,CACpEA,GAAO,QAAQ,MAAM,6BAA8BA,CAAK,CAAA,CAC7D,EACH,EACC,CAACV,EAAIQ,CAAI,CAAC,EAGP,MAAAQ,EAAgBC,EAAAA,YAAY,SAAY,CAE5CX,EAAY,cAAc,CAAE,SAAU,CAAC,iBAAkBN,CAAE,EAAG,EAC9DM,EAAY,cAAc,CAAE,SAAU,CAAC,WAAYN,CAAE,EAAG,EAGxD,MAAM,QAAQ,IAAI,CAChBM,EAAY,kBAAkB,CAAE,SAAU,CAAC,iBAAkBN,CAAE,EAAG,EAClEM,EAAY,kBAAkB,CAAE,SAAU,CAAC,WAAYN,CAAE,EAAG,CAAA,CAC7D,CAAA,EACA,CAACM,EAAaN,CAAE,CAAC,EAEpB,OAAIS,EAEAS,EAAA,IAAC,OAAI,UAAU,4DACb,eAACC,EAAQ,CAAA,UAAU,sBAAuB,CAAA,CAC5C,CAAA,EAIAT,GAAS,CAACF,QAET,MAAI,CAAA,UAAU,wCACb,SAACY,EAAA,KAAA,MAAA,CAAI,UAAU,oBACb,SAAA,CAAAF,MAAC,KAAE,UAAU,wBACV,SAAEhB,EAAA,yBAA0B,YAAY,EAC3C,EACAkB,EAAA,KAACC,EAAA,CACC,QAAQ,UACR,UAAU,OACV,QAAS,IAAMjB,EAAS,YAAY,EAEpC,SAAA,CAACc,EAAAA,IAAAI,EAAA,CAAU,UAAU,cAAe,CAAA,EACnCpB,EAAE,uBAAwB,MAAM,CAAA,CAAA,CACnC,CAAA,CACF,CAAA,CACF,CAAA,QAKDqB,EAAc,CAAA,UAAWP,EACxB,SAACI,EAAA,KAAA,MAAA,CAAI,UAAU,wCAEb,SAAA,CAAAA,EAAA,KAACC,EAAA,CACC,QAAQ,QACR,KAAK,KACL,UAAU,OACV,QAAS,IAAMjB,EAAS,YAAY,EAEpC,SAAA,CAACc,EAAAA,IAAAI,EAAA,CAAU,UAAU,cAAe,CAAA,EACnCpB,EAAE,uBAAwB,MAAM,CAAA,CAAA,CACnC,EAGEM,EAAsB,YAAc,SACpCU,EAAA,IAACM,EAAoB,CAAA,KAAAhB,EAAmB,EAExCU,EAAA,IAACO,EAAS,CAAA,KAAAjB,EAAY,YAAW,GAAC,aAAY,GAAC,EAIjDU,EAAAA,IAAC,MAAI,CAAA,UAAU,OACb,SAAAA,EAAA,IAACQ,EAAA,CACC,SAAUlB,EAAK,GACf,WAAW,MAAA,CAAA,EAEf,CAAA,CACF,CAAA,CACF,CAAA,CAEJ"}