import{a as ge,u as Z,b as ee}from"./vendor-query-BlSVl3IQ.js";import{y as V,Q as p,x as re,D as xe,aC as ve,B as w,ad as je,a as ye,b as Ce,c as we,ay as _e,az as U,aM as be,aN as Ne,aO as Se,aP as De,aQ as Ee,aR as Ue,I as O,X as Y,aS as Ie,af as qe,ag as Ae,ah as Fe,ai as ke,aj as Te,ak as Re,al as Pe,am as ze,a3 as o}from"./index-BF1tiRoq.js";import{j as e}from"./vendor-ui-DAmPMpEA.js";import{r as u}from"./vendor-react-iAJ0IrSD.js";import{I as Me,a as $e,b as M}from"./input-otp-Ca-hn1JF.js";import{u as Le}from"./vendor-i18n-DxKeo2S1.js";const te=new Set,We=(d,v="restaurant",C)=>{const{user:l}=V();return ge({queryKey:["comments",d,v],enabled:C?.enabled!==!1&&!!d,queryFn:async()=>{let r=p.from("comments").select("*").eq("target_id",d).eq("target_type",v).order("created_at",{ascending:!1});const{data:n,error:N}=await r;if(N)throw N;if(!n||n.length===0)return[];const j=n.filter(s=>s.moderation_status==="approved"||l&&s.user_id===l.id&&s.moderation_status==="pending"||l&&s.user_id===l.id&&s.moderation_status==="flagged"&&te.has(s.id)),I=[...new Set(j.map(s=>s.user_id))],{data:_}=await p.rpc("get_public_profiles",{user_ids:I}),m=new Map((_||[]).map(s=>[s.id,{display_name:s.display_name,avatar_url:s.avatar_url}])),f=j.filter(s=>!s.parent_id),y=j.filter(s=>s.parent_id),h=new Map;return y.forEach(s=>{const i=s.parent_id;h.has(i)||h.set(i,[]),h.get(i).push(s)}),f.map(s=>({...s,moderation_status:s.moderation_status,profiles:m.get(s.user_id),replies:(h.get(s.id)||[]).sort((i,q)=>new Date(i.created_at).getTime()-new Date(q.created_at).getTime()).map(i=>({...i,moderation_status:i.moderation_status,profiles:m.get(i.user_id)}))}))},staleTime:3e4})},Ge=()=>{const{user:d}=V(),{toast:v}=re(),C=Z();return ee({mutationFn:async({targetId:l,targetType:r,content:n,ratingValue:N,priceRange:j,imageUrl:I,parentId:_})=>{if(!d)throw new Error("User not authenticated");const m={user_id:d.id,target_id:l,target_type:r,content:n,parent_id:_,moderation_status:"pending"};_||(N&&(m.rating_value=N),j&&(m.price_range=j)),I&&(m.image_url=I);const{data:f,error:y}=await p.from("comments").insert(m).select().single();if(y)throw y;try{const{data:h,error:x}=await p.functions.invoke("moderate-comment",{body:{comment_id:f.id,content:n,user_id:d.id,sensitive_word_detected:!1,target_id:l,target_type:r}});x?(console.error("AI moderation error:",x),await p.from("comments").update({moderation_status:"approved"}).eq("id",f.id)):h&&console.log("AI moderation result:",h)}catch(h){console.error("Failed to invoke AI moderation:",h),await p.from("comments").update({moderation_status:"approved"}).eq("id",f.id)}return f},onSuccess:(l,r)=>{l?.id&&te.add(l.id),C.invalidateQueries({queryKey:["comments",r.targetId,r.targetType]}),C.invalidateQueries({queryKey:["restaurants"]}),C.invalidateQueries({queryKey:["restaurant",r.targetId]}),v({title:"评论已提交",description:"您的评论正在审核中，审核完成后会通知您结果"})},onError:()=>{v({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Xe=()=>{const{toast:d}=re(),v=Z();return ee({mutationFn:async C=>{const{error:l}=await p.from("comments").delete().eq("id",C);if(l)throw l},onSuccess:()=>{v.invalidateQueries({queryKey:["comments"]}),d({title:"Success",description:"Comment deleted successfully"})},onError:()=>{d({title:"Error",description:"Failed to delete comment",variant:"destructive"})}})},Je=({targetType:d,targetId:v,trigger:C,onLoginRequired:l})=>{const{t:r}=Le(),{user:n}=V(),[N,j]=u.useState(!1),[I,_]=u.useState(!1),[m,f]=u.useState(!1),[y,h]=u.useState(""),[x,s]=u.useState(""),[i,q]=u.useState(n?.email||""),[b,k]=u.useState([""]),[A,$]=u.useState([]),[K,H]=u.useState(!1),[L,F]=u.useState("form"),[T,R]=u.useState(""),[S,Q]=u.useState(0),[B,W]=u.useState(!1),se=t=>{if(t&&!n){l?.();return}j(t),t&&n?.email&&q(n.email),t||(F("form"),R(""),Q(0))};u.useEffect(()=>{let t;return S>0&&(t=setTimeout(()=>Q(S-1),1e3)),()=>clearTimeout(t)},[S]);const ae=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],ie=()=>{k([...b,""])},oe=t=>{k(b.filter((a,c)=>c!==t))},ne=(t,a)=>{const c=[...b];c[t]=a,k(c)},le=t=>{const a=Array.from(t.target.files||[]);if(a.filter(g=>g.size>5*1024*1024).length>0){o.error(r("report.imageTooLarge"));return}const D=["image/jpeg","image/png","image/webp","image/gif"];if(a.filter(g=>!D.includes(g.type)).length>0){o.error(r("report.invalidImageType"));return}$(g=>[...g,...a])},ce=t=>{$(a=>a.filter((c,D)=>D!==t))},de=async()=>{if(A.length===0)return[];H(!0);const t=[];try{for(const a of A){const c=a.name.split(".").pop(),E=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${c}`}`,{error:g}=await p.storage.from("report-evidence").upload(E,a);if(g)throw g;const{data:P}=p.storage.from("report-evidence").getPublicUrl(E);t.push(P.publicUrl)}return t}catch(a){throw console.error("Error uploading images:",a),a}finally{H(!1)}},G=async()=>{if(!i.trim()){o.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){o.error(r("report.invalidEmail"));return}W(!0);try{const{error:t}=await p.functions.invoke("send-verification-code",{body:{email:i}});if(t){o.error(r("auth.verificationCodeFailed")),console.error(t);return}F("verify"),o.success(r("auth.verificationCodeSent")),Q(30)}catch(t){o.error(t.message||r("error.general"))}finally{W(!1)}},me=async()=>{S>0||await G()},ue=async()=>{if(T.length!==4){o.error(r("auth.invalidVerificationCode"));return}f(!0);try{const{data:t,error:a}=await p.functions.invoke("verify-email-code",{body:{email:i,code:T}});if(a||!t?.success){t?.error==="This verification code has already been used"?o.error(r("auth.verificationCodeUsed")):o.error(t?.error||r("auth.invalidVerificationCode")),f(!1);return}F("submitting"),await X()}catch(t){o.error(t.message||r("error.general")),f(!1)}},pe=async()=>{if(!y){o.error(r("report.reasonPlaceholder"));return}if(!x||x.length<20){o.error(r("report.detailsMin"));return}if(!i.trim()){o.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){o.error(r("report.invalidEmail"));return}if(b.filter(a=>a.trim()!=="").length===0&&A.length===0){o.error(r("report.evidenceRequired"));return}n?_(!0):await G()},X=async()=>{f(!0);try{let t=[];try{t=await de()}catch{o.error(r("report.imageUploadFailed")),f(!1);return}const c=[...b.filter(z=>z.trim()!==""),...t],D={reporter_id:n?.id||null,target_type:d,target_id:v,reason:y,description:x,evidence_urls:c,reporter_contact:i};console.log("Attempting to insert report:",D);const{data:E,error:g}=await p.from("reports").insert(D).select().single();if(console.log("Insert result:",{report:E,error:g}),g)throw g;let P="Anonymous",J=i;if(n){const{data:z}=await p.from("profiles").select("display_name").eq("id",n.id).single();P=z?.display_name||"Unknown",J=n.email||i}await p.functions.invoke("send-report-email",{body:{reportId:E.id,reporterName:P,reporterEmail:J,targetType:d,targetId:v,reason:y,description:x,evidenceUrls:c.length>0?c:void 0,reporterContact:i||void 0}});const he=E.id.substring(0,8).toUpperCase();o.success(r("report.successDetailed",{reference:he}),{description:r("report.successDescription"),duration:8e3}),j(!1),_(!1),h(""),s(""),n||q(""),k([""]),$([]),F("form"),R("")}catch(t){console.error("Error submitting report:",t),o.error(r("report.failed"))}finally{f(!1)}},fe=()=>{switch(d){case"comment":return r("report.reportComment");case"restaurant":return r("report.reportRestaurant");case"activity":return r("report.reportActivity");case"user":return r("report.reportUser");default:return r("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{open:N,onOpenChange:se,children:[e.jsx(ve,{asChild:!0,children:C||e.jsxs(w,{variant:"ghost",size:"sm",children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),r("report.title")]})}),e.jsxs(ye,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ce,{children:[e.jsx(we,{children:fe()}),e.jsx(_e,{children:r(L==="verify"?"auth.verificationCodeSent":"report.description")})]}),L==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"reason",children:r("report.reason")}),e.jsxs(be,{value:y,onValueChange:h,children:[e.jsx(Ne,{children:e.jsx(Se,{placeholder:r("report.reasonPlaceholder")})}),e.jsx(De,{children:ae.map(t=>e.jsx(Ee,{value:t,children:r(`report.reasons.${t}`)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"description",children:r("report.detailsLabel")}),e.jsx(Ue,{id:"description",value:x,onChange:t=>s(t.target.value),placeholder:r("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x.length,"/20 ",r("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"contact",children:[r("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(O,{id:"contact",type:"email",value:i,onChange:t=>q(t.target.value),placeholder:r("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{children:[r("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:r("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"image-upload",className:"text-sm font-medium",children:r("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:A.map((t,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Evidence ${a+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(w,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>ce(a),children:e.jsx(Y,{className:"w-3 h-3"})})]},a))}),e.jsx(O,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:le,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(U,{className:"text-sm font-medium",children:r("report.evidenceUrls")}),b.map((t,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{value:t,onChange:c=>ne(a,c.target.value),placeholder:r("report.evidencePlaceholder")}),b.length>1&&e.jsx(w,{variant:"ghost",size:"icon",onClick:()=>oe(a),children:e.jsx(Y,{className:"w-4 h-4"})})]},a)),e.jsxs(w,{variant:"outline",size:"sm",onClick:ie,className:"w-full",children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),r("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(w,{variant:"outline",onClick:()=>j(!1),children:r("report.cancel")}),e.jsx(w,{onClick:pe,disabled:!y||x.length<20||!i.trim()||b.filter(t=>t.trim()!=="").length===0&&A.length===0||K||B,children:r(K?"common.uploading":B?"auth.sendingCode":"report.submit")})]})]}):L==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:r("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:r("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Me,{maxLength:4,value:T,onChange:t=>R(t),children:e.jsxs($e,{children:[e.jsx(M,{index:0}),e.jsx(M,{index:1}),e.jsx(M,{index:2}),e.jsx(M,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:r("auth.verificationCodeHint",{email:i})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(w,{variant:"link",size:"sm",onClick:me,disabled:S>0||m,children:S>0?`${r("auth.resendCode")} (${S}s)`:r("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",className:"w-full",onClick:()=>{F("form"),R("")},disabled:m,children:r("common.back")}),e.jsx(w,{className:"w-full",onClick:ue,disabled:T.length!==4||m,children:r(m?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(qe,{open:I,onOpenChange:_,children:e.jsxs(Ae,{children:[e.jsxs(Fe,{children:[e.jsx(ke,{children:r("report.confirmTitle")}),e.jsx(Te,{children:r("report.confirmMessage")})]}),e.jsxs(Re,{children:[e.jsx(Pe,{children:r("report.cancel")}),e.jsx(ze,{onClick:X,disabled:m,children:r(m?"report.submitting":"report.submit")})]})]})})]})};export{Je as R,Ge as a,Xe as b,We as u};
//# sourceMappingURL=ReportDialog-BHJjnQJa.js.map
