import{s as ve,q as Z,v as ee,p as te,r as c,j as e,by as xe,X as Y,bW as ye,w as u,cf as je}from"./vendor-react-3frukg7q.js";import{u as W,s as j,f as re,D as we,W as be,B as N,c as Ce,d as _e,e as Ne,T as Se,U as q,a2 as Ee,a3 as Te,a4 as De,a5 as Ie,a6 as qe,a8 as Ue,I as K,A as ke,t as Fe,v as Ae,w as Re,x as Me,y as Pe,z as Le,E as ze}from"./index-DBl0LkXN.js";import{I as $e,a as Qe,b as L}from"./input-otp-Cjek56dc.js";const se=new Set,He=(n,x="restaurant",d)=>{const{user:m}=W();return ve({queryKey:["comments",n,x],enabled:d?.enabled!==!1&&!!n,queryFn:async()=>{let t=j.from("comments").select("*").eq("target_id",n).eq("target_type",x).order("created_at",{ascending:!1});const{data:l,error:_}=await t;if(_)throw _;if(!l||l.length===0)return[];const f=l.filter(s=>s.moderation_status==="approved"||m&&s.user_id===m.id&&s.moderation_status==="pending"||m&&s.user_id===m.id&&s.moderation_status==="flagged"&&se.has(s.id)),C=[...new Set(f.map(s=>s.user_id))],{data:y}=await j.rpc("get_public_profiles",{user_ids:C}),h=new Map((y||[]).map(s=>[s.id,{display_name:s.display_name,avatar_url:s.avatar_url}])),g=f.filter(s=>!s.parent_id),w=f.filter(s=>s.parent_id),o=new Map;return w.forEach(s=>{const a=s.parent_id;o.has(a)||o.set(a,[]),o.get(a).push(s)}),g.map(s=>({...s,moderation_status:s.moderation_status,profiles:h.get(s.user_id),replies:(o.get(s.id)||[]).sort((a,E)=>new Date(a.created_at).getTime()-new Date(E.created_at).getTime()).map(a=>({...a,moderation_status:a.moderation_status,profiles:h.get(a.user_id)}))}))},staleTime:3e4})},Ve=()=>{const{user:n}=W(),{toast:x}=re(),d=Z();return ee({mutationFn:async({targetId:m,targetType:t,content:l,ratingValue:_,priceRange:f,imageUrl:C,parentId:y})=>{if(!n)throw new Error("User not authenticated");const h={user_id:n.id,target_id:m,target_type:t,content:l,parent_id:y,moderation_status:"pending"};y||(_&&(h.rating_value=_),f&&(h.price_range=f)),C&&(h.image_url=C);const{data:g,error:w}=await j.from("comments").insert(h).select().single();if(w)throw w;try{const{data:o,error:p}=await j.functions.invoke("moderate-comment",{body:{comment_id:g.id,content:l,user_id:n.id,sensitive_word_detected:!1,target_id:m,target_type:t}});p&&(console.error("AI moderation error:",p),await j.from("comments").update({moderation_status:"approved"}).eq("id",g.id))}catch(o){console.error("Failed to invoke AI moderation:",o),await j.from("comments").update({moderation_status:"approved"}).eq("id",g.id)}return g},onSuccess:(m,t)=>{m?.id&&se.add(m.id),d.invalidateQueries({queryKey:["comments",t.targetId,t.targetType]}),d.invalidateQueries({queryKey:["restaurants"]}),d.invalidateQueries({queryKey:["restaurant",t.targetId]}),t.targetType==="post"&&(d.invalidateQueries({queryKey:["community-post",t.targetId]}),d.invalidateQueries({queryKey:["community-posts"]}))},onError:()=>{x({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Oe=()=>{const{t:n}=te(),{toast:x}=re(),d=Z();return ee({mutationFn:async m=>{const{error:t}=await j.from("comments").delete().eq("id",m);if(t)throw t},onSuccess:(m,t)=>{d.invalidateQueries({queryKey:["comments"]}),d.invalidateQueries({queryKey:["community-post"]}),d.invalidateQueries({queryKey:["community-posts"]}),x({title:n("common.success","Success"),description:n("toast.commentDeleted","Comment deleted successfully")})},onError:()=>{x({title:n("common.error","Error"),description:n("toast.commentDeleteFailed","Failed to delete comment"),variant:"destructive"})}})},Be=({targetType:n,targetId:x,trigger:d,onLoginRequired:m})=>{const{t}=te(),{user:l}=W(),[_,f]=c.useState(!1),[C,y]=c.useState(!1),[h,g]=c.useState(!1),[w,o]=c.useState(""),[p,s]=c.useState(""),[a,E]=c.useState(l?.email||""),[S,F]=c.useState([""]),[U,z]=c.useState([]),[H,V]=c.useState(!1),[$,k]=c.useState("form"),[A,R]=c.useState(""),[T,Q]=c.useState(0),[O,B]=c.useState(!1),ae=r=>{if(r&&!l){m?.();return}f(r),r&&l?.email&&E(l.email),r||(k("form"),R(""),Q(0))};c.useEffect(()=>{let r;return T>0&&(r=setTimeout(()=>Q(T-1),1e3)),()=>clearTimeout(r)},[T]);const oe=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],ie=()=>{F([...S,""])},ne=r=>{F(S.filter((i,v)=>v!==r))},le=(r,i)=>{const v=[...S];v[r]=i,F(v)},ce=r=>{const i=Array.from(r.target.files||[]);if(i.filter(b=>b.size>5*1024*1024).length>0){u.error(t("report.imageTooLarge"));return}const D=["image/jpeg","image/png","image/webp","image/gif"];if(i.filter(b=>!D.includes(b.type)).length>0){u.error(t("report.invalidImageType"));return}z(b=>[...b,...i])},de=r=>{z(i=>i.filter((v,D)=>D!==r))},ue=async()=>{if(U.length===0)return[];V(!0);const r=[];try{for(const i of U){const v=i.name.split(".").pop(),I=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${v}`}`,{error:b}=await j.storage.from("report-evidence").upload(I,i);if(b)throw b;const{data:M}=j.storage.from("report-evidence").getPublicUrl(I);r.push(M.publicUrl)}return r}catch(i){throw console.error("Error uploading images:",i),i}finally{V(!1)}},G=async()=>{if(!a.trim()){u.error(t("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)){u.error(t("report.invalidEmail"));return}B(!0);try{const{error:r}=await j.functions.invoke("send-verification-code",{body:{email:a}});if(r){u.error(t("auth.verificationCodeFailed")),console.error(r);return}k("verify"),u.success(t("auth.verificationCodeSent")),Q(30)}catch(r){u.error(r.message||t("error.general"))}finally{B(!1)}},me=async()=>{T>0||await G()},pe=async()=>{if(A.length!==4){u.error(t("auth.invalidVerificationCode"));return}g(!0);try{const{data:r,error:i}=await j.functions.invoke("verify-email-code",{body:{email:a,code:A}});if(i||!r?.success){r?.error==="This verification code has already been used"?u.error(t("auth.verificationCodeUsed")):u.error(r?.error||t("auth.invalidVerificationCode")),g(!1);return}k("submitting"),await X()}catch(r){u.error(r.message||t("error.general")),g(!1)}},fe=async()=>{if(!w){u.error(t("report.reasonPlaceholder"));return}if(!p||p.length<20){u.error(t("report.detailsMin"));return}if(!a.trim()){u.error(t("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)){u.error(t("report.invalidEmail"));return}if(S.filter(i=>i.trim()!=="").length===0&&U.length===0){u.error(t("report.evidenceRequired"));return}l?y(!0):await G()},X=async()=>{g(!0);try{let r=[];try{r=await ue()}catch{u.error(t("report.imageUploadFailed")),g(!1);return}const v=[...S.filter(P=>P.trim()!==""),...r],D={reporter_id:l?.id||null,target_type:n,target_id:x,reason:w,description:p,evidence_urls:v,reporter_contact:a};console.log("Attempting to insert report:",D);const{data:I,error:b}=await j.from("reports").insert(D).select().single();if(console.log("Insert result:",{report:I,error:b}),b)throw b;let M="Anonymous",J=a;if(l){const{data:P}=await j.from("profiles").select("display_name").eq("id",l.id).single();M=P?.display_name||"Unknown",J=l.email||a}await j.functions.invoke("send-report-email",{body:{reportId:I.id,reporterName:M,reporterEmail:J,targetType:n,targetId:x,reason:w,description:p,evidenceUrls:v.length>0?v:void 0,reporterContact:a||void 0}});const ge=I.id.substring(0,8).toUpperCase();u.success(t("report.successDetailed",{reference:ge}),{description:t("report.successDescription"),duration:8e3}),f(!1),y(!1),o(""),s(""),l||E(""),F([""]),z([]),k("form"),R("")}catch(r){console.error("Error submitting report:",r),u.error(t("report.failed"))}finally{g(!1)}},he=()=>{switch(n){case"comment":return t("report.reportComment");case"restaurant":return t("report.reportRestaurant");case"activity":return t("report.reportActivity");case"user":return t("report.reportUser");default:return t("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(we,{open:_,onOpenChange:ae,children:[e.jsx(be,{asChild:!0,children:d||e.jsxs(N,{variant:"ghost",size:"sm",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),t("report.title")]})}),e.jsxs(Ce,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(Ne,{children:he()}),e.jsx(Se,{children:t($==="verify"?"auth.verificationCodeSent":"report.description")})]}),$==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"reason",children:t("report.reason")}),e.jsxs(Ee,{value:w,onValueChange:o,children:[e.jsx(Te,{children:e.jsx(De,{placeholder:t("report.reasonPlaceholder")})}),e.jsx(Ie,{children:oe.map(r=>e.jsx(qe,{value:r,children:t(`report.reasons.${r}`)},r))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"description",children:t("report.detailsLabel")}),e.jsx(Ue,{id:"description",value:p,onChange:r=>s(r.target.value),placeholder:t("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[p.length,"/20 ",t("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"contact",children:[t("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(K,{id:"contact",type:"email",value:a,onChange:r=>E(r.target.value),placeholder:t("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{children:[t("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:t("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"image-upload",className:"text-sm font-medium",children:t("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:U.map((r,i)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(r),alt:`Evidence ${i+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(N,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>de(i),children:e.jsx(Y,{className:"w-3 h-3"})})]},i))}),e.jsx(K,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:ce,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(q,{className:"text-sm font-medium",children:t("report.evidenceUrls")}),S.map((r,i)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{value:r,onChange:v=>le(i,v.target.value),placeholder:t("report.evidencePlaceholder")}),S.length>1&&e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>ne(i),children:e.jsx(Y,{className:"w-4 h-4"})})]},i)),e.jsxs(N,{variant:"outline",size:"sm",onClick:ie,className:"w-full",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),t("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(N,{variant:"outline",onClick:()=>f(!1),children:t("report.cancel")}),e.jsx(N,{onClick:fe,disabled:!w||p.length<20||!a.trim()||S.filter(r=>r.trim()!=="").length===0&&U.length===0||H||O,children:t(H?"common.uploading":O?"auth.sendingCode":"report.submit")})]})]}):$==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:t("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{children:t("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{maxLength:4,value:A,onChange:r=>R(r),children:e.jsxs(Qe,{children:[e.jsx(L,{index:0}),e.jsx(L,{index:1}),e.jsx(L,{index:2}),e.jsx(L,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:t("auth.verificationCodeHint",{email:a})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(N,{variant:"link",size:"sm",onClick:me,disabled:T>0||h,children:T>0?`${t("auth.resendCode")} (${T}s)`:t("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{variant:"outline",className:"w-full",onClick:()=>{k("form"),R("")},disabled:h,children:t("common.back")}),e.jsx(N,{className:"w-full",onClick:pe,disabled:A.length!==4||h,children:t(h?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(ke,{open:C,onOpenChange:y,children:e.jsxs(Fe,{children:[e.jsxs(Ae,{children:[e.jsx(Re,{children:t("report.confirmTitle")}),e.jsx(Me,{children:t("report.confirmMessage")})]}),e.jsxs(Pe,{children:[e.jsx(Le,{children:t("report.cancel")}),e.jsx(ze,{onClick:X,disabled:h,children:t(h?"report.submitting":"report.submit")})]})]})})]})},Ge=({imageUrl:n,isOpen:x,onClose:d})=>{const[m,t]=c.useState(!1),[l,_]=c.useState(!1),[f,C]=c.useState(null),y=c.useRef(null);c.useEffect(()=>{if(x){const o=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${o}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.overflow="",window.scrollTo(0,o)}}},[x]),c.useEffect(()=>{t(!1),_(!1)},[n]);const h=o=>{const p=o.currentTarget,s=p.naturalHeight/p.naturalWidth;t(s>1.5),_(!0)},g=o=>{o.target===o.currentTarget&&d()},w=o=>{if(!f)return;const p=o.changedTouches[0],s=Math.abs(p.clientY-f.y),a=y.current,E=a?Math.abs(a.scrollTop-f.scrollTop):0;s<15&&E<15&&(o.preventDefault(),d()),C(null)};return x?je.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black",style:{left:0,right:0,top:0,bottom:0,width:"100vw",height:"100dvh",overflow:"hidden",margin:0,padding:0},children:[e.jsx(N,{variant:"ghost",size:"icon",className:"absolute top-4 right-4 z-10 text-white hover:bg-white/20",onClick:d,children:e.jsx(Y,{className:"h-6 w-6"})}),e.jsxs("div",{ref:y,className:"w-full h-full overflow-x-hidden overscroll-contain",style:{overflowY:m?"scroll":"hidden",WebkitOverflowScrolling:"touch"},onClick:g,onTouchStart:o=>{C({y:o.touches[0].clientY,scrollTop:y.current?.scrollTop||0})},onTouchEnd:w,onMouseDown:o=>{C({y:o.clientY,scrollTop:y.current?.scrollTop||0})},onMouseUp:o=>{if(f){const p=Math.abs(o.clientY-f.y),s=y.current,a=s?Math.abs(s.scrollTop-f.scrollTop):0;p<10&&a<10&&d(),C(null)}},children:[!l&&e.jsx("img",{src:n,alt:"",onLoad:h,style:{position:"absolute",opacity:0,pointerEvents:"none"}}),l&&(m?e.jsx("img",{src:n,alt:"",draggable:!1,className:"block select-none",style:{width:"100vw",minWidth:"100vw",minHeight:"100dvh",height:"auto",margin:0,objectFit:"cover",objectPosition:"top center"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",onClick:d,children:e.jsx("img",{src:n,alt:"",draggable:!1,className:"max-w-full max-h-full object-contain select-none"})}))]})]}),document.body):null};export{Ge as I,Be as R,Ve as a,Oe as b,He as u};
//# sourceMappingURL=ImagePreviewModal-CKkIjfYK.js.map
