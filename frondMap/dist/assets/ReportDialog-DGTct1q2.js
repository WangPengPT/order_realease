import{s as ve,q as J,v as ee,p as te,r as u,j as e,bC as xe,X as Z,bY as ye,w as o}from"./vendor-react-87iFmKFJ.js";import{u as V,s as p,z as re,D as je,a0 as Ce,h as w,c as we,d as _e,e as be,Y as Ne,Z as q,a7 as Se,a8 as De,a9 as Ee,aa as qe,ab as Ie,ad as Ue,I as L,A as Fe,q as Ae,r as Te,t as ke,v as Re,w as Pe,x as ze,y as Qe}from"./index-CH4FpCej.js";import{I as $e,a as Ke,b as Q}from"./input-otp-uTF1jlLx.js";const se=new Set,Oe=(l,x="restaurant",f)=>{const{user:c}=V();return ve({queryKey:["comments",l,x],enabled:f?.enabled!==!1&&!!l,queryFn:async()=>{let t=p.from("comments").select("*").eq("target_id",l).eq("target_type",x).order("created_at",{ascending:!1});const{data:n,error:N}=await t;if(N)throw N;if(!n||n.length===0)return[];const y=n.filter(s=>s.moderation_status==="approved"||c&&s.user_id===c.id&&s.moderation_status==="pending"||c&&s.user_id===c.id&&s.moderation_status==="flagged"&&se.has(s.id)),I=[...new Set(y.map(s=>s.user_id))],{data:_}=await p.rpc("get_public_profiles",{user_ids:I}),m=new Map((_||[]).map(s=>[s.id,{display_name:s.display_name,avatar_url:s.avatar_url}])),h=y.filter(s=>!s.parent_id),j=y.filter(s=>s.parent_id),C=new Map;return j.forEach(s=>{const i=s.parent_id;C.has(i)||C.set(i,[]),C.get(i).push(s)}),h.map(s=>({...s,moderation_status:s.moderation_status,profiles:m.get(s.user_id),replies:(C.get(s.id)||[]).sort((i,U)=>new Date(i.created_at).getTime()-new Date(U.created_at).getTime()).map(i=>({...i,moderation_status:i.moderation_status,profiles:m.get(i.user_id)}))}))},staleTime:3e4})},He=()=>{const{user:l}=V(),{toast:x}=re(),f=J();return ee({mutationFn:async({targetId:c,targetType:t,content:n,ratingValue:N,priceRange:y,imageUrl:I,parentId:_})=>{if(!l)throw new Error("User not authenticated");const m={user_id:l.id,target_id:c,target_type:t,content:n,parent_id:_,moderation_status:"pending"};_||(N&&(m.rating_value=N),y&&(m.price_range=y)),I&&(m.image_url=I);const{data:h,error:j}=await p.from("comments").insert(m).select().single();if(j)throw j;try{const{data:C,error:v}=await p.functions.invoke("moderate-comment",{body:{comment_id:h.id,content:n,user_id:l.id,sensitive_word_detected:!1,target_id:c,target_type:t}});v&&(console.error("AI moderation error:",v),await p.from("comments").update({moderation_status:"approved"}).eq("id",h.id))}catch(C){console.error("Failed to invoke AI moderation:",C),await p.from("comments").update({moderation_status:"approved"}).eq("id",h.id)}return h},onSuccess:(c,t)=>{c?.id&&se.add(c.id),f.invalidateQueries({queryKey:["comments",t.targetId,t.targetType]}),f.invalidateQueries({queryKey:["restaurants"]}),f.invalidateQueries({queryKey:["restaurant",t.targetId]}),t.targetType==="post"&&(f.invalidateQueries({queryKey:["community-post",t.targetId]}),f.invalidateQueries({queryKey:["community-posts"]}))},onError:()=>{x({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Be=()=>{const{t:l}=te(),{toast:x}=re(),f=J();return ee({mutationFn:async c=>{const{error:t}=await p.from("comments").delete().eq("id",c);if(t)throw t},onSuccess:(c,t)=>{f.invalidateQueries({queryKey:["comments"]}),f.invalidateQueries({queryKey:["community-post"]}),f.invalidateQueries({queryKey:["community-posts"]}),x({title:l("common.success","Success"),description:l("toast.commentDeleted","Comment deleted successfully")})},onError:()=>{x({title:l("common.error","Error"),description:l("toast.commentDeleteFailed","Failed to delete comment"),variant:"destructive"})}})},We=({targetType:l,targetId:x,trigger:f,onLoginRequired:c})=>{const{t}=te(),{user:n}=V(),[N,y]=u.useState(!1),[I,_]=u.useState(!1),[m,h]=u.useState(!1),[j,C]=u.useState(""),[v,s]=u.useState(""),[i,U]=u.useState(n?.email||""),[b,T]=u.useState([""]),[F,$]=u.useState([]),[O,H]=u.useState(!1),[K,A]=u.useState("form"),[k,R]=u.useState(""),[S,M]=u.useState(0),[B,W]=u.useState(!1),ae=r=>{if(r&&!n){c?.();return}y(r),r&&n?.email&&U(n.email),r||(A("form"),R(""),M(0))};u.useEffect(()=>{let r;return S>0&&(r=setTimeout(()=>M(S-1),1e3)),()=>clearTimeout(r)},[S]);const ie=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],oe=()=>{T([...b,""])},ne=r=>{T(b.filter((a,d)=>d!==r))},le=(r,a)=>{const d=[...b];d[r]=a,T(d)},ce=r=>{const a=Array.from(r.target.files||[]);if(a.filter(g=>g.size>5*1024*1024).length>0){o.error(t("report.imageTooLarge"));return}const D=["image/jpeg","image/png","image/webp","image/gif"];if(a.filter(g=>!D.includes(g.type)).length>0){o.error(t("report.invalidImageType"));return}$(g=>[...g,...a])},de=r=>{$(a=>a.filter((d,D)=>D!==r))},me=async()=>{if(F.length===0)return[];H(!0);const r=[];try{for(const a of F){const d=a.name.split(".").pop(),E=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${d}`}`,{error:g}=await p.storage.from("report-evidence").upload(E,a);if(g)throw g;const{data:P}=p.storage.from("report-evidence").getPublicUrl(E);r.push(P.publicUrl)}return r}catch(a){throw console.error("Error uploading images:",a),a}finally{H(!1)}},Y=async()=>{if(!i.trim()){o.error(t("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){o.error(t("report.invalidEmail"));return}W(!0);try{const{error:r}=await p.functions.invoke("send-verification-code",{body:{email:i}});if(r){o.error(t("auth.verificationCodeFailed")),console.error(r);return}A("verify"),o.success(t("auth.verificationCodeSent")),M(30)}catch(r){o.error(r.message||t("error.general"))}finally{W(!1)}},ue=async()=>{S>0||await Y()},pe=async()=>{if(k.length!==4){o.error(t("auth.invalidVerificationCode"));return}h(!0);try{const{data:r,error:a}=await p.functions.invoke("verify-email-code",{body:{email:i,code:k}});if(a||!r?.success){r?.error==="This verification code has already been used"?o.error(t("auth.verificationCodeUsed")):o.error(r?.error||t("auth.invalidVerificationCode")),h(!1);return}A("submitting"),await G()}catch(r){o.error(r.message||t("error.general")),h(!1)}},fe=async()=>{if(!j){o.error(t("report.reasonPlaceholder"));return}if(!v||v.length<20){o.error(t("report.detailsMin"));return}if(!i.trim()){o.error(t("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){o.error(t("report.invalidEmail"));return}if(b.filter(a=>a.trim()!=="").length===0&&F.length===0){o.error(t("report.evidenceRequired"));return}n?_(!0):await Y()},G=async()=>{h(!0);try{let r=[];try{r=await me()}catch{o.error(t("report.imageUploadFailed")),h(!1);return}const d=[...b.filter(z=>z.trim()!==""),...r],D={reporter_id:n?.id||null,target_type:l,target_id:x,reason:j,description:v,evidence_urls:d,reporter_contact:i};console.log("Attempting to insert report:",D);const{data:E,error:g}=await p.from("reports").insert(D).select().single();if(console.log("Insert result:",{report:E,error:g}),g)throw g;let P="Anonymous",X=i;if(n){const{data:z}=await p.from("profiles").select("display_name").eq("id",n.id).single();P=z?.display_name||"Unknown",X=n.email||i}await p.functions.invoke("send-report-email",{body:{reportId:E.id,reporterName:P,reporterEmail:X,targetType:l,targetId:x,reason:j,description:v,evidenceUrls:d.length>0?d:void 0,reporterContact:i||void 0}});const ge=E.id.substring(0,8).toUpperCase();o.success(t("report.successDetailed",{reference:ge}),{description:t("report.successDescription"),duration:8e3}),y(!1),_(!1),C(""),s(""),n||U(""),T([""]),$([]),A("form"),R("")}catch(r){console.error("Error submitting report:",r),o.error(t("report.failed"))}finally{h(!1)}},he=()=>{switch(l){case"comment":return t("report.reportComment");case"restaurant":return t("report.reportRestaurant");case"activity":return t("report.reportActivity");case"user":return t("report.reportUser");default:return t("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(je,{open:N,onOpenChange:ae,children:[e.jsx(Ce,{asChild:!0,children:f||e.jsxs(w,{variant:"ghost",size:"sm",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),t("report.title")]})}),e.jsxs(we,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(be,{children:he()}),e.jsx(Ne,{children:t(K==="verify"?"auth.verificationCodeSent":"report.description")})]}),K==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"reason",children:t("report.reason")}),e.jsxs(Se,{value:j,onValueChange:C,children:[e.jsx(De,{children:e.jsx(Ee,{placeholder:t("report.reasonPlaceholder")})}),e.jsx(qe,{children:ie.map(r=>e.jsx(Ie,{value:r,children:t(`report.reasons.${r}`)},r))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"description",children:t("report.detailsLabel")}),e.jsx(Ue,{id:"description",value:v,onChange:r=>s(r.target.value),placeholder:t("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[v.length,"/20 ",t("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"contact",children:[t("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(L,{id:"contact",type:"email",value:i,onChange:r=>U(r.target.value),placeholder:t("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{children:[t("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:t("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"image-upload",className:"text-sm font-medium",children:t("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:F.map((r,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(r),alt:`Evidence ${a+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(w,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>de(a),children:e.jsx(Z,{className:"w-3 h-3"})})]},a))}),e.jsx(L,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:ce,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(q,{className:"text-sm font-medium",children:t("report.evidenceUrls")}),b.map((r,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{value:r,onChange:d=>le(a,d.target.value),placeholder:t("report.evidencePlaceholder")}),b.length>1&&e.jsx(w,{variant:"ghost",size:"icon",onClick:()=>ne(a),children:e.jsx(Z,{className:"w-4 h-4"})})]},a)),e.jsxs(w,{variant:"outline",size:"sm",onClick:oe,className:"w-full",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),t("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(w,{variant:"outline",onClick:()=>y(!1),children:t("report.cancel")}),e.jsx(w,{onClick:fe,disabled:!j||v.length<20||!i.trim()||b.filter(r=>r.trim()!=="").length===0&&F.length===0||O||B,children:t(O?"common.uploading":B?"auth.sendingCode":"report.submit")})]})]}):K==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:t("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{children:t("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{maxLength:4,value:k,onChange:r=>R(r),children:e.jsxs(Ke,{children:[e.jsx(Q,{index:0}),e.jsx(Q,{index:1}),e.jsx(Q,{index:2}),e.jsx(Q,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:t("auth.verificationCodeHint",{email:i})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(w,{variant:"link",size:"sm",onClick:ue,disabled:S>0||m,children:S>0?`${t("auth.resendCode")} (${S}s)`:t("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",className:"w-full",onClick:()=>{A("form"),R("")},disabled:m,children:t("common.back")}),e.jsx(w,{className:"w-full",onClick:pe,disabled:k.length!==4||m,children:t(m?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(Fe,{open:I,onOpenChange:_,children:e.jsxs(Ae,{children:[e.jsxs(Te,{children:[e.jsx(ke,{children:t("report.confirmTitle")}),e.jsx(Re,{children:t("report.confirmMessage")})]}),e.jsxs(Pe,{children:[e.jsx(ze,{children:t("report.cancel")}),e.jsx(Qe,{onClick:G,disabled:m,children:t(m?"report.submitting":"report.submit")})]})]})})]})};export{We as R,He as a,Be as b,Oe as u};
//# sourceMappingURL=ReportDialog-DGTct1q2.js.map
