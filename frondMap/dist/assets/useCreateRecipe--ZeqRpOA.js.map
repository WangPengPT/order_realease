{"version":3,"file":"useCreateRecipe--ZeqRpOA.js","sources":["../../src/hooks/useCreateRecipe.ts"],"sourcesContent":["import { useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Ingredient, RecipeStep, RecipeDifficulty } from \"@/components/community/recipe/RecipeTypes\";\r\n\r\ninterface CreateRecipeParams {\r\n  recipe_name: string;\r\n  recipe_name_en?: string;\r\n  recipe_name_pt?: string;\r\n  subtitle?: string;\r\n  subtitle_en?: string;\r\n  subtitle_pt?: string;\r\n  cook_time: number;\r\n  difficulty: RecipeDifficulty;\r\n  servings: number;\r\n  ingredients: Ingredient[];\r\n  steps: RecipeStep[];\r\n  cover_image?: string | null;\r\n  introduction?: string;\r\n  introduction_en?: string;\r\n  introduction_pt?: string;\r\n  cooking_note?: string;\r\n  // Optional fields\r\n  nutrition?: {\r\n    calories?: number;\r\n    protein?: number;\r\n    carbs?: number;\r\n    fat?: number;\r\n  };\r\n  recipe_tags?: string[];\r\n  recipe_category?: string;\r\n  ai_recipe_source?: Record<string, any>;\r\n}\r\n\r\n// Build structured content string: [[NOTE]]心得\\n[[INTRO]]介绍\r\nconst buildContent = (note: string, intro: string) => {\r\n  if (note && intro) return `[[NOTE]]${note}\\n[[INTRO]]${intro}`;\r\n  if (note) return `[[NOTE]]${note}`;\r\n  return intro;\r\n};\r\n\r\nexport const useCreateRecipe = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (params: CreateRecipeParams) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const note = params.cooking_note?.trim() || \"\";\r\n      // Primary content (zh) = note + zh introduction\r\n      const content = buildContent(note, params.introduction?.trim() || \"\");\r\n      // Localized content variants (note stays as-is, intro is localized)\r\n      const content_en = buildContent(note, params.introduction_en?.trim() || \"\");\r\n      const content_pt = buildContent(note, params.introduction_pt?.trim() || \"\");\r\n\r\n      // Prepare image_urls (cover image first if present)\r\n      const imageUrls: string[] = [];\r\n      if (params.cover_image) {\r\n        imageUrls.push(params.cover_image);\r\n      }\r\n      // Add step images (support both image_urls array and legacy image_url)\r\n      params.steps.forEach(step => {\r\n        if (step.image_urls && step.image_urls.length > 0) {\r\n          step.image_urls.forEach(url => imageUrls.push(url));\r\n        } else if (step.image_url) {\r\n          imageUrls.push(step.image_url);\r\n        }\r\n      });\r\n\r\n      // Insert the recipe post\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .insert({\r\n          author_id: user.id,\r\n          post_type: \"recipe\",\r\n          content,\r\n          content_zh: content || null,\r\n          content_en: content_en || null,\r\n          content_pt: content_pt || null,\r\n          image_urls: imageUrls,\r\n          recipe_name: params.recipe_name,\r\n          recipe_name_en: params.recipe_name_en || null,\r\n          recipe_name_pt: params.recipe_name_pt || null,\r\n          subtitle: params.subtitle || null,\r\n          subtitle_en: params.subtitle_en || null,\r\n          subtitle_pt: params.subtitle_pt || null,\r\n          cook_time: params.cook_time,\r\n          difficulty: params.difficulty,\r\n          servings: params.servings,\r\n          ingredients: params.ingredients as unknown as any,\r\n          steps: params.steps as unknown as any,\r\n          nutrition: params.nutrition ? (params.nutrition as unknown as any) : null,\r\n          recipe_tags: params.recipe_tags || null,\r\n          recipe_category: params.recipe_category || null,\r\n          ai_recipe_source: params.ai_recipe_source ? (params.ai_recipe_source as unknown as any) : null,\r\n          status: \"pending\",\r\n          moderation_status: \"pending\",\r\n        } as any)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Call moderation function\r\n      try {\r\n        await supabase.functions.invoke(\"moderate-post\", {\r\n          body: {\r\n            post_id: data.id,\r\n            content,\r\n            user_id: user.id,\r\n            image_urls: imageUrls,\r\n          },\r\n        });\r\n      } catch (err) {\r\n        console.error(\"Moderation call failed:\", err);\r\n      }\r\n\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"has-posted-today\"] });\r\n      toast.success(t(\"recipe.publishSuccess\", \"食谱发布成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Create recipe error:\", error);\r\n      toast.error(t(\"recipe.publishError\", \"发布失败\"));\r\n    },\r\n  });\r\n};\r\n"],"names":["buildContent","note","intro","useCreateRecipe","queryClient","useQueryClient","t","useTranslation","useMutation","params","user","supabase","content","content_en","content_pt","imageUrls","step","url","data","error","err","toast"],"mappings":"uGAoCA,MAAMA,EAAe,CAACC,EAAcC,IAC9BD,GAAQC,EAAc,WAAWD,CAAI;AAAA,WAAcC,CAAK,GACxDD,EAAa,WAAWA,CAAI,GACzBC,EAGIC,EAAkB,IAAM,CACnC,MAAMC,EAAcC,IACd,CAAE,EAAAC,GAAMC,IAEd,OAAOC,EAAY,CACjB,WAAY,MAAOC,GAA+B,CAC1C,KAAA,CAAE,KAAM,CAAE,KAAAC,IAAW,MAAMC,EAAS,KAAK,UAC/C,GAAI,CAACD,EAAY,MAAA,IAAI,MAAM,mBAAmB,EAE9C,MAAMT,EAAOQ,EAAO,cAAc,KAAA,GAAU,GAEtCG,EAAUZ,EAAaC,EAAMQ,EAAO,cAAc,KAAA,GAAU,EAAE,EAE9DI,EAAab,EAAaC,EAAMQ,EAAO,iBAAiB,KAAA,GAAU,EAAE,EACpEK,EAAad,EAAaC,EAAMQ,EAAO,iBAAiB,KAAA,GAAU,EAAE,EAGpEM,EAAsB,CAAA,EACxBN,EAAO,aACCM,EAAA,KAAKN,EAAO,WAAW,EAG5BA,EAAA,MAAM,QAAgBO,GAAA,CACvBA,EAAK,YAAcA,EAAK,WAAW,OAAS,EAC9CA,EAAK,WAAW,QAAQC,GAAOF,EAAU,KAAKE,CAAG,CAAC,EACzCD,EAAK,WACJD,EAAA,KAAKC,EAAK,SAAS,CAC/B,CACD,EAGK,KAAA,CAAE,KAAAE,EAAM,MAAAC,GAAU,MAAMR,EAC3B,KAAK,iBAAiB,EACtB,OAAO,CACN,UAAWD,EAAK,GAChB,UAAW,SACX,QAAAE,EACA,WAAYA,GAAW,KACvB,WAAYC,GAAc,KAC1B,WAAYC,GAAc,KAC1B,WAAYC,EACZ,YAAaN,EAAO,YACpB,eAAgBA,EAAO,gBAAkB,KACzC,eAAgBA,EAAO,gBAAkB,KACzC,SAAUA,EAAO,UAAY,KAC7B,YAAaA,EAAO,aAAe,KACnC,YAAaA,EAAO,aAAe,KACnC,UAAWA,EAAO,UAClB,WAAYA,EAAO,WACnB,SAAUA,EAAO,SACjB,YAAaA,EAAO,YACpB,MAAOA,EAAO,MACd,UAAWA,EAAO,UAAaA,EAAO,UAA+B,KACrE,YAAaA,EAAO,aAAe,KACnC,gBAAiBA,EAAO,iBAAmB,KAC3C,iBAAkBA,EAAO,iBAAoBA,EAAO,iBAAsC,KAC1F,OAAQ,UACR,kBAAmB,SAAA,CACb,EACP,SACA,SAEH,GAAIU,EAAa,MAAAA,EAGb,GAAA,CACI,MAAAR,EAAS,UAAU,OAAO,gBAAiB,CAC/C,KAAM,CACJ,QAASO,EAAK,GACd,QAAAN,EACA,QAASF,EAAK,GACd,WAAYK,CACd,CAAA,CACD,QACMK,EAAK,CACJ,QAAA,MAAM,0BAA2BA,CAAG,CAC9C,CAEO,OAAAF,CACT,EACA,UAAW,IAAM,CACfd,EAAY,kBAAkB,CAAE,SAAU,CAAC,iBAAiB,CAAG,CAAA,EAC/DA,EAAY,kBAAkB,CAAE,SAAU,CAAC,kBAAkB,CAAG,CAAA,EAChEiB,EAAM,QAAQf,EAAE,wBAAyB,QAAQ,CAAC,CACpD,EACA,QAAUa,GAAU,CACV,QAAA,MAAM,uBAAwBA,CAAK,EAC3CE,EAAM,MAAMf,EAAE,sBAAuB,MAAM,CAAC,CAC9C,CAAA,CACD,CACH"}