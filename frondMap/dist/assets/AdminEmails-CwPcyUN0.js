import{j as e}from"./vendor-ui-DAmPMpEA.js";import{r as d}from"./vendor-react-iAJ0IrSD.js";import{u as pe,a as R,b as F}from"./vendor-query-BlSVl3IQ.js";import{n as ge,m as fe,af as ve,D as E,a3 as ye,B as i,a as P,b as q,c as z,a0 as m,I as L,a6 as b,a7 as w,a8 as N,a9 as T,aa as l,a2 as K,L as _,C as V,i as Q,t as B,q as M,a1 as be,ac as we,j as $,ag as Ne,e as Y,U as G,$ as Te,an as _e,s as u}from"./index-BcrfGQEh.js";import{T as Ce,a as Se,b as J,c as W}from"./tabs-C_tzE0Ci.js";import{T as De,a as Ue,b as X,c as j,d as Ie,e as p}from"./table-D62aEpyA.js";import{R as ke}from"./RichTextEditor--UO8SiL1.js";import{u as Re}from"./vendor-i18n-DxKeo2S1.js";import{P as Fe}from"./plus-CN0JuuEq.js";import{F as Ee}from"./file-pen-BakHYBxv.js";import{S as Pe}from"./square-pen-B33wHQe-.js";import{C as qe}from"./copy-CvrIxvPN.js";import{E as ze}from"./eye-CrXJhp4G.js";import{U as Le}from"./users-B1UqT5l5.js";import{M as Ke,S as Me}from"./sparkles-TOVZp-zT.js";import{f as Oe}from"./format-C1rHoFdk.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-KNAP0qdW.js";import"./vendor-editor-BxSQdrX3.js";import"./startOfDay-CJ0Nm-E7.js";const O=[{value:"activity_promotion",labelKey:"admin.activityPromotion",icon:Ke},{value:"security_alert",labelKey:"admin.securityAlert",icon:_e},{value:"custom",labelKey:"admin.customTemplate",icon:Me}];function os(){const{t:a,i18n:He}=Re(),{user:Z}=ge(),{toast:g}=fe(),C=pe(),[ee,f]=d.useState(!1),[se,v]=d.useState(!1),[ae,S]=d.useState(!1),[y,D]=d.useState(null),[h,U]=d.useState(null),[te,ne]=d.useState("templates"),[r,o]=d.useState({name:"",subject:"",content:"",template_type:"custom",status:"draft"}),[n,x]=d.useState({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),{data:re=[],isLoading:ie}=R({queryKey:["email-templates"],queryFn:async()=>{const{data:s,error:t}=await u.from("email_templates").select("*").order("created_at",{ascending:!1});if(t)throw t;return s}}),{data:le=[],isLoading:ce}=R({queryKey:["email-send-records"],queryFn:async()=>{const{data:s,error:t}=await u.from("email_send_records").select("*").order("sent_at",{ascending:!1});if(t)throw t;return s}}),{data:oe=[]}=R({queryKey:["all-users-for-email"],queryFn:async()=>{const{data:s,error:t}=await u.from("profiles").select("id, display_name").order("display_name");if(t)throw t;return s}}),I=F({mutationFn:async s=>{const t={name:s.name,subject_zh:s.subject,subject_en:s.subject,subject_pt:s.subject,content_zh:s.content,content_en:s.content,content_pt:s.content,template_type:s.template_type,status:s.status};if(s.id){const{error:c}=await u.from("email_templates").update(t).eq("id",s.id);if(c)throw c}else{const{error:c}=await u.from("email_templates").insert({...t,created_by:Z?.id});if(c)throw c}},onSuccess:()=>{C.invalidateQueries({queryKey:["email-templates"]}),f(!1),A(),g({title:a("common.success"),description:a(y?"common.updated":"common.created")})},onError:s=>{g({title:a("common.error"),description:s.message,variant:"destructive"})}}),H=F({mutationFn:async s=>{const{error:t}=await u.from("email_templates").delete().eq("id",s);if(t)throw t},onSuccess:()=>{C.invalidateQueries({queryKey:["email-templates"]}),g({title:a("common.success"),description:a("common.deleted")})}}),k=F({mutationFn:async()=>{if(!h)throw new Error("No template selected");const{data:s,error:t}=await u.functions.invoke("send-bulk-email",{body:{templateId:h.id,targetType:n.targetType,targetRole:n.targetType==="role"?n.targetRole:null,targetUserIds:n.targetType==="specific"?n.targetUserIds:null}});if(t)throw t;return s},onSuccess:s=>{C.invalidateQueries({queryKey:["email-send-records"]}),v(!1),U(null),x({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),g({title:a("common.success"),description:`成功发送 ${s.success_count} 封邮件，失败 ${s.failed_count} 封`})},onError:s=>{g({title:a("common.error"),description:s.message,variant:"destructive"})}}),A=()=>{o({name:"",subject:"",content:"",template_type:"custom",status:"draft"}),D(null)},de=s=>{D(s),o({name:s.name,subject:s.subject_zh,content:s.content_zh,template_type:s.template_type,status:s.status}),f(!0)},me=s=>{D(null),o({name:`${s.name} (副本)`,subject:s.subject_zh,content:s.content_zh,template_type:s.template_type,status:"draft"}),f(!0)},ue=s=>{U(s),v(!0)},he=s=>{U(s),S(!0)},xe=oe.filter(s=>s.display_name?.toLowerCase().includes(n.userSearch.toLowerCase())),je=s=>{const t=O.find(c=>c.value===s)||O[2];return{...t,label:a(t.labelKey,t.value)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ve,{className:"h-6 w-6"}),a("admin.emails","发送邮件")]}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.emailsDesc","管理邮件模板和批量发送邮件")})]})}),e.jsxs(Ce,{value:te,onValueChange:ne,children:[e.jsxs(Se,{children:[e.jsx(J,{value:"templates",children:a("admin.templates","模板管理")}),e.jsx(J,{value:"records",children:a("admin.sendRecords","发送记录")})]}),e.jsxs(W,{value:"templates",className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(E,{open:ee,onOpenChange:s=>{f(s),s||A()},children:[e.jsx(ye,{asChild:!0,children:e.jsxs(i,{children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),a("admin.createTemplate","创建模板")]})}),e.jsxs(P,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsx(q,{children:e.jsx(z,{children:y?a("admin.editTemplate","编辑模板"):a("admin.createTemplate","创建模板")})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:a("admin.templateName","模板名称")}),e.jsx(L,{value:r.name,onChange:s=>o({...r,name:s.target.value}),placeholder:"模板名称"})]}),e.jsxs("div",{children:[e.jsx(m,{children:a("admin.templateType","模板类型")}),e.jsxs(b,{value:r.template_type,onValueChange:s=>o({...r,template_type:s}),children:[e.jsx(w,{children:e.jsx(N,{})}),e.jsx(T,{children:O.map(s=>e.jsx(l,{value:s.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(s.icon,{className:"h-4 w-4"}),a(s.labelKey,s.value)]})},s.value))})]})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:a("common.status")}),e.jsxs(b,{value:r.status,onValueChange:s=>o({...r,status:s}),children:[e.jsx(w,{className:"w-40",children:e.jsx(N,{})}),e.jsxs(T,{children:[e.jsx(l,{value:"draft",children:a("common.draft","草稿")}),e.jsx(l,{value:"published",children:a("common.published","已发布")})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:a("admin.emailSubject","邮件主题")}),e.jsx(L,{value:r.subject,onChange:s=>o({...r,subject:s.target.value}),placeholder:"邮件主题"})]}),e.jsxs("div",{children:[e.jsx(m,{children:a("admin.emailContent","邮件内容")}),e.jsx(ke,{value:r.content,onChange:s=>o({...r,content:s}),placeholder:"邮件内容..."})]})]}),e.jsxs(K,{children:[e.jsx(i,{variant:"outline",onClick:()=>f(!1),children:a("common.cancel")}),e.jsxs(i,{onClick:()=>I.mutate({...r,id:y?.id}),disabled:I.isPending||!r.name||!r.subject||!r.content,children:[I.isPending&&e.jsx(_,{className:"h-4 w-4 mr-2 animate-spin"}),a(y?"common.save":"common.create")]})]})]})]})}),ie?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(_,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:re.map(s=>{const t=je(s.template_type);return e.jsxs(V,{children:[e.jsxs(Q,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t.icon,{className:"h-5 w-5 text-primary"}),e.jsx(B,{className:"text-lg",children:s.name})]}),e.jsx(M,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"h-3 w-3 mr-1"}),a("common.published","已发布")]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-3 w-3 mr-1"}),a("common.draft","草稿")]})})]}),e.jsx(we,{className:"line-clamp-1",children:s.subject_zh})]}),e.jsxs($,{children:[e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-4",children:e.jsx(M,{variant:"outline",children:t.label})}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(i,{size:"sm",variant:"outline",onClick:()=>de(s),children:[e.jsx(Pe,{className:"h-4 w-4 mr-1"}),a("common.edit")]}),e.jsxs(i,{size:"sm",variant:"outline",onClick:()=>me(s),children:[e.jsx(qe,{className:"h-4 w-4 mr-1"}),a("common.copy","复制")]}),e.jsxs(i,{size:"sm",variant:"outline",onClick:()=>he(s),children:[e.jsx(ze,{className:"h-4 w-4 mr-1"}),a("common.preview","预览")]}),e.jsxs(i,{size:"sm",variant:"outline",onClick:()=>H.mutate(s.id),disabled:H.isPending,children:[e.jsx(Ne,{className:"h-4 w-4 mr-1"}),a("common.delete")]}),s.status==="published"&&e.jsxs(i,{size:"sm",onClick:()=>ue(s),children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),a("common.send","发送")]})]})]})]},s.id)})})]}),e.jsx(W,{value:"records",children:e.jsxs(V,{children:[e.jsx(Q,{children:e.jsx(B,{children:a("admin.sendRecords","发送记录")})}),e.jsx($,{children:ce?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(_,{className:"h-8 w-8 animate-spin"})}):e.jsxs(De,{children:[e.jsx(Ue,{children:e.jsxs(X,{children:[e.jsx(j,{children:a("admin.emailSubject","邮件主题")}),e.jsx(j,{children:a("admin.targetType","发送对象")}),e.jsx(j,{children:a("admin.sentCount","发送数量")}),e.jsx(j,{children:a("admin.successCount","成功")}),e.jsx(j,{children:a("admin.failedCount","失败")}),e.jsx(j,{children:a("admin.sentAt","发送时间")})]})}),e.jsx(Ie,{children:le.map(s=>e.jsxs(X,{children:[e.jsx(p,{className:"font-medium max-w-xs truncate",children:s.subject}),e.jsx(p,{children:e.jsx(M,{variant:"outline",children:s.target_type==="all"?e.jsxs(e.Fragment,{children:[e.jsx(Le,{className:"h-3 w-3 mr-1"}),a("admin.allUsers","全部用户")]}):s.target_type==="role"?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),s.target_role]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),a("admin.specificUsers","指定用户")]})})}),e.jsx(p,{children:s.sent_count}),e.jsx(p,{className:"text-green-600",children:s.success_count}),e.jsx(p,{className:"text-red-600",children:s.failed_count}),e.jsx(p,{children:Oe(new Date(s.sent_at),"yyyy-MM-dd HH:mm")})]},s.id))})]})})]})})]}),e.jsx(E,{open:se,onOpenChange:v,children:e.jsxs(P,{className:"max-w-md",children:[e.jsxs(q,{children:[e.jsx(z,{children:a("admin.sendEmail","发送邮件")}),e.jsx(Te,{children:h?.name})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:a("admin.targetType","发送对象")}),e.jsxs(b,{value:n.targetType,onValueChange:s=>x({...n,targetType:s}),children:[e.jsx(w,{children:e.jsx(N,{})}),e.jsxs(T,{children:[e.jsx(l,{value:"all",children:a("admin.allUsers","全部用户")}),e.jsx(l,{value:"role",children:a("admin.byRole","按身份")}),e.jsx(l,{value:"specific",children:a("admin.specificUsers","指定用户")})]})]})]}),n.targetType==="role"&&e.jsxs("div",{children:[e.jsx(m,{children:a("admin.selectRole","选择身份")}),e.jsxs(b,{value:n.targetRole,onValueChange:s=>x({...n,targetRole:s}),children:[e.jsx(w,{children:e.jsx(N,{placeholder:a("admin.selectRole")})}),e.jsxs(T,{children:[e.jsx(l,{value:"user",children:a("common.user","用户")}),e.jsx(l,{value:"merchant",children:a("common.merchant","商家")}),e.jsx(l,{value:"supervisor",children:a("common.supervisor","主管")}),e.jsx(l,{value:"admin",children:a("common.admin","管理员")})]})]})]}),n.targetType==="specific"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:a("admin.selectUsers","选择用户")}),e.jsx(L,{placeholder:a("admin.searchUsers","搜索用户..."),value:n.userSearch,onChange:s=>x({...n,userSearch:s.target.value})}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-md p-2 space-y-1",children:xe.slice(0,20).map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-muted rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:n.targetUserIds.includes(s.id),onChange:t=>{t.target.checked?x({...n,targetUserIds:[...n.targetUserIds,s.id]}):x({...n,targetUserIds:n.targetUserIds.filter(c=>c!==s.id)})}}),e.jsx("span",{className:"text-sm",children:s.display_name})]},s.id))}),n.targetUserIds.length>0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.selectedUsersCount",{count:n.targetUserIds.length})})]})]}),e.jsxs(K,{children:[e.jsx(i,{variant:"outline",onClick:()=>v(!1),children:a("common.cancel")}),e.jsxs(i,{onClick:()=>k.mutate(),disabled:k.isPending||n.targetType==="role"&&!n.targetRole||n.targetType==="specific"&&n.targetUserIds.length===0,children:[k.isPending&&e.jsx(_,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx(Y,{className:"h-4 w-4 mr-2"}),a("common.send","发送")]})]})]})}),e.jsx(E,{open:ae,onOpenChange:S,children:e.jsxs(P,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(q,{children:e.jsx(z,{children:a("common.preview","预览邮件")})}),h&&e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-lg mb-2",children:h.subject_zh}),e.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert",dangerouslySetInnerHTML:{__html:h.content_zh}})]}),e.jsx(K,{children:e.jsx(i,{variant:"outline",onClick:()=>S(!1),children:a("common.close","关闭")})})]})})]})}export{os as default};
//# sourceMappingURL=AdminEmails-CwPcyUN0.js.map
