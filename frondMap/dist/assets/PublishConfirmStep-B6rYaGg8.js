import{p as I,r,w as N,j as e,bz as F,X as B,a6 as V,dS as O,cl as X,bJ as H,aM as J,bL as Q,c8 as W,aw as q,et as T,b2 as K,bi as D,ab as Y}from"./vendor-react-87iFmKFJ.js";import{s as S,h as y,ad as G}from"./index-BrOhGy48.js";const te=()=>{const{t:u,i18n:g}=I(),[f,m]=r.useState(!1),[w,s]=r.useState(!1),[i,o]=r.useState(!1);return{identifyIngredients:async x=>{m(!0);try{const{data:l,error:d}=await S.functions.invoke("ai-recipe/identify",{body:{image_url:x}});if(d)throw d;if(l?.error)throw new Error(l.error);return l.ingredients||[]}catch(l){return console.error("Identify error:",l),N.error(u("aiRecipe.identifyError","食材识别失败，请重试")),null}finally{m(!1)}},generateRecipes:async(x,l,d,a,t,h)=>{s(!0);try{const{data:c,error:b}=await S.functions.invoke("ai-recipe/generate",{body:{ingredients:x,difficulty:l,servings:d,recipe_count:a||3,dish_count_specified:!!a,notes:t,exclude_dishes:h}});if(b){const k=(b?.context?.body?await b.context.json?.().catch(()=>null):null)?.error||b.message;if(k?.includes("credits"))return N.error(u("aiRecipe.creditsExhausted","AI 额度不足，请充值后重试")),null;if(k?.includes("rate limit"))return N.error(u("aiRecipe.rateLimited","请求过于频繁，请稍后重试")),null;throw new Error(k)}if(c?.error){if(c.error.includes("credits"))return N.error(u("aiRecipe.creditsExhausted","AI 额度不足，请充值后重试")),null;throw new Error(c.error)}return c.recipes||[]}catch(c){return console.error("Generate error:",c),N.error(u("aiRecipe.generateError","菜谱生成失败，请重试")),null}finally{s(!1)}},verifyResultPhoto:async(x,l,d,a)=>{o(!0);try{const{data:t,error:h}=await S.functions.invoke("ai-recipe/verify-photo",{body:{image_url:x,recipe_name:l,exif_time:d,lang:g.language,photo_source:a||"camera"}});if(h)throw h;if(t?.error)throw new Error(t.error);return t}catch(t){return console.error("Verify error:",t),N.error(u("aiRecipe.verifyError","照片验证失败，请重试")),null}finally{o(!1)}},uploadImage:async(x,l)=>{try{const d=x.name.split(".").pop(),a=`${l}/${Date.now()}-${Math.random().toString(36).slice(2)}.${d}`,{data:t,error:h}=await S.storage.from("community-images").upload(a,x,{cacheControl:"3600",upsert:!1});if(h)throw h;const{data:c}=S.storage.from("community-images").getPublicUrl(t.path);return c.publicUrl}catch(d){return console.error("Upload error:",d),N.error(u("common.uploadFailed","上传失败")),null}},isIdentifying:f,isGenerating:w,isVerifying:i}},Z=({onCapture:u,onClose:g})=>{const{t:f}=I(),m=r.useRef(null),w=r.useRef(null),s=r.useRef(null),[i,o]=r.useState(!1),[j,R]=r.useState("environment"),[n,v]=r.useState(!1),x=r.useCallback(async a=>{s.current&&(s.current.getTracks().forEach(t=>t.stop()),s.current=null),o(!1);try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:a},audio:!1});s.current=t,m.current&&(m.current.srcObject=t,m.current.onloadedmetadata=()=>{m.current?.play(),o(!0)})}catch(t){console.error("Camera error:",t),t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?N.error(f("aiRecipe.cameraPermissionDenied","相机权限被拒绝，请在浏览器设置中允许访问相机")):t.name==="NotFoundError"?N.error(f("aiRecipe.cameraNotFound","未找到相机设备")):N.error(f("aiRecipe.cameraError","无法访问相机，请检查权限设置")),g()}},[g,f]);r.useEffect(()=>(x(j),()=>{s.current?.getTracks().forEach(a=>a.stop())}),[]);const l=async()=>{const a=j==="environment"?"user":"environment";R(a),await x(a)},d=()=>{if(!m.current||!w.current||!i)return;v(!0);const a=m.current,t=w.current;t.width=a.videoWidth,t.height=a.videoHeight;const h=t.getContext("2d");h&&(h.drawImage(a,0,0),t.toBlob(c=>{if(c){const b=new File([c],`photo-${Date.now()}.jpg`,{type:"image/jpeg"});s.current?.getTracks().forEach(E=>E.stop()),u(b)}v(!1)},"image/jpeg",.92))};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black flex flex-col",children:[e.jsxs("div",{className:"relative flex-1 overflow-hidden",children:[e.jsx("video",{ref:m,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),e.jsx("canvas",{ref:w,className:"hidden"}),i&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsxs("div",{className:"w-64 h-64 relative",children:[e.jsx("div",{className:"absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white/80 rounded-tl"}),e.jsx("div",{className:"absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white/80 rounded-tr"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/80 rounded-bl"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white/80 rounded-br"})]})}),!i&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3 text-white/70",children:[e.jsx(F,{className:"h-10 w-10 animate-pulse"}),e.jsx("span",{className:"text-sm",children:f("aiRecipe.cameraLoading","相机加载中...")})]})})]}),e.jsxs("div",{className:"bg-black/90 px-6 py-6 flex items-center justify-between safe-area-bottom",children:[e.jsx(y,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/10 rounded-full w-12 h-12",onClick:()=>{s.current?.getTracks().forEach(a=>a.stop()),g()},children:e.jsx(B,{className:"h-6 w-6"})}),e.jsx("button",{onClick:d,disabled:!i||n,className:"w-20 h-20 rounded-full bg-white flex items-center justify-center disabled:opacity-50 active:scale-95 transition-transform",children:e.jsx(V,{className:"w-16 h-16 text-black fill-black/10"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/10 rounded-full w-12 h-12",onClick:l,disabled:!i,children:e.jsx(O,{className:"h-6 w-6"})})]})]})},re=({onPhotoVerified:u,uploadImage:g,verifyPhoto:f,recipeName:m,isVerifying:w})=>{const{t:s}=I(),[i,o]=r.useState(!1),[j,R]=r.useState(null),[n,v]=r.useState(null),[x,l]=r.useState(!1),[d,a]=r.useState(null),[t,h]=r.useState(null),[c,b]=r.useState(""),[E,k]=r.useState(!1),[L,M]=r.useState(!1),_=r.useRef(null),U=async(p,C)=>{o(!0),v(null),a(C),R(URL.createObjectURL(p)),b(""),k(!1);const P=await g(p,"ai-recipe-results");if(!P){o(!1);return}h(P),o(!1);const z=await f(P,m,C);v(z),z?.is_genuine&&k(!0)},$=p=>{l(!1),U(p,"camera")},A=()=>{t&&n&&u(t,n.is_genuine,c.trim()||void 0)};return e.jsxs(e.Fragment,{children:[x&&e.jsx(Z,{onCapture:$,onClose:()=>l(!1)}),e.jsx("input",{ref:_,type:"file",accept:"image/*",className:"hidden",onChange:p=>{const C=p.target.files?.[0];C&&U(C,"upload"),p.target.value=""}}),e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto",children:e.jsx(X,{className:"h-10 w-10 text-primary"})}),e.jsx("h3",{className:"text-lg font-semibold",children:s("aiRecipe.resultPhotoTitle","拍摄成品")}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-xs",children:s("aiRecipe.resultPhotoDesc","拍摄或上传成品照片，系统将验证真实性")})]}),!j&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg w-full max-w-sm bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-400",children:[e.jsx(H,{className:"h-4 w-4 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs",children:s("aiRecipe.uploadStricterNote","相册上传将接受更严格的审核，建议直接拍摄")})]}),j&&e.jsxs("div",{className:"w-full max-w-sm rounded-xl overflow-hidden border relative",children:[e.jsx("img",{src:j,alt:"Result",className:"w-full h-48 object-cover"}),d==="upload"&&e.jsx("div",{className:"absolute top-2 right-2 bg-amber-500 text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s("aiRecipe.fromGallery","相册")}),d==="camera"&&e.jsx("div",{className:"absolute top-2 right-2 bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s("aiRecipe.fromCamera","拍摄")})]}),(i||w)&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(J,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:i?s("common.uploading","上传中..."):s("aiRecipe.verifying","验证中...")})]}),n&&e.jsxs("div",{className:`w-full max-w-sm rounded-lg overflow-hidden ${n.is_genuine?"bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-400":"bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 p-3",children:[n.is_genuine?e.jsx(Q,{className:"h-5 w-5 shrink-0"}):e.jsx(W,{className:"h-5 w-5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium flex-1",children:n.is_genuine?s("aiRecipe.photoVerified","照片验证通过"):s("aiRecipe.photoNotVerified","照片验证未通过")}),!n.is_genuine&&n.explanation&&e.jsxs("button",{onClick:()=>M(p=>!p),className:"flex items-center gap-0.5 text-xs opacity-70 hover:opacity-100 shrink-0",children:[s("aiRecipe.viewReason","原因"),e.jsx(q,{className:`h-3.5 w-3.5 transition-transform ${L?"rotate-180":""}`})]})]}),!n.is_genuine&&L&&n.explanation&&e.jsx("div",{className:"px-3 pb-3 text-xs opacity-80 border-t border-current/10 pt-2",children:n.explanation})]}),E&&n?.is_genuine&&e.jsxs("div",{className:"w-full max-w-sm space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-medium",children:[e.jsx(T,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:s("aiRecipe.cookingNote","写下烹饪心得")}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal ml-1",children:s("common.optional","（可选）")})]}),e.jsx(G,{placeholder:s("aiRecipe.cookingNotePlaceholder","分享一下今天的烹饪体验、技巧或感受..."),value:c,onChange:p=>b(p.target.value),rows:3,maxLength:500,className:"resize-none text-sm"}),c.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[c.length,"/500"]})]}),n?.is_genuine?e.jsxs("div",{className:"flex flex-col gap-2 w-full max-w-sm",children:[e.jsxs(y,{className:"w-full gap-2 h-11",onClick:A,children:[e.jsx(K,{className:"h-4 w-4"}),s("aiRecipe.continueToShare","继续")]}),e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsxs(y,{variant:"ghost",className:"flex-1 gap-2 text-muted-foreground",onClick:()=>l(!0),children:[e.jsx(F,{className:"h-4 w-4"}),s("aiRecipe.retakePhoto","重新拍摄")]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-9 w-9 shrink-0 text-muted-foreground",onClick:()=>_.current?.click(),title:s("aiRecipe.uploadFromGallery","上传相册"),children:e.jsx(D,{className:"h-4 w-4"})})]})]}):e.jsxs("div",{className:"flex items-center gap-3 w-full max-w-sm",children:[e.jsxs(y,{className:"flex-1 gap-2 h-11",onClick:()=>l(!0),disabled:i||w,children:[e.jsx(F,{className:"h-4 w-4"}),j?s("aiRecipe.retakePhoto","重新拍摄"):s("aiRecipe.takeResultPhoto","拍摄成品")]}),e.jsx(y,{variant:"outline",size:"icon",className:"h-11 w-11 shrink-0",onClick:()=>_.current?.click(),disabled:i||w,title:s("aiRecipe.uploadFromGallery","上传相册"),children:e.jsx(D,{className:"h-4 w-4"})})]})]})]})},ae=({resultImageUrl:u,recipeName:g,initialNote:f="",onPublish:m,onSkip:w,isPublishing:s})=>{const{t:i}=I(),[o,j]=r.useState(f),[R,n]=r.useState(!1);return e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx("h3",{className:"text-lg font-semibold",children:i("aiRecipe.congratulations","恭喜完成！")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i("aiRecipe.publishQuestion","要发布到社区吗？")})]}),u&&e.jsxs("div",{className:"w-full max-w-sm rounded-xl overflow-hidden border",children:[e.jsx("img",{src:u,alt:g,className:"w-full h-48 object-cover"}),e.jsxs("div",{className:"p-3 space-y-2",children:[e.jsx("p",{className:"font-medium text-sm",children:g}),R?e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{autoFocus:!0,placeholder:i("aiRecipe.cookingNotePlaceholder","分享一下今天的烹饪体验、技巧或感受..."),value:o,onChange:v=>j(v.target.value),rows:3,maxLength:500,className:"resize-none text-sm",disabled:s,onBlur:()=>n(!1)}),o.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[o.length,"/500"]})]}):e.jsx("button",{className:"w-full text-left",onClick:()=>n(!0),disabled:s,children:o?e.jsxs("p",{className:"text-sm text-foreground/80 flex items-start gap-1.5",children:[e.jsx(T,{className:"h-3.5 w-3.5 mt-0.5 shrink-0 text-primary"}),o]}):e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1.5",children:[e.jsx(T,{className:"h-3.5 w-3.5 shrink-0"}),i("aiRecipe.addCookingNote","点击添加烹饪心得...")]})})]})]}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsxs(y,{className:"w-full gap-2",onClick:()=>m(o),disabled:s,children:[e.jsx(Y,{className:"h-4 w-4"}),s?i("common.publishing","发布中…"):i("aiRecipe.publishToCommunity","发布到社区")]})})]})};export{Z as C,ae as P,re as R,te as u};
//# sourceMappingURL=PublishConfirmStep-B6rYaGg8.js.map
