import{p as B,u as U,r as i,j as e,b2 as me,L as w,b8 as ue,b0 as he,eb as $,bg as xe,b6 as ge,bn as fe,aX as je,X as pe,bm as ve,W as we,w as y,br as ye,aL as Ne,bN as M}from"./vendor-react-Hsdnn-sD.js";import{u as be,C as Ce,v as Te,A as Se,h as ke,i as _e,P as De,Q as Le,B as c,R as Ae,T as ze,w as Ie,k as F,x as Pe,y as Ee,z as $e,E as Me,F as Fe,G as Ye,J as He,K as Re,L as Be}from"./index-Bhoi9VDh.js";import{C as Y,a as H,b as R}from"./carousel-XVoBQK0h.js";import{c as Ue,i as We,b as Oe,j as qe}from"./useCommunityPosts-WcktIPU2.js";import{u as Je}from"./useLocalizedContent-D-CDxH29.js";import{T as Xe,R as Ge}from"./RestaurantComments-CBCSAYl5.js";import{H as Ke,p as Qe,I as Ve,J as Ze}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-BVdpxhZP.js";import"./ReportDialog-DTs5Rjw2.js";import"./input-otp-C3HacMQ0.js";import"./useSensitiveWords-CaHtovtx.js";const es=({post:s,showActions:f=!0,isDetailPage:j=!1})=>{const{t:n,i18n:u}=B(),{user:d}=be(),W=U(),{getLocalizedField:N}=Je(),O=Ue(),b=We(),q=Oe(),[J,C]=i.useState(!1),[k,_]=i.useState({}),[T,h]=i.useState(!1),[X,D]=i.useState(0),[x,G]=i.useState(),[L,K]=i.useState(),[A,z]=i.useState(0),[Q,V]=i.useState(null);i.useState(null),i.useState(!1),i.useState(0),i.useState(!1);const[I,Z]=i.useState({}),[g,p]=i.useState(null);i.useEffect(()=>{if(T){const t=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${t}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.overflow="",window.scrollTo(0,t)}}},[T]),i.useEffect(()=>{x&&(z(x.selectedScrollSnap()),x.on("select",()=>{z(x.selectedScrollSnap())}))},[x]);const ee=()=>{switch(u.language){case"zh":return Ze;case"pt":return Ve;default:return Qe}},se=()=>{d&&O.mutate({postId:s.id,liked:s.user_liked||!1})},te=async()=>{const t=`${window.location.origin}/community/${s.id}`;if(navigator.share)try{await navigator.share({title:n("community.shareTitle","分享帖子"),url:t}),d&&b.mutate(s.id),y.success(n("community.shareSuccess","分享成功"))}catch(a){a?.name!=="AbortError"&&(await navigator.clipboard.writeText(t),y.success(n("community.linkCopied","链接已复制到剪贴板")),d&&b.mutate(s.id))}else try{await navigator.clipboard.writeText(t),y.success(n("community.linkCopied","链接已复制到剪贴板")),d&&b.mutate(s.id)}catch{y.error(n("community.shareFailed","分享失败"))}},ae=()=>{q.mutate(s.id),C(!1)},P=t=>{j?(D(t),h(!0)):W(`/community/${s.id}`)},v=(t,a)=>{const r=t.currentTarget;Z(o=>({...o,[a]:{width:r.naturalWidth,height:r.naturalHeight}}))},E=t=>{const a=I[t];return a?a.height/a.width>1.5:!1},le=d?.id===s.author_id,ne=s.activity?N(s.activity,"title"):null,re=s.restaurant?N(s.restaurant,"name"):null,ie=N(s,"content"),oe=u.language==="zh"&&s.content_zh||u.language==="en"&&s.content_en||u.language==="pt"&&s.content_pt,ce=Q||ie||s.content;return e.jsxs(e.Fragment,{children:[e.jsxs(Ce,{className:"overflow-hidden",children:[e.jsx(Te,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Se,{className:"h-10 w-10",children:[e.jsx(ke,{src:s.author?.avatar_url||void 0}),e.jsx(_e,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:Ke(new Date(s.created_at),{addSuffix:!0,locale:ee()})})]})]}),f&&le&&e.jsxs(De,{children:[e.jsx(Le,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(me,{className:"h-4 w-4"})})}),e.jsx(Ae,{align:"end",children:e.jsx(ze,{onClick:()=>C(!0),className:"text-destructive",children:n("common.delete","删除")})})]})]})}),e.jsxs(Ie,{className:"pt-0 pb-3",children:[(s.activity||s.restaurant)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[s.activity&&e.jsx(w,{to:`/activity/${s.activity.id}`,children:e.jsxs(F,{variant:"secondary",className:"gap-1",children:[e.jsx(ue,{className:"h-3 w-3"}),ne]})}),s.restaurant&&e.jsx(w,{to:`/restaurant/${s.restaurant.id}`,children:e.jsxs(F,{variant:"secondary",className:"gap-1",children:[e.jsx(he,{className:"h-3 w-3"}),re]})})]}),e.jsx(w,{to:`/community/${s.id}`,children:e.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert",dangerouslySetInnerHTML:{__html:ce}})}),!oe&&e.jsx(Xe,{text:s.content,onTranslation:V,className:"mt-1"}),(()=>{const t=j&&s.video_url?(s.image_urls||[]).filter(a=>!a.includes("-cover")):s.image_urls;return!t||t.length===0?null:e.jsx("div",{className:"relative mt-3",children:t.length===1?(()=>{const a=t[0],r=E(a);return e.jsx("div",{className:`relative overflow-hidden rounded-lg cursor-pointer ${r?"max-h-[500px]":"aspect-square"}`,onClick:()=>P(0),children:k[a]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:n("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"",className:`w-full ${r?"h-auto object-contain":"h-full object-cover"}`,onLoad:o=>v(o,a),onError:()=>_(o=>({...o,[a]:!0}))}),r&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{children:n("community.longImage","长图")})]})]})})})():e.jsxs(e.Fragment,{children:[e.jsx(Y,{setApi:G,className:"w-full",opts:{loop:!0},children:e.jsx(H,{className:"-ml-0",children:t.map((a,r)=>{const o=E(a);return e.jsx(R,{className:"pl-0",children:e.jsx("div",{className:`relative overflow-hidden rounded-lg cursor-pointer ${o?"max-h-[500px]":"aspect-square"}`,onClick:()=>P(r),children:k[a]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:n("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"",className:`w-full ${o?"h-auto object-contain":"h-full object-cover"}`,onLoad:l=>v(l,a),onError:()=>_(l=>({...l,[a]:!0}))}),o&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{children:n("community.longImage","长图")})]})]})})},r)})})}),e.jsxs("div",{className:"absolute top-3 right-3 bg-black/60 text-white text-xs px-2 py-1 rounded-full z-10",children:[A+1,"/",t.length]}),e.jsx("div",{className:"flex justify-center gap-1.5 mt-2",children:t.map((a,r)=>e.jsx("button",{className:`w-1.5 h-1.5 rounded-full transition-colors ${r===A?"bg-primary":"bg-muted-foreground/30"}`,onClick:o=>{o.stopPropagation(),x?.scrollTo(r)}},r))})]})})})(),s.video_url&&e.jsx("div",{className:"mt-3 rounded-lg overflow-hidden bg-gray-900",children:e.jsx("video",{src:s.video_url,...s.image_urls?.length?{poster:s.image_urls[0]}:{},controls:!0,className:"w-full max-h-96",preload:"metadata",playsInline:!0})})]}),e.jsx(Pe,{className:"pt-0 border-t",children:e.jsxs("div",{className:"flex items-center gap-4 pt-3 w-full",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:`gap-2 ${s.user_liked?"text-red-500":""}`,onClick:se,disabled:!d,children:[e.jsx(xe,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count})]}),e.jsx(w,{to:`/community/${s.id}`,children:e.jsxs(c,{variant:"ghost",size:"sm",className:"gap-2",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{children:s.comments_count})]})}),e.jsxs(c,{variant:"ghost",size:"sm",className:"gap-2",onClick:te,children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{children:s.shares_count})]})]})})]}),e.jsx(Ee,{open:J,onOpenChange:C,children:e.jsxs($e,{children:[e.jsxs(Me,{children:[e.jsx(Fe,{children:n("common.confirmDelete","确认删除")}),e.jsx(Ye,{children:n("community.deleteWarning","删除后无法恢复，确定要删除这篇帖子吗？")})]}),e.jsxs(He,{children:[e.jsx(Re,{children:n("common.cancel","取消")}),e.jsx(Be,{onClick:ae,children:n("common.delete","删除")})]})]})}),T&&je.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black overflow-hidden",onClick:t=>{t.target===t.currentTarget&&h(!1)},onWheel:t=>t.stopPropagation(),onTouchMove:t=>t.stopPropagation(),children:[s.image_urls&&s.image_urls.length>1&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-10 text-white text-sm bg-black/50 px-4 py-1.5 rounded-full",children:[X+1," / ",s.image_urls.length]}),e.jsx(c,{variant:"ghost",size:"icon",className:"absolute top-4 right-4 z-10 text-white hover:bg-white/20",onClick:()=>h(!1),children:e.jsx(pe,{className:"h-6 w-6"})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Y,{className:"w-full",opts:{loop:!0},setApi:t=>{K(t),t&&t.on("select",()=>{D(t.selectedScrollSnap())})},children:e.jsx(H,{className:"-ml-0",children:s.image_urls?.map((t,a)=>{const r=I[t],o=r?r.height/r.width>1.5:!1;return e.jsx(R,{className:"pl-0 flex items-center justify-center",children:o?e.jsx("div",{className:"w-full h-screen overflow-y-auto overscroll-contain",onMouseDown:l=>{const m=l.currentTarget;p({y:l.clientY,scrollTop:m.scrollTop})},onMouseUp:l=>{if(g){const m=Math.abs(l.clientY-g.y),S=Math.abs(l.currentTarget.scrollTop-g.scrollTop);m<10&&S<10&&h(!1),p(null)}},onTouchStart:l=>{const m=l.currentTarget;p({y:l.touches[0].clientY,scrollTop:m.scrollTop})},onTouchEnd:l=>{if(g){const m=l.changedTouches[0],S=Math.abs(m.clientY-g.y),de=Math.abs(l.currentTarget.scrollTop-g.scrollTop);S<15&&de<15&&(l.preventDefault(),h(!1)),p(null)}},children:e.jsx("div",{className:"min-h-full flex flex-col items-center py-4",children:e.jsx("img",{src:t,alt:"",className:"w-full max-w-[90vw] h-auto object-contain select-none pointer-events-none",draggable:!1,onLoad:l=>v(l,t)})})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("img",{src:t,alt:"",className:"object-contain w-screen h-screen select-none cursor-pointer",draggable:!1,onClick:()=>h(!1),onLoad:l=>v(l,t)})})},a)})})})}),s.image_urls&&s.image_urls.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(c,{variant:"ghost",size:"icon",className:"absolute left-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>L?.scrollPrev(),children:e.jsx(ve,{className:"h-8 w-8"})}),e.jsx(c,{variant:"ghost",size:"icon",className:"absolute right-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>L?.scrollNext(),children:e.jsx(we,{className:"h-8 w-8"})})]})]}),document.body)]})},xs=()=>{const{id:s}=ye(),{t:f}=B(),j=U(),{data:n,isLoading:u,error:d}=qe(s||"");return u?e.jsx("div",{className:"container max-w-2xl mx-auto py-6 px-4 flex justify-center",children:e.jsx(Ne,{className:"h-8 w-8 animate-spin"})}):d||!n?e.jsx("div",{className:"container max-w-2xl mx-auto py-6 px-4",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground",children:f("community.postNotFound","帖子不存在或已被删除")}),e.jsxs(c,{variant:"outline",className:"mt-4",onClick:()=>j("/community"),children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),f("community.backToList","返回社区")]})]})}):e.jsxs("div",{className:"container max-w-2xl mx-auto py-6 px-4",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"mb-4",onClick:()=>j("/community"),children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),f("community.backToList","返回社区")]}),e.jsx(es,{post:n,showActions:!0,isDetailPage:!0}),e.jsx("div",{className:"mt-6",children:e.jsx(Ge,{targetId:n.id,targetType:"post"})})]})};export{xs as default};
//# sourceMappingURL=PostDetail-Cff77gXk.js.map
