import{c as se,x as te,o as W,ac as Y,af as Z,s as y,u as ae,r as A,j as e,aw as re,C as k,m as S,l as ne,w as ie,ao as le,I as de,ag as ce,ah as oe,ai as xe,aj as me,ak as I,B as j,a8 as z,X as E,v as f,a3 as U,a4 as Q,a5 as R,av as F,f as $,D as he,b as ue,d as ge,e as pe,a6 as je,a1 as fe}from"./index-J_eLqhtQ.js";import{C as K}from"./checkbox-BAIBDFDY.js";import{T as ve,a as _e,b as O,c as N,d as Ne,e as w}from"./table-BWoT8Qch.js";import{u as we}from"./useLocalizedContent-Lqq9AGxD.js";import{S as ye}from"./search-DysiiJNQ.js";import{F as be}from"./filter-Djri3XSj.js";import{E as V}from"./external-link-DeF9QoG5.js";import{E as Ce}from"./eye-Blq6nEqE.js";import{S as ke}from"./star-rWzQUpNX.js";import{f as T}from"./format-oMq0U1zw.js";import"./startOfDay-D-ztUGh2.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=se("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]),Me=r=>te({queryKey:["admin-comments",r],queryFn:async()=>{let h=y.from("comments").select("*").is("parent_id",null).order("created_at",{ascending:!1}).limit(200);r&&r!=="all"&&(h=h.eq("moderation_status",r));const{data:d,error:u}=await h;if(u)throw u;if(!d||d.length===0)return[];const o=[...new Set(d.map(t=>t.user_id))],{data:b}=await y.rpc("get_public_profiles",{user_ids:o}),c=new Map((b||[]).map(t=>[t.id,{display_name:t.display_name,avatar_url:t.avatar_url}])),g=d.filter(t=>t.target_type==="restaurant").map(t=>t.target_id),a=d.filter(t=>t.target_type==="activity").map(t=>t.target_id),v=new Map,i=new Map;if(g.length>0){const{data:t}=await y.from("restaurants").select("id, name, name_en, name_pt").in("id",g);t==null||t.forEach(n=>{v.set(n.id,{name:n.name,name_en:n.name_en||void 0,name_pt:n.name_pt||void 0})})}if(a.length>0){const{data:t}=await y.from("activities").select("id, title_zh, title_en, title_pt").in("id",a);t==null||t.forEach(n=>{i.set(n.id,{title_zh:n.title_zh,title_en:n.title_en,title_pt:n.title_pt})})}return d.map(t=>{let n="",C,x;if(t.target_type==="restaurant"){const l=v.get(t.target_id);n=(l==null?void 0:l.name)||"Unknown Restaurant",C=l==null?void 0:l.name_en,x=l==null?void 0:l.name_pt}else if(t.target_type==="activity"){const l=i.get(t.target_id);n=(l==null?void 0:l.title_zh)||"Unknown Activity",C=l==null?void 0:l.title_en,x=l==null?void 0:l.title_pt}return{...t,risk_reasons:Array.isArray(t.risk_reasons)?t.risk_reasons:[],profiles:c.get(t.user_id),target_name:n,target_name_en:C,target_name_pt:x}})}}),Ie=()=>{const{toast:r}=W(),h=Y();return Z({mutationFn:async({commentId:d,action:u})=>{const{data:{user:o}}=await y.auth.getUser();if(!o)throw new Error("Not authenticated");const b={approve:"approved",reject:"rejected",flag:"flagged"},{error:c}=await y.from("comments").update({moderation_status:b[u],reviewed_by:o.id,reviewed_at:new Date().toISOString()}).eq("id",d);if(c)throw c},onSuccess:()=>{h.invalidateQueries({queryKey:["admin-comments"]}),r({title:"审核完成",description:"评论状态已更新"})},onError:()=>{r({title:"操作失败",description:"无法更新评论状态",variant:"destructive"})}})},De=()=>{const{toast:r}=W(),h=Y();return Z({mutationFn:async({commentIds:d,action:u})=>{const{data:{user:o}}=await y.auth.getUser();if(!o)throw new Error("Not authenticated");const b={approve:"approved",reject:"rejected"},{error:c}=await y.from("comments").update({moderation_status:b[u],reviewed_by:o.id,reviewed_at:new Date().toISOString()}).in("id",d);if(c)throw c},onSuccess:(d,u)=>{h.invalidateQueries({queryKey:["admin-comments"]}),r({title:"批量审核完成",description:`已${u.action==="approve"?"通过":"拒绝"} ${u.commentIds.length} 条评论`})},onError:()=>{r({title:"批量操作失败",description:"无法更新评论状态",variant:"destructive"})}})},X=r=>r<=30?"bg-green-500/10 text-green-600 border-green-500/20":r<=60?"bg-yellow-500/10 text-yellow-600 border-yellow-500/20":"bg-red-500/10 text-red-600 border-red-500/20",G=r=>{switch(r){case"approved":return e.jsx(f,{variant:"outline",className:"bg-green-500/10 text-green-600 border-green-500/20",children:"已通过"});case"pending":return e.jsx(f,{variant:"outline",className:"bg-yellow-500/10 text-yellow-600 border-yellow-500/20",children:"待审核"});case"flagged":return e.jsx(f,{variant:"outline",className:"bg-orange-500/10 text-orange-600 border-orange-500/20",children:"已标记"});case"rejected":return e.jsx(f,{variant:"outline",className:"bg-red-500/10 text-red-600 border-red-500/20",children:"已拒绝"});default:return e.jsx(f,{variant:"secondary",children:r})}},J=r=>({spam:"垃圾信息",offensive:"不当言论",harassment:"骚扰攻击",fake_review:"虚假评论",flooding:"刷屏",irrelevant:"无关内容",sensitive_word_detected:"敏感词",parse_error:"解析错误"})[r]||r,Re=()=>{var B,P;const{t:r,i18n:h}=ae();we();const[d,u]=A.useState("all"),[o,b]=A.useState(""),[c,g]=A.useState([]),[a,v]=A.useState(null),{data:i,isLoading:t}=Me(d),n=Ie(),C=De(),x=i==null?void 0:i.filter(s=>{var p,_,D;if(!o)return!0;const m=o.toLowerCase();return s.content.toLowerCase().includes(m)||((_=(p=s.profiles)==null?void 0:p.display_name)==null?void 0:_.toLowerCase().includes(m))||((D=s.target_name)==null?void 0:D.toLowerCase().includes(m))}),l=s=>{g(s?(x==null?void 0:x.map(m=>m.id))||[]:[])},ee=(s,m)=>{g(m?p=>[...p,s]:p=>p.filter(_=>_!==s))},H=s=>{c.length!==0&&C.mutate({commentIds:c,action:s},{onSuccess:()=>g([])})},q=s=>s.target_type==="restaurant"?`/restaurants/${s.target_id}`:s.target_type==="activity"?`/activities/${s.target_id}`:"#",L=s=>h.language==="en"&&s.target_name_en?s.target_name_en:h.language==="pt"&&s.target_name_pt?s.target_name_pt:s.target_name||"",M={total:(i==null?void 0:i.length)||0,pending:(i==null?void 0:i.filter(s=>s.moderation_status==="pending").length)||0,flagged:(i==null?void 0:i.filter(s=>s.moderation_status==="flagged").length)||0,approved:(i==null?void 0:i.filter(s=>s.moderation_status==="approved").length)||0,rejected:(i==null?void 0:i.filter(s=>s.moderation_status==="rejected").length)||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(re,{className:"h-6 w-6"}),r("admin.comments.title","评论管理")]}),e.jsx("p",{className:"text-muted-foreground",children:r("admin.comments.description","审核和管理用户评论，防止恶意内容")})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(k,{children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:M.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"总评论"})]})}),e.jsx(k,{className:"border-yellow-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:M.pending}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"待审核"})]})}),e.jsx(k,{className:"border-orange-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:M.flagged}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已标记"})]})}),e.jsx(k,{className:"border-green-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:M.approved}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已通过"})]})}),e.jsx(k,{className:"border-red-500/20",children:e.jsxs(S,{className:"pt-4",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:M.rejected}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"已拒绝"})]})})]}),e.jsxs(k,{children:[e.jsxs(ne,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx(ie,{children:r("admin.comments.list","评论列表")}),e.jsx(le,{children:r("admin.comments.listDescription","按风险等级颜色显示，AI 自动标记可疑评论")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("div",{className:"relative w-64",children:[e.jsx(ye,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(de,{placeholder:r("admin.comments.search","搜索评论..."),value:o,onChange:s=>b(s.target.value),className:"pl-9"})]}),e.jsxs(ce,{value:d,onValueChange:u,children:[e.jsxs(oe,{className:"w-32",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),e.jsx(xe,{})]}),e.jsxs(me,{children:[e.jsx(I,{value:"all",children:"全部"}),e.jsx(I,{value:"pending",children:"待审核"}),e.jsx(I,{value:"flagged",children:"已标记"}),e.jsx(I,{value:"approved",children:"已通过"}),e.jsx(I,{value:"rejected",children:"已拒绝"})]})]})]})]}),c.length>0&&e.jsxs("div",{className:"flex items-center gap-2 mt-4 p-2 bg-muted rounded-lg",children:[e.jsxs("span",{className:"text-sm",children:["已选择 ",c.length," 项"]}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>H("approve"),disabled:C.isPending,children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),"批量通过"]}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>H("reject"),disabled:C.isPending,children:[e.jsx(E,{className:"h-4 w-4 mr-1"}),"批量拒绝"]}),e.jsx(j,{size:"sm",variant:"ghost",onClick:()=>g([]),children:"取消选择"})]})]}),e.jsx(S,{children:t?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"加载中..."}):x&&x.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(ve,{children:[e.jsx(_e,{children:e.jsxs(O,{children:[e.jsx(N,{className:"w-12",children:e.jsx(K,{checked:x.length>0&&c.length===x.length,onCheckedChange:l})}),e.jsx(N,{className:"w-16",children:"风险"}),e.jsx(N,{children:"评论内容"}),e.jsx(N,{children:"用户"}),e.jsx(N,{children:"目标"}),e.jsx(N,{children:"状态"}),e.jsx(N,{children:"时间"}),e.jsx(N,{className:"text-right",children:"操作"})]})}),e.jsx(Ne,{children:x.map(s=>{var m,p;return e.jsxs(O,{className:s.risk_score>60?"bg-red-500/5":s.risk_score>30?"bg-yellow-500/5":"",children:[e.jsx(w,{children:e.jsx(K,{checked:c.includes(s.id),onCheckedChange:_=>ee(s.id,_)})}),e.jsx(w,{children:e.jsx(f,{variant:"outline",className:X(s.risk_score),children:s.risk_score})}),e.jsxs(w,{className:"max-w-xs",children:[e.jsx("div",{className:"truncate",title:s.content,children:s.content}),s.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:s.risk_reasons.map((_,D)=>e.jsx(f,{variant:"secondary",className:"text-xs",children:J(_)},D))})]}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{className:"h-6 w-6",children:[e.jsx(Q,{src:(m=s.profiles)==null?void 0:m.avatar_url}),e.jsx(R,{children:e.jsx(F,{className:"h-3 w-3"})})]}),e.jsx("span",{className:"text-sm truncate max-w-[100px]",children:((p=s.profiles)==null?void 0:p.display_name)||"Unknown"})]})}),e.jsx(w,{children:e.jsxs($,{to:q(s),className:"flex items-center gap-1 text-sm hover:underline text-primary",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:L(s)}),e.jsx(V,{className:"h-3 w-3"})]})}),e.jsx(w,{children:G(s.moderation_status)}),e.jsx(w,{className:"text-sm text-muted-foreground",children:T(new Date(s.created_at),"MM-dd HH:mm")}),e.jsx(w,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(j,{size:"icon",variant:"ghost",onClick:()=>v(s),title:"查看详情",children:e.jsx(Ce,{className:"h-4 w-4"})}),s.moderation_status!=="approved"&&e.jsx(j,{size:"icon",variant:"ghost",onClick:()=>n.mutate({commentId:s.id,action:"approve"}),disabled:n.isPending,title:"通过",className:"text-green-600 hover:text-green-700",children:e.jsx(z,{className:"h-4 w-4"})}),s.moderation_status!=="rejected"&&e.jsx(j,{size:"icon",variant:"ghost",onClick:()=>n.mutate({commentId:s.id,action:"reject"}),disabled:n.isPending,title:"拒绝",className:"text-red-600 hover:text-red-700",children:e.jsx(E,{className:"h-4 w-4"})})]})})]},s.id)})})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:o?"没有找到匹配的评论":"暂无评论"})})]}),e.jsx(he,{open:!!a,onOpenChange:()=>v(null),children:e.jsxs(ue,{className:"max-w-2xl",children:[e.jsxs(ge,{children:[e.jsx(pe,{children:"评论详情"}),e.jsx(je,{children:"查看评论完整信息和 AI 分析结果"})]}),a&&e.jsx(fe,{className:"max-h-[60vh]",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[e.jsxs(U,{children:[e.jsx(Q,{src:(B=a.profiles)==null?void 0:B.avatar_url}),e.jsx(R,{children:e.jsx(F,{className:"h-4 w-4"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:((P=a.profiles)==null?void 0:P.display_name)||"Unknown"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:T(new Date(a.created_at),"yyyy-MM-dd HH:mm:ss")})]}),a.rating_value&&e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[e.jsx(ke,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),e.jsx("span",{children:a.rating_value})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论内容"}),e.jsx("div",{className:"p-3 bg-muted rounded-lg whitespace-pre-wrap",children:a.content})]}),a.image_url&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论图片"}),e.jsx("img",{src:a.image_url,alt:"Comment",className:"max-w-full h-auto rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"评论目标"}),e.jsxs($,{to:q(a),className:"flex items-center gap-2 p-3 bg-muted rounded-lg hover:bg-muted/80",children:[e.jsxs("span",{children:[a.target_type==="restaurant"?"餐厅":"活动",":"]}),e.jsx("span",{className:"text-primary",children:L(a)}),e.jsx(V,{className:"h-4 w-4"})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),"AI 分析结果"]}),e.jsxs("div",{className:"p-3 bg-muted rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"风险评分:"}),e.jsxs(f,{variant:"outline",className:X(a.risk_score),children:[a.risk_score,"/100"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"审核状态:"}),G(a.moderation_status)]}),a.risk_reasons.length>0&&e.jsxs("div",{children:[e.jsx("span",{children:"检测问题:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:a.risk_reasons.map((s,m)=>e.jsx(f,{variant:"secondary",children:J(s)},m))})]}),a.ai_reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["AI 审核时间: ",T(new Date(a.ai_reviewed_at),"yyyy-MM-dd HH:mm:ss")]}),a.reviewed_at&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["人工审核时间: ",T(new Date(a.reviewed_at),"yyyy-MM-dd HH:mm:ss")]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[a.moderation_status!=="approved"&&e.jsxs(j,{onClick:()=>{n.mutate({commentId:a.id,action:"approve"},{onSuccess:()=>v(null)})},disabled:n.isPending,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"通过"]}),a.moderation_status!=="rejected"&&e.jsxs(j,{variant:"destructive",onClick:()=>{n.mutate({commentId:a.id,action:"reject"},{onSuccess:()=>v(null)})},disabled:n.isPending,children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"拒绝"]}),e.jsx(j,{variant:"outline",onClick:()=>v(null),children:"关闭"})]})]})})]})})]})};export{Re as default};
