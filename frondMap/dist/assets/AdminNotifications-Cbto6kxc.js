import{c as ge,u as Me,k as qe,i as Le,ad as Re,r as d,p as H,ae as V,j as e,aL as se,D as O,aa as Ee,B as o,t as B,a4 as A,a5 as K,a7 as r,I as y,ak as Q,af as S,ag as I,ai as D,aj as m,ah as G,a9 as Z,K as U,C as $,e as de,o as me,n as J,a8 as Fe,an as He,f as W,aV as X,at as he,a6 as xe,s as h}from"./index-DwrhXWM3.js";import{T as Y,a as ee,b as j,c as C}from"./tabs-DJpjTeDe.js";import{T as Ve,a as Oe,b as ue,c as P,d as Be,e as M}from"./table-B4vHekNg.js";import{P as Ae}from"./plus-oULWhB69.js";import{F as Ke}from"./file-pen-DyX8aJh0.js";import{I as Qe}from"./image-D_6oqjpi.js";import{E as pe}from"./eye-D3AyRO7x.js";import{S as Ge}from"./square-pen-DqUDspQ2.js";import{T as Ze}from"./trash-2-BpBngrWz.js";import{U as $e}from"./users-BJ0tey1w.js";import{E as Je}from"./external-link-D1Xzfm_Q.js";import{M as We,S as Xe}from"./sparkles-CLVO7UK_.js";import{G as Ye}from"./gift-uDZJF6Ux.js";import{S as es}from"./star-D5FH4An7.js";import{H as ss}from"./heart-CaMSA8jY.js";import{C as ts}from"./circle-alert-Ca69ZvVh.js";import{I as ns}from"./info-B9Y0IKAJ.js";import{f as je}from"./format-BrDZPov3.js";import"./startOfDay-C97cAIwM.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=ge("PartyPopper",[["path",{d:"M5.8 11.3 2 22l10.7-3.79",key:"gwxi1d"}],["path",{d:"M4 3h.01",key:"1vcuye"}],["path",{d:"M22 8h.01",key:"1mrtc2"}],["path",{d:"M15 2h.01",key:"1cjtqr"}],["path",{d:"M22 20h.01",key:"1mrys2"}],["path",{d:"m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10",key:"hbicv8"}],["path",{d:"m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17",key:"1i94pl"}],["path",{d:"m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7",key:"1cofks"}],["path",{d:"M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z",key:"4kbmks"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=ge("Trophy",[["path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6",key:"17hqa7"}],["path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18",key:"lmptdp"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",key:"1nw9bq"}],["path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",key:"1np0yb"}],["path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z",key:"u46fv3"}]]),ls=["Bell","Megaphone","Gift","Star","Heart","AlertCircle","Info","PartyPopper","Sparkles","Trophy"],rs={Bell:se,Megaphone:We,Gift:Ye,Star:es,Heart:ss,AlertCircle:ts,Info:ns,PartyPopper:as,Sparkles:Xe,Trophy:is},q=({name:t,className:k})=>{const p=rs[t]||se;return e.jsx(p,{className:k})};function bs(){const{t,i18n:k}=Me(),{user:p}=qe(),{toast:N}=Le(),L=Re(),[fe,T]=d.useState(!1),[ve,b]=d.useState(!1),[_e,z]=d.useState(!1),[v,te]=d.useState(null),[x,ne]=d.useState(null),[l,ye]=d.useState(null),[R,ae]=d.useState("zh"),[Ne,we]=d.useState("templates"),[i,c]=d.useState({title_zh:"",title_en:"",title_pt:"",content_zh:"",content_en:"",content_pt:"",icon:"Bell",image_url:"",link:"",status:"draft"}),[a,_]=d.useState({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),{data:Ce=[],isLoading:ke}=H({queryKey:["notification-templates"],queryFn:async()=>{const{data:s,error:n}=await h.from("notification_templates").select("*").order("created_at",{ascending:!1});if(n)throw n;return s}}),{data:Te=[],isLoading:be}=H({queryKey:["notification-send-records"],queryFn:async()=>{const{data:s,error:n}=await h.from("notification_send_records").select("*").order("sent_at",{ascending:!1});if(n)throw n;return s}}),{data:ze=[]}=H({queryKey:["all-users-for-notification"],queryFn:async()=>{const{data:s,error:n}=await h.from("profiles").select("id, display_name").order("display_name");if(n)throw n;return s}}),E=V({mutationFn:async s=>{if(s.id){const{error:n}=await h.from("notification_templates").update({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon,image_url:s.image_url||null,link:s.link||null,status:s.status}).eq("id",s.id);if(n)throw n}else{const{error:n}=await h.from("notification_templates").insert({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon,image_url:s.image_url||null,link:s.link||null,status:s.status,created_by:p==null?void 0:p.id});if(n)throw n}},onSuccess:()=>{L.invalidateQueries({queryKey:["notification-templates"]}),T(!1),le(),N({title:t("common.success"),description:t(v?"common.updated":"common.created")})},onError:s=>{N({title:t("common.error"),description:s.message,variant:"destructive"})}}),ie=V({mutationFn:async s=>{const{error:n}=await h.from("notification_templates").delete().eq("id",s);if(n)throw n},onSuccess:()=>{L.invalidateQueries({queryKey:["notification-templates"]}),N({title:t("common.success"),description:t("common.deleted")})}}),F=V({mutationFn:async()=>{if(!x)throw new Error("No template selected");let s=[];if(a.targetType==="all"){const{data:f}=await h.from("profiles").select("id");s=(f==null?void 0:f.map(w=>w.id))||[]}else if(a.targetType==="role"){const f=a.targetRole,{data:w}=await h.from("user_roles").select("user_id").eq("role",f);s=(w==null?void 0:w.map(Pe=>Pe.user_id))||[]}else s=a.targetUserIds;if(s.length===0)throw new Error("No users to send to");const n=s.map(f=>({user_id:f,type:"activity_update",title:g(x,"title"),content:g(x,"content"),link:x.link})),{error:u}=await h.from("notifications").insert(n);if(u)throw u;const Ue=a.targetType==="role"?a.targetRole:null,{error:oe}=await h.from("notification_send_records").insert({template_id:x.id,title:g(x,"title"),content:g(x,"content"),target_type:a.targetType,target_role:Ue,target_user_ids:a.targetType==="specific"?a.targetUserIds:null,sent_count:s.length,sent_by:p==null?void 0:p.id});if(oe)throw oe;return s.length},onSuccess:s=>{L.invalidateQueries({queryKey:["notification-send-records"]}),b(!1),ne(null),_({targetType:"all",targetRole:"",targetUserIds:[],userSearch:""}),N({title:t("common.success"),description:t("admin.notificationsSent",{count:s})||`已发送 ${s} 条通知`})},onError:s=>{N({title:t("common.error"),description:s.message,variant:"destructive"})}}),g=(s,n)=>{const u=k.language;return n==="title"?u==="zh"?s.title_zh:u==="pt"?s.title_pt:s.title_en:u==="zh"?s.content_zh:u==="pt"?s.content_pt:s.content_en},le=()=>{c({title_zh:"",title_en:"",title_pt:"",content_zh:"",content_en:"",content_pt:"",icon:"Bell",image_url:"",link:"",status:"draft"}),te(null)},Se=s=>{te(s),c({title_zh:s.title_zh,title_en:s.title_en,title_pt:s.title_pt,content_zh:s.content_zh,content_en:s.content_en,content_pt:s.content_pt,icon:s.icon||"Bell",image_url:s.image_url||"",link:s.link||"",status:s.status}),T(!0)},re=s=>{ne(s),b(!0)},Ie=s=>{ye(s),ae(k.language),z(!0)},ce=(s,n)=>({title:n==="zh"?s.title_zh:n==="pt"?s.title_pt:s.title_en,content:n==="zh"?s.content_zh:n==="pt"?s.content_pt:s.content_en}),De=ze.filter(s=>{var n;return(n=s.display_name)==null?void 0:n.toLowerCase().includes(a.userSearch.toLowerCase())});return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(se,{className:"h-6 w-6"}),t("admin.notifications","发送通知")]}),e.jsx("p",{className:"text-muted-foreground",children:t("admin.notificationsDesc","管理通知模板和发送站内通知")})]})}),e.jsxs(Y,{value:Ne,onValueChange:we,children:[e.jsxs(ee,{children:[e.jsx(j,{value:"templates",children:t("admin.templates","模板管理")}),e.jsx(j,{value:"records",children:t("admin.sendRecords","发送记录")})]}),e.jsxs(C,{value:"templates",className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(O,{open:fe,onOpenChange:s=>{T(s),s||le()},children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(o,{children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),t("admin.createTemplate","创建模板")]})}),e.jsxs(B,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(A,{children:e.jsx(K,{children:v?t("admin.editTemplate","编辑模板"):t("admin.createTemplate","创建模板")})}),e.jsxs(Y,{defaultValue:"zh",className:"w-full",children:[e.jsxs(ee,{className:"grid w-full grid-cols-3",children:[e.jsx(j,{value:"zh",children:"中文"}),e.jsx(j,{value:"en",children:"English"}),e.jsx(j,{value:"pt",children:"Português"})]}),e.jsxs(C,{value:"zh",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(y,{value:i.title_zh,onChange:s=>c({...i,title_zh:s.target.value}),placeholder:"通知标题"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Q,{value:i.content_zh,onChange:s=>c({...i,content_zh:s.target.value}),placeholder:"通知内容",rows:4})]})]}),e.jsxs(C,{value:"en",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(y,{value:i.title_en,onChange:s=>c({...i,title_en:s.target.value}),placeholder:"Notification Title"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Q,{value:i.content_en,onChange:s=>c({...i,content_en:s.target.value}),placeholder:"Notification Content",rows:4})]})]}),e.jsxs(C,{value:"pt",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("common.title")}),e.jsx(y,{value:i.title_pt,onChange:s=>c({...i,title_pt:s.target.value}),placeholder:"Título da Notificação"})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.content")}),e.jsx(Q,{value:i.content_pt,onChange:s=>c({...i,content_pt:s.target.value}),placeholder:"Conteúdo da Notificação",rows:4})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("admin.icon","图标")}),e.jsxs(S,{value:i.icon,onValueChange:s=>c({...i,icon:s}),children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{name:i.icon,className:"h-4 w-4"}),e.jsx("span",{children:i.icon})]})}),e.jsx(D,{children:ls.map(s=>e.jsx(m,{value:s,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{name:s,className:"h-4 w-4"}),e.jsx("span",{children:s})]})},s))})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("common.status")}),e.jsxs(S,{value:i.status,onValueChange:s=>c({...i,status:s}),children:[e.jsx(I,{children:e.jsx(G,{})}),e.jsxs(D,{children:[e.jsx(m,{value:"draft",children:t("common.draft","草稿")}),e.jsx(m,{value:"published",children:t("common.published","已发布")})]})]})]})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("admin.imageUrl","图片URL（可选）")}),e.jsx(y,{value:i.image_url,onChange:s=>c({...i,image_url:s.target.value}),placeholder:"https://..."})]}),e.jsxs("div",{children:[e.jsx(r,{children:t("admin.link","链接（可选）")}),e.jsx(y,{value:i.link,onChange:s=>c({...i,link:s.target.value}),placeholder:"/activity/xxx"})]}),e.jsxs(Z,{children:[e.jsx(o,{variant:"outline",onClick:()=>T(!1),children:t("common.cancel")}),e.jsxs(o,{onClick:()=>E.mutate({...i,id:v==null?void 0:v.id}),disabled:E.isPending||!i.title_zh||!i.content_zh,children:[E.isPending&&e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),t(v?"common.save":"common.create")]})]})]})]})}),ke?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(U,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:Ce.map(s=>e.jsxs($,{children:[e.jsxs(de,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(me,{className:"text-lg",children:g(s,"title")}),e.jsx(J,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"h-3 w-3 mr-1"}),t("common.published","已发布")]}):e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"h-3 w-3 mr-1"}),t("common.draft","草稿")]})})]}),e.jsx(He,{className:"line-clamp-2",children:g(s,"content")})]}),e.jsxs(W,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-4",children:[e.jsx(q,{name:s.icon||"Bell",className:"h-4 w-4"}),e.jsx("span",{children:s.icon||"Bell"}),s.image_url&&e.jsx(Qe,{className:"h-4 w-4 ml-2"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>Ie(s),children:[e.jsx(pe,{className:"h-4 w-4 mr-1"}),t("common.preview","预览")]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>Se(s),children:[e.jsx(Ge,{className:"h-4 w-4 mr-1"}),t("common.edit")]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>ie.mutate(s.id),disabled:ie.isPending,children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),t("common.delete")]}),s.status==="published"&&e.jsxs(o,{size:"sm",onClick:()=>re(s),children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),t("common.send","发送")]})]})]})]},s.id))})]}),e.jsx(C,{value:"records",children:e.jsxs($,{children:[e.jsx(de,{children:e.jsx(me,{children:t("admin.sendRecords","发送记录")})}),e.jsx(W,{children:be?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(U,{className:"h-8 w-8 animate-spin"})}):e.jsxs(Ve,{children:[e.jsx(Oe,{children:e.jsxs(ue,{children:[e.jsx(P,{children:t("common.title")}),e.jsx(P,{children:t("admin.targetType","发送对象")}),e.jsx(P,{children:t("admin.sentCount","发送数量")}),e.jsx(P,{children:t("admin.sentAt","发送时间")})]})}),e.jsx(Be,{children:Te.map(s=>e.jsxs(ue,{children:[e.jsx(M,{className:"font-medium",children:s.title}),e.jsx(M,{children:e.jsx(J,{variant:"outline",children:s.target_type==="all"?e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-3 w-3 mr-1"}),t("admin.allUsers","全部用户")]}):s.target_type==="role"?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),s.target_role]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),t("admin.specificUsers","指定用户")]})})}),e.jsx(M,{children:s.sent_count}),e.jsx(M,{children:je(new Date(s.sent_at),"yyyy-MM-dd HH:mm")})]},s.id))})]})})]})})]}),e.jsx(O,{open:ve,onOpenChange:b,children:e.jsxs(B,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(K,{children:t("admin.sendNotification","发送通知")}),e.jsx(xe,{children:x&&g(x,"title")})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(r,{children:t("admin.targetType","发送对象")}),e.jsxs(S,{value:a.targetType,onValueChange:s=>_({...a,targetType:s}),children:[e.jsx(I,{children:e.jsx(G,{})}),e.jsxs(D,{children:[e.jsx(m,{value:"all",children:t("admin.allUsers","全部用户")}),e.jsx(m,{value:"role",children:t("admin.byRole","按身份")}),e.jsx(m,{value:"specific",children:t("admin.specificUsers","指定用户")})]})]})]}),a.targetType==="role"&&e.jsxs("div",{children:[e.jsx(r,{children:t("admin.selectRole","选择身份")}),e.jsxs(S,{value:a.targetRole,onValueChange:s=>_({...a,targetRole:s}),children:[e.jsx(I,{children:e.jsx(G,{placeholder:t("admin.selectRole")})}),e.jsxs(D,{children:[e.jsx(m,{value:"user",children:t("common.user","用户")}),e.jsx(m,{value:"merchant",children:t("common.merchant","商家")}),e.jsx(m,{value:"supervisor",children:t("common.supervisor","主管")}),e.jsx(m,{value:"admin",children:t("common.admin","管理员")})]})]})]}),a.targetType==="specific"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:t("admin.selectUsers","选择用户")}),e.jsx(y,{placeholder:t("admin.searchUsers","搜索用户..."),value:a.userSearch,onChange:s=>_({...a,userSearch:s.target.value})}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded-md p-2 space-y-1",children:De.slice(0,20).map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-1 hover:bg-muted rounded cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.targetUserIds.includes(s.id),onChange:n=>{n.target.checked?_({...a,targetUserIds:[...a.targetUserIds,s.id]}):_({...a,targetUserIds:a.targetUserIds.filter(u=>u!==s.id)})}}),e.jsx("span",{className:"text-sm",children:s.display_name})]},s.id))}),a.targetUserIds.length>0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.selectedUsersCount",{count:a.targetUserIds.length})})]})]}),e.jsxs(Z,{children:[e.jsx(o,{variant:"outline",onClick:()=>b(!1),children:t("common.cancel")}),e.jsxs(o,{onClick:()=>F.mutate(),disabled:F.isPending||a.targetType==="role"&&!a.targetRole||a.targetType==="specific"&&a.targetUserIds.length===0,children:[F.isPending&&e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx(X,{className:"h-4 w-4 mr-2"}),t("common.send","发送")]})]})]})}),e.jsx(O,{open:_e,onOpenChange:z,children:e.jsxs(B,{className:"max-w-lg",children:[e.jsxs(A,{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),t("admin.previewNotification","预览通知")]}),e.jsx(xe,{children:t("admin.previewNotificationDesc","查看不同语言版本的通知内容")})]}),l&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(Y,{value:R,onValueChange:s=>ae(s),children:e.jsxs(ee,{className:"grid w-full grid-cols-3",children:[e.jsx(j,{value:"zh",children:"中文"}),e.jsx(j,{value:"en",children:"English"}),e.jsx(j,{value:"pt",children:"Português"})]})}),e.jsx($,{className:"border-2",children:e.jsx(W,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(q,{name:l.icon||"Bell",className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("h4",{className:"font-semibold text-base",children:ce(l,R).title}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:ce(l,R).content}),l.image_url&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:l.image_url,alt:"Notification",className:"rounded-md max-h-40 object-cover"})}),l.link&&e.jsxs("div",{className:"mt-2 flex items-center gap-1 text-sm text-primary",children:[e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate",children:l.link})]})]})]})})}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:[t("common.status"),":"]}),e.jsx(J,{variant:l.status==="published"?"default":"secondary",className:"text-xs",children:l.status==="published"?t("common.published","已发布"):t("common.draft","草稿")})]}),e.jsxs("div",{children:[t("common.createdAt"),": ",je(new Date(l.created_at),"yyyy-MM-dd HH:mm")]})]})]}),e.jsxs(Z,{children:[e.jsx(o,{variant:"outline",onClick:()=>z(!1),children:t("common.close","关闭")}),(l==null?void 0:l.status)==="published"&&e.jsxs(o,{onClick:()=>{z(!1),re(l)},children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),t("common.send","发送")]})]})]})})]})}export{bs as default};
