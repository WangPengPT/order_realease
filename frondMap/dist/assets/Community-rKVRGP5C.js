import{p as B,u as He,r as i,j as e,cX as ze,cl as Be,ba as Ve,b5 as Y,be as qe,bB as je,bA as J,bf as ye,ao as Ge,e7 as C,b4 as Ne,e8 as be,a4 as O,a_ as ve,e9 as We,ea as Qe,bJ as Ke,aM as xe,X as he,bh as Xe,cK as Je,w as T,q as Ye,bO as pe,eb as Ze,bc as es,bb as ss}from"./vendor-react-DO-hMdHk.js";import{u as ts,g as ge,P as as,Q as rs,R as ns,D as is,W as os,c as ls,d as cs,e as ds,i as N,a as K,I as ms,B as z,S as we,G as us,af as xs,ak as hs,ag as ps,al as gs,a8 as fs,s as $,j as V}from"./index-KBuYVGMg.js";import{c as js,d as ys,e as Ns,f as bs,g as vs,h as ws}from"./useCommunityPosts-DHmVkHCb.js";import{u as X}from"./useLocalizedContent-SBVFuvBn.js";import{c as ks}from"./usePoints-C0owLGEQ.js";import{D as Z,b as ee,c as se,d as te,f as ke}from"./drawer-oDqjc-Rl.js";import{P as ae,a as re,b as ne}from"./popover-CYrdJaKB.js";import{u as Cs}from"./useActivities-GmVKrwZU.js";import{u as Ss}from"./useRestaurants-SKBtC6Wb.js";import{P as Rs}from"./PullToRefresh-DKLdHiPv.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-DUJEpEPV.js";const Ps=({post:s,showAssociations:t=!1})=>{const{t:r}=B(),{user:d}=ts(),x=He(),{getLocalizedField:o}=X(),R=js(),[c,g]=i.useState(!1),y=a=>{a.preventDefault(),a.stopPropagation(),d&&R.mutate({postId:s.id,liked:s.user_liked||!1})},m=()=>{x(`/community/${s.id}`)},p=a=>{a.preventDefault(),a.stopPropagation(),s.restaurant?.id&&x(`/restaurant/${s.restaurant.id}`)},f=a=>{a.preventDefault(),a.stopPropagation(),s.activity?.id&&x(`/activity/${s.activity.id}`)},v=a=>new DOMParser().parseFromString(a,"text/html").body.textContent||"",h=o(s,"content"),n=v(h),S=s.image_urls&&s.image_urls.length>0,k=!!s.video_url,L=S||k,U=s.image_urls?.length||0,I=s.restaurant?o(s.restaurant,"name"):null,_=s.activity?o(s.activity,"title"):null;return e.jsxs("div",{className:"group cursor-pointer rounded-lg overflow-hidden bg-card border border-border/50 hover:shadow-lg transition-all duration-300 hover:-translate-y-1",onClick:m,children:[L&&e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden",children:[S?c?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:r("common.imageLoadError","å›¾ç‰‡åŠ è½½å¤±è´¥")})}):e.jsx("img",{src:s.image_urls[0],alt:"",className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",onError:()=>g(!0)}):k?e.jsx("video",{src:s.video_url,className:"w-full h-full object-cover",preload:"metadata",muted:!0,playsInline:!0}):null,k&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-black/50 backdrop-blur-sm flex items-center justify-center",children:e.jsx(ze,{className:"h-5 w-5 text-white fill-white ml-0.5"})})}),!k&&U>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full z-10 flex items-center gap-1",children:[e.jsx(Be,{className:"h-3 w-3"}),e.jsx("span",{children:U})]})]}),e.jsxs("div",{className:"p-3",children:[t&&(I||_)&&e.jsxs("div",{className:"flex flex-wrap gap-1.5 mb-2",children:[I&&e.jsxs(ge,{variant:"secondary",className:"text-xs cursor-pointer hover:bg-secondary/80 gap-1",onClick:p,children:[e.jsx(Ve,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-[120px]",children:I})]}),_&&e.jsxs(ge,{variant:"secondary",className:"text-xs cursor-pointer hover:bg-secondary/80 gap-1",onClick:f,children:[e.jsx(Y,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-[120px]",children:_})]})]}),e.jsx("p",{className:`text-sm font-medium line-clamp-2 leading-relaxed ${L?"":"min-h-[60px]"}`,children:n}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(as,{className:"h-5 w-5 flex-shrink-0",children:[e.jsx(rs,{src:s.author?.avatar_url||void 0}),e.jsx(ns,{className:"text-[10px]",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:s.author?.display_name})]}),e.jsxs("button",{className:`flex items-center gap-1 text-xs ${s.user_liked?"text-red-500":"text-muted-foreground"} hover:text-red-500 transition-colors`,onClick:y,disabled:!d,children:[e.jsx(qe,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count||0})]})]})]})]})},Ls=()=>{const{t:s}=B(),{data:t}=ks(),r=t?.find(o=>o.key==="post_points")?.value||"5",d=t?.find(o=>o.key==="min_post_length")?.value||"10",x=t?.find(o=>o.key==="post_require_media")?.value==="true";return e.jsxs(is,{children:[e.jsx(os,{asChild:!0,children:e.jsx("button",{className:"text-primary hover:underline text-sm whitespace-nowrap",children:s("community.viewPointsRules","æŸ¥çœ‹è¯¦ç»†è§„åˆ™")})}),e.jsxs(ls,{className:"max-w-md",children:[e.jsx(cs,{children:e.jsxs(ds,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5 text-primary"}),s("community.pointsRulesTitle","å‘å¸–ç§¯åˆ†è§„åˆ™")]})}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:s("community.pointsRulesIntro","é€šè¿‡å‘å¸ƒç¤¾åŒºå¸–å­è·å¾—ç§¯åˆ†ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š")}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(J,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.rulePostPoints",{points:r})})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(J,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleMinLength",{length:d})})]}),x&&e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(J,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleRequireMedia","å¸–å­å¿…é¡»åŒ…å«è‡³å°‘ä¸€å¼ å›¾ç‰‡æˆ–ä¸€ä¸ªè§†é¢‘")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(ye,{className:"h-4 w-4 text-blue-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleDailyLimit","æ¯å¤©ä»…å¯é€šè¿‡å‘å¸–è·å¾—ä¸€æ¬¡ç§¯åˆ†å¥–åŠ±")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ge,{className:"h-4 w-4 text-purple-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleModerationRequired","å¸–å­éœ€é€šè¿‡å®¡æ ¸åæ‰èƒ½è·å¾—ç§¯åˆ†")})]})]})]})]})]})},ie=i.forwardRef(({className:s,...t},r)=>e.jsx(C,{ref:r,className:N("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...t}));ie.displayName=C.displayName;const Ce=i.forwardRef(({className:s,...t},r)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(C.Input,{ref:r,className:N("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...t})]}));Ce.displayName=C.Input.displayName;const oe=i.forwardRef(({className:s,...t},r)=>e.jsx(C.List,{ref:r,className:N("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...t}));oe.displayName=C.List.displayName;const Se=i.forwardRef((s,t)=>e.jsx(C.Empty,{ref:t,className:"py-6 text-center text-sm",...s}));Se.displayName=C.Empty.displayName;const le=i.forwardRef(({className:s,...t},r)=>e.jsx(C.Group,{ref:r,className:N("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...t}));le.displayName=C.Group.displayName;const Is=i.forwardRef(({className:s,...t},r)=>e.jsx(C.Separator,{ref:r,className:N("-mx-1 h-px bg-border",s),...t}));Is.displayName=C.Separator.displayName;const q=i.forwardRef(({className:s,...t},r)=>e.jsx(C.Item,{ref:r,className:N("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",s),...t}));q.displayName=C.Item.displayName;const Us=({open:s,onOpenChange:t,value:r,onSelect:d,restaurants:x,showNoneOption:o=!0,required:R=!1})=>{const{t:c}=B(),{getLocalizedField:g}=X(),y=K(),[m,p]=i.useState(""),[f,v]=i.useState(r),[h,n]=i.useState("85vh");i.useEffect(()=>{if(!s||!y)return;const a=window.visualViewport;if(!a){n("85vh");return}const P=()=>{const E=a.height,D=Math.min(E*.85,E-50);n(`${D}px`)};return P(),a.addEventListener("resize",P),()=>{a.removeEventListener("resize",P)}},[s,y]);const S=a=>{a&&(v(r),p("")),t(a)},k=x?.filter(a=>{if(!m)return!0;const P=g(a,"name")?.toLowerCase()||"",E=a.address?.toLowerCase()||"",D=m.toLowerCase();return P.includes(D)||E.includes(D)})||[],L=()=>{if(!r)return"";const a=x?.find(P=>P.id===r);return a?g(a,"name"):""},U=()=>{d(f),t(!1),p("")},I=a=>{d(a),t(!1),p("")},_=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>S(!0),children:[r?e.jsx("span",{className:"text-primary",children:L()}):e.jsxs("span",{className:"text-muted-foreground",children:[c("community.linkRestaurant","å…³è”é¤å…"),R&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(be,{className:"h-4 w-4 opacity-50"})]});return y?e.jsxs(e.Fragment,{children:[_,e.jsx(Z,{open:s,onOpenChange:S,children:e.jsxs(ee,{className:"flex flex-col",style:{height:h,maxHeight:h,transition:"height 0.15s ease-out, max-height 0.15s ease-out"},children:[e.jsx(se,{className:"pb-2 shrink-0",children:e.jsx(te,{children:c("community.selectRestaurant","é€‰æ‹©é¤å…")})}),e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ms,{placeholder:c("community.searchRestaurant","æœç´¢é¤å…..."),value:m,onChange:a=>p(a.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 min-h-0",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[o&&e.jsxs("div",{className:N("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",f===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>v(""),children:[e.jsx(O,{className:N("h-4 w-4 shrink-0",f===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:c("community.noRestaurantLink","ä¸å…³è”é¤å…")})]}),k.map(a=>e.jsxs("div",{className:N("flex items-start gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",f===a.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>v(a.id),children:[e.jsx(O,{className:N("h-4 w-4 shrink-0 mt-0.5",f===a.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:g(a,"name")}),a.address&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate flex items-center gap-1 mt-0.5",children:[e.jsx(ve,{className:"h-3 w-3 shrink-0"}),a.address]})]})]},a.id)),k.length===0&&m&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:c("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")})]})}),e.jsx(ke,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(z,{variant:"outline",className:"flex-1",onClick:()=>S(!1),children:c("common.cancel","å–æ¶ˆ")}),e.jsx(z,{className:"flex-1",onClick:U,children:c("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(ae,{open:s,onOpenChange:S,children:[e.jsx(re,{asChild:!0,children:_}),e.jsx(ne,{className:"w-72 p-0",align:"start",children:e.jsxs(ie,{shouldFilter:!1,children:[e.jsx(Ce,{placeholder:c("community.searchRestaurant","æœç´¢é¤å…..."),value:m,onValueChange:p}),e.jsxs(oe,{children:[e.jsx(Se,{children:c("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")}),e.jsxs(le,{children:[o&&e.jsxs(q,{value:"none",onSelect:()=>I(""),children:[e.jsx(O,{className:N("mr-2 h-4 w-4",r?"opacity-0":"opacity-100")}),c("community.noRestaurantLink","ä¸å…³è”é¤å…")]}),k.map(a=>e.jsxs(q,{value:a.id,onSelect:()=>I(a.id),children:[e.jsx(O,{className:N("mr-2 h-4 w-4",r===a.id?"opacity-100":"opacity-0")}),g(a,"name")]},a.id))]})]})]})})]})},_s=({open:s,onOpenChange:t,value:r,onSelect:d,activities:x})=>{const{t:o}=B(),{getLocalizedField:R}=X(),c=K(),[g,y]=i.useState(r),m=n=>{n&&y(r),t(n)},p=()=>{if(!r)return"";const n=x?.find(S=>S.id===r);return n?R(n,"title"):""},f=()=>{d(g),t(!1)},v=n=>{d(n),t(!1)},h=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>m(!0),children:[r?e.jsx("span",{className:"text-primary",children:p()}):e.jsx("span",{className:"text-muted-foreground",children:o("community.linkActivity","å…³è”æ´»åŠ¨")}),e.jsx(be,{className:"h-4 w-4 opacity-50"})]});return c?e.jsxs(e.Fragment,{children:[h,e.jsx(Z,{open:s,onOpenChange:m,children:e.jsxs(ee,{className:"max-h-[85vh] flex flex-col",children:[e.jsx(se,{className:"pb-2",children:e.jsx(te,{children:o("community.selectActivity","é€‰æ‹©æ´»åŠ¨")})}),e.jsx(we,{className:"flex-1 px-4",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:N("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",g===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>y(""),children:[e.jsx(O,{className:N("h-4 w-4 shrink-0",g===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:o("community.noActivity","ä¸å…³è”æ´»åŠ¨")})]}),x.map(n=>e.jsxs("div",{className:N("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",g===n.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>y(n.id),children:[e.jsx(O,{className:N("h-4 w-4 shrink-0",g===n.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:R(n,"title")})]})]},n.id)),x.length===0&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:o("activities.noActivities","æš‚æ— å¯ç”¨æ´»åŠ¨")})]})}),e.jsx(ke,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(z,{variant:"outline",className:"flex-1",onClick:()=>m(!1),children:o("common.cancel","å–æ¶ˆ")}),e.jsx(z,{className:"flex-1",onClick:f,children:o("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(ae,{open:s,onOpenChange:m,children:[e.jsx(re,{asChild:!0,children:h}),e.jsx(ne,{className:"w-72 p-0",align:"start",children:e.jsx(ie,{children:e.jsx(oe,{children:e.jsxs(le,{children:[e.jsxs(q,{value:"none",onSelect:()=>v(""),children:[e.jsx(O,{className:N("mr-2 h-4 w-4",r?"opacity-0":"opacity-100")}),o("community.noActivity","ä¸å…³è”æ´»åŠ¨")]}),x.map(n=>e.jsxs(q,{value:n.id,onSelect:()=>v(n.id),children:[e.jsx(O,{className:N("mr-2 h-4 w-4",r===n.id?"opacity-100":"opacity-0")}),R(n,"title")]},n.id))]})})})})]})},fe=[{name:"smileys",emojis:["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ¤£","ğŸ˜‚","ğŸ™‚","ğŸ˜Š","ğŸ˜‡","ğŸ¥°","ğŸ˜","ğŸ¤©","ğŸ˜˜","ğŸ˜—","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ¤‘","ğŸ¤—","ğŸ¤­","ğŸ¤«","ğŸ¤”","ğŸ¤","ğŸ¤¨","ğŸ˜","ğŸ˜‘","ğŸ˜¶","ğŸ˜","ğŸ˜’","ğŸ™„","ğŸ˜¬","ğŸ¤¥","ğŸ˜Œ","ğŸ˜”","ğŸ˜ª","ğŸ¤¤","ğŸ˜´","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤®","ğŸ¥µ","ğŸ¥¶","ğŸ¥´","ğŸ˜µ","ğŸ¤¯","ğŸ¤ ","ğŸ¥³","ğŸ˜","ğŸ¤“","ğŸ§"]},{name:"gestures",emojis:["ğŸ‘","ğŸ‘","ğŸ‘Œ","ğŸ¤Œ","âœŒï¸","ğŸ¤","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","â˜ï¸","âœ‹","ğŸ¤š","ğŸ–ï¸","ğŸ––","ğŸ‘‹","ğŸ¤","ğŸ™","ğŸ’ª","ğŸ¦¾","ğŸ¦¿","ğŸ¦µ","ğŸ¦¶","ğŸ‘‚","ğŸ¦»","ğŸ‘ƒ","ğŸ§ ","ğŸ‘€","ğŸ‘ï¸","ğŸ‘…","ğŸ‘„"]},{name:"food",emojis:["ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥¬","ğŸ¥’","ğŸŒ¶ï¸","ğŸ«‘","ğŸŒ½","ğŸ¥•","ğŸ§„","ğŸ§…","ğŸ¥”","ğŸ ","ğŸ¥","ğŸ¥¯","ğŸ","ğŸ¥–","ğŸ¥¨","ğŸ§€","ğŸ¥š","ğŸ³","ğŸ§ˆ","ğŸ¥","ğŸ§‡","ğŸ¥“","ğŸ¥©","ğŸ—","ğŸ–","ğŸ¦´","ğŸŒ­","ğŸ”","ğŸŸ","ğŸ•","ğŸ«“","ğŸ¥ª","ğŸ¥™","ğŸ§†","ğŸŒ®","ğŸŒ¯","ğŸ«”","ğŸ¥—","ğŸ¥˜","ğŸ«•","ğŸ¥«","ğŸ","ğŸœ","ğŸ²","ğŸ›","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸ¦ª","ğŸ¤","ğŸ™","ğŸš","ğŸ˜","ğŸ¥","ğŸ¥ ","ğŸ¥®","ğŸ¢","ğŸ¡","ğŸ§","ğŸ¨","ğŸ¦","ğŸ¥§","ğŸ§","ğŸ°","ğŸ‚","ğŸ®","ğŸ­","ğŸ¬","ğŸ«","ğŸ¿","ğŸ©","ğŸª"]},{name:"hearts",emojis:["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ¤","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’","ğŸ’“","ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’","ğŸ’Ÿ","â™¥ï¸"]},{name:"objects",emojis:["â­","ğŸŒŸ","âœ¨","ğŸ’«","ğŸ”¥","ğŸ’¯","ğŸ‰","ğŸŠ","ğŸˆ","ğŸ","ğŸ†","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","âš½","ğŸ€","ğŸˆ","âš¾","ğŸ¾","ğŸ","ğŸ±","ğŸ“","ğŸ®","ğŸ²","ğŸ§©","ğŸ­","ğŸ¨","ğŸ¬","ğŸ¤","ğŸ§","ğŸµ","ğŸ¶","ğŸ¹","ğŸ¸","ğŸº","ğŸ»","ğŸ“·","ğŸ“¸","ğŸ“¹","ğŸ¥","ğŸ“±","ğŸ’»","âŒ¨ï¸","ğŸ–¥ï¸","ğŸ“º","ğŸ“»","â°","âŒš","ğŸ’¡","ğŸ”¦","ğŸ“š","ğŸ“–","âœï¸","ğŸ“","ğŸ’°","ğŸ’µ","ğŸ’´","ğŸ’¶","ğŸ’·","ğŸ’³","ğŸ›’","ğŸ€","ğŸ—ï¸"]},{name:"nature",emojis:["ğŸŒ¸","ğŸ’®","ğŸµï¸","ğŸŒ¹","ğŸ¥€","ğŸŒº","ğŸŒ»","ğŸŒ¼","ğŸŒ·","ğŸŒ±","ğŸª´","ğŸŒ²","ğŸŒ³","ğŸŒ´","ğŸŒµ","ğŸŒ¾","ğŸŒ¿","â˜˜ï¸","ğŸ€","ğŸ","ğŸ‚","ğŸƒ","ğŸŒ","ğŸŒ","ğŸŒ","ğŸŒ™","â­","â˜€ï¸","ğŸŒ¤ï¸","â›…","ğŸŒ¥ï¸","â˜ï¸","ğŸŒ¦ï¸","ğŸŒ§ï¸","â›ˆï¸","ğŸŒ©ï¸","ğŸŒ¨ï¸","â„ï¸","â˜ƒï¸","â›„","ğŸŒ¬ï¸","ğŸ’¨","ğŸŒŠ","ğŸ’§","ğŸ’¦","â˜”","ğŸŒˆ"]}],Es=({onSelect:s})=>{const{t}=B(),r=K(),[d,x]=i.useState(!1),[o,R]=i.useState(0),c=p=>{s(p),r||x(!1)},g={smileys:t("emoji.smileys","è¡¨æƒ…"),gestures:t("emoji.gestures","æ‰‹åŠ¿"),food:t("emoji.food","ç¾é£Ÿ"),hearts:t("emoji.hearts","çˆ±å¿ƒ"),objects:t("emoji.objects","ç‰©å“"),nature:t("emoji.nature","è‡ªç„¶")},y=e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 border-b",children:fe.map((p,f)=>e.jsx("button",{type:"button",onClick:()=>R(f),className:`px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors ${o===f?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-muted-foreground"}`,children:g[p.name]},p.name))}),e.jsx("div",{className:"grid grid-cols-8 gap-1",children:fe[o].emojis.map((p,f)=>e.jsx("button",{type:"button",onClick:()=>c(p),className:"w-9 h-9 flex items-center justify-center text-xl hover:bg-muted rounded-md transition-colors",children:p},f))})]}),m=e.jsxs("button",{type:"button",onClick:()=>x(!0),className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(We,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.emoji","è¡¨æƒ…")})]});return r?e.jsxs(e.Fragment,{children:[m,e.jsx(Z,{open:d,onOpenChange:x,children:e.jsxs(ee,{className:"h-[50vh]",children:[e.jsx(se,{className:"pb-2",children:e.jsx(te,{children:t("emoji.title","é€‰æ‹©è¡¨æƒ…")})}),e.jsx(we,{className:"flex-1 px-4 pb-4",children:y})]})})]}):e.jsxs(ae,{open:d,onOpenChange:x,children:[e.jsx(re,{asChild:!0,children:m}),e.jsx(ne,{className:"w-80 p-3",align:"start",side:"top",children:y})]})},Ds=({trigger:s})=>{const{t}=B(),{getLocalizedField:r}=X(),d=ys(),{data:x}=Cs(),{data:o}=Ss(),{role:R,isMerchant:c,isAdmin:g,isSupervisor:y}=us(),{data:m}=Ns(),{data:p,isLoading:f}=bs(),[v,h]=i.useState(!1),[n,S]=i.useState(""),[k,L]=i.useState([]),[U,I]=i.useState(null),[_,a]=i.useState(""),[P,E]=i.useState(""),[D,G]=i.useState(!1),[Re,ce]=i.useState(!1),[Pe,de]=i.useState(!1),W=i.useRef(null),Q=i.useRef(null),me=!c&&!y&&!g;i.useEffect(()=>{c&&m&&v&&E(m.id)},[c,m,v]);const ue=()=>{S(""),L([]),I(null),a(""),E(""),ce(!1),de(!1)},Le=u=>{h(u),u||ue()},Ie=x?.filter(u=>u.status==="published")||[],Ue=async u=>{const j=u.target.files;if(!(!j||j.length===0)){if(k.length+j.length>9){T.error(t("community.maxImages","æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡"));return}G(!0);try{const{data:{user:w}}=await $.auth.getUser();if(!w)throw new Error("Not authenticated");const l=[];for(const b of Array.from(j)){const H=b.name.split(".").pop(),A=`${w.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${H}`,{error:F}=await $.storage.from("community-posts").upload(A,b);if(F)throw F;const{data:{publicUrl:M}}=$.storage.from("community-posts").getPublicUrl(A);l.push(M)}L(b=>[...b,...l])}catch(w){console.error("Upload error:",w),T.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{G(!1),W.current&&(W.current.value="")}}},_e=u=>new Promise((j,w)=>{const l=document.createElement("video"),b=document.createElement("canvas"),H=b.getContext("2d");l.preload="auto",l.muted=!0,l.playsInline=!0;let A=!1;const F=()=>{A||l.videoWidth===0||l.videoHeight===0||(b.width=l.videoWidth,b.height=l.videoHeight,H&&(H.drawImage(l,0,0,b.width,b.height),b.toBlob(M=>{M&&M.size>0?(A=!0,l.pause(),URL.revokeObjectURL(l.src),j(M)):w(new Error("Failed to create blob"))},"image/jpeg",.85)))};l.onloadedmetadata=()=>{b.width=l.videoWidth,b.height=l.videoHeight,l.currentTime=.1},l.onseeked=()=>{setTimeout(F,100)},l.onerror=()=>{URL.revokeObjectURL(l.src),w(new Error("Failed to load video"))},setTimeout(()=>{A||(URL.revokeObjectURL(l.src),w(new Error("Timeout")))},1e4),l.src=URL.createObjectURL(u),l.load()}),Ee=async u=>{const j=u.target.files?.[0];if(j){if(j.size>100*1024*1024){T.error(t("community.videoTooLarge","è§†é¢‘ä¸èƒ½è¶…è¿‡100MB"));return}G(!0);try{const{data:{user:w}}=await $.auth.getUser();if(!w)throw new Error("Not authenticated");const l=j.name.split(".").pop(),b=`${w.id}/${Date.now()}.${l}`,{error:H}=await $.storage.from("community-posts").upload(b,j);if(H)throw H;const{data:{publicUrl:A}}=$.storage.from("community-posts").getPublicUrl(b);I(A);try{T.info(t("community.extractingCover","æ­£åœ¨æå–è§†é¢‘å°é¢..."));const F=await _e(j),M=`${w.id}/${Date.now()}-cover.jpg`,{error:Te}=await $.storage.from("community-posts").upload(M,F);if(!Te){const{data:{publicUrl:$e}}=$.storage.from("community-posts").getPublicUrl(M);L(Oe=>[$e,...Oe]),T.success(t("community.coverExtracted","å°é¢å·²è‡ªåŠ¨ç”Ÿæˆ"))}}catch(F){console.warn("Cover extraction failed:",F)}}catch(w){console.error("Upload error:",w),T.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{G(!1),Q.current&&(Q.current.value="")}}},De=u=>{L(j=>j.filter((w,l)=>l!==u))},Ae=()=>{I(null),L(u=>u.length>0&&u[0].includes("-cover.jpg")?u.slice(1):u)},Fe=async()=>{if(!n.trim()){T.error(t("community.contentRequired","è¯·è¾“å…¥å†…å®¹"));return}if(me&&!P){T.error(t("community.restaurantRequired","è¯·é€‰æ‹©é¤å…"));return}await d.mutateAsync({content:n,image_urls:k,video_url:U||void 0,activity_id:_||void 0,restaurant_id:P||void 0}),ue(),h(!1)},Me=()=>m?r(m,"name"):t("community.noRestaurant","æœªå…³è”é¤å…");return e.jsxs(xs,{open:v,onOpenChange:Le,children:[e.jsx(hs,{asChild:!0,children:s||e.jsx(z,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs(ps,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(Qe,{children:e.jsx(gs,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>h(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(Ke,{className:"h-5 w-5"})}),e.jsxs(z,{size:"sm",onClick:Fe,disabled:d.isPending||!n.trim(),className:"rounded-full px-6",children:[d.isPending&&e.jsx(xe,{className:"h-4 w-4 mr-2 animate-spin"}),t("community.publish","å‘å¸ƒ")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[!f&&!p&&e.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2 bg-primary/10 dark:bg-primary/20 border border-primary/30 dark:border-primary/40 rounded-md text-sm text-primary dark:text-primary",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:t("community.dailyPointsHint","æ¯æ—¥å‘å¸ƒé¦–ä¸ªå¸–å­å¯è·å¾—5ç§¯åˆ†ï¼")})]}),e.jsx(Ls,{})]}),e.jsx(fs,{value:n,onChange:u=>S(u.target.value),placeholder:t("community.contentPlaceholder","åˆ†äº«ä½ çš„æƒ³æ³•..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base"}),k.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:k.map((u,j)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:u,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>De(j),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(he,{className:"h-3 w-3"})})]},j))}),U&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:U,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:Ae,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(he,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-2 pb-0 bg-background shrink-0 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ve,{className:"h-5 w-5 text-muted-foreground shrink-0"}),c?e.jsx("span",{className:"text-sm text-muted-foreground",children:Me()}):e.jsx(Us,{open:Re,onOpenChange:ce,value:P,onSelect:E,restaurants:o||[],showNoneOption:y||g,required:me})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(_s,{open:Pe,onOpenChange:de,value:_,onSelect:a,activities:Ie})]})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 pt-0 py-2 pb-[max(2rem,calc(env(safe-area-inset-bottom)+1rem))] bg-background shrink-0",children:[e.jsx("input",{ref:W,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:Ue}),e.jsx("input",{ref:Q,type:"file",accept:"video/*",className:"hidden",onChange:Ee}),e.jsxs("button",{type:"button",onClick:()=>W.current?.click(),disabled:D||k.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Xe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.photo","ç…§ç‰‡")})]}),e.jsxs("button",{type:"button",onClick:()=>Q.current?.click(),disabled:D||!!U,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Je,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.video","è§†é¢‘")})]}),e.jsx(Es,{onSelect:u=>S(j=>j+u)}),D&&e.jsx(xe,{className:"h-5 w-5 animate-spin ml-auto"})]})]})]})},As=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(V,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"h-4 w-full"}),e.jsx(V,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 rounded-full"}),e.jsx(V,{className:"h-3 w-16"})]}),e.jsx(V,{className:"h-4 w-10"})]})]})]}),Xs=()=>{const{t:s}=B(),t=Ye(),r=K(),[d,x]=i.useState(()=>localStorage.getItem("community-mobile-layout")==="single"?"single":"double"),[o,R]=i.useState(()=>localStorage.getItem("community-sort")==="popular"?"popular":"latest"),{data:c,isLoading:g}=vs({status:"approved",sortBy:o}),{data:y}=ws(),m=i.useCallback(async()=>{await t.invalidateQueries({queryKey:["community-posts"]})},[t]),p=()=>{const h=d==="double"?"single":"double";x(h),localStorage.setItem("community-mobile-layout",h)},f=h=>{const n=h;R(n),localStorage.setItem("community-sort",n)},v=()=>r?d==="single"?"columns-1 gap-4":"columns-2 gap-3":"columns-3 lg:columns-4 gap-4";return e.jsx(Rs,{onRefresh:m,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-5xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl mb-2 text-primary font-medium",children:s("community.title","ç¤¾åŒº")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:s("community.description","åˆ†äº«ç¾é£Ÿä½“éªŒï¼Œå‘ç°æ›´å¤šç²¾å½©")})]}),y&&e.jsx(Ds,{trigger:e.jsxs(z,{size:"sm",className:"gap-1.5",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.createPost","å‘å¸ƒ")})]})})]}),e.jsx("div",{className:"flex items-center mb-4",children:e.jsxs("div",{className:"inline-flex h-9 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>f("latest"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${o==="latest"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(ye,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.sortLatest","æœ€æ–°")})]}),e.jsxs("button",{onClick:()=>f("popular"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${o==="popular"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(Ze,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.sortPopular","çƒ­é—¨")})]}),r&&e.jsx("button",{onClick:p,className:"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-2.5 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",title:d==="double"?s("community.singleColumn","å•åˆ—å¸ƒå±€"):s("community.doubleColumn","åŒåˆ—å¸ƒå±€"),children:d==="double"?e.jsx(es,{className:"h-3.5 w-3.5"}):e.jsx(ss,{className:"h-3.5 w-3.5"})})]})}),g?e.jsx("div",{className:v(),children:Array.from({length:8}).map((h,n)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(As,{})},n))}):c&&c.length>0?e.jsx("div",{className:v(),children:c.map(h=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Ps,{post:h,showAssociations:r&&d==="single"})},h.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(pe,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:s("community.noPosts","æš‚æ— å¸–å­")}),y&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:s("community.beFirst","æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸–çš„äººå§ï¼")})]})]})})})};export{Xs as default};
//# sourceMappingURL=Community-rKVRGP5C.js.map
