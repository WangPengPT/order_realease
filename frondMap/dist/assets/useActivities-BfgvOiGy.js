import{A as o,t as _,y as n,s as v,af as b,ai as m,a5 as d}from"./index-tBrG_sQo.js";const p=()=>o({queryKey:["activities"],queryFn:async()=>{const{data:t,error:r}=await n.from("activities").select("*").eq("status","published").order("pinned",{ascending:!1}).order("sort_order",{ascending:!0}).order("start_date",{ascending:!1});if(r)throw r;return await Promise.all((t||[]).map(async i=>{const{count:u}=await n.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{count:s}=await n.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{data:c}=await n.rpc("get_activity_creator_info",{creator_user_id:i.creator_id}),a=c;return{...i,subscriber_count:u||0,share_count:s||0,creator:{isAdmin:(a==null?void 0:a.isAdmin)??!0,restaurant:(a==null?void 0:a.restaurant)??null,avatar_url:(a==null?void 0:a.avatar_url)??null}}}))}}),q=()=>o({queryKey:["admin-activities"],queryFn:async()=>{const{data:t,error:r}=await n.from("activities").select("*").order("pinned",{ascending:!1}).order("sort_order",{ascending:!0}).order("start_date",{ascending:!1});if(r)throw r;return await Promise.all((t||[]).map(async i=>{const{count:u}=await n.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{count:s}=await n.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",i.id),{data:c}=await n.rpc("get_activity_creator_info",{creator_user_id:i.creator_id}),a=c;return{...i,subscriber_count:u||0,share_count:s||0,creator:{isAdmin:(a==null?void 0:a.isAdmin)??!0,restaurant:(a==null?void 0:a.restaurant)??null,avatar_url:(a==null?void 0:a.avatar_url)??null}}}))}}),f=t=>o({queryKey:["activity",t],queryFn:async()=>{const{data:r,error:e}=await n.from("activities").select("*").eq("id",t).single();if(e)throw e;return r},enabled:!!t}),w=t=>o({queryKey:["activityRestaurants",t],queryFn:async()=>{const{data:r,error:e}=await n.from("activity_restaurants").select("*").eq("activity_id",t);if(e)throw e;if(!r||r.length===0)return[];const i=r.map(c=>c.restaurant_id),{data:u,error:s}=await n.from("restaurants").select("id, name, name_en, name_pt, type, type_en, type_pt, address, image_url, rating, lat, lng").in("id",i);if(s)throw s;return r.map(c=>({...c,restaurants:(u==null?void 0:u.find(a=>a.id===c.restaurant_id))||{id:c.restaurant_id,name:"",name_en:null,name_pt:null,type:[],type_en:null,type_pt:null,address:"",image_url:null,rating:null,lat:null,lng:null}}))},enabled:!!t}),g=()=>{const{user:t}=_();return o({queryKey:["subscriptions",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const{data:r,error:e}=await n.from("subscriptions").select("*").eq("user_id",t.id).order("created_at",{ascending:!1});if(e)throw e;return(await Promise.all((r||[]).map(async u=>{const{data:s}=await n.from("activities").select("*").eq("id",u.activity_id).eq("status","published").maybeSingle();return{...u,activity:s}}))).filter(u=>u.activity!==null)},enabled:!!t})},A=()=>{const{user:t}=_(),{toast:r}=v(),e=b();return m({mutationFn:async i=>{if(!t)throw new Error("User not authenticated");const{data:u}=await n.from("subscriptions").select("id").eq("activity_id",i).eq("user_id",t.id).maybeSingle();if(u){const{error:s}=await n.from("subscriptions").delete().eq("id",u.id);if(s)throw s;return{action:"unsubscribed",activityId:i}}else{const{error:s}=await n.from("subscriptions").insert({activity_id:i,user_id:t.id});if(s)throw s;return{action:"subscribed",activityId:i}}},onMutate:async i=>{await e.cancelQueries({queryKey:["activities"]}),await e.cancelQueries({queryKey:["subscriptions"]});const u=e.getQueryData(["activities"]),s=e.getQueryData(["subscriptions",t==null?void 0:t.id]),a=(e.getQueryData(["subscriptions",t==null?void 0:t.id])||[]).some(l=>l.activity_id===i);return e.setQueryData(["activities"],l=>l&&l.map(y=>y.id===i?{...y,subscriber_count:(y.subscriber_count||0)+(a?-1:1)}:y)),{previousActivities:u,previousSubscriptions:s}},onSuccess:i=>{e.invalidateQueries({queryKey:["subscriptions"]}),r({title:i.action==="subscribed"?d.t("toast.subscribed"):d.t("toast.unsubscribed"),description:i.action==="subscribed"?d.t("toast.subscribedDesc"):d.t("toast.unsubscribedDesc")})},onError:(i,u,s)=>{s!=null&&s.previousActivities&&e.setQueryData(["activities"],s.previousActivities),s!=null&&s.previousSubscriptions&&e.setQueryData(["subscriptions",t==null?void 0:t.id],s.previousSubscriptions),r({title:d.t("common.error"),description:d.t("toast.subscriptionFailed"),variant:"destructive"})}})},K=t=>o({queryKey:["subscriberCount",t],queryFn:async()=>{const{count:r,error:e}=await n.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",t);if(e)throw e;return r||0},enabled:!!t}),Q=t=>o({queryKey:["shareCount",t],queryFn:async()=>{const{count:r,error:e}=await n.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",t);if(e)throw e;return r||0},enabled:!!t}),S=()=>{const t=b();return m({mutationFn:async({activityId:r,userId:e})=>{const{error:i}=await n.from("activity_shares").insert({activity_id:r,user_id:e});if(i)throw i},onSuccess:(r,e)=>{t.invalidateQueries({queryKey:["shareCount",e.activityId]}),t.invalidateQueries({queryKey:["hasShared",e.activityId]}),t.invalidateQueries({queryKey:["activities"]})}})},F=t=>o({queryKey:["activityCreator",t],queryFn:async()=>{if(!t)return null;const{data:r}=await n.rpc("get_activity_creator_info",{creator_user_id:t}),e=r;return{isAdmin:(e==null?void 0:e.isAdmin)??!0,restaurant:(e==null?void 0:e.restaurant)??null,avatar_url:(e==null?void 0:e.avatar_url)??null}},enabled:!!t});export{g as a,f as b,w as c,K as d,Q as e,S as f,F as g,A as h,q as i,p as u};
