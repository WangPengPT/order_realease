{"version":3,"file":"TranslateButton-DMYBpi1A.js","sources":["../../src/components/ImagePreviewModal.tsx","../../src/components/TranslateButton.tsx"],"sourcesContent":["import { useState, useEffect, useRef } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { X } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\ninterface ImagePreviewModalProps {\r\n  imageUrl: string;\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n}\r\n\r\nconst ImagePreviewModal = ({ imageUrl, isOpen, onClose }: ImagePreviewModalProps) => {\r\n  const [isLongImage, setIsLongImage] = useState(false);\r\n  const [imageLoaded, setImageLoaded] = useState(false);\r\n  const [scrollStart, setScrollStart] = useState<{ y: number; scrollTop: number } | null>(null);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Lock body scroll when preview is open\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      const scrollY = window.scrollY;\r\n      document.body.style.position = 'fixed';\r\n      document.body.style.top = `-${scrollY}px`;\r\n      document.body.style.left = '0';\r\n      document.body.style.right = '0';\r\n      document.body.style.overflow = 'hidden';\r\n      \r\n      return () => {\r\n        document.body.style.position = '';\r\n        document.body.style.top = '';\r\n        document.body.style.left = '';\r\n        document.body.style.right = '';\r\n        document.body.style.overflow = '';\r\n        window.scrollTo(0, scrollY);\r\n      };\r\n    }\r\n  }, [isOpen]);\r\n\r\n  // Reset state when image URL changes\r\n  useEffect(() => {\r\n    setIsLongImage(false);\r\n    setImageLoaded(false);\r\n  }, [imageUrl]);\r\n\r\n  const handleImageLoad = (e: React.SyntheticEvent<HTMLImageElement>) => {\r\n    const img = e.currentTarget;\r\n    const ratio = img.naturalHeight / img.naturalWidth;\r\n    setIsLongImage(ratio > 1.5);\r\n    setImageLoaded(true);\r\n  };\r\n\r\n  const handleContainerClick = (e: React.MouseEvent) => {\r\n    if (e.target === e.currentTarget) {\r\n      onClose();\r\n    }\r\n  };\r\n\r\n  const handleTouchEnd = (e: React.TouchEvent) => {\r\n    if (!scrollStart) return;\r\n    \r\n    const touch = e.changedTouches[0];\r\n    const deltaY = Math.abs(touch.clientY - scrollStart.y);\r\n    const container = containerRef.current;\r\n    const deltaScroll = container ? Math.abs(container.scrollTop - scrollStart.scrollTop) : 0;\r\n    \r\n    if (deltaY < 15 && deltaScroll < 15) {\r\n      e.preventDefault();\r\n      onClose();\r\n    }\r\n    setScrollStart(null);\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return createPortal(\r\n    <div \r\n      className=\"fixed inset-0 z-[100] bg-black\"\r\n      style={{ \r\n        left: 0,\r\n        right: 0,\r\n        top: 0,\r\n        bottom: 0,\r\n        width: '100vw',\r\n        height: '100dvh',\r\n        overflow: 'hidden',\r\n        margin: 0,\r\n        padding: 0\r\n      }}\r\n    >\r\n      {/* Close Button */}\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"icon\"\r\n        className=\"absolute top-4 right-4 z-10 text-white hover:bg-white/20\"\r\n        onClick={onClose}\r\n      >\r\n        <X className=\"h-6 w-6\" />\r\n      </Button>\r\n\r\n      {/* Image Container */}\r\n      <div \r\n        ref={containerRef}\r\n        className=\"w-full h-full overflow-x-hidden overscroll-contain\"\r\n        style={{\r\n          overflowY: isLongImage ? 'scroll' : 'hidden',\r\n          WebkitOverflowScrolling: 'touch',\r\n        }}\r\n        onClick={handleContainerClick}\r\n        onTouchStart={(e) => {\r\n          setScrollStart({ \r\n            y: e.touches[0].clientY, \r\n            scrollTop: containerRef.current?.scrollTop || 0 \r\n          });\r\n        }}\r\n        onTouchEnd={handleTouchEnd}\r\n        onMouseDown={(e) => {\r\n          setScrollStart({ \r\n            y: e.clientY, \r\n            scrollTop: containerRef.current?.scrollTop || 0 \r\n          });\r\n        }}\r\n        onMouseUp={(e) => {\r\n          if (scrollStart) {\r\n            const deltaY = Math.abs(e.clientY - scrollStart.y);\r\n            const container = containerRef.current;\r\n            const deltaScroll = container ? Math.abs(container.scrollTop - scrollStart.scrollTop) : 0;\r\n            if (deltaY < 10 && deltaScroll < 10) {\r\n              onClose();\r\n            }\r\n            setScrollStart(null);\r\n          }\r\n        }}\r\n      >\r\n        {/* Hidden image to detect dimensions */}\r\n        {!imageLoaded && (\r\n          <img \r\n            src={imageUrl} \r\n            alt=\"\" \r\n            onLoad={handleImageLoad}\r\n            style={{ position: 'absolute', opacity: 0, pointerEvents: 'none' }}\r\n          />\r\n        )}\r\n        \r\n        {/* Actual visible image */}\r\n        {imageLoaded && (\r\n          isLongImage ? (\r\n            <img\r\n              src={imageUrl}\r\n              alt=\"\"\r\n              draggable={false}\r\n              className=\"block select-none\"\r\n              style={{ \r\n                width: '100vw',\r\n                minWidth: '100vw',\r\n                minHeight: '100dvh',\r\n                height: 'auto',\r\n                margin: 0,\r\n                objectFit: 'cover',\r\n                objectPosition: 'top center'\r\n              }}\r\n            />\r\n          ) : (\r\n            <div \r\n              className=\"w-full h-full flex items-center justify-center\"\r\n              onClick={onClose}\r\n            >\r\n              <img\r\n                src={imageUrl}\r\n                alt=\"\"\r\n                draggable={false}\r\n                className=\"max-w-full max-h-full object-contain select-none\"\r\n              />\r\n            </div>\r\n          )\r\n        )}\r\n      </div>\r\n    </div>,\r\n    document.body\r\n  );\r\n};\r\n\r\nexport default ImagePreviewModal;\r\n","import { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Languages, Loader2, RotateCcw } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface TranslateButtonProps {\r\n  text: string;\r\n  className?: string;\r\n  label?: string;\r\n  onTranslation?: (translatedText: string | null) => void;\r\n}\r\n\r\n// Simple cache to store translations and avoid repeated API calls\r\nconst translationCache = new Map<string, string>();\r\n\r\nconst TranslateButton = ({ text, className, label, onTranslation }: TranslateButtonProps) => {\r\n  const { t, i18n } = useTranslation();\r\n  const [isTranslating, setIsTranslating] = useState(false);\r\n  const [translatedText, setTranslatedText] = useState<string | null>(null);\r\n  const [showTranslation, setShowTranslation] = useState(false);\r\n  const [lastTranslatedLang, setLastTranslatedLang] = useState<string | null>(null);\r\n\r\n  // Reset translation when language changes\r\n  const currentLang = i18n.language;\r\n  \r\n  // If language changed and we have a translation, reset it\r\n  if (lastTranslatedLang && lastTranslatedLang !== currentLang && showTranslation) {\r\n    setShowTranslation(false);\r\n    setTranslatedText(null);\r\n    onTranslation?.(null);\r\n  }\r\n\r\n  const handleTranslate = async () => {\r\n    // Get current language at call time, not render time\r\n    const targetLang = i18n.language;\r\n    const cacheKey = `${text.substring(0, 100)}_${targetLang}`;\r\n    \r\n    // If already showing translation for the same language, toggle back to original\r\n    if (showTranslation && lastTranslatedLang === targetLang) {\r\n      setShowTranslation(false);\r\n      onTranslation?.(null);\r\n      return;\r\n    }\r\n\r\n    // Check global cache\r\n    const cached = translationCache.get(cacheKey);\r\n    if (cached) {\r\n      setTranslatedText(cached);\r\n      setShowTranslation(true);\r\n      setLastTranslatedLang(targetLang);\r\n      onTranslation?.(cached);\r\n      return;\r\n    }\r\n\r\n    // Call translation API\r\n    setIsTranslating(true);\r\n    console.log('[TranslateButton] Calling translate-content with targetLang:', targetLang);\r\n    try {\r\n      const { data, error } = await supabase.functions.invoke('translate-content', {\r\n        body: { text, targetLang }\r\n      });\r\n      console.log('[TranslateButton] Response:', data, error);\r\n\r\n      if (error) {\r\n        console.error('Translation error:', error);\r\n        toast.error(t(\"translate.error\", \"翻译失败，请稍后重试\"));\r\n        return;\r\n      }\r\n\r\n      if (data?.translatedText) {\r\n        // Store in cache\r\n        translationCache.set(cacheKey, data.translatedText);\r\n        setTranslatedText(data.translatedText);\r\n        setShowTranslation(true);\r\n        setLastTranslatedLang(targetLang);\r\n        onTranslation?.(data.translatedText);\r\n      } else if (data?.error) {\r\n        toast.error(data.error);\r\n      }\r\n    } catch (err) {\r\n      console.error('Translation error:', err);\r\n      toast.error(t(\"translate.error\", \"翻译失败，请稍后重试\"));\r\n    } finally {\r\n      setIsTranslating(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Button\r\n      variant=\"ghost\"\r\n      size=\"sm\"\r\n      className={`gap-1.5 h-auto py-1 px-2 text-xs text-muted-foreground hover:text-foreground ${className || ''}`}\r\n      onClick={handleTranslate}\r\n      disabled={isTranslating}\r\n    >\r\n      {isTranslating ? (\r\n        <>\r\n          <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n          <span>{t(\"translate.translating\", \"翻译中...\")}</span>\r\n        </>\r\n      ) : showTranslation ? (\r\n        <>\r\n          <RotateCcw className=\"h-3 w-3\" />\r\n          <span>{t(\"translate.showOriginal\", \"显示原文\")}</span>\r\n        </>\r\n      ) : (\r\n        <>\r\n          <Languages className=\"h-3 w-3\" />\r\n          <span>{label || t(\"translate.button\", \"翻译\")}</span>\r\n        </>\r\n      )}\r\n    </Button>\r\n  );\r\n};\r\n\r\nexport default TranslateButton;\r\n"],"names":["ImagePreviewModal","imageUrl","isOpen","onClose","isLongImage","setIsLongImage","useState","imageLoaded","setImageLoaded","scrollStart","setScrollStart","containerRef","useRef","useEffect","scrollY","handleImageLoad","img","ratio","handleContainerClick","handleTouchEnd","touch","deltaY","container","deltaScroll","createPortal","jsxs","jsx","Button","X","translationCache","TranslateButton","text","className","label","onTranslation","t","i18n","useTranslation","isTranslating","setIsTranslating","translatedText","setTranslatedText","showTranslation","setShowTranslation","lastTranslatedLang","setLastTranslatedLang","currentLang","handleTranslate","targetLang","cacheKey","cached","data","error","supabase","toast","err","Fragment","Loader2","RotateCcw","Languages"],"mappings":"0JAWA,MAAMA,EAAoB,CAAC,CAAE,SAAAC,EAAU,OAAAC,EAAQ,QAAAC,KAAsC,CACnF,KAAM,CAACC,EAAaC,CAAc,EAAIC,WAAS,EAAK,EAC9C,CAACC,EAAaC,CAAc,EAAIF,WAAS,EAAK,EAC9C,CAACG,EAAaC,CAAc,EAAIJ,WAAkD,IAAI,EACtFK,EAAeC,SAAuB,IAAI,EAGhDC,EAAAA,UAAU,IAAM,CACd,GAAIX,EAAQ,CACV,MAAMY,EAAU,OAAO,QACd,gBAAA,KAAK,MAAM,SAAW,QAC/B,SAAS,KAAK,MAAM,IAAM,IAAIA,CAAO,KAC5B,SAAA,KAAK,MAAM,KAAO,IAClB,SAAA,KAAK,MAAM,MAAQ,IACnB,SAAA,KAAK,MAAM,SAAW,SAExB,IAAM,CACF,SAAA,KAAK,MAAM,SAAW,GACtB,SAAA,KAAK,MAAM,IAAM,GACjB,SAAA,KAAK,MAAM,KAAO,GAClB,SAAA,KAAK,MAAM,MAAQ,GACnB,SAAA,KAAK,MAAM,SAAW,GACxB,OAAA,SAAS,EAAGA,CAAO,CAAA,CAE9B,CAAA,EACC,CAACZ,CAAM,CAAC,EAGXW,EAAAA,UAAU,IAAM,CACdR,EAAe,EAAK,EACpBG,EAAe,EAAK,CAAA,EACnB,CAACP,CAAQ,CAAC,EAEP,MAAAc,EAAmB,GAA8C,CACrE,MAAMC,EAAM,EAAE,cACRC,EAAQD,EAAI,cAAgBA,EAAI,aACtCX,EAAeY,EAAQ,GAAG,EAC1BT,EAAe,EAAI,CAAA,EAGfU,EAAwB,GAAwB,CAChD,EAAE,SAAW,EAAE,eACTf,GACV,EAGIgB,EAAkB,GAAwB,CAC9C,GAAI,CAACV,EAAa,OAEZ,MAAAW,EAAQ,EAAE,eAAe,CAAC,EAC1BC,EAAS,KAAK,IAAID,EAAM,QAAUX,EAAY,CAAC,EAC/Ca,EAAYX,EAAa,QACzBY,EAAcD,EAAY,KAAK,IAAIA,EAAU,UAAYb,EAAY,SAAS,EAAI,EAEpFY,EAAS,IAAME,EAAc,KAC/B,EAAE,eAAe,EACTpB,KAEVO,EAAe,IAAI,CAAA,EAGjB,OAACR,EAEEsB,EAAA,aACLC,EAAA,KAAC,MAAA,CACC,UAAU,iCACV,MAAO,CACL,KAAM,EACN,MAAO,EACP,IAAK,EACL,OAAQ,EACR,MAAO,QACP,OAAQ,SACR,SAAU,SACV,OAAQ,EACR,QAAS,CACX,EAGA,SAAA,CAAAC,EAAA,IAACC,EAAA,CACC,QAAQ,QACR,KAAK,OACL,UAAU,2DACV,QAASxB,EAET,SAAAuB,EAAAA,IAACE,EAAE,CAAA,UAAU,SAAU,CAAA,CAAA,CACzB,EAGAH,EAAA,KAAC,MAAA,CACC,IAAKd,EACL,UAAU,qDACV,MAAO,CACL,UAAWP,EAAc,SAAW,SACpC,wBAAyB,OAC3B,EACA,QAASc,EACT,aAAe,GAAM,CACJR,EAAA,CACb,EAAG,EAAE,QAAQ,CAAC,EAAE,QAChB,UAAWC,EAAa,SAAS,WAAa,CAAA,CAC/C,CACH,EACA,WAAYQ,EACZ,YAAc,GAAM,CACHT,EAAA,CACb,EAAG,EAAE,QACL,UAAWC,EAAa,SAAS,WAAa,CAAA,CAC/C,CACH,EACA,UAAY,GAAM,CAChB,GAAIF,EAAa,CACf,MAAMY,EAAS,KAAK,IAAI,EAAE,QAAUZ,EAAY,CAAC,EAC3Ca,EAAYX,EAAa,QACzBY,EAAcD,EAAY,KAAK,IAAIA,EAAU,UAAYb,EAAY,SAAS,EAAI,EACpFY,EAAS,IAAME,EAAc,IACvBpB,IAEVO,EAAe,IAAI,CACrB,CACF,EAGC,SAAA,CAAA,CAACH,GACAmB,EAAA,IAAC,MAAA,CACC,IAAKzB,EACL,IAAI,GACJ,OAAQc,EACR,MAAO,CAAE,SAAU,WAAY,QAAS,EAAG,cAAe,MAAO,CAAA,CACnE,EAIDR,IACCH,EACEsB,EAAA,IAAC,MAAA,CACC,IAAKzB,EACL,IAAI,GACJ,UAAW,GACX,UAAU,oBACV,MAAO,CACL,MAAO,QACP,SAAU,QACV,UAAW,SACX,OAAQ,OACR,OAAQ,EACR,UAAW,QACX,eAAgB,YAClB,CAAA,CAAA,EAGFyB,EAAA,IAAC,MAAA,CACC,UAAU,iDACV,QAASvB,EAET,SAAAuB,EAAA,IAAC,MAAA,CACC,IAAKzB,EACL,IAAI,GACJ,UAAW,GACX,UAAU,kDAAA,CACZ,CAAA,CAAA,EACF,CAAA,CAGN,CAAA,CAAA,CACF,EACA,SAAS,IAAA,EAzGS,IA2GtB,ECpKM4B,MAAuB,IAEvBC,EAAkB,CAAC,CAAE,KAAAC,EAAM,UAAAC,EAAW,MAAAC,EAAO,cAAAC,KAA0C,CAC3F,KAAM,CAAE,EAAAC,EAAG,KAAAC,CAAK,EAAIC,EAAe,EAC7B,CAACC,EAAeC,CAAgB,EAAIjC,WAAS,EAAK,EAClD,CAACkC,EAAgBC,CAAiB,EAAInC,WAAwB,IAAI,EAClE,CAACoC,EAAiBC,CAAkB,EAAIrC,WAAS,EAAK,EACtD,CAACsC,EAAoBC,CAAqB,EAAIvC,WAAwB,IAAI,EAG1EwC,EAAcV,EAAK,SAGrBQ,GAAsBA,IAAuBE,GAAeJ,IAC9DC,EAAmB,EAAK,EACxBF,EAAkB,IAAI,EACtBP,IAAgB,IAAI,GAGtB,MAAMa,EAAkB,SAAY,CAElC,MAAMC,EAAaZ,EAAK,SAClBa,EAAW,GAAGlB,EAAK,UAAU,EAAG,GAAG,CAAC,IAAIiB,CAAU,GAGpD,GAAAN,GAAmBE,IAAuBI,EAAY,CACxDL,EAAmB,EAAK,EACxBT,IAAgB,IAAI,EACpB,MACF,CAGM,MAAAgB,EAASrB,EAAiB,IAAIoB,CAAQ,EAC5C,GAAIC,EAAQ,CACVT,EAAkBS,CAAM,EACxBP,EAAmB,EAAI,EACvBE,EAAsBG,CAAU,EAChCd,IAAgBgB,CAAM,EACtB,MACF,CAGAX,EAAiB,EAAI,EACb,QAAA,IAAI,+DAAgES,CAAU,EAClF,GAAA,CACI,KAAA,CAAE,KAAAG,EAAM,MAAAC,CAAM,EAAI,MAAMC,EAAS,UAAU,OAAO,oBAAqB,CAC3E,KAAM,CAAE,KAAAtB,EAAM,WAAAiB,CAAW,CAAA,CAC1B,EAGD,GAFQ,QAAA,IAAI,8BAA+BG,EAAMC,CAAK,EAElDA,EAAO,CACD,QAAA,MAAM,qBAAsBA,CAAK,EACzCE,EAAM,MAAMnB,EAAE,kBAAmB,YAAY,CAAC,EAC9C,MACF,CAEIgB,GAAM,gBAEStB,EAAA,IAAIoB,EAAUE,EAAK,cAAc,EAClDV,EAAkBU,EAAK,cAAc,EACrCR,EAAmB,EAAI,EACvBE,EAAsBG,CAAU,EAChCd,IAAgBiB,EAAK,cAAc,GAC1BA,GAAM,OACTG,EAAA,MAAMH,EAAK,KAAK,QAEjBI,EAAK,CACJ,QAAA,MAAM,qBAAsBA,CAAG,EACvCD,EAAM,MAAMnB,EAAE,kBAAmB,YAAY,CAAC,CAAA,QAC9C,CACAI,EAAiB,EAAK,CACxB,CAAA,EAIA,OAAAb,EAAA,IAACC,EAAA,CACC,QAAQ,QACR,KAAK,KACL,UAAW,gFAAgFK,GAAa,EAAE,GAC1G,QAASe,EACT,SAAUT,EAET,WAEGb,EAAAA,KAAA+B,EAAA,SAAA,CAAA,SAAA,CAAC9B,EAAAA,IAAA+B,EAAA,CAAQ,UAAU,sBAAuB,CAAA,EACzC/B,EAAA,IAAA,OAAA,CAAM,SAAES,EAAA,wBAAyB,QAAQ,EAAE,CAC9C,CAAA,CAAA,EACEO,EAEAjB,EAAA,KAAA+B,EAAA,SAAA,CAAA,SAAA,CAAC9B,EAAAA,IAAAgC,EAAA,CAAU,UAAU,SAAU,CAAA,EAC9BhC,EAAA,IAAA,OAAA,CAAM,SAAES,EAAA,yBAA0B,MAAM,EAAE,CAAA,CAAA,CAC7C,EAGEV,EAAAA,KAAA+B,EAAA,SAAA,CAAA,SAAA,CAAC9B,EAAAA,IAAAiC,EAAA,CAAU,UAAU,SAAU,CAAA,QAC9B,OAAM,CAAA,SAAA1B,GAASE,EAAE,mBAAoB,IAAI,EAAE,CAAA,EAC9C,CAAA,CAAA,CAIR"}