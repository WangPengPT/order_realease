import{p as z,u as ze,r as n,j as e,cT as He,cg as Ve,L as qe,b0 as te,bg as Be,bB as Ne,bA as se,bh as Ge,an as We,e3 as L,e4 as C,b7 as ye,e5 as ve,a4 as O,b8 as be,e6 as Qe,e7 as Je,bJ as Ke,aL as pe,X as ge,bj as Xe,cG as Ye,w as F,q as Ze,bO as fe}from"./vendor-react-5CWRUXey.js";import{u as es,k as ss,A as ts,h as as,i as rs,D as ns,Y as is,d as os,e as ls,f as cs,g as c,b as ae,I as ds,B as $,S as we,N as ms,ag as us,ak as xs,ah as hs,al as ps,a8 as gs,s as T,n as q}from"./index-ffVqEBGu.js";import{c as fs,d as js,e as Ns,f as ys,g as vs,h as bs}from"./useCommunityPosts-BNL3yjf2.js";import{u as K}from"./useLocalizedContent-B7sai0xn.js";import{c as ws}from"./usePoints-BVJ0Iyux.js";import{P as re,a as ne,b as ie}from"./popover-CQECQzmD.js";import{u as ks}from"./useActivities-EM8x_Ly3.js";import{u as Cs}from"./useRestaurants-BIBbTpV3.js";import{P as Rs}from"./PullToRefresh-DyT6E3MF.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-hygftDOh.js";const Ps=({post:s})=>{const{t}=z(),{user:a}=es(),h=ze(),{getLocalizedField:u}=K(),l=fs(),[w,d]=n.useState(!1),f=N=>{N.preventDefault(),N.stopPropagation(),a&&l.mutate({postId:s.id,liked:s.user_liked||!1})},v=()=>{h(`/community/${s.id}`)},x=N=>new DOMParser().parseFromString(N,"text/html").body.textContent||"",p=u(s,"content"),j=x(p),R=s.image_urls&&s.image_urls.length>0,k=!!s.video_url,i=R||k,P=s.image_urls?.length||0;return e.jsxs("div",{className:"group cursor-pointer rounded-lg overflow-hidden bg-card border border-border/50 hover:shadow-lg transition-all duration-300 hover:-translate-y-1",onClick:v,children:[i&&e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden",children:[R?w?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:t("common.imageLoadError","å›¾ç‰‡åŠ è½½å¤±è´¥")})}):e.jsx("img",{src:s.image_urls[0],alt:"",className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",onError:()=>d(!0)}):k?e.jsx("video",{src:s.video_url,className:"w-full h-full object-cover",preload:"metadata",muted:!0,playsInline:!0}):null,k&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-black/50 backdrop-blur-sm flex items-center justify-center",children:e.jsx(He,{className:"h-5 w-5 text-white fill-white ml-0.5"})})}),!k&&P>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full z-10 flex items-center gap-1",children:[e.jsx(Ve,{className:"h-3 w-3"}),e.jsx("span",{children:P})]})]}),e.jsxs("div",{className:"p-3",children:[s.restaurant&&e.jsx(qe,{to:`/restaurant/${s.restaurant.id}`,onClick:N=>N.stopPropagation(),className:"inline-block mb-2",children:e.jsxs(ss,{variant:"outline",className:"text-xs gap-1 hover:bg-accent transition-colors",children:[e.jsx(te,{className:"h-3 w-3"}),u(s.restaurant,"name")]})}),e.jsx("p",{className:`text-sm font-medium line-clamp-2 leading-relaxed ${i?"":"min-h-[60px]"}`,children:j}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(ts,{className:"h-5 w-5 flex-shrink-0",children:[e.jsx(as,{src:s.author?.avatar_url||void 0}),e.jsx(rs,{className:"text-[10px]",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:s.author?.display_name})]}),e.jsxs("button",{className:`flex items-center gap-1 text-xs ${s.user_liked?"text-red-500":"text-muted-foreground"} hover:text-red-500 transition-colors`,onClick:f,disabled:!a,children:[e.jsx(Be,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count||0})]})]})]})]})},Ss=()=>{const{t:s}=z(),{data:t}=ws(),a=t?.find(l=>l.key==="post_points")?.value||"5",h=t?.find(l=>l.key==="min_post_length")?.value||"10",u=t?.find(l=>l.key==="post_require_media")?.value==="true";return e.jsxs(ns,{children:[e.jsx(is,{asChild:!0,children:e.jsx("button",{className:"text-primary hover:underline text-sm whitespace-nowrap",children:s("community.viewPointsRules","æŸ¥çœ‹è¯¦ç»†è§„åˆ™")})}),e.jsxs(os,{className:"max-w-md",children:[e.jsx(ls,{children:e.jsxs(cs,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),s("community.pointsRulesTitle","å‘å¸–ç§¯åˆ†è§„åˆ™")]})}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:s("community.pointsRulesIntro","é€šè¿‡å‘å¸ƒç¤¾åŒºå¸–å­è·å¾—ç§¯åˆ†ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š")}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(se,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.rulePostPoints",{points:a})})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(se,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleMinLength",{length:h})})]}),u&&e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(se,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleRequireMedia","å¸–å­å¿…é¡»åŒ…å«è‡³å°‘ä¸€å¼ å›¾ç‰‡æˆ–ä¸€ä¸ªè§†é¢‘")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ge,{className:"h-4 w-4 text-blue-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleDailyLimit","æ¯å¤©ä»…å¯é€šè¿‡å‘å¸–è·å¾—ä¸€æ¬¡ç§¯åˆ†å¥–åŠ±")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(We,{className:"h-4 w-4 text-purple-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleModerationRequired","å¸–å­éœ€é€šè¿‡å®¡æ ¸åæ‰èƒ½è·å¾—ç§¯åˆ†")})]})]})]})]})]})},X=({shouldScaleBackground:s=!0,...t})=>e.jsx(L.Root,{shouldScaleBackground:s,...t});X.displayName="Drawer";const Ls=L.Portal,ke=n.forwardRef(({className:s,...t},a)=>e.jsx(L.Overlay,{ref:a,className:c("fixed inset-0 z-50 bg-black/80",s),...t}));ke.displayName=L.Overlay.displayName;const Y=n.forwardRef(({className:s,children:t,...a},h)=>e.jsxs(Ls,{children:[e.jsx(ke,{}),e.jsxs(L.Content,{ref:h,className:c("fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",s),...a,children:[e.jsx("div",{className:"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted"}),t]})]}));Y.displayName="DrawerContent";const Z=({className:s,...t})=>e.jsx("div",{className:c("grid gap-1.5 p-4 text-center sm:text-left",s),...t});Z.displayName="DrawerHeader";const oe=({className:s,...t})=>e.jsx("div",{className:c("mt-auto flex flex-col gap-2 p-4",s),...t});oe.displayName="DrawerFooter";const ee=n.forwardRef(({className:s,...t},a)=>e.jsx(L.Title,{ref:a,className:c("text-lg font-semibold leading-none tracking-tight",s),...t}));ee.displayName=L.Title.displayName;const Ds=n.forwardRef(({className:s,...t},a)=>e.jsx(L.Description,{ref:a,className:c("text-sm text-muted-foreground",s),...t}));Ds.displayName=L.Description.displayName;const le=n.forwardRef(({className:s,...t},a)=>e.jsx(C,{ref:a,className:c("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...t}));le.displayName=C.displayName;const Ce=n.forwardRef(({className:s,...t},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(ye,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(C.Input,{ref:a,className:c("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...t})]}));Ce.displayName=C.Input.displayName;const ce=n.forwardRef(({className:s,...t},a)=>e.jsx(C.List,{ref:a,className:c("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...t}));ce.displayName=C.List.displayName;const Re=n.forwardRef((s,t)=>e.jsx(C.Empty,{ref:t,className:"py-6 text-center text-sm",...s}));Re.displayName=C.Empty.displayName;const de=n.forwardRef(({className:s,...t},a)=>e.jsx(C.Group,{ref:a,className:c("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...t}));de.displayName=C.Group.displayName;const Us=n.forwardRef(({className:s,...t},a)=>e.jsx(C.Separator,{ref:a,className:c("-mx-1 h-px bg-border",s),...t}));Us.displayName=C.Separator.displayName;const G=n.forwardRef(({className:s,...t},a)=>e.jsx(C.Item,{ref:a,className:c("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",s),...t}));G.displayName=C.Item.displayName;const Es=({open:s,onOpenChange:t,value:a,onSelect:h,restaurants:u,showNoneOption:l=!0,required:w=!1})=>{const{t:d}=z(),{getLocalizedField:f}=K(),v=ae(),[x,p]=n.useState(""),[j,R]=n.useState(a),[k,i]=n.useState("85vh");n.useEffect(()=>{if(!s||!v)return;const r=window.visualViewport;if(!r){i("85vh");return}const S=()=>{const U=r.height,E=Math.min(U*.85,U-50);i(`${E}px`)};return S(),r.addEventListener("resize",S),()=>{r.removeEventListener("resize",S)}},[s,v]);const P=r=>{r&&(R(a),p("")),t(r)},N=u?.filter(r=>{if(!x)return!0;const S=f(r,"name")?.toLowerCase()||"",U=r.address?.toLowerCase()||"",E=x.toLowerCase();return S.includes(E)||U.includes(E)})||[],D=()=>{if(!a)return"";const r=u?.find(S=>S.id===a);return r?f(r,"name"):""},H=()=>{h(j),t(!1),p("")},V=r=>{h(r),t(!1),p("")},B=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>P(!0),children:[a?e.jsx("span",{className:"text-primary",children:D()}):e.jsxs("span",{className:"text-muted-foreground",children:[d("community.linkRestaurant","å…³è”é¤å…"),w&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(ve,{className:"h-4 w-4 opacity-50"})]});return v?e.jsxs(e.Fragment,{children:[B,e.jsx(X,{open:s,onOpenChange:P,children:e.jsxs(Y,{className:"flex flex-col",style:{height:k,maxHeight:k,transition:"height 0.15s ease-out, max-height 0.15s ease-out"},children:[e.jsx(Z,{className:"pb-2 shrink-0",children:e.jsx(ee,{children:d("community.selectRestaurant","é€‰æ‹©é¤å…")})}),e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ds,{placeholder:d("community.searchRestaurant","æœç´¢é¤å…..."),value:x,onChange:r=>p(r.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 min-h-0",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[l&&e.jsxs("div",{className:c("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",j===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>R(""),children:[e.jsx(O,{className:c("h-4 w-4 shrink-0",j===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:d("community.noRestaurantLink","ä¸å…³è”é¤å…")})]}),N.map(r=>e.jsxs("div",{className:c("flex items-start gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",j===r.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>R(r.id),children:[e.jsx(O,{className:c("h-4 w-4 shrink-0 mt-0.5",j===r.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:f(r,"name")}),r.address&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate flex items-center gap-1 mt-0.5",children:[e.jsx(te,{className:"h-3 w-3 shrink-0"}),r.address]})]})]},r.id)),N.length===0&&x&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:d("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")})]})}),e.jsx(oe,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx($,{variant:"outline",className:"flex-1",onClick:()=>P(!1),children:d("common.cancel","å–æ¶ˆ")}),e.jsx($,{className:"flex-1",onClick:H,children:d("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(re,{open:s,onOpenChange:P,children:[e.jsx(ne,{asChild:!0,children:B}),e.jsx(ie,{className:"w-72 p-0",align:"start",children:e.jsxs(le,{shouldFilter:!1,children:[e.jsx(Ce,{placeholder:d("community.searchRestaurant","æœç´¢é¤å…..."),value:x,onValueChange:p}),e.jsxs(ce,{children:[e.jsx(Re,{children:d("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")}),e.jsxs(de,{children:[l&&e.jsxs(G,{value:"none",onSelect:()=>V(""),children:[e.jsx(O,{className:c("mr-2 h-4 w-4",a?"opacity-0":"opacity-100")}),d("community.noRestaurantLink","ä¸å…³è”é¤å…")]}),N.map(r=>e.jsxs(G,{value:r.id,onSelect:()=>V(r.id),children:[e.jsx(O,{className:c("mr-2 h-4 w-4",a===r.id?"opacity-100":"opacity-0")}),f(r,"name")]},r.id))]})]})]})})]})},_s=({open:s,onOpenChange:t,value:a,onSelect:h,activities:u})=>{const{t:l}=z(),{getLocalizedField:w}=K(),d=ae(),[f,v]=n.useState(a),x=i=>{i&&v(a),t(i)},p=()=>{if(!a)return"";const i=u?.find(P=>P.id===a);return i?w(i,"title"):""},j=()=>{h(f),t(!1)},R=i=>{h(i),t(!1)},k=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>x(!0),children:[a?e.jsx("span",{className:"text-primary",children:p()}):e.jsx("span",{className:"text-muted-foreground",children:l("community.linkActivity","å…³è”æ´»åŠ¨")}),e.jsx(ve,{className:"h-4 w-4 opacity-50"})]});return d?e.jsxs(e.Fragment,{children:[k,e.jsx(X,{open:s,onOpenChange:x,children:e.jsxs(Y,{className:"max-h-[85vh] flex flex-col",children:[e.jsx(Z,{className:"pb-2",children:e.jsx(ee,{children:l("community.selectActivity","é€‰æ‹©æ´»åŠ¨")})}),e.jsx(we,{className:"flex-1 px-4",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:c("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",f===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>v(""),children:[e.jsx(O,{className:c("h-4 w-4 shrink-0",f===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:l("community.noActivity","ä¸å…³è”æ´»åŠ¨")})]}),u.map(i=>e.jsxs("div",{className:c("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",f===i.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>v(i.id),children:[e.jsx(O,{className:c("h-4 w-4 shrink-0",f===i.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:w(i,"title")})]})]},i.id)),u.length===0&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:l("activities.noActivities","æš‚æ— å¯ç”¨æ´»åŠ¨")})]})}),e.jsx(oe,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx($,{variant:"outline",className:"flex-1",onClick:()=>x(!1),children:l("common.cancel","å–æ¶ˆ")}),e.jsx($,{className:"flex-1",onClick:j,children:l("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(re,{open:s,onOpenChange:x,children:[e.jsx(ne,{asChild:!0,children:k}),e.jsx(ie,{className:"w-72 p-0",align:"start",children:e.jsx(le,{children:e.jsx(ce,{children:e.jsxs(de,{children:[e.jsxs(G,{value:"none",onSelect:()=>R(""),children:[e.jsx(O,{className:c("mr-2 h-4 w-4",a?"opacity-0":"opacity-100")}),l("community.noActivity","ä¸å…³è”æ´»åŠ¨")]}),u.map(i=>e.jsxs(G,{value:i.id,onSelect:()=>R(i.id),children:[e.jsx(O,{className:c("mr-2 h-4 w-4",a===i.id?"opacity-100":"opacity-0")}),w(i,"title")]},i.id))]})})})})]})},je=[{name:"smileys",emojis:["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ¤£","ğŸ˜‚","ğŸ™‚","ğŸ˜Š","ğŸ˜‡","ğŸ¥°","ğŸ˜","ğŸ¤©","ğŸ˜˜","ğŸ˜—","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ¤‘","ğŸ¤—","ğŸ¤­","ğŸ¤«","ğŸ¤”","ğŸ¤","ğŸ¤¨","ğŸ˜","ğŸ˜‘","ğŸ˜¶","ğŸ˜","ğŸ˜’","ğŸ™„","ğŸ˜¬","ğŸ¤¥","ğŸ˜Œ","ğŸ˜”","ğŸ˜ª","ğŸ¤¤","ğŸ˜´","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤®","ğŸ¥µ","ğŸ¥¶","ğŸ¥´","ğŸ˜µ","ğŸ¤¯","ğŸ¤ ","ğŸ¥³","ğŸ˜","ğŸ¤“","ğŸ§"]},{name:"gestures",emojis:["ğŸ‘","ğŸ‘","ğŸ‘Œ","ğŸ¤Œ","âœŒï¸","ğŸ¤","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","â˜ï¸","âœ‹","ğŸ¤š","ğŸ–ï¸","ğŸ––","ğŸ‘‹","ğŸ¤","ğŸ™","ğŸ’ª","ğŸ¦¾","ğŸ¦¿","ğŸ¦µ","ğŸ¦¶","ğŸ‘‚","ğŸ¦»","ğŸ‘ƒ","ğŸ§ ","ğŸ‘€","ğŸ‘ï¸","ğŸ‘…","ğŸ‘„"]},{name:"food",emojis:["ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥¬","ğŸ¥’","ğŸŒ¶ï¸","ğŸ«‘","ğŸŒ½","ğŸ¥•","ğŸ§„","ğŸ§…","ğŸ¥”","ğŸ ","ğŸ¥","ğŸ¥¯","ğŸ","ğŸ¥–","ğŸ¥¨","ğŸ§€","ğŸ¥š","ğŸ³","ğŸ§ˆ","ğŸ¥","ğŸ§‡","ğŸ¥“","ğŸ¥©","ğŸ—","ğŸ–","ğŸ¦´","ğŸŒ­","ğŸ”","ğŸŸ","ğŸ•","ğŸ«“","ğŸ¥ª","ğŸ¥™","ğŸ§†","ğŸŒ®","ğŸŒ¯","ğŸ«”","ğŸ¥—","ğŸ¥˜","ğŸ«•","ğŸ¥«","ğŸ","ğŸœ","ğŸ²","ğŸ›","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸ¦ª","ğŸ¤","ğŸ™","ğŸš","ğŸ˜","ğŸ¥","ğŸ¥ ","ğŸ¥®","ğŸ¢","ğŸ¡","ğŸ§","ğŸ¨","ğŸ¦","ğŸ¥§","ğŸ§","ğŸ°","ğŸ‚","ğŸ®","ğŸ­","ğŸ¬","ğŸ«","ğŸ¿","ğŸ©","ğŸª"]},{name:"hearts",emojis:["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ¤","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’","ğŸ’“","ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’","ğŸ’Ÿ","â™¥ï¸"]},{name:"objects",emojis:["â­","ğŸŒŸ","âœ¨","ğŸ’«","ğŸ”¥","ğŸ’¯","ğŸ‰","ğŸŠ","ğŸˆ","ğŸ","ğŸ†","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","âš½","ğŸ€","ğŸˆ","âš¾","ğŸ¾","ğŸ","ğŸ±","ğŸ“","ğŸ®","ğŸ²","ğŸ§©","ğŸ­","ğŸ¨","ğŸ¬","ğŸ¤","ğŸ§","ğŸµ","ğŸ¶","ğŸ¹","ğŸ¸","ğŸº","ğŸ»","ğŸ“·","ğŸ“¸","ğŸ“¹","ğŸ¥","ğŸ“±","ğŸ’»","âŒ¨ï¸","ğŸ–¥ï¸","ğŸ“º","ğŸ“»","â°","âŒš","ğŸ’¡","ğŸ”¦","ğŸ“š","ğŸ“–","âœï¸","ğŸ“","ğŸ’°","ğŸ’µ","ğŸ’´","ğŸ’¶","ğŸ’·","ğŸ’³","ğŸ›’","ğŸ€","ğŸ—ï¸"]},{name:"nature",emojis:["ğŸŒ¸","ğŸ’®","ğŸµï¸","ğŸŒ¹","ğŸ¥€","ğŸŒº","ğŸŒ»","ğŸŒ¼","ğŸŒ·","ğŸŒ±","ğŸª´","ğŸŒ²","ğŸŒ³","ğŸŒ´","ğŸŒµ","ğŸŒ¾","ğŸŒ¿","â˜˜ï¸","ğŸ€","ğŸ","ğŸ‚","ğŸƒ","ğŸŒ","ğŸŒ","ğŸŒ","ğŸŒ™","â­","â˜€ï¸","ğŸŒ¤ï¸","â›…","ğŸŒ¥ï¸","â˜ï¸","ğŸŒ¦ï¸","ğŸŒ§ï¸","â›ˆï¸","ğŸŒ©ï¸","ğŸŒ¨ï¸","â„ï¸","â˜ƒï¸","â›„","ğŸŒ¬ï¸","ğŸ’¨","ğŸŒŠ","ğŸ’§","ğŸ’¦","â˜”","ğŸŒˆ"]}],Is=({onSelect:s})=>{const{t}=z(),a=ae(),[h,u]=n.useState(!1),[l,w]=n.useState(0),d=p=>{s(p),a||u(!1)},f={smileys:t("emoji.smileys","è¡¨æƒ…"),gestures:t("emoji.gestures","æ‰‹åŠ¿"),food:t("emoji.food","ç¾é£Ÿ"),hearts:t("emoji.hearts","çˆ±å¿ƒ"),objects:t("emoji.objects","ç‰©å“"),nature:t("emoji.nature","è‡ªç„¶")},v=e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 border-b",children:je.map((p,j)=>e.jsx("button",{type:"button",onClick:()=>w(j),className:`px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors ${l===j?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-muted-foreground"}`,children:f[p.name]},p.name))}),e.jsx("div",{className:"grid grid-cols-8 gap-1",children:je[l].emojis.map((p,j)=>e.jsx("button",{type:"button",onClick:()=>d(p),className:"w-9 h-9 flex items-center justify-center text-xl hover:bg-muted rounded-md transition-colors",children:p},j))})]}),x=e.jsxs("button",{type:"button",onClick:()=>u(!0),className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(Qe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.emoji","è¡¨æƒ…")})]});return a?e.jsxs(e.Fragment,{children:[x,e.jsx(X,{open:h,onOpenChange:u,children:e.jsxs(Y,{className:"h-[50vh]",children:[e.jsx(Z,{className:"pb-2",children:e.jsx(ee,{children:t("emoji.title","é€‰æ‹©è¡¨æƒ…")})}),e.jsx(we,{className:"flex-1 px-4 pb-4",children:v})]})})]}):e.jsxs(re,{open:h,onOpenChange:u,children:[e.jsx(ne,{asChild:!0,children:x}),e.jsx(ie,{className:"w-80 p-3",align:"start",side:"top",children:v})]})},As=({trigger:s})=>{const{t}=z(),{getLocalizedField:a}=K(),h=js(),{data:u}=ks(),{data:l}=Cs(),{role:w,isMerchant:d,isAdmin:f,isSupervisor:v}=ms(),{data:x}=Ns(),{data:p,isLoading:j}=ys(),[R,k]=n.useState(!1),[i,P]=n.useState(""),[N,D]=n.useState([]),[H,V]=n.useState(null),[B,r]=n.useState(""),[S,U]=n.useState(""),[E,W]=n.useState(!1),[Pe,me]=n.useState(!1),[Se,ue]=n.useState(!1),Q=n.useRef(null),J=n.useRef(null),xe=!d&&!v&&!f;n.useEffect(()=>{d&&x&&R&&U(x.id)},[d,x,R]);const he=()=>{P(""),D([]),V(null),r(""),U(""),me(!1),ue(!1)},Le=m=>{k(m),m||he()},De=u?.filter(m=>m.status==="published")||[],Ue=async m=>{const g=m.target.files;if(!(!g||g.length===0)){if(N.length+g.length>9){F.error(t("community.maxImages","æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡"));return}W(!0);try{const{data:{user:b}}=await T.auth.getUser();if(!b)throw new Error("Not authenticated");const o=[];for(const y of Array.from(g)){const M=y.name.split(".").pop(),_=`${b.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${M}`,{error:I}=await T.storage.from("community-posts").upload(_,y);if(I)throw I;const{data:{publicUrl:A}}=T.storage.from("community-posts").getPublicUrl(_);o.push(A)}D(y=>[...y,...o])}catch(b){console.error("Upload error:",b),F.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{W(!1),Q.current&&(Q.current.value="")}}},Ee=m=>new Promise((g,b)=>{const o=document.createElement("video"),y=document.createElement("canvas"),M=y.getContext("2d");o.preload="auto",o.muted=!0,o.playsInline=!0;let _=!1;const I=()=>{_||o.videoWidth===0||o.videoHeight===0||(y.width=o.videoWidth,y.height=o.videoHeight,M&&(M.drawImage(o,0,0,y.width,y.height),y.toBlob(A=>{A&&A.size>0?(_=!0,o.pause(),URL.revokeObjectURL(o.src),g(A)):b(new Error("Failed to create blob"))},"image/jpeg",.85)))};o.onloadedmetadata=()=>{y.width=o.videoWidth,y.height=o.videoHeight,o.currentTime=.1},o.onseeked=()=>{setTimeout(I,100)},o.onerror=()=>{URL.revokeObjectURL(o.src),b(new Error("Failed to load video"))},setTimeout(()=>{_||(URL.revokeObjectURL(o.src),b(new Error("Timeout")))},1e4),o.src=URL.createObjectURL(m),o.load()}),_e=async m=>{const g=m.target.files?.[0];if(g){if(g.size>100*1024*1024){F.error(t("community.videoTooLarge","è§†é¢‘ä¸èƒ½è¶…è¿‡100MB"));return}W(!0);try{const{data:{user:b}}=await T.auth.getUser();if(!b)throw new Error("Not authenticated");const o=g.name.split(".").pop(),y=`${b.id}/${Date.now()}.${o}`,{error:M}=await T.storage.from("community-posts").upload(y,g);if(M)throw M;const{data:{publicUrl:_}}=T.storage.from("community-posts").getPublicUrl(y);V(_);try{F.info(t("community.extractingCover","æ­£åœ¨æå–è§†é¢‘å°é¢..."));const I=await Ee(g),A=`${b.id}/${Date.now()}-cover.jpg`,{error:Oe}=await T.storage.from("community-posts").upload(A,I);if(!Oe){const{data:{publicUrl:Me}}=T.storage.from("community-posts").getPublicUrl(A);D($e=>[Me,...$e]),F.success(t("community.coverExtracted","å°é¢å·²è‡ªåŠ¨ç”Ÿæˆ"))}}catch(I){console.warn("Cover extraction failed:",I)}}catch(b){console.error("Upload error:",b),F.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{W(!1),J.current&&(J.current.value="")}}},Ie=m=>{D(g=>g.filter((b,o)=>o!==m))},Ae=()=>{V(null),D(m=>m.length>0&&m[0].includes("-cover.jpg")?m.slice(1):m)},Fe=async()=>{if(!i.trim()){F.error(t("community.contentRequired","è¯·è¾“å…¥å†…å®¹"));return}if(xe&&!S){F.error(t("community.restaurantRequired","è¯·é€‰æ‹©é¤å…"));return}await h.mutateAsync({content:i,image_urls:N,video_url:H||void 0,activity_id:B||void 0,restaurant_id:S||void 0}),he(),k(!1)},Te=()=>x?a(x,"name"):t("community.noRestaurant","æœªå…³è”é¤å…");return e.jsxs(us,{open:R,onOpenChange:Le,children:[e.jsx(xs,{asChild:!0,children:s||e.jsx($,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs(hs,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(Je,{children:e.jsx(ps,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>k(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(Ke,{className:"h-5 w-5"})}),e.jsxs($,{size:"sm",onClick:Fe,disabled:h.isPending||!i.trim(),className:"rounded-full px-6",children:[h.isPending&&e.jsx(pe,{className:"h-4 w-4 mr-2 animate-spin"}),t("community.publish","å‘å¸ƒ")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[!j&&!p&&e.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2 bg-primary/10 dark:bg-primary/20 border border-primary/30 dark:border-primary/40 rounded-md text-sm text-primary dark:text-primary",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:t("community.dailyPointsHint","æ¯æ—¥å‘å¸ƒé¦–ä¸ªå¸–å­å¯è·å¾—5ç§¯åˆ†ï¼")})]}),e.jsx(Ss,{})]}),e.jsx(gs,{value:i,onChange:m=>P(m.target.value),placeholder:t("community.contentPlaceholder","åˆ†äº«ä½ çš„æƒ³æ³•..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base"}),N.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:N.map((m,g)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden",children:[e.jsx("img",{src:m,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>Ie(g),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(ge,{className:"h-3 w-3"})})]},g))}),H&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:H,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:Ae,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(ge,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-3 bg-background shrink-0 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"h-5 w-5 text-muted-foreground shrink-0"}),d?e.jsx("span",{className:"text-sm text-muted-foreground",children:Te()}):e.jsx(Es,{open:Pe,onOpenChange:me,value:S,onSelect:U,restaurants:l||[],showNoneOption:v||f,required:xe})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(be,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(_s,{open:Se,onOpenChange:ue,value:B,onSelect:r,activities:De})]})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 py-3 bg-background shrink-0 safe-area-inset-bottom",children:[e.jsx("input",{ref:Q,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:Ue}),e.jsx("input",{ref:J,type:"file",accept:"video/*",className:"hidden",onChange:_e}),e.jsxs("button",{type:"button",onClick:()=>Q.current?.click(),disabled:E||N.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Xe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.photo","ç…§ç‰‡")})]}),e.jsxs("button",{type:"button",onClick:()=>J.current?.click(),disabled:E||!!H,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Ye,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.video","è§†é¢‘")})]}),e.jsx(Is,{onSelect:m=>P(g=>g+m)}),E&&e.jsx(pe,{className:"h-5 w-5 animate-spin ml-auto"})]})]})]})},Fs=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(q,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"h-4 w-full"}),e.jsx(q,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5 rounded-full"}),e.jsx(q,{className:"h-3 w-16"})]}),e.jsx(q,{className:"h-4 w-10"})]})]})]}),Ks=()=>{const{t:s}=z(),t=Ze(),{data:a,isLoading:h}=vs({status:"approved"}),{data:u}=bs(),l=n.useCallback(async()=>{await t.invalidateQueries({queryKey:["community-posts"]})},[t]);return e.jsx(Rs,{onRefresh:l,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-4xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl mb-2 text-primary font-medium",children:s("community.title","ç¤¾åŒº")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:s("community.description","åˆ†äº«ç¾é£Ÿä½“éªŒï¼Œå‘ç°æ›´å¤šç²¾å½©")})]}),u&&e.jsx(As,{trigger:e.jsxs($,{size:"sm",className:"gap-1.5",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.createPost","å‘å¸ƒ")})]})})]}),h?e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:Array.from({length:6}).map((w,d)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Fs,{})},d))}):a&&a.length>0?e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:a.map(w=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Ps,{post:w})},w.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(fe,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:s("community.noPosts","æš‚æ— å¸–å­")}),u&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:s("community.beFirst","æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸–çš„äººå§ï¼")})]})]})})})};export{Ks as default};
//# sourceMappingURL=Community-DHjRqcyo.js.map
