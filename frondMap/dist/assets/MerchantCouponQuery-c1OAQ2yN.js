import{p as ye,r as o,ex as ae,j as e,bz as Z,bV as we,q as ve,aZ as je,ey as _e,aM as G,c8 as J,bL as Y,am as Ce,be as Ne,an as oe}from"./vendor-react-87iFmKFJ.js";import{l as ke}from"./useCoupons-Bl2su6F6.js";import{A as ie,q as ce,r as le,t as de,v as ue,w as me,x as pe,y as he,u as be,z as Se,C as ee,m as xe,E as ge,n as se,I as Qe,h as F,B as U,s as k}from"./index-BrOhGy48.js";import{D as K}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CQWbleDe.js";const qe=({open:f,onOpenChange:r,onScan:M})=>{const{t:n}=ye(),[w,b]=o.useState(null),[I,S]=o.useState(!0),[L,m]=o.useState("checking"),[Q,q]=o.useState(!1),[A,t]=o.useState(!1),l=o.useRef(null),T=o.useRef(`qr-scanner-${Date.now()}`),j=o.useRef(null),E=o.useRef([]),_=o.useRef(0),x=o.useCallback(async()=>{if(l.current){try{l.current.getState()===2&&await l.current.stop()}catch{}l.current=null}j.current&&document.body.contains(j.current)&&(document.body.removeChild(j.current),j.current=null)},[]),p=o.useCallback(async()=>{await x(),b(null),S(!0),q(!1),t(!1),r(!1)},[x,r]),R=o.useCallback(async()=>{try{return navigator.permissions&&navigator.permissions.query?(await navigator.permissions.query({name:"camera"})).state:"prompt"}catch{return"prompt"}},[]),H=o.useCallback(async()=>{try{return(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach(a=>a.stop()),m("granted"),!0}catch(s){return console.error("Camera permission error:",s),s.name==="NotAllowedError"||s.name==="PermissionDeniedError"?(m("denied"),t(!0)):m("denied"),!1}},[]),V=o.useCallback(async()=>{q(!1),await H()&&m("granted")},[H]),D=o.useCallback(async(s,a)=>{const i=document.createElement("div");i.style.cssText=`
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    `,document.body.appendChild(i),j.current=i;const d=document.createElement("div");d.style.cssText=`
      background: hsl(var(--background));
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      overflow: hidden;
    `,i.appendChild(d);const g=document.createElement("div");g.style.cssText=`
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    `,g.innerHTML=`
      <h3 style="font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: hsl(var(--foreground));">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        ${n("qrScanner.title")}
      </h3>
    `;const C=document.createElement("div");C.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
    `;const y=document.createElement("button");y.id="switch-camera-btn",y.style.cssText=`
      background: hsl(var(--primary));
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      color: hsl(var(--primary-foreground));
      display: none;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    `,y.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><circle cx="12" cy="12" r="3"/><path d="m18 22-3-3 3-3"/><path d="m6 2 3 3-3 3"/></svg>',y.title=n("qrScanner.switchCamera"),C.appendChild(y);const N=document.createElement("button");N.style.cssText=`
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: hsl(var(--muted-foreground));
    `,N.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',N.onclick=()=>p(),C.appendChild(N),g.appendChild(C),d.appendChild(g);const B=document.createElement("div");B.id=s;const z=window.innerWidth<400?Math.min(window.innerWidth-80,280):300;B.style.cssText=`
      width: ${z}px;
      height: ${z}px;
      border-radius: 8px;
      overflow: hidden;
      background: hsl(var(--muted));
      position: relative;
      margin: 0 auto;
    `,d.appendChild(B);const O=document.createElement("p");O.style.cssText=`
      text-align: center;
      color: hsl(var(--muted-foreground));
      font-size: 14px;
      margin-top: 16px;
    `,O.textContent=n("qrScanner.hint"),d.appendChild(O);const v=document.createElement("div");v.id="qr-loading",v.style.cssText=`
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: hsl(var(--muted));
    `,v.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="hsl(var(--primary))" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
    `,B.appendChild(v);const te=document.createElement("style");te.textContent=`
      @keyframes spin { to { transform: rotate(360deg); } }
      .animate-spin { animation: spin 1s linear infinite; }
      #${s} video {
        width: ${z}px !important;
        height: ${z}px !important;
        object-fit: cover !important;
      }
    `,d.appendChild(te);const re=async c=>{if(a.value){v.style.display="flex";try{const u=new ae(s);l.current=u;const $=(h,P)=>{const W=Math.min(h,P),X=Math.floor(W*.7);return console.log("QR Scanner qrbox calculated:",{viewfinderWidth:h,viewfinderHeight:P,qrboxSize:X}),{width:X,height:X}};console.log("Starting QR scanner with camera:",c),await u.start(c,{fps:15,qrbox:$,aspectRatio:1},async(h,P)=>{if(console.log("QR Code detected:",h,P),a.value&&l.current){try{await l.current.stop()}catch(W){console.log("Error stopping scanner:",W)}l.current=null,await x(),M(h),r(!1)}},h=>{}),console.log("QR Scanner started successfully"),a.value&&(v.style.display="none")}catch(u){console.error("QR Scanner start error:",u),a.value&&(v.innerHTML=`<p style="color: hsl(var(--destructive)); text-align: center; padding: 20px;">${n("qrScanner.cameraError")}</p>`)}}},fe=async()=>{if(E.current.length<2)return;if(l.current){try{l.current.getState()===2&&await l.current.stop()}catch{}l.current=null}_.current=(_.current+1)%E.current.length;const c=E.current[_.current];await re(c.id)};y.onclick=fe;try{(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach(u=>u.stop())}catch(c){console.error("Camera permission denied:",c),a.value&&(v.innerHTML=`<p style="color: hsl(var(--destructive)); text-align: center; padding: 20px;">${n("qrScanner.permissionDenied")}</p>`);return}if(!a.value)return;try{const c=await ae.getCameras();E.current=c,c.length>=2&&(y.style.display="flex");let u=0;const $=c.findIndex(h=>h.label.toLowerCase().includes("back")||h.label.toLowerCase().includes("rear")||h.label.toLowerCase().includes("environment")||h.label.toLowerCase().includes("后"));$!==-1&&(u=$),_.current=u,await re(c[u].id)}catch(c){console.error("QR Scanner error:",c),a.value&&(v.innerHTML=`<p style="color: hsl(var(--destructive)); text-align: center; padding: 20px;">${n("qrScanner.cameraError")}</p>`)}i.onclick=c=>{c.target===i&&p()};const ne=c=>{c.key==="Escape"&&p()};return document.addEventListener("keydown",ne),()=>{document.removeEventListener("keydown",ne)}},[n,p,x,M,r]);return o.useEffect(()=>{if(!f){x(),m("checking");return}const s={value:!0},a=T.current;return(async()=>{const d=await R();if(s.value){if(m(d),d==="denied"){t(!0);return}if(d==="prompt"){q(!0);return}D(a,s)}})(),()=>{s.value=!1,x()}},[f,x,R,D]),o.useEffect(()=>{if(f&&L==="granted"&&!j.current){const s={value:!0},a=T.current;return D(a,s),()=>{s.value=!1}}},[L,f,D]),e.jsxs(e.Fragment,{children:[e.jsx(ie,{open:Q,onOpenChange:q,children:e.jsxs(ce,{children:[e.jsxs(le,{children:[e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5"}),n("qrScanner.requestPermission")]}),e.jsx(ue,{children:n("qrScanner.requestPermissionMessage")})]}),e.jsxs(me,{children:[e.jsx(pe,{onClick:p,children:n("common.cancel")}),e.jsxs(he,{onClick:V,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),n("qrScanner.allowCamera")]})]})]})}),e.jsx(ie,{open:A,onOpenChange:t,children:e.jsxs(ce,{children:[e.jsxs(le,{children:[e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5 text-destructive"}),n("qrScanner.requestPermission")]}),e.jsx(ue,{children:n("qrScanner.permissionBlockedMessage")})]}),e.jsxs(me,{children:[e.jsx(pe,{onClick:p,children:n("common.cancel")}),e.jsxs(he,{onClick:p,children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),n("qrScanner.openSettings")]})]})]})})]})},He=()=>{const{user:f}=be(),{t:r,i18n:M}=ye(),{toast:n}=Se(),w=ve(),[b,I]=o.useState(""),[S,L]=o.useState(""),[m,Q]=o.useState(null),[q,A]=o.useState(!1),{data:t,isLoading:l}=ke(S),T=()=>{b.trim()&&L(b.trim())},j=s=>{I(s),L(s)},E=()=>{if(!t)return"";const s=M.language;return s==="zh"?t.coupon_templates.title_zh:s==="pt"?t.coupon_templates.title_pt:t.coupon_templates.title_en},_=()=>{if(!t)return"";const s=M.language;return s==="zh"?t.coupon_templates.description_zh:s==="pt"?t.coupon_templates.description_pt:t.coupon_templates.description_en},x=t?.coupon_templates.valid_until&&new Date(t.coupon_templates.valid_until)<=new Date,p=t&&t.used_count>=t.usage_limit,R=t?.is_active&&!x&&!p,H=async(s,a)=>{if(!f){n({title:r("common.error"),description:r("auth.loginRequired"),variant:"destructive"});return}Q(s);try{const{data:i,error:d}=await k.from("coupon_codes").select("used_count, usage_limit").eq("id",a).single();if(d)throw console.error("Failed to fetch coupon code:",d),new Error(r("common.unknownError"));if(i&&i.used_count>=i.usage_limit)throw new Error(r("couponQuery.usageLimitReached"));const g=new Date().toISOString(),{error:C}=await k.from("user_coupons").update({used_at:g}).eq("id",s).is("used_at",null);if(C)throw console.error("Failed to update user_coupon:",C),new Error(r("couponQuery.alreadyUsed"));const{error:y}=await k.from("coupon_codes").update({used_count:i.used_count+1}).eq("id",a);y&&console.error("Failed to update coupon code used_count:",y);const{error:N}=await k.from("coupon_usage_history").insert({user_coupon_id:s,coupon_code_id:a,used_by_user_id:f.id,used_at:g});N&&console.error("Failed to record usage history:",N),n({title:r("common.success"),description:r("couponQuery.couponUsedSuccess")}),await w.invalidateQueries({queryKey:["queryCouponByCode",S]}),w.invalidateQueries({queryKey:["userCoupons"]}),w.invalidateQueries({queryKey:["couponCodeUsers"]}),w.invalidateQueries({queryKey:["couponUsageHistory"]})}catch(i){console.error("handleUseCoupon error:",i),n({title:r("common.error"),description:i.message||r("common.unknownError"),variant:"destructive"})}finally{Q(null)}},V=async()=>{if(!t||!f){n({title:r("common.error"),description:r("auth.loginRequired"),variant:"destructive"});return}Q("direct");try{const s=new Date().toISOString(),{data:a,error:i}=await k.from("coupon_codes").select("used_count, usage_limit").eq("id",t.id).single();if(i)throw i;if(a&&a.used_count>=a.usage_limit)throw new Error(r("couponQuery.usageLimitReached"));const{error:d}=await k.from("coupon_codes").update({used_count:(a?.used_count||0)+1}).eq("id",t.id);if(d)throw d;const{error:g}=await k.from("coupon_usage_history").insert({coupon_code_id:t.id,used_by_user_id:f.id,used_at:s});g&&console.error("Failed to record usage history:",g),n({title:r("common.success"),description:r("couponQuery.couponUsedSuccess")}),await w.invalidateQueries({queryKey:["queryCouponByCode",S]}),w.invalidateQueries({queryKey:["userCoupons"]}),w.invalidateQueries({queryKey:["couponCodeUsers"]}),w.invalidateQueries({queryKey:["couponUsageHistory"]})}catch(s){console.error("handleDirectUseCoupon error:",s),n({title:r("common.error"),description:s.message||r("common.unknownError"),variant:"destructive"})}finally{Q(null)}},D=t&&R&&(!t.user_coupons||t.user_coupons.length===0)&&t.used_count<t.usage_limit;return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:r("couponQuery.title")}),e.jsx("p",{className:"text-muted-foreground",children:r("couponQuery.description")})]}),e.jsxs(ee,{className:"mb-6",children:[e.jsx(xe,{children:e.jsx(ge,{children:r("couponQuery.searchTitle")})}),e.jsx(se,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 sm:gap-2",children:[e.jsx(Qe,{className:"sm:flex-1",placeholder:r("couponQuery.searchPlaceholder"),value:b,onChange:s=>I(s.target.value),onKeyDown:s=>s.key==="Enter"&&T()}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(F,{className:"flex-1 sm:flex-none",onClick:T,disabled:l||!b.trim(),children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),r("couponQuery.search")]}),e.jsxs(F,{className:"flex-1 sm:flex-none",variant:"outline",onClick:()=>A(!0),children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),r("couponQuery.scan")]})]})]})})]}),l&&e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx(G,{className:"w-8 h-8 animate-spin text-primary"})}),!l&&S&&!t&&e.jsx(ee,{children:e.jsxs(se,{className:"py-12 text-center",children:[e.jsx(J,{className:"w-12 h-12 text-destructive mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:r("couponQuery.notFound")})]})}),!l&&t&&e.jsxs(ee,{children:[e.jsx(xe,{className:"pb-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3",children:[e.jsx(ge,{className:"text-xl sm:text-2xl",children:E()}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.user_coupons?.some(s=>!s.used_at)&&e.jsx(U,{className:"bg-green-500 text-white text-xs",children:r("couponQuery.unused")}),p?e.jsxs(e.Fragment,{children:[e.jsxs(U,{variant:"secondary",className:"text-xs",children:[e.jsx(Y,{className:"w-3 h-3 mr-1"}),r("couponQuery.used")]}),e.jsxs(U,{variant:"secondary",className:"text-xs",children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),r("couponQuery.usageLimitReached")]})]}):R?e.jsxs(U,{className:"bg-green-500 text-xs",children:[e.jsx(Y,{className:"w-3 h-3 mr-1"}),r("couponQuery.valid")]}):e.jsxs(U,{variant:"destructive",className:"text-xs",children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),r("couponQuery.invalid")]})]})]})}),e.jsxs(se,{className:"space-y-4 sm:space-y-6",children:[_()&&e.jsx("p",{className:"text-muted-foreground text-sm sm:text-base",children:_()}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:r("couponQuery.code")}),e.jsx("p",{className:"font-mono font-bold text-lg",children:t.code})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:r("couponQuery.discount")}),e.jsx("p",{className:"font-bold text-lg",children:t.coupon_templates.discount_type==="percentage"?`${t.coupon_templates.discount_value}%`:`€${t.coupon_templates.discount_value}`})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:r("couponQuery.usageCount")}),e.jsxs("p",{className:"font-medium",children:[t.used_count," / ",t.usage_limit]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:r("couponQuery.validity")}),e.jsxs("p",{className:"font-medium",children:[K(new Date(t.coupon_templates.valid_from),"yyyy-MM-dd"),t.coupon_templates.valid_until?` - ${K(new Date(t.coupon_templates.valid_until),"yyyy-MM-dd")}`:` - ${r("couponQuery.noExpiry")}`]})]}),t.coupon_templates.min_order_amount&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:r("couponQuery.minOrder")}),e.jsxs("p",{className:"font-medium",children:["€",t.coupon_templates.min_order_amount]})]}),t.coupon_templates.max_discount_amount&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:r("couponQuery.maxDiscount")}),e.jsxs("p",{className:"font-medium",children:["€",t.coupon_templates.max_discount_amount]})]})]}),t.user_coupons&&t.user_coupons.length>0&&e.jsx("div",{className:"pt-4 border-t space-y-3",children:t.user_coupons.map(s=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-start sm:items-center gap-3",children:[e.jsx(Ce,{className:"w-4 h-4 text-muted-foreground shrink-0 mt-0.5 sm:mt-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-sm",children:s.profiles?.display_name||r("couponQuery.unknownUser")}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:flex-wrap gap-1 sm:gap-3 text-xs text-muted-foreground mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ne,{className:"w-3 h-3 shrink-0"}),r("couponQuery.claimedAt"),": ",K(new Date(s.claimed_at),"yyyy-MM-dd HH:mm")]}),s.used_at&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Y,{className:"w-3 h-3 shrink-0"}),r("couponQuery.usedAt"),": ",K(new Date(s.used_at),"yyyy-MM-dd HH:mm")]})]})]})]}),!s.used_at&&!p&&t.is_active&&!x&&e.jsxs(F,{size:"sm",className:"w-full sm:w-auto shrink-0",onClick:()=>H(s.id,t.id),disabled:m===s.id,children:[m===s.id?e.jsx(G,{className:"w-4 h-4 animate-spin mr-1"}):e.jsx(oe,{className:"w-4 h-4 mr-1"}),r("couponQuery.useCoupon")]})]},s.id))}),D&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(F,{onClick:V,disabled:m==="direct",className:"w-full sm:w-auto",children:[m==="direct"?e.jsx(G,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx(oe,{className:"w-4 h-4 mr-2"}),r("couponQuery.useCoupon")]})})]})]}),e.jsx(qe,{open:q,onOpenChange:A,onScan:j})]})};export{He as default};
//# sourceMappingURL=MerchantCouponQuery-c1OAQ2yN.js.map
