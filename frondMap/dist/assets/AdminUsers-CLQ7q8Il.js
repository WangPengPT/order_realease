import{j as e}from"./vendor-ui-DAmPMpEA.js";import{r as d}from"./vendor-react-iAJ0IrSD.js";import{c as ms,n as pe,x as Ee,D as je,a3 as _e,B as p,a as fe,b as ge,d as Ne,$ as ve,a0 as H,I as K,a6 as ae,a7 as re,a8 as te,a9 as ne,aa as I,a2 as hs,L as J,s as N,o as xs,h as Te,S as We,r as Q,M as us,U as ps,aq as js,ar as Qe,as as Xe,at as $e,an as M,Y as Fe,Z as ze,_ as Ie,J as Ue,K as qe,N as ce,O as de,Q as oe,R as me,T as he,V as xe,ag as ye,C as X,k as $,X as Ve,v as fs}from"./index-Do1W_89N.js";import{C as ue}from"./checkbox-Do5gfcxP.js";import{S as He}from"./separator-BNFZYgFe.js";import{g as gs,h as Ns,i as vs,j as ws,k as ys,l as bs,m as _s}from"./useAdmin-Cqjt-KAT.js";import{u as Cs}from"./useInfiniteScroll-ZuOE9FjP.js";import{u as Ce,a as W,b as be}from"./vendor-query-BlSVl3IQ.js";import{u as G}from"./vendor-i18n-DxKeo2S1.js";import{U as Le}from"./user-plus-CkMdO6H9.js";import{u as Ss}from"./useLocalizedContent-tJ7i_ycU.js";import{S as Je}from"./search-DsePuv7P.js";import{U as Z}from"./users-BFOmDQIZ.js";import{B as le}from"./briefcase-DC-TxXC6.js";import{S as Ye}from"./square-pen-jEvVvS5O.js";import{U as ks}from"./upload-B1PGtm6Q.js";import{T as Ze}from"./triangle-alert-DbNBpwMv.js";import{U as Ds}from"./UserProfileDialog-DmAvmkxe.js";import{e as Rs}from"./exportUtils-YWmY6fTR.js";import{F as Us}from"./filter-CBzs1yBA.js";import{A as qs}from"./arrow-up-down-DnMTFOix.js";import{A as Ls,a as As}from"./arrow-up-v6F9-AUF.js";import{D as Es}from"./download-DPWfpS6b.js";import{E as Ts}from"./eye-BYP9cNA5.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-KNAP0qdW.js";import"./arrow-left-Bzk4r06Q.js";import"./clock-C2dMhwrG.js";import"./heart-Dr4rCDn9.js";import"./star-DGsfeJZk.js";import"./external-link-CmznQ2n3.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=ms("UserCog",[["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m21.7 16.4-.9-.3",key:"12j9ji"}],["path",{d:"m15.2 13.9-.9-.3",key:"1fdjdi"}],["path",{d:"m16.6 18.7.3-.9",key:"heedtr"}],["path",{d:"m19.1 12.2.3-.9",key:"1af3ki"}],["path",{d:"m19.6 18.7-.4-1",key:"1x9vze"}],["path",{d:"m16.8 12.3-.4-1",key:"vqeiwj"}],["path",{d:"m14.3 16.6 1-.4",key:"1qlj63"}],["path",{d:"m20.7 13.8 1-.4",key:"1v5t8k"}]]),Fs=({trigger:a})=>{const{t:o}=G(),{toast:j}=pe(),C=Ce(),{isSupervisor:m}=Ee(),[i,S]=d.useState(!1),[l,E]=d.useState(!1),[c,v]=d.useState({email:"",password:"",displayName:"",phone:"",role:"merchant"}),u=async h=>{h.preventDefault(),E(!0);try{const{data:{session:w}}=await N.auth.getSession(),f=await fetch("https://tzdgqhwyzsxkxnncgzap.supabase.co/functions/v1/admin-create-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w?.access_token}`},body:JSON.stringify({email:c.email,password:c.password,displayName:c.displayName,phone:c.phone,role:c.role})}),y=await f.json();if(!f.ok)throw new Error(y.error||"Failed to create user");j({title:o("common.success"),description:o("admin.userCreated")}),S(!1),v({email:"",password:"",displayName:"",phone:"",role:"merchant"}),C.invalidateQueries({queryKey:["admin-users"]})}catch(w){console.error("Error creating user:",w),j({title:o("common.error"),description:w.message||o("admin.createUserError"),variant:"destructive"})}finally{E(!1)}};return e.jsxs(je,{open:i,onOpenChange:S,children:[e.jsx(_e,{asChild:!0,children:a||e.jsxs(p,{children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),o("admin.createUser")]})}),e.jsx(fe,{className:"max-w-[90vw] sm:max-w-[500px]",children:e.jsxs("form",{onSubmit:u,children:[e.jsxs(ge,{children:[e.jsx(Ne,{children:o("admin.createNewUser")}),e.jsx(ve,{children:o("admin.createUserDescription")})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"email",children:o("auth.email")}),e.jsx(K,{id:"email",type:"email",required:!0,value:c.email,onChange:h=>v({...c,email:h.target.value}),placeholder:"user@example.com"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"password",children:o("auth.password")}),e.jsx(K,{id:"password",type:"password",required:!0,value:c.password,onChange:h=>v({...c,password:h.target.value}),placeholder:"••••••••",minLength:6})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"displayName",children:o("profile.displayName")}),e.jsx(K,{id:"displayName",required:!0,value:c.displayName,onChange:h=>v({...c,displayName:h.target.value}),placeholder:o("profile.displayName")})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"phone",children:o("profile.phone")}),e.jsx(K,{id:"phone",type:"tel",value:c.phone,onChange:h=>v({...c,phone:h.target.value}),placeholder:"+351 XXX XXX XXX"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(H,{htmlFor:"role",children:o("admin.role")}),m?e.jsx(K,{id:"role",value:o("admin.merchant"),disabled:!0,className:"bg-muted"}):e.jsxs(ae,{value:c.role,onValueChange:h=>v({...c,role:h}),children:[e.jsx(re,{children:e.jsx(te,{})}),e.jsxs(ne,{children:[e.jsx(I,{value:"merchant",children:o("admin.merchant")}),e.jsx(I,{value:"supervisor",children:o("admin.supervisor")})]})]})]})]}),e.jsxs(hs,{children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>S(!1),disabled:l,children:o("common.cancel")}),e.jsxs(p,{type:"submit",disabled:l,children:[l&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),o("admin.create")]})]})]})})]})},zs=({open:a,onOpenChange:o,merchantId:j,merchantName:C,userRole:m})=>{const{t:i}=G(),{toast:S}=pe(),l=Ce(),{localizeRestaurant:E}=Ss(),{user:c}=xs(),{isSupervisor:v}=Ee(),[u,h]=d.useState([]),[w,f]=d.useState(""),{data:y}=W({queryKey:["supervisorRestaurants",c?.id],queryFn:async()=>{if(!c||!v)return null;const{data:t,error:g}=await N.from("merchant_restaurants").select("restaurant_id").eq("user_id",c.id);if(g)throw g;return t?.map(_=>_.restaurant_id)||[]},enabled:a&&v&&!!c}),{data:O,isLoading:r}=W({queryKey:["allRestaurants",y],queryFn:async()=>{let t=N.from("restaurants").select("*").order("name");v&&y&&y.length>0&&(t=t.in("id",y));const{data:g,error:_}=await t;if(_)throw _;return g},enabled:!v||v&&y!==void 0}),{data:n,isLoading:b}=W({queryKey:["merchantRestaurants",j],queryFn:async()=>{const{data:t,error:g}=await N.from("merchant_restaurants").select("restaurant_id").eq("user_id",j);if(g)throw g;return t?.map(_=>_.restaurant_id)||[]},enabled:a}),{data:k}=W({queryKey:["allRestaurantAssignments"],queryFn:async()=>{const{data:t,error:g}=await N.from("merchant_restaurants").select("restaurant_id, user_id");if(g)throw g;if(!t||t.length===0)return{};const _=[...new Set(t.map(A=>A.user_id))],{data:P}=await N.from("profiles").select("id, display_name").in("id",_),{data:L}=await N.from("user_roles").select("user_id, role").in("user_id",_),B=new Map(P?.map(A=>[A.id,A.display_name])||[]),T=new Map(L?.map(A=>[A.user_id,A.role])||[]),Y={};return t.forEach(A=>{Y[A.restaurant_id]||(Y[A.restaurant_id]=[]),Y[A.restaurant_id].push({userId:A.user_id,displayName:B.get(A.user_id)||"Unknown",role:T.get(A.user_id)||"user"})}),Y},enabled:a});d.useEffect(()=>{n&&h(n)},[n]);const D=be({mutationFn:async()=>{const{error:t}=await N.from("merchant_restaurants").delete().eq("user_id",j);if(t)throw t;if(u.length>0){const{error:g}=await N.from("merchant_restaurants").insert(u.map(_=>({user_id:j,restaurant_id:_})));if(g)throw g}},onSuccess:()=>{S({title:i("toast.merchantRestaurantsSaved"),description:i("toast.merchantRestaurantsDescription")}),l.invalidateQueries({queryKey:["merchantRestaurants"]}),l.invalidateQueries({queryKey:["adminUsers"]}),o(!1)},onError:t=>{console.error("Error saving merchant restaurants:",t),S({title:i("toast.merchantRestaurantsSaveFailed"),description:i("toast.merchantRestaurantsDescriptionFailed"),variant:"destructive"})}}),R=t=>{m==="merchant"?u.includes(t)?h([]):h([t]):h(g=>g.includes(t)?g.filter(_=>_!==t):[...g,t])},F=()=>{D.mutate()},q=r||b,U=O?.filter(t=>w.trim()?E(t).name.toLowerCase().includes(w.toLowerCase())||t.address.toLowerCase().includes(w.toLowerCase()):!0);return e.jsx(je,{open:a,onOpenChange:o,children:e.jsxs(fe,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(ge,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-5 h-5"}),i(m==="merchant"?"merchant.manageRestaurants":"merchant.manageSupervisorRestaurants")]}),e.jsxs(ve,{children:[i("merchant.assignRestaurantsTo",{name:C}),m==="merchant"&&e.jsx("span",{className:"block mt-1 text-primary font-medium",children:i("merchant.merchantOnlyOne")}),e.jsx("span",{className:"block mt-1 text-muted-foreground text-xs",children:i("merchant.saveReminder")})]})]}),q?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{className:"w-6 h-6 animate-spin text-primary"})}):e.jsxs("div",{className:"flex flex-col flex-1 min-h-0",children:[e.jsxs("div",{className:"relative mb-4 flex-shrink-0",children:[e.jsx(Je,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(K,{placeholder:i("merchant.searchRestaurants"),value:w,onChange:t=>f(t.target.value),className:"pl-9"})]}),e.jsx(We,{className:"flex-1 min-h-0 pr-4",children:e.jsx("div",{className:"space-y-3",children:U?.map(t=>{const g=u.includes(t.id),_=E(t),P=k?.[t.id]?.filter(L=>L.userId!==j)||[];return e.jsxs("div",{className:"flex items-start space-x-3 p-4 rounded-lg border hover:bg-accent/50 transition-all cursor-pointer",onClick:()=>R(t.id),children:[e.jsx(ue,{checked:g,className:"mt-1"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 flex-wrap",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:_.name}),g&&e.jsx(Q,{variant:"secondary",className:"text-xs",children:i("merchant.selected")})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(us,{className:"w-3 h-3"}),e.jsx("span",{className:"line-clamp-1",children:t.address})]}),t.type&&t.type.length>0&&e.jsx("div",{className:"flex gap-1 mt-2 flex-wrap",children:t.type.slice(0,2).map((L,B)=>e.jsx(Q,{variant:"outline",className:"text-xs",children:L},B))}),P.length>0&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-2 flex-wrap",children:[e.jsx(ps,{className:"w-3 h-3 text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[i("merchant.assignedTo"),":"]}),e.jsxs(js,{children:[P.slice(0,3).map((L,B)=>e.jsxs(Qe,{children:[e.jsx(Xe,{asChild:!0,children:e.jsx(Q,{variant:"outline",className:`text-xs ${L.role==="supervisor"?"border-blue-500/50 text-blue-600 dark:text-blue-400":"border-amber-500/50 text-amber-600 dark:text-amber-400"}`,children:L.displayName})}),e.jsx($e,{children:e.jsx("p",{children:L.role==="supervisor"?i("roles.supervisor"):i("roles.merchant")})})]},L.userId)),P.length>3&&e.jsxs(Qe,{children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(Q,{variant:"outline",className:"text-xs",children:["+",P.length-3]})}),e.jsx($e,{children:e.jsx("div",{className:"space-y-1",children:P.slice(3).map(L=>e.jsxs("p",{children:[L.displayName," (",L.role==="supervisor"?i("roles.supervisor"):i("roles.merchant"),")"]},L.userId))})})]})]})]})]})]},t.id)})})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:m==="merchant"?i("merchant.selectedCountOne",{count:u.length}):i("merchant.selectedCountMulti",{count:u.length})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>o(!1),disabled:D.isPending,children:i("common.cancel")}),e.jsxs(p,{onClick:F,disabled:D.isPending,children:[D.isPending&&e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),i("common.save")]})]})]})]})]})})},Is=({merchantId:a,merchantName:o,trigger:j})=>{G();const{toast:C}=pe(),m=Ce(),[i,S]=d.useState(!1),[l,E]=d.useState(""),{data:c=[],isLoading:v}=W({queryKey:["supervisors"],queryFn:async()=>{const{data:r,error:n}=await N.from("user_roles").select("user_id").eq("role","supervisor");if(n)throw n;const b=r.map(R=>R.user_id);if(b.length===0)return[];const{data:k,error:D}=await N.from("profiles").select("id, display_name").in("id",b);if(D)throw D;return k},enabled:i}),{data:u=[]}=W({queryKey:["merchant-restaurants",a],queryFn:async()=>{const{data:r,error:n}=await N.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(n)throw n;return r.map(b=>b.restaurant_id)},enabled:i}),{data:h=[]}=W({queryKey:["merchant-supervisors",a],queryFn:async()=>{if(u.length===0)return[];const{data:r,error:n}=await N.from("merchant_restaurants").select("user_id, restaurant_id").in("restaurant_id",u).neq("user_id",a);if(n)throw n;const b=[...new Set(r.map(U=>U.user_id))];if(b.length===0)return[];const{data:k,error:D}=await N.from("user_roles").select("user_id").in("user_id",b).eq("role","supervisor");if(D)throw D;const R=k.map(U=>U.user_id);if(R.length===0)return[];const{data:F,error:q}=await N.from("profiles").select("id, display_name").in("id",R);if(q)throw q;return F},enabled:i&&u.length>0}),w=be({mutationFn:async r=>{if(u.length===0)throw new Error("该商家没有管理任何餐厅");const n=u.map(k=>({user_id:r,restaurant_id:k})),{error:b}=await N.from("merchant_restaurants").upsert(n,{onConflict:"user_id,restaurant_id"});if(b)throw b},onSuccess:()=>{C({title:"分配成功",description:"商家已成功分配给主管"}),m.invalidateQueries({queryKey:["merchant-supervisors"]}),E(""),S(!1)},onError:r=>{C({title:"分配失败",description:r.message,variant:"destructive"})}}),f=be({mutationFn:async r=>{const{error:n}=await N.from("merchant_restaurants").delete().eq("user_id",r).in("restaurant_id",u);if(n)throw n},onSuccess:()=>{C({title:"移除成功",description:"主管已从该商家移除"}),m.invalidateQueries({queryKey:["merchant-supervisors"]})},onError:r=>{C({title:"移除失败",description:r.message,variant:"destructive"})}}),y=()=>{l&&w.mutate(l)},O=r=>{f.mutate(r)};return e.jsxs(je,{open:i,onOpenChange:S,children:[e.jsx(_e,{asChild:!0,children:j||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"分配主管"]})}),e.jsxs(fe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"分配商家给主管"]}),e.jsxs(ve,{children:["为商家 ",e.jsx("strong",{children:o})," 分配主管"]})]}),e.jsxs("div",{className:"space-y-4",children:[h.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"当前主管"}),e.jsx("div",{className:"space-y-2",children:h.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm",children:r.display_name})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>O(r.id),disabled:f.isPending,children:"移除"})]},r.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"分配新主管"}),e.jsxs(ae,{value:l,onValueChange:E,children:[e.jsx(re,{children:e.jsx(te,{placeholder:"选择主管"})}),e.jsx(ne,{children:v?e.jsx("div",{className:"p-2 text-center",children:e.jsx(J,{className:"w-4 h-4 animate-spin mx-auto"})}):c.length===0?e.jsx("div",{className:"p-2 text-center text-sm text-muted-foreground",children:"没有可用的主管"}):c.filter(r=>!h.find(n=>n.id===r.id)).map(r=>e.jsx(I,{value:r.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-blue-500"}),r.display_name]})},r.id))})]})]}),u.length===0&&e.jsx(Q,{variant:"secondary",className:"w-full justify-center",children:"该商家没有管理任何餐厅"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(p,{variant:"outline",onClick:()=>S(!1),children:"取消"}),e.jsx(p,{onClick:y,disabled:!l||w.isPending||u.length===0,children:w.isPending?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),"分配中..."]}):"确认分配"})]})]})]})]})},Ms=({supervisorId:a,supervisorName:o,trigger:j})=>{G();const{toast:C}=pe(),m=Ce(),[i,S]=d.useState(!1),[l,E]=d.useState([]),{data:c=[],isLoading:v}=W({queryKey:["all-merchants-with-restaurants"],queryFn:async()=>{const{data:r,error:n}=await N.from("user_roles").select("user_id").eq("role","merchant");if(n)throw n;const b=r.map(q=>q.user_id);if(b.length===0)return[];const{data:k,error:D}=await N.from("profiles").select("id, display_name, avatar_url").in("id",b);if(D)throw D;const{data:R,error:F}=await N.from("merchant_restaurants").select("user_id, restaurant_id, restaurants(name)").in("user_id",b);if(F)throw F;return k.map(q=>({...q,restaurants:R.filter(U=>U.user_id===q.id).map(U=>({id:U.restaurant_id,name:U.restaurants?.name||"Unknown"}))}))},enabled:i}),{data:u=[],isLoading:h}=W({queryKey:["supervisor-managed-merchants",a],queryFn:async()=>{const{data:r,error:n}=await N.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(n)throw n;const b=r.map(U=>U.restaurant_id);if(b.length===0)return[];const{data:k,error:D}=await N.from("merchant_restaurants").select("user_id").in("restaurant_id",b).neq("user_id",a);if(D)throw D;const R=[...new Set(k.map(U=>U.user_id))];if(R.length===0)return[];const{data:F,error:q}=await N.from("user_roles").select("user_id").in("user_id",R).eq("role","merchant");if(q)throw q;return F.map(U=>U.user_id)},enabled:i});d.useState(()=>{u.length>0&&l.length===0&&E(u)});const w=be({mutationFn:async()=>{const{data:r,error:n}=await N.from("merchant_restaurants").select("user_id, restaurant_id").in("user_id",l);if(n)throw n;const{data:b,error:k}=await N.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(k)throw k;const D=b.map(t=>t.restaurant_id),R=r.map(t=>t.restaurant_id),F=R.filter(t=>!D.includes(t)),q=c.flatMap(t=>t.restaurants.map(g=>g.id)),U=D.filter(t=>q.includes(t)&&!R.includes(t));if(F.length>0){const t=F.map(_=>({user_id:a,restaurant_id:_})),{error:g}=await N.from("merchant_restaurants").upsert(t,{onConflict:"user_id,restaurant_id"});if(g)throw g}if(U.length>0){const{error:t}=await N.from("merchant_restaurants").delete().eq("user_id",a).in("restaurant_id",U);if(t)throw t}},onSuccess:()=>{C({title:"保存成功",description:"商家分配已更新"}),m.invalidateQueries({queryKey:["supervisor-managed-merchants"]}),m.invalidateQueries({queryKey:["merchant-restaurants"]}),S(!1)},onError:r=>{C({title:"保存失败",description:r.message,variant:"destructive"})}}),f=r=>{E(n=>n.includes(r)?n.filter(b=>b!==r):[...n,r])},y=()=>{w.mutate()},O=d.useState(!1);return!O[0]&&u.length>0&&(E(u),O[1](!0)),e.jsxs(je,{open:i,onOpenChange:r=>{S(r),r&&E(u)},children:[e.jsx(_e,{asChild:!0,children:j||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"管理商家"]})}),e.jsxs(fe,{className:"max-w-lg",children:[e.jsxs(ge,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5 text-blue-500"}),"分配商家给主管"]}),e.jsxs(ve,{children:["选择要分配给 ",e.jsx("strong",{children:o})," 管理的商家"]})]}),e.jsxs("div",{className:"space-y-4",children:[v||h?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(J,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(le,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"没有可分配的商家"})]}):e.jsx(We,{className:"h-[300px] pr-4",children:e.jsx("div",{className:"space-y-2",children:c.map(r=>e.jsxs("div",{className:`flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition-colors ${l.includes(r.id)?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>f(r.id),children:[e.jsx(ue,{checked:l.includes(r.id),onCheckedChange:()=>f(r.id)}),e.jsxs(Fe,{className:"h-10 w-10",children:[e.jsx(ze,{src:r.avatar_url||""}),e.jsx(Ie,{className:"bg-emerald-100 text-emerald-700",children:r.display_name?.charAt(0).toUpperCase()||"M"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r.display_name}),r.restaurants.length>0?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Te,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:r.restaurants.map(n=>n.name).join(", ")})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"无餐厅"})]}),e.jsxs(Q,{variant:"outline",className:"text-xs",children:[e.jsx(le,{className:"w-3 h-3 mr-1"}),"商家"]})]},r.id))})}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["已选择 ",l.length," 个商家"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>S(!1),children:"取消"}),e.jsx(p,{onClick:y,disabled:w.isPending,children:w.isPending?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):"保存"})]})]})]})]})]})},Ps=({merchant:a,trigger:o})=>{const{t:j}=G(),[C,m]=d.useState(!1),[i,S]=d.useState(a.display_name),[l,E]=d.useState(a.phone||""),[c,v]=d.useState(null),[u,h]=d.useState(a.avatar_url||""),w=gs(),f=Ns(),y=r=>{const n=r.target.files?.[0];if(n){if(n.size>2*1024*1024)return;v(n),h(URL.createObjectURL(n))}},O=async()=>{let r=a.avatar_url;if(c){const n=await f.mutateAsync({file:c,userId:a.id});n&&(r=n)}await w.mutateAsync({userId:a.id,display_name:i,phone:l||void 0,avatar_url:r||void 0}),m(!1)};return e.jsxs(je,{open:C,onOpenChange:m,children:[e.jsx(_e,{asChild:!0,children:o||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"编辑资料"]})}),e.jsxs(fe,{className:"max-w-[90vw] sm:max-w-[425px]",children:[e.jsxs(ge,{children:[e.jsx(Ne,{children:"编辑商家资料"}),e.jsx(ve,{children:"修改商家的个人信息和头像"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs(Fe,{className:"w-24 h-24",children:[e.jsx(ze,{src:u}),e.jsx(Ie,{children:i?.charAt(0).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx(K,{type:"file",accept:"image/*",onChange:y,className:"hidden",id:"avatar-upload"}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>document.getElementById("avatar-upload")?.click(),children:[e.jsx(ks,{className:"w-4 h-4 mr-2"}),j("profile.uploadAvatar")]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"displayName",children:j("profile.displayName")}),e.jsx(K,{id:"displayName",value:i,onChange:r=>S(r.target.value),placeholder:j("profile.displayName")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"phone",children:j("profile.phone")}),e.jsx(K,{id:"phone",value:l,onChange:r=>E(r.target.value),placeholder:j("profile.phone")})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>m(!1),children:j("common.cancel")}),e.jsx(p,{onClick:O,disabled:w.isPending||f.isPending,children:w.isPending||f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),j("common.loading")]}):j("common.save")})]})]})]})},Bs=({open:a,onOpenChange:o,userName:j,userId:C,userRole:m,onConfirm:i,isDeleting:S=!1})=>{const{t:l}=G(),[E,c]=d.useState(1),[v,u]=d.useState(""),h=()=>{c(1),u(""),o(!1)},w=()=>{c(2)},f=()=>{v.toLowerCase()==="delete"&&i()};return e.jsx(Ue,{open:a,onOpenChange:y=>{y?o(y):h()},children:e.jsx(qe,{className:"max-w-[90vw] sm:max-w-[500px]",children:E===1?e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ze,{className:"h-5 w-5"}),l("admin.deleteUser")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:l("admin.deleteUserWarning")}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[l("admin.userName"),":"]})," ",j]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[l("admin.userRole"),":"]})," ",m]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:l("admin.deleteUserConsequences")}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:l("admin.deleteUserData1")}),e.jsx("li",{children:l("admin.deleteUserData2")}),e.jsx("li",{children:l("admin.deleteUserData3")}),e.jsx("li",{children:l("admin.deleteUserData4")})]})]}),m==="admin"&&e.jsx("div",{className:"bg-destructive/20 border border-destructive p-3 rounded-lg",children:e.jsxs("p",{className:"text-sm font-semibold text-destructive",children:["⚠️ ",l("admin.deleteAdminWarning")]})})]})]}),e.jsxs(me,{children:[e.jsx(he,{onClick:h,children:l("common.cancel")}),e.jsx(xe,{onClick:w,className:"bg-destructive hover:bg-destructive/90",children:l("common.continue")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(ye,{className:"h-5 w-5"}),l("admin.confirmDeleteUser")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsx("p",{className:"text-foreground font-medium",children:l("admin.finalDeleteWarning",{userName:j})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"delete-confirm",className:"text-sm font-medium",children:l("admin.typeDeleteToConfirm")}),e.jsx(K,{id:"delete-confirm",value:v,onChange:y=>u(y.target.value),placeholder:"DELETE",className:"uppercase",autoComplete:"off"})]})]})]}),e.jsxs(me,{children:[e.jsx(he,{onClick:h,children:l("common.cancel")}),e.jsx(xe,{onClick:f,disabled:v.toLowerCase()!=="delete"||S,className:"bg-destructive hover:bg-destructive/90",children:l(S?"common.loading":"admin.deleteUser")})]})]})})})},Na=()=>{const{t:a}=G(),{toast:o}=pe(),{isSupervisor:j,isAdmin:C}=Ee(),{data:m,isLoading:i}=vs(),S=ws(),l=ys(),E=bs(),c=_s(),[v,u]=d.useState(null),[h,w]=d.useState(""),[f,y]=d.useState([]),[O,r]=d.useState("user"),[n,b]=d.useState(""),[k,D]=d.useState("all"),[R,F]=d.useState("name"),[q,U]=d.useState("asc"),[t,g]=d.useState(null),[_,P]=d.useState({open:!1,userId:"",userName:"",userRole:""}),[L,B]=d.useState({open:!1,step:1,confirmText:""}),[T,Y]=d.useState({open:!1,userId:"",userName:"",currentRole:"",newRole:""}),[A,Me]=d.useState({open:!1,merchantId:"",merchantName:"",userRole:"merchant"}),[we,Pe]=d.useState({open:!1,userId:"",userName:"",userRole:""}),Be=["user","merchant","supervisor","admin"],Ke=j?Be.filter(s=>s==="user"||s==="merchant"):Be,ee=d.useMemo(()=>m?{total:m.length,admins:m.filter(s=>s.role==="admin").length,supervisors:m.filter(s=>s.role==="supervisor").length,merchants:m.filter(s=>s.role==="merchant").length,regularUsers:m.filter(s=>s.role==="user").length}:{total:0,admins:0,supervisors:0,merchants:0,regularUsers:0},[m]),se=d.useMemo(()=>{if(!m)return[];let s=m.filter(x=>{const z=n===""||x.display_name.toLowerCase().includes(n.toLowerCase())||x.phone?.toLowerCase().includes(n.toLowerCase())||x.email?.toLowerCase().includes(n.toLowerCase()),V=k==="all"||x.role===k;return z&&V});return s.sort((x,z)=>{let V=0;if(R==="name")V=x.display_name.localeCompare(z.display_name);else if(R==="created"){const De=new Date(x.auth_created_at||x.created_at).getTime(),Re=new Date(z.auth_created_at||z.created_at).getTime();V=De-Re}else if(R==="lastLogin"){const De=x.last_sign_in_at?new Date(x.last_sign_in_at).getTime():0,Re=z.last_sign_in_at?new Date(z.last_sign_in_at).getTime():0;V=De-Re}return q==="asc"?V:-V}),s},[m,n,k,R,q]),{displayedData:Se,hasMore:Ge,reset:Oe,displayedCount:es,sentinelRef:ss}=Cs({data:se,initialItemsPerPage:30,incrementPerPage:30});d.useEffect(()=>{Oe()},[n,k,R,q,Oe]);const as=()=>{if(!m||m.length===0){o({title:a("common.error"),description:a("admin.noDataToExport"),variant:"destructive"});return}Rs(m),o({title:a("common.success"),description:a("admin.exportSuccess")})},rs=s=>{y(x=>x.includes(s)?x.filter(z=>z!==s):[...x,s])},ts=()=>{f.length===se?.length?y([]):y(se?.map(s=>s.id)||[])},ns=()=>{_.userId&&c.mutate(_.userId,{onSuccess:()=>{P({open:!1,userId:"",userName:"",userRole:""})},onError:()=>{P({open:!1,userId:"",userName:"",userRole:""})}})},ls=(s,x,z)=>{P({open:!0,userId:s,userName:x,userRole:z})},is=()=>{f.length===0||L.confirmText.toLowerCase()!=="delete"||l.mutate(f,{onSuccess:()=>{y([]),B({open:!1,step:1,confirmText:""})}})},cs=()=>{f.length!==0&&(E.mutate({userIds:f,role:O}),y([]))},ds=()=>{T.userId&&T.newRole&&S.mutate({userId:T.userId,role:T.newRole},{onSuccess:()=>{Y({open:!1,userId:"",userName:"",currentRole:"",newRole:""}),u(null),w("")}})},os=(s,x,z,V)=>{Y({open:!0,userId:s,userName:x,currentRole:z,newRole:V})},ke=s=>{switch(s){case"admin":return"bg-primary text-primary-foreground hover:bg-primary/90";case"supervisor":return"bg-blue-500 text-white hover:bg-blue-600";case"merchant":return"bg-emerald-500 text-white hover:bg-emerald-600";default:return"bg-muted text-muted-foreground hover:bg-muted/80"}},ie=s=>{switch(s){case"admin":return e.jsx(M,{className:"h-3.5 w-3.5"});case"supervisor":return e.jsx(M,{className:"h-3.5 w-3.5"});case"merchant":return e.jsx(le,{className:"h-3.5 w-3.5"});default:return e.jsx(Z,{className:"h-3.5 w-3.5"})}};return i?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:a("common.loading")})]})}):e.jsxs("div",{className:"space-y-6 w-full max-w-full overflow-x-hidden",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(Ae,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:a("admin.userManagement")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.manageUserRoles")})]})]})}),j?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx(X,{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200 dark:from-emerald-950/20 dark:to-emerald-900/20 dark:border-emerald-900/30",children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:a("admin.managedMerchants")}),e.jsx("p",{className:"text-2xl font-bold",children:ee.merchants})]}),e.jsx(le,{className:"h-8 w-8 text-emerald-500"})]})})})}):e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3",children:[e.jsx(X,{className:"bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20 min-w-0",children:e.jsx($,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.totalUsersLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.total})]}),e.jsx(Z,{className:"h-6 w-6 text-primary/60 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 dark:from-red-950/20 dark:to-red-900/20 dark:border-red-900/30 min-w-0",children:e.jsx($,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.adminsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.admins})]}),e.jsx(M,{className:"h-6 w-6 text-red-500 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200 dark:from-blue-950/20 dark:to-blue-900/20 dark:border-blue-900/30 min-w-0",children:e.jsx($,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.supervisorsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.supervisors})]}),e.jsx(M,{className:"h-6 w-6 text-blue-500 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200 dark:from-emerald-950/20 dark:to-emerald-900/20 dark:border-emerald-900/30 min-w-0",children:e.jsx($,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.merchantsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.merchants})]}),e.jsx(le,{className:"h-6 w-6 text-emerald-500 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200 dark:from-gray-950/20 dark:to-gray-900/20 dark:border-gray-900/30 min-w-0",children:e.jsx($,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.regularUsersLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.regularUsers})]}),e.jsx(Z,{className:"h-6 w-6 text-gray-500 flex-shrink-0"})]})})})]}),e.jsx(X,{children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"relative",children:[e.jsx(Je,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(K,{placeholder:a("admin.searchUserPlaceholder"),value:n,onChange:s=>b(s.target.value),className:"pl-10 pr-10"}),n&&e.jsx(p,{variant:"ghost",size:"sm",className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7 p-0",onClick:()=>b(""),children:e.jsx(Ve,{className:"h-4 w-4"})})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[!j&&e.jsxs(ae,{value:k,onValueChange:D,children:[e.jsxs(re,{className:"w-full lg:w-[200px]",children:[e.jsx(Us,{className:"h-4 w-4 mr-2"}),e.jsx(te,{placeholder:a("admin.filterRole")})]}),e.jsxs(ne,{children:[e.jsx(I,{value:"all",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),a("admin.allRolesLabel")]})}),e.jsx(I,{value:"admin",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-4 w-4 text-red-500"}),a("admin.adminsLabel")]})}),e.jsx(I,{value:"supervisor",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-4 w-4 text-blue-500"}),a("admin.supervisorsLabel")]})}),e.jsx(I,{value:"merchant",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-emerald-500"}),a("admin.merchantsLabel")]})}),e.jsx(I,{value:"user",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4 text-gray-500"}),a("admin.regularUsersLabel")]})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ae,{value:R,onValueChange:s=>F(s),children:[e.jsxs(re,{className:"w-full lg:w-[160px]",children:[e.jsx(qs,{className:"h-4 w-4 mr-2"}),e.jsx(te,{})]}),e.jsxs(ne,{children:[e.jsx(I,{value:"name",children:a("admin.sortByName")}),e.jsx(I,{value:"created",children:a("admin.sortByCreated")}),e.jsx(I,{value:"lastLogin",children:a("admin.sortByLastLogin")})]})]}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>U(s=>s==="asc"?"desc":"asc"),title:a(q==="asc"?"admin.sortAsc":"admin.sortDesc"),children:q==="asc"?e.jsx(Ls,{className:"h-4 w-4"}):e.jsx(As,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[C&&e.jsx(Fs,{trigger:e.jsxs(p,{variant:"default",size:"default",children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:a("admin.createUser")}),e.jsx("span",{className:"sm:hidden",children:a("admin.create")})]})}),e.jsxs(p,{variant:"outline",onClick:as,children:[e.jsx(Es,{className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:a("admin.exportLabel")})]})]})]})]})})}),C&&f.length>0&&e.jsx(X,{className:"border-primary/50 bg-primary/5",children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{checked:!0,onCheckedChange:()=>y([])}),e.jsxs("span",{className:"font-semibold",children:["已选择 ",f.length," 个用户"]})]}),e.jsxs(p,{variant:"ghost",size:"sm",onClick:()=>y([]),children:[e.jsx(Ve,{className:"h-4 w-4 mr-1"}),"清除选择"]})]}),e.jsx(He,{}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"批量更改角色为："}),e.jsxs(ae,{value:O,onValueChange:s=>r(s),children:[e.jsx(re,{className:"w-full sm:w-[160px]",children:e.jsx(te,{})}),e.jsx(ne,{children:Ke.map(s=>e.jsx(I,{value:s,children:e.jsxs("div",{className:"flex items-center gap-2",children:[ie(s),e.jsx("span",{className:"capitalize",children:s})]})},s))})]}),e.jsxs(p,{onClick:cs,size:"default",children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"应用"]})]}),e.jsxs(p,{variant:"destructive",size:"default",onClick:()=>B({open:!0,step:1,confirmText:""}),children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),"批量删除"]})]})]})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{checked:f.length===se?.length&&se.length>0,onCheckedChange:ts}),e.jsx("span",{className:"font-medium text-sm",children:"全选"})]}),e.jsxs(Q,{variant:"secondary",className:"text-xs",children:[es," / ",se?.length||0]})]}),Se&&Se.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3",children:Se.map(s=>e.jsx(X,{className:`transition-all duration-200 ${t===s.id?"ring-2 ring-primary":"hover:shadow-md"} ${s.is_banned?"border-orange-300 bg-orange-50/50 dark:bg-orange-950/20":""}`,children:e.jsxs($,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-4 py-2",children:[e.jsx(ue,{checked:f.includes(s.id),onCheckedChange:()=>rs(s.id),onClick:x=>x.stopPropagation(),className:"h-5 w-5"}),e.jsxs(Fe,{className:"h-14 w-14 flex-shrink-0",children:[e.jsx(ze,{src:s.avatar_url||""}),e.jsx(Ie,{className:"text-lg font-medium bg-primary/10 text-primary",children:s.display_name?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-base truncate",children:s.display_name}),s.is_banned&&e.jsx(Q,{variant:"outline",className:"text-xs px-1.5 py-0.5 text-orange-500 border-orange-300",children:"已封禁"})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.email||s.phone||"未设置联系方式"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.last_sign_in_at?`最后登录: ${new Date(s.last_sign_in_at).toLocaleString("zh-CN")}`:"从未登录"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs(Q,{className:`${ke(s.role)} text-xs px-2.5 py-1`,children:[ie(s.role),e.jsx("span",{className:"ml-1.5 capitalize",children:s.role})]}),e.jsx(p,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>g(t===s.id?null:s.id),children:e.jsx(fs,{className:`h-5 w-5 transition-transform ${t===s.id?"rotate-180":""}`})})]})]}),t===s.id&&e.jsxs("div",{className:"mt-3 pt-3 border-t space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"邮箱:"}),e.jsx("p",{className:"truncate",children:s.email||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"电话:"}),e.jsx("p",{className:"truncate",children:s.phone||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"创建时间:"}),e.jsx("p",{children:s.auth_created_at?new Date(s.auth_created_at).toLocaleDateString("zh-CN"):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"最后登录:"}),e.jsx("p",{children:s.last_sign_in_at?new Date(s.last_sign_in_at).toLocaleString("zh-CN"):"-"})]})]}),C&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ae,{value:v===s.id?h:"",onValueChange:x=>{u(s.id),w(x)},children:[e.jsx(re,{className:"h-8 text-xs flex-1",children:e.jsx(te,{placeholder:"更改角色..."})}),e.jsx(ne,{children:Ke.filter(x=>x!==s.role).map(x=>e.jsx(I,{value:x,children:e.jsxs("div",{className:"flex items-center gap-2",children:[ie(x),e.jsx("span",{className:"capitalize",children:x})]})},x))})]}),e.jsx(p,{size:"sm",className:"h-8 text-xs",onClick:()=>{v===s.id&&h&&os(s.id,s.display_name,s.role,h)},disabled:v!==s.id||!h,children:"确认"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>Pe({open:!0,userId:s.id,userName:s.display_name,userRole:s.role}),children:[e.jsx(Ts,{className:"mr-1.5 h-3.5 w-3.5"}),"查看资料"]}),j&&s.role==="merchant"&&e.jsx(Ps,{merchant:{id:s.id,display_name:s.display_name,phone:s.phone,avatar_url:s.avatar_url},trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(Ye,{className:"mr-1.5 h-3.5 w-3.5"}),"编辑资料"]})}),(s.role==="merchant"||s.role==="supervisor")&&e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>Me({open:!0,merchantId:s.id,merchantName:s.display_name,userRole:s.role}),children:[e.jsx(Te,{className:"mr-1.5 h-3.5 w-3.5"}),"餐厅"]}),C&&s.role==="merchant"&&e.jsx(Is,{merchantId:s.id,merchantName:s.display_name,trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(Ae,{className:"mr-1.5 h-3.5 w-3.5"}),"分配主管"]})}),C&&s.role==="supervisor"&&e.jsx(Ms,{supervisorId:s.id,supervisorName:s.display_name,trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(Z,{className:"mr-1.5 h-3.5 w-3.5"}),"管理商家"]})}),C&&s.role!=="admin"&&e.jsxs(p,{variant:"destructive",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>ls(s.id,s.display_name,s.role),children:[e.jsx(ye,{className:"mr-1.5 h-3.5 w-3.5"}),"删除"]})]})]})]})},s.id))}):e.jsx(X,{children:e.jsx($,{className:"pt-12 pb-12",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(Z,{className:"h-16 w-16 text-muted-foreground/50 mx-auto"}),e.jsx("h3",{className:"text-lg font-semibold",children:"未找到用户"}),e.jsx("p",{className:"text-muted-foreground",children:n||k!=="all"?"尝试调整搜索条件或筛选器":"还没有任何用户"})]})})}),Ge&&e.jsx("div",{ref:ss,className:"flex justify-center py-4",children:e.jsx(J,{className:"h-6 w-6 animate-spin text-muted-foreground"})})]}),e.jsx(Ue,{open:T.open,onOpenChange:s=>{s||Y({open:!1,userId:"",userName:"",currentRole:"",newRole:""})},children:e.jsxs(qe,{className:"max-w-[90vw] sm:max-w-[500px]",children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-5 w-5 text-primary"}),"确认角色更改"]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"用户："}),e.jsx("span",{className:"font-semibold text-foreground",children:T.userName})]}),e.jsx(He,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"当前角色："}),e.jsxs(Q,{className:ke(T.currentRole),children:[ie(T.currentRole),e.jsx("span",{className:"ml-1.5 capitalize",children:T.currentRole})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"text-2xl text-primary",children:"↓"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"新角色："}),e.jsxs(Q,{className:ke(T.newRole),children:[ie(T.newRole),e.jsx("span",{className:"ml-1.5 capitalize",children:T.newRole})]})]})]}),T.newRole==="admin"&&e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg flex gap-3",children:[e.jsx(M,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-destructive text-sm",children:"⚠️ 警告：管理员权限"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"您即将授予该用户管理员权限。管理员可以管理所有用户、餐厅和活动，包括删除数据和分配角色。"})]})]}),T.currentRole==="admin"&&e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg flex gap-3",children:[e.jsx(M,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-destructive text-sm",children:"⚠️ 警告：移除管理员权限"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"您即将移除该用户的管理员权限。该用户将失去对系统的完全访问权限。"})]})]}),e.jsx("p",{className:"text-sm text-center text-muted-foreground",children:"此操作将立即生效。确定要继续吗？"})]})]}),e.jsxs(me,{children:[e.jsx(he,{children:"取消"}),e.jsx(xe,{onClick:ds,className:"bg-primary",children:"确认更改"})]})]})}),e.jsx(zs,{open:A.open,onOpenChange:s=>Me({...A,open:s}),merchantId:A.merchantId,merchantName:A.merchantName,userRole:A.userRole}),e.jsx(Bs,{open:_.open,onOpenChange:s=>{s||P({open:!1,userId:"",userName:"",userRole:""})},userName:_.userName,userId:_.userId,userRole:_.userRole,onConfirm:ns,isDeleting:c.isPending}),e.jsx(Ue,{open:L.open,onOpenChange:s=>{s||B({open:!1,step:1,confirmText:""})},children:e.jsx(qe,{className:"max-w-[90vw] sm:max-w-[500px]",children:L.step===1?e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ze,{className:"h-5 w-5"}),a("admin.batchDeleteTitle")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg",children:e.jsx("p",{className:"font-semibold text-foreground",children:a("admin.batchDeleteStep1",{count:f.length})})}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:a("admin.deleteUserConsequences")}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:a("admin.deleteUserData1")}),e.jsx("li",{children:a("admin.deleteUserData2")}),e.jsx("li",{children:a("admin.deleteUserData3")}),e.jsx("li",{children:a("admin.deleteUserData4")})]})]})]})]}),e.jsxs(me,{children:[e.jsx(he,{onClick:()=>B({open:!1,step:1,confirmText:""}),children:a("common.cancel")}),e.jsx(xe,{onClick:()=>B(s=>({...s,step:2})),className:"bg-destructive hover:bg-destructive/90",children:a("common.continue")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(ye,{className:"h-5 w-5"}),a("admin.batchDeleteStep2Title")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsx("p",{className:"text-foreground font-medium",children:a("admin.batchDeleteStep2Desc",{count:f.length})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"batch-delete-confirm",className:"text-sm font-medium",children:a("admin.typeDeleteToConfirm")}),e.jsx(K,{id:"batch-delete-confirm",value:L.confirmText,onChange:s=>B(x=>({...x,confirmText:s.target.value})),placeholder:"DELETE",className:"uppercase",autoComplete:"off"})]})]})]}),e.jsxs(me,{children:[e.jsx(he,{onClick:()=>B({open:!1,step:1,confirmText:""}),children:a("common.cancel")}),e.jsx(xe,{onClick:is,disabled:L.confirmText.toLowerCase()!=="delete"||l.isPending,className:"bg-destructive hover:bg-destructive/90",children:l.isPending?a("common.loading"):a("admin.deleteUser")})]})]})})}),e.jsx(Ds,{open:we.open,onOpenChange:s=>Pe(x=>({...x,open:s})),userId:we.userId,userName:we.userName,userRole:we.userRole})]})};export{Na as default};
//# sourceMappingURL=AdminUsers-CLQ7q8Il.js.map
