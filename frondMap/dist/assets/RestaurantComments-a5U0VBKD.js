import{j as e}from"./vendor-ui-BO6fjm1h.js";import{r as l,u as _e}from"./vendor-react-CrHRjzzo.js";import{B as u,L as Ae,cl as De,cm as Le,s as K,a9 as W,u as Ue,aO as Pe,a8 as ze,j as $e,aA as ae,aB as te,aC as le,bm as Be,k as ne,$ as Me,bq as Ee,r as X,f as re,a1 as ie,cn as Fe,b4 as ce,aj as Oe,be as oe,Y as me,I as de,a2 as xe,br as qe,q as R,T as D,bC as Ve,aZ as He,a_ as We,a$ as Xe,b0 as Ke,b1 as Ye,R as Ze,am as ue,an as he,ao as ge,ap as pe,aq as je,ar as fe,as as ve,at as Ne}from"./index-H22t9J9U.js";import{u as Ge,a as Je,b as Qe,R as es}from"./ReportDialog-CPd7WJg4.js";import{u as ss}from"./useSensitiveWords-DBK3I7d5.js";import{u as be}from"./vendor-i18n-DWR4v88Y.js";const we=new Map,as=({text:h,className:y,onTranslation:n})=>{const{t:o,i18n:a}=be(),[r,m]=l.useState(!1),[Y,i]=l.useState(null),[k,d]=l.useState(!1),[N,g]=l.useState(null),T=a.language;N&&N!==T&&k&&(d(!1),i(null),n?.(null));const L=async()=>{const p=a.language,f=`${h.substring(0,100)}_${p}`;if(k&&N===p){d(!1),n?.(null);return}const w=we.get(f);if(w){i(w),d(!0),g(p),n?.(w);return}m(!0),console.log("[TranslateButton] Calling translate-content with targetLang:",p);try{const{data:x,error:v}=await K.functions.invoke("translate-content",{body:{text:h,targetLang:p}});if(console.log("[TranslateButton] Response:",x,v),v){console.error("Translation error:",v),W.error(o("translate.error","翻译失败，请稍后重试"));return}x?.translatedText?(we.set(f,x.translatedText),i(x.translatedText),d(!0),g(p),n?.(x.translatedText)):x?.error&&W.error(x.error)}catch(x){console.error("Translation error:",x),W.error(o("translate.error","翻译失败，请稍后重试"))}finally{m(!1)}};return e.jsx(u,{variant:"ghost",size:"sm",className:`gap-1.5 h-auto py-1 px-2 text-xs text-muted-foreground hover:text-foreground ${y||""}`,onClick:L,disabled:r,children:r?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"h-3 w-3 animate-spin"}),e.jsx("span",{children:o("translate.translating","翻译中...")})]}):k?e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"h-3 w-3"}),e.jsx("span",{children:o("translate.showOriginal","显示原文")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{className:"h-3 w-3"}),e.jsx("span",{children:o("translate.button","翻译")})]})})},ts=({text:h,className:y})=>{const[n,o]=l.useState(null);return e.jsxs("div",{className:y,children:[e.jsx("p",{className:"text-xs sm:text-sm text-foreground break-words",children:n||h}),e.jsx(as,{text:h,onTranslation:o,className:"mt-0.5"})]})},Ce=[{value:"0-5",label:"0-5€"},{value:"5-10",label:"5-10€"},{value:"10-15",label:"10-15€"},{value:"15-20",label:"15-20€"},{value:"20-25",label:"20-25€"},{value:"25-30",label:"25-30€"},{value:"30-40",label:"30-40€"},{value:"40-50",label:"40-50€"},{value:"50+",label:"50€+"}],ls=({restaurantId:h,targetId:y,targetType:n="restaurant"})=>{const o=y||h||"",{t:a}=be(),{user:r}=Ue(),{data:m}=Pe(),{isAdmin:Y}=ze(),{toast:i}=$e(),k=_e(),[d,N]=l.useState(""),[g,T]=l.useState(0),[L,p]=l.useState(0),[f,w]=l.useState(""),[x,v]=l.useState(null),[C,U]=l.useState(""),[P,z]=l.useState(null),[Z,$]=l.useState(null),[B,M]=l.useState(null),[G,E]=l.useState(null),[j,I]=l.useState(!1),[ye,J]=l.useState(!1),[F,O]=l.useState(null),{data:q,isLoading:ke}=Ge(o,n),b=Je(),Q=Qe(),{checkContent:_}=ss(),A=l.useCallback(async s=>{try{const c=s.name.split(".").pop(),S=`${`${r?.id}-${Date.now()}.${c}`}`,{error:se,data:ns}=await K.storage.from("comment-images").upload(S,s);if(se)throw se;const{data:{publicUrl:Ie}}=K.storage.from("comment-images").getPublicUrl(S);return Ie}catch(c){return console.error("Error uploading image:",c),i({title:a("common.error"),description:a("restaurant.imageUploadFailed"),variant:"destructive"}),null}},[r,i,a]),ee=l.useCallback((s,c=!1)=>{const t=s.target.files?.[0];if(t){if(t.size>5*1024*1024){i({title:a("common.error"),description:a("restaurant.imageTooLarge"),variant:"destructive"});return}c?(M(t),E(URL.createObjectURL(t))):(z(t),$(URL.createObjectURL(t)))}},[i,a]),V=l.useCallback((s=!1)=>{s?(M(null),E(null)):(z(null),$(null))},[]),Se=l.useCallback(async()=>{if(!d.trim()||!r)return;if(m?.is_muted){i({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(_(d).hasSensitive){i({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}if(n==="restaurant"&&!g){i({title:a("common.hint","提示"),description:a("toast.pleaseSelectRating"),variant:"warning"});return}I(!0);let c;if(P){const t=await A(P);t&&(c=t)}await b.mutateAsync({targetId:o,targetType:n,content:d,ratingValue:n==="restaurant"?g:void 0,priceRange:n==="restaurant"&&f?f:void 0,imageUrl:c}),N(""),T(0),w(""),z(null),$(null),I(!1)},[d,r,m,n,g,i,a,P,A,b,h,f,_]),Re=l.useCallback(async s=>{if(!C.trim()||!r)return;if(m?.is_muted){i({title:a("common.error"),description:a("restaurant.youAreMuted"),variant:"destructive"});return}if(_(C).hasSensitive){i({title:a("common.error"),description:a("restaurant.sensitiveWordsDetected","评论包含敏感词，请修改后重试"),variant:"destructive"});return}I(!0);let t;if(B){const S=await A(B);S&&(t=S)}await b.mutateAsync({targetId:o,targetType:n,content:C,parentId:s,imageUrl:t}),U(""),v(null),M(null),E(null),I(!1)},[C,r,m,B,A,b,h,n,_,i,a]),Te=l.useCallback(async s=>{await Q.mutateAsync(s),O(null)},[Q]),H=l.memo(({comment:s,isReply:c=!1})=>e.jsxs("div",{className:`flex gap-2 sm:gap-3 ${c?"ml-8 sm:ml-12 mt-3":""}`,children:[e.jsxs(ae,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(te,{src:s.profiles?.avatar_url}),e.jsx(le,{className:"text-xs sm:text-sm",children:s.profiles?.display_name?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-xs sm:text-sm truncate",children:s.profiles?.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground shrink-0",children:Be(new Date(s.created_at),{addSuffix:!0})}),s.edited&&e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:["(",a("restaurant.edited"),")"]}),r?.id===s.user_id&&s.moderation_status==="pending"&&e.jsxs(ne,{variant:"outline",className:"text-yellow-600 border-yellow-500 bg-yellow-50 dark:bg-yellow-950/30 text-xs py-0 h-5",children:[e.jsx(Me,{className:"w-3 h-3 mr-1"}),a("restaurant.commentPending","审核中")]}),r?.id===s.user_id&&s.moderation_status==="flagged"&&e.jsxs(ne,{variant:"outline",className:"text-destructive border-destructive bg-destructive/10 text-xs py-0 h-5",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1"}),a("restaurant.commentFailed","发送失败")]})]}),!c&&s.rating_value&&e.jsxs("div",{className:"flex items-center gap-3 mt-1 mb-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(t=>e.jsx(X,{className:re("w-4 h-4",t<=s.rating_value?"fill-accent text-accent":"text-muted-foreground")},t))}),s.price_range&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(ie,{className:"w-3 h-3"}),e.jsx("span",{children:Ce.find(t=>t.value===s.price_range)?.label})]})]}),e.jsx(ts,{text:s.content,className:"mt-1"}),s.image_url&&e.jsx("img",{src:s.image_url,alt:"Comment attachment",className:"mt-2 rounded-lg max-w-full sm:max-w-sm w-full"}),e.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-2",children:[!c&&r&&!m?.is_muted&&e.jsxs(u,{variant:"ghost",size:"sm",onClick:()=>v(s.id),className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Fe,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("restaurant.reply")})]}),(r?.id===s.user_id||Y)&&e.jsxs(u,{variant:"ghost",size:"sm",onClick:()=>O(s.id),className:"h-7 text-xs text-destructive hover:text-destructive px-2 sm:px-3",children:[e.jsx(ce,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("common.delete")})]}),r?.id!==s.user_id&&e.jsx(es,{targetType:"comment",targetId:s.id,onLoginRequired:()=>J(!0),trigger:e.jsxs(u,{variant:"ghost",size:"sm",className:"h-7 text-xs px-2 sm:px-3",children:[e.jsx(Oe,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden xs:inline",children:a("report.title")})]})})]}),x===s.id&&e.jsx("div",{className:"mt-3 space-y-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(oe,{value:C,onChange:t=>U(t.target.value),placeholder:a("restaurant.writeReply"),className:"min-h-[80px] text-sm"}),G&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:G,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(u,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>V(!0),children:e.jsx(me,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex sm:flex-col gap-2",children:[e.jsx(u,{size:"sm",onClick:()=>Re(s.id),disabled:!C.trim()||j,className:"text-xs",children:a(j?"common.loading":"restaurant.reply")}),e.jsx(de,{type:"file",accept:"image/*",onChange:t=>ee(t,!0),className:"hidden",id:`reply-image-${s.id}`,disabled:j}),e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>document.getElementById(`reply-image-${s.id}`)?.click(),disabled:j,className:"text-xs sm:px-3",children:[e.jsx(xe,{className:"h-4 w-4 sm:mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>{v(null),U(""),V(!0)},className:"text-xs",children:a("common.cancel")})]})]})}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3",children:s.replies.map(t=>e.jsx(H,{comment:t,isReply:!0},t.id))})]})]}));return H.displayName="CommentItem",ke?e.jsx("div",{className:"text-center py-8",children:a("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 sm:w-5 h-4 sm:h-5"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold",children:[a("restaurant.reviews")," (",q?.length||0,")"]})]}),r?m?.is_muted?e.jsx(R,{className:"border-yellow-300 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(D,{className:"py-4 sm:py-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex items-center gap-3 text-yellow-600 dark:text-yellow-400",children:[e.jsx(Ve,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:a("restaurant.youAreMutedNotice")})]})})}):e.jsx(R,{children:e.jsx(D,{className:"pt-4 sm:pt-6 px-3 sm:px-6",children:e.jsxs("div",{className:"flex gap-2 sm:gap-3",children:[e.jsxs(ae,{className:"w-8 h-8 sm:w-10 sm:h-10 shrink-0",children:[e.jsx(te,{src:m?.avatar_url||void 0}),e.jsx(le,{className:"text-xs sm:text-sm",children:m?.display_name?.charAt(0).toUpperCase()||r?.email?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 space-y-2 sm:space-y-3 min-w-0",children:[n==="restaurant"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4 text-accent"}),"评分 ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onMouseEnter:()=>p(s),onMouseLeave:()=>p(0),onClick:()=>T(s),className:"transition-transform hover:scale-110",children:e.jsx(X,{className:re("w-7 h-7 cursor-pointer transition-colors",s<=(L||g)?"fill-accent text-accent":"text-muted-foreground hover:text-accent")})},s)),g>0&&e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",g,"/5)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4"}),a("restaurant.priceRange")]}),e.jsxs(He,{value:f,onValueChange:w,children:[e.jsx(We,{className:"w-full",children:e.jsx(Xe,{placeholder:a("restaurant.selectPriceRange")})}),e.jsx(Ke,{className:"bg-background",children:Ce.map(s=>e.jsx(Ye,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsx(oe,{value:d,onChange:s=>N(s.target.value),placeholder:a("restaurant.writeComment"),className:"min-h-[80px] sm:min-h-[100px] text-sm"}),Z&&e.jsxs("div",{className:"relative inline-block max-w-full",children:[e.jsx("img",{src:Z,alt:"Preview",className:"max-w-full sm:max-w-xs rounded-lg"}),e.jsx(u,{size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full",onClick:()=>V(!1),children:e.jsx(me,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(de,{type:"file",accept:"image/*",onChange:s=>ee(s,!1),className:"hidden",id:"comment-image",disabled:j}),e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>document.getElementById("comment-image")?.click(),disabled:j,className:"text-xs",children:[e.jsx(xe,{className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:a("restaurant.addImage")})]}),e.jsx(u,{onClick:Se,disabled:!d.trim()||b.isPending||j,size:"sm",className:"text-xs",children:j||b.isPending?a("common.loading"):a("restaurant.postComment")})]})]})]})})}):e.jsx(R,{children:e.jsx(D,{className:"py-4 sm:py-6 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.signInToComment")})}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:q?.map(s=>e.jsx(R,{children:e.jsx(Ze,{className:"p-3 sm:p-6",children:e.jsx(H,{comment:s})})},s.id))}),q?.length===0&&e.jsx(R,{children:e.jsx(D,{className:"py-8 sm:py-12 px-3 sm:px-6 text-center text-muted-foreground text-sm",children:a("restaurant.noComments")})})]}),e.jsx(ue,{open:ye,onOpenChange:J,children:e.jsxs(he,{children:[e.jsxs(ge,{children:[e.jsx(pe,{children:a("activities.loginRequired")}),e.jsx(je,{children:a("activities.loginRequiredMessage")})]}),e.jsxs(fe,{children:[e.jsx(ve,{children:a("common.cancel")}),e.jsx(Ne,{onClick:()=>k("/auth"),children:a("activities.goToLogin")})]})]})}),e.jsx(ue,{open:!!F,onOpenChange:s=>!s&&O(null),children:e.jsxs(he,{className:"max-w-sm",children:[e.jsxs(ge,{children:[e.jsx("div",{className:"mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(ce,{className:"h-7 w-7 text-destructive"})}),e.jsx(pe,{className:"text-center",children:a("restaurant.deleteComment")}),e.jsx(je,{className:"text-center",children:a("restaurant.confirmDelete")})]}),e.jsxs(fe,{className:"sm:justify-center gap-2",children:[e.jsx(ve,{className:"sm:w-24",children:a("common.cancel")}),e.jsx(Ne,{onClick:()=>F&&Te(F),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 sm:w-24",children:a("common.delete")})]})]})})]})},xs=Object.freeze(Object.defineProperty({__proto__:null,default:ls},Symbol.toStringTag,{value:"Module"}));export{ls as R,as as T,xs as a};
//# sourceMappingURL=RestaurantComments-a5U0VBKD.js.map
