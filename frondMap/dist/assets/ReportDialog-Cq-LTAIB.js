import{s as ge,q as Z,v as ee,p as ve,r as m,j as e,bt as xe,X as Y,bS as je,w as o}from"./vendor-react-D8EXe6Pj.js";import{u as K,s as p,f as re,D as ye,W as Ce,B as w,b as we,c as _e,d as be,T as Ne,U,a1 as Se,a2 as De,a3 as Ee,a4 as Ue,a5 as Ie,a7 as qe,I as V,A as Ae,t as Fe,v as Te,w as ke,x as Re,y as Pe,z as ze,E as $e}from"./index-Flvc7LYa.js";import{I as Me,a as Le,b as $}from"./input-otp-BLKCA3Ck.js";const te=new Set,Oe=(d,y="restaurant",C)=>{const{user:l}=K();return ge({queryKey:["comments",d,y],enabled:C?.enabled!==!1&&!!d,queryFn:async()=>{let r=p.from("comments").select("*").eq("target_id",d).eq("target_type",y).order("created_at",{ascending:!1});const{data:n,error:N}=await r;if(N)throw N;if(!n||n.length===0)return[];const v=n.filter(s=>s.moderation_status==="approved"||l&&s.user_id===l.id&&s.moderation_status==="pending"||l&&s.user_id===l.id&&s.moderation_status==="flagged"&&te.has(s.id)),I=[...new Set(v.map(s=>s.user_id))],{data:_}=await p.rpc("get_public_profiles",{user_ids:I}),u=new Map((_||[]).map(s=>[s.id,{display_name:s.display_name,avatar_url:s.avatar_url}])),f=v.filter(s=>!s.parent_id),x=v.filter(s=>s.parent_id),j=new Map;return x.forEach(s=>{const i=s.parent_id;j.has(i)||j.set(i,[]),j.get(i).push(s)}),f.map(s=>({...s,moderation_status:s.moderation_status,profiles:u.get(s.user_id),replies:(j.get(s.id)||[]).sort((i,q)=>new Date(i.created_at).getTime()-new Date(q.created_at).getTime()).map(i=>({...i,moderation_status:i.moderation_status,profiles:u.get(i.user_id)}))}))},staleTime:3e4})},He=()=>{const{user:d}=K(),{toast:y}=re(),C=Z();return ee({mutationFn:async({targetId:l,targetType:r,content:n,ratingValue:N,priceRange:v,imageUrl:I,parentId:_})=>{if(!d)throw new Error("User not authenticated");const u={user_id:d.id,target_id:l,target_type:r,content:n,parent_id:_,moderation_status:"pending"};_||(N&&(u.rating_value=N),v&&(u.price_range=v)),I&&(u.image_url=I);const{data:f,error:x}=await p.from("comments").insert(u).select().single();if(x)throw x;try{const{data:j,error:g}=await p.functions.invoke("moderate-comment",{body:{comment_id:f.id,content:n,user_id:d.id,sensitive_word_detected:!1,target_id:l,target_type:r}});g&&(console.error("AI moderation error:",g),await p.from("comments").update({moderation_status:"approved"}).eq("id",f.id))}catch(j){console.error("Failed to invoke AI moderation:",j),await p.from("comments").update({moderation_status:"approved"}).eq("id",f.id)}return f},onSuccess:(l,r)=>{l?.id&&te.add(l.id),C.invalidateQueries({queryKey:["comments",r.targetId,r.targetType]}),C.invalidateQueries({queryKey:["restaurants"]}),C.invalidateQueries({queryKey:["restaurant",r.targetId]})},onError:()=>{y({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Be=()=>{const{toast:d}=re(),y=Z();return ee({mutationFn:async C=>{const{error:l}=await p.from("comments").delete().eq("id",C);if(l)throw l},onSuccess:()=>{y.invalidateQueries({queryKey:["comments"]}),d({title:"Success",description:"Comment deleted successfully"})},onError:()=>{d({title:"Error",description:"Failed to delete comment",variant:"destructive"})}})},We=({targetType:d,targetId:y,trigger:C,onLoginRequired:l})=>{const{t:r}=ve(),{user:n}=K(),[N,v]=m.useState(!1),[I,_]=m.useState(!1),[u,f]=m.useState(!1),[x,j]=m.useState(""),[g,s]=m.useState(""),[i,q]=m.useState(n?.email||""),[b,T]=m.useState([""]),[A,M]=m.useState([]),[O,H]=m.useState(!1),[L,F]=m.useState("form"),[k,R]=m.useState(""),[S,Q]=m.useState(0),[B,W]=m.useState(!1),se=t=>{if(t&&!n){l?.();return}v(t),t&&n?.email&&q(n.email),t||(F("form"),R(""),Q(0))};m.useEffect(()=>{let t;return S>0&&(t=setTimeout(()=>Q(S-1),1e3)),()=>clearTimeout(t)},[S]);const ae=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],ie=()=>{T([...b,""])},oe=t=>{T(b.filter((a,c)=>c!==t))},ne=(t,a)=>{const c=[...b];c[t]=a,T(c)},le=t=>{const a=Array.from(t.target.files||[]);if(a.filter(h=>h.size>5*1024*1024).length>0){o.error(r("report.imageTooLarge"));return}const D=["image/jpeg","image/png","image/webp","image/gif"];if(a.filter(h=>!D.includes(h.type)).length>0){o.error(r("report.invalidImageType"));return}M(h=>[...h,...a])},ce=t=>{M(a=>a.filter((c,D)=>D!==t))},de=async()=>{if(A.length===0)return[];H(!0);const t=[];try{for(const a of A){const c=a.name.split(".").pop(),E=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${c}`}`,{error:h}=await p.storage.from("report-evidence").upload(E,a);if(h)throw h;const{data:P}=p.storage.from("report-evidence").getPublicUrl(E);t.push(P.publicUrl)}return t}catch(a){throw console.error("Error uploading images:",a),a}finally{H(!1)}},G=async()=>{if(!i.trim()){o.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){o.error(r("report.invalidEmail"));return}W(!0);try{const{error:t}=await p.functions.invoke("send-verification-code",{body:{email:i}});if(t){o.error(r("auth.verificationCodeFailed")),console.error(t);return}F("verify"),o.success(r("auth.verificationCodeSent")),Q(30)}catch(t){o.error(t.message||r("error.general"))}finally{W(!1)}},ue=async()=>{S>0||await G()},me=async()=>{if(k.length!==4){o.error(r("auth.invalidVerificationCode"));return}f(!0);try{const{data:t,error:a}=await p.functions.invoke("verify-email-code",{body:{email:i,code:k}});if(a||!t?.success){t?.error==="This verification code has already been used"?o.error(r("auth.verificationCodeUsed")):o.error(t?.error||r("auth.invalidVerificationCode")),f(!1);return}F("submitting"),await X()}catch(t){o.error(t.message||r("error.general")),f(!1)}},pe=async()=>{if(!x){o.error(r("report.reasonPlaceholder"));return}if(!g||g.length<20){o.error(r("report.detailsMin"));return}if(!i.trim()){o.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){o.error(r("report.invalidEmail"));return}if(b.filter(a=>a.trim()!=="").length===0&&A.length===0){o.error(r("report.evidenceRequired"));return}n?_(!0):await G()},X=async()=>{f(!0);try{let t=[];try{t=await de()}catch{o.error(r("report.imageUploadFailed")),f(!1);return}const c=[...b.filter(z=>z.trim()!==""),...t],D={reporter_id:n?.id||null,target_type:d,target_id:y,reason:x,description:g,evidence_urls:c,reporter_contact:i};console.log("Attempting to insert report:",D);const{data:E,error:h}=await p.from("reports").insert(D).select().single();if(console.log("Insert result:",{report:E,error:h}),h)throw h;let P="Anonymous",J=i;if(n){const{data:z}=await p.from("profiles").select("display_name").eq("id",n.id).single();P=z?.display_name||"Unknown",J=n.email||i}await p.functions.invoke("send-report-email",{body:{reportId:E.id,reporterName:P,reporterEmail:J,targetType:d,targetId:y,reason:x,description:g,evidenceUrls:c.length>0?c:void 0,reporterContact:i||void 0}});const he=E.id.substring(0,8).toUpperCase();o.success(r("report.successDetailed",{reference:he}),{description:r("report.successDescription"),duration:8e3}),v(!1),_(!1),j(""),s(""),n||q(""),T([""]),M([]),F("form"),R("")}catch(t){console.error("Error submitting report:",t),o.error(r("report.failed"))}finally{f(!1)}},fe=()=>{switch(d){case"comment":return r("report.reportComment");case"restaurant":return r("report.reportRestaurant");case"activity":return r("report.reportActivity");case"user":return r("report.reportUser");default:return r("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(ye,{open:N,onOpenChange:se,children:[e.jsx(Ce,{asChild:!0,children:C||e.jsxs(w,{variant:"ghost",size:"sm",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),r("report.title")]})}),e.jsxs(we,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(be,{children:fe()}),e.jsx(Ne,{children:r(L==="verify"?"auth.verificationCodeSent":"report.description")})]}),L==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"reason",children:r("report.reason")}),e.jsxs(Se,{value:x,onValueChange:j,children:[e.jsx(De,{children:e.jsx(Ee,{placeholder:r("report.reasonPlaceholder")})}),e.jsx(Ue,{children:ae.map(t=>e.jsx(Ie,{value:t,children:r(`report.reasons.${t}`)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"description",children:r("report.detailsLabel")}),e.jsx(qe,{id:"description",value:g,onChange:t=>s(t.target.value),placeholder:r("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[g.length,"/20 ",r("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"contact",children:[r("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(V,{id:"contact",type:"email",value:i,onChange:t=>q(t.target.value),placeholder:r("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{children:[r("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:r("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{htmlFor:"image-upload",className:"text-sm font-medium",children:r("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:A.map((t,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Evidence ${a+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(w,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>ce(a),children:e.jsx(Y,{className:"w-3 h-3"})})]},a))}),e.jsx(V,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:le,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(U,{className:"text-sm font-medium",children:r("report.evidenceUrls")}),b.map((t,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(V,{value:t,onChange:c=>ne(a,c.target.value),placeholder:r("report.evidencePlaceholder")}),b.length>1&&e.jsx(w,{variant:"ghost",size:"icon",onClick:()=>oe(a),children:e.jsx(Y,{className:"w-4 h-4"})})]},a)),e.jsxs(w,{variant:"outline",size:"sm",onClick:ie,className:"w-full",children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),r("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(w,{variant:"outline",onClick:()=>v(!1),children:r("report.cancel")}),e.jsx(w,{onClick:pe,disabled:!x||g.length<20||!i.trim()||b.filter(t=>t.trim()!=="").length===0&&A.length===0||O||B,children:r(O?"common.uploading":B?"auth.sendingCode":"report.submit")})]})]}):L==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:r("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:r("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Me,{maxLength:4,value:k,onChange:t=>R(t),children:e.jsxs(Le,{children:[e.jsx($,{index:0}),e.jsx($,{index:1}),e.jsx($,{index:2}),e.jsx($,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:r("auth.verificationCodeHint",{email:i})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(w,{variant:"link",size:"sm",onClick:ue,disabled:S>0||u,children:S>0?`${r("auth.resendCode")} (${S}s)`:r("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",className:"w-full",onClick:()=>{F("form"),R("")},disabled:u,children:r("common.back")}),e.jsx(w,{className:"w-full",onClick:me,disabled:k.length!==4||u,children:r(u?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(Ae,{open:I,onOpenChange:_,children:e.jsxs(Fe,{children:[e.jsxs(Te,{children:[e.jsx(ke,{children:r("report.confirmTitle")}),e.jsx(Re,{children:r("report.confirmMessage")})]}),e.jsxs(Pe,{children:[e.jsx(ze,{children:r("report.cancel")}),e.jsx($e,{onClick:X,disabled:u,children:r(u?"report.submitting":"report.submit")})]})]})})]})};export{We as R,He as a,Be as b,Oe as u};
//# sourceMappingURL=ReportDialog-Cq-LTAIB.js.map
