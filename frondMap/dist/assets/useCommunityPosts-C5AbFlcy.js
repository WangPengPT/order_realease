import{s as c,q as d,p as y,v as m,w as o}from"./vendor-react-C7F4V4j9.js";import{u as l,s as i}from"./index-BoYjF4ya.js";const q=e=>{const{user:r}=l();return c({queryKey:["community-posts",e],queryFn:async()=>{let t=i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt)
        `).order("weight",{ascending:!1}).order("created_at",{ascending:!1});e?.authorId&&(t=t.eq("author_id",e.authorId)),e?.status&&(t=t.eq("status",e.status)),e?.limit&&(t=t.limit(e.limit));const{data:s,error:a}=await t;if(a)throw a;if(r&&s){const n=s.map(u=>u.id),{data:_}=await i.from("post_likes").select("post_id").eq("user_id",r.id).in("post_id",n),f=new Set(_?.map(u=>u.post_id)||[]);return s.map(u=>({...u,user_liked:f.has(u.id)}))}return s}})},w=e=>{const{user:r}=l();return c({queryKey:["community-post",e],queryFn:async()=>{const{data:t,error:s}=await i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt)
        `).eq("id",e).single();if(s)throw s;if(r){const{data:a}=await i.from("post_likes").select("id").eq("post_id",e).eq("user_id",r.id).maybeSingle();return{...t,user_liked:!!a}}return t},enabled:!!e})},v=()=>{const e=d(),{t:r}=y();return m({mutationFn:async t=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");const{data:a,error:n}=await i.from("community_posts").insert({author_id:s.id,content:t.content,image_urls:t.image_urls||[],video_url:t.video_url||null,activity_id:t.activity_id||null,restaurant_id:t.restaurant_id||null,status:"pending",moderation_status:"pending"}).select().single();if(n)throw n;return i.functions.invoke("moderate-post",{body:{post_id:a.id,content:t.content,user_id:s.id,image_urls:t.image_urls||[],video_url:t.video_url||null,sensitive_word_detected:t.sensitive_word_detected||!1}}).catch(_=>{console.error("Moderation call failed:",_)}),a},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),o.success(r("community.postPending","帖子已提交，正在审核中"))},onError:t=>{console.error("Create post error:",t),o.error(r("community.postError","发布失败"))}})},g=()=>{const e=d(),{t:r}=y();return m({mutationFn:async({id:t,...s})=>{const{data:a,error:n}=await i.from("community_posts").update(s).eq("id",t).select().single();if(n)throw n;return a},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]}),e.invalidateQueries({queryKey:["admin-community-posts"]}),o.success(r("common.saved","保存成功"))},onError:t=>{console.error("Update post error:",t),o.error(r("common.error","操作失败"))}})},K=()=>{const e=d(),{t:r}=y();return m({mutationFn:async t=>{const{error:s}=await i.from("community_posts").delete().eq("id",t);if(s)throw s},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["admin-community-posts"]}),o.success(r("common.deleted","删除成功"))},onError:t=>{console.error("Delete post error:",t),o.error(r("common.error","操作失败"))}})},k=()=>{const e=d();return m({mutationFn:async({postId:r,liked:t})=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");if(t){const{error:a}=await i.from("post_likes").delete().eq("post_id",r).eq("user_id",s.id);if(a)throw a}else{const{error:a}=await i.from("post_likes").insert({post_id:r,user_id:s.id});if(a)throw a}},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]})}})},C=()=>{const e=d(),{t:r}=y();return m({mutationFn:async t=>{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:a}=await i.from("post_shares").insert({post_id:t,user_id:s.id});if(a)throw a},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]}),o.success(r("community.shared","分享成功"))}})},P=()=>{const{user:e}=l();return c({queryKey:["can-create-post",e?.id],queryFn:async()=>!!e,enabled:!0})},Q=()=>{const{user:e}=l();return c({queryKey:["merchant-restaurant",e?.id],queryFn:async()=>{if(!e)return null;const{data:r}=await i.from("merchant_restaurants").select("restaurant_id, restaurants:restaurant_id(id, name, name_en, name_pt)").eq("user_id",e.id).limit(1).maybeSingle();return r?.restaurants||null},enabled:!!e})},S=()=>{const{user:e}=l();return c({queryKey:["has-posted-today",e?.id],queryFn:async()=>{if(!e)return!1;const r=new Date;r.setHours(0,0,0,0);const t=r.toISOString(),{count:s,error:a}=await i.from("community_posts").select("id",{count:"exact",head:!0}).eq("author_id",e.id).gte("created_at",t);if(a)throw a;return(s??0)>0},enabled:!!e})},F=e=>c({queryKey:["admin-community-posts",e],queryFn:async()=>{let r=i.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt)
        `).order("created_at",{ascending:!1});e?.status&&(r=r.eq("status",e.status)),e?.moderation_status&&(r=r.eq("moderation_status",e.moderation_status)),e?.search&&(r=r.ilike("content",`%${e.search}%`));const{data:t,error:s}=await r;if(s)throw s;return t}});export{g as a,K as b,k as c,v as d,Q as e,S as f,q as g,P as h,C as i,w as j,F as u};
//# sourceMappingURL=useCommunityPosts-C5AbFlcy.js.map
