import{br as $,p as ee,r as se,s as N,j as e,L as ae,bm as te,b8 as re,bM as ie,bg as k,bn as F,b1 as T,b6 as I,bd as ne,cq as le,cr as ce,cs as de,ct as oe,cu as me,cv as xe,cw as he,cy as ue}from"./vendor-react-Hsdnn-sD.js";import{n as h,B as pe,a2 as je,a3 as ge,a4 as fe,a5 as ye,a6 as v,C as c,w as d,v as w,M as _,A as S,h as C,i as q,k as Ne,s as x}from"./index-DNQsNrYF.js";import{b as ve,c as we}from"./useActivities-BHjirLn3.js";import{u as _e}from"./useLocalizedContent-D-CDxH29.js";import{D as g,s as L,f as D}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-BVdpxhZP.js";const ke=()=>{const{id:i}=$(),{t}=ee(),{getLocalizedField:R}=_e(),[m,K]=se.useState("30days"),V=()=>{const s=new Date;switch(m){case"today":return D(s).toISOString();case"7days":return D(L(s,6)).toISOString();case"30days":return D(L(s,29)).toISOString();default:return null}},z=()=>{switch(m){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:A,isLoading:E}=ve(i),{data:H=[]}=we(i),o=V(),{data:f=[],isLoading:O}=N({queryKey:["activity-subscribers",i,m],queryFn:async()=>{let s=x.from("subscriptions").select("user_id, created_at").eq("activity_id",i).order("created_at",{ascending:!1});o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;if(a&&a.length>0){const l=a.map(n=>n.user_id),{data:p}=await x.rpc("get_public_profiles",{user_ids:l});return a.map(n=>({...n,profile:p?.find(j=>j.id===n.user_id)}))}return[]},enabled:!!i}),{data:y=[],isLoading:U}=N({queryKey:["activity-sharers",i,m],queryFn:async()=>{let s=x.from("activity_shares").select("user_id, created_at").eq("activity_id",i).order("created_at",{ascending:!1});o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;if(a&&a.length>0){const l=a.map(n=>n.user_id),{data:p}=await x.rpc("get_public_profiles",{user_ids:l});return a.map(n=>({...n,profile:p?.find(j=>j.id===n.user_id)}))}return[]},enabled:!!i}),{data:u=[],isLoading:B}=N({queryKey:["activity-comments",i,m],queryFn:async()=>{let s=x.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_id",i).eq("target_type","activity").order("created_at",{ascending:!1});o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;if(a&&a.length>0){const l=[...new Set(a.map(n=>n.user_id))],{data:p}=await x.rpc("get_public_profiles",{user_ids:l});return a.map(n=>({...n,profile:p?.find(j=>j.id===n.user_id)}))}return[]},enabled:!!i}),{data:M=[],isLoading:W}=N({queryKey:["activity-page-views",i,m],queryFn:async()=>{let s=x.from("page_views").select("created_at").eq("target_id",i).eq("page_type","activity");o&&(s=s.gte("created_at",o));const{data:a,error:r}=await s;if(r)throw r;return a||[]},enabled:!!i}),G=(()=>{const s=new Map,a=z();for(let r=a-1;r>=0;r--){const l=g(L(new Date,r),"MM-dd");s.set(l,0)}return M.forEach(r=>{const l=g(new Date(r.created_at),"MM-dd");s.has(l)&&s.set(l,(s.get(l)||0)+1)}),Array.from(s.entries()).map(([r,l])=>({date:r,views:l}))})(),P=M.length,Q=f.length,X=y.length,b=u.filter(s=>s.rating_value!==null),Y=b.length>0?(b.reduce((s,a)=>s+(a.rating_value||0),0)/b.length).toFixed(1):"0.0",J=u.length;if(E)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(h,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(h,{className:"h-32"},s))})]});if(!A)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:t("common.notFound")})});const Z=R(A,"title");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(pe,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(ae,{to:"/admin/activity-stats",children:e.jsx(te,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:t("admin.activityStats")}),e.jsx("p",{className:"text-muted-foreground",children:Z})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-12 sm:ml-0",children:[e.jsx(re,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(je,{value:m,onValueChange:s=>K(s),children:[e.jsx(ge,{className:"w-[140px]",children:e.jsx(fe,{})}),e.jsxs(ye,{children:[e.jsx(v,{value:"today",children:t("analytics.today")}),e.jsx(v,{value:"7days",children:t("analytics.last7Days")}),e.jsx(v,{value:"30days",children:t("analytics.last30Days","近30天")}),e.jsx(v,{value:"all",children:t("analytics.allTime","所有时间")})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("analytics.pageViews")})]}),e.jsx("p",{className:"text-2xl font-bold",children:P})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(k,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.favorites")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Q})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.shares")})]}),e.jsx("p",{className:"text-2xl font-bold",children:X})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(T,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("restaurant.rating")})]}),e.jsx("p",{className:"text-2xl font-bold",children:Y})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("restaurant.comments")})]}),e.jsx("p",{className:"text-2xl font-bold",children:J})]})}),e.jsx(c,{children:e.jsxs(d,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t("activities.participatingRestaurants")})]}),e.jsx("p",{className:"text-2xl font-bold",children:H.length})]})})]}),e.jsxs(c,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5"}),t("analytics.viewTrend")]})}),e.jsx(d,{children:e.jsx("div",{className:"h-[300px]",children:W?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(h,{className:"h-full w-full"})}):e.jsx(ce,{width:"100%",height:"100%",children:e.jsxs(de,{data:G,children:[e.jsx(oe,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(me,{dataKey:"date",className:"text-xs",tick:{fontSize:11}}),e.jsx(xe,{className:"text-xs",tick:{fontSize:11}}),e.jsx(he,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(ue,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1})]})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(c,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),t("admin.sharersList","分享用户")," (",y.length,")"]})}),e.jsx(d,{children:U?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(h,{className:"h-12 w-full"},s))}):y.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:y.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:s.profile?.avatar_url}),e.jsx(q,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g(new Date(s.created_at),"yyyy-MM-dd")})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]}),e.jsxs(c,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"}),t("admin.subscribersList","收藏用户")," (",f.length,")"]})}),e.jsx(d,{children:O?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(h,{className:"h-12 w-full"},s))}):f.length>0?e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:f.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:s.profile?.avatar_url}),e.jsx(q,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g(new Date(s.created_at),"yyyy-MM-dd")})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]})]}),e.jsxs(c,{children:[e.jsx(w,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),t("admin.commentsAndRatings","评论与评分")," (",u.length,")"]})}),e.jsx(d,{children:B?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(h,{className:"h-20 w-full"},s))}):u.length>0?e.jsx("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:u.map(s=>e.jsxs("div",{className:"p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:s.profile?.avatar_url}),e.jsx(q,{children:s.profile?.display_name?.charAt(0)||"U"})]}),e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),s.rating_value&&e.jsxs(Ne,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(T,{className:"w-3 h-3 fill-current"}),s.rating_value]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3",children:s.content})]},s.id))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:t("analytics.noData")})})]})]})};export{ke as default};
//# sourceMappingURL=AdminActivityStats-feQfZF1d.js.map
