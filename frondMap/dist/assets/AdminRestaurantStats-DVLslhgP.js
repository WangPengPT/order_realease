import{bj as T,w as U,u as W,r as J,p as _,j as e,d as z,B as b,L as D,S as Z,b as O,af as ee,ag as se,ah as ae,ai as te,aj as C,C as x,f as h,e as S,o as M,an as B,$ as V,a0 as $,a1 as P,n as X,s as f}from"./index-DwrhXWM3.js";import{d as re}from"./useRestaurants-55ingJCa.js";import{u as ne}from"./useLocalizedContent-Csh5LJrs.js";import{C as ie}from"./chevron-left-vFbBE41j.js";import{S as H}from"./star-D5FH4An7.js";import{E as de}from"./external-link-D1Xzfm_Q.js";import{S as le}from"./square-pen-DqUDspQ2.js";import{E as ce}from"./eye-D3AyRO7x.js";import{M as Y}from"./message-circle-cHjzR6BQ.js";import{H as G}from"./heart-CaMSA8jY.js";import{T as oe}from"./trending-up-CcInDeI7.js";import{R as me,L as xe,C as he,X as ue,Y as ge,T as je,b as pe}from"./LineChart-BN2fbdP5.js";import{s as q}from"./subDays-USzpjx9O.js";import{f as u}from"./format-BrDZPov3.js";import{s as I}from"./startOfDay-C97cAIwM.js";import"./isEqual-D_z53ADz.js";function Q(n,a){const y=T(n.start),l=T(n.end);let v=+y>+l;const R=v?+y:+l,m=v?l:y;m.setHours(0,0,0,0);let o=1;const N=[];for(;+m<=R;)N.push(T(m)),m.setDate(m.getDate()+o),m.setHours(0,0,0,0);return v?N.reverse():N}const Ie=()=>{const{id:n}=U(),{t:a}=W(),{localizeRestaurant:y}=ne(),[l,v]=J.useState("30days"),R=()=>{const s=new Date;switch(l){case"today":return I(s).toISOString();case"7days":return I(q(s,6)).toISOString();case"30days":return I(q(s,29)).toISOString();default:return null}},m=()=>{switch(l){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:o,isLoading:N}=re(n),p=R(),{data:L=[],isLoading:fe}=_({queryKey:["restaurant-page-views",n,l],queryFn:async()=>{let s=f.from("page_views").select("created_at").eq("page_type","restaurant").eq("target_id",n);p&&(s=s.gte("created_at",p));const{data:t,error:r}=await s;if(r)throw r;return t},enabled:!!n}),{data:g=[],isLoading:ye}=_({queryKey:["restaurant-comments",n,l],queryFn:async()=>{let s=f.from("comments").select("id, user_id, content, rating_value, created_at").eq("target_type","restaurant").eq("target_id",n).order("created_at",{ascending:!1});p&&(s=s.gte("created_at",p));const{data:t,error:r}=await s;if(r)throw r;if(t&&t.length>0){const c=[...new Set(t.map(i=>i.user_id))],{data:d}=await f.rpc("get_public_profiles",{user_ids:c});return t.map(i=>({...i,profile:d==null?void 0:d.find(j=>j.id===i.user_id)}))}return[]},enabled:!!n}),{data:w=[],isLoading:ve}=_({queryKey:["restaurant-favorites",n,l],queryFn:async()=>{let s=f.from("favorites").select("user_id, created_at").eq("restaurant_id",n);p&&(s=s.gte("created_at",p));const{data:t,error:r}=await s;if(r)throw r;if(t&&t.length>0){const c=t.map(i=>i.user_id),{data:d}=await f.rpc("get_public_profiles",{user_ids:c});return t.map(i=>({...i,profile:d==null?void 0:d.find(j=>j.id===i.user_id)}))}return[]},enabled:!!n}),{data:A=[]}=_({queryKey:["restaurant-activities",n],queryFn:async()=>{const{data:s,error:t}=await f.from("activity_restaurants").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            status
          )
        `).eq("restaurant_id",n);if(t)throw t;return(s==null?void 0:s.map(r=>r.activities).filter(Boolean))||[]},enabled:!!n}),E=(()=>{if(l==="all"){const t=new Date,r=q(t,29);return Q({start:r,end:t}).map(d=>{const i=u(d,"yyyy-MM-dd"),j=L.filter(k=>u(new Date(k.created_at),"yyyy-MM-dd")===i).length;return{date:i,views:j}})}else{const s=m(),t=new Date,r=q(t,s-1);return Q({start:r,end:t}).map(d=>{const i=u(d,"yyyy-MM-dd"),j=L.filter(k=>u(new Date(k.created_at),"yyyy-MM-dd")===i).length;return{date:i,views:j}})}})(),K=g.length>0?g.filter(s=>s.rating_value).reduce((s,t)=>s+(t.rating_value||0),0)/g.filter(s=>s.rating_value).length:0,F=o?y(o):null;return N?e.jsxs("div",{className:"space-y-6",children:[e.jsx(z,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(z,{className:"h-24"},s))}),e.jsx(z,{className:"h-64"})]}):!o||!F?e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"text-muted-foreground",children:a("error.notFound")})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(b,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(D,{to:"/admin/restaurant-stats",children:e.jsx(ie,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[o.image_url?e.jsx("img",{src:o.image_url,alt:F.name,className:"w-12 h-12 rounded-lg object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(Z,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:F.name}),o.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(H,{className:"h-3 w-3 fill-amber-400 text-amber-400"}),e.jsx("span",{children:o.rating.toFixed(1)})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(ee,{value:l,onValueChange:s=>v(s),children:[e.jsx(se,{className:"w-[140px]",children:e.jsx(ae,{})}),e.jsxs(te,{children:[e.jsx(C,{value:"today",children:a("analytics.today","今日")}),e.jsx(C,{value:"7days",children:a("analytics.last7Days","近7天")}),e.jsx(C,{value:"30days",children:a("analytics.last30Days","近30天")}),e.jsx(C,{value:"all",children:a("analytics.allTime","所有时间")})]})]}),e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(D,{to:`/restaurant/${n}`,target:"_blank",children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),a("admin.preview","预览")]})}),e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(D,{to:"/admin/restaurants",state:{editRestaurantId:n},children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),a("admin.edit","编辑")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx(ce,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.views","浏览量")}),e.jsx("p",{className:"text-2xl font-bold",children:L.length})]})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx(Y,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.comments","评论")}),e.jsx("p",{className:"text-2xl font-bold",children:g.length})]})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg",children:e.jsx(G,{className:"h-5 w-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.favorites","收藏")}),e.jsx("p",{className:"text-2xl font-bold",children:w.length})]})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/10 rounded-lg",children:e.jsx(H,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.avgRating","平均评分")}),e.jsx("p",{className:"text-2xl font-bold",children:K>0?K.toFixed(1):"-"})]})]})})})]}),e.jsxs(x,{children:[e.jsx(S,{children:e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),a("admin.viewTrend","浏览趋势")]})}),e.jsx(h,{children:e.jsx("div",{className:"h-[300px]",children:E.length>0?e.jsx(me,{width:"100%",height:"100%",children:e.jsxs(xe,{data:E,children:[e.jsx(he,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(ue,{dataKey:"date",tickFormatter:s=>u(new Date(s),"MM/dd"),className:"text-xs"}),e.jsx(ge,{className:"text-xs"}),e.jsx(je,{labelFormatter:s=>u(new Date(s),"yyyy-MM-dd"),contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(pe,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,name:a("admin.views")})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:a("analytics.noData")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(x,{children:[e.jsxs(S,{children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),a("admin.recentComments","最近评论")]}),e.jsx(B,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(g.length,10)})})]}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[g.slice(0,10).map(s=>{var t,r,c,d;return e.jsxs("div",{className:"flex gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(V,{className:"h-8 w-8",children:[e.jsx($,{src:(t=s.profile)==null?void 0:t.avatar_url}),e.jsx(P,{children:((c=(r=s.profile)==null?void 0:r.display_name)==null?void 0:c[0])||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:((d=s.profile)==null?void 0:d.display_name)||a("common.anonymous")}),s.rating_value&&e.jsxs(X,{variant:"secondary",className:"text-xs",children:[e.jsx(H,{className:"h-3 w-3 mr-1 fill-amber-400 text-amber-400"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:u(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},s.id)}),g.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noComments","暂无评论")})]})})]}),e.jsxs(x,{children:[e.jsxs(S,{children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5"}),a("admin.recentFavorites","最近收藏")]}),e.jsx(B,{children:a("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(w.length,10)})})]}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:[w.slice(0,10).map((s,t)=>{var r,c,d,i;return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(V,{className:"h-8 w-8",children:[e.jsx($,{src:(r=s.profile)==null?void 0:r.avatar_url}),e.jsx(P,{children:((d=(c=s.profile)==null?void 0:c.display_name)==null?void 0:d[0])||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm",children:((i=s.profile)==null?void 0:i.display_name)||a("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},t)}),w.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:a("admin.noFavorites","暂无收藏")})]})})]})]}),e.jsxs(x,{children:[e.jsx(S,{children:e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),a("admin.participatingActivities","参与的活动")]})}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[A.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.title_zh||s.title_en}),e.jsx(X,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?a("admin.published","已发布"):a("admin.draft","草稿")})]}),e.jsx(b,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:e.jsx(D,{to:`/admin/activity-stats/${s.id}`,children:a("admin.viewStats","查看统计")})})]},s.id)),A.length===0&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:a("admin.noActivities","暂未参与活动")})]})})]})]})};export{Ie as default};
