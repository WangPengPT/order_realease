import{p as $,u as Oe,r as i,j as e,cX as $e,cl as He,bg as ze,bF as ge,bE as X,bh as Ve,ao as qe,e7 as C,b7 as fe,e8 as je,a4 as M,b1 as ye,b8 as Ne,e9 as Be,ea as Ge,bN as We,aM as ue,X as xe,bj as Qe,cK as Ke,w as F,q as Xe,bS as he}from"./vendor-react-D8EXe6Pj.js";import{u as Je,P as Ye,Q as Ze,R as es,D as ss,W as ts,b as as,c as rs,d as ns,e as g,j as J,I as is,B as O,S as ve,G as os,ae as ls,aj as cs,af as ds,ak as ms,a7 as us,s as A,i as V}from"./index-Flvc7LYa.js";import{c as xs,d as hs,e as ps,f as gs,g as fs,h as js}from"./useCommunityPosts-CTU42mAQ.js";import{u as K}from"./useLocalizedContent-Dnd9g27T.js";import{c as ys}from"./usePoints-C5bYm35M.js";import{D as Y,b as Z,c as ee,d as se,e as be}from"./drawer-wLuvGy9A.js";import{P as te,a as ae,b as re}from"./popover-Bafg368u.js";import{u as Ns}from"./useActivities-77tU6bJN.js";import{u as vs}from"./useRestaurants-D4SUPVOp.js";import{P as bs}from"./PullToRefresh-BbyXgC5p.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-BzOCmhQX.js";const ws=({post:s})=>{const{t}=$(),{user:a}=Je(),p=Oe(),{getLocalizedField:m}=K(),l=xs(),[b,c]=i.useState(!1),f=k=>{k.preventDefault(),k.stopPropagation(),a&&l.mutate({postId:s.id,liked:s.user_liked||!1})},N=()=>{p(`/community/${s.id}`)},u=k=>new DOMParser().parseFromString(k,"text/html").body.textContent||"",x=m(s,"content"),j=u(x),R=s.image_urls&&s.image_urls.length>0,w=!!s.video_url,n=R||w,S=s.image_urls?.length||0;return e.jsxs("div",{className:"group cursor-pointer rounded-lg overflow-hidden bg-card border border-border/50 hover:shadow-lg transition-all duration-300 hover:-translate-y-1",onClick:N,children:[n&&e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden",children:[R?b?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:t("common.imageLoadError","å›¾ç‰‡åŠ è½½å¤±è´¥")})}):e.jsx("img",{src:s.image_urls[0],alt:"",className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",onError:()=>c(!0)}):w?e.jsx("video",{src:s.video_url,className:"w-full h-full object-cover",preload:"metadata",muted:!0,playsInline:!0}):null,w&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-black/50 backdrop-blur-sm flex items-center justify-center",children:e.jsx($e,{className:"h-5 w-5 text-white fill-white ml-0.5"})})}),!w&&S>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full z-10 flex items-center gap-1",children:[e.jsx(He,{className:"h-3 w-3"}),e.jsx("span",{children:S})]})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:`text-sm font-medium line-clamp-2 leading-relaxed ${n?"":"min-h-[60px]"}`,children:j}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(Ye,{className:"h-5 w-5 flex-shrink-0",children:[e.jsx(Ze,{src:s.author?.avatar_url||void 0}),e.jsx(es,{className:"text-[10px]",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:s.author?.display_name})]}),e.jsxs("button",{className:`flex items-center gap-1 text-xs ${s.user_liked?"text-red-500":"text-muted-foreground"} hover:text-red-500 transition-colors`,onClick:f,disabled:!a,children:[e.jsx(ze,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count||0})]})]})]})]})},ks=()=>{const{t:s}=$(),{data:t}=ys(),a=t?.find(l=>l.key==="post_points")?.value||"5",p=t?.find(l=>l.key==="min_post_length")?.value||"10",m=t?.find(l=>l.key==="post_require_media")?.value==="true";return e.jsxs(ss,{children:[e.jsx(ts,{asChild:!0,children:e.jsx("button",{className:"text-primary hover:underline text-sm whitespace-nowrap",children:s("community.viewPointsRules","æŸ¥çœ‹è¯¦ç»†è§„åˆ™")})}),e.jsxs(as,{className:"max-w-md",children:[e.jsx(rs,{children:e.jsxs(ns,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),s("community.pointsRulesTitle","å‘å¸–ç§¯åˆ†è§„åˆ™")]})}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:s("community.pointsRulesIntro","é€šè¿‡å‘å¸ƒç¤¾åŒºå¸–å­è·å¾—ç§¯åˆ†ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š")}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(X,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.rulePostPoints",{points:a})})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(X,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleMinLength",{length:p})})]}),m&&e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(X,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleRequireMedia","å¸–å­å¿…é¡»åŒ…å«è‡³å°‘ä¸€å¼ å›¾ç‰‡æˆ–ä¸€ä¸ªè§†é¢‘")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ve,{className:"h-4 w-4 text-blue-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleDailyLimit","æ¯å¤©ä»…å¯é€šè¿‡å‘å¸–è·å¾—ä¸€æ¬¡ç§¯åˆ†å¥–åŠ±")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(qe,{className:"h-4 w-4 text-purple-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleModerationRequired","å¸–å­éœ€é€šè¿‡å®¡æ ¸åæ‰èƒ½è·å¾—ç§¯åˆ†")})]})]})]})]})]})},ne=i.forwardRef(({className:s,...t},a)=>e.jsx(C,{ref:a,className:g("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...t}));ne.displayName=C.displayName;const we=i.forwardRef(({className:s,...t},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(fe,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(C.Input,{ref:a,className:g("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...t})]}));we.displayName=C.Input.displayName;const ie=i.forwardRef(({className:s,...t},a)=>e.jsx(C.List,{ref:a,className:g("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...t}));ie.displayName=C.List.displayName;const ke=i.forwardRef((s,t)=>e.jsx(C.Empty,{ref:t,className:"py-6 text-center text-sm",...s}));ke.displayName=C.Empty.displayName;const oe=i.forwardRef(({className:s,...t},a)=>e.jsx(C.Group,{ref:a,className:g("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...t}));oe.displayName=C.Group.displayName;const Cs=i.forwardRef(({className:s,...t},a)=>e.jsx(C.Separator,{ref:a,className:g("-mx-1 h-px bg-border",s),...t}));Cs.displayName=C.Separator.displayName;const B=i.forwardRef(({className:s,...t},a)=>e.jsx(C.Item,{ref:a,className:g("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",s),...t}));B.displayName=C.Item.displayName;const Rs=({open:s,onOpenChange:t,value:a,onSelect:p,restaurants:m,showNoneOption:l=!0,required:b=!1})=>{const{t:c}=$(),{getLocalizedField:f}=K(),N=J(),[u,x]=i.useState(""),[j,R]=i.useState(a),[w,n]=i.useState("85vh");i.useEffect(()=>{if(!s||!N)return;const r=window.visualViewport;if(!r){n("85vh");return}const P=()=>{const E=r.height,U=Math.min(E*.85,E-50);n(`${U}px`)};return P(),r.addEventListener("resize",P),()=>{r.removeEventListener("resize",P)}},[s,N]);const S=r=>{r&&(R(a),x("")),t(r)},k=m?.filter(r=>{if(!u)return!0;const P=f(r,"name")?.toLowerCase()||"",E=r.address?.toLowerCase()||"",U=u.toLowerCase();return P.includes(U)||E.includes(U)})||[],L=()=>{if(!a)return"";const r=m?.find(P=>P.id===a);return r?f(r,"name"):""},H=()=>{p(j),t(!1),x("")},z=r=>{p(r),t(!1),x("")},q=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>S(!0),children:[a?e.jsx("span",{className:"text-primary",children:L()}):e.jsxs("span",{className:"text-muted-foreground",children:[c("community.linkRestaurant","å…³è”é¤å…"),b&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(je,{className:"h-4 w-4 opacity-50"})]});return N?e.jsxs(e.Fragment,{children:[q,e.jsx(Y,{open:s,onOpenChange:S,children:e.jsxs(Z,{className:"flex flex-col",style:{height:w,maxHeight:w,transition:"height 0.15s ease-out, max-height 0.15s ease-out"},children:[e.jsx(ee,{className:"pb-2 shrink-0",children:e.jsx(se,{children:c("community.selectRestaurant","é€‰æ‹©é¤å…")})}),e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(is,{placeholder:c("community.searchRestaurant","æœç´¢é¤å…..."),value:u,onChange:r=>x(r.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 min-h-0",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[l&&e.jsxs("div",{className:g("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",j===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>R(""),children:[e.jsx(M,{className:g("h-4 w-4 shrink-0",j===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:c("community.noRestaurantLink","ä¸å…³è”é¤å…")})]}),k.map(r=>e.jsxs("div",{className:g("flex items-start gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",j===r.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>R(r.id),children:[e.jsx(M,{className:g("h-4 w-4 shrink-0 mt-0.5",j===r.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:f(r,"name")}),r.address&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate flex items-center gap-1 mt-0.5",children:[e.jsx(ye,{className:"h-3 w-3 shrink-0"}),r.address]})]})]},r.id)),k.length===0&&u&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:c("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")})]})}),e.jsx(be,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(O,{variant:"outline",className:"flex-1",onClick:()=>S(!1),children:c("common.cancel","å–æ¶ˆ")}),e.jsx(O,{className:"flex-1",onClick:H,children:c("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(te,{open:s,onOpenChange:S,children:[e.jsx(ae,{asChild:!0,children:q}),e.jsx(re,{className:"w-72 p-0",align:"start",children:e.jsxs(ne,{shouldFilter:!1,children:[e.jsx(we,{placeholder:c("community.searchRestaurant","æœç´¢é¤å…..."),value:u,onValueChange:x}),e.jsxs(ie,{children:[e.jsx(ke,{children:c("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")}),e.jsxs(oe,{children:[l&&e.jsxs(B,{value:"none",onSelect:()=>z(""),children:[e.jsx(M,{className:g("mr-2 h-4 w-4",a?"opacity-0":"opacity-100")}),c("community.noRestaurantLink","ä¸å…³è”é¤å…")]}),k.map(r=>e.jsxs(B,{value:r.id,onSelect:()=>z(r.id),children:[e.jsx(M,{className:g("mr-2 h-4 w-4",a===r.id?"opacity-100":"opacity-0")}),f(r,"name")]},r.id))]})]})]})})]})},Ss=({open:s,onOpenChange:t,value:a,onSelect:p,activities:m})=>{const{t:l}=$(),{getLocalizedField:b}=K(),c=J(),[f,N]=i.useState(a),u=n=>{n&&N(a),t(n)},x=()=>{if(!a)return"";const n=m?.find(S=>S.id===a);return n?b(n,"title"):""},j=()=>{p(f),t(!1)},R=n=>{p(n),t(!1)},w=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>u(!0),children:[a?e.jsx("span",{className:"text-primary",children:x()}):e.jsx("span",{className:"text-muted-foreground",children:l("community.linkActivity","å…³è”æ´»åŠ¨")}),e.jsx(je,{className:"h-4 w-4 opacity-50"})]});return c?e.jsxs(e.Fragment,{children:[w,e.jsx(Y,{open:s,onOpenChange:u,children:e.jsxs(Z,{className:"max-h-[85vh] flex flex-col",children:[e.jsx(ee,{className:"pb-2",children:e.jsx(se,{children:l("community.selectActivity","é€‰æ‹©æ´»åŠ¨")})}),e.jsx(ve,{className:"flex-1 px-4",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:g("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",f===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>N(""),children:[e.jsx(M,{className:g("h-4 w-4 shrink-0",f===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:l("community.noActivity","ä¸å…³è”æ´»åŠ¨")})]}),m.map(n=>e.jsxs("div",{className:g("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",f===n.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>N(n.id),children:[e.jsx(M,{className:g("h-4 w-4 shrink-0",f===n.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:b(n,"title")})]})]},n.id)),m.length===0&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:l("activities.noActivities","æš‚æ— å¯ç”¨æ´»åŠ¨")})]})}),e.jsx(be,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(O,{variant:"outline",className:"flex-1",onClick:()=>u(!1),children:l("common.cancel","å–æ¶ˆ")}),e.jsx(O,{className:"flex-1",onClick:j,children:l("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(te,{open:s,onOpenChange:u,children:[e.jsx(ae,{asChild:!0,children:w}),e.jsx(re,{className:"w-72 p-0",align:"start",children:e.jsx(ne,{children:e.jsx(ie,{children:e.jsxs(oe,{children:[e.jsxs(B,{value:"none",onSelect:()=>R(""),children:[e.jsx(M,{className:g("mr-2 h-4 w-4",a?"opacity-0":"opacity-100")}),l("community.noActivity","ä¸å…³è”æ´»åŠ¨")]}),m.map(n=>e.jsxs(B,{value:n.id,onSelect:()=>R(n.id),children:[e.jsx(M,{className:g("mr-2 h-4 w-4",a===n.id?"opacity-100":"opacity-0")}),b(n,"title")]},n.id))]})})})})]})},pe=[{name:"smileys",emojis:["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ¤£","ğŸ˜‚","ğŸ™‚","ğŸ˜Š","ğŸ˜‡","ğŸ¥°","ğŸ˜","ğŸ¤©","ğŸ˜˜","ğŸ˜—","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ¤‘","ğŸ¤—","ğŸ¤­","ğŸ¤«","ğŸ¤”","ğŸ¤","ğŸ¤¨","ğŸ˜","ğŸ˜‘","ğŸ˜¶","ğŸ˜","ğŸ˜’","ğŸ™„","ğŸ˜¬","ğŸ¤¥","ğŸ˜Œ","ğŸ˜”","ğŸ˜ª","ğŸ¤¤","ğŸ˜´","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤®","ğŸ¥µ","ğŸ¥¶","ğŸ¥´","ğŸ˜µ","ğŸ¤¯","ğŸ¤ ","ğŸ¥³","ğŸ˜","ğŸ¤“","ğŸ§"]},{name:"gestures",emojis:["ğŸ‘","ğŸ‘","ğŸ‘Œ","ğŸ¤Œ","âœŒï¸","ğŸ¤","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","â˜ï¸","âœ‹","ğŸ¤š","ğŸ–ï¸","ğŸ––","ğŸ‘‹","ğŸ¤","ğŸ™","ğŸ’ª","ğŸ¦¾","ğŸ¦¿","ğŸ¦µ","ğŸ¦¶","ğŸ‘‚","ğŸ¦»","ğŸ‘ƒ","ğŸ§ ","ğŸ‘€","ğŸ‘ï¸","ğŸ‘…","ğŸ‘„"]},{name:"food",emojis:["ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥¬","ğŸ¥’","ğŸŒ¶ï¸","ğŸ«‘","ğŸŒ½","ğŸ¥•","ğŸ§„","ğŸ§…","ğŸ¥”","ğŸ ","ğŸ¥","ğŸ¥¯","ğŸ","ğŸ¥–","ğŸ¥¨","ğŸ§€","ğŸ¥š","ğŸ³","ğŸ§ˆ","ğŸ¥","ğŸ§‡","ğŸ¥“","ğŸ¥©","ğŸ—","ğŸ–","ğŸ¦´","ğŸŒ­","ğŸ”","ğŸŸ","ğŸ•","ğŸ«“","ğŸ¥ª","ğŸ¥™","ğŸ§†","ğŸŒ®","ğŸŒ¯","ğŸ«”","ğŸ¥—","ğŸ¥˜","ğŸ«•","ğŸ¥«","ğŸ","ğŸœ","ğŸ²","ğŸ›","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸ¦ª","ğŸ¤","ğŸ™","ğŸš","ğŸ˜","ğŸ¥","ğŸ¥ ","ğŸ¥®","ğŸ¢","ğŸ¡","ğŸ§","ğŸ¨","ğŸ¦","ğŸ¥§","ğŸ§","ğŸ°","ğŸ‚","ğŸ®","ğŸ­","ğŸ¬","ğŸ«","ğŸ¿","ğŸ©","ğŸª"]},{name:"hearts",emojis:["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ¤","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’","ğŸ’“","ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’","ğŸ’Ÿ","â™¥ï¸"]},{name:"objects",emojis:["â­","ğŸŒŸ","âœ¨","ğŸ’«","ğŸ”¥","ğŸ’¯","ğŸ‰","ğŸŠ","ğŸˆ","ğŸ","ğŸ†","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","âš½","ğŸ€","ğŸˆ","âš¾","ğŸ¾","ğŸ","ğŸ±","ğŸ“","ğŸ®","ğŸ²","ğŸ§©","ğŸ­","ğŸ¨","ğŸ¬","ğŸ¤","ğŸ§","ğŸµ","ğŸ¶","ğŸ¹","ğŸ¸","ğŸº","ğŸ»","ğŸ“·","ğŸ“¸","ğŸ“¹","ğŸ¥","ğŸ“±","ğŸ’»","âŒ¨ï¸","ğŸ–¥ï¸","ğŸ“º","ğŸ“»","â°","âŒš","ğŸ’¡","ğŸ”¦","ğŸ“š","ğŸ“–","âœï¸","ğŸ“","ğŸ’°","ğŸ’µ","ğŸ’´","ğŸ’¶","ğŸ’·","ğŸ’³","ğŸ›’","ğŸ€","ğŸ—ï¸"]},{name:"nature",emojis:["ğŸŒ¸","ğŸ’®","ğŸµï¸","ğŸŒ¹","ğŸ¥€","ğŸŒº","ğŸŒ»","ğŸŒ¼","ğŸŒ·","ğŸŒ±","ğŸª´","ğŸŒ²","ğŸŒ³","ğŸŒ´","ğŸŒµ","ğŸŒ¾","ğŸŒ¿","â˜˜ï¸","ğŸ€","ğŸ","ğŸ‚","ğŸƒ","ğŸŒ","ğŸŒ","ğŸŒ","ğŸŒ™","â­","â˜€ï¸","ğŸŒ¤ï¸","â›…","ğŸŒ¥ï¸","â˜ï¸","ğŸŒ¦ï¸","ğŸŒ§ï¸","â›ˆï¸","ğŸŒ©ï¸","ğŸŒ¨ï¸","â„ï¸","â˜ƒï¸","â›„","ğŸŒ¬ï¸","ğŸ’¨","ğŸŒŠ","ğŸ’§","ğŸ’¦","â˜”","ğŸŒˆ"]}],Ps=({onSelect:s})=>{const{t}=$(),a=J(),[p,m]=i.useState(!1),[l,b]=i.useState(0),c=x=>{s(x),a||m(!1)},f={smileys:t("emoji.smileys","è¡¨æƒ…"),gestures:t("emoji.gestures","æ‰‹åŠ¿"),food:t("emoji.food","ç¾é£Ÿ"),hearts:t("emoji.hearts","çˆ±å¿ƒ"),objects:t("emoji.objects","ç‰©å“"),nature:t("emoji.nature","è‡ªç„¶")},N=e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 border-b",children:pe.map((x,j)=>e.jsx("button",{type:"button",onClick:()=>b(j),className:`px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors ${l===j?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-muted-foreground"}`,children:f[x.name]},x.name))}),e.jsx("div",{className:"grid grid-cols-8 gap-1",children:pe[l].emojis.map((x,j)=>e.jsx("button",{type:"button",onClick:()=>c(x),className:"w-9 h-9 flex items-center justify-center text-xl hover:bg-muted rounded-md transition-colors",children:x},j))})]}),u=e.jsxs("button",{type:"button",onClick:()=>m(!0),className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(Be,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.emoji","è¡¨æƒ…")})]});return a?e.jsxs(e.Fragment,{children:[u,e.jsx(Y,{open:p,onOpenChange:m,children:e.jsxs(Z,{className:"h-[50vh]",children:[e.jsx(ee,{className:"pb-2",children:e.jsx(se,{children:t("emoji.title","é€‰æ‹©è¡¨æƒ…")})}),e.jsx(ve,{className:"flex-1 px-4 pb-4",children:N})]})})]}):e.jsxs(te,{open:p,onOpenChange:m,children:[e.jsx(ae,{asChild:!0,children:u}),e.jsx(re,{className:"w-80 p-3",align:"start",side:"top",children:N})]})},Ls=({trigger:s})=>{const{t}=$(),{getLocalizedField:a}=K(),p=hs(),{data:m}=Ns(),{data:l}=vs(),{role:b,isMerchant:c,isAdmin:f,isSupervisor:N}=os(),{data:u}=ps(),{data:x,isLoading:j}=gs(),[R,w]=i.useState(!1),[n,S]=i.useState(""),[k,L]=i.useState([]),[H,z]=i.useState(null),[q,r]=i.useState(""),[P,E]=i.useState(""),[U,G]=i.useState(!1),[Ce,le]=i.useState(!1),[Re,ce]=i.useState(!1),W=i.useRef(null),Q=i.useRef(null),de=!c&&!N&&!f;i.useEffect(()=>{c&&u&&R&&E(u.id)},[c,u,R]);const me=()=>{S(""),L([]),z(null),r(""),E(""),le(!1),ce(!1)},Se=d=>{w(d),d||me()},Pe=m?.filter(d=>d.status==="published")||[],Le=async d=>{const h=d.target.files;if(!(!h||h.length===0)){if(k.length+h.length>9){F.error(t("community.maxImages","æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡"));return}G(!0);try{const{data:{user:v}}=await A.auth.getUser();if(!v)throw new Error("Not authenticated");const o=[];for(const y of Array.from(h)){const T=y.name.split(".").pop(),_=`${v.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${T}`,{error:I}=await A.storage.from("community-posts").upload(_,y);if(I)throw I;const{data:{publicUrl:D}}=A.storage.from("community-posts").getPublicUrl(_);o.push(D)}L(y=>[...y,...o])}catch(v){console.error("Upload error:",v),F.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{G(!1),W.current&&(W.current.value="")}}},Ee=d=>new Promise((h,v)=>{const o=document.createElement("video"),y=document.createElement("canvas"),T=y.getContext("2d");o.preload="auto",o.muted=!0,o.playsInline=!0;let _=!1;const I=()=>{_||o.videoWidth===0||o.videoHeight===0||(y.width=o.videoWidth,y.height=o.videoHeight,T&&(T.drawImage(o,0,0,y.width,y.height),y.toBlob(D=>{D&&D.size>0?(_=!0,o.pause(),URL.revokeObjectURL(o.src),h(D)):v(new Error("Failed to create blob"))},"image/jpeg",.85)))};o.onloadedmetadata=()=>{y.width=o.videoWidth,y.height=o.videoHeight,o.currentTime=.1},o.onseeked=()=>{setTimeout(I,100)},o.onerror=()=>{URL.revokeObjectURL(o.src),v(new Error("Failed to load video"))},setTimeout(()=>{_||(URL.revokeObjectURL(o.src),v(new Error("Timeout")))},1e4),o.src=URL.createObjectURL(d),o.load()}),Ue=async d=>{const h=d.target.files?.[0];if(h){if(h.size>100*1024*1024){F.error(t("community.videoTooLarge","è§†é¢‘ä¸èƒ½è¶…è¿‡100MB"));return}G(!0);try{const{data:{user:v}}=await A.auth.getUser();if(!v)throw new Error("Not authenticated");const o=h.name.split(".").pop(),y=`${v.id}/${Date.now()}.${o}`,{error:T}=await A.storage.from("community-posts").upload(y,h);if(T)throw T;const{data:{publicUrl:_}}=A.storage.from("community-posts").getPublicUrl(y);z(_);try{F.info(t("community.extractingCover","æ­£åœ¨æå–è§†é¢‘å°é¢..."));const I=await Ee(h),D=`${v.id}/${Date.now()}-cover.jpg`,{error:Ae}=await A.storage.from("community-posts").upload(D,I);if(!Ae){const{data:{publicUrl:Me}}=A.storage.from("community-posts").getPublicUrl(D);L(Te=>[Me,...Te]),F.success(t("community.coverExtracted","å°é¢å·²è‡ªåŠ¨ç”Ÿæˆ"))}}catch(I){console.warn("Cover extraction failed:",I)}}catch(v){console.error("Upload error:",v),F.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{G(!1),Q.current&&(Q.current.value="")}}},_e=d=>{L(h=>h.filter((v,o)=>o!==d))},Ie=()=>{z(null),L(d=>d.length>0&&d[0].includes("-cover.jpg")?d.slice(1):d)},De=async()=>{if(!n.trim()){F.error(t("community.contentRequired","è¯·è¾“å…¥å†…å®¹"));return}if(de&&!P){F.error(t("community.restaurantRequired","è¯·é€‰æ‹©é¤å…"));return}await p.mutateAsync({content:n,image_urls:k,video_url:H||void 0,activity_id:q||void 0,restaurant_id:P||void 0}),me(),w(!1)},Fe=()=>u?a(u,"name"):t("community.noRestaurant","æœªå…³è”é¤å…");return e.jsxs(ls,{open:R,onOpenChange:Se,children:[e.jsx(cs,{asChild:!0,children:s||e.jsx(O,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs(ds,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(Ge,{children:e.jsx(ms,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>w(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(We,{className:"h-5 w-5"})}),e.jsxs(O,{size:"sm",onClick:De,disabled:p.isPending||!n.trim(),className:"rounded-full px-6",children:[p.isPending&&e.jsx(ue,{className:"h-4 w-4 mr-2 animate-spin"}),t("community.publish","å‘å¸ƒ")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[!j&&!x&&e.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2 bg-primary/10 dark:bg-primary/20 border border-primary/30 dark:border-primary/40 rounded-md text-sm text-primary dark:text-primary",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:t("community.dailyPointsHint","æ¯æ—¥å‘å¸ƒé¦–ä¸ªå¸–å­å¯è·å¾—5ç§¯åˆ†ï¼")})]}),e.jsx(ks,{})]}),e.jsx(us,{value:n,onChange:d=>S(d.target.value),placeholder:t("community.contentPlaceholder","åˆ†äº«ä½ çš„æƒ³æ³•..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base"}),k.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:k.map((d,h)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden",children:[e.jsx("img",{src:d,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>_e(h),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(xe,{className:"h-3 w-3"})})]},h))}),H&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:H,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:Ie,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(xe,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-2 pb-0 bg-background shrink-0 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ye,{className:"h-5 w-5 text-muted-foreground shrink-0"}),c?e.jsx("span",{className:"text-sm text-muted-foreground",children:Fe()}):e.jsx(Rs,{open:Ce,onOpenChange:le,value:P,onSelect:E,restaurants:l||[],showNoneOption:N||f,required:de})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ne,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(Ss,{open:Re,onOpenChange:ce,value:q,onSelect:r,activities:Pe})]})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 pt-0 py-2 pb-[max(2rem,calc(env(safe-area-inset-bottom)+1rem))] bg-background shrink-0",children:[e.jsx("input",{ref:W,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:Le}),e.jsx("input",{ref:Q,type:"file",accept:"video/*",className:"hidden",onChange:Ue}),e.jsxs("button",{type:"button",onClick:()=>W.current?.click(),disabled:U||k.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Qe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.photo","ç…§ç‰‡")})]}),e.jsxs("button",{type:"button",onClick:()=>Q.current?.click(),disabled:U||!!H,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Ke,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.video","è§†é¢‘")})]}),e.jsx(Ps,{onSelect:d=>S(h=>h+d)}),U&&e.jsx(ue,{className:"h-5 w-5 animate-spin ml-auto"})]})]})]})},Es=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(V,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"h-4 w-full"}),e.jsx(V,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 rounded-full"}),e.jsx(V,{className:"h-3 w-16"})]}),e.jsx(V,{className:"h-4 w-10"})]})]})]}),Bs=()=>{const{t:s}=$(),t=Xe(),{data:a,isLoading:p}=fs({status:"approved"}),{data:m}=js(),l=i.useCallback(async()=>{await t.invalidateQueries({queryKey:["community-posts"]})},[t]);return e.jsx(bs,{onRefresh:l,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-4xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl mb-2 text-primary font-medium",children:s("community.title","ç¤¾åŒº")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:s("community.description","åˆ†äº«ç¾é£Ÿä½“éªŒï¼Œå‘ç°æ›´å¤šç²¾å½©")})]}),m&&e.jsx(Ls,{trigger:e.jsxs(O,{size:"sm",className:"gap-1.5",children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.createPost","å‘å¸ƒ")})]})})]}),p?e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:Array.from({length:6}).map((b,c)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Es,{})},c))}):a&&a.length>0?e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:a.map(b=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(ws,{post:b})},b.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(he,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:s("community.noPosts","æš‚æ— å¸–å­")}),m&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:s("community.beFirst","æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸–çš„äººå§ï¼")})]})]})})})};export{Bs as default};
//# sourceMappingURL=Community-cu_EULfE.js.map
