import{s as p,p as m,q as v,v as y,r as h}from"./vendor-react-DwI6ZJq7.js";import{u as f,f as w,s as r}from"./index-C7QjDrm6.js";const F=()=>{const{user:e}=f(),i=v();return h.useEffect(()=>{if(!e?.id)return;const t=r.channel(`invitation-code-${e.id}`).on("postgres_changes",{event:"*",schema:"public",table:"invitation_codes",filter:`user_id=eq.${e.id}`},()=>{i.invalidateQueries({queryKey:["my-invitation-code",e.id]})}).subscribe();return()=>{r.removeChannel(t)}},[e?.id,i]),p({queryKey:["my-invitation-code",e?.id],queryFn:async()=>{if(!e?.id)return null;const{data:t,error:o}=await r.from("invitation_codes").select("*").eq("user_id",e.id).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(o)throw o;return t},enabled:!!e?.id})},I=()=>{const{user:e}=f(),i=v();return h.useEffect(()=>{if(!e?.id)return;const t=r.channel(`invitation-code-history-${e.id}`).on("postgres_changes",{event:"*",schema:"public",table:"invitation_codes",filter:`user_id=eq.${e.id}`},()=>{i.invalidateQueries({queryKey:["my-invitation-code-history",e.id]})}).subscribe();return()=>{r.removeChannel(t)}},[e?.id,i]),p({queryKey:["my-invitation-code-history",e?.id],queryFn:async()=>{if(!e?.id)return[];const{data:t,error:o}=await r.from("invitation_codes").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(o)throw o;return t},enabled:!!e?.id})},b=()=>{const{user:e}=f(),{toast:i}=w(),{t}=m(),o=v();return y({mutationFn:async n=>{if(!e?.id)throw new Error("User not authenticated");const{data:s}=await r.from("invitation_codes").select("id, user_id").eq("nif",n.nif).neq("user_id",e.id).limit(1).maybeSingle();if(s)throw new Error("NIF_ALREADY_EXISTS");const{data:a,error:c}=await r.rpc("generate_invitation_code");if(c)throw c;const{data:u,error:l}=await r.from("invitation_codes").insert({user_id:e.id,code:a,full_name:n.full_name,nif:n.nif,contact:n.contact,address:n.address,status:"pending"}).select().single();if(l)throw l;await r.from("profiles").update({full_name:n.full_name,nif:n.nif,contact:n.contact,address:n.address}).eq("id",e.id);try{await r.functions.invoke("send-invitation-code-email",{body:{user_id:e.id,full_name:n.full_name,nif:n.nif,contact:n.contact,address:n.address,is_reapply:!1}}),console.log("Invitation code application email sent")}catch(d){console.error("Failed to send invitation code email:",d)}return u},onSuccess:()=>{o.invalidateQueries({queryKey:["my-invitation-code"]}),i({title:t("invitationCode.applySuccess","申请已提交"),description:t("invitationCode.applySuccessDesc","您的邀请码申请已提交，请等待管理员审核")})},onError:n=>{n.message==="NIF_ALREADY_EXISTS"?i({title:t("invitationCode.applyFailed","申请失败"),description:t("invitationCode.nifExists","该NIF已被其他用户使用，请检查后重试"),variant:"destructive"}):i({title:t("invitationCode.applyFailed","申请失败"),description:t("invitationCode.applyFailedDesc","提交申请时发生错误，请稍后重试"),variant:"destructive"})}})},D=()=>{const{user:e}=f(),{toast:i}=w(),{t}=m(),o=v();return y({mutationFn:async({id:n,data:s})=>{if(!e?.id)throw new Error("User not authenticated");const{data:a}=await r.from("invitation_codes").select("id, user_id").eq("nif",s.nif).neq("user_id",e.id).limit(1).maybeSingle();if(a)throw new Error("NIF_ALREADY_EXISTS");const{data:c,error:u}=await r.from("invitation_codes").update({full_name:s.full_name,nif:s.nif,contact:s.contact,address:s.address,status:"pending",rejection_reason:null,reviewed_by:null,reviewed_at:null}).eq("id",n).eq("user_id",e.id).select().single();if(u)throw u;await r.from("profiles").update({full_name:s.full_name,nif:s.nif,contact:s.contact,address:s.address}).eq("id",e.id);try{await r.functions.invoke("send-invitation-code-email",{body:{user_id:e.id,full_name:s.full_name,nif:s.nif,contact:s.contact,address:s.address,is_reapply:!0}}),console.log("Invitation code reapplication email sent")}catch(l){console.error("Failed to send invitation code email:",l)}return c},onSuccess:()=>{o.invalidateQueries({queryKey:["my-invitation-code"]}),i({title:t("invitationCode.reapplySuccess","重新申请已提交"),description:t("invitationCode.reapplySuccessDesc","您的邀请码申请已重新提交，请等待管理员审核")})},onError:n=>{n.message==="NIF_ALREADY_EXISTS"?i({title:t("invitationCode.applyFailed","申请失败"),description:t("invitationCode.nifExists","该NIF已被其他用户使用，请检查后重试"),variant:"destructive"}):i({title:t("invitationCode.applyFailed","申请失败"),description:t("invitationCode.applyFailedDesc","提交申请时发生错误，请稍后重试"),variant:"destructive"})}})},R=()=>p({queryKey:["admin-invitation-codes"],queryFn:async()=>{const{data:e,error:i}=await r.from("invitation_codes").select("*").order("created_at",{ascending:!1});if(i)throw i;if(!e?.length)return[];const t=[...new Set(e.map(n=>n.user_id))],{data:o}=await r.from("profiles").select("id, display_name, avatar_url").in("id",t);return e.map(n=>({...n,profiles:o?.find(s=>s.id===n.user_id)||null}))}}),j=()=>p({queryKey:["invitation-code-stats"],queryFn:async()=>{const{data:e,error:i}=await r.from("invitation_codes").select("status");if(i)throw i;return{total:e.length,pending:e.filter(o=>o.status==="pending").length,approved:e.filter(o=>o.status==="approved").length,rejected:e.filter(o=>o.status==="rejected").length,revoked:e.filter(o=>o.status==="revoked").length}}}),K=e=>p({queryKey:["invitation-code-usage-details",e],queryFn:async()=>{if(!e)return null;const{data:i,error:t}=await r.from("join_requests").select("id, name, email, restaurant_name, status, created_at").eq("invitation_code",e).order("created_at",{ascending:!1});if(t)throw t;const{data:o,error:n}=await r.from("profiles").select("id, display_name, avatar_url, created_at, invited_at").eq("invitation_code_used",e).order("invited_at",{ascending:!1});if(n)throw n;const s=i?.length||0,a=i?.filter(d=>d.status==="completed").length||0,c=i?.filter(d=>d.status==="pending"||d.status==="received").length||0,u=o?.length||0,l=s>0?Math.round((a+u)/s*100):0;return{joinRequests:i||[],invitedUsers:o||[],stats:{totalUsed:s,completedJoinRequests:a,pendingJoinRequests:c,registeredUsers:u,successRate:l}}},enabled:!!e}),U=()=>p({queryKey:["invitation-code-performance-stats"],queryFn:async()=>{const{data:e,error:i}=await r.from("invitation_codes").select("code, usage_count").eq("status","approved");if(i)throw i;const{data:t,error:o}=await r.from("join_requests").select("invitation_code, status").not("invitation_code","is",null);if(o)throw o;const{data:n,error:s}=await r.from("profiles").select("invitation_code_used").not("invitation_code_used","is",null);if(s)throw s;const a=e?.length||0,c=e?.reduce((_,C)=>_+(C.usage_count||0),0)||0,u=e?.filter(_=>(_.usage_count||0)>0).length||0,l=t?.filter(_=>_.status==="completed").length||0,d=t?.length||0,g=n?.length||0,q=d>0?Math.round((l+g)/d*100):0;return{totalCodes:a,totalUsage:c,activeCodesCount:u,completedJoinRequests:l,totalJoinRequestsWithCode:d,totalRegisteredUsers:g,overallSuccessRate:q}}}),A=()=>{const{user:e}=f(),{toast:i}=w(),{t}=m(),o=v();return y({mutationFn:async n=>{if(!e?.id)throw new Error("User not authenticated");const{data:s,error:a}=await r.from("invitation_codes").update({status:"approved",reviewed_by:e.id,reviewed_at:new Date().toISOString()}).eq("id",n).select().single();if(a)throw a;return s},onSuccess:()=>{o.invalidateQueries({queryKey:["admin-invitation-codes"]}),o.invalidateQueries({queryKey:["invitation-code-stats"]}),i({title:t("invitationCode.approveSuccess","审核通过"),description:t("invitationCode.approveSuccessDesc","邀请码申请已通过")})},onError:()=>{i({title:t("invitationCode.operationFailed","操作失败"),description:t("invitationCode.operationFailedDesc","审核操作失败，请稍后重试"),variant:"destructive"})}})},Q=()=>{const{user:e}=f(),{toast:i}=w(),{t}=m(),o=v();return y({mutationFn:async({id:n,reason:s})=>{if(!e?.id)throw new Error("User not authenticated");const{data:a,error:c}=await r.from("invitation_codes").update({status:"rejected",rejection_reason:s,reviewed_by:e.id,reviewed_at:new Date().toISOString()}).eq("id",n).select().single();if(c)throw c;return a},onSuccess:()=>{o.invalidateQueries({queryKey:["admin-invitation-codes"]}),o.invalidateQueries({queryKey:["invitation-code-stats"]}),i({title:t("invitationCode.rejectSuccess","已拒绝"),description:t("invitationCode.rejectSuccessDesc","邀请码申请已拒绝")})},onError:()=>{i({title:t("invitationCode.operationFailed","操作失败"),description:t("invitationCode.operationFailedDesc","审核操作失败，请稍后重试"),variant:"destructive"})}})},k=()=>{const{user:e}=f(),{toast:i}=w(),{t}=m(),o=v();return y({mutationFn:async({id:n,reason:s})=>{if(!e?.id)throw new Error("User not authenticated");const{data:a,error:c}=await r.from("invitation_codes").update({status:"revoked",rejection_reason:s,reviewed_by:e.id,reviewed_at:new Date().toISOString()}).eq("id",n).select().single();if(c)throw c;return a},onSuccess:()=>{o.invalidateQueries({queryKey:["admin-invitation-codes"]}),o.invalidateQueries({queryKey:["invitation-code-stats"]}),i({title:t("invitationCode.revokeSuccess","已收回"),description:t("invitationCode.revokeSuccessDesc","邀请码已成功收回")})},onError:()=>{i({title:t("invitationCode.operationFailed","操作失败"),description:t("invitationCode.operationFailedDesc","收回操作失败，请稍后重试"),variant:"destructive"})}})},N=()=>y({mutationFn:async e=>{const{data:i,error:t}=await r.from("invitation_codes").select("id, code, user_id, status, code_type, usage_limit, usage_count").eq("code",e.toUpperCase()).eq("status","approved").maybeSingle();if(t)throw t;return i&&i.usage_limit>0&&i.usage_count>=i.usage_limit?null:i}});export{D as a,F as b,I as c,N as d,A as e,Q as f,k as g,K as h,R as i,j,U as k,b as u};
//# sourceMappingURL=useInvitationCodes-DykR_7-0.js.map
