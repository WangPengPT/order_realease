{"version":3,"file":"paginatedQuery-BD4UjlyT.js","sources":["../../src/lib/paginatedQuery.ts"],"sourcesContent":["import { supabase } from \"@/integrations/supabase/client\";\r\n\r\ntype TableName = \"page_views\" | \"comments\" | \"favorites\" | \"community_posts\" | \"subscriptions\" | \"activity_shares\" | \"coupon_usage_history\" | \"user_coupons\";\r\n\r\n/**\r\n * Fetches all data from a Supabase table using pagination to overcome the 1000 row limit.\r\n * @param tableName - The name of the table to query\r\n * @param selectQuery - The select query string\r\n * @param buildQuery - A function that applies filters to the query\r\n * @param pageSize - The number of rows to fetch per page (default: 1000)\r\n * @returns All rows matching the query\r\n */\r\nexport async function fetchAllPaginated<T = any>(\r\n  tableName: TableName,\r\n  selectQuery: string,\r\n  buildQuery?: (query: any) => any,\r\n  pageSize: number = 1000\r\n): Promise<T[]> {\r\n  let allData: T[] = [];\r\n  let page = 0;\r\n  let hasMore = true;\r\n\r\n  while (hasMore) {\r\n    let query = supabase\r\n      .from(tableName)\r\n      .select(selectQuery)\r\n      .range(page * pageSize, (page + 1) * pageSize - 1);\r\n\r\n    if (buildQuery) {\r\n      query = buildQuery(query);\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) throw error;\r\n\r\n    if (data && data.length > 0) {\r\n      allData = allData.concat(data as T[]);\r\n      hasMore = data.length === pageSize;\r\n      page++;\r\n    } else {\r\n      hasMore = false;\r\n    }\r\n  }\r\n\r\n  return allData;\r\n}\r\n\r\n/**\r\n * Helper to create a query builder with common filters\r\n */\r\nexport function createQueryBuilder(options: {\r\n  dateFilter?: string | null;\r\n  dateColumn?: string;\r\n  filters?: Record<string, any>;\r\n  orderBy?: { column: string; ascending?: boolean };\r\n}) {\r\n  return (query: any) => {\r\n    const { dateFilter, dateColumn = \"created_at\", filters, orderBy } = options;\r\n\r\n    if (filters) {\r\n      Object.entries(filters).forEach(([key, value]) => {\r\n        query = query.eq(key, value);\r\n      });\r\n    }\r\n\r\n    if (dateFilter) {\r\n      query = query.gte(dateColumn, dateFilter);\r\n    }\r\n\r\n    if (orderBy) {\r\n      query = query.order(orderBy.column, { ascending: orderBy.ascending ?? false });\r\n    }\r\n\r\n    return query;\r\n  };\r\n}\r\n"],"names":["fetchAllPaginated","tableName","selectQuery","buildQuery","pageSize","allData","page","hasMore","query","supabase","data","error"],"mappings":"wCAYA,eAAsBA,EACpBC,EACAC,EACAC,EACAC,EAAmB,IACL,CACd,IAAIC,EAAe,CAAA,EACfC,EAAO,EACPC,EAAU,GAEd,KAAOA,GAAS,CACd,IAAIC,EAAQC,EACT,KAAKR,CAAS,EACd,OAAOC,CAAW,EAClB,MAAMI,EAAOF,GAAWE,EAAO,GAAKF,EAAW,CAAC,EAE/CD,IACFK,EAAQL,EAAWK,CAAK,GAG1B,KAAM,CAAE,KAAAE,EAAM,MAAAC,CAAM,EAAI,MAAMH,EAE9B,GAAIG,EAAa,MAAAA,EAEbD,GAAQA,EAAK,OAAS,GACdL,EAAAA,EAAQ,OAAOK,CAAW,EACpCH,EAAUG,EAAK,SAAWN,EAC1BE,KAEUC,EAAA,EAEd,CAEO,OAAAF,CACT"}