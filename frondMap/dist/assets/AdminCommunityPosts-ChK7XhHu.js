import{p as ie,j as e,bz as be,r as c,bb as we,bc as ye,b4 as Ce,aX as Pe,cd as H,bf as f,bP as Z,c6 as ee,a4 as se,bC as ae,dI as _e,ea as te,bh as ke,ak as le,cQ as De,aM as Se,aL as Te,bA as Ae,bQ as R,be as Fe,b3 as Ie,bq as ze,bN as Ee,ck as Le,ca as re,w as V}from"./vendor-react-BQzJ6E-_.js";import{D as Me,c as He,d as Re,e as Ve,B as o,S as Ue,C as P,q as _,I as Be,a2 as U,a3 as B,a4 as O,a5 as G,a6 as i,i as b,A as Oe,t as Ge,v as Qe,w as We,x as qe,y as $e,z as Xe,E as Je,P as Ke,Q as Ye,R as Ze,g as Q,ab as h,ac as u,ad as g,ae as j,j as d,s as k}from"./index-CvGChxBf.js";import{d as es,e as ss,c as as}from"./useCommunityPosts-PMIyS9cK.js";import{u as ts}from"./useLocalizedContent-CInskQbp.js";import{P as ls}from"./PostManagementDialog-CkqHrPv3.js";import{P as rs}from"./PostCard-NWWO7qg8.js";import{R as is}from"./RecipeDetailContent-B9zYf0eG.js";import{H as ns,p as cs,I as ds,J as os}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-Bm_2ig-Q.js";import"./separator-RJWDid-q.js";import"./useActivities-CN_ZMYRf.js";import"./carousel-lKSIpy60.js";import"./TranslateButton-Cf8ziUlN.js";import"./ShareDrawer-wwlPqDNx.js";import"./drawer-BFaYQr5Y.js";import"./ImagePreviewModal-Bz8iD6tv.js";import"./progress-D8HGfqHY.js";const ms=({post:a,open:D,onOpenChange:S})=>{const{t:p}=ie();if(!a)return null;const w=a,v=w.post_type==="recipe",T=()=>{window.open(`/community/${a.id}`,"_blank")};return e.jsx(Me,{open:D,onOpenChange:S,children:e.jsxs(He,{className:"max-w-2xl max-h-[90vh] p-0 gap-0",children:[e.jsxs(Re,{className:"px-6 py-4 border-b flex-row items-center justify-between space-y-0",children:[e.jsx(Ve,{className:"flex items-center gap-2",children:p("admin.communityPosts.preview","预览帖子")}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(o,{variant:"ghost",size:"sm",className:"gap-1.5",onClick:T,children:[e.jsx(be,{className:"h-4 w-4"}),p("admin.communityPosts.openInNewTab","新标签打开")]})})]}),e.jsx(Ue,{className:"max-h-[calc(90vh-80px)]",children:e.jsx("div",{className:"p-6 bg-secondary/30",children:e.jsx("div",{className:"max-w-lg mx-auto",children:v?e.jsx(is,{post:w}):e.jsx(rs,{post:a,showActions:!1,isDetailPage:!0})})})})]})})},As=()=>{const{t:a,i18n:D}=ie(),{getLocalizedField:S}=ts(),[p,w]=c.useState(""),[v,T]=c.useState("all"),[A,ne]=c.useState("all"),[F,ce]=c.useState("all"),[W,q]=c.useState(null),[$,X]=c.useState(null),[I,z]=c.useState(null),[y,J]=c.useState("grid"),[K,Y]=c.useState(null),{data:N,isLoading:de}=es({status:v!=="all"?v:void 0,moderation_status:A!=="all"?A:void 0,post_type:F!=="all"?F:void 0,search:p||void 0}),C=ss(),oe=as(),me=()=>{switch(D.language){case"zh":return os;case"pt":return ds;default:return cs}},xe=s=>{switch(s){case"approved":return{label:a("admin.status.approved","已发布"),icon:H,className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/20"};case"pending":return{label:a("admin.status.pending","待审核"),icon:f,className:"bg-amber-500/10 text-amber-600 border-amber-500/20"};case"rejected":return{label:a("admin.status.rejected","已拒绝"),icon:ee,className:"bg-red-500/10 text-red-600 border-red-500/20"};case"hidden":return{label:a("admin.status.hidden","已隐藏"),icon:Z,className:"bg-gray-500/10 text-gray-600 border-gray-500/20"};default:return{label:s,icon:re,className:"bg-gray-500/10 text-gray-600 border-gray-500/20"}}},he=s=>{switch(s){case"approved":return{label:a("admin.moderation.approved","通过"),icon:se,className:"text-emerald-600"};case"flagged":return{label:a("admin.moderation.flagged","标记"),icon:ae,className:"text-orange-500"};case"pending":return{label:a("admin.moderation.pending","待审"),icon:f,className:"text-muted-foreground"};default:return{label:s,icon:re,className:"text-muted-foreground"}}},E=(s,l)=>{switch(l){case"approve":C.mutate({id:s.id,status:"approved"});break;case"hide":C.mutate({id:s.id,status:"hidden"});break;case"unhide":C.mutate({id:s.id,status:"approved"});break;case"delete":z(s);break}},ue=()=>{I&&(oe.mutate(I.id),z(null))},ge=s=>{const l=document.createElement("div");return l.innerHTML=s,l.textContent||l.innerText||""},je=s=>new Promise((l,n)=>{const t=document.createElement("video"),r=document.createElement("canvas"),x=r.getContext("2d");t.preload="auto",t.muted=!0,t.playsInline=!0,t.crossOrigin="anonymous";let m=!1;const L=()=>{m||t.videoWidth===0||t.videoHeight===0||(r.width=t.videoWidth,r.height=t.videoHeight,x&&(x.drawImage(t,0,0,r.width,r.height),r.toBlob(M=>{M&&M.size>0?(m=!0,t.pause(),l(M)):n(new Error("Failed to create blob"))},"image/jpeg",.85)))};t.onloadedmetadata=()=>{r.width=t.videoWidth,r.height=t.videoHeight,t.currentTime=.1},t.onseeked=()=>{setTimeout(L,100)},t.onerror=()=>{n(new Error("Failed to load video"))},setTimeout(()=>{m||n(new Error("Timeout"))},15e3),t.src=s,t.load()}),pe=async s=>{if(s.video_url){Y(s.id);try{V.info(a("admin.communityPosts.extractingCover","正在提取视频封面..."));const l=await je(s.video_url),{data:{user:n}}=await k.auth.getUser();if(!n)throw new Error("Not authenticated");const t=`covers/${s.id}-cover-${Date.now()}.jpg`,{error:r}=await k.storage.from("community-posts").upload(t,l);if(r)throw r;const{data:{publicUrl:x}}=k.storage.from("community-posts").getPublicUrl(t),m=[x,...s.image_urls||[]];await k.from("community_posts").update({image_urls:m}).eq("id",s.id),C.mutate({id:s.id,image_urls:m}),V.success(a("admin.communityPosts.coverGenerated","封面已生成"))}catch(l){console.error("Failed to generate cover:",l),V.error(a("admin.communityPosts.coverFailed","封面生成失败，请重试"))}finally{Y(null)}}},ve=s=>s.video_url&&(!s.image_urls||s.image_urls.length===0),Ne=({post:s})=>{const l=xe(s.status),n=he(s.moderation_status),t=l.icon,r=n.icon,x=s.post_type==="recipe";return e.jsx(P,{className:"group overflow-hidden hover:shadow-md transition-all duration-200 border-border/60",children:e.jsxs(_,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border/40",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Ke,{className:"h-10 w-10 ring-2 ring-background shadow-sm",children:[e.jsx(Ye,{src:s.author?.avatar_url||void 0}),e.jsx(Ze,{className:"bg-primary/10 text-primary font-medium",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),x&&e.jsxs(Q,{variant:"secondary",className:"text-xs gap-1 bg-primary/10 text-primary",children:[e.jsx(te,{className:"h-3 w-3"}),a("admin.communityPosts.recipe","食谱")]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(f,{className:"h-3 w-3"}),ns(new Date(s.created_at),{addSuffix:!0,locale:me()})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{children:e.jsxs(u,{children:[e.jsx(g,{asChild:!0,children:e.jsx("div",{className:b("p-1.5 rounded-full",n.className),children:e.jsx(r,{className:"h-3.5 w-3.5"})})}),e.jsx(j,{side:"left",children:e.jsx("p",{children:n.label})})]})})})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[x&&s.recipe_name&&e.jsx("p",{className:"text-sm font-medium text-foreground line-clamp-2",children:s.recipe_name}),e.jsx("p",{className:"text-sm line-clamp-3 text-foreground/90 whitespace-pre-line",children:ge(s.content)}),(s.image_urls?.length>0||s.video_url)&&e.jsxs("div",{className:"flex items-center gap-3",children:[s.image_urls&&s.image_urls.length>0&&e.jsxs("div",{className:"flex -space-x-2",children:[s.image_urls.slice(0,3).map((m,L)=>e.jsx("div",{className:"h-12 w-12 rounded-lg overflow-hidden border-2 border-background shadow-sm",children:e.jsx("img",{src:m,alt:"",className:"w-full h-full object-cover"})},L)),s.image_urls.length>3&&e.jsx("div",{className:"h-12 w-12 rounded-lg bg-muted/80 border-2 border-background flex items-center justify-center shadow-sm",children:e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["+",s.image_urls.length-3]})})]}),s.video_url&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground bg-muted/50 px-2 py-1 rounded-full",children:[e.jsx(De,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:a("admin.communityPosts.hasVideo","视频")})]}),ve(s)&&e.jsxs(o,{variant:"outline",size:"sm",className:"h-6 text-xs gap-1 text-orange-600 border-orange-300 hover:bg-orange-50",onClick:()=>pe(s),disabled:K===s.id,children:[K===s.id?e.jsx(Se,{className:"h-3 w-3 animate-spin"}):e.jsx(Te,{className:"h-3 w-3"}),a("admin.communityPosts.generateCover","生成封面")]})]})]}),s.activity&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ae,{className:"h-3.5 w-3.5 text-primary"}),e.jsx(Q,{variant:"secondary",className:"text-xs font-normal",children:S(s.activity,"title")})]})]}),e.jsx("div",{className:"px-4 py-3 bg-muted/30 border-t border-border/40",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(R,{className:"h-3.5 w-3.5"}),s.views_count||0]}),e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(Fe,{className:"h-3.5 w-3.5"}),s.likes_count]}),e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(Ie,{className:"h-3.5 w-3.5"}),s.comments_count]}),e.jsxs("span",{className:"flex items-center gap-1 text-xs",children:[e.jsx(ze,{className:"h-3.5 w-3.5"}),s.shares_count]})]}),e.jsxs(Q,{variant:"outline",className:b("text-xs border",l.className),children:[e.jsx(t,{className:"h-3 w-3 mr-1"}),l.label]})]})}),e.jsxs("div",{className:"flex items-center gap-1 p-2 border-t border-border/40 bg-background",children:[e.jsx(h,{children:e.jsxs(u,{children:[e.jsx(g,{asChild:!0,children:e.jsxs(o,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-purple-600 hover:text-purple-700 hover:bg-purple-50",onClick:()=>X(s),children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.communityPosts.preview","预览")})]})}),e.jsx(j,{children:e.jsx("p",{children:a("admin.communityPosts.preview","预览帖子")})})]})}),e.jsx(h,{children:e.jsxs(u,{children:[e.jsx(g,{asChild:!0,children:e.jsxs(o,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:()=>q(s),children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("common.details","详情")})]})}),e.jsx(j,{children:e.jsx("p",{children:a("common.viewDetails","查看详情")})})]})}),s.status==="pending"||s.status==="flagged"?e.jsx(h,{children:e.jsxs(u,{children:[e.jsx(g,{asChild:!0,children:e.jsxs(o,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50",onClick:()=>E(s,"approve"),children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.action.approve","发布")})]})}),e.jsx(j,{children:e.jsx("p",{children:a("admin.action.approve","发布")})})]})}):null,e.jsx(h,{children:e.jsxs(u,{children:[e.jsx(g,{asChild:!0,children:e.jsx(o,{variant:"ghost",size:"sm",className:b("flex-1 h-8",s.status==="hidden"?"text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50":"text-amber-600 hover:text-amber-700 hover:bg-amber-50"),onClick:()=>E(s,s.status==="hidden"?"unhide":"hide"),children:s.status==="hidden"?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.action.unhide","显示")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1.5 text-xs hidden sm:inline",children:a("admin.action.hide","隐藏")})]})})}),e.jsx(j,{children:e.jsx("p",{children:s.status==="hidden"?a("admin.action.unhide","显示"):a("admin.action.hide","隐藏")})})]})}),e.jsx(h,{children:e.jsxs(u,{children:[e.jsx(g,{asChild:!0,children:e.jsx(o,{variant:"ghost",size:"sm",className:"flex-1 h-8 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>E(s,"delete"),children:e.jsx(le,{className:"h-4 w-4"})})}),e.jsx(j,{children:e.jsx("p",{children:a("common.delete","删除")})})]})})]})]})})},fe=()=>e.jsx(P,{className:"overflow-hidden",children:e.jsxs(_,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border-b",children:[e.jsx(d,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{className:"h-4 w-24"}),e.jsx(d,{className:"h-3 w-16"})]})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx(d,{className:"h-4 w-full"}),e.jsx(d,{className:"h-4 w-3/4"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{className:"h-12 w-12 rounded-lg"}),e.jsx(d,{className:"h-12 w-12 rounded-lg"})]})]}),e.jsx("div",{className:"px-4 py-3 bg-muted/30 border-t",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx(d,{className:"h-4 w-24"}),e.jsx(d,{className:"h-5 w-16 rounded-full"})]})})]})});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:a("admin.communityPosts.title","帖子管理")}),e.jsx("p",{className:"text-muted-foreground text-sm mt-1",children:a("admin.communityPosts.subtitle","管理和审核社区帖子")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:y==="grid"?"secondary":"ghost",size:"icon",className:"h-9 w-9",onClick:()=>J("grid"),children:e.jsx(we,{className:"h-4 w-4"})}),e.jsx(o,{variant:y==="list"?"secondary":"ghost",size:"icon",className:"h-9 w-9",onClick:()=>J("list"),children:e.jsx(ye,{className:"h-4 w-4"})})]})]}),e.jsx(P,{className:"border-border/60",children:e.jsx(_,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ce,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Be,{placeholder:a("admin.communityPosts.searchPlaceholder","搜索内容..."),value:p,onChange:s=>w(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground hidden sm:block"}),e.jsxs(U,{value:v,onValueChange:T,children:[e.jsx(B,{className:"w-[140px]",children:e.jsx(O,{placeholder:a("admin.status.all","所有状态")})}),e.jsxs(G,{children:[e.jsx(i,{value:"all",children:a("admin.status.all","所有状态")}),e.jsx(i,{value:"approved",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-3.5 w-3.5 text-emerald-600"}),a("admin.status.approved","已发布")]})}),e.jsx(i,{value:"pending",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-3.5 w-3.5 text-amber-600"}),a("admin.status.pending","待审核")]})}),e.jsx(i,{value:"hidden",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-3.5 w-3.5 text-gray-500"}),a("admin.status.hidden","已隐藏")]})}),e.jsx(i,{value:"rejected",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-3.5 w-3.5 text-red-600"}),a("admin.status.rejected","已拒绝")]})})]})]}),e.jsxs(U,{value:A,onValueChange:ne,children:[e.jsx(B,{className:"w-[130px]",children:e.jsx(O,{placeholder:a("admin.moderation.all","所有审核")})}),e.jsxs(G,{children:[e.jsx(i,{value:"all",children:a("admin.moderation.all","所有审核")}),e.jsx(i,{value:"pending",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-3.5 w-3.5 text-gray-500"}),a("admin.moderation.pending","待审")]})}),e.jsx(i,{value:"approved",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-3.5 w-3.5 text-emerald-600"}),a("admin.moderation.approved","通过")]})}),e.jsx(i,{value:"flagged",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-3.5 w-3.5 text-orange-500"}),a("admin.moderation.flagged","标记")]})})]})]}),e.jsxs(U,{value:F,onValueChange:ce,children:[e.jsx(B,{className:"w-[120px]",children:e.jsx(O,{placeholder:a("admin.communityPosts.allTypes","所有类型")})}),e.jsxs(G,{children:[e.jsx(i,{value:"all",children:a("admin.communityPosts.allTypes","所有类型")}),e.jsx(i,{value:"post",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-3.5 w-3.5 text-blue-500"}),a("admin.communityPosts.typePost","普通帖子")]})}),e.jsx(i,{value:"recipe",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-3.5 w-3.5 text-primary"}),a("admin.communityPosts.typeRecipe","食谱")]})})]})]})]})]})})}),N&&e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:e.jsxs("span",{children:[a("admin.communityPosts.total","共")," ",N.length," ",a("admin.communityPosts.posts","篇帖子")]})}),de?e.jsx("div",{className:b("grid gap-4",y==="grid"?"grid-cols-1 md:grid-cols-2 lg:grid-cols-3":"grid-cols-1"),children:Array.from({length:6}).map((s,l)=>e.jsx(fe,{},l))}):N&&N.length>0?e.jsx("div",{className:b("grid gap-4",y==="grid"?"grid-cols-1 md:grid-cols-2 lg:grid-cols-3":"grid-cols-1"),children:N.map(s=>e.jsx(Ne,{post:s},s.id))}):e.jsx(P,{className:"border-dashed",children:e.jsxs(_,{className:"py-16 text-center",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4",children:e.jsx(ke,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("h3",{className:"font-medium text-lg mb-1",children:a("admin.communityPosts.noPosts","暂无帖子")}),e.jsx("p",{className:"text-muted-foreground text-sm",children:a("admin.communityPosts.noPostsDesc","当前筛选条件下没有帖子")})]})}),e.jsx(ls,{post:W,open:!!W,onOpenChange:s=>!s&&q(null)}),e.jsx(ms,{post:$,open:!!$,onOpenChange:s=>!s&&X(null)}),e.jsx(Oe,{open:!!I,onOpenChange:s=>!s&&z(null),children:e.jsxs(Ge,{children:[e.jsxs(Qe,{children:[e.jsxs(We,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-destructive"}),a("common.confirmDelete","确认删除")]}),e.jsx(qe,{children:a("admin.communityPosts.deleteWarning","删除后无法恢复，确定要删除这篇帖子吗？")})]}),e.jsxs($e,{children:[e.jsx(Xe,{children:a("common.cancel","取消")}),e.jsx(Je,{onClick:ue,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:a("common.delete","删除")})]})]})})]})};export{As as default};
//# sourceMappingURL=AdminCommunityPosts-ChK7XhHu.js.map
