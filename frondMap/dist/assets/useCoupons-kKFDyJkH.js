import{s as m,q as _,r as E,v as f}from"./vendor-react-DanJ59UG.js";import{u as g,s as n,z as v}from"./index-Dac7evyM.js";import{i as c}from"./vendor-i18n-jtdHZIRR.js";const S=()=>m({queryKey:["couponTemplates"],queryFn:async()=>{const{data:e,error:t}=await n.from("coupon_templates").select("*").order("created_at",{ascending:!1});if(t)throw t;return e}}),K=()=>{const{user:e}=g(),t=_();return E.useEffect(()=>{if(!e)return;const r=n.channel("user-coupons-changes").on("postgres_changes",{event:"*",schema:"public",table:"user_coupons",filter:`user_id=eq.${e.id}`},()=>{t.invalidateQueries({queryKey:["userCoupons",e.id]})}).subscribe();return()=>{n.removeChannel(r)}},[e,t]),m({queryKey:["userCoupons",e?.id],queryFn:async()=>{if(!e)return[];const{data:r,error:s}=await n.from("user_coupons").select(`
          *,
          coupon_codes (
            *,
            coupon_templates (*)
          )
        `).eq("user_id",e.id).order("claimed_at",{ascending:!1});if(s)throw s;return r},enabled:!!e,staleTime:1e3*30,gcTime:1e3*60*5})},D=e=>m({queryKey:["activityCouponTemplates",e],queryFn:async()=>{const{data:t,error:r}=await n.from("coupon_template_activities").select(`
          coupon_templates (*)
        `).eq("activity_id",e);if(r)throw r;return(t||[]).map(o=>o.coupon_templates).filter(o=>o&&o.is_active&&o.visible)},enabled:!!e}),F=e=>{const{user:t}=g();return m({queryKey:["hasSharedCoupon",e,t?.id],queryFn:async()=>{if(!t)return!1;const{data:r,error:s}=await n.from("user_coupons").select("id").eq("user_id",t.id).eq("activity_id",e).eq("source","share").maybeSingle();if(s)throw s;return!!r},enabled:!!t&&!!e})},Q=()=>m({queryKey:["globalShareCouponTemplate"],queryFn:async()=>{const{data:e,error:t}=await n.from("coupon_templates").select("*").is("activity_id",null).eq("is_active",!0).maybeSingle();if(t)throw t;return e}}),M=e=>m({queryKey:["queryCouponByCode",e],queryFn:async()=>{if(!e)return null;const{data:t,error:r}=await n.from("coupon_codes").select(`
          *,
          coupon_templates (*),
          user_coupons (
            id,
            user_id,
            claimed_at,
            used_at,
            source,
            claimed_email
          )
        `).eq("code",e.trim().toUpperCase()).maybeSingle();if(r)throw r;if(!t)return null;const s=t.user_coupons?.filter(i=>i.user_id).map(i=>i.user_id)||[];let o={};if(s.length>0){const{data:i}=await n.rpc("get_public_profiles",{user_ids:s});i&&(o=i.reduce((d,u)=>(d[u.id]={display_name:u.display_name},d),{}))}const p=t.user_coupons?.map(i=>({...i,profiles:i.user_id&&o[i.user_id]||null}))||[];return{...t,user_coupons:p}},enabled:!!e&&e.trim().length>0}),L=()=>{const{user:e}=g(),{toast:t}=v(),r=_();return f({mutationFn:async({templateId:s,activityId:o,source:p="share"})=>{if(!e)throw new Error("User not authenticated");const i=e.email;if(p==="share"&&i&&o){const{data:l}=await n.from("user_coupons").select("id").eq("claimed_email",i).eq("activity_id",o).eq("source","share").maybeSingle();if(l)throw new Error("EMAIL_ALREADY_CLAIMED")}const{data:d,error:u}=await n.rpc("generate_coupon_code",{template_id_param:s});if(u)throw u;const q=d,{data:y,error:w}=await n.from("coupon_codes").insert({template_id:s,code:q,usage_limit:1,used_count:0,is_active:!0}).select().single();if(w)throw w;const{data:h,error:a}=await n.from("user_coupons").insert({user_id:e.id,coupon_code_id:y.id,activity_id:o||null,source:p,claimed_email:i||null}).select().single();if(a)throw a;return{userCoupon:h,couponCode:y}},onSuccess:(s,o)=>{r.invalidateQueries({queryKey:["userCoupons"]}),o.activityId&&r.invalidateQueries({queryKey:["hasSharedCoupon",o.activityId]}),t({title:c.t("coupon.claimSuccess"),description:c.t("coupon.claimSuccessDescription")})},onError:s=>{const o=s?.message?.includes("user_coupons_share_once_per_activity")||s?.message?.includes("idx_user_coupons_email")||s?.message==="EMAIL_ALREADY_CLAIMED"||s?.code==="23505";if(s?.message==="EMAIL_ALREADY_CLAIMED"){t({title:c.t("coupon.alreadyClaimed"),description:c.t("coupon.emailAlreadyClaimed"),variant:"destructive"});return}o||t({title:c.t("common.error"),description:s.message||"领取失败",variant:"destructive"})}})},U=()=>{const{toast:e}=v(),t=_();return f({mutationFn:async r=>{if(r.id){const{id:s,created_at:o,updated_at:p,...i}=r,{data:d,error:u}=await n.from("coupon_templates").update(i).eq("id",s).select().single();if(u)throw u;return d}else{const{id:s,created_at:o,updated_at:p,...i}=r,{data:d,error:u}=await n.from("coupon_templates").insert(i).select().single();if(u)throw u;return d}},onSuccess:()=>{t.invalidateQueries({queryKey:["couponTemplates"]}),e({title:c.t("common.success"),description:"优惠券模板保存成功"})},onError:r=>{e({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},x=()=>{const{toast:e}=v(),t=_();return f({mutationFn:async r=>{const{error:s}=await n.from("coupon_templates").delete().eq("id",r);if(s)throw s},onSuccess:()=>{t.invalidateQueries({queryKey:["couponTemplates"]}),e({title:c.t("common.success"),description:"优惠券模板删除成功"})},onError:r=>{e({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},R=e=>m({queryKey:["templateActivities",e],queryFn:async()=>{const{data:t,error:r}=await n.from("coupon_template_activities").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            start_date,
            end_date,
            visible
          )
        `).eq("coupon_template_id",e);if(r)throw r;return t||[]},enabled:!!e}),H=()=>{const e=_(),{toast:t}=v();return f({mutationFn:async({templateId:r,activityId:s})=>{const{error:o}=await n.from("coupon_template_activities").insert({coupon_template_id:r,activity_id:s});if(o)throw o},onSuccess:(r,s)=>{e.invalidateQueries({queryKey:["templateActivities",s.templateId]}),e.invalidateQueries({queryKey:["activityCouponTemplates"]}),t({title:c.t("common.success"),description:"活动关联添加成功"})},onError:r=>{t({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},I=()=>{const e=_(),{toast:t}=v();return f({mutationFn:async({templateId:r,activityId:s})=>{const{error:o}=await n.from("coupon_template_activities").delete().eq("coupon_template_id",r).eq("activity_id",s);if(o)throw o},onSuccess:(r,s)=>{e.invalidateQueries({queryKey:["templateActivities",s.templateId]}),e.invalidateQueries({queryKey:["activityCouponTemplates"]}),t({title:c.t("common.success"),description:"活动关联移除成功"})},onError:r=>{t({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},Y=e=>m({queryKey:["templateUsageHistory",e],queryFn:async()=>{if(!e)return[];const{data:t,error:r}=await n.from("coupon_codes").select("id").eq("template_id",e);if(r)throw r;if(!t||t.length===0)return[];const s=t.map(a=>a.id),{data:o,error:p}=await n.from("coupon_usage_history").select("*").in("coupon_code_id",s).order("used_at",{ascending:!1});if(p)throw p;if(!o||o.length===0)return[];const i=[...new Set(o.map(a=>a.used_by_user_id))],{data:d}=await n.from("profiles").select("id, display_name, avatar_url").in("id",i),u=(d||[]).reduce((a,l)=>(a[l.id]={display_name:l.display_name,avatar_url:l.avatar_url},a),{}),q=[...new Set(o.filter(a=>a.restaurant_id).map(a=>a.restaurant_id))];let y={};if(q.length>0){const{data:a}=await n.from("restaurants").select("id, name, name_en, name_pt").in("id",q);y=(a||[]).reduce((l,C)=>(l[C.id]={name:C.name,name_en:C.name_en,name_pt:C.name_pt},l),{})}const{data:w}=await n.from("coupon_codes").select("id, code").in("id",s),h=(w||[]).reduce((a,l)=>(a[l.id]=l.code,a),{});return o.map(a=>({...a,used_by_profile:u[a.used_by_user_id]||null,restaurant:a.restaurant_id&&y[a.restaurant_id]||null,coupon_code:h[a.coupon_code_id]||null}))},enabled:!!e});export{F as a,Q as b,L as c,K as d,U as e,S as f,x as g,R as h,H as i,I as j,Y as k,M as l,D as u};
//# sourceMappingURL=useCoupons-kKFDyJkH.js.map
