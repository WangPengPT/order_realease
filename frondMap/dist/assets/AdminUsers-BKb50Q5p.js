import{p as Z,q as _e,r as o,j as e,c4 as Ue,aM as J,s as H,v as be,ba as Ae,b4 as He,a_ as ms,am as xs,cH as qe,ao as P,bD as G,bY as ae,bx as Je,bU as hs,bC as Ye,ak as ye,X as Qe,aX as us,cI as ps,cJ as js,cK as gs,b9 as fs,aw as Ns,bQ as vs}from"./vendor-react-CQNN3SAN.js";import{f as pe,G as Fe,D as je,W as Ce,B as p,c as ge,d as fe,e as Ne,T as ve,U as W,I as K,a2 as re,a3 as te,a4 as ne,a5 as le,a6 as I,V as ws,s as y,u as ys,S as Ge,g as O,ab as bs,ac as Xe,ad as Ve,ae as $e,P as Te,Q as ze,R as Me,A as Le,t as Ee,v as ce,w as de,x as oe,y as me,z as xe,E as he,C as X,q as V}from"./index-a3KLXDOT.js";import{C as ue}from"./checkbox-CKjDU1eT.js";import{S as We}from"./separator-DpUzX8-a.js";import{g as _s,h as Cs,i as Ss,j as Ds,k as Rs,l as ks,m as Us}from"./useAdmin-61Q6qNsz.js";import{u as qs}from"./useInfiniteScroll-BHl_rpQS.js";import{u as Ls}from"./useLocalizedContent-CVuSz_c7.js";import{U as Es}from"./UserProfileDialog-DnXVsJCk.js";import{e as As}from"./exportUtils-YWmY6fTR.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-vwQGbBim.js";import"./vendor-supabase-BUZyZFPD.js";const Fs=({trigger:a})=>{const{t:h}=Z(),{toast:f}=pe(),b=_e(),{isSupervisor:m}=Fe(),[d,S]=o.useState(!1),[l,D]=o.useState(!1),[c,N]=o.useState({email:"",password:"",displayName:"",phone:"",role:"merchant"}),R=async n=>{n.preventDefault(),D(!0);try{const{data:{session:_}}=await y.auth.getSession(),j=await fetch("https://tzdgqhwyzsxkxnncgzap.supabase.co/functions/v1/admin-create-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${_?.access_token}`},body:JSON.stringify({email:c.email,password:c.password,displayName:c.displayName,phone:c.phone,role:c.role})}),v=await j.json();if(!j.ok)throw new Error(v.error||"Failed to create user");f({title:h("common.success"),description:h("admin.userCreated")}),S(!1),N({email:"",password:"",displayName:"",phone:"",role:"merchant"}),b.invalidateQueries({queryKey:["admin-users"]})}catch(_){console.error("Error creating user:",_),f({title:h("common.error"),description:_.message||h("admin.createUserError"),variant:"destructive"})}finally{D(!1)}};return e.jsxs(je,{open:d,onOpenChange:S,children:[e.jsx(Ce,{asChild:!0,children:a||e.jsxs(p,{children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),h("admin.createUser")]})}),e.jsx(ge,{className:"max-w-[90vw] sm:max-w-[500px]",children:e.jsxs("form",{onSubmit:R,children:[e.jsxs(fe,{children:[e.jsx(Ne,{children:h("admin.createNewUser")}),e.jsx(ve,{children:h("admin.createUserDescription")})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{htmlFor:"email",children:h("auth.email")}),e.jsx(K,{id:"email",type:"email",required:!0,value:c.email,onChange:n=>N({...c,email:n.target.value}),placeholder:"user@example.com"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{htmlFor:"password",children:h("auth.password")}),e.jsx(K,{id:"password",type:"password",required:!0,value:c.password,onChange:n=>N({...c,password:n.target.value}),placeholder:"••••••••",minLength:6})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{htmlFor:"displayName",children:h("profile.displayName")}),e.jsx(K,{id:"displayName",required:!0,value:c.displayName,onChange:n=>N({...c,displayName:n.target.value}),placeholder:h("profile.displayName")})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{htmlFor:"phone",children:h("profile.phone")}),e.jsx(K,{id:"phone",type:"tel",value:c.phone,onChange:n=>N({...c,phone:n.target.value}),placeholder:"+351 XXX XXX XXX"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{htmlFor:"role",children:h("admin.role")}),m?e.jsx(K,{id:"role",value:h("admin.merchant"),disabled:!0,className:"bg-muted"}):e.jsxs(re,{value:c.role,onValueChange:n=>N({...c,role:n}),children:[e.jsx(te,{children:e.jsx(ne,{})}),e.jsxs(le,{children:[e.jsx(I,{value:"merchant",children:h("admin.merchant")}),e.jsx(I,{value:"supervisor",children:h("admin.supervisor")})]})]})]})]}),e.jsxs(ws,{children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>S(!1),disabled:l,children:h("common.cancel")}),e.jsxs(p,{type:"submit",disabled:l,children:[l&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),h("admin.create")]})]})]})})]})},Ts=({open:a,onOpenChange:h,merchantId:f,merchantName:b,userRole:m})=>{const{t:d}=Z(),{toast:S}=pe(),l=_e(),{localizeRestaurant:D}=Ls(),{user:c}=ys(),{isSupervisor:N}=Fe(),[R,n]=o.useState([]),[_,j]=o.useState(""),{data:v}=H({queryKey:["supervisorRestaurants",c?.id],queryFn:async()=>{if(!c||!N)return null;const{data:t,error:i}=await y.from("merchant_restaurants").select("restaurant_id").eq("user_id",c.id);if(i)throw i;return t?.map(w=>w.restaurant_id)||[]},enabled:a&&N&&!!c}),{data:Q,isLoading:L}=H({queryKey:["allRestaurants",v],queryFn:async()=>{let t=y.from("restaurants").select("*").order("name");N&&v&&v.length>0&&(t=t.in("id",v));const{data:i,error:w}=await t;if(w)throw w;return i},enabled:!N||N&&v!==void 0}),{data:r,isLoading:x}=H({queryKey:["merchantRestaurants",f],queryFn:async()=>{const{data:t,error:i}=await y.from("merchant_restaurants").select("restaurant_id").eq("user_id",f);if(i)throw i;return t?.map(w=>w.restaurant_id)||[]},enabled:a}),{data:g}=H({queryKey:["allRestaurantAssignments"],queryFn:async()=>{const{data:t,error:i}=await y.from("merchant_restaurants").select("restaurant_id, user_id");if(i)throw i;if(!t||t.length===0)return{};const w=[...new Set(t.map(U=>U.user_id))],{data:z}=await y.from("profiles").select("id, display_name").in("id",w),{data:k}=await y.from("user_roles").select("user_id, role").in("user_id",w),B=new Map(z?.map(U=>[U.id,U.display_name])||[]),T=new Map(k?.map(U=>[U.user_id,U.role])||[]),Y={};return t.forEach(U=>{Y[U.restaurant_id]||(Y[U.restaurant_id]=[]),Y[U.restaurant_id].push({userId:U.user_id,displayName:B.get(U.user_id)||"Unknown",role:T.get(U.user_id)||"user"})}),Y},enabled:a});o.useEffect(()=>{r&&n(r)},[r]);const q=be({mutationFn:async()=>{const{error:t}=await y.from("merchant_restaurants").delete().eq("user_id",f);if(t)throw t;if(R.length>0){const{error:i}=await y.from("merchant_restaurants").insert(R.map(w=>({user_id:f,restaurant_id:w})));if(i)throw i}},onSuccess:()=>{S({title:d("toast.merchantRestaurantsSaved"),description:d("toast.merchantRestaurantsDescription")}),l.invalidateQueries({queryKey:["merchantRestaurants"]}),l.invalidateQueries({queryKey:["adminUsers"]}),h(!1)},onError:t=>{console.error("Error saving merchant restaurants:",t),S({title:d("toast.merchantRestaurantsSaveFailed"),description:d("toast.merchantRestaurantsDescriptionFailed"),variant:"destructive"})}}),C=t=>{m==="merchant"?R.includes(t)?n([]):n([t]):n(i=>i.includes(t)?i.filter(w=>w!==t):[...i,t])},A=()=>{q.mutate()},E=L||x,F=Q?.filter(t=>_.trim()?D(t).name.toLowerCase().includes(_.toLowerCase())||t.address.toLowerCase().includes(_.toLowerCase()):!0);return e.jsx(je,{open:a,onOpenChange:h,children:e.jsxs(ge,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(fe,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"w-5 h-5"}),d(m==="merchant"?"merchant.manageRestaurants":"merchant.manageSupervisorRestaurants")]}),e.jsxs(ve,{children:[d("merchant.assignRestaurantsTo",{name:b}),m==="merchant"&&e.jsx("span",{className:"block mt-1 text-primary font-medium",children:d("merchant.merchantOnlyOne")}),e.jsx("span",{className:"block mt-1 text-muted-foreground text-xs",children:d("merchant.saveReminder")})]})]}),E?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{className:"w-6 h-6 animate-spin text-primary"})}):e.jsxs("div",{className:"flex flex-col flex-1 min-h-0",children:[e.jsxs("div",{className:"relative mb-4 flex-shrink-0",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(K,{placeholder:d("merchant.searchRestaurants"),value:_,onChange:t=>j(t.target.value),className:"pl-9"})]}),e.jsx(Ge,{className:"flex-1 min-h-0 pr-4",children:e.jsx("div",{className:"space-y-3",children:F?.map(t=>{const i=R.includes(t.id),w=D(t),z=g?.[t.id]?.filter(k=>k.userId!==f)||[];return e.jsxs("div",{className:"flex items-start space-x-3 p-4 rounded-lg border hover:bg-accent/50 transition-all cursor-pointer",onClick:()=>C(t.id),children:[e.jsx(ue,{checked:i,className:"mt-1"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 flex-wrap",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:w.name}),i&&e.jsx(O,{variant:"secondary",className:"text-xs",children:d("merchant.selected")})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(ms,{className:"w-3 h-3"}),e.jsx("span",{className:"line-clamp-1",children:t.address})]}),t.type&&t.type.length>0&&e.jsx("div",{className:"flex gap-1 mt-2 flex-wrap",children:t.type.slice(0,2).map((k,B)=>e.jsx(O,{variant:"outline",className:"text-xs",children:k},B))}),z.length>0&&e.jsxs("div",{className:"flex items-center gap-1.5 mt-2 flex-wrap",children:[e.jsx(xs,{className:"w-3 h-3 text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[d("merchant.assignedTo"),":"]}),e.jsxs(bs,{children:[z.slice(0,3).map((k,B)=>e.jsxs(Xe,{children:[e.jsx(Ve,{asChild:!0,children:e.jsx(O,{variant:"outline",className:`text-xs ${k.role==="supervisor"?"border-blue-500/50 text-blue-600 dark:text-blue-400":"border-amber-500/50 text-amber-600 dark:text-amber-400"}`,children:k.displayName})}),e.jsx($e,{children:e.jsx("p",{children:k.role==="supervisor"?d("roles.supervisor"):d("roles.merchant")})})]},k.userId)),z.length>3&&e.jsxs(Xe,{children:[e.jsx(Ve,{asChild:!0,children:e.jsxs(O,{variant:"outline",className:"text-xs",children:["+",z.length-3]})}),e.jsx($e,{children:e.jsx("div",{className:"space-y-1",children:z.slice(3).map(k=>e.jsxs("p",{children:[k.displayName," (",k.role==="supervisor"?d("roles.supervisor"):d("roles.merchant"),")"]},k.userId))})})]})]})]})]})]},t.id)})})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:m==="merchant"?d("merchant.selectedCountOne",{count:R.length}):d("merchant.selectedCountMulti",{count:R.length})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>h(!1),disabled:q.isPending,children:d("common.cancel")}),e.jsxs(p,{onClick:A,disabled:q.isPending,children:[q.isPending&&e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),d("common.save")]})]})]})]})]})})},zs=({merchantId:a,merchantName:h,trigger:f})=>{const{t:b}=Z(),{toast:m}=pe(),d=_e(),[S,l]=o.useState(!1),[D,c]=o.useState(""),{data:N=[],isLoading:R}=H({queryKey:["supervisors"],queryFn:async()=>{const{data:r,error:x}=await y.from("user_roles").select("user_id").eq("role","supervisor");if(x)throw x;const g=r.map(A=>A.user_id);if(g.length===0)return[];const{data:q,error:C}=await y.from("profiles").select("id, display_name").in("id",g);if(C)throw C;return q},enabled:S}),{data:n=[]}=H({queryKey:["merchant-restaurants",a],queryFn:async()=>{const{data:r,error:x}=await y.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(x)throw x;return r.map(g=>g.restaurant_id)},enabled:S}),{data:_=[]}=H({queryKey:["merchant-supervisors",a],queryFn:async()=>{if(n.length===0)return[];const{data:r,error:x}=await y.from("merchant_restaurants").select("user_id, restaurant_id").in("restaurant_id",n).neq("user_id",a);if(x)throw x;const g=[...new Set(r.map(t=>t.user_id))];if(g.length===0)return[];const{data:q,error:C}=await y.from("user_roles").select("user_id").in("user_id",g).eq("role","supervisor");if(C)throw C;const A=q.map(t=>t.user_id);if(A.length===0)return[];const{data:E,error:F}=await y.from("profiles").select("id, display_name").in("id",A);if(F)throw F;return E},enabled:S&&n.length>0}),j=be({mutationFn:async r=>{if(n.length===0)throw new Error("该商家没有管理任何餐厅");const x=n.map(q=>({user_id:r,restaurant_id:q})),{error:g}=await y.from("merchant_restaurants").upsert(x,{onConflict:"user_id,restaurant_id"});if(g)throw g},onSuccess:()=>{m({title:b("admin.supervisor.assignSuccess"),description:b("admin.supervisor.assignMerchantSuccess")}),d.invalidateQueries({queryKey:["merchant-supervisors"]}),c(""),l(!1)},onError:r=>{m({title:b("admin.supervisor.assignError"),description:r.message,variant:"destructive"})}}),v=be({mutationFn:async r=>{const{error:x}=await y.from("merchant_restaurants").delete().eq("user_id",r).in("restaurant_id",n);if(x)throw x},onSuccess:()=>{m({title:b("admin.supervisor.removeSuccess"),description:b("admin.supervisor.removeSupervisorSuccess")}),d.invalidateQueries({queryKey:["merchant-supervisors"]})},onError:r=>{m({title:b("admin.supervisor.removeError"),description:r.message,variant:"destructive"})}}),Q=()=>{D&&j.mutate(D)},L=r=>{v.mutate(r)};return e.jsxs(je,{open:S,onOpenChange:l,children:[e.jsx(Ce,{asChild:!0,children:f||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"分配主管"]})}),e.jsxs(ge,{className:"max-w-md",children:[e.jsxs(fe,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"分配商家给主管"]}),e.jsxs(ve,{children:["为商家 ",e.jsx("strong",{children:h})," 分配主管"]})]}),e.jsxs("div",{className:"space-y-4",children:[_.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"当前主管"}),e.jsx("div",{className:"space-y-2",children:_.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm",children:r.display_name})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>L(r.id),disabled:v.isPending,children:"移除"})]},r.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"分配新主管"}),e.jsxs(re,{value:D,onValueChange:c,children:[e.jsx(te,{children:e.jsx(ne,{placeholder:"选择主管"})}),e.jsx(le,{children:R?e.jsx("div",{className:"p-2 text-center",children:e.jsx(J,{className:"w-4 h-4 animate-spin mx-auto"})}):N.length===0?e.jsx("div",{className:"p-2 text-center text-sm text-muted-foreground",children:"没有可用的主管"}):N.filter(r=>!_.find(x=>x.id===r.id)).map(r=>e.jsx(I,{value:r.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-4 h-4 text-blue-500"}),r.display_name]})},r.id))})]})]}),n.length===0&&e.jsx(O,{variant:"secondary",className:"w-full justify-center",children:"该商家没有管理任何餐厅"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(p,{variant:"outline",onClick:()=>l(!1),children:"取消"}),e.jsx(p,{onClick:Q,disabled:!D||j.isPending||n.length===0,children:j.isPending?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),"分配中..."]}):"确认分配"})]})]})]})]})},Ms=({supervisorId:a,supervisorName:h,trigger:f})=>{const{t:b}=Z(),{toast:m}=pe(),d=_e(),[S,l]=o.useState(!1),[D,c]=o.useState([]),{data:N=[],isLoading:R}=H({queryKey:["all-merchants-with-restaurants"],queryFn:async()=>{const{data:r,error:x}=await y.from("user_roles").select("user_id").eq("role","merchant");if(x)throw x;const g=r.map(F=>F.user_id);if(g.length===0)return[];const{data:q,error:C}=await y.from("profiles").select("id, display_name, avatar_url").in("id",g);if(C)throw C;const{data:A,error:E}=await y.from("merchant_restaurants").select("user_id, restaurant_id, restaurants(name)").in("user_id",g);if(E)throw E;return q.map(F=>({...F,restaurants:A.filter(t=>t.user_id===F.id).map(t=>({id:t.restaurant_id,name:t.restaurants?.name||"Unknown"}))}))},enabled:S}),{data:n=[],isLoading:_}=H({queryKey:["supervisor-managed-merchants",a],queryFn:async()=>{const{data:r,error:x}=await y.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(x)throw x;const g=r.map(t=>t.restaurant_id);if(g.length===0)return[];const{data:q,error:C}=await y.from("merchant_restaurants").select("user_id").in("restaurant_id",g).neq("user_id",a);if(C)throw C;const A=[...new Set(q.map(t=>t.user_id))];if(A.length===0)return[];const{data:E,error:F}=await y.from("user_roles").select("user_id").in("user_id",A).eq("role","merchant");if(F)throw F;return E.map(t=>t.user_id)},enabled:S});o.useState(()=>{n.length>0&&D.length===0&&c(n)});const j=be({mutationFn:async()=>{const{data:r,error:x}=await y.from("merchant_restaurants").select("user_id, restaurant_id").in("user_id",D);if(x)throw x;const{data:g,error:q}=await y.from("merchant_restaurants").select("restaurant_id").eq("user_id",a);if(q)throw q;const C=g.map(i=>i.restaurant_id),A=r.map(i=>i.restaurant_id),E=A.filter(i=>!C.includes(i)),F=N.flatMap(i=>i.restaurants.map(w=>w.id)),t=C.filter(i=>F.includes(i)&&!A.includes(i));if(E.length>0){const i=E.map(z=>({user_id:a,restaurant_id:z})),{error:w}=await y.from("merchant_restaurants").upsert(i,{onConflict:"user_id,restaurant_id"});if(w)throw w}if(t.length>0){const{error:i}=await y.from("merchant_restaurants").delete().eq("user_id",a).in("restaurant_id",t);if(i)throw i}},onSuccess:()=>{m({title:b("admin.supervisor.saveSuccess"),description:b("admin.supervisor.merchantAssignmentUpdated")}),d.invalidateQueries({queryKey:["supervisor-managed-merchants"]}),d.invalidateQueries({queryKey:["merchant-restaurants"]}),l(!1)},onError:r=>{m({title:b("admin.supervisor.saveError"),description:r.message,variant:"destructive"})}}),v=r=>{c(x=>x.includes(r)?x.filter(g=>g!==r):[...x,r])},Q=()=>{j.mutate()},L=o.useState(!1);return!L[0]&&n.length>0&&(c(n),L[1](!0)),e.jsxs(je,{open:S,onOpenChange:r=>{l(r),r&&c(n)},children:[e.jsx(Ce,{asChild:!0,children:f||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"管理商家"]})}),e.jsxs(ge,{className:"max-w-lg",children:[e.jsxs(fe,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5 text-blue-500"}),"分配商家给主管"]}),e.jsxs(ve,{children:["选择要分配给 ",e.jsx("strong",{children:h})," 管理的商家"]})]}),e.jsxs("div",{className:"space-y-4",children:[R||_?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(J,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):N.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ae,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"没有可分配的商家"})]}):e.jsx(Ge,{className:"h-[300px] pr-4",children:e.jsx("div",{className:"space-y-2",children:N.map(r=>e.jsxs("div",{className:`flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition-colors ${D.includes(r.id)?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>v(r.id),children:[e.jsx(ue,{checked:D.includes(r.id),onCheckedChange:()=>v(r.id)}),e.jsxs(Te,{className:"h-10 w-10",children:[e.jsx(ze,{src:r.avatar_url||""}),e.jsx(Me,{className:"bg-emerald-100 text-emerald-700",children:r.display_name?.charAt(0).toUpperCase()||"M"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r.display_name}),r.restaurants.length>0?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Ae,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:r.restaurants.map(x=>x.name).join(", ")})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"无餐厅"})]}),e.jsxs(O,{variant:"outline",className:"text-xs",children:[e.jsx(ae,{className:"w-3 h-3 mr-1"}),"商家"]})]},r.id))})}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["已选择 ",D.length," 个商家"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>l(!1),children:"取消"}),e.jsx(p,{onClick:Q,disabled:j.isPending,children:j.isPending?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),"保存中..."]}):"保存"})]})]})]})]})]})},Is=({merchant:a,trigger:h})=>{const{t:f}=Z(),[b,m]=o.useState(!1),[d,S]=o.useState(a.display_name),[l,D]=o.useState(a.phone||""),[c,N]=o.useState(null),[R,n]=o.useState(a.avatar_url||""),_=_s(),j=Cs(),v=L=>{const r=L.target.files?.[0];if(r){if(r.size>2*1024*1024)return;N(r),n(URL.createObjectURL(r))}},Q=async()=>{let L=a.avatar_url;if(c){const r=await j.mutateAsync({file:c,userId:a.id});r&&(L=r)}await _.mutateAsync({userId:a.id,display_name:d,phone:l||void 0,avatar_url:L||void 0}),m(!1)};return e.jsxs(je,{open:b,onOpenChange:m,children:[e.jsx(Ce,{asChild:!0,children:h||e.jsxs(p,{variant:"outline",size:"sm",children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"编辑资料"]})}),e.jsxs(ge,{className:"max-w-[90vw] sm:max-w-[425px]",children:[e.jsxs(fe,{children:[e.jsx(Ne,{children:"编辑商家资料"}),e.jsx(ve,{children:"修改商家的个人信息和头像"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsxs(Te,{className:"w-24 h-24",children:[e.jsx(ze,{src:R}),e.jsx(Me,{children:d?.charAt(0).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx(K,{type:"file",accept:"image/*",onChange:v,className:"hidden",id:"avatar-upload"}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>document.getElementById("avatar-upload")?.click(),children:[e.jsx(hs,{className:"w-4 h-4 mr-2"}),f("profile.uploadAvatar")]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"displayName",children:f("profile.displayName")}),e.jsx(K,{id:"displayName",value:d,onChange:L=>S(L.target.value),placeholder:f("profile.displayName")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"phone",children:f("profile.phone")}),e.jsx(K,{id:"phone",value:l,onChange:L=>D(L.target.value),placeholder:f("profile.phone")})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>m(!1),children:f("common.cancel")}),e.jsx(p,{onClick:Q,disabled:_.isPending||j.isPending,children:_.isPending||j.isPending?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),f("common.loading")]}):f("common.save")})]})]})]})},Ps=({open:a,onOpenChange:h,userName:f,userId:b,userRole:m,onConfirm:d,isDeleting:S=!1})=>{const{t:l}=Z(),[D,c]=o.useState(1),[N,R]=o.useState(""),n=()=>{c(1),R(""),h(!1)},_=()=>{c(2)},j=()=>{N.toLowerCase()==="delete"&&d()};return e.jsx(Le,{open:a,onOpenChange:v=>{v?h(v):n()},children:e.jsx(Ee,{className:"max-w-[90vw] sm:max-w-[500px]",children:D===1?e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ye,{className:"h-5 w-5"}),l("admin.deleteUser")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:l("admin.deleteUserWarning")}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[l("admin.userName"),":"]})," ",f]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[l("admin.userRole"),":"]})," ",m]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:l("admin.deleteUserConsequences")}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:l("admin.deleteUserData1")}),e.jsx("li",{children:l("admin.deleteUserData2")}),e.jsx("li",{children:l("admin.deleteUserData3")}),e.jsx("li",{children:l("admin.deleteUserData4")})]})]}),m==="admin"&&e.jsx("div",{className:"bg-destructive/20 border border-destructive p-3 rounded-lg",children:e.jsxs("p",{className:"text-sm font-semibold text-destructive",children:["⚠️ ",l("admin.deleteAdminWarning")]})})]})]}),e.jsxs(me,{children:[e.jsx(xe,{onClick:n,children:l("common.cancel")}),e.jsx(he,{onClick:_,className:"bg-destructive hover:bg-destructive/90",children:l("common.continue")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(ye,{className:"h-5 w-5"}),l("admin.confirmDeleteUser")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsx("p",{className:"text-foreground font-medium",children:l("admin.finalDeleteWarning",{userName:f})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"delete-confirm",className:"text-sm font-medium",children:l("admin.typeDeleteToConfirm")}),e.jsx(K,{id:"delete-confirm",value:N,onChange:v=>R(v.target.value),placeholder:"DELETE",className:"uppercase",autoComplete:"off"})]})]})]}),e.jsxs(me,{children:[e.jsx(xe,{onClick:n,children:l("common.cancel")}),e.jsx(he,{onClick:j,disabled:N.toLowerCase()!=="delete"||S,className:"bg-destructive hover:bg-destructive/90",children:l(S?"common.loading":"admin.deleteUser")})]})]})})})},ea=()=>{const{t:a}=Z(),{toast:h}=pe(),{isSupervisor:f,isAdmin:b}=Fe(),{data:m,isLoading:d}=Ss(),S=Ds(),l=Rs(),D=ks(),c=Us(),[N,R]=o.useState(null),[n,_]=o.useState(""),[j,v]=o.useState([]),[Q,L]=o.useState("user"),[r,x]=o.useState(""),[g,q]=o.useState("all"),[C,A]=o.useState("name"),[E,F]=o.useState("asc"),[t,i]=o.useState(null),[w,z]=o.useState({open:!1,userId:"",userName:"",userRole:""}),[k,B]=o.useState({open:!1,step:1,confirmText:""}),[T,Y]=o.useState({open:!1,userId:"",userName:"",currentRole:"",newRole:""}),[U,Ie]=o.useState({open:!1,merchantId:"",merchantName:"",userRole:"merchant"}),[we,Pe]=o.useState({open:!1,userId:"",userName:"",userRole:""}),Be=["user","merchant","supervisor","admin"],Ke=f?Be.filter(s=>s==="user"||s==="merchant"):Be,ee=o.useMemo(()=>m?{total:m.length,admins:m.filter(s=>s.role==="admin").length,supervisors:m.filter(s=>s.role==="supervisor").length,merchants:m.filter(s=>s.role==="merchant").length,regularUsers:m.filter(s=>s.role==="user").length}:{total:0,admins:0,supervisors:0,merchants:0,regularUsers:0},[m]),se=o.useMemo(()=>{if(!m)return[];let s=m.filter(u=>{const M=r===""||u.display_name.toLowerCase().includes(r.toLowerCase())||u.phone?.toLowerCase().includes(r.toLowerCase())||u.email?.toLowerCase().includes(r.toLowerCase()),$=g==="all"||u.role===g;return M&&$});return s.sort((u,M)=>{let $=0;if(C==="name")$=u.display_name.localeCompare(M.display_name);else if(C==="created"){const Re=new Date(u.auth_created_at||u.created_at).getTime(),ke=new Date(M.auth_created_at||M.created_at).getTime();$=Re-ke}else if(C==="lastLogin"){const Re=u.last_sign_in_at?new Date(u.last_sign_in_at).getTime():0,ke=M.last_sign_in_at?new Date(M.last_sign_in_at).getTime():0;$=Re-ke}return E==="asc"?$:-$}),s},[m,r,g,C,E]),{displayedData:Se,hasMore:Ze,reset:Oe,displayedCount:es,sentinelRef:ss}=qs({data:se,initialItemsPerPage:30,incrementPerPage:30});o.useEffect(()=>{Oe()},[r,g,C,E,Oe]);const as=()=>{if(!m||m.length===0){h({title:a("common.error"),description:a("admin.noDataToExport"),variant:"destructive"});return}As(m),h({title:a("common.success"),description:a("admin.exportSuccess")})},rs=s=>{v(u=>u.includes(s)?u.filter(M=>M!==s):[...u,s])},ts=()=>{j.length===se?.length?v([]):v(se?.map(s=>s.id)||[])},ns=()=>{w.userId&&c.mutate(w.userId,{onSuccess:()=>{z({open:!1,userId:"",userName:"",userRole:""})},onError:()=>{z({open:!1,userId:"",userName:"",userRole:""})}})},ls=(s,u,M)=>{z({open:!0,userId:s,userName:u,userRole:M})},is=()=>{j.length===0||k.confirmText.toLowerCase()!=="delete"||l.mutate(j,{onSuccess:()=>{v([]),B({open:!1,step:1,confirmText:""})}})},cs=()=>{j.length!==0&&(D.mutate({userIds:j,role:Q}),v([]))},ds=()=>{T.userId&&T.newRole&&S.mutate({userId:T.userId,role:T.newRole},{onSuccess:()=>{Y({open:!1,userId:"",userName:"",currentRole:"",newRole:""}),R(null),_("")}})},os=(s,u,M,$)=>{Y({open:!0,userId:s,userName:u,currentRole:M,newRole:$})},De=s=>{switch(s){case"admin":return"bg-primary text-primary-foreground hover:bg-primary/90";case"supervisor":return"bg-blue-500 text-white hover:bg-blue-600";case"merchant":return"bg-emerald-500 text-white hover:bg-emerald-600";default:return"bg-muted text-muted-foreground hover:bg-muted/80"}},ie=s=>{switch(s){case"admin":return e.jsx(P,{className:"h-3.5 w-3.5"});case"supervisor":return e.jsx(P,{className:"h-3.5 w-3.5"});case"merchant":return e.jsx(ae,{className:"h-3.5 w-3.5"});default:return e.jsx(G,{className:"h-3.5 w-3.5"})}};return d?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:a("common.loading")})]})}):e.jsxs("div",{className:"space-y-6 w-full max-w-full overflow-x-hidden",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(qe,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:a("admin.userManagement")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.manageUserRoles")})]})]})}),f?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx(X,{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200 dark:from-emerald-950/20 dark:to-emerald-900/20 dark:border-emerald-900/30",children:e.jsx(V,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:a("admin.managedMerchants")}),e.jsx("p",{className:"text-2xl font-bold",children:ee.merchants})]}),e.jsx(ae,{className:"h-8 w-8 text-emerald-500"})]})})})}):e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3",children:[e.jsx(X,{className:"bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.totalUsersLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.total})]}),e.jsx(G,{className:"h-6 w-6 text-primary/60 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 dark:from-red-950/20 dark:to-red-900/20 dark:border-red-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.adminsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.admins})]}),e.jsx(P,{className:"h-6 w-6 text-red-500 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200 dark:from-blue-950/20 dark:to-blue-900/20 dark:border-blue-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.supervisorsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.supervisors})]}),e.jsx(P,{className:"h-6 w-6 text-blue-500 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200 dark:from-emerald-950/20 dark:to-emerald-900/20 dark:border-emerald-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.merchantsLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.merchants})]}),e.jsx(ae,{className:"h-6 w-6 text-emerald-500 flex-shrink-0"})]})})}),e.jsx(X,{className:"bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200 dark:from-gray-950/20 dark:to-gray-900/20 dark:border-gray-900/30 min-w-0",children:e.jsx(V,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:a("admin.regularUsersLabel")}),e.jsx("p",{className:"text-xl font-bold",children:ee.regularUsers})]}),e.jsx(G,{className:"h-6 w-6 text-gray-500 flex-shrink-0"})]})})})]}),e.jsx(X,{children:e.jsx(V,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"relative",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(K,{placeholder:a("admin.searchUserPlaceholder"),value:r,onChange:s=>x(s.target.value),className:"pl-10 pr-10"}),r&&e.jsx(p,{variant:"ghost",size:"sm",className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7 p-0",onClick:()=>x(""),children:e.jsx(Qe,{className:"h-4 w-4"})})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[!f&&e.jsxs(re,{value:g,onValueChange:q,children:[e.jsxs(te,{className:"w-full lg:w-[200px]",children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),e.jsx(ne,{placeholder:a("admin.filterRole")})]}),e.jsxs(le,{children:[e.jsx(I,{value:"all",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),a("admin.allRolesLabel")]})}),e.jsx(I,{value:"admin",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4 text-red-500"}),a("admin.adminsLabel")]})}),e.jsx(I,{value:"supervisor",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4 text-blue-500"}),a("admin.supervisorsLabel")]})}),e.jsx(I,{value:"merchant",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-emerald-500"}),a("admin.merchantsLabel")]})}),e.jsx(I,{value:"user",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 text-gray-500"}),a("admin.regularUsersLabel")]})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(re,{value:C,onValueChange:s=>A(s),children:[e.jsxs(te,{className:"w-full lg:w-[160px]",children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),e.jsx(ne,{})]}),e.jsxs(le,{children:[e.jsx(I,{value:"name",children:a("admin.sortByName")}),e.jsx(I,{value:"created",children:a("admin.sortByCreated")}),e.jsx(I,{value:"lastLogin",children:a("admin.sortByLastLogin")})]})]}),e.jsx(p,{variant:"outline",size:"icon",onClick:()=>F(s=>s==="asc"?"desc":"asc"),title:a(E==="asc"?"admin.sortAsc":"admin.sortDesc"),children:E==="asc"?e.jsx(js,{className:"h-4 w-4"}):e.jsx(gs,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[b&&e.jsx(Fs,{trigger:e.jsxs(p,{variant:"default",size:"default",children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:a("admin.createUser")}),e.jsx("span",{className:"sm:hidden",children:a("admin.create")})]})}),e.jsxs(p,{variant:"outline",onClick:as,children:[e.jsx(fs,{className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:a("admin.exportLabel")})]})]})]})]})})}),b&&j.length>0&&e.jsx(X,{className:"border-primary/50 bg-primary/5",children:e.jsx(V,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{checked:!0,onCheckedChange:()=>v([])}),e.jsxs("span",{className:"font-semibold",children:["已选择 ",j.length," 个用户"]})]}),e.jsxs(p,{variant:"ghost",size:"sm",onClick:()=>v([]),children:[e.jsx(Qe,{className:"h-4 w-4 mr-1"}),"清除选择"]})]}),e.jsx(We,{}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"批量更改角色为："}),e.jsxs(re,{value:Q,onValueChange:s=>L(s),children:[e.jsx(te,{className:"w-full sm:w-[160px]",children:e.jsx(ne,{})}),e.jsx(le,{children:Ke.map(s=>e.jsx(I,{value:s,children:e.jsxs("div",{className:"flex items-center gap-2",children:[ie(s),e.jsx("span",{className:"capitalize",children:s})]})},s))})]}),e.jsxs(p,{onClick:cs,size:"default",children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),"应用"]})]}),e.jsxs(p,{variant:"destructive",size:"default",onClick:()=>B({open:!0,step:1,confirmText:""}),children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),"批量删除"]})]})]})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{checked:j.length===se?.length&&se.length>0,onCheckedChange:ts}),e.jsx("span",{className:"font-medium text-sm",children:"全选"})]}),e.jsxs(O,{variant:"secondary",className:"text-xs",children:[es," / ",se?.length||0]})]}),Se&&Se.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3",children:Se.map(s=>e.jsx(X,{className:`transition-all duration-200 ${t===s.id?"ring-2 ring-primary":"hover:shadow-md"} ${s.is_banned?"border-orange-300 bg-orange-50/50 dark:bg-orange-950/20":""}`,children:e.jsxs(V,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-4 py-2",children:[e.jsx(ue,{checked:j.includes(s.id),onCheckedChange:()=>rs(s.id),onClick:u=>u.stopPropagation(),className:"h-5 w-5"}),e.jsxs(Te,{className:"h-14 w-14 flex-shrink-0",children:[e.jsx(ze,{src:s.avatar_url||""}),e.jsx(Me,{className:"text-lg font-medium bg-primary/10 text-primary",children:s.display_name?.charAt(0).toUpperCase()||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-base truncate",children:s.display_name}),s.is_banned&&e.jsx(O,{variant:"outline",className:"text-xs px-1.5 py-0.5 text-orange-500 border-orange-300",children:"已封禁"})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.email||s.phone||"未设置联系方式"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.last_sign_in_at?`最后登录: ${new Date(s.last_sign_in_at).toLocaleString("zh-CN")}`:"从未登录"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs(O,{className:`${De(s.role)} text-xs px-2.5 py-1`,children:[ie(s.role),e.jsx("span",{className:"ml-1.5 capitalize",children:s.role})]}),e.jsx(p,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>i(t===s.id?null:s.id),children:e.jsx(Ns,{className:`h-5 w-5 transition-transform ${t===s.id?"rotate-180":""}`})})]})]}),t===s.id&&e.jsxs("div",{className:"mt-3 pt-3 border-t space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"邮箱:"}),e.jsx("p",{className:"truncate",children:s.email||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"电话:"}),e.jsx("p",{className:"truncate",children:s.phone||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"创建时间:"}),e.jsx("p",{children:s.auth_created_at?new Date(s.auth_created_at).toLocaleDateString("zh-CN"):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"最后登录:"}),e.jsx("p",{children:s.last_sign_in_at?new Date(s.last_sign_in_at).toLocaleString("zh-CN"):"-"})]})]}),b&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(re,{value:N===s.id?n:"",onValueChange:u=>{R(s.id),_(u)},children:[e.jsx(te,{className:"h-8 text-xs flex-1",children:e.jsx(ne,{placeholder:"更改角色..."})}),e.jsx(le,{children:Ke.filter(u=>u!==s.role).map(u=>e.jsx(I,{value:u,children:e.jsxs("div",{className:"flex items-center gap-2",children:[ie(u),e.jsx("span",{className:"capitalize",children:u})]})},u))})]}),e.jsx(p,{size:"sm",className:"h-8 text-xs",onClick:()=>{N===s.id&&n&&os(s.id,s.display_name,s.role,n)},disabled:N!==s.id||!n,children:"确认"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>Pe({open:!0,userId:s.id,userName:s.display_name,userRole:s.role}),children:[e.jsx(vs,{className:"mr-1.5 h-3.5 w-3.5"}),"查看资料"]}),f&&s.role==="merchant"&&e.jsx(Is,{merchant:{id:s.id,display_name:s.display_name,phone:s.phone,avatar_url:s.avatar_url},trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(Je,{className:"mr-1.5 h-3.5 w-3.5"}),"编辑资料"]})}),(s.role==="merchant"||s.role==="supervisor")&&e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>Ie({open:!0,merchantId:s.id,merchantName:s.display_name,userRole:s.role}),children:[e.jsx(Ae,{className:"mr-1.5 h-3.5 w-3.5"}),"餐厅"]}),b&&s.role==="merchant"&&e.jsx(zs,{merchantId:s.id,merchantName:s.display_name,trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(qe,{className:"mr-1.5 h-3.5 w-3.5"}),"分配主管"]})}),b&&s.role==="supervisor"&&e.jsx(Ms,{supervisorId:s.id,supervisorName:s.display_name,trigger:e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 px-3 text-xs",children:[e.jsx(G,{className:"mr-1.5 h-3.5 w-3.5"}),a("admin.users.manageMerchant")]})}),b&&s.role!=="admin"&&e.jsxs(p,{variant:"destructive",size:"sm",className:"h-8 px-3 text-xs",onClick:()=>ls(s.id,s.display_name,s.role),children:[e.jsx(ye,{className:"mr-1.5 h-3.5 w-3.5"}),a("admin.users.delete")]})]})]})]})},s.id))}):e.jsx(X,{children:e.jsx(V,{className:"pt-12 pb-12",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(G,{className:"h-16 w-16 text-muted-foreground/50 mx-auto"}),e.jsx("h3",{className:"text-lg font-semibold",children:a("admin.users.noUsersFound")}),e.jsx("p",{className:"text-muted-foreground",children:a(r||g!=="all"?"admin.users.adjustFilters":"admin.users.noUsersYet")})]})})}),Ze&&e.jsx("div",{ref:ss,className:"flex justify-center py-4",children:e.jsx(J,{className:"h-6 w-6 animate-spin text-muted-foreground"})})]}),e.jsx(Le,{open:T.open,onOpenChange:s=>{s||Y({open:!1,userId:"",userName:"",currentRole:"",newRole:""})},children:e.jsxs(Ee,{className:"max-w-[90vw] sm:max-w-[500px]",children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5 text-primary"}),"确认角色更改"]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"用户："}),e.jsx("span",{className:"font-semibold text-foreground",children:T.userName})]}),e.jsx(We,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"当前角色："}),e.jsxs(O,{className:De(T.currentRole),children:[ie(T.currentRole),e.jsx("span",{className:"ml-1.5 capitalize",children:T.currentRole})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"text-2xl text-primary",children:"↓"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"新角色："}),e.jsxs(O,{className:De(T.newRole),children:[ie(T.newRole),e.jsx("span",{className:"ml-1.5 capitalize",children:T.newRole})]})]})]}),T.newRole==="admin"&&e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg flex gap-3",children:[e.jsx(P,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-destructive text-sm",children:"⚠️ 警告：管理员权限"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"您即将授予该用户管理员权限。管理员可以管理所有用户、餐厅和活动，包括删除数据和分配角色。"})]})]}),T.currentRole==="admin"&&e.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg flex gap-3",children:[e.jsx(P,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-destructive text-sm",children:"⚠️ 警告：移除管理员权限"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"您即将移除该用户的管理员权限。该用户将失去对系统的完全访问权限。"})]})]}),e.jsx("p",{className:"text-sm text-center text-muted-foreground",children:"此操作将立即生效。确定要继续吗？"})]})]}),e.jsxs(me,{children:[e.jsx(xe,{children:"取消"}),e.jsx(he,{onClick:ds,className:"bg-primary",children:"确认更改"})]})]})}),e.jsx(Ts,{open:U.open,onOpenChange:s=>Ie({...U,open:s}),merchantId:U.merchantId,merchantName:U.merchantName,userRole:U.userRole}),e.jsx(Ps,{open:w.open,onOpenChange:s=>{s||z({open:!1,userId:"",userName:"",userRole:""})},userName:w.userName,userId:w.userId,userRole:w.userRole,onConfirm:ns,isDeleting:c.isPending}),e.jsx(Le,{open:k.open,onOpenChange:s=>{s||B({open:!1,step:1,confirmText:""})},children:e.jsx(Ee,{className:"max-w-[90vw] sm:max-w-[500px]",children:k.step===1?e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(Ye,{className:"h-5 w-5"}),a("admin.batchDeleteTitle")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 p-4 rounded-lg",children:e.jsx("p",{className:"font-semibold text-foreground",children:a("admin.batchDeleteStep1",{count:j.length})})}),e.jsxs("div",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:a("admin.deleteUserConsequences")}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e.jsx("li",{children:a("admin.deleteUserData1")}),e.jsx("li",{children:a("admin.deleteUserData2")}),e.jsx("li",{children:a("admin.deleteUserData3")}),e.jsx("li",{children:a("admin.deleteUserData4")})]})]})]})]}),e.jsxs(me,{children:[e.jsx(xe,{onClick:()=>B({open:!1,step:1,confirmText:""}),children:a("common.cancel")}),e.jsx(he,{onClick:()=>B(s=>({...s,step:2})),className:"bg-destructive hover:bg-destructive/90",children:a("common.continue")})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsxs(de,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(ye,{className:"h-5 w-5"}),a("admin.batchDeleteStep2Title")]}),e.jsxs(oe,{className:"space-y-4 pt-4",children:[e.jsx("p",{className:"text-foreground font-medium",children:a("admin.batchDeleteStep2Desc",{count:j.length})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"batch-delete-confirm",className:"text-sm font-medium",children:a("admin.typeDeleteToConfirm")}),e.jsx(K,{id:"batch-delete-confirm",value:k.confirmText,onChange:s=>B(u=>({...u,confirmText:s.target.value})),placeholder:"DELETE",className:"uppercase",autoComplete:"off"})]})]})]}),e.jsxs(me,{children:[e.jsx(xe,{onClick:()=>B({open:!1,step:1,confirmText:""}),children:a("common.cancel")}),e.jsx(he,{onClick:is,disabled:k.confirmText.toLowerCase()!=="delete"||l.isPending,className:"bg-destructive hover:bg-destructive/90",children:l.isPending?a("common.loading"):a("admin.deleteUser")})]})]})})}),e.jsx(Es,{open:we.open,onOpenChange:s=>Pe(u=>({...u,open:s})),userId:we.userId,userName:we.userName,userRole:we.userRole})]})};export{ea as default};
//# sourceMappingURL=AdminUsers-BKb50Q5p.js.map
