import{j as f}from"./vendor-ui-DAmPMpEA.js";import{r as c}from"./vendor-react-iAJ0IrSD.js";import{m as d}from"./vendor-map-BaCLwlqt.js";/* empty css                  */import{c as S}from"./geolocation-YPf7LJYy.js";import{r as $,a4 as y,aq as W,B as z,j as O,Q as P}from"./index-COqZhysY.js";import{m as B}from"./map-icon-DR07RZr_.js";import{u as D}from"./vendor-i18n-DxKeo2S1.js";import{a as G}from"./vendor-query-BlSVl3IQ.js";const L=({restaurants:h,onRestaurantClick:v,userLocation:t,radiusFilter:g,onMapInit:I,onMarkerClick:E,showViewDetailsButton:M=!1})=>{const{i18n:T,t:u}=D(),b=c.useRef(null),r=c.useRef(null),w=c.useRef([]),[x,j]=c.useState(!1),[C,k]=c.useState(null),a=c.useRef(null);return c.useEffect(()=>{if(!b.current||r.current)return;const n="pk.eyJ1IjoieGlhb3hpb25nMTIzIiwiYSI6ImNtNTFjOXliYjF1Y2IyaXM4bnNzMGxvdnkifQ.mPcWqH7ndIrjEqlWIJVk8g";if(!(()=>{try{const s=document.createElement("canvas");return s.getContext("webgl")||s.getContext("experimental-webgl")?d.supported():(console.warn("[RestaurantMap] WebGL context creation failed"),!1)}catch(s){return console.warn("[RestaurantMap] WebGL check error:",s),!1}})()){console.warn("[RestaurantMap] WebGL not supported",{isIOSDevice:$(),isIOSWebView:y(),userAgent:navigator.userAgent}),k(u("map.webglNotSupported","Your browser does not support map display"));return}let l=0;const i=30,o=()=>{if(!b.current)return;const s=b.current.getBoundingClientRect();if(console.log("[RestaurantMap] Container dimensions:",s.width,s.height,"retry:",l),s.width===0||s.height===0){if(l++,l>=i){console.error("[RestaurantMap] Container never got valid dimensions after",i,"retries"),y()?k(u("map.loadError","Map failed to load")):setTimeout(o,500);return}setTimeout(o,100);return}try{d.accessToken=n;const p=t?[t.lng,t.lat]:[-9.1393,38.7223];r.current=new d.Map({container:b.current,style:"mapbox://styles/mapbox/light-v11",center:p,zoom:13,cooperativeGestures:!0,doubleClickZoom:!1,fadeDuration:y()?0:300,preserveDrawingBuffer:y()}),r.current.on("error",R=>{console.error("[RestaurantMap] Map error:",R),k(u("map.loadError","Map failed to load"))}),r.current.addControl(new d.NavigationControl({visualizePitch:!0}),"top-right"),r.current.on("load",()=>{j(!0),I&&r.current&&I(r.current)})}catch(p){console.error("[RestaurantMap] Failed to initialize map:",p),k(u("map.loadError","Map failed to load"))}};return y()?setTimeout(o,200):o(),()=>{w.current.forEach(s=>s.remove()),w.current=[],a.current&&(a.current.remove(),a.current=null),r.current?.remove(),r.current=null,j(!1)}},[]),c.useEffect(()=>{r.current&&t&&x&&r.current.flyTo({center:[t.lng,t.lat],zoom:14,duration:1500})},[t,x]),c.useEffect(()=>{if(!r.current||!x)return;w.current.forEach(e=>e.remove()),w.current=[],a.current&&(a.current.remove(),a.current=null);let n=h;if(t&&g&&(n=h.filter(e=>S(t.lat,t.lng,e.lat,e.lng)<=g)),n.forEach(e=>{const l=document.createElement("div");l.className="p-3 min-w-[200px]",l.innerHTML=`
        <div class="space-y-2">
          <h3 class="font-bold text-base text-foreground">${e.name}</h3>
          ${e.type&&e.type.length>0?`
            <div class="flex flex-wrap gap-1">
              ${e.type.slice(0,2).map(m=>`<span class="text-xs bg-secondary text-secondary-foreground px-2 py-0.5 rounded">${m}</span>`).join("")}
            </div>
          `:""}
          ${e.rating?`
            <div class="flex items-center gap-1">
              <span style="color: #016450;">‚≠ê</span>
              <span class="font-semibold text-sm">${e.rating.toFixed(1)}</span>
            </div>
          `:""}
          <p class="text-xs text-muted-foreground">${e.address}</p>
          ${M?`
            <button 
              id="view-details-${e.id}" 
              class="w-full mt-2 px-3 py-1.5 text-sm font-medium text-white rounded-md transition-colors"
              style="background-color: #016450;"
              onmouseover="this.style.opacity='0.9'"
              onmouseout="this.style.opacity='1'"
            >
              ${u("restaurants.viewDetails")}
            </button>
          `:""}
        </div>
      `;const i=new d.Popup({offset:25,closeButton:!0,closeOnClick:!1,closeOnMove:!1,maxWidth:"300px"}).setLngLat([e.lng,e.lat]).setDOMContent(l),o=document.createElement("div");o.className="custom-marker",o.style.backgroundImage=`url(${B})`,o.style.width="40px",o.style.height="40px",o.style.backgroundSize="contain",o.style.backgroundRepeat="no-repeat",o.style.backgroundPosition="center",o.style.cursor="pointer";const s=new d.Marker({element:o,draggable:!1}).setLngLat([e.lng,e.lat]).addTo(r.current),p=s.getElement();p.style.cursor="pointer";const R=m=>{m.stopPropagation(),m.preventDefault(),a.current&&a.current!==i&&a.current.remove(),i.addTo(r.current),a.current=i,r.current.easeTo({center:[e.lng,e.lat],zoom:17,duration:800}),E&&E(e)};p.addEventListener("click",R,!0),M&&i.on("open",()=>{const m=document.getElementById(`view-details-${e.id}`);m&&m.addEventListener("click",N=>{N.stopPropagation(),v(e)})}),i.on("close",()=>{a.current===i&&(a.current=null)}),w.current.push(s)}),n.length>0){const e=new d.LngLatBounds;n.forEach(l=>{e.extend([l.lng,l.lat])}),t&&e.extend([t.lng,t.lat]),r.current.fitBounds(e,{padding:50,maxZoom:15})}},[h,g,t,x,v,T.language,M,u,E]),c.useEffect(()=>{if(!r.current||!t||!x)return;const n=document.createElement("div");n.className="user-location-marker",n.style.backgroundColor="#3b82f6",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.border="3px solid white",n.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)";const e=new d.Marker(n).setLngLat([t.lng,t.lat]).addTo(r.current);return()=>{e.remove()}},[t,x]),C?f.jsxs("div",{className:"w-full h-full rounded-lg overflow-hidden bg-muted/50 flex flex-col items-center justify-center p-6 text-center",children:[f.jsx(W,{className:"w-12 h-12 text-muted-foreground mb-4"}),f.jsx("p",{className:"text-muted-foreground mb-2",children:C}),f.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:u("map.viewListInstead","Please view the restaurant list below")}),y()&&f.jsxs(z,{variant:"outline",size:"sm",onClick:()=>window.open(window.location.href,"_blank"),children:[f.jsx(O,{className:"w-4 h-4 mr-2"}),u("map.openInBrowser","Open in Browser")]})]}):f.jsx("div",{ref:b,className:"w-full h-full rounded-lg overflow-hidden",style:{minHeight:"300px",WebkitTransform:"translateZ(0)"}})},X=()=>G({queryKey:["activity-restaurant-counts"],queryFn:async()=>{const{data:h,error:v}=await P.from("activity_restaurants").select("activity_id");if(v)throw v;const t={};return h.forEach(g=>{t[g.activity_id]=(t[g.activity_id]||0)+1}),t}}),K="/assets/xiaoxiong-logo-v3-D4uDr23w.png";export{L as R,K as l,X as u};
//# sourceMappingURL=xiaoxiong-logo-clean-BXn5ASeQ.js.map
