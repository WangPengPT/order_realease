import{u as me,r as c,ad as ue,p as O,s as o,ae as X,j as e,C as M,e as R,o as F,an as P,f as L,I as b,B as u,A as he,E as je,F as xe,G as Y,aq as pe,P as fe,S as ge,M as ve,n as $,af as we,ag as Ue,ah as ye,ai as be,aj as Ne,as as Se,aV as Ce,N as _e,O as De,Q as Ee,R as Ae,T as ke,U as Te,V as Oe,W as Me,D as Re,t as Fe,a4 as Pe,a5 as Le,a6 as $e,a7 as _,a9 as qe,a3 as r}from"./index-DVul3rRI.js";import{T as Ie,a as Ke,b as Z,c as h,d as Qe,e as j}from"./table-DNURx4s1.js";import{S as Be}from"./switch-DhKWlehl.js";import{D as He}from"./download-C6I8KRRV.js";import{S as Ve}from"./search-5C1V7VKV.js";import{F as ze}from"./filter-6riRaydw.js";import{T as Ge}from"./trash-2-i8G4gdCQ.js";const ee=["pending","received","completed","cancelled"],as=()=>{const{t:s}=me(),[q,se]=c.useState(""),[N,I]=c.useState("all"),[D,E]=c.useState(null),[ae,U]=c.useState(!1),[n,te]=c.useState(null),[y,K]=c.useState(""),[x,Q]=c.useState(""),[A,k]=c.useState(!1),[T,m]=c.useState(!1),[S,B]=c.useState(!1),p=ue(),{data:f,isLoading:re}=O({queryKey:["joinRequests"],queryFn:async()=>{const{data:a,error:t}=await o.from("join_requests").select("*").order("created_at",{ascending:!1});if(t)throw t;return a}}),{data:d}=O({queryKey:["emailConfig","join_request"],queryFn:async()=>{const{data:a,error:t}=await o.from("email_config").select("*").eq("type","join_request").single();if(t)throw t;return a}}),{data:g}=O({queryKey:["siteSettings"],queryFn:async()=>{const{data:a,error:t}=await o.from("site_settings").select("logo_url").single();if(t)throw t;return a}});c.useEffect(()=>{const a=o.channel("join_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"join_requests"},()=>{p.invalidateQueries({queryKey:["joinRequests"]})}).subscribe();return()=>{o.removeChannel(a)}},[p]);const v=f==null?void 0:f.filter(a=>{const t=q.toLowerCase(),i=a.name.toLowerCase().includes(t)||a.email.toLowerCase().includes(t)||a.restaurant_name.toLowerCase().includes(t)||a.phone.toLowerCase().includes(t),w=N==="all"||a.status===N;return i&&w}),ne=async()=>{const a=prompt(s("joinUs.enterNewEmail"),d==null?void 0:d.recipient_email);if(a)try{const{error:t}=await o.from("email_config").update({recipient_email:a}).eq("id",d==null?void 0:d.id);if(t)throw t;r({title:s("common.success"),description:s("joinUs.emailUpdated")})}catch(t){console.error("Error updating email:",t),r({title:s("common.error"),description:s("joinUs.emailUpdateError"),variant:"destructive"})}},H=X({mutationFn:async({id:a,status:t})=>{const{error:i}=await o.from("join_requests").update({status:t}).eq("id",a);if(i)throw i},onSuccess:()=>{p.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.statusUpdated")})},onError:a=>{console.error("Error updating status:",a),r({title:s("common.error"),description:s("joinUs.statusUpdateError"),variant:"destructive"})}}),V=X({mutationFn:async a=>{const{error:t}=await o.from("join_requests").delete().eq("id",a);if(t)throw t},onSuccess:()=>{p.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.requestDeleted")}),E(null)},onError:a=>{console.error("Error deleting request:",a),r({title:s("common.error"),description:s("joinUs.deleteError"),variant:"destructive"})}}),ie=()=>{if(!v||v.length===0){r({title:s("admin.noDataToExport"),variant:"destructive"});return}const a=[["Name","Email","Phone","Restaurant Name","Restaurant Address","Features","Status","Submitted Date"],...v.map(l=>[l.name,l.email,l.phone,l.restaurant_name,l.restaurant_address||"",Array.isArray(l.features_selected)?l.features_selected.join(", "):"",l.status||"pending",new Date(l.created_at).toLocaleString()])].map(l=>l.map(C=>`"${C}"`).join(",")).join(`
`),t=new Blob([a],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),w=URL.createObjectURL(t);i.setAttribute("href",w),i.setAttribute("download",`join_requests_${new Date().toISOString()}.csv`),i.click(),URL.revokeObjectURL(w),r({title:s("admin.exportSuccess")})},z=a=>{switch(a){case"completed":return"default";case"received":return"secondary";case"cancelled":return"destructive";default:return"outline"}},oe=a=>{te(a),K(a.email),Q(""),B(!1),U(!0)},le=async()=>{if(!n||!y.trim()||!x.trim()){r({title:s("common.error"),description:s("joinUs.accountPasswordRequired"),variant:"destructive"});return}if(x.length<6){r({title:s("common.error"),description:s("auth.passwordTooShort"),variant:"destructive"});return}try{if(S){k(!0);const ce=`【小熊市场】您的商家账号信息 - ${n.restaurant_name}`,de="您的商家账号信息如下！",{data:J,error:W}=await o.functions.invoke("send-merchant-email",{body:{to:n.email,subject:ce,content:de,merchantName:n.name,account:y,password:x,logoUrl:(g==null?void 0:g.logo_url)||null}});if(W)throw W;if(!J.success)throw new Error(J.error);await o.from("join_requests").update({email_sent_at:new Date().toISOString()}).eq("id",n.id),p.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),U(!1);return}m(!0);const{data:a}=await o.auth.getSession();if(!(a!=null&&a.session)){r({title:s("common.error"),description:s("auth.sessionExpired"),variant:"destructive"}),m(!1);return}const{data:t,error:i}=await o.functions.invoke("admin-create-user",{body:{email:y,password:x,displayName:n.name,phone:n.phone,role:"merchant"}});if(i){console.error("Create user function error:",i),r({title:s("common.error"),description:i.message||s("admin.createUserError"),variant:"destructive"}),m(!1);return}if(t!=null&&t.error){console.error("Create user business error:",t.error),r({title:s("common.error"),description:t.error,variant:"destructive"}),m(!1);return}if(!(t!=null&&t.success)||!(t!=null&&t.user)){console.error("User creation failed - no user returned"),r({title:s("common.error"),description:s("admin.createUserError"),variant:"destructive"}),m(!1);return}r({title:s("common.success"),description:s("joinUs.merchantUserCreated")}),m(!1),k(!0);const w=`【小熊市场】您的商家账号已创建 - ${n.restaurant_name}`,l="您的商家账号已创建成功！",{data:C,error:G}=await o.functions.invoke("send-merchant-email",{body:{to:n.email,subject:w,content:l,merchantName:n.name,account:y,password:x,logoUrl:(g==null?void 0:g.logo_url)||null}});if(G)throw G;if(!C.success)throw new Error(C.error);await o.from("join_requests").update({status:"received",email_sent_at:new Date().toISOString()}).eq("id",n.id),p.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),U(!1)}catch(a){console.error("Error:",a),r({title:s("common.error"),description:a.message||s("joinUs.emailSendError"),variant:"destructive"})}finally{m(!1),k(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("joinUs.adminTitle")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:s("joinUs.adminDescription")})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(M,{children:[e.jsxs(R,{children:[e.jsx(F,{children:s("joinUs.recipientEmail")}),e.jsx(P,{children:s("joinUs.recipientEmailDesc")})]}),e.jsx(L,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(b,{value:(d==null?void 0:d.recipient_email)||"",readOnly:!0}),e.jsx(u,{onClick:ne,children:s("common.edit")})]})})]}),e.jsxs(M,{children:[e.jsxs(R,{children:[e.jsx(F,{children:s("joinUs.totalRequests")}),e.jsx(P,{children:s("joinUs.totalRequestsDesc")})]}),e.jsx(L,{children:e.jsx("div",{className:"text-3xl font-bold",children:(f==null?void 0:f.length)||0})})]})]}),e.jsxs(M,{children:[e.jsxs(R,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(F,{children:s("joinUs.allRequests")}),e.jsx(P,{children:s("joinUs.allRequestsDesc")})]}),e.jsxs(u,{onClick:ie,variant:"outline",children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),s("admin.exportCSV")]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ve,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(b,{placeholder:s("joinUs.searchPlaceholder"),value:q,onChange:a=>se(a.target.value),className:"pl-10"})]}),e.jsxs(he,{children:[e.jsx(je,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"gap-2",children:[e.jsx(ze,{className:"w-4 h-4"}),s(N==="all"?"admin.allStatus":`joinUs.status.${N}`)]})}),e.jsxs(xe,{align:"end",className:"bg-background",children:[e.jsx(Y,{onClick:()=>I("all"),children:s("admin.allStatus")}),ee.map(a=>e.jsx(Y,{onClick:()=>I(a),children:s(`joinUs.status.${a}`)},a))]})]})]})]}),e.jsx(L,{children:re?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):v&&v.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ie,{children:[e.jsx(Ke,{children:e.jsxs(Z,{children:[e.jsx(h,{children:s("joinUs.name")}),e.jsx(h,{children:s("joinUs.contact")}),e.jsx(h,{children:s("joinUs.restaurant")}),e.jsx(h,{children:s("joinUs.featuresNeeded")}),e.jsx(h,{children:s("joinUs.status")}),e.jsx(h,{children:s("joinUs.submittedAt")}),e.jsx(h,{className:"text-right",children:s("common.actions")})]})}),e.jsx(Qe,{children:v.map(a=>e.jsxs(Z,{children:[e.jsx(j,{className:"font-medium",children:a.name}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pe,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`mailto:${a.email}`,className:"hover:underline",children:a.email})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fe,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`tel:${a.phone}`,className:"hover:underline",children:a.phone})]})]})}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ge,{className:"w-3 h-3 text-muted-foreground"}),a.restaurant_name]}),a.restaurant_address&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ve,{className:"w-3 h-3"}),a.restaurant_address]})]})}),e.jsx(j,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:Array.isArray(a.features_selected)&&a.features_selected.map((t,i)=>e.jsx($,{variant:"secondary",children:s(`joinUs.feature.${t}`)},i))})}),e.jsx(j,{children:e.jsxs(we,{value:a.status||"pending",onValueChange:t=>H.mutate({id:a.id,status:t}),disabled:H.isPending,children:[e.jsx(Ue,{className:"w-[130px]",children:e.jsx(ye,{children:e.jsx($,{variant:z(a.status||"pending"),children:s(`joinUs.status.${a.status||"pending"}`)})})}),e.jsx(be,{children:ee.map(t=>e.jsx(Ne,{value:t,children:e.jsx($,{variant:z(t),children:s(`joinUs.status.${t}`)})},t))})]})}),e.jsx(j,{className:"text-sm text-muted-foreground",children:Se(new Date(a.created_at),{addSuffix:!0})}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(u,{size:"sm",variant:"outline",onClick:()=>oe(a),title:s("joinUs.sendEmail"),children:e.jsx(Ce,{className:"w-4 h-4"})}),e.jsx(u,{size:"sm",variant:"destructive",onClick:()=>E(a.id),disabled:V.isPending,children:e.jsx(Ge,{className:"w-4 h-4"})})]})})]},a.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("joinUs.noRequests")})})]})]}),e.jsx(_e,{open:D!==null,onOpenChange:a=>!a&&E(null),children:e.jsxs(De,{children:[e.jsxs(Ee,{children:[e.jsx(Ae,{children:s("joinUs.confirmDelete")}),e.jsx(ke,{children:s("joinUs.confirmDeleteDescription")})]}),e.jsxs(Te,{children:[e.jsx(Oe,{children:s("common.cancel")}),e.jsx(Me,{onClick:()=>D&&V.mutate(D),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s("common.delete")})]})]})}),e.jsx(Re,{open:ae,onOpenChange:U,children:e.jsxs(Fe,{className:"sm:max-w-[500px]",children:[e.jsxs(Pe,{children:[e.jsx(Le,{children:s("joinUs.sendAccountTitle")}),e.jsx($e,{children:s("joinUs.sendAccountDescription",{name:n==null?void 0:n.name})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(_,{htmlFor:"emailOnlyMode",className:"font-medium",children:s("joinUs.emailOnlyMode")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.emailOnlyModeDesc")})]}),e.jsx(Be,{id:"emailOnlyMode",checked:S,onCheckedChange:B})]}),!S&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:["ℹ️ ",s("joinUs.createUserModeNote")]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:s("joinUs.emailRecipient")}),e.jsx(b,{value:(n==null?void 0:n.email)||"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"account",children:s("joinUs.merchantAccount")}),e.jsx(b,{id:"account",value:y,onChange:a=>K(a.target.value),placeholder:s("joinUs.merchantAccountPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"password",children:s("joinUs.merchantPassword")}),e.jsx(b,{id:"password",type:"text",value:x,onChange:a=>Q(a.target.value),placeholder:s("joinUs.merchantPasswordPlaceholder")})]}),e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:["⚠️ ",s("joinUs.passwordSecurityNote")]})})]}),e.jsxs(qe,{children:[e.jsx(u,{variant:"outline",onClick:()=>U(!1),disabled:T||A,children:s("common.cancel")}),e.jsx(u,{onClick:le,disabled:T||A,children:s(T?"joinUs.creatingUser":A?"common.sending":S?"joinUs.sendEmailOnly":"joinUs.createAndSendEmail")})]})]})})]})};export{as as default};
