import{p as O,u as xe,r as o,j as e,cg as ge,L as fe,b1 as ee,bg as pe,b8 as ve,X as Q,bj as je,cG as be,aL as W,w as p,q as ye,bO as X}from"./vendor-react-BJ_Fufgb.js";import{u as Ne,h as we,Q as ke,R as Ce,T as Re,J as Pe,D as Ue,X as Ee,B as R,c as Le,d as Ie,e as _e,V as M,a2 as J,a3 as K,a4 as Y,a5 as Z,a6 as T,a8 as Se,s as v,t as C}from"./index-BSqTIOKh.js";import{c as Ae,d as $e,e as Fe,f as Te,g as De}from"./useCommunityPosts-MVlSi4zz.js";import{u as se}from"./useLocalizedContent-Bk4lYsHC.js";import{u as Ve}from"./useActivities-DTcpAzU7.js";import{u as ze}from"./useRestaurants-DmbF1jrQ.js";import{P as Me}from"./PullToRefresh-CI1Yan2w.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-Dbipw1Nj.js";const Oe=({post:t})=>{const{t:a}=O(),{user:d}=Ne(),j=xe(),{getLocalizedField:b}=se(),P=Ae(),[k,m]=o.useState(!1),I=c=>{c.preventDefault(),c.stopPropagation(),d&&P.mutate({postId:t.id,liked:t.user_liked||!1})},_=()=>{j(`/community/${t.id}`)},y=c=>new DOMParser().parseFromString(c,"text/html").body.textContent||"",U=b(t,"content"),E=y(U),N=t.image_urls&&t.image_urls.length>0,L=!!t.video_url,u=N||L,h=t.image_urls?.length||0;return e.jsxs("div",{className:"group cursor-pointer rounded-lg overflow-hidden bg-card border border-border/50 hover:shadow-lg transition-all duration-300 hover:-translate-y-1",onClick:_,children:[u&&e.jsx("div",{className:"relative",children:N?e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden",children:[k?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:a("common.imageLoadError","图片加载失败")})}):e.jsx("img",{src:t.image_urls[0],alt:"",className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",onError:()=>m(!0)}),h>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full z-10 flex items-center gap-1",children:[e.jsx(ge,{className:"h-3 w-3"}),e.jsx("span",{children:h})]})]}):L?e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden bg-gray-900",children:[e.jsx("video",{src:t.video_url,...t.image_urls?.length?{poster:t.image_urls[0]}:{},className:"w-full h-full object-cover",preload:"metadata",muted:!0,playsInline:!0}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-white/30 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"w-0 h-0 border-l-[16px] border-l-white border-y-[10px] border-y-transparent ml-1"})})})]}):null}),e.jsxs("div",{className:"p-3",children:[t.restaurant&&e.jsx(fe,{to:`/restaurants/${t.restaurant.id}`,onClick:c=>c.stopPropagation(),className:"inline-block mb-2",children:e.jsxs(we,{variant:"outline",className:"text-xs gap-1 hover:bg-accent transition-colors",children:[e.jsx(ee,{className:"h-3 w-3"}),b(t.restaurant,"name")]})}),e.jsx("p",{className:`text-sm font-medium line-clamp-2 leading-relaxed ${u?"":"min-h-[60px]"}`,children:E}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(ke,{className:"h-5 w-5 flex-shrink-0",children:[e.jsx(Ce,{src:t.author?.avatar_url||void 0}),e.jsx(Re,{className:"text-[10px]",children:t.author?.display_name?.charAt(0)||"?"})]}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:t.author?.display_name})]}),e.jsxs("button",{className:`flex items-center gap-1 text-xs ${t.user_liked?"text-red-500":"text-muted-foreground"} hover:text-red-500 transition-colors`,onClick:I,disabled:!d,children:[e.jsx(pe,{className:`h-4 w-4 ${t.user_liked?"fill-current":""}`}),e.jsx("span",{children:t.likes_count||0})]})]})]})]})},qe=({trigger:t})=>{const{t:a}=O(),{getLocalizedField:d}=se(),j=$e(),{data:b}=Ve(),{data:P}=ze(),{role:k,isMerchant:m,isAdmin:I,isSupervisor:_}=Pe(),{data:y}=Fe(),[U,E]=o.useState(!1),[N,L]=o.useState(""),[u,h]=o.useState([]),[c,S]=o.useState(null),[q,B]=o.useState(""),[D,V]=o.useState(""),[z,A]=o.useState(!1),$=o.useRef(null),F=o.useRef(null),H=!m&&!_&&!I;o.useEffect(()=>{m&&y&&U&&V(y.id)},[m,y,U]);const G=()=>{L(""),h([]),S(null),B(""),V("")},te=s=>{E(s),s||G()},ae=async s=>{const n=s.target.files;if(!(!n||n.length===0)){if(u.length+n.length>9){p.error(a("community.maxImages","最多上传9张图片"));return}A(!0);try{const{data:{user:l}}=await v.auth.getUser();if(!l)throw new Error("Not authenticated");const r=[];for(const i of Array.from(n)){const w=i.name.split(".").pop(),x=`${l.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${w}`,{error:g}=await v.storage.from("community-posts").upload(x,i);if(g)throw g;const{data:{publicUrl:f}}=v.storage.from("community-posts").getPublicUrl(x);r.push(f)}h(i=>[...i,...r])}catch(l){console.error("Upload error:",l),p.error(a("common.uploadError","上传失败"))}finally{A(!1),$.current&&($.current.value="")}}},re=s=>new Promise((n,l)=>{const r=document.createElement("video"),i=document.createElement("canvas"),w=i.getContext("2d");r.preload="auto",r.muted=!0,r.playsInline=!0;let x=!1;const g=()=>{x||r.videoWidth===0||r.videoHeight===0||(i.width=r.videoWidth,i.height=r.videoHeight,w&&(w.drawImage(r,0,0,i.width,i.height),i.toBlob(f=>{f&&f.size>0?(x=!0,r.pause(),URL.revokeObjectURL(r.src),n(f)):l(new Error("Failed to create blob"))},"image/jpeg",.85)))};r.onloadedmetadata=()=>{i.width=r.videoWidth,i.height=r.videoHeight,r.currentTime=.1},r.onseeked=()=>{setTimeout(g,100)},r.onerror=()=>{URL.revokeObjectURL(r.src),l(new Error("Failed to load video"))},setTimeout(()=>{x||(URL.revokeObjectURL(r.src),l(new Error("Timeout")))},1e4),r.src=URL.createObjectURL(s),r.load()}),ne=async s=>{const n=s.target.files?.[0];if(n){if(n.size>100*1024*1024){p.error(a("community.videoTooLarge","视频不能超过100MB"));return}A(!0);try{const{data:{user:l}}=await v.auth.getUser();if(!l)throw new Error("Not authenticated");const r=n.name.split(".").pop(),i=`${l.id}/${Date.now()}.${r}`,{error:w}=await v.storage.from("community-posts").upload(i,n);if(w)throw w;const{data:{publicUrl:x}}=v.storage.from("community-posts").getPublicUrl(i);S(x);try{p.info(a("community.extractingCover","正在提取视频封面..."));const g=await re(n),f=`${l.id}/${Date.now()}-cover.jpg`,{error:me}=await v.storage.from("community-posts").upload(f,g);if(!me){const{data:{publicUrl:ue}}=v.storage.from("community-posts").getPublicUrl(f);h(he=>[ue,...he]),p.success(a("community.coverExtracted","封面已自动生成"))}}catch(g){console.warn("Cover extraction failed:",g)}}catch(l){console.error("Upload error:",l),p.error(a("common.uploadError","上传失败"))}finally{A(!1),F.current&&(F.current.value="")}}},ie=s=>{h(n=>n.filter((l,r)=>r!==s))},le=()=>{S(null),h(s=>s.length>0&&s[0].includes("-cover.jpg")?s.slice(1):s)},oe=async()=>{if(!N.trim()){p.error(a("community.contentRequired","请输入内容"));return}if(H&&!D){p.error(a("community.restaurantRequired","请选择餐厅"));return}await j.mutateAsync({content:N,image_urls:u,video_url:c||void 0,activity_id:q||void 0,restaurant_id:D||void 0}),G(),E(!1)},ce=b?.filter(s=>s.status==="published")||[],de=()=>y?d(y,"name"):a("community.noRestaurant","未关联餐厅");return e.jsxs(Ue,{open:U,onOpenChange:te,children:[e.jsx(Ee,{asChild:!0,children:t||e.jsx(R,{children:a("community.createPost","发布帖子")})}),e.jsxs(Le,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(Ie,{children:e.jsx(_e,{children:a("community.createPost","发布帖子")})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),a("community.linkRestaurant","关联餐厅"),H&&e.jsx("span",{className:"text-destructive",children:"*"})]}),m?e.jsx("div",{className:"px-3 py-2 border rounded-md bg-muted/50 text-sm",children:de()}):e.jsxs(J,{value:D||"none",onValueChange:s=>V(s==="none"?"":s),children:[e.jsx(K,{children:e.jsx(Y,{placeholder:a("community.selectRestaurant","选择餐厅")})}),e.jsxs(Z,{children:[(_||I)&&e.jsx(T,{value:"none",children:a("community.noRestaurantLink","不关联餐厅")}),P?.map(s=>e.jsx(T,{value:s.id,children:d(s,"name")},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:a("community.content","内容")}),e.jsx(Se,{value:N,onChange:s=>L(s.target.value),placeholder:a("community.contentPlaceholder","分享你的想法..."),rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4"}),a("community.linkActivity","关联活动")]}),e.jsxs(J,{value:q||"none",onValueChange:s=>B(s==="none"?"":s),children:[e.jsx(K,{children:e.jsx(Y,{placeholder:a("community.selectActivity","选择活动（可选）")})}),e.jsxs(Z,{children:[e.jsx(T,{value:"none",children:a("community.noActivity","不关联活动")}),ce.map(s=>e.jsx(T,{value:s.id,children:d(s,"title")},s.id))]})]})]}),u.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:u.map((s,n)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden",children:[e.jsx("img",{src:s,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>ie(n),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(Q,{className:"h-3 w-3"})})]},n))}),c&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:c,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:le,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(Q,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:$,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:ae}),e.jsx("input",{ref:F,type:"file",accept:"video/*",className:"hidden",onChange:ne}),e.jsxs(R,{type:"button",variant:"outline",size:"sm",onClick:()=>$.current?.click(),disabled:z||u.length>=9,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),a("community.addImage","添加图片")]}),e.jsxs(R,{type:"button",variant:"outline",size:"sm",onClick:()=>F.current?.click(),disabled:z||!!c,children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),a("community.addVideo","添加视频")]}),z&&e.jsx(W,{className:"h-4 w-4 animate-spin"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(R,{variant:"outline",onClick:()=>E(!1),children:a("common.cancel","取消")}),e.jsxs(R,{onClick:oe,disabled:j.isPending||!N.trim(),children:[j.isPending&&e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}),a("community.publish","发布")]})]})]})]})]})},Be=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(C,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{className:"h-4 w-full"}),e.jsx(C,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"h-5 w-5 rounded-full"}),e.jsx(C,{className:"h-3 w-16"})]}),e.jsx(C,{className:"h-4 w-10"})]})]})]}),ts=()=>{const{t}=O(),a=ye(),{data:d,isLoading:j}=Te({status:"approved"}),{data:b}=De(),P=o.useCallback(async()=>{await a.invalidateQueries({queryKey:["community-posts"]})},[a]);return e.jsx(Me,{onRefresh:P,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-4xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl font-bold mb-2 text-primary",children:t("community.title","社区")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:t("community.description","分享美食体验，发现更多精彩")})]}),b&&e.jsx(qe,{trigger:e.jsxs(R,{size:"sm",className:"gap-1.5",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.createPost","发布")})]})})]}),j?e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:Array.from({length:6}).map((k,m)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Be,{})},m))}):d&&d.length>0?e.jsx("div",{className:"columns-2 sm:columns-3 lg:columns-4 xl:columns-5 gap-3 sm:gap-4",children:d.map(k=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Oe,{post:k})},k.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(X,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:t("community.noPosts","暂无帖子")}),b&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:t("community.beFirst","成为第一个发帖的人吧！")})]})]})})})};export{ts as default};
//# sourceMappingURL=Community-CPrs8mkp.js.map
