{"version":3,"file":"useActivityRequests-C7Zjf1-C.js","sources":["../../src/hooks/useActivityRequests.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport i18n from \"@/i18n/config\";\r\n\r\nexport interface ActivityRequest {\r\n  id: string;\r\n  requester_id: string;\r\n  title_zh: string;\r\n  title_en: string;\r\n  title_pt: string;\r\n  intro_zh?: string | null;\r\n  intro_en?: string | null;\r\n  intro_pt?: string | null;\r\n  content_zh: string;\r\n  content_en: string;\r\n  content_pt: string;\r\n  image_url?: string | null;\r\n  start_date: string;\r\n  end_date?: string | null;\r\n  service_type: \"dine_in\" | \"takeaway\" | \"both\";\r\n  badge_text_zh?: string | null;\r\n  badge_text_en?: string | null;\r\n  badge_text_pt?: string | null;\r\n  badge_color?: string | null;\r\n  usage_instructions_zh?: string | null;\r\n  usage_instructions_en?: string | null;\r\n  usage_instructions_pt?: string | null;\r\n  status: \"pending\" | \"approved\" | \"rejected\";\r\n  admin_notes?: string | null;\r\n  reviewed_by?: string | null;\r\n  reviewed_at?: string | null;\r\n  created_activity_id?: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  profiles?: {\r\n    display_name: string;\r\n    avatar_url: string | null;\r\n  };\r\n  // Computed field to track if the created activity was deleted\r\n  activity_deleted?: boolean;\r\n}\r\n\r\n// 获取用户自己的活动申请\r\nexport const useMyActivityRequests = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"myActivityRequests\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return [];\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"activity_requests\")\r\n        .select(\"*\")\r\n        .eq(\"requester_id\", user.id)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Check if created activities still exist\r\n      const requestsWithDeletedStatus = await Promise.all(\r\n        (data as ActivityRequest[]).map(async (request) => {\r\n          if (request.created_activity_id && request.status === \"approved\") {\r\n            // Check if activity still exists\r\n            const { data: activity } = await supabase\r\n              .from(\"activities\")\r\n              .select(\"id\")\r\n              .eq(\"id\", request.created_activity_id)\r\n              .single();\r\n            \r\n            return {\r\n              ...request,\r\n              activity_deleted: !activity,\r\n            };\r\n          }\r\n          return { ...request, activity_deleted: false };\r\n        })\r\n      );\r\n      \r\n      return requestsWithDeletedStatus;\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\nexport const useAllActivityRequests = () => {\r\n  return useQuery({\r\n    queryKey: [\"allActivityRequests\"],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"activity_requests\")\r\n        .select(\"*, profiles:requester_id(display_name, avatar_url)\")\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data as unknown as ActivityRequest[];\r\n    },\r\n  });\r\n};\r\n\r\n// 创建活动申请\r\nexport const useCreateActivityRequest = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (data: Omit<ActivityRequest, \"id\" | \"requester_id\" | \"status\" | \"admin_notes\" | \"reviewed_by\" | \"reviewed_at\" | \"created_activity_id\" | \"created_at\" | \"updated_at\" | \"profiles\">) => {\r\n      if (!user) throw new Error(\"User not authenticated\");\r\n\r\n      const { data: result, error } = await supabase\r\n        .from(\"activity_requests\")\r\n        .insert([{\r\n          ...data,\r\n          requester_id: user.id,\r\n        }])\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return result;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"myActivityRequests\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"活动申请已提交，等待管理员审核\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message || \"提交失败\",\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 审核活动申请（管理员）\r\nexport const useReviewActivityRequest = () => {\r\n  const { user } = useAuth();\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      requestId,\r\n      status,\r\n      adminNotes,\r\n    }: {\r\n      requestId: string;\r\n      status: \"approved\" | \"rejected\";\r\n      adminNotes?: string;\r\n    }) => {\r\n      if (!user) throw new Error(\"User not authenticated\");\r\n\r\n      // 获取申请详情\r\n      const { data: request, error: fetchError } = await supabase\r\n        .from(\"activity_requests\")\r\n        .select(\"*\")\r\n        .eq(\"id\", requestId)\r\n        .single();\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      let createdActivityId: string | null = null;\r\n\r\n      // 如果审核通过，创建活动\r\n      if (status === \"approved\") {\r\n        const { data: activity, error: activityError } = await supabase\r\n          .from(\"activities\")\r\n          .insert([{\r\n            creator_id: request.requester_id,\r\n            title_zh: request.title_zh,\r\n            title_en: request.title_en,\r\n            title_pt: request.title_pt,\r\n            intro_zh: request.intro_zh,\r\n            intro_en: request.intro_en,\r\n            intro_pt: request.intro_pt,\r\n            content_zh: request.content_zh,\r\n            content_en: request.content_en,\r\n            content_pt: request.content_pt,\r\n            image_url: request.image_url,\r\n            start_date: request.start_date,\r\n            end_date: request.end_date,\r\n            service_type: request.service_type,\r\n            badge_text_zh: request.badge_text_zh,\r\n            badge_text_en: request.badge_text_en,\r\n            badge_text_pt: request.badge_text_pt,\r\n            badge_color: request.badge_color,\r\n            visible: true,\r\n          }])\r\n          .select()\r\n          .single();\r\n\r\n        if (activityError) throw activityError;\r\n        createdActivityId = activity.id;\r\n      }\r\n\r\n      // 更新申请状态\r\n      const { error: updateError } = await supabase\r\n        .from(\"activity_requests\")\r\n        .update({\r\n          status,\r\n          admin_notes: adminNotes || null,\r\n          reviewed_by: user.id,\r\n          reviewed_at: new Date().toISOString(),\r\n          created_activity_id: createdActivityId,\r\n        })\r\n        .eq(\"id\", requestId);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      return { status, createdActivityId };\r\n    },\r\n    onSuccess: (result) => {\r\n      queryClient.invalidateQueries({ queryKey: [\"allActivityRequests\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"activities\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: result.status === \"approved\" ? \"活动已审核通过并创建\" : \"活动申请已拒绝\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 删除活动申请\r\nexport const useDeleteActivityRequest = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (requestId: string) => {\r\n      const { error } = await supabase\r\n        .from(\"activity_requests\")\r\n        .delete()\r\n        .eq(\"id\", requestId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"myActivityRequests\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"allActivityRequests\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"活动申请已删除\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 重新提交活动申请（将已批准但活动被删除的申请重置为待审核状态）\r\nexport const useResubmitActivityRequest = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async (requestId: string) => {\r\n      const { error } = await supabase\r\n        .from(\"activity_requests\")\r\n        .update({\r\n          status: \"pending\",\r\n          created_activity_id: null,\r\n          reviewed_by: null,\r\n          reviewed_at: null,\r\n          admin_notes: null,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", requestId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"myActivityRequests\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"allActivityRequests\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"活动申请已重新提交，等待管理员审核\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// 更新活动申请\r\nexport const useUpdateActivityRequest = () => {\r\n  const { toast } = useToast();\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      requestId,\r\n      data,\r\n    }: {\r\n      requestId: string;\r\n      data: Partial<Omit<ActivityRequest, \"id\" | \"requester_id\" | \"status\" | \"admin_notes\" | \"reviewed_by\" | \"reviewed_at\" | \"created_activity_id\" | \"created_at\" | \"updated_at\" | \"profiles\" | \"activity_deleted\">>;\r\n    }) => {\r\n      const { error } = await supabase\r\n        .from(\"activity_requests\")\r\n        .update({\r\n          ...data,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", requestId);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"myActivityRequests\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"allActivityRequests\"] });\r\n      toast({\r\n        title: i18n.t(\"common.success\"),\r\n        description: \"活动申请已更新\",\r\n      });\r\n    },\r\n    onError: (error: any) => {\r\n      toast({\r\n        title: i18n.t(\"common.error\"),\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    },\r\n  });\r\n};\r\n"],"names":["useMyActivityRequests","user","useAuth","useQuery","data","error","supabase","request","activity","useAllActivityRequests","useCreateActivityRequest","toast","useToast","queryClient","useQueryClient","useMutation","result","i18n","useReviewActivityRequest","requestId","status","adminNotes","fetchError","createdActivityId","activityError","updateError","useDeleteActivityRequest","useResubmitActivityRequest"],"mappings":"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"}