import{r as k}from"./vendor-react-DImbKuZP.js";import{s as A}from"./index-_G3CuCzp.js";const C="https://tzdgqhwyzsxkxnncgzap.supabase.co",O="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw",y=`${C}/functions/v1/ai-recipe-video`,_="xiaoxiong_video_tasks",$=2,J=()=>{try{const c=localStorage.getItem(_);return c?JSON.parse(c):{}}catch{return{}}},U=c=>{try{const d={};for(const[i,g]of Object.entries(c)){const I=(g.tasks??[]).filter(T=>T.status==="succeeded"&&T.videoUrl);I.length>0&&(d[i]={tasks:I,selectedIndex:Math.min(g.selectedIndex,I.length-1)})}localStorage.setItem(_,JSON.stringify(d))}catch{}},V=()=>{const[c,d]=k.useState(()=>J()),i=k.useRef({});k.useEffect(()=>{U(c)},[c]);const g=k.useCallback((t,e,n)=>{d(r=>{const o=r[t];if(!o)return r;const h=(o.tasks??[]).map(s=>s.taskId===e?{...s,...n}:s);return{...r,[t]:{...o,tasks:h}}})},[]),I=k.useCallback(async(t,e)=>{const n=`${t}_${e}`;try{const r=await fetch(`${y}/${e}`,{headers:{Authorization:`Bearer ${O}`}});if(!r.ok)throw new Error(`Poll failed ${r.status}`);const o=await r.json(),h=o.status;if(h==="succeeded"){const s=o.content?.video_url||o.content?.[0]?.url||o.content?.[0]?.video_url||null;g(t,e,{status:"succeeded",videoUrl:s}),d(a=>{const f=a[t];if(!f)return a;const l=(f.tasks??[]).filter(u=>u.taskId===e||u.status==="succeeded"&&u.videoUrl).length-1;return{...a,[t]:{...f,selectedIndex:Math.max(0,l)}}}),delete i.current[n]}else h==="failed"?(g(t,e,{status:"failed",error:o.error?.message||"视频生成失败"}),delete i.current[n]):i.current[n]=window.setTimeout(()=>I(t,e),6e3)}catch(r){console.error("Poll video task error:",r),g(t,e,{status:"failed",error:"查询视频状态失败"}),delete i.current[n]}},[g]),T=k.useCallback(async(t,e,n)=>{const r=c[t];if((r?.tasks?.length??0)>=$||r?.tasks?.some(s=>s.status==="creating"||s.status==="processing"))return;const h={taskId:"",status:"creating",videoUrl:null,error:null};d(s=>{const a=s[t]||{tasks:[],selectedIndex:0},l=(a.tasks??[]).filter(u=>u.status==="succeeded");return{...s,[t]:{tasks:[...l,h],selectedIndex:a.selectedIndex}}});try{const{data:{user:s}}=await A.auth.getUser(),a=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${O}`},body:JSON.stringify({image_url:e,prompt:n,user_id:s?.id||null,recipe_name:t})});if(!a.ok){const w=await a.json().catch(()=>({}));throw a.status===429&&w.error==="daily_limit_reached"?new Error(w.message||"今日视频生成次数已达上限"):new Error(w.error||`Error ${a.status}`)}const l=(await a.json()).id;if(!l)throw new Error("No task ID returned");d(w=>{const S=w[t];if(!S)return w;const j=(S.tasks??[]).map(x=>x.status==="creating"&&!x.taskId?{...x,taskId:l,status:"processing"}:x);return{...w,[t]:{...S,tasks:j}}});const u=`${t}_${l}`;i.current[u]=window.setTimeout(()=>I(t,l),6e3)}catch(s){console.error("Generate video error:",s),d(a=>{const f=a[t];if(!f)return a;const l=(f.tasks??[]).map(u=>u.status==="creating"?{...u,status:"failed",error:s.message||"创建视频任务失败"}:u);return{...a,[t]:{...f,tasks:l}}})}},[I,c]),m=k.useCallback((t,e)=>{d(n=>{const r=n[t];return r?{...n,[t]:{...r,selectedIndex:e}}:n})},[]);k.useEffect(()=>()=>{Object.values(i.current).forEach(t=>clearTimeout(t))},[]);const b=k.useCallback(t=>{Object.keys(i.current).forEach(e=>{e.startsWith(t)&&(clearTimeout(i.current[e]),delete i.current[e])}),d(e=>{const n={...e};return delete n[t],n})},[]),E={};for(const[t,e]of Object.entries(c)){const n=e?.tasks??[];if(n.length===0)continue;const r=n.find(s=>s.status==="creating"||s.status==="processing"),o=n.filter(s=>s.status==="succeeded")[e?.selectedIndex??0],h=n.find(s=>s.status==="failed");E[t]=r||o||h||n[n.length-1]}return{videoTasks:E,videoStates:c,generateVideo:T,selectVideo:m,clearTask:b}};export{V as u};
//# sourceMappingURL=useRecipeVideo-CWGjMCP6.js.map
