import{s as d,q as l,p,v as y,w as u}from"./vendor-react-3frukg7q.js";import{u as _,s as n}from"./index-BvRf7moB.js";const w=e=>{const{user:r}=_();return d({queryKey:["community-posts",e],queryFn:async()=>{let t=n.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt),
          post_restaurants(
            restaurant:restaurants(id, name, name_en, name_pt)
          )
        `);e?.sortBy==="popular"?t=t.order("likes_count",{ascending:!1}).order("created_at",{ascending:!1}):t=t.order("weight",{ascending:!1}).order("created_at",{ascending:!1}),e?.authorId&&(t=t.eq("author_id",e.authorId)),e?.status&&(t=t.eq("status",e.status)),e?.limit&&(t=t.limit(e.limit)),e?.postType&&e.postType!=="all"&&(t=t.eq("post_type",e.postType));const{data:s,error:a}=await t;if(a)throw a;const i=s?.map(o=>({...o,restaurants:o.post_restaurants?.map(m=>m.restaurant).filter(Boolean)||[]}));if(r&&i){const o=i.map(c=>c.id),{data:m}=await n.from("post_likes").select("post_id").eq("user_id",r.id).in("post_id",o),f=new Set(m?.map(c=>c.post_id)||[]);return i.map(c=>({...c,user_liked:f.has(c.id)}))}return i}})},v=e=>{const{user:r}=_();return d({queryKey:["community-post",e],queryFn:async()=>{const{data:t,error:s}=await n.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt),
          post_restaurants(
            restaurant:restaurants(id, name, name_en, name_pt)
          )
        `).eq("id",e).single();if(s)throw s;const a={...t,restaurants:t.post_restaurants?.map(i=>i.restaurant).filter(Boolean)||[]};if(r){const{data:i}=await n.from("post_likes").select("id").eq("post_id",e).eq("user_id",r.id).maybeSingle();return{...a,user_liked:!!i}}return a},enabled:!!e})},g=()=>{const e=l(),{t:r}=p();return y({mutationFn:async t=>{const{data:{user:s}}=await n.auth.getUser();if(!s)throw new Error("Not authenticated");const{data:a,error:i}=await n.from("community_posts").insert({author_id:s.id,content:t.content,image_urls:t.image_urls||[],video_url:t.video_url||null,activity_id:t.activity_id||null,restaurant_id:null,status:"pending",moderation_status:"pending"}).select().single();if(i)throw i;if(t.restaurant_ids&&t.restaurant_ids.length>0){const{error:o}=await n.from("post_restaurants").insert(t.restaurant_ids.map(m=>({post_id:a.id,restaurant_id:m})));o&&console.error("Failed to insert post restaurants:",o)}try{await n.functions.invoke("moderate-post",{body:{post_id:a.id,content:t.content,user_id:s.id,image_urls:t.image_urls||[],video_url:t.video_url||null,sensitive_word_detected:t.sensitive_word_detected||!1}})}catch(o){console.error("Moderation call failed:",o)}return a},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["has-posted-today"]}),u.success(r("community.postSuccess","帖子发布成功"))},onError:t=>{console.error("Create post error:",t),u.error(r("community.postError","发布失败"))}})},K=()=>{const e=l(),{t:r}=p();return y({mutationFn:async({id:t,...s})=>{const{data:a,error:i}=await n.from("community_posts").update(s).eq("id",t).select().single();if(i)throw i;return a},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]}),e.invalidateQueries({queryKey:["admin-community-posts"]}),u.success(r("common.saved","保存成功"))},onError:t=>{console.error("Update post error:",t),u.error(r("common.error","操作失败"))}})},k=()=>{const e=l(),{t:r}=p();return y({mutationFn:async t=>{const{error:s}=await n.from("community_posts").delete().eq("id",t);if(s)throw s},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["admin-community-posts"]}),u.success(r("common.deleted","删除成功"))},onError:t=>{console.error("Delete post error:",t),u.error(r("common.error","操作失败"))}})},C=()=>{const e=l();return y({mutationFn:async({postId:r,liked:t})=>{const{data:{user:s}}=await n.auth.getUser();if(!s)throw new Error("Not authenticated");if(t){const{error:a}=await n.from("post_likes").delete().eq("post_id",r).eq("user_id",s.id);if(a)throw a}else{const{error:a}=await n.from("post_likes").insert({post_id:r,user_id:s.id});if(a)throw a}},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]})}})},Q=()=>{const e=l(),{t:r}=p();return y({mutationFn:async t=>{const{data:{user:s}}=await n.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:a}=await n.from("post_shares").insert({post_id:t,user_id:s.id});if(a)throw a},onSuccess:()=>{e.invalidateQueries({queryKey:["community-posts"]}),e.invalidateQueries({queryKey:["community-post"]}),u.success(r("community.shared","分享成功"))}})},S=()=>{const{user:e}=_();return d({queryKey:["can-create-post",e?.id],queryFn:async()=>!!e,enabled:!0})},F=()=>{const{user:e}=_();return d({queryKey:["merchant-restaurant",e?.id],queryFn:async()=>{if(!e)return null;const{data:r}=await n.from("merchant_restaurants").select("restaurant_id, restaurants:restaurant_id(id, name, name_en, name_pt)").eq("user_id",e.id).limit(1).maybeSingle();return r?.restaurants||null},enabled:!!e})},P=()=>{const{user:e}=_();return d({queryKey:["has-posted-today",e?.id],queryFn:async()=>{if(!e)return!1;const r=new Date;r.setHours(0,0,0,0);const t=r.toISOString(),{count:s,error:a}=await n.from("community_posts").select("id",{count:"exact",head:!0}).eq("author_id",e.id).gte("created_at",t);if(a)throw a;return(s??0)>0},enabled:!!e})},b=e=>d({queryKey:["admin-community-posts",e],queryFn:async()=>{let r=n.from("community_posts").select(`
          *,
          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),
          activity:activities(id, title_en, title_zh, title_pt),
          restaurant:restaurants(id, name, name_en, name_pt)
        `).order("created_at",{ascending:!1});e?.status&&(r=r.eq("status",e.status)),e?.moderation_status&&(r=r.eq("moderation_status",e.moderation_status)),e?.post_type&&(r=r.eq("post_type",e.post_type)),e?.search&&(r=r.ilike("content",`%${e.search}%`));const{data:t,error:s}=await r;if(s)throw s;return t}});export{C as a,Q as b,k as c,b as d,K as e,g as f,F as g,P as h,S as i,v as j,w as u};
//# sourceMappingURL=useCommunityPosts-ByuUJb7u.js.map
