import{a as v,u as c,b as f}from"./vendor-query-EnOED-MY.js";import{r as w}from"./vendor-react-CrHRjzzo.js";import{u,j as _,s}from"./index-sgw1izSd.js";const S=()=>{const{user:e}=u(),i=c();return w.useEffect(()=>{if(!e?.id)return;const n=s.channel(`invitation-code-${e.id}`).on("postgres_changes",{event:"*",schema:"public",table:"invitation_codes",filter:`user_id=eq.${e.id}`},()=>{i.invalidateQueries({queryKey:["my-invitation-code",e.id]})}).subscribe();return()=>{s.removeChannel(n)}},[e?.id,i]),v({queryKey:["my-invitation-code",e?.id],queryFn:async()=>{if(!e?.id)return null;const{data:n,error:t}=await s.from("invitation_codes").select("*").eq("user_id",e.id).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;return n},enabled:!!e?.id})},j=()=>{const{user:e}=u(),i=c();return w.useEffect(()=>{if(!e?.id)return;const n=s.channel(`invitation-code-history-${e.id}`).on("postgres_changes",{event:"*",schema:"public",table:"invitation_codes",filter:`user_id=eq.${e.id}`},()=>{i.invalidateQueries({queryKey:["my-invitation-code-history",e.id]})}).subscribe();return()=>{s.removeChannel(n)}},[e?.id,i]),v({queryKey:["my-invitation-code-history",e?.id],queryFn:async()=>{if(!e?.id)return[];const{data:n,error:t}=await s.from("invitation_codes").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(t)throw t;return n},enabled:!!e?.id})},I=()=>{const{user:e}=u(),{toast:i}=_(),n=c();return f({mutationFn:async t=>{if(!e?.id)throw new Error("User not authenticated");const{data:r,error:o}=await s.rpc("generate_invitation_code");if(o)throw o;const{data:a,error:l}=await s.from("invitation_codes").insert({user_id:e.id,code:r,full_name:t.full_name,nif:t.nif,contact:t.contact,address:t.address,status:"pending"}).select().single();if(l)throw l;return await s.from("profiles").update({full_name:t.full_name,nif:t.nif,contact:t.contact,address:t.address}).eq("id",e.id),a},onSuccess:()=>{n.invalidateQueries({queryKey:["my-invitation-code"]}),i({title:"申请已提交",description:"您的邀请码申请已提交，请等待管理员审核"})},onError:()=>{i({title:"申请失败",description:"提交申请时发生错误，请稍后重试",variant:"destructive"})}})},K=()=>{const{user:e}=u(),{toast:i}=_(),n=c();return f({mutationFn:async({id:t,data:r})=>{if(!e?.id)throw new Error("User not authenticated");const{data:o,error:a}=await s.from("invitation_codes").update({full_name:r.full_name,nif:r.nif,contact:r.contact,address:r.address,status:"pending",rejection_reason:null,reviewed_by:null,reviewed_at:null}).eq("id",t).eq("user_id",e.id).select().single();if(a)throw a;return await s.from("profiles").update({full_name:r.full_name,nif:r.nif,contact:r.contact,address:r.address}).eq("id",e.id),o},onSuccess:()=>{n.invalidateQueries({queryKey:["my-invitation-code"]}),i({title:"重新申请已提交",description:"您的邀请码申请已重新提交，请等待管理员审核"})},onError:()=>{i({title:"申请失败",description:"提交申请时发生错误，请稍后重试",variant:"destructive"})}})},R=()=>v({queryKey:["admin-invitation-codes"],queryFn:async()=>{const{data:e,error:i}=await s.from("invitation_codes").select("*").order("created_at",{ascending:!1});if(i)throw i;if(!e?.length)return[];const n=[...new Set(e.map(r=>r.user_id))],{data:t}=await s.from("profiles").select("id, display_name, avatar_url").in("id",n);return e.map(r=>({...r,profiles:t?.find(o=>o.id===r.user_id)||null}))}}),U=()=>v({queryKey:["invitation-code-stats"],queryFn:async()=>{const{data:e,error:i}=await s.from("invitation_codes").select("status");if(i)throw i;return{total:e.length,pending:e.filter(t=>t.status==="pending").length,approved:e.filter(t=>t.status==="approved").length,rejected:e.filter(t=>t.status==="rejected").length,revoked:e.filter(t=>t.status==="revoked").length}}}),F=e=>v({queryKey:["invitation-code-usage-details",e],queryFn:async()=>{if(!e)return null;const{data:i,error:n}=await s.from("join_requests").select("id, name, email, restaurant_name, status, created_at").eq("invitation_code",e).order("created_at",{ascending:!1});if(n)throw n;const{data:t,error:r}=await s.from("profiles").select("id, display_name, avatar_url, created_at, invited_at").eq("invitation_code_used",e).order("invited_at",{ascending:!1});if(r)throw r;const o=i?.length||0,a=i?.filter(d=>d.status==="completed").length||0,l=i?.filter(d=>d.status==="pending"||d.status==="received").length||0,m=t?.length||0,p=o>0?Math.round((a+m)/o*100):0;return{joinRequests:i||[],invitedUsers:t||[],stats:{totalUsed:o,completedJoinRequests:a,pendingJoinRequests:l,registeredUsers:m,successRate:p}}},enabled:!!e}),Q=()=>v({queryKey:["invitation-code-performance-stats"],queryFn:async()=>{const{data:e,error:i}=await s.from("invitation_codes").select("code, usage_count").eq("status","approved");if(i)throw i;const{data:n,error:t}=await s.from("join_requests").select("invitation_code, status").not("invitation_code","is",null);if(t)throw t;const{data:r,error:o}=await s.from("profiles").select("invitation_code_used").not("invitation_code_used","is",null);if(o)throw o;const a=e?.length||0,l=e?.reduce((y,g)=>y+(g.usage_count||0),0)||0,m=e?.filter(y=>(y.usage_count||0)>0).length||0,p=n?.filter(y=>y.status==="completed").length||0,d=n?.length||0,h=r?.length||0,q=d>0?Math.round((p+h)/d*100):0;return{totalCodes:a,totalUsage:l,activeCodesCount:m,completedJoinRequests:p,totalJoinRequestsWithCode:d,totalRegisteredUsers:h,overallSuccessRate:q}}}),k=()=>{const{user:e}=u(),{toast:i}=_(),n=c();return f({mutationFn:async t=>{if(!e?.id)throw new Error("User not authenticated");const{data:r,error:o}=await s.from("invitation_codes").update({status:"approved",reviewed_by:e.id,reviewed_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw o;return r},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-invitation-codes"]}),n.invalidateQueries({queryKey:["invitation-code-stats"]}),i({title:"审核通过",description:"邀请码申请已通过"})},onError:()=>{i({title:"操作失败",description:"审核操作失败，请稍后重试",variant:"destructive"})}})},M=()=>{const{user:e}=u(),{toast:i}=_(),n=c();return f({mutationFn:async({id:t,reason:r})=>{if(!e?.id)throw new Error("User not authenticated");const{data:o,error:a}=await s.from("invitation_codes").update({status:"rejected",rejection_reason:r,reviewed_by:e.id,reviewed_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw a;return o},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-invitation-codes"]}),n.invalidateQueries({queryKey:["invitation-code-stats"]}),i({title:"已拒绝",description:"邀请码申请已拒绝"})},onError:()=>{i({title:"操作失败",description:"审核操作失败，请稍后重试",variant:"destructive"})}})},A=()=>{const{user:e}=u(),{toast:i}=_(),n=c();return f({mutationFn:async({id:t,reason:r})=>{if(!e?.id)throw new Error("User not authenticated");const{data:o,error:a}=await s.from("invitation_codes").update({status:"revoked",rejection_reason:r,reviewed_by:e.id,reviewed_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw a;return o},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-invitation-codes"]}),n.invalidateQueries({queryKey:["invitation-code-stats"]}),i({title:"已收回",description:"邀请码已成功收回"})},onError:()=>{i({title:"操作失败",description:"收回操作失败，请稍后重试",variant:"destructive"})}})},D=()=>f({mutationFn:async e=>{const{data:i,error:n}=await s.from("invitation_codes").select("id, code, user_id, status").eq("code",e.toUpperCase()).eq("status","approved").maybeSingle();if(n)throw n;return i}});export{K as a,S as b,j as c,D as d,k as e,M as f,A as g,F as h,R as i,U as j,Q as k,I as u};
//# sourceMappingURL=useInvitationCodes-Dw_jBvr8.js.map
