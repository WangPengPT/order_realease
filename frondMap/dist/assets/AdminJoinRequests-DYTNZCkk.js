import{j as e}from"./vendor-ui-C5i6UHrb.js";import{Q as i,i as R,v as k,T,aT as O,w as M,I as w,B as m,q as me,j as ue,a6 as he,a7 as je,F as xe,a8 as pe,a9 as X,b0 as ge,P as fe,r as ve,g as we,G as q,aM as be,aN as ye,aO as Ue,aP as Ne,aQ as Se,bc as Ce,f as De,b2 as _e,ag as Ee,ah as Ae,ai as Re,aj as ke,ak as Te,al as Oe,am as Me,an as qe,D as Fe,b as Pe,c as Le,d as $e,ay as Ie,az as N,aB as Qe,aF as r}from"./index-IeyQ9IsG.js";import{T as Ke,a as Be,b as Y,c as u,d as He,e as h}from"./table-D_4pSymK.js";import{u as ze,a as F,b as Z}from"./vendor-query-BqhVR-X_.js";import{r as c}from"./vendor-react-iAJ0IrSD.js";import{S as Ve}from"./switch-MJGnmGNO.js";import{u as Ge}from"./vendor-i18n-DxKeo2S1.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-DEeLm6rS.js";const ee=["pending","received","completed","cancelled"],rs=()=>{const{t:s}=Ge(),[P,se]=c.useState(""),[b,L]=c.useState("all"),[S,C]=c.useState(null),[te,f]=c.useState(!1),[o,ae]=c.useState(null),[v,$]=c.useState(""),[j,I]=c.useState(""),[D,_]=c.useState(!1),[E,d]=c.useState(!1),[y,Q]=c.useState(!1),x=ze(),{data:K,isLoading:re}=F({queryKey:["joinRequests"],queryFn:async()=>{const{data:t,error:a}=await i.from("join_requests").select("*").order("created_at",{ascending:!1});if(a)throw a;return t}}),{data:A}=F({queryKey:["emailConfig","join_request"],queryFn:async()=>{const{data:t,error:a}=await i.from("email_config").select("*").eq("type","join_request").single();if(a)throw a;return t}}),{data:B}=F({queryKey:["siteSettings"],queryFn:async()=>{const{data:t,error:a}=await i.from("site_settings").select("logo_url").single();if(a)throw a;return t}});c.useEffect(()=>{const t=i.channel("join_requests_changes").on("postgres_changes",{event:"*",schema:"public",table:"join_requests"},()=>{x.invalidateQueries({queryKey:["joinRequests"]})}).subscribe();return()=>{i.removeChannel(t)}},[x]);const p=K?.filter(t=>{const a=P.toLowerCase(),n=t.name.toLowerCase().includes(a)||t.email.toLowerCase().includes(a)||t.restaurant_name.toLowerCase().includes(a)||t.phone.toLowerCase().includes(a),g=b==="all"||t.status===b;return n&&g}),ne=async()=>{const t=prompt(s("joinUs.enterNewEmail"),A?.recipient_email);if(t)try{const{error:a}=await i.from("email_config").update({recipient_email:t}).eq("id",A?.id);if(a)throw a;r({title:s("common.success"),description:s("joinUs.emailUpdated")})}catch(a){console.error("Error updating email:",a),r({title:s("common.error"),description:s("joinUs.emailUpdateError"),variant:"destructive"})}},H=Z({mutationFn:async({id:t,status:a})=>{const{error:n}=await i.from("join_requests").update({status:a}).eq("id",t);if(n)throw n},onSuccess:()=>{x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.statusUpdated")})},onError:t=>{console.error("Error updating status:",t),r({title:s("common.error"),description:s("joinUs.statusUpdateError"),variant:"destructive"})}}),z=Z({mutationFn:async t=>{const{error:a}=await i.from("join_requests").delete().eq("id",t);if(a)throw a},onSuccess:()=>{x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.requestDeleted")}),C(null)},onError:t=>{console.error("Error deleting request:",t),r({title:s("common.error"),description:s("joinUs.deleteError"),variant:"destructive"})}}),ie=()=>{if(!p||p.length===0){r({title:s("admin.noDataToExport"),variant:"destructive"});return}const t=[["Name","Email","Phone","Restaurant Name","Restaurant Address","Features","Status","Submitted Date"],...p.map(l=>[l.name,l.email,l.phone,l.restaurant_name,l.restaurant_address||"",Array.isArray(l.features_selected)?l.features_selected.join(", "):"",l.status||"pending",new Date(l.created_at).toLocaleString()])].map(l=>l.map(U=>`"${U}"`).join(",")).join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),g=URL.createObjectURL(a);n.setAttribute("href",g),n.setAttribute("download",`join_requests_${new Date().toISOString()}.csv`),n.click(),URL.revokeObjectURL(g),r({title:s("admin.exportSuccess")})},V=t=>{switch(t){case"completed":return"default";case"received":return"secondary";case"cancelled":return"destructive";default:return"outline"}},oe=t=>{ae(t),$(t.email),I(""),Q(!1),f(!0)},le=async()=>{if(!o||!v.trim()||!j.trim()){r({title:s("common.error"),description:s("joinUs.accountPasswordRequired"),variant:"destructive"});return}if(j.length<6){r({title:s("common.error"),description:s("auth.passwordTooShort"),variant:"destructive"});return}try{if(y){_(!0);const ce=`【小熊市场】您的商家账号信息 - ${o.restaurant_name}`,de="您的商家账号信息如下！",{data:J,error:W}=await i.functions.invoke("send-merchant-email",{body:{to:o.email,subject:ce,content:de,merchantName:o.name,account:v,password:j,logoUrl:B?.logo_url||null}});if(W)throw W;if(!J.success)throw new Error(J.error);await i.from("join_requests").update({email_sent_at:new Date().toISOString()}).eq("id",o.id),x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),f(!1);return}d(!0);const{data:t}=await i.auth.getSession();if(!t?.session){r({title:s("common.error"),description:s("auth.sessionExpired"),variant:"destructive"}),d(!1);return}const{data:a,error:n}=await i.functions.invoke("admin-create-user",{body:{email:v,password:j,displayName:o.name,phone:o.phone,role:"merchant"}});if(n){console.error("Create user function error:",n),r({title:s("common.error"),description:n.message||s("admin.createUserError"),variant:"destructive"}),d(!1);return}if(a?.error){console.error("Create user business error:",a.error),r({title:s("common.error"),description:a.error,variant:"destructive"}),d(!1);return}if(!a?.success||!a?.user){console.error("User creation failed - no user returned"),r({title:s("common.error"),description:s("admin.createUserError"),variant:"destructive"}),d(!1);return}r({title:s("common.success"),description:s("joinUs.merchantUserCreated")}),d(!1),_(!0);const g=`【小熊市场】您的商家账号已创建 - ${o.restaurant_name}`,l="您的商家账号已创建成功！",{data:U,error:G}=await i.functions.invoke("send-merchant-email",{body:{to:o.email,subject:g,content:l,merchantName:o.name,account:v,password:j,logoUrl:B?.logo_url||null}});if(G)throw G;if(!U.success)throw new Error(U.error);await i.from("join_requests").update({status:"received",email_sent_at:new Date().toISOString()}).eq("id",o.id),x.invalidateQueries({queryKey:["joinRequests"]}),r({title:s("common.success"),description:s("joinUs.emailSentSuccess")}),f(!1)}catch(t){console.error("Error:",t),r({title:s("common.error"),description:t.message||s("joinUs.emailSendError"),variant:"destructive"})}finally{d(!1),_(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("joinUs.adminTitle")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:s("joinUs.adminDescription")})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsx(T,{children:s("joinUs.recipientEmail")}),e.jsx(O,{children:s("joinUs.recipientEmailDesc")})]}),e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{value:A?.recipient_email||"",readOnly:!0}),e.jsx(m,{onClick:ne,children:s("common.edit")})]})})]}),e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsx(T,{children:s("joinUs.totalRequests")}),e.jsx(O,{children:s("joinUs.totalRequestsDesc")})]}),e.jsx(M,{children:e.jsx("div",{className:"text-3xl font-bold",children:K?.length||0})})]})]}),e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(T,{children:s("joinUs.allRequests")}),e.jsx(O,{children:s("joinUs.allRequestsDesc")})]}),e.jsxs(m,{onClick:ie,variant:"outline",children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),s("admin.exportCSV")]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(w,{placeholder:s("joinUs.searchPlaceholder"),value:P,onChange:t=>se(t.target.value),className:"pl-10"})]}),e.jsxs(he,{children:[e.jsx(je,{asChild:!0,children:e.jsxs(m,{variant:"outline",className:"gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),s(b==="all"?"admin.allStatus":`joinUs.status.${b}`)]})}),e.jsxs(pe,{align:"end",className:"bg-background",children:[e.jsx(X,{onClick:()=>L("all"),children:s("admin.allStatus")}),ee.map(t=>e.jsx(X,{onClick:()=>L(t),children:s(`joinUs.status.${t}`)},t))]})]})]})]}),e.jsx(M,{children:re?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("common.loading")}):p&&p.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ke,{children:[e.jsx(Be,{children:e.jsxs(Y,{children:[e.jsx(u,{children:s("joinUs.name")}),e.jsx(u,{children:s("joinUs.contact")}),e.jsx(u,{children:s("joinUs.restaurant")}),e.jsx(u,{children:s("joinUs.featuresNeeded")}),e.jsx(u,{children:s("joinUs.status")}),e.jsx(u,{children:s("joinUs.submittedAt")}),e.jsx(u,{className:"text-right",children:s("common.actions")})]})}),e.jsx(He,{children:p.map(t=>e.jsxs(Y,{children:[e.jsx(h,{className:"font-medium",children:t.name}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ge,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`mailto:${t.email}`,className:"hover:underline",children:t.email})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fe,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("a",{href:`tel:${t.phone}`,className:"hover:underline",children:t.phone})]})]})}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ve,{className:"w-3 h-3 text-muted-foreground"}),t.restaurant_name]}),t.restaurant_address&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(we,{className:"w-3 h-3"}),t.restaurant_address]})]})}),e.jsx(h,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:Array.isArray(t.features_selected)&&t.features_selected.map((a,n)=>e.jsx(q,{variant:"secondary",children:s(`joinUs.feature.${a}`)},n))})}),e.jsx(h,{children:e.jsxs(be,{value:t.status||"pending",onValueChange:a=>H.mutate({id:t.id,status:a}),disabled:H.isPending,children:[e.jsx(ye,{className:"w-[130px]",children:e.jsx(Ue,{children:e.jsx(q,{variant:V(t.status||"pending"),children:s(`joinUs.status.${t.status||"pending"}`)})})}),e.jsx(Ne,{children:ee.map(a=>e.jsx(Se,{value:a,children:e.jsx(q,{variant:V(a),children:s(`joinUs.status.${a}`)})},a))})]})}),e.jsx(h,{className:"text-sm text-muted-foreground",children:Ce(new Date(t.created_at),{addSuffix:!0})}),e.jsx(h,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>oe(t),title:s("joinUs.sendEmail"),children:e.jsx(De,{className:"w-4 h-4"})}),e.jsx(m,{size:"sm",variant:"destructive",onClick:()=>C(t.id),disabled:z.isPending,children:e.jsx(_e,{className:"w-4 h-4"})})]})})]},t.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("joinUs.noRequests")})})]})]}),e.jsx(Ee,{open:S!==null,onOpenChange:t=>!t&&C(null),children:e.jsxs(Ae,{children:[e.jsxs(Re,{children:[e.jsx(ke,{children:s("joinUs.confirmDelete")}),e.jsx(Te,{children:s("joinUs.confirmDeleteDescription")})]}),e.jsxs(Oe,{children:[e.jsx(Me,{children:s("common.cancel")}),e.jsx(qe,{onClick:()=>S&&z.mutate(S),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s("common.delete")})]})]})}),e.jsx(Fe,{open:te,onOpenChange:f,children:e.jsxs(Pe,{className:"sm:max-w-[500px]",children:[e.jsxs(Le,{children:[e.jsx($e,{children:s("joinUs.sendAccountTitle")}),e.jsx(Ie,{children:s("joinUs.sendAccountDescription",{name:o?.name})})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(N,{htmlFor:"emailOnlyMode",className:"font-medium",children:s("joinUs.emailOnlyMode")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("joinUs.emailOnlyModeDesc")})]}),e.jsx(Ve,{id:"emailOnlyMode",checked:y,onCheckedChange:Q})]}),!y&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:["ℹ️ ",s("joinUs.createUserModeNote")]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:s("joinUs.emailRecipient")}),e.jsx(w,{value:o?.email||"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"account",children:s("joinUs.merchantAccount")}),e.jsx(w,{id:"account",value:v,onChange:t=>$(t.target.value),placeholder:s("joinUs.merchantAccountPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"password",children:s("joinUs.merchantPassword")}),e.jsx(w,{id:"password",type:"text",value:j,onChange:t=>I(t.target.value),placeholder:s("joinUs.merchantPasswordPlaceholder")})]}),e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:["⚠️ ",s("joinUs.passwordSecurityNote")]})})]}),e.jsxs(Qe,{children:[e.jsx(m,{variant:"outline",onClick:()=>f(!1),disabled:E||D,children:s("common.cancel")}),e.jsx(m,{onClick:le,disabled:E||D,children:s(E?"joinUs.creatingUser":D?"common.sending":y?"joinUs.sendEmailOnly":"joinUs.createAndSendEmail")})]})]})})]})};export{rs as default};
//# sourceMappingURL=AdminJoinRequests-DYTNZCkk.js.map
