import{p as F,q as J,r,j as e,bf as x,bJ as K,be as W,b3 as X,bm as $,cl as G,c0 as Y,br as Z,e4 as O,b5 as ee,aM as se,w as I,c3 as D,bI as ae,b$ as te,c6 as ne,bv as ie,a4 as re}from"./vendor-react-COnB1Bf9.js";import{D as le,c as ce,d as de,e as me,P as oe,Q as xe,R as ue,U as i,B as u,i as l,g as E,I as he,a2 as h,a3 as g,a4 as j,a5 as f,a6 as c,s as ge}from"./index-T7L6ozN1.js";import{S as je}from"./separator-BDZI3xWL.js";import{a as fe}from"./useCommunityPosts-VrYjWjR9.js";import{u as Ne}from"./useActivities-CNSwrhvp.js";import{u as ve}from"./useLocalizedContent-pMHaJh_n.js";import{H as L,p as pe,I as ye,J as be}from"./vendor-utils-Z4kpnli5.js";const Re=({post:s,open:M,onOpenChange:d})=>{const{t,i18n:T}=F(),{getLocalizedField:N}=ve(),m=fe(),{data:q}=Ne(),v=J(),[p,y]=r.useState(0),[b,w]=r.useState("approved"),[_,k]=r.useState("pending"),[S,C]=r.useState(""),[P,A]=r.useState(!1);r.useEffect(()=>{s&&(y(s.weight),w(s.status),k(s.moderation_status),C(s.activity_id||""))},[s]);const z=a=>a===null?"bg-gray-100 text-gray-600":a<=30?"bg-emerald-100 text-emerald-700":a<=60?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700",H=async()=>{if(s){A(!0);try{const{error:a}=await ge.functions.invoke("moderate-post",{body:{post_id:s.id,content:s.content,user_id:s.author_id,image_urls:s.image_urls,video_url:s.video_url}});if(a)throw a;I.success(t("admin.moderation.reReviewSuccess","重新审核完成")),v.invalidateQueries({queryKey:["admin-community-posts"]}),v.invalidateQueries({queryKey:["community-post"]})}catch(a){console.error("Re-moderation error:",a),I.error(t("admin.moderation.reReviewError","重新审核失败"))}finally{A(!1)}}},R=()=>{switch(T.language){case"zh":return be;case"pt":return ye;default:return pe}},B=async()=>{s&&(await m.mutateAsync({id:s.id,weight:p,status:b,moderation_status:_,activity_id:S||null}),d(!1))};if(!s)return null;const Q=q?.filter(a=>a.status==="published")||[],V=a=>{switch(a){case"approved":return{icon:ne,label:t("admin.status.approved","已发布"),className:"text-emerald-600"};case"pending":return{icon:x,label:t("admin.status.pending","待审核"),className:"text-amber-600"};case"rejected":return{icon:te,label:t("admin.status.rejected","已拒绝"),className:"text-red-600"};case"hidden":return{icon:ae,label:t("admin.status.hidden","已隐藏"),className:"text-gray-500"};default:return{icon:D,label:a,className:"text-gray-500"}}},U=a=>{switch(a){case"approved":return{icon:re,label:t("admin.moderation.approved","通过"),className:"text-emerald-600"};case"flagged":return{icon:ie,label:t("admin.moderation.flagged","标记"),className:"text-orange-500"};case"pending":return{icon:x,label:t("admin.moderation.pending","待审"),className:"text-gray-500"};default:return{icon:D,label:a,className:"text-gray-500"}}};return e.jsx(le,{open:M,onOpenChange:d,children:e.jsxs(ce,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(de,{className:"pb-4 border-b",children:e.jsx(me,{className:"text-xl",children:t("admin.communityPosts.manage","管理帖子")})}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gradient-to-r from-muted/50 to-muted/30 rounded-xl",children:[e.jsxs(oe,{className:"h-14 w-14 ring-2 ring-background shadow-md",children:[e.jsx(xe,{src:s.author?.avatar_url||void 0}),e.jsx(ue,{className:"bg-primary/10 text-primary font-semibold text-lg",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-lg",children:s.author?.display_name}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1.5",children:[e.jsx(x,{className:"h-3.5 w-3.5"}),L(new Date(s.created_at),{addSuffix:!0,locale:R()})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-sm font-medium",children:t("admin.communityPosts.content","内容")}),e.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert p-4 border rounded-xl bg-muted/20",dangerouslySetInnerHTML:{__html:N(s,"content")}})]}),s.image_urls&&s.image_urls.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-sm font-medium",children:t("admin.communityPosts.images","图片")}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:s.image_urls.map((a,n)=>e.jsx("div",{className:"aspect-square rounded-xl overflow-hidden border shadow-sm hover:shadow-md transition-shadow",children:e.jsx("img",{src:a,alt:"",className:"w-full h-full object-cover"})},n))})]}),s.video_url&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-sm font-medium",children:t("admin.communityPosts.video","视频")}),e.jsx("video",{src:s.video_url,controls:!0,className:"w-full max-h-48 rounded-xl border shadow-sm",preload:"metadata"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/30 rounded-xl flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(K,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:s.views_count||0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.views","浏览")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(W,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium",children:s.likes_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.likes","赞")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(X,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium",children:s.comments_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.comments","评论")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx($,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium",children:s.shares_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.shares","分享")})]})]}),(s.risk_score!==null||s.ai_reviewed_at)&&e.jsxs("div",{className:"space-y-3 p-4 bg-muted/30 rounded-xl border border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(i,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),t("admin.moderation.aiResult","AI审核结果")]}),e.jsxs(u,{size:"sm",variant:"ghost",onClick:H,disabled:P,className:"h-7 text-xs",children:[e.jsx(Y,{className:l("h-3.5 w-3.5 mr-1",P&&"animate-spin")}),t("admin.moderation.reReview","重审")]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(E,{className:l("text-sm",z(s.risk_score)),children:[e.jsx(Z,{className:"h-3.5 w-3.5 mr-1"}),t("admin.moderation.riskScore","风险分数"),": ",s.risk_score??"-"]}),s.ai_reviewed_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:L(new Date(s.ai_reviewed_at),{addSuffix:!0,locale:R()})})]}),s.risk_reasons&&s.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.risk_reasons.map((a,n)=>e.jsx(E,{variant:"outline",className:"text-xs",children:a},n))})]}),e.jsx(je,{}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4"}),t("admin.communityPosts.weight","权重")]}),e.jsx(he,{type:"number",value:p,onChange:a=>y(parseInt(a.target.value)||0),min:0,max:1e3,className:"h-10"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.communityPosts.weightHint","权重越高，帖子排序越靠前")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),t("admin.communityPosts.linkActivity","关联活动")]}),e.jsxs(h,{value:S||"none",onValueChange:a=>C(a==="none"?"":a),children:[e.jsx(g,{className:"h-10",children:e.jsx(j,{placeholder:t("community.selectActivity","选择活动（可选）")})}),e.jsxs(f,{children:[e.jsx(c,{value:"none",children:t("community.noActivity","不关联活动")}),Q.map(a=>e.jsx(c,{value:a.id,children:N(a,"title")},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-sm font-medium",children:t("admin.communityPosts.status","状态")}),e.jsxs(h,{value:b,onValueChange:w,children:[e.jsx(g,{className:"h-10",children:e.jsx(j,{})}),e.jsx(f,{children:["approved","pending","hidden","rejected"].map(a=>{const n=V(a),o=n.icon;return e.jsx(c,{value:a,children:e.jsxs("span",{className:l("flex items-center gap-2",n.className),children:[e.jsx(o,{className:"h-4 w-4"}),n.label]})},a)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-sm font-medium",children:t("admin.communityPosts.moderation","审核状态")}),e.jsxs(h,{value:_,onValueChange:k,children:[e.jsx(g,{className:"h-10",children:e.jsx(j,{})}),e.jsx(f,{children:["pending","approved","flagged"].map(a=>{const n=U(a),o=n.icon;return e.jsx(c,{value:a,children:e.jsxs("span",{className:l("flex items-center gap-2",n.className),children:[e.jsx(o,{className:"h-4 w-4"}),n.label]})},a)})})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(u,{variant:"outline",onClick:()=>d(!1),className:"px-6",children:t("common.cancel","取消")}),e.jsxs(u,{onClick:B,disabled:m.isPending,className:"px-6",children:[m.isPending&&e.jsx(se,{className:"h-4 w-4 mr-2 animate-spin"}),t("common.save","保存")]})]})]})})};export{Re as P};
//# sourceMappingURL=PostManagementDialog-DPF5OYwa.js.map
