{"version":3,"file":"usePoints-CgohqkHy.js","sources":["../../src/hooks/usePoints.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { useTranslation } from \"react-i18next\";\r\n\r\nexport interface PointsTransaction {\r\n  id: string;\r\n  user_id: string;\r\n  amount: number;\r\n  balance_after: number;\r\n  type: 'comment' | 'admin_grant' | 'admin_deduct' | 'purchase' | 'refund' | 'expire';\r\n  reference_id: string | null;\r\n  reason: string | null;\r\n  expires_at: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface PointsSetting {\r\n  id: string;\r\n  key: string;\r\n  value: string;\r\n  description_zh: string | null;\r\n  description_en: string | null;\r\n  description_pt: string | null;\r\n  updated_at: string;\r\n}\r\n\r\n// Hook to get user's points balance\r\nexport const useUserPoints = () => {\r\n  const { user } = useAuth();\r\n  \r\n  return useQuery({\r\n    queryKey: ['user-points', user?.id],\r\n    queryFn: async () => {\r\n      if (!user?.id) return 0;\r\n      \r\n      const { data, error } = await supabase\r\n        .from('profiles')\r\n        .select('points')\r\n        .eq('id', user.id)\r\n        .single();\r\n      \r\n      if (error) throw error;\r\n      return data?.points ?? 0;\r\n    },\r\n    enabled: !!user?.id,\r\n  });\r\n};\r\n\r\n// Hook to get user's points transactions\r\nexport const usePointsTransactions = (userId?: string) => {\r\n  const { user } = useAuth();\r\n  const targetUserId = userId || user?.id;\r\n  \r\n  return useQuery({\r\n    queryKey: ['points-transactions', targetUserId],\r\n    queryFn: async () => {\r\n      if (!targetUserId) return [];\r\n      \r\n      const { data, error } = await supabase\r\n        .from('points_transactions')\r\n        .select('*')\r\n        .eq('user_id', targetUserId)\r\n        .order('created_at', { ascending: false });\r\n      \r\n      if (error) throw error;\r\n      return data as PointsTransaction[];\r\n    },\r\n    enabled: !!targetUserId,\r\n  });\r\n};\r\n\r\n// Hook to get all points transactions (admin)\r\nexport const useAllPointsTransactions = (filters?: { type?: string; userId?: string }) => {\r\n  return useQuery({\r\n    queryKey: ['all-points-transactions', filters],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from('points_transactions')\r\n        .select(`\r\n          *,\r\n          profiles:user_id (\r\n            id,\r\n            display_name,\r\n            avatar_url\r\n          )\r\n        `)\r\n        .order('created_at', { ascending: false })\r\n        .limit(500);\r\n      \r\n      if (filters?.type) {\r\n        query = query.eq('type', filters.type);\r\n      }\r\n      if (filters?.userId) {\r\n        query = query.eq('user_id', filters.userId);\r\n      }\r\n      \r\n      const { data, error } = await query;\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to get points settings\r\nexport const usePointsSettings = () => {\r\n  return useQuery({\r\n    queryKey: ['points-settings'],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from('points_settings')\r\n        .select('*');\r\n      \r\n      if (error) throw error;\r\n      return data as PointsSetting[];\r\n    },\r\n  });\r\n};\r\n\r\n// Hook to update points setting\r\nexport const useUpdatePointsSetting = () => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async ({ key, value }: { key: string; value: string }) => {\r\n      const { error } = await supabase\r\n        .from('points_settings')\r\n        .update({ value, updated_at: new Date().toISOString() })\r\n        .eq('key', key);\r\n      \r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['points-settings'] });\r\n      toast({\r\n        title: t('common.success'),\r\n        description: t('admin.points.settingUpdated'),\r\n      });\r\n    },\r\n    onError: () => {\r\n      toast({\r\n        title: t('common.error'),\r\n        description: t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n\r\n// Hook for admin to modify user points\r\nexport const useAdminModifyPoints = () => {\r\n  const { t } = useTranslation();\r\n  const queryClient = useQueryClient();\r\n  \r\n  return useMutation({\r\n    mutationFn: async ({ \r\n      userId, \r\n      amount, \r\n      reason \r\n    }: { \r\n      userId: string; \r\n      amount: number; \r\n      reason: string;\r\n    }) => {\r\n      const { data, error } = await supabase.rpc('admin_modify_points', {\r\n        p_target_user_id: userId,\r\n        p_amount: amount,\r\n        p_reason: reason,\r\n      });\r\n      \r\n      if (error) throw error;\r\n      \r\n      const result = data as { success: boolean; error?: string; new_balance?: number };\r\n      if (!result.success) {\r\n        throw new Error(result.error || 'Unknown error');\r\n      }\r\n      \r\n      return result;\r\n    },\r\n    onSuccess: (_, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: ['user-points'] });\r\n      queryClient.invalidateQueries({ queryKey: ['points-transactions'] });\r\n      queryClient.invalidateQueries({ queryKey: ['all-points-transactions'] });\r\n      queryClient.invalidateQueries({ queryKey: ['profiles'] });\r\n      \r\n      toast({\r\n        title: t('common.success'),\r\n        description: variables.amount > 0 \r\n          ? t('admin.points.grantSuccess')\r\n          : t('admin.points.deductSuccess'),\r\n      });\r\n    },\r\n    onError: (error: Error) => {\r\n      toast({\r\n        title: t('common.error'),\r\n        description: error.message === 'insufficient_points'\r\n          ? t('admin.points.insufficientPoints')\r\n          : t('common.errorOccurred'),\r\n        variant: 'destructive',\r\n      });\r\n    },\r\n  });\r\n};\r\n"],"names":["useUserPoints","user","useAuth","useQuery","data","error","supabase","usePointsTransactions","userId","targetUserId","useAllPointsTransactions","filters","query","usePointsSettings","useUpdatePointsSetting","useTranslation","queryClient","useQueryClient","useMutation","key","value","toast","useAdminModifyPoints","amount","reason","result","_","variables"],"mappings":"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"}