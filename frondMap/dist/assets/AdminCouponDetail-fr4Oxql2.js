import{j as e}from"./vendor-ui-DAmPMpEA.js";import{a as ae,u as Je}from"./vendor-query-BlSVl3IQ.js";import{r as u,j as Ye,u as Ze,L as Xe}from"./vendor-react-iAJ0IrSD.js";import{r as es,D as re,a3 as ss,B as N,a as le,b as de,c as ce,$ as oe,S as ts,L as ue,q as F,s as m,a0 as ie,I as Te,a6 as B,a7 as I,a8 as Q,a9 as V,aa as h,a2 as qe,y as q,C as X,i as ee,t as se,j as te,f as as,ag as is,Y as ge,Z as fe,_ as _e,U as ve,g as ye,J as Ne,K as be,N as we,O as Ce,Q as Se,R as De,T as Ae,V as Ee}from"./index-BcrfGQEh.js";import{S as K}from"./separator-CM8vz3w9.js";import{u as He}from"./useLocalizedContent-tJ7i_ycU.js";import{h as ze,i as ns,j as rs,k as ls}from"./useCoupons-BQ7M5Y8a.js";import{C as ne}from"./checkbox-4ejPvdP9.js";import{u as O}from"./vendor-i18n-DxKeo2S1.js";import{L as Le}from"./link-CYPozdcn.js";import{f as T}from"./format-C1rHoFdk.js";import{u as ds}from"./index.esm-CVRqJy9l.js";import{A as cs}from"./arrow-left-4K88mBFI.js";import{T as ke}from"./ticket-BIMDfaCH.js";import{S as os}from"./search-DYCHfSrp.js";import{P as us}from"./pencil-Di38ODVj.js";import{H as ms}from"./history-CDUjO1Wv.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-KNAP0qdW.js";import"./startOfDay-CJ0Nm-E7.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=es("Code",[["polyline",{points:"16 18 22 12 16 6",key:"z7tu5w"}],["polyline",{points:"8 6 2 12 8 18",key:"1eg1df"}]]),hs=({templateId:r,children:v})=>{O();const{getLocalizedField:i}=He(),[C,t]=u.useState(!1),{data:p,isLoading:A}=ze(r),{data:l,isLoading:H}=ae({queryKey:["allActivitiesForCoupon"],queryFn:async()=>{const{data:d,error:c}=await m.from("activities").select("id, title_zh, title_en, title_pt, start_date, end_date, visible").eq("visible",!0).order("start_date",{ascending:!1});if(c)throw c;return d},enabled:C}),f=ns(),_=rs(),x=new Set(p?.map(d=>d.activity_id)||[]),M=async(d,c)=>{c?await _.mutateAsync({templateId:r,activityId:d}):await f.mutateAsync({templateId:r,activityId:d})},L=A||H,E=f.isPending||_.isPending;return e.jsxs(re,{open:C,onOpenChange:t,children:[e.jsx(ss,{asChild:!0,children:v||e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"管理关联活动"]})}),e.jsxs(le,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(de,{children:[e.jsx(ce,{children:"管理关联活动"}),e.jsx(oe,{children:"选择要关联到此优惠券模板的活动。一个优惠券可以关联多个活动。"})]}),e.jsx(ts,{className:"flex-1 pr-4",children:L?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(ue,{className:"w-6 h-6 animate-spin"})}):e.jsx("div",{className:"space-y-2",children:l&&l.length>0?l.map(d=>{const c=x.has(d.id);return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(ne,{checked:c,onCheckedChange:()=>M(d.id,c),disabled:E}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:i(d,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T(new Date(d.start_date),"yyyy-MM-dd"),d.end_date&&` ~ ${T(new Date(d.end_date),"yyyy-MM-dd")}`]})]})]}),c&&e.jsxs(F,{variant:"secondary",className:"ml-2",children:[e.jsx(Le,{className:"w-3 h-3 mr-1"}),"已关联"]})]},d.id)}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"暂无可关联的活动"})})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["已关联 ",x.size," 个活动"]}),e.jsx(N,{variant:"outline",onClick:()=>t(!1),children:"关闭"})]})]})]})};function ps({open:r,onOpenChange:v,couponCode:i,onSuccess:C}){const{t}=O(),[p,A]=u.useState(!1),l=()=>i.is_active?i.user_coupons?.some(S=>S.used_at)?"used":"available":"expired",{register:H,handleSubmit:f,watch:_,setValue:x,reset:M,formState:{errors:L}}=ds({defaultValues:{usage_limit:i.usage_limit,status:l()}});u.useEffect(()=>{M({usage_limit:i.usage_limit,status:l()})},[i,M]);const E=_("status"),d=async c=>{A(!0);try{const{error:S}=await m.from("coupon_codes").update({usage_limit:c.usage_limit,is_active:c.status!=="expired"}).eq("id",i.id);if(S)throw S;if(i.user_coupons&&i.user_coupons.length>0){if(c.status==="used"){const{error:k}=await m.from("user_coupons").update({used_at:new Date().toISOString()}).eq("coupon_code_id",i.id).is("used_at",null);if(k)throw k}else if(c.status==="available"){const{error:k}=await m.from("user_coupons").update({used_at:null}).eq("coupon_code_id",i.id);if(k)throw k}}q.success(t("admin.couponCode.updateSuccess")),C(),v(!1)}catch(S){console.error("Error updating coupon code:",S),q.error(t("admin.couponCode.updateError"))}finally{A(!1)}};return e.jsx(re,{open:r,onOpenChange:v,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsxs(de,{children:[e.jsx(ce,{children:t("admin.couponCode.editTitle")}),e.jsxs(oe,{children:[t("admin.couponCode.editDescription"),": ",e.jsx("code",{className:"font-mono font-semibold",children:i.code})]})]}),e.jsxs("form",{onSubmit:f(d),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"usage_limit",children:t("admin.couponCode.usageLimit")}),e.jsx(Te,{id:"usage_limit",type:"number",min:"1",...H("usage_limit",{required:t("admin.couponCode.usageLimitRequired"),min:{value:1,message:t("admin.couponCode.usageLimitMin")},valueAsNumber:!0})}),L.usage_limit&&e.jsx("p",{className:"text-sm text-destructive",children:L.usage_limit.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.couponCode.usageLimitHint")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(B,{value:E,onValueChange:c=>x("status",c),children:[e.jsx(I,{children:e.jsx(Q,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs(V,{children:[e.jsx(h,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(h,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(h,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[E==="available"&&t("admin.couponCode.statusAvailableHint"),E==="used"&&t("admin.couponCode.statusUsedHint"),E==="expired"&&t("admin.couponCode.statusExpiredHint")]})]}),e.jsxs(qe,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:p,children:t("common.cancel")}),e.jsxs(N,{type:"submit",disabled:p,children:[p&&e.jsx(ue,{className:"mr-2 h-4 w-4 animate-spin"}),t("common.save")]})]})]})]})})}function js({open:r,onOpenChange:v,selectedCodeIds:i,onSuccess:C}){const{t}=O(),[p,A]=u.useState(!1),[l,H]=u.useState("available"),f=async()=>{if(i.length!==0){A(!0);try{const{error:_}=await m.from("coupon_codes").update({is_active:l!=="expired"}).in("id",i);if(_)throw _;if(l==="used"){const{error:x}=await m.from("user_coupons").update({used_at:new Date().toISOString()}).in("coupon_code_id",i).is("used_at",null);if(x)throw x}else if(l==="available"){const{error:x}=await m.from("user_coupons").update({used_at:null}).in("coupon_code_id",i);if(x)throw x}q.success(t("admin.couponCode.batchUpdateSuccess",{count:i.length})),C(),v(!1)}catch(_){console.error("Error batch updating coupon codes:",_),q.error(t("admin.couponCode.batchUpdateError"))}finally{A(!1)}}};return e.jsx(re,{open:r,onOpenChange:v,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsxs(de,{children:[e.jsx(ce,{children:t("admin.couponCode.batchEditTitle")}),e.jsx(oe,{children:t("admin.couponCode.batchEditDescription",{count:i.length})})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(B,{value:l,onValueChange:_=>H(_),children:[e.jsx(I,{children:e.jsx(Q,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs(V,{children:[e.jsx(h,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(h,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(h,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[l==="available"&&t("admin.couponCode.statusAvailableHint"),l==="used"&&t("admin.couponCode.statusUsedHint"),l==="expired"&&t("admin.couponCode.statusExpiredHint")]})]})}),e.jsxs(qe,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:p,children:t("common.cancel")}),e.jsxs(N,{onClick:f,disabled:p,children:[p&&e.jsx(ue,{className:"mr-2 h-4 w-4 animate-spin"}),t("admin.couponCode.batchUpdate")]})]})]})})}const Us=()=>{const{id:r}=Ye(),v=Ze(),{t:i}=O(),{getLocalizedField:C}=He(),t=Je(),[p,A]=u.useState(""),[l,H]=u.useState("all"),[f,_]=u.useState("all"),[x,M]=u.useState("all"),[L,E]=u.useState(null),[d,c]=u.useState(null),[S,k]=u.useState(!1),[b,U]=u.useState(new Set),[Fe,me]=u.useState(!1),[Me,R]=u.useState(!1),[W,xe]=u.useState(!1),{data:n,isLoading:Ue}=ae({queryKey:["couponTemplate",r],queryFn:async()=>{const{data:s,error:a}=await m.from("coupon_templates").select("*").eq("id",r).single();if(a)throw a;return s},enabled:!!r}),{data:G,isLoading:Pe}=ze(r),{data:$,isLoading:Be}=ls(r),{data:D,isLoading:Ie}=ae({queryKey:["templateCouponCodes",r],queryFn:async()=>{const{data:s,error:a}=await m.from("coupon_codes").select(`
          *,
          user_coupons(
            id,
            user_id,
            claimed_at,
            used_at,
            source
          )
        `).eq("template_id",r).order("created_at",{ascending:!1});if(a)throw a;const j=(s||[]).map(o=>o.id),{data:P}=await m.from("coupon_usage_history").select("user_coupon_id, used_by_user_id, restaurant_id").in("coupon_code_id",j),Y=[...new Set((P||[]).map(o=>o.used_by_user_id))],{data:Z}=await m.from("profiles").select("id, display_name, avatar_url").in("id",Y),w=(Z||[]).reduce((o,g)=>(o[g.id]={display_name:g.display_name,avatar_url:g.avatar_url},o),{}),he=[...new Set((P||[]).filter(o=>o.restaurant_id).map(o=>o.restaurant_id))];let pe={};if(he.length>0){const{data:o}=await m.from("restaurants").select("id, name, name_en, name_pt").in("id",he);pe=(o||[]).reduce((g,y)=>(g[y.id]={name:y.name,name_en:y.name_en,name_pt:y.name_pt},g),{})}const je=(P||[]).reduce((o,g)=>(g.user_coupon_id&&(o[g.user_coupon_id]={used_by_merchant:w[g.used_by_user_id]||null,used_at_restaurant:g.restaurant_id&&pe[g.restaurant_id]||null}),o),{});return await Promise.all((s||[]).map(async o=>{const g=await Promise.all((o.user_coupons||[]).map(async y=>{if(!y.user_id)return{...y,profiles:{id:"",display_name:"Unknown",avatar_url:null},...je[y.id]};const{data:Ge}=await m.from("profiles").select("id, display_name, avatar_url").eq("id",y.user_id).maybeSingle();return{...y,profiles:Ge||{id:y.user_id,display_name:"Unknown",avatar_url:null},...je[y.id]}}));return{...o,user_coupons:g}}))},enabled:!!r}),z=u.useMemo(()=>D?D.filter(s=>{const a=p.toLowerCase(),j=p===""||s.code.toLowerCase().includes(a)||s.user_coupons.some(w=>w.profiles.display_name.toLowerCase().includes(a)),P=l==="all"||l==="active"&&s.is_active||l==="inactive"&&!s.is_active,Y=f==="all"||f==="unclaimed"&&s.user_coupons.length===0||f==="claimed"&&s.user_coupons.length>0&&s.user_coupons.every(w=>!w.used_at)||f==="used"&&s.user_coupons.some(w=>w.used_at),Z=x==="all"||x==="share"&&s.user_coupons.some(w=>w.source==="share")||x==="other"&&s.user_coupons.some(w=>w.source!=="share");return j&&P&&Y&&Z}):[],[D,p,l,f,x]),J=D?.length||0,Qe=D?.reduce((s,a)=>s+a.used_count,0)||0,Ve=D?.reduce((s,a)=>s+a.user_coupons.length,0)||0,$e=s=>{U(a=>{const j=new Set(a);return j.has(s)?j.delete(s):j.add(s),j})},Ke=()=>{b.size===z.length?U(new Set):U(new Set(z.map(s=>s.id)))},Oe=()=>{U(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",r]})},Re=async()=>{if(b.size!==0){xe(!0);try{const s=Array.from(b),{error:a}=await m.from("user_coupons").delete().in("coupon_code_id",s);if(a)throw a;const{error:j}=await m.from("coupon_codes").delete().in("id",s);if(j)throw j;q.success(i("admin.couponCode.batchDeleteSuccess",{count:s.length})),U(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",r]}),R(!1)}catch(s){console.error("Error batch deleting coupon codes:",s),q.error(i("admin.couponCode.batchDeleteError"))}finally{xe(!1)}}},We=async s=>{k(!0);try{const{error:a}=await m.from("user_coupons").delete().eq("coupon_code_id",s);if(a)throw a;const{error:j}=await m.from("coupon_codes").delete().eq("id",s);if(j)throw j;q.success("子优惠券已删除"),t.invalidateQueries({queryKey:["templateCouponCodes",r]}),c(null)}catch(a){console.error("Error deleting coupon code:",a),q.error("删除失败")}finally{k(!1)}};return Ue?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center py-12",children:"加载中..."})}):n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(N,{variant:"ghost",onClick:()=>v("/admin/coupons"),className:"mb-4",children:[e.jsx(cs,{className:"w-4 h-4 mr-2"}),"返回列表"]}),e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(ke,{className:"w-8 h-8"}),"优惠券模板详情"]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(X,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-lg",children:"模板信息"})}),e.jsxs(te,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"关联活动"}),Pe?e.jsx("p",{className:"text-sm",children:"加载中..."}):G&&G.length>0?e.jsx("div",{className:"space-y-2",children:G.map(s=>e.jsx(Xe,{to:`/activity/${s.activity_id}`,className:"block text-primary hover:underline",children:C(s.activities,"title")},s.activity_id))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"未关联任何活动"})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(hs,{templateId:r}),!n.visible&&e.jsx(F,{variant:"secondary",children:"已隐藏"}),!n.is_active&&e.jsx(F,{variant:"secondary",children:"未激活"}),n.is_active&&e.jsx(F,{children:"已激活"})]})]}),e.jsx(K,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"标题"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"中文："}),n.title_zh]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"English："}),n.title_en]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Português："}),n.title_pt]})]})]}),(n.description_zh||n.description_en||n.description_pt)&&e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"描述"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[n.description_zh&&e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"中文："}),n.description_zh]}),n.description_en&&e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"English："}),n.description_en]}),n.description_pt&&e.jsxs("p",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Português："}),n.description_pt]})]})]})]}),e.jsx(K,{}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"折扣类型"}),e.jsx("p",{className:"font-medium",children:n.discount_type==="percentage"?"百分比折扣":"固定金额"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"折扣值"}),e.jsx("p",{className:"font-medium text-primary text-lg",children:n.discount_type==="percentage"?`${n.discount_value}%`:`€${n.discount_value}`})]}),n.min_order_amount&&n.min_order_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"最低消费"}),e.jsxs("p",{className:"font-medium",children:["€",n.min_order_amount]})]}),n.max_discount_amount&&n.max_discount_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"最高折扣"}),e.jsxs("p",{className:"font-medium",children:["€",n.max_discount_amount]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"已生成"}),e.jsxs("p",{className:"font-medium",children:[J," 张"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"已领取"}),e.jsxs("p",{className:"font-medium",children:[Ve," 次"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"已使用"}),e.jsxs("p",{className:"font-medium",children:[Qe," 次"]})]})]}),e.jsx(K,{}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"有效期"}),e.jsxs("p",{className:"font-medium",children:[T(new Date(n.valid_from),"yyyy-MM-dd"),n.valid_until?` - ${T(new Date(n.valid_until),"yyyy-MM-dd")}`:" - 无限期"]})]})]})})]})]}),e.jsxs(X,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4"}),"已生成的子优惠券 (",J,")"]}),D&&D.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(os,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Te,{placeholder:"搜索优惠券代码或用户名",value:p,onChange:s=>A(s.target.value),className:"pl-9"})]}),e.jsxs(B,{value:l,onValueChange:s=>H(s),children:[e.jsx(I,{children:e.jsx(Q,{placeholder:"状态"})}),e.jsxs(V,{children:[e.jsx(h,{value:"all",children:"全部状态"}),e.jsx(h,{value:"active",children:"已激活"}),e.jsx(h,{value:"inactive",children:"已停用"})]})]}),e.jsxs(B,{value:f,onValueChange:s=>_(s),children:[e.jsx(I,{children:e.jsx(Q,{placeholder:"使用状态"})}),e.jsxs(V,{children:[e.jsx(h,{value:"all",children:"全部"}),e.jsx(h,{value:"unclaimed",children:"未领取"}),e.jsx(h,{value:"claimed",children:"已领取未使用"}),e.jsx(h,{value:"used",children:"已使用"})]})]}),e.jsxs(B,{value:x,onValueChange:s=>M(s),children:[e.jsx(I,{children:e.jsx(Q,{placeholder:"来源"})}),e.jsxs(V,{children:[e.jsx(h,{value:"all",children:"全部来源"}),e.jsx(h,{value:"share",children:"分享"}),e.jsx(h,{value:"other",children:"其他"})]})]})]})]})}),e.jsx(te,{children:Ie?e.jsx("p",{className:"text-sm text-muted-foreground",children:"加载中..."}):!D||D.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"暂无生成的优惠券，用户分享后将自动生成"}):z.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"没有符合筛选条件的优惠券"}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{id:"selectAll",checked:b.size===z.length&&z.length>0,onCheckedChange:Ke}),e.jsx("label",{htmlFor:"selectAll",className:"text-sm cursor-pointer",children:i("admin.couponCode.selectAll")})]}),b.size>0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:i("admin.couponCode.selectedCount",{count:b.size})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[b.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>me(!0),children:i("admin.couponCode.batchEditStatus")}),e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>R(!0),children:i("admin.couponCode.batchDelete")})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[z.length," / ",J]})]})]}),z.map(s=>e.jsxs("div",{className:`rounded-lg border bg-card p-4 ${b.has(s.id)?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{checked:b.has(s.id),onCheckedChange:()=>$e(s.id)}),e.jsx("div",{className:"w-12 h-12 rounded bg-primary/10 flex items-center justify-center",children:e.jsx(ke,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("code",{className:"font-mono font-semibold text-base",children:s.code}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["生成时间：",T(new Date(s.created_at),"yyyy-MM-dd HH:mm")]}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["使用：",s.used_count," / ",s.usage_limit]}),e.jsx(F,{variant:s.is_active?"default":"secondary",children:s.is_active?"激活":"停用"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>E(s),title:"编辑",children:e.jsx(us,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>c(s.id),title:"删除",children:e.jsx(is,{className:"h-4 w-4 text-destructive"})})]})]}),s.user_coupons.length>0?e.jsxs("div",{className:"space-y-2 pt-3 border-t",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:"领取用户"}),s.user_coupons.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-md bg-secondary/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ge,{className:"h-10 w-10",children:[e.jsx(fe,{src:a.profiles.avatar_url||void 0}),e.jsx(_e,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.profiles.display_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["领取时间：",T(new Date(a.claimed_at),"yyyy-MM-dd HH:mm")]}),a.source&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["来源：",a.source==="share"?"分享":a.source]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(F,{variant:a.used_at?"default":"secondary",children:a.used_at?`已使用 ${T(new Date(a.used_at),"MM-dd HH:mm")}`:"未使用"}),a.used_at&&a.used_by_merchant&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ye,{className:"h-3 w-3"}),e.jsxs("span",{children:["核销：",a.used_by_merchant.display_name]}),a.used_at_restaurant&&e.jsxs("span",{className:"text-primary",children:["@ ",C(a.used_at_restaurant,"name")]})]})]})]},a.id))]}):e.jsx("p",{className:"text-sm text-muted-foreground pt-3 border-t",children:"暂无用户领取此优惠券"})]},s.id))]})})]}),e.jsxs(X,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(ms,{className:"h-4 w-4"}),"使用历史记录 (",$?.length||0,")"]})}),e.jsx(te,{children:Be?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"加载中..."}):!$||$.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"暂无使用记录"}):e.jsx("div",{className:"space-y-3",children:$.map(s=>e.jsxs("div",{className:"flex items-start gap-4 p-4 border rounded-lg",children:[e.jsxs(ge,{className:"h-10 w-10",children:[s.used_by_profile?.avatar_url?e.jsx(fe,{src:s.used_by_profile.avatar_url}):null,e.jsx(_e,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium",children:s.used_by_profile?.display_name||"未知用户"}),e.jsx("span",{className:"text-muted-foreground",children:"核销了优惠券"}),s.coupon_code&&e.jsx(F,{variant:"outline",className:"font-mono text-xs",children:s.coupon_code})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground flex-wrap",children:[e.jsx("span",{children:T(new Date(s.used_at),"yyyy-MM-dd HH:mm:ss")}),s.restaurant&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"h-3 w-3"}),C(s.restaurant,"name")]})]}),s.notes&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["备注: ",s.notes]})]})]},s.id))})})]})]})]}),L&&e.jsx(ps,{open:!!L,onOpenChange:s=>!s&&E(null),couponCode:L,onSuccess:()=>{t.invalidateQueries({queryKey:["templateCouponCodes",r]})}}),e.jsx(js,{open:Fe,onOpenChange:me,selectedCodeIds:Array.from(b),onSuccess:Oe}),e.jsx(Ne,{open:!!d,onOpenChange:s=>!s&&c(null),children:e.jsxs(be,{children:[e.jsxs(we,{children:[e.jsx(Ce,{children:"确认删除"}),e.jsx(Se,{children:"确定要删除这个子优惠券吗？此操作将同时删除所有关联的用户领取记录，且无法撤销。"})]}),e.jsxs(De,{children:[e.jsx(Ae,{disabled:S,children:"取消"}),e.jsx(Ee,{onClick:()=>d&&We(d),disabled:S,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:S?"删除中...":"确认删除"})]})]})}),e.jsx(Ne,{open:Me,onOpenChange:R,children:e.jsxs(be,{children:[e.jsxs(we,{children:[e.jsx(Ce,{children:i("admin.couponCode.batchDeleteTitle")}),e.jsx(Se,{children:i("admin.couponCode.batchDeleteDescription",{count:b.size})})]}),e.jsxs(De,{children:[e.jsx(Ae,{disabled:W,children:i("common.cancel")}),e.jsx(Ee,{onClick:Re,disabled:W,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:i(W?"common.deleting":"common.delete")})]})]})})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"优惠券模板不存在"}),e.jsx(N,{onClick:()=>v("/admin/coupons"),children:"返回列表"})]})})};export{Us as default};
//# sourceMappingURL=AdminCouponDetail-fr4Oxql2.js.map
