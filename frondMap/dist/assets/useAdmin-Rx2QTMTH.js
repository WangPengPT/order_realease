import{a as v,u as g,b as _}from"./vendor-query-D82cqPtt.js";import{u as q,s as a,i as p}from"./index-DsNZqemC.js";import{i as o}from"./vendor-i18n-DxKeo2S1.js";const S=async t=>{const{data:n}=await a.from("user_roles").select("role").eq("user_id",t).single();return n?.role},A=()=>{const{user:t}=q();return v({queryKey:["admin-users",t?.id],queryFn:async()=>{if(!t)return[];const[n,s,e,r]=await Promise.all([a.from("profiles").select("*").order("created_at",{ascending:!1}),a.from("user_roles").select("user_id, role"),a.auth.getSession(),a.from("user_roles").select("role").eq("user_id",t.id).single()]);if(n.error)throw n.error;const u=n.data||[],l=s.data||[],m={};l.forEach(f=>{m[f.user_id]=f.role});let d={},i={},c={};if(e.data?.session?.access_token)try{const f=await a.functions.invoke("get-user-emails",{headers:{Authorization:`Bearer ${e.data.session.access_token}`}});f.data?.emails&&(d=f.data.emails),f.data?.createdAt&&(i=f.data.createdAt),f.data?.lastSignIn&&(c=f.data.lastSignIn)}catch(f){console.error("Failed to fetch user data:",f)}const y=u.map(f=>({...f,role:m[f.id]||"user",email:d[f.id]||"",auth_created_at:i[f.id]||f.created_at,last_sign_in_at:c[f.id]||null}));if(r.data?.role==="supervisor"){const{data:f,error:F}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);if(F)throw F;if(!f||f.length===0)return[];const R=f.map(w=>w.restaurant_id),{data:b,error:E}=await a.from("merchant_restaurants").select("user_id, restaurant_id").in("restaurant_id",R);if(E)throw E;if(!b||b.length===0)return[];const C=[...new Set(b.map(w=>w.user_id).filter(w=>w!==t.id))];if(C.length===0)return[];const U=C.filter(w=>m[w]==="merchant");return y.filter(w=>U.includes(w.id))}return y},staleTime:3e4})},Q=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async({userId:s,role:e})=>{const{error:r}=await a.from("user_roles").upsert({user_id:s,role:e},{onConflict:"user_id"});if(r)throw r},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["user-roles"]}),t({title:o.t("common.success"),description:o.t("toast.roleChanged")})},onError:s=>{console.error("Role change error:",s),t({title:o.t("common.error"),description:s.message||o.t("toast.roleChangeFailed"),variant:"destructive"})}})},$=()=>{const{user:t}=q();return v({queryKey:["admin-restaurants",t?.id],queryFn:async()=>{if(!t)return[];if(await S(t.id)==="supervisor"){const{data:e,error:r}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);if(r)throw r;const u=e?.map(d=>d.restaurant_id)||[];if(u.length===0)return[];const{data:l,error:m}=await a.from("restaurants").select("*").in("id",u).order("rating",{ascending:!1});if(m)throw m;return l||[]}else{const{data:e,error:r}=await a.from("restaurants").select("*").order("rating",{ascending:!1});if(r)throw r;return e||[]}},enabled:!!t})},k=()=>v({queryKey:["operation-logs"],queryFn:async()=>{const{data:t,error:n}=await a.from("operation_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(n)throw n;return await Promise.all((t||[]).map(async e=>{const{data:r}=await a.from("profiles").select("display_name").eq("id",e.user_id).single();return{...e,user_name:r?.display_name||"Unknown User"}}))}}),P=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async({userId:s,display_name:e,phone:r,avatar_url:u})=>{const{data:l,error:m}=await a.from("profiles").update({display_name:e,phone:r,avatar_url:u}).eq("id",s).select().single();if(m)throw m;return l},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.profileUpdated")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.profileUpdateFailed"),variant:"destructive"})}})},O=()=>{const{toast:t}=p();return _({mutationFn:async({file:n,userId:s})=>{const e=n.name.split(".").pop(),r=`${Date.now()}.${e}`,u=`${s}/${r}`,{error:l}=await a.storage.from("avatars").upload(u,n,{upsert:!0});if(l)throw l;const{data:{publicUrl:m}}=a.storage.from("avatars").getPublicUrl(u);return m},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.avatarUploadFailed"),variant:"destructive"})}})},x=()=>{const{user:t}=q();return v({queryKey:["admin-stats",t?.id],queryFn:async()=>{if(!t)return{totalUsers:0,totalRestaurants:0,totalActivities:0,totalComments:0};if(await S(t.id)==="supervisor"){const{data:m}=await a.from("merchant_restaurants").select("restaurant_id, user_id").eq("user_id",t.id),d=m?.map(f=>f.restaurant_id)||[],c=(Array.from(new Set(m?.map(f=>f.user_id)))||[]).length,y=d.length;let h=0;if(d.length>0){const{count:f}=await a.from("comments").select("*",{count:"exact",head:!0}).eq("target_type","restaurant").in("target_id",d);h=f||0}return{totalUsers:c,totalRestaurants:y,totalActivities:0,totalComments:h}}const[e,r,u,l]=await Promise.all([a.from("profiles").select("*",{count:"exact",head:!0}),a.from("restaurants").select("*",{count:"exact",head:!0}),a.from("activities").select("*",{count:"exact",head:!0}),a.from("comments").select("*",{count:"exact",head:!0})]);return{totalUsers:e.count||0,totalRestaurants:r.count||0,totalActivities:u.count||0,totalComments:l.count||0}}})},j=()=>{const{user:t}=q();return v({queryKey:["top-restaurants",t?.id],queryFn:async()=>{if(!t)return[];const s=await S(t.id)==="supervisor";let e=a.from("restaurants").select("id, name, rating").order("rating",{ascending:!1,nullsFirst:!1}).limit(10);if(s){const{data:m}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id),d=m?.map(i=>i.restaurant_id)||[];if(d.length===0)return[];e=a.from("restaurants").select("id, name, rating").in("id",d).order("rating",{ascending:!1,nullsFirst:!1}).limit(10)}const{data:r,error:u}=await e;if(u)throw u;return await Promise.all((r||[]).map(async m=>{const{count:d}=await a.from("comments").select("*",{count:"exact",head:!0}).eq("target_id",m.id).eq("target_type","restaurant");return{name:m.name,rating:m.rating||0,comments:d||0}}))}})},z=()=>{const{user:t}=q();return v({queryKey:["restaurant-rating-trends",t?.id],queryFn:async()=>{if(!t)return[];const s=await S(t.id)==="supervisor";let e=[],r={};if(s){const{data:i}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);e=i?.map(c=>c.restaurant_id)||[]}else{const{data:i}=await a.from("restaurants").select("id, name").order("rating",{ascending:!1,nullsFirst:!1}).limit(5);e=i?.map(c=>c.id)||[],i?.forEach(c=>{r[c.id]=c.name})}if(e.length===0)return[];const{data:u}=await a.from("comments").select("target_id, rating_value, created_at").eq("target_type","restaurant").in("target_id",e).not("rating_value","is",null).order("created_at",{ascending:!0});if(!u||u.length===0)return[];if(Object.keys(r).length===0){const{data:i}=await a.from("restaurants").select("id, name").in("id",e);i?.forEach(c=>{r[c.id]=c.name})}const l={};u.forEach(i=>{const c=new Date(i.created_at),y=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;l[i.target_id]||(l[i.target_id]={}),l[i.target_id][y]||(l[i.target_id][y]={sum:0,count:0}),l[i.target_id][y].sum+=i.rating_value,l[i.target_id][y].count+=1});const m=new Set;return Object.values(l).forEach(i=>{Object.keys(i).forEach(c=>m.add(c))}),Array.from(m).sort().map(i=>{const c={month:i};return Object.keys(l).forEach(y=>{const h=l[y][i],f=h?(h.sum/h.count).toFixed(1):null;c[r[y]||y]=f}),c})}})},T=()=>{const{user:t}=q();return v({queryKey:["restaurant-comment-trends",t?.id],queryFn:async()=>{if(!t)return[];const s=await S(t.id)==="supervisor";let e=[],r={};if(s){const{data:i}=await a.from("merchant_restaurants").select("restaurant_id").eq("user_id",t.id);e=i?.map(c=>c.restaurant_id)||[]}else{const{data:i}=await a.from("restaurants").select("id, name").order("rating",{ascending:!1,nullsFirst:!1}).limit(5);e=i?.map(c=>c.id)||[],i?.forEach(c=>{r[c.id]=c.name})}if(e.length===0)return[];const{data:u}=await a.from("comments").select("target_id, created_at").eq("target_type","restaurant").in("target_id",e).order("created_at",{ascending:!0});if(!u||u.length===0)return[];if(Object.keys(r).length===0){const{data:i}=await a.from("restaurants").select("id, name").in("id",e);i?.forEach(c=>{r[c.id]=c.name})}const l={};u.forEach(i=>{const c=new Date(i.created_at),y=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`;l[i.target_id]||(l[i.target_id]={}),l[i.target_id][y]=(l[i.target_id][y]||0)+1});const m=new Set;return Object.values(l).forEach(i=>{Object.keys(i).forEach(c=>m.add(c))}),Array.from(m).sort().map(i=>{const c={month:i};return Object.keys(l).forEach(y=>{const h=l[y][i]||0;c[r[y]||y]=h}),c})}})},B=()=>v({queryKey:["activity-engagement"],queryFn:async()=>{const{data:t,error:n}=await a.from("activities").select("id, title_en").order("created_at",{ascending:!1}).limit(10);if(n)throw n;return await Promise.all((t||[]).map(async e=>{const[r,u]=await Promise.all([a.from("subscriptions").select("*",{count:"exact",head:!0}).eq("activity_id",e.id),a.from("comments").select("*",{count:"exact",head:!0}).eq("target_id",e.id).eq("target_type","activity")]);return{name:e.title_en,subscribers:r.count||0,comments:u.count||0}}))}}),W=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{await a.from("activity_restaurants").delete().eq("activity_id",s);const{error:e}=await a.from("activities").delete().eq("id",s);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["activities"]}),n.invalidateQueries({queryKey:["admin-activities"]}),t({title:o.t("common.success"),description:o.t("toast.activityDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.activityDeleteFailed"),variant:"destructive"})}})},L=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{const{error:e}=await a.from("restaurants").delete().eq("id",s);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.restaurantDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.restaurantDeleteFailed"),variant:"destructive"})}})},N=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{console.log("Calling delete-account edge function for userId:",s);const{data:e,error:r}=await a.functions.invoke("delete-account",{body:{userId:s}});if(console.log("Delete-account response:",{data:e,error:r}),r)throw console.error("Delete-account error:",r),r;if(e?.error)throw console.error("Delete-account data error:",e.error),new Error(e.error);return e},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.userDeleted")})},onError:s=>{console.error("useDeleteUser onError:",s),t({title:o.t("common.error"),description:s?.message||o.t("toast.userDeleteFailed"),variant:"destructive"})}})},Y=()=>{const{toast:t}=p(),n=g(),{user:s}=q();return _({mutationFn:async({userId:e,banReason:r})=>{const{error:u}=await a.from("profiles").update({is_banned:!0,ban_reason:r||null,banned_at:new Date().toISOString(),banned_by:s?.id}).eq("id",e);if(u)throw u},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.userBanned")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userBanFailed"),variant:"destructive"})}})},I=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{const{error:e}=await a.from("profiles").update({is_banned:!1,ban_reason:null,banned_at:null,banned_by:null}).eq("id",s);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["banned-users"]}),t({title:o.t("common.success"),description:o.t("toast.userUnbanned")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userUnbanFailed"),variant:"destructive"})}})},V=()=>{const{toast:t}=p(),n=g(),{user:s}=q();return _({mutationFn:async({userId:e,muteReason:r,mutedUntil:u})=>{const{error:l}=await a.from("profiles").update({is_muted:!0,mute_reason:r||null,muted_at:new Date().toISOString(),muted_by:s?.id,muted_until:u||null}).eq("id",e);if(l)throw l;const{data:m}=await a.from("profiles").select("language_preference").eq("id",e).single(),d=m?.language_preference||"en";let i="";if(u){const h=new Date(u);d==="zh"?i=`禁言至: ${h.toLocaleDateString("zh-CN")}`:d==="pt"?i=`Silenciado até: ${h.toLocaleDateString("pt-PT")}`:i=`Muted until: ${h.toLocaleDateString("en-US")}`}else d==="zh"?i="永久禁言":d==="pt"?i="Silenciamento permanente":i="Permanent mute";let c="",y="";d==="zh"?(c="账号已被禁言",y=`${i}。原因: ${r||"违反社区规则"}`):d==="pt"?(c="Conta silenciada",y=`${i}. Motivo: ${r||"Violação das regras da comunidade"}`):(c="Account muted",y=`${i}. Reason: ${r||"Community guidelines violation"}`),await a.from("notifications").insert({user_id:e,type:"activity_update",title:c,content:y,link:"/profile"})},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["muted-users"]}),t({title:o.t("common.success"),description:o.t("toast.userMuted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userMuteFailed"),variant:"destructive"})}})},G=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{const{data:e}=await a.from("profiles").select("language_preference").eq("id",s).single(),{error:r}=await a.from("profiles").update({is_muted:!1,mute_reason:null,muted_at:null,muted_by:null,muted_until:null}).eq("id",s);if(r)throw r;const u=e?.language_preference||"en";let l="",m="";u==="zh"?(l="禁言已解除",m="您的账号禁言已被解除，现在可以正常发表评论了。"):u==="pt"?(l="Silenciamento removido",m="O silenciamento da sua conta foi removido. Você pode comentar novamente."):(l="Mute lifted",m="Your account mute has been lifted. You can now post comments again."),await a.from("notifications").insert({user_id:s,type:"activity_update",title:l,content:m,link:"/profile"})},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),n.invalidateQueries({queryKey:["muted-users"]}),t({title:o.t("common.success"),description:o.t("toast.userUnmuted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.userUnmuteFailed"),variant:"destructive"})}})},H=()=>v({queryKey:["banned-users"],queryFn:async()=>{const{data:t,error:n}=await a.from("profiles").select("*").eq("is_banned",!0).order("banned_at",{ascending:!1});if(n)throw n;const{data:s}=await a.from("user_roles").select("user_id, role"),e={};return s?.forEach(r=>{e[r.user_id]=r.role}),(t||[]).map(r=>({...r,role:e[r.id]||"user"}))}}),J=()=>v({queryKey:["muted-users"],queryFn:async()=>{const{data:t,error:n}=await a.from("profiles").select("*").eq("is_muted",!0).order("muted_at",{ascending:!1});if(n)throw n;const{data:s}=await a.from("user_roles").select("user_id, role"),e={};return s?.forEach(r=>{e[r.user_id]=r.role}),(t||[]).map(r=>({...r,role:e[r.id]||"user"}))}}),X=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{const e=s.map(async r=>{const{error:u}=await a.functions.invoke("delete-account",{body:{userId:r}});if(u)throw u});await Promise.all(e)},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.usersDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.usersDeleteFailed"),variant:"destructive"})}})},Z=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{const{error:e}=await a.from("restaurants").delete().in("id",s);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.restaurantsDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.restaurantsDeleteFailed"),variant:"destructive"})}})},tt=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async s=>{await a.from("activity_restaurants").delete().in("activity_id",s);const{error:e}=await a.from("activities").delete().in("id",s);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["activities"]}),t({title:o.t("common.success"),description:o.t("toast.activitiesDeleted")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.activitiesDeleteFailed"),variant:"destructive"})}})},et=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async({userIds:s,role:e})=>{const r=s.map(l=>({user_id:l,role:e})),{error:u}=await a.from("user_roles").upsert(r,{onConflict:"user_id"});if(u)throw u},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]}),t({title:o.t("common.success"),description:o.t("toast.rolesChanged")})},onError:s=>{console.error("Batch role change error:",s),t({title:o.t("common.error"),description:s.message||o.t("toast.rolesChangeFailed"),variant:"destructive"})}})},rt=()=>{const{toast:t}=p(),n=g();return _({mutationFn:async({restaurantId:s,visible:e})=>{const{error:r}=await a.from("restaurants").update({visible:e}).eq("id",s);if(r)throw r},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-restaurants"]}),n.invalidateQueries({queryKey:["restaurants"]}),t({title:o.t("common.success"),description:o.t("toast.visibilityUpdated")})},onError:()=>{t({title:o.t("common.error"),description:o.t("toast.visibilityUpdateFailed"),variant:"destructive"})}})},st=()=>v({queryKey:["activity-share-trends"],queryFn:async()=>{const{data:t}=await a.from("activities").select("id, title_zh, title_en, title_pt").eq("visible",!0).limit(10);if(!t||t.length===0)return[];const n=t.map(d=>d.id),s={};t.forEach(d=>{s[d.id]=d.title_zh||d.title_en});const{data:e}=await a.from("activity_shares").select("activity_id, created_at").in("activity_id",n).order("created_at",{ascending:!0});if(!e||e.length===0)return[];const r={};e.forEach(d=>{const i=new Date(d.created_at),c=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`;r[d.activity_id]||(r[d.activity_id]={}),r[d.activity_id][c]=(r[d.activity_id][c]||0)+1});const u=new Set;Object.values(r).forEach(d=>{Object.keys(d).forEach(i=>u.add(i))});const l=Array.from(u).sort(),m=Object.keys(r);return l.map(d=>{const i={month:d};return m.forEach(c=>{const y=r[c][d]||0,h=s[c]?.substring(0,15)||c;i[h]=y}),i})}}),at=()=>v({queryKey:["activity-share-stats"],queryFn:async()=>{const{data:t}=await a.from("activities").select("id, title_zh, title_en, title_pt").eq("visible",!0);return!t||t.length===0?[]:(await Promise.all(t.map(async s=>{const{count:e}=await a.from("activity_shares").select("*",{count:"exact",head:!0}).eq("activity_id",s.id);return{id:s.id,name:(s.title_zh||s.title_en).substring(0,15),shares:e||0}}))).sort((s,e)=>e.shares-s.shares).slice(0,10)}});export{J as A,j as a,B as b,z as c,T as d,st as e,at as f,P as g,O as h,A as i,Q as j,X as k,et as l,N as m,$ as n,L as o,Z as p,rt as q,W as r,tt as s,k as t,x as u,Y as v,I as w,V as x,G as y,H as z};
//# sourceMappingURL=useAdmin-Rx2QTMTH.js.map
