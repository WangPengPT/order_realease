import{j as e,C as Q,d as t,e as U,f as G,g as J,h as ve,u as Ne,i as we,r as o,k as be,I as ye,B as c,l as ke,m as Ce,n as b,X as _,M as Re,P as Se,L as Te,s as ze}from"./index-CJcx5ZXn.js";import{P as K,a as Y,b as Z}from"./popover-BkGkUhvA.js";import{u as Le,a as De,b as Fe,c as Me}from"./useRestaurants-Btrpdsd5.js";import{c as _e,N as E,o as Ae,g as $e}from"./geolocation-BtvYIWp5.js";import{f as Pe,N as Be}from"./timeUtils-CF4ibJXW.js";import{u as Ee,R as Ie,l as Ve}from"./xiaoxiong-logo-clean-qpGS7xFc.js";import{u as We}from"./useLocalizedContent-CRFYWMmp.js";import{u as qe}from"./useActivities-D-YRzY8n.js";import{u as He}from"./useInfiniteScroll-DgRx1fsT.js";import{L as Oe}from"./LocationPermissionDialog-CLaypKBk.js";import{F as Xe}from"./filter-1zRzvkDy.js";import{H as Qe}from"./heart-BHzsmQXG.js";import{S as Ue}from"./star-B60JlfS3.js";import{C as Ge}from"./clock-CziG37Y9.js";import{E as Je}from"./ellipsis-CRdype13.js";import"./mapbox-gl-B4m1T7Sd.js";import"./map-icon-DR07RZr_.js";const Ke=({count:g=6})=>e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:Array.from({length:g}).map((a,u)=>e.jsxs(Q,{className:"overflow-hidden flex flex-col h-full",style:{animationDelay:`${u*100}ms`},children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx(t,{className:"w-full h-full rounded-none"}),e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx(t,{className:"h-9 w-9 rounded-md"})})]}),e.jsx(U,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(t,{className:"h-6 w-40"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(t,{className:"h-4 w-4 rounded-full"}),e.jsx(t,{className:"h-4 w-16"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(t,{className:"h-5 w-5 rounded-full"}),e.jsx(t,{className:"h-5 w-8"})]})]})}),e.jsxs(G,{className:"space-y-3 flex-grow",children:[e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(t,{className:"h-5 w-16 rounded-full"}),e.jsx(t,{className:"h-5 w-20 rounded-full"}),e.jsx(t,{className:"h-5 w-14 rounded-full"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(t,{className:"h-4 w-full"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(t,{className:"h-4 w-32"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(t,{className:"h-4 w-40"})]})]}),e.jsxs(J,{className:"gap-2 mt-auto",children:[e.jsx(t,{className:"h-10 flex-1 rounded-md"}),e.jsx(t,{className:"h-10 w-10 rounded-md"})]})]},u))}),Ye=()=>e.jsxs("div",{className:"relative flex-1 min-h-[300px] sm:min-h-[400px] lg:mx-4 lg:mb-4 lg:rounded-lg overflow-hidden lg:shadow-lg bg-muted",children:[e.jsx(t,{className:"absolute inset-0 w-full h-full rounded-none"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2",children:e.jsx(t,{className:"h-8 w-8 rounded-full"})}),e.jsx("div",{className:"absolute top-1/4 left-1/3",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute top-1/3 right-1/4",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute bottom-1/3 left-1/4",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute bottom-1/4 right-1/3",children:e.jsx(t,{className:"h-6 w-6 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-4 left-4 z-10",children:e.jsx(t,{className:"h-10 w-36 rounded-full"})}),e.jsxs("div",{className:"absolute top-4 right-4 z-10 flex flex-col gap-2",children:[e.jsx(t,{className:"h-8 w-8 rounded-md"}),e.jsx(t,{className:"h-8 w-8 rounded-md"})]})]}),Ze=({restaurant:g,language:a})=>{const[u,y]=o.useState(999),k=o.useRef(null),C=g.type.map((l,R)=>({key:`type-${R}`,label:l,variant:"secondary",color:void 0}));o.useEffect(()=>{const l=()=>{var T;if(!k.current)return;const f=k.current,n=Array.from(f.querySelectorAll(".tag-badge"));if(n.length===0){setTimeout(l,50);return}const L=(T=n[0])==null?void 0:T.offsetTop;let i=n.length;for(let x=0;x<n.length;x++)if(n[x].offsetTop>L){i=x;break}if(i===n.length){y(n.length);return}const S=f.offsetWidth,h=40;let D=0,v=i;for(let x=0;x<i;x++)D+=n[x].offsetWidth+8;D+h>S&&(v=Math.max(1,i-1)),y(v)};y(999);const R=setTimeout(l,100);return window.addEventListener("resize",l),()=>{clearTimeout(R),window.removeEventListener("resize",l)}},[C.length,g.id]);const d=C.slice(0,u),j=C.slice(u),m=j.length>0;return e.jsxs("div",{className:"flex items-center gap-2 -mt-1",children:[e.jsx("div",{ref:k,className:"flex gap-2 flex-wrap flex-1",children:d.map(l=>e.jsx(b,{variant:l.variant,className:"text-xs whitespace-nowrap tag-badge",style:l.color?{backgroundColor:l.color,color:"white"}:void 0,children:l.label},l.key))}),m&&e.jsxs(K,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-muted-foreground hover:text-foreground flex-shrink-0",children:e.jsx(Je,{className:"h-4 w-4"})})}),e.jsx(Z,{className:"w-auto max-w-80",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:j.map(l=>e.jsx(b,{variant:l.variant,className:"text-xs",style:l.color?{backgroundColor:l.color,color:"white"}:void 0,children:l.label},l.key))})})]})]})},gs=()=>{const g=ve(),{t:a,i18n:u}=Ne(),{toast:y}=we(),{localizeRestaurant:k}=We(),[z,C]=o.useState(""),[d,j]=o.useState([]),[m,l]=o.useState(null),[R,f]=o.useState([]),[n,L]=o.useState("list"),[i,S]=o.useState(null),[h,D]=o.useState(null),[v,T]=o.useState(!1),[x,ee]=o.useState(!1),[A,se]=o.useState(!1),[ae,$]=o.useState(!1),[te,P]=o.useState(!1),[p,le]=o.useState(null),{user:I}=be(),{data:F,isLoading:ne}=Le(z,d.length>0?d.join(","):void 0),{data:re=[]}=De(),{data:B=[]}=Fe(),{data:ie=[]}=qe(),{data:oe={}}=Ee(),M=ie.filter(s=>(oe[s.id]||0)>0),ce=Me(),de=(s,r)=>{r.preventDefault(),r.stopPropagation(),I&&ce.mutate(s)},me=s=>{j(r=>r.includes(s)?r.filter(w=>w!==s):[...r,s])},xe=()=>{P(!0)},V=async()=>{P(!1);try{const s=await $e();D({lat:s.coords.latitude,lng:s.coords.longitude}),T(!0),y({title:a("restaurants.locationEnabled"),description:a("restaurants.sortByDistance")})}catch(s){console.error("Location error:",s)}},he=s=>{S(s),s&&!h&&V()},ue=async s=>{if(m===s)l(null),f([]);else{l(s);const{data:r,error:w}=await ze.from("activity_restaurants").select("restaurant_id").eq("activity_id",s);w?(console.error("Error fetching activity restaurants:",w),f([])):f(r.map(je=>je.restaurant_id))}},W=(F==null?void 0:F.map(s=>{const r=k(s);if(h){const w=_e(h.lat,h.lng,s.lat,s.lng);return{...r,distance:w}}return r}))||[],q=m?W.filter(s=>R.includes(s.id)):W,H=i&&h?q.filter(s=>s.distance&&s.distance<=i):q,N=h?[...H].sort((s,r)=>(s.distance||0)-(r.distance||0)):[...H].sort((s,r)=>(r.rating||0)-(s.rating||0)),{displayedData:O,hasMore:fe,loadMore:pe,reset:X}=He({data:N,initialItemsPerPage:12,incrementPerPage:12});o.useEffect(()=>{X()},[z,d,m,i,v,X]);const ge=s=>{g(`/restaurant/${s.id}`)};return e.jsx("div",{className:`bg-secondary/20 animate-fade-in ${n==="map"?"h-screen flex flex-col overflow-hidden":"min-h-screen py-8 px-4"}`,children:e.jsxs("div",{className:`${n==="map"?"flex flex-col h-full":"container mx-auto max-w-7xl"}`,children:[e.jsxs("div",{className:`${n==="map"?"px-4 pt-4 pb-2 flex-shrink-0":"mb-8"}`,children:[e.jsx("h1",{className:`text-4xl font-bold text-primary ${n==="map"?"hidden md:block md:mb-4":"mb-4"}`,children:a("restaurants.title")}),e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 md:items-center",children:[e.jsx(ye,{placeholder:a("restaurants.search"),value:z,onChange:s=>C(s.target.value),className:"w-full md:max-w-md"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(c,{variant:n==="list"?"default":"outline",size:"icon",onClick:()=>L("list"),title:a("restaurants.listView"),className:"flex-shrink-0",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx(c,{variant:n==="map"?"default":"outline",size:"icon",onClick:()=>L("map"),title:a("restaurants.mapView"),className:"flex-shrink-0",children:e.jsx(Ce,{className:"w-4 h-4"})}),e.jsxs(K,{children:[e.jsx(Y,{asChild:!0,children:e.jsxs(c,{variant:d.length>0||m||i?"default":"outline",size:"icon",className:"flex-shrink-0 relative",title:a("restaurants.filter"),children:[e.jsx(Xe,{className:"w-4 h-4"}),(d.length>0||m||i)&&e.jsx(b,{variant:"secondary",className:"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:(d.length>0?1:0)+(m?1:0)+(i?1:0)})]})}),e.jsx(Z,{className:"w-[90vw] max-w-sm p-0",align:"start",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border/50 bg-muted/30",children:[e.jsx("span",{className:"font-semibold text-foreground text-base",children:a("restaurants.filter")}),(d.length>0||m||i)&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{j([]),l(null),f([]),S(null)},children:[e.jsx(_,{className:"w-3 h-3 mr-1"}),a("common.actions.clearFilter")]})]}),e.jsxs("div",{className:"p-4 space-y-5",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("restaurants.restaurantTypes")}),e.jsxs("div",{className:"flex items-center gap-2",children:[d.length>0&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>j([]),children:[e.jsx(_,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]}),B.length>8&&e.jsx(c,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-primary hover:text-primary/80",onClick:()=>ee(!x),children:a(x?"common.showLess":"common.showMore")})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap max-h-36 overflow-y-auto pr-1",children:(x?B:B.slice(0,8)).map(s=>e.jsx(b,{variant:d.includes(s)?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${d.includes(s)?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>me(s),children:s},s))})]}),M.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("nav.activities")}),e.jsxs("div",{className:"flex items-center gap-2",children:[m&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{l(null),f([])},children:[e.jsx(_,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]}),M.length>8&&e.jsx(c,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-primary hover:text-primary/80",onClick:()=>se(!A),children:a(A?"common.showLess":"common.showMore")})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap max-h-36 overflow-y-auto pr-1",children:(A?M:M.slice(0,8)).map(s=>{const r=u.language==="zh"?s.badge_text_zh||s.title_zh:u.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(b,{variant:m===s.id?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${m===s.id?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>ue(s.id),children:r},s.id)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("restaurants.radius")}),i&&e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>S(null),children:[e.jsx(_,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[{value:null,label:a("restaurants.allRestaurants")},{value:5,label:a("restaurants.radius5km")},{value:10,label:a("restaurants.radius10km")},{value:20,label:a("restaurants.radius20km")}].map(s=>e.jsx(b,{variant:i===s.value?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${i===s.value?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>he(s.value),children:s.label},s.value??"all"))})]})]})]})})]}),h?e.jsx(c,{variant:v?"default":"outline",onClick:()=>T(!v),className:"flex-1 md:flex-initial whitespace-nowrap",children:a("restaurants.sortByDistance")}):e.jsxs(c,{variant:"outline",onClick:xe,className:"flex-1 md:flex-initial",children:[e.jsx(E,{className:"w-4 h-4 mr-2 flex-shrink-0"}),e.jsx("span",{className:"md:hidden whitespace-nowrap text-sm",children:a("restaurants.getLocationMobile")}),e.jsx("span",{className:"hidden md:inline whitespace-nowrap",children:a("restaurants.getLocation")})]})]})]})})]}),ne||!F?n==="map"?e.jsx(Ye,{}):e.jsx(Ke,{count:6}):N.length===0?e.jsxs("div",{className:`text-center ${n==="map"?"flex-1 flex flex-col justify-center px-4":"py-20"}`,children:[e.jsx("p",{className:"text-xl text-muted-foreground",children:a("restaurants.noResults")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:a("restaurants.noResultsDesc")})]}):e.jsxs(e.Fragment,{children:[n==="map"&&N.length>0&&e.jsxs("div",{className:"relative flex-1 min-h-[300px] sm:min-h-[400px] lg:mx-4 lg:mb-4 lg:rounded-lg overflow-hidden lg:shadow-lg",children:[e.jsx(Ie,{restaurants:N,onRestaurantClick:ge,userLocation:h,radiusFilter:i,showViewDetailsButton:!0}),e.jsxs("div",{className:"absolute bottom-4 left-4 z-10 pointer-events-none flex items-center gap-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg",children:[e.jsx("img",{src:Ve,alt:"Xiaoxiong Market Logo",className:"h-6 w-6 object-contain"}),e.jsx("span",{className:"text-sm font-semibold text-foreground whitespace-nowrap",children:u.language==="zh"?"小熊市场":"Xiaoxiong Market"})]})]}),n==="list"&&N.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:O.map(s=>e.jsxs(Q,{className:"overflow-hidden hover:shadow-large transition-shadow flex flex-col h-full",children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx("img",{src:s.image_url||"https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600&q=80",alt:s.name,className:"w-full h-full object-cover transition-transform hover:scale-105"}),I&&e.jsx(c,{size:"icon",variant:"secondary",className:"absolute top-3 right-3",onClick:r=>de(s.id,r),children:e.jsx(Qe,{className:`w-5 h-5 ${re.includes(s.id)?"fill-destructive text-destructive":""}`})})]}),e.jsx(U,{className:"mb-px pb-[15px]",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-card-foreground",children:s.name}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(E,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"font-semibold text-sm text-foreground",children:[s.distance.toFixed(1)," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ue,{className:`w-5 h-5 ${s.rating?"fill-accent text-accent":"text-muted-foreground"}`}),s.rating?e.jsx("span",{className:"font-semibold text-card-foreground",children:s.rating.toFixed(1)}):e.jsxs("span",{className:"text-xs text-muted-foreground text-center whitespace-nowrap",children:[a("restaurant.noRatingLine1"),e.jsx("br",{}),a("restaurant.noRatingLine2")]})]})]})}),e.jsxs(G,{className:"space-y-2 flex-grow",children:[e.jsx(Ze,{restaurant:s,language:u.language}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Re,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-1",children:s.address})]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Se,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.phone})]}),s.opening_hours&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Ge,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:Pe(s.opening_hours)})]})]}),e.jsxs(J,{className:"gap-2 mt-auto",children:[e.jsx(c,{asChild:!0,className:"flex-1",children:e.jsx(Te,{to:`/restaurant/${s.id}`,children:a("restaurants.viewDetails")})}),h&&e.jsx(c,{variant:"outline",size:"icon",onClick:()=>{le({lat:s.lat,lng:s.lng,name:s.name}),$(!0)},title:a("restaurants.directions"),children:e.jsx(E,{className:"w-4 h-4"})})]})]},s.id))}),fe&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsxs(c,{onClick:pe,size:"lg",variant:"outline",children:[a("common.loadMore")," (",O.length," / ",N.length,")"]})})]})]}),e.jsx(Be,{open:ae,onOpenChange:$,onConfirm:()=>{p&&Ae(p.lat,p.lng,p.name),$(!1)},destinationName:(p==null?void 0:p.name)||""}),e.jsx(Oe,{open:te,onOpenChange:P,onConfirm:V})]})})};export{gs as default};
