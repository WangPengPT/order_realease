import{p as ee,u as Ve,r as l,j as e,be as de,bf as Be,c$ as Qe,bl as Xe,L as ne,b0 as Je,bd as Ke,aw as J,ay as K,ej as Ce,bb as ae,aY as re,bu as le,ci as Ze,X as es,bk as ss,W as ts,w as ns,s as as,bD as rs,cB as De,bG as Ae,a_ as Le,bm as Me,dO as ze,el as ie,b8 as ke}from"./vendor-react-87iFmKFJ.js";import{C as Se,a as Te,b as Ee}from"./carousel-DS7H_fh7.js";import{u as ls,C as Q,m as me,V as ue,W as xe,X as he,B as _,O as is,P as cs,h as E,Q as os,R as Ie,n as Z,p as ds,A as ms,q as us,r as xs,t as hs,v as gs,w as fs,x as ps,y as js,a as Ns,s as bs}from"./index-CH4FpCej.js";import{a as ws,f as vs,b as ys}from"./useCommunityPosts-Hwex2FMK.js";import{u as ge}from"./useLocalizedContent-CFh79NZC.js";import{T as fe}from"./TranslateButton-n7ikl_oX.js";import{u as _s}from"./ShareDrawer-BdsC_cKT.js";import{E as Cs,a as ks}from"./EditRecipeDialog-BvttCogK.js";import{u as Ss}from"./useLoginRequired-NoLR-dKx.js";import{H as pe,p as je,I as Ne,J as be}from"./vendor-utils-vwQGbBim.js";import{S as ce}from"./separator-2WV3a7KV.js";import{I as Re}from"./ImagePreviewModal-BqCHox3o.js";import{E as Ts}from"./ExternalLinkConfirmDialog-C5LyO7qi.js";import{R as Es}from"./RecipeCookingMode-Brf7h4xI.js";const Qs=({post:s,showActions:j=!0,isDetailPage:t=!1})=>{const{t:i,i18n:I}=ee(),{user:b}=ls(),h=Ve(),{requireLogin:R}=Ss(),{getLocalizedField:w}=ge(),P=ws(),d=vs(),C=ys(),[D,p]=l.useState(!1),[$,k]=l.useState(!1),[O,v]=l.useState({}),[S,z]=l.useState(!1),[A,g]=l.useState(0),[y,L]=l.useState(),[U,H]=l.useState(),[W,G]=l.useState(0),[Y,q]=l.useState(null);l.useState(null),l.useState(!1),l.useState(0),l.useState(!1);const[c,n]=l.useState({}),[r,o]=l.useState(null),[x,N]=l.useState(!1),{share:M,DrawerComponent:V}=_s();l.useEffect(()=>{if(S){const a=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${a}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.overflow="",window.scrollTo(0,a)}}},[S]),l.useEffect(()=>{y&&(G(y.selectedScrollSnap()),y.on("select",()=>{G(y.selectedScrollSnap())}))},[y]);const $e=()=>{switch(I.language){case"zh":return be;case"pt":return Ne;default:return je}},Pe=()=>{R()&&P.mutate({postId:s.id,liked:s.user_liked||!1})},Oe=async()=>{const a=`${window.location.origin}/community/${s.id}`;M({title:i("community.shareTitle","分享帖子"),text:s.content.replace(/<[^>]*>/g,"").substring(0,100),url:a},()=>{b&&d.mutate(s.id),ns.success(i("community.shareSuccess","分享成功"))})},Fe=()=>{C.mutate(s.id),p(!1)},we=a=>{t?(g(a),z(!0)):h(`/community/${s.id}`)},X=(a,m)=>{const f=a.currentTarget;n(T=>({...T,[m]:{width:f.naturalWidth,height:f.naturalHeight}}))},ve=a=>{const m=c[a];return m?m.height/m.width>1.5:!1},ye=b?.id===s.author_id,Ue=s.activity?w(s.activity,"title"):null,B=[...s.restaurants||[],...s.restaurant&&!s.restaurants?.find(a=>a.id===s.restaurant?.id)?[s.restaurant]:[]],se=t?3:2,We=x?B:B.slice(0,se),_e=B.length>se,Ge=w(s,"content"),He=I.language==="zh"&&s.content_zh||I.language==="en"&&s.content_en||I.language==="pt"&&s.content_pt,Ye=(Y||Ge||s.content)?.replace(/\n/g,"<br>")||"";return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{className:"overflow-hidden",children:[e.jsx(me,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ue,{className:"h-10 w-10 cursor-pointer hover:ring-2 hover:ring-primary/50 transition-all",onClick:()=>s.author?.id&&h(`/user/${s.author.id}`),children:[e.jsx(xe,{src:s.author?.avatar_url||void 0}),e.jsx(he,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm cursor-pointer hover:underline",onClick:()=>s.author?.id&&h(`/user/${s.author.id}`),children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:pe(new Date(s.created_at),{addSuffix:!0,locale:$e()})}),ye&&s.status==="pending"&&e.jsxs(_,{variant:"outline",className:"text-amber-600 border-amber-500 bg-amber-50 dark:bg-amber-950/30 text-xs mt-0.5",children:[e.jsx(de,{className:"w-3 h-3 mr-1"}),i("community.pendingReview","审核中")]})]})]}),j&&ye&&e.jsxs(is,{children:[e.jsx(cs,{asChild:!0,children:e.jsx(E,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(Be,{className:"h-4 w-4"})})}),e.jsxs(os,{align:"end",children:[e.jsxs(Ie,{onClick:()=>k(!0),children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),i("common.edit","编辑")]}),e.jsx(Ie,{onClick:()=>p(!0),className:"text-destructive",children:i("common.delete","删除")})]})]})]})}),e.jsxs(Z,{className:"pt-0 pb-3",children:[(s.activity||B.length>0||s.ai_recipe_source)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3 items-center",children:[s.ai_recipe_source&&e.jsxs(_,{variant:"secondary",className:"gap-1 bg-primary/10 text-primary",children:[e.jsx(Xe,{className:"h-3 w-3"}),i("aiRecipe.badge","AI 食谱")]}),s.activity&&e.jsx(ne,{to:`/activity/${s.activity.id}`,children:e.jsxs(_,{variant:"secondary",className:"gap-1",children:[e.jsx(Je,{className:"h-3 w-3"}),Ue]})}),We.map(a=>e.jsx(ne,{to:`/restaurant/${a.id}`,children:e.jsxs(_,{variant:"secondary",className:"gap-1",children:[e.jsx(Ke,{className:"h-3 w-3"}),w(a,"name")]})},a.id)),_e&&!x&&e.jsxs("button",{onClick:()=>N(!0),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-0.5",children:["+",B.length-se," ",i("community.more","更多"),e.jsx(J,{className:"h-3 w-3"})]}),x&&_e&&e.jsxs("button",{onClick:()=>N(!1),className:"text-xs text-muted-foreground hover:text-foreground flex items-center gap-0.5",children:[i("community.collapse","收起"),e.jsx(K,{className:"h-3 w-3"})]})]}),e.jsx(ne,{to:`/community/${s.id}`,children:e.jsx("div",{className:`prose prose-sm max-w-none dark:prose-invert ${t?"":"line-clamp-6"}`,dangerouslySetInnerHTML:{__html:Ye}})}),!He&&e.jsx(fe,{text:s.content,onTranslation:q,className:"mt-1"}),(()=>{const a=t&&s.video_url?(s.image_urls||[]).filter(m=>!m.includes("-cover")):s.image_urls;return!a||a.length===0?null:e.jsx("div",{className:"relative mt-3",children:a.length===1?(()=>{const m=a[0],f=ve(m);return e.jsx("div",{className:"relative overflow-hidden rounded-lg cursor-pointer max-h-[300px] sm:max-h-[400px]",onClick:()=>we(0),children:O[m]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:i("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:m,alt:"",className:"w-full max-h-[300px] sm:max-h-[400px] object-cover object-top",onLoad:T=>X(T,m),onError:()=>v(T=>({...T,[m]:!0}))}),f&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx(Ce,{className:"h-3 w-3"}),e.jsx("span",{children:i("community.longImage","长图")})]})]})})})():e.jsxs(e.Fragment,{children:[e.jsx(Se,{setApi:L,className:"w-full",opts:{loop:!0},children:e.jsx(Te,{className:"-ml-0",children:a.map((m,f)=>{const T=ve(m);return e.jsx(Ee,{className:"pl-0",children:e.jsx("div",{className:"relative overflow-hidden rounded-lg cursor-pointer aspect-[4/3] bg-muted",onClick:()=>we(f),children:O[m]?e.jsx("div",{className:"w-full h-full min-h-[200px] bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:i("common.imageLoadError","图片加载失败")})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:m,alt:"",className:"w-full h-full object-contain",onLoad:u=>X(u,m),onError:()=>v(u=>({...u,[m]:!0}))}),T&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full flex items-center gap-1",children:[e.jsx(Ce,{className:"h-3 w-3"}),e.jsx("span",{children:i("community.longImage","长图")})]})]})})},f)})})}),e.jsxs("div",{className:"absolute top-3 right-3 bg-black/60 text-white text-xs px-2 py-1 rounded-full z-10",children:[W+1,"/",a.length]}),e.jsx("div",{className:"flex justify-center gap-1.5 mt-2",children:a.map((m,f)=>e.jsx("button",{className:`w-1.5 h-1.5 rounded-full transition-colors ${f===W?"bg-primary":"bg-muted-foreground/30"}`,onClick:T=>{T.stopPropagation(),y?.scrollTo(f)}},f))})]})})})(),s.video_url&&e.jsx("div",{className:"mt-3 rounded-lg overflow-hidden bg-gray-900",children:e.jsx("video",{src:s.video_url,...s.image_urls?.length?{poster:s.image_urls[0]}:{},controls:!0,className:"w-full max-h-96",preload:"metadata",playsInline:!0})})]}),e.jsx(ds,{className:"pt-0 border-t",children:e.jsxs("div",{className:"flex items-center gap-4 pt-3 w-full",children:[e.jsxs(E,{variant:"ghost",size:"sm",className:`gap-2 ${s.user_liked?"text-red-500":""}`,onClick:Pe,disabled:!b,children:[e.jsx(ae,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count})]}),e.jsxs(E,{variant:"ghost",size:"sm",className:"gap-2",onClick:()=>{R()&&h(`/community/${s.id}`)},children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{children:s.comments_count})]}),e.jsxs(E,{variant:"ghost",size:"sm",className:"gap-2",onClick:Oe,children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{children:s.shares_count})]})]})})]}),e.jsx(ms,{open:D,onOpenChange:p,children:e.jsxs(us,{children:[e.jsxs(xs,{children:[e.jsx(hs,{children:i("common.confirmDelete","确认删除")}),e.jsx(gs,{children:i("community.deleteWarning","删除后无法恢复，确定要删除这篇帖子吗？")})]}),e.jsxs(fs,{children:[e.jsx(ps,{children:i("common.cancel","取消")}),e.jsx(js,{onClick:Fe,children:i("common.delete","删除")})]})]})}),s.post_type==="recipe"?e.jsx(Cs,{post:s,open:$,onOpenChange:k}):e.jsx(ks,{post:s,open:$,onOpenChange:k}),S&&Ze.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black overflow-hidden",onClick:a=>{a.target===a.currentTarget&&z(!1)},onWheel:a=>a.stopPropagation(),onTouchMove:a=>a.stopPropagation(),children:[s.image_urls&&s.image_urls.length>1&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-10 text-white text-sm bg-black/50 px-4 py-1.5 rounded-full",children:[A+1," / ",s.image_urls.length]}),e.jsx(E,{variant:"ghost",size:"icon",className:"absolute top-4 right-4 z-10 text-white hover:bg-white/20",onClick:()=>z(!1),children:e.jsx(es,{className:"h-6 w-6"})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Se,{className:"w-full",opts:{loop:!0,startIndex:A},setApi:a=>{H(a),a&&a.on("select",()=>{g(a.selectedScrollSnap())})},children:e.jsx(Te,{className:"-ml-0",children:s.image_urls?.map((a,m)=>{const f=c[a],T=f?f.height/f.width>1.5:!1;return e.jsx(Ee,{className:"pl-0 flex items-center justify-center",children:T?e.jsx("div",{className:"w-full h-screen overflow-x-hidden overflow-y-scroll overscroll-contain",onMouseDown:u=>{const F=u.currentTarget;o({y:u.clientY,scrollTop:F.scrollTop})},onMouseUp:u=>{if(r){const F=Math.abs(u.clientY-r.y),te=Math.abs(u.currentTarget.scrollTop-r.scrollTop);F<10&&te<10&&z(!1),o(null)}},onTouchStart:u=>{const F=u.currentTarget;o({y:u.touches[0].clientY,scrollTop:F.scrollTop})},onTouchEnd:u=>{if(r){const F=u.changedTouches[0],te=Math.abs(F.clientY-r.y),qe=Math.abs(u.currentTarget.scrollTop-r.scrollTop);te<15&&qe<15&&(u.preventDefault(),z(!1)),o(null)}},children:e.jsx("img",{src:a,alt:"",className:"block select-none",style:{width:"100vw",minHeight:"100dvh",height:"auto",margin:0},draggable:!1,onLoad:u=>X(u,a)})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("img",{src:a,alt:"",className:"object-contain w-screen h-screen select-none cursor-pointer",draggable:!1,onClick:()=>z(!1),onLoad:u=>X(u,a)})})},m)})})})}),s.image_urls&&s.image_urls.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",size:"icon",className:"absolute left-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>U?.scrollPrev(),children:e.jsx(ss,{className:"h-8 w-8"})}),e.jsx(E,{variant:"ghost",size:"icon",className:"absolute right-4 top-1/2 -translate-y-1/2 z-10 text-white hover:bg-white/20 h-12 w-12 hidden sm:flex",onClick:()=>U?.scrollNext(),children:e.jsx(ts,{className:"h-8 w-8"})})]})]}),document.body),V]})},Is=()=>bs.from("ads"),oe=()=>{const{t:s}=ee(),j=Ns(),[t,i]=l.useState(null),[I,b]=l.useState(null),{data:h}=as({queryKey:["active-ads"],queryFn:async()=>{const d=new Date().toISOString(),{data:C,error:D}=await Is().select("*").eq("is_active",!0).or(`start_date.is.null,start_date.lte.${d}`).or(`end_date.is.null,end_date.gte.${d}`).order("sort_order",{ascending:!0});if(D)throw D;return C},staleTime:5*60*1e3});if(!h||h.length===0)return null;const R=d=>{d.link_url&&(i(d.link_url),b(d.name))},w=()=>{t&&(window.open(t,"_blank","noopener,noreferrer"),i(null),b(null))},P=d=>j?d.mobile_image_url||d.desktop_image_url||d.image_url:d.desktop_image_url||d.mobile_image_url||d.image_url;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2 mt-3",children:h.map(d=>{const C=P(d);return e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-border/50 hover:border-primary/30 transition-colors cursor-pointer",style:{aspectRatio:j?"375/112":"672/112"},onClick:()=>R(d),children:[e.jsx(_,{className:"absolute top-1.5 left-1.5 z-10 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded hover:bg-black/60",children:s("common.ad","广告")}),C?e.jsx("img",{src:C,alt:d.name,className:"w-full h-full object-cover"}):e.jsxs("div",{className:"flex items-center gap-2 px-3 bg-muted/50 text-sm text-muted-foreground w-full h-full justify-center",children:[e.jsx(rs,{className:"h-3.5 w-3.5 shrink-0"}),e.jsx("span",{className:"truncate",children:d.name})]})]},d.id)})}),e.jsx(Ts,{open:!!t,onOpenChange:d=>{d||(i(null),b(null))},onConfirm:w,url:t||void 0,title:s("common.adLinkTitle","外部链接"),description:s("common.adLinkDescription","您即将离开本站，前往广告链接「{{name}}」的外部页面",{name:I||""}),confirmLabel:s("common.adLinkContinue","继续前往")})]})},Ds=s=>{const j=s.match(/^\[\[NOTE\]\]([\s\S]*?)(?:\n\[\[INTRO\]\]|$)/),t=s.match(/\[\[INTRO\]\]([\s\S]*)$/);return j?{note:j[1].trim(),intro:t?t[1].trim():""}:{note:"",intro:s}},As=({post:s,onStartCooking:j})=>{const{t,i18n:i}=ee(),{getLocalizedField:I}=ge(),[b,h]=l.useState(null),[R,w]=l.useState(null),[P,d]=l.useState({}),[C,D]=l.useState(null),[p,$]=l.useState(!1),[k,O]=l.useState(!1),v=200,S=5,A=R||(()=>{const n={zh:"content_zh",en:"content_en",pt:"content_pt"}[i.language]||"content",r=s[n];return r&&typeof r=="string"&&r.trim()?r:s.content})(),g=l.useMemo(()=>Ds(A||""),[A]),y=b||I(s,"recipe_name")||s.recipe_name,L=()=>{const c=[];if(s.recipe_name&&c.push(`[NAME]${s.recipe_name}`),s.content&&s.content.trim()&&!s.content.includes("主要配料：")&&c.push(`[CONTENT]${s.content}`),s.ingredients&&s.ingredients.length>0){const n=s.ingredients.map(r=>r.name).join("|");c.push(`[INGREDIENTS]${n}`)}return c.join(`
---
`)},U=c=>{if(!c){h(null),w(null),d({});return}c.split(`
---
`).forEach(r=>{if(r.startsWith("[NAME]"))h(r.replace("[NAME]",""));else if(r.startsWith("[CONTENT]"))w(r.replace("[CONTENT]",""));else if(r.startsWith("[INGREDIENTS]")){const o=r.replace("[INGREDIENTS]","").split("|"),x={};o.forEach((N,M)=>{x[M]=N.trim()}),d(x)}})},H=()=>{switch(i.language){case"zh":return be;case"pt":return Ne;default:return je}},W=c=>{switch(c){case"easy":return"bg-green-500/20 text-green-700 dark:text-green-400 border-green-500/30";case"medium":return"bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 border-yellow-500/30";case"hard":return"bg-red-500/20 text-red-700 dark:text-red-400 border-red-500/30";default:return"bg-muted text-muted-foreground"}},G=c=>{switch(c){case"easy":return t("recipe.difficulty.easy","简单");case"medium":return t("recipe.difficulty.medium","中等");case"hard":return t("recipe.difficulty.hard","困难");default:return c}},Y=s.image_urls&&s.image_urls.length>0,q=s.steps&&s.steps.length>0;return e.jsxs(Q,{className:"overflow-hidden",children:[Y&&e.jsxs("div",{className:"relative aspect-video overflow-hidden",children:[e.jsx("img",{src:s.image_urls[0],alt:y||"",className:"w-full h-full object-cover cursor-pointer",onClick:()=>D(s.image_urls[0])}),e.jsxs(_,{className:"absolute top-3 left-3 bg-primary text-primary-foreground gap-1",children:[e.jsx(De,{className:"h-3 w-3"}),t("recipe.badge","食谱")]})]}),e.jsxs(me,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsxs(ue,{className:"h-10 w-10",children:[e.jsx(xe,{src:s.author?.avatar_url||void 0}),e.jsx(he,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:pe(new Date(s.created_at),{addSuffix:!0,locale:H()})})]})]}),e.jsx("div",{className:"mb-2",children:e.jsx(fe,{text:L(),onTranslation:U,label:t("recipe.translateAll")})}),e.jsx("h2",{className:"text-xl font-bold",children:y}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-3",children:[s.cook_time&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.cook_time," ",t("recipe.minutes","分钟")]})]}),s.servings&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.servings," ",t("recipe.servings","人份")]})]}),s.difficulty&&e.jsxs(_,{variant:"outline",className:W(s.difficulty),children:[e.jsx(Le,{className:"h-3 w-3 mr-1"}),G(s.difficulty)]})]})]}),e.jsxs(Z,{className:"space-y-6",children:[s.content&&s.content.trim()&&!s.content.includes("主要配料：")&&e.jsxs("div",{className:"space-y-3",children:[g.note&&e.jsxs("div",{className:"rounded-lg border border-primary/20 bg-primary/5 px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1.5",children:[e.jsx(Me,{className:"h-3.5 w-3.5 text-primary"}),e.jsx("span",{className:"text-xs font-medium text-primary",children:t("recipe.cookingNote","心得")})]}),e.jsx("p",{className:"text-sm text-foreground/80 italic leading-relaxed whitespace-pre-line",children:g.note})]}),g.intro&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line leading-relaxed",children:p||g.intro.length<=v?g.intro:g.intro.slice(0,v)+"..."}),g.intro.length>v&&e.jsxs(E,{variant:"ghost",size:"sm",className:"px-0 h-auto py-1 text-xs text-primary",onClick:()=>$(!p),children:[p?t("common.collapse","收起"):t("common.viewAll","查看全部"),p?e.jsx(K,{className:"h-3 w-3 ml-1"}):e.jsx(J,{className:"h-3 w-3 ml-1"})]})]}),!g.note&&!g.intro&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:p||(A||"").length<=v?A:(A||"").slice(0,v)+"..."}),(A||"").length>v&&e.jsxs(E,{variant:"ghost",size:"sm",className:"px-0 h-auto py-1 text-xs text-primary",onClick:()=>$(!p),children:[p?t("common.collapse","收起"):t("common.viewAll","查看全部"),p?e.jsx(K,{className:"h-3 w-3 ml-1"}):e.jsx(J,{className:"h-3 w-3 ml-1"})]})]})]}),s.nutrition&&(s.nutrition.calories||s.nutrition.protein||s.nutrition.carbs||s.nutrition.fat)&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3 flex items-center gap-2",children:[e.jsx(ze,{className:"h-4 w-4 text-orange-500"}),t("recipe.nutrition","营养信息")]}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[s.nutrition.calories&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-lg font-bold text-primary",children:s.nutrition.calories}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.kcal","千卡")})]}),s.nutrition.protein&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.protein,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.protein","蛋白质")})]}),s.nutrition.carbs&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.carbs,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.carbs","碳水")})]}),s.nutrition.fat&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.fat,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.fat","脂肪")})]})]})]}),e.jsx(ce,{}),s.ingredients&&s.ingredients.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3",children:[t("recipe.ingredients","食材")," (",s.ingredients.length,")"]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground font-medium px-2 py-1.5 bg-muted/50 rounded-t-md border border-border/50",children:[e.jsx("span",{className:"flex-1",children:t("recipe.ingredientName","名称")}),e.jsx("span",{className:"w-24 text-right",children:t("recipe.amount","用量")})]}),e.jsx("ul",{className:"border border-t-0 border-border/50 rounded-b-md divide-y divide-border/50",children:(k?s.ingredients:s.ingredients.slice(0,S)).map((c,n)=>{const r=P[n]||(i.language==="en"&&c.name_en?c.name_en:i.language==="pt"&&c.name_pt?c.name_pt:c.name);return e.jsxs("li",{className:"flex items-center text-sm px-2 py-2",children:[e.jsx("span",{className:"flex-1 min-w-0 truncate",children:r}),e.jsxs("span",{className:"w-24 text-right text-muted-foreground shrink-0",children:[c.amount," ",i.language==="en"&&c.unit_en?c.unit_en:i.language==="pt"&&c.unit_pt?c.unit_pt:c.unit]})]},n)})}),s.ingredients.length>S&&e.jsxs(e.Fragment,{children:[k&&e.jsx(oe,{}),e.jsxs(E,{variant:"ghost",size:"sm",className:"w-full mt-2 text-xs text-primary",onClick:()=>O(!k),children:[k?t("common.collapse","收起"):t("recipe.showAllIngredients",{count:s.ingredients.length}),k?e.jsx(K,{className:"h-3 w-3 ml-1"}):e.jsx(J,{className:"h-3 w-3 ml-1"})]})]}),s.ingredients.length<=S&&e.jsx(oe,{})]}),s.recipe_tags&&s.recipe_tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2",children:s.recipe_tags.map((c,n)=>e.jsxs(_,{variant:"secondary",className:"text-xs",children:["#",c]},n))}),q&&e.jsxs(E,{size:"lg",className:"w-full gap-2 h-14 text-lg",onClick:j,children:[e.jsx(ie,{className:"h-6 w-6"}),t("recipe.startCooking","开始烹饪"),e.jsxs(_,{variant:"secondary",className:"ml-2",children:[s.steps.length," ",t("recipe.stepsCount","步")]})]})]}),e.jsx(Re,{imageUrl:C||"",isOpen:!!C,onClose:()=>D(null)})]})},Ls=s=>{const j=s.match(/^\[\[NOTE\]\]([\s\S]*?)(?:\n\[\[INTRO\]\]|$)/),t=s.match(/\[\[INTRO\]\]([\s\S]*)$/);return j?{note:j[1].trim(),intro:t?t[1].trim():""}:{note:"",intro:s}},Xs=({post:s,showActions:j=!1})=>{const{t,i18n:i}=ee(),{getLocalizedField:I}=ge(),[b,h]=l.useState("guided"),[R,w]=l.useState("overview"),[P,d]=l.useState(null),[C,D]=l.useState(null),[p,$]=l.useState({}),[k,O]=l.useState({}),[v,S]=l.useState(null);l.useRef(null);const z=l.useCallback(()=>{w("cooking"),requestAnimationFrame(()=>{window.scrollTo({top:0,behavior:"smooth"})})},[]),g=C||(()=>{const r={zh:"content_zh",en:"content_en",pt:"content_pt"}[i.language]||"content",o=s[r];return o&&typeof o=="string"&&o.trim()?o:s.content})(),y=P||I(s,"recipe_name")||s.recipe_name,L=l.useMemo(()=>Ls(g||""),[g]),U=()=>{const n=[];if(s.recipe_name&&n.push(`[NAME]${s.recipe_name}`),s.content&&s.content.trim()&&!s.content.includes("主要配料：")&&n.push(`[CONTENT]${s.content}`),s.ingredients&&s.ingredients.length>0){const r=s.ingredients.map(o=>o.name).join("|");n.push(`[INGREDIENTS]${r}`)}if(s.steps&&s.steps.length>0){const r=s.steps.sort((o,x)=>o.order-x.order).map(o=>o.description).join("|");n.push(`[STEPS]${r}`)}return n.join(`
---
`)},H=n=>{if(!n){d(null),D(null),$({}),O({});return}n.split(`
---
`).forEach(o=>{if(o.startsWith("[NAME]"))d(o.replace("[NAME]",""));else if(o.startsWith("[CONTENT]"))D(o.replace("[CONTENT]",""));else if(o.startsWith("[INGREDIENTS]")){const x=o.replace("[INGREDIENTS]","").split("|"),N={};x.forEach((M,V)=>{N[V]=M.trim()}),$(N)}else if(o.startsWith("[STEPS]")){const x=o.replace("[STEPS]","").split("|"),N={};x.forEach((M,V)=>{N[V]=M.trim()}),O(N)}})},W=()=>{switch(i.language){case"zh":return be;case"pt":return Ne;default:return je}},G=n=>{switch(n){case"easy":return"bg-green-500/20 text-green-700 dark:text-green-400 border-green-500/30";case"medium":return"bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 border-yellow-500/30";case"hard":return"bg-red-500/20 text-red-700 dark:text-red-400 border-red-500/30";default:return"bg-muted text-muted-foreground"}},Y=n=>{switch(n){case"easy":return t("recipe.difficulty.easy","简单");case"medium":return t("recipe.difficulty.medium","中等");case"hard":return t("recipe.difficulty.hard","困难");default:return n}},q=s.image_urls&&s.image_urls.length>0,c=s.steps&&s.steps.length>0;return b==="guided"&&R==="cooking"&&c?e.jsx(Q,{className:"overflow-hidden",children:e.jsx(Es,{steps:s.steps,onExit:()=>w("overview")})}):b==="guided"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"inline-flex h-9 items-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>h("guided"),className:"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium transition-all gap-1.5 bg-background text-foreground shadow-sm",children:[e.jsx(ie,{className:"h-4 w-4"}),t("recipe.guidedMode","流程模式")]}),e.jsxs("button",{onClick:()=>h("full"),className:"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium transition-all gap-1.5",children:[e.jsx(ke,{className:"h-4 w-4"}),t("recipe.fullMode","完整模式")]})]})}),e.jsx(As,{post:s,onStartCooking:z}),e.jsx(Q,{children:e.jsx(Z,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-6 text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(ae,{className:"h-4 w-4"}),s.likes_count||0]}),e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(re,{className:"h-4 w-4"}),s.comments_count||0]}),e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(le,{className:"h-4 w-4"}),s.shares_count||0]})]})})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"inline-flex h-9 items-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>{h("guided"),w("overview")},className:"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium transition-all gap-1.5",children:[e.jsx(ie,{className:"h-4 w-4"}),t("recipe.guidedMode","流程模式")]}),e.jsxs("button",{onClick:()=>h("full"),className:"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium transition-all gap-1.5 bg-background text-foreground shadow-sm",children:[e.jsx(ke,{className:"h-4 w-4"}),t("recipe.fullMode","完整模式")]})]})}),e.jsxs(Q,{className:"overflow-hidden",children:[q&&e.jsxs("div",{className:"relative aspect-video overflow-hidden",children:[e.jsx("img",{src:s.image_urls[0],alt:y||"",className:"w-full h-full object-cover cursor-pointer",onClick:()=>S(s.image_urls[0])}),e.jsxs(_,{className:"absolute top-3 left-3 bg-primary text-primary-foreground gap-1",children:[e.jsx(De,{className:"h-3 w-3"}),t("recipe.badge","食谱")]})]}),e.jsxs(me,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsxs(ue,{className:"h-10 w-10",children:[e.jsx(xe,{src:s.author?.avatar_url||void 0}),e.jsx(he,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:pe(new Date(s.created_at),{addSuffix:!0,locale:W()})})]})]}),e.jsx("div",{className:"mb-2",children:e.jsx(fe,{text:U(),onTranslation:H,label:t("recipe.translateAllFull")})}),e.jsx("h2",{className:"text-xl font-bold",children:y}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-3",children:[s.cook_time&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.cook_time," ",t("recipe.minutes","分钟")]})]}),s.servings&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.servings," ",t("recipe.servings","人份")]})]}),s.difficulty&&e.jsxs(_,{variant:"outline",className:G(s.difficulty),children:[e.jsx(Le,{className:"h-3 w-3 mr-1"}),Y(s.difficulty)]})]})]}),e.jsxs(Z,{className:"space-y-6",children:[s.content&&s.content.trim()&&!s.content.includes("主要配料：")&&e.jsxs("div",{className:"space-y-3",children:[L.note&&e.jsxs("div",{className:"rounded-lg border border-primary/20 bg-primary/5 px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1.5",children:[e.jsx(Me,{className:"h-3.5 w-3.5 text-primary"}),e.jsx("span",{className:"text-xs font-medium text-primary",children:t("recipe.cookingNote","心得")})]}),e.jsx("p",{className:"text-sm text-foreground/80 italic leading-relaxed whitespace-pre-line",children:L.note})]}),L.intro&&e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line leading-relaxed",children:L.intro}),!L.note&&!L.intro&&e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:g})]}),s.nutrition&&(s.nutrition.calories||s.nutrition.protein||s.nutrition.carbs||s.nutrition.fat)&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3 flex items-center gap-2",children:[e.jsx(ze,{className:"h-4 w-4 text-primary"}),t("recipe.nutrition","营养信息")]}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[s.nutrition.calories&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-lg font-bold text-primary",children:s.nutrition.calories}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.kcal","千卡")})]}),s.nutrition.protein&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.protein,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.protein","蛋白质")})]}),s.nutrition.carbs&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.carbs,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.carbs","碳水")})]}),s.nutrition.fat&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.fat,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("recipe.fat","脂肪")})]})]})]}),e.jsx(ce,{}),s.ingredients&&s.ingredients.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3",children:[t("recipe.ingredients","食材")," (",s.ingredients.length,")"]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground font-medium px-2 py-1.5 bg-muted/50 rounded-t-md border border-border/50",children:[e.jsx("span",{className:"flex-1",children:t("recipe.ingredientName","名称")}),e.jsx("span",{className:"w-24 text-right",children:t("recipe.amount","用量")})]}),e.jsx("ul",{className:"border border-t-0 border-border/50 rounded-b-md divide-y divide-border/50",children:s.ingredients.map((n,r)=>{const o=p[r]||(i.language==="en"&&n.name_en?n.name_en:i.language==="pt"&&n.name_pt?n.name_pt:n.name);return e.jsxs("li",{className:"flex items-center text-sm px-2 py-2",children:[e.jsx("span",{className:"flex-1 min-w-0 truncate",children:o}),e.jsxs("span",{className:"w-24 text-right text-muted-foreground shrink-0",children:[n.amount," ",i.language==="en"&&n.unit_en?n.unit_en:i.language==="pt"&&n.unit_pt?n.unit_pt:n.unit]})]},r)})}),e.jsx(oe,{})]}),e.jsx(ce,{}),c&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3",children:[t("recipe.steps","步骤")," (",s.steps.length,")"]}),e.jsx("ol",{className:"space-y-4",children:s.steps.sort((n,r)=>n.order-r.order).map((n,r)=>{const o=k[r]||(i.language==="en"&&n.description_en?n.description_en:i.language==="pt"&&n.description_pt?n.description_pt:n.description);return e.jsxs("li",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-xs font-bold",children:n.order}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("p",{className:"text-sm",children:o}),(()=>{const x=n.image_urls&&n.image_urls.length>0?n.image_urls:n.image_url?[n.image_url]:[];return x.length>0&&e.jsx("div",{className:`flex gap-2 ${x.length===1?"":"flex-wrap"}`,children:x.map((N,M)=>e.jsx("img",{src:N,alt:`Step ${n.order} - ${M+1}`,className:`rounded-lg max-h-48 object-cover cursor-pointer ${x.length===1?"w-full":"w-[calc(50%-0.25rem)]"}`,onClick:()=>S(N)},M))})})()]})]},r)})})]}),s.recipe_tags&&s.recipe_tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2",children:s.recipe_tags.map((n,r)=>e.jsxs(_,{variant:"secondary",className:"text-xs",children:["#",n]},r))}),e.jsxs("div",{className:"flex items-center gap-6 pt-4 border-t text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(ae,{className:"h-4 w-4"}),s.likes_count||0]}),e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(re,{className:"h-4 w-4"}),s.comments_count||0]}),e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(le,{className:"h-4 w-4"}),s.shares_count||0]})]})]})]}),e.jsx(Re,{imageUrl:v||"",isOpen:!!v,onClose:()=>S(null)})]})};export{Qs as P,Xs as R};
//# sourceMappingURL=RecipeDetailContent-CUySloKa.js.map
