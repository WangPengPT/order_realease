import{bp as Z,p as ee,r as se,s as j,j as e,L as p,bj as ae,ba as te,a$ as L,b5 as E,bs as ne,bq as re,bJ as V,b3 as k,be as z,bG as G,cr as ie,cs as le,ct as de,cu as ce,cv as me,cw as oe,cx as xe,cz as he}from"./vendor-react-COnB1Bf9.js";import{j as I,B as w,a2 as ue,a3 as ge,a4 as je,a5 as pe,a6 as _,C as l,q as d,p as f,F as N,$ as T,P as A,Q as H,R as K,g as P,s as b}from"./index-B-ATr_p9.js";import{f as D}from"./paginatedQuery-D68z0tcs.js";import{d as fe}from"./useRestaurants-qNgLbNB5.js";import{u as Ne}from"./useLocalizedContent-pMHaJh_n.js";import{s as C,W as Q,D as m,f as O}from"./vendor-utils-Z4kpnli5.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CK3nEoYK.js";const ze=()=>{const{id:n}=Z(),{t}=ee(),{localizeRestaurant:W}=Ne(),[o,J]=se.useState("30days"),U=()=>{const s=new Date;switch(o){case"today":return O(s).toISOString();case"7days":return O(C(s,6)).toISOString();case"30days":return O(C(s,29)).toISOString();default:return null}},X=()=>{switch(o){case"today":return 1;case"7days":return 7;case"30days":return 30;default:return 30}},{data:h,isLoading:Y}=fe(n),x=U(),{data:S=[],isLoading:ve}=j({queryKey:["restaurant-page-views",n,o],queryFn:async()=>await D("page_views","created_at",s=>(s=s.eq("page_type","restaurant").eq("target_id",n),x&&(s=s.gte("created_at",x)),s)),enabled:!!n}),{data:u=[],isLoading:ye}=j({queryKey:["restaurant-comments",n,o],queryFn:async()=>{const s=await D("comments","id, user_id, content, rating_value, created_at",a=>(a=a.eq("target_type","restaurant").eq("target_id",n).order("created_at",{ascending:!1}),x&&(a=a.gte("created_at",x)),a));if(s&&s.length>0){const a=[...new Set(s.map(r=>r.user_id))],{data:i}=await b.rpc("get_public_profiles",{user_ids:a});return s.map(r=>({...r,profile:i?.find(c=>c.id===r.user_id)}))}return[]},enabled:!!n}),{data:v=[],isLoading:we}=j({queryKey:["restaurant-favorites",n,o],queryFn:async()=>{const s=await D("favorites","user_id, created_at",a=>(a=a.eq("restaurant_id",n),x&&(a=a.gte("created_at",x)),a));if(s&&s.length>0){const a=s.map(r=>r.user_id),{data:i}=await b.rpc("get_public_profiles",{user_ids:a});return s.map(r=>({...r,profile:i?.find(c=>c.id===r.user_id)}))}return[]},enabled:!!n}),{data:y=[],isLoading:_e}=j({queryKey:["restaurant-posts",n,o],queryFn:async()=>{const s=await D("community_posts","id, author_id, content, likes_count, comments_count, views_count, created_at, status",a=>(a=a.eq("restaurant_id",n).order("created_at",{ascending:!1}),x&&(a=a.gte("created_at",x)),a));if(s&&s.length>0){const a=[...new Set(s.map(r=>r.author_id))],{data:i}=await b.rpc("get_public_profiles",{user_ids:a});return s.map(r=>({...r,profile:i?.find(c=>c.id===r.author_id)}))}return[]},enabled:!!n}),{data:$=[]}=j({queryKey:["restaurant-activities",n],queryFn:async()=>{const{data:s,error:a}=await b.from("activity_restaurants").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            status
          )
        `).eq("restaurant_id",n);if(a)throw a;return s?.map(i=>i.activities).filter(Boolean)||[]},enabled:!!n}),q=(()=>{if(o==="all"){const a=new Date,i=C(a,29);return Q({start:i,end:a}).map(c=>{const g=m(c,"yyyy-MM-dd"),R=S.filter(F=>m(new Date(F.created_at),"yyyy-MM-dd")===g).length;return{date:g,views:R}})}else{const s=X(),a=new Date,i=C(a,s-1);return Q({start:i,end:a}).map(c=>{const g=m(c,"yyyy-MM-dd"),R=S.filter(F=>m(new Date(F.created_at),"yyyy-MM-dd")===g).length;return{date:g,views:R}})}})(),B=u.length>0?u.filter(s=>s.rating_value).reduce((s,a)=>s+(a.rating_value||0),0)/u.filter(s=>s.rating_value).length:0,M=h?W(h):null;return Y?e.jsxs("div",{className:"space-y-6",children:[e.jsx(I,{className:"h-8 w-48"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsx(I,{className:"h-24"},s))}),e.jsx(I,{className:"h-64"})]}):!h||!M?e.jsx("div",{className:"flex items-center justify-center min-h-[50vh]",children:e.jsx("p",{className:"text-muted-foreground",children:t("error.notFound")})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{variant:"ghost",size:"icon",asChild:!0,children:e.jsx(p,{to:"/admin/restaurant-stats",children:e.jsx(ae,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[h.image_url?e.jsx("img",{src:h.image_url,alt:M.name,className:"w-12 h-12 rounded-lg object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(te,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:M.name}),h.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(L,{className:"h-3 w-3 fill-amber-400 text-amber-400"}),e.jsx("span",{children:h.rating.toFixed(1)})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(ue,{value:o,onValueChange:s=>J(s),children:[e.jsx(ge,{className:"w-[140px]",children:e.jsx(je,{})}),e.jsxs(pe,{children:[e.jsx(_,{value:"today",children:t("analytics.today","今日")}),e.jsx(_,{value:"7days",children:t("analytics.last7Days","近7天")}),e.jsx(_,{value:"30days",children:t("analytics.last30Days","近30天")}),e.jsx(_,{value:"all",children:t("analytics.allTime","所有时间")})]})]}),e.jsx(w,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(p,{to:`/restaurant/${n}`,target:"_blank",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),t("admin.preview","预览")]})}),e.jsx(w,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(p,{to:"/admin/restaurants",state:{editRestaurantId:n},children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),t("admin.edit","编辑")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx(V,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.views","浏览量")}),e.jsx("p",{className:"text-2xl font-bold",children:S.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-500/10 rounded-lg",children:e.jsx(k,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.comments","评论")}),e.jsx("p",{className:"text-2xl font-bold",children:u.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/10 rounded-lg",children:e.jsx(z,{className:"h-5 w-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.favorites","收藏")}),e.jsx("p",{className:"text-2xl font-bold",children:v.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-500/10 rounded-lg",children:e.jsx(G,{className:"h-5 w-5 text-purple-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.posts","帖子")}),e.jsx("p",{className:"text-2xl font-bold",children:y.length})]})]})})}),e.jsx(l,{children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/10 rounded-lg",children:e.jsx(L,{className:"h-5 w-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t("admin.avgRating","平均评分")}),e.jsx("p",{className:"text-2xl font-bold",children:B>0?B.toFixed(1):"-"})]})]})})})]}),e.jsxs(l,{children:[e.jsx(f,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),t("admin.viewTrend","浏览趋势")]})}),e.jsx(d,{children:e.jsx("div",{className:"h-[300px]",children:q.length>0?e.jsx(le,{width:"100%",height:"100%",children:e.jsxs(de,{data:q,children:[e.jsx(ce,{strokeDasharray:"3 3",className:"stroke-muted"}),e.jsx(me,{dataKey:"date",tickFormatter:s=>m(new Date(s),"MM/dd"),className:"text-xs"}),e.jsx(oe,{className:"text-xs"}),e.jsx(xe,{labelFormatter:s=>m(new Date(s),"yyyy-MM-dd"),contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))"}}),e.jsx(he,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,name:t("admin.views")})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:t("analytics.noData")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(l,{children:[e.jsxs(f,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"}),t("admin.recentComments","最近评论")]}),e.jsx(T,{children:t("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(u.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[u.slice(0,10).map(s=>e.jsxs("div",{className:"flex gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(A,{className:"h-8 w-8",children:[e.jsx(H,{src:s.profile?.avatar_url}),e.jsx(K,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),s.rating_value&&e.jsxs(P,{variant:"secondary",className:"text-xs",children:[e.jsx(L,{className:"h-3 w-3 mr-1 fill-amber-400 text-amber-400"}),s.rating_value]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:m(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},s.id)),u.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:t("admin.noComments","暂无评论")})]})})]}),e.jsxs(l,{children:[e.jsxs(f,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5"}),t("admin.recentFavorites","最近收藏")]}),e.jsx(T,{children:t("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(v.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:[v.slice(0,10).map((s,a)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[e.jsxs(A,{className:"h-8 w-8",children:[e.jsx(H,{src:s.profile?.avatar_url}),e.jsx(K,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:m(new Date(s.created_at),"yyyy-MM-dd HH:mm")})]})]},a)),v.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:t("admin.noFavorites","暂无收藏")})]})})]}),e.jsxs(l,{children:[e.jsxs(f,{children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5"}),t("admin.recentPosts","最近帖子")]}),e.jsx(T,{children:t("admin.showingRecent","显示最近 {{count}} 条",{count:Math.min(y.length,10)})})]}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-4 max-h-[400px] overflow-y-auto",children:[y.slice(0,10).map(s=>e.jsxs(p,{to:`/post/${s.id}`,className:"flex gap-3 p-3 bg-muted/50 rounded-lg hover:bg-muted/70 transition-colors block",children:[e.jsxs(A,{className:"h-8 w-8",children:[e.jsx(H,{src:s.profile?.avatar_url}),e.jsx(K,{children:s.profile?.display_name?.[0]||"?"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:s.profile?.display_name||t("common.anonymous")}),e.jsx(P,{variant:s.status==="approved"?"default":"secondary",className:"text-xs",children:s.status==="approved"?t("admin.published","已发布"):s.status})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.content?.replace(/<[^>]*>/g,"")}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-3 w-3"}),s.views_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-3 w-3"}),s.likes_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(k,{className:"h-3 w-3"}),s.comments_count||0]}),e.jsx("span",{children:m(new Date(s.created_at),"MM-dd HH:mm")})]})]})]},s.id)),y.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:t("admin.noPosts","暂无帖子")})]})})]})]}),e.jsxs(l,{children:[e.jsx(f,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),t("admin.participatingActivities","参与的活动")]})}),e.jsx(d,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[$.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.title_zh||s.title_en}),e.jsx(P,{variant:s.status==="published"?"default":"secondary",children:s.status==="published"?t("admin.published","已发布"):t("admin.draft","草稿")})]}),e.jsx(w,{variant:"outline",size:"sm",className:"w-full",asChild:!0,children:e.jsx(p,{to:`/admin/activity-stats/${s.id}`,children:t("admin.viewStats","查看统计")})})]},s.id)),$.length===0&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:t("admin.noActivities","暂未参与活动")})]})})]})]})};export{ze as default};
//# sourceMappingURL=AdminRestaurantStats-DdY5Lf9l.js.map
