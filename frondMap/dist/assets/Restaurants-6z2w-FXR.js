import{j as e}from"./vendor-ui-BO6fjm1h.js";import{u as be,r as n,L as ye}from"./vendor-react-CrHRjzzo.js";import{q as U,K as l,O as Y,P as G,Q as J,j as ke,u as Ce,I as Re,B as i,R as Te,T as Se,F as ze,k as b,X as L,N as $,V as Le,r as De,p as Fe,W as _e,Y as Ae,E as Me,s as Pe}from"./index-ChGLUOfd.js";import{P as Z,a as ee,b as se}from"./popover-DqGyCvLa.js";import{u as $e,b as qe,a as Be,c as Ee}from"./useRestaurants-Due3PPfR.js";import{c as Ie,o as Ve,g as Qe}from"./geolocation-DRm3QMsJ.js";import{f as We,N as Oe}from"./timeUtils-BcrBwg3X.js";import{u as Ke,R as He,l as Xe}from"./xiaoxiong-logo-clean-CHZd6QBT.js";import{u as Ue}from"./useLocalizedContent-S0TAoDtX.js";import{u as Ye}from"./useActivities-i7vr2zPW.js";import{u as Ge}from"./useInfiniteScroll-1jvSebPK.js";import{L as Je}from"./LocationPermissionDialog-JcLH1iGB.js";import{P as Ze}from"./PullToRefresh-dGxySVA7.js";import{u as es}from"./vendor-query-EnOED-MY.js";import{u as ss}from"./vendor-i18n-DWR4v88Y.js";import"./vendor-charts-C50LysBY.js";import"./vendor-supabase-QnE9GqXs.js";import"./vendor-map-hWrxZwzm.js";/* empty css                  */const as=({count:j=6})=>e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:Array.from({length:j}).map((v,a)=>e.jsxs(U,{className:"overflow-hidden flex flex-col h-full",style:{animationDelay:`${a*100}ms`},children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx(l,{className:"w-full h-full rounded-none"}),e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx(l,{className:"h-9 w-9 rounded-md"})})]}),e.jsx(Y,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(l,{className:"h-6 w-40"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(l,{className:"h-4 w-4 rounded-full"}),e.jsx(l,{className:"h-4 w-16"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(l,{className:"h-5 w-5 rounded-full"}),e.jsx(l,{className:"h-5 w-8"})]})]})}),e.jsxs(G,{className:"space-y-3 flex-grow",children:[e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(l,{className:"h-5 w-16 rounded-full"}),e.jsx(l,{className:"h-5 w-20 rounded-full"}),e.jsx(l,{className:"h-5 w-14 rounded-full"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(l,{className:"h-4 w-full"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(l,{className:"h-4 w-32"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:"h-4 w-4 rounded-full flex-shrink-0"}),e.jsx(l,{className:"h-4 w-40"})]})]}),e.jsxs(J,{className:"gap-2 mt-auto",children:[e.jsx(l,{className:"h-10 flex-1 rounded-md"}),e.jsx(l,{className:"h-10 w-10 rounded-md"})]})]},a))}),ts=()=>e.jsxs("div",{className:"relative flex-1 min-h-[300px] sm:min-h-[400px] lg:mx-4 lg:mb-4 lg:rounded-lg overflow-hidden lg:shadow-lg bg-muted",children:[e.jsx(l,{className:"absolute inset-0 w-full h-full rounded-none"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2",children:e.jsx(l,{className:"h-8 w-8 rounded-full"})}),e.jsx("div",{className:"absolute top-1/4 left-1/3",children:e.jsx(l,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute top-1/3 right-1/4",children:e.jsx(l,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute bottom-1/3 left-1/4",children:e.jsx(l,{className:"h-6 w-6 rounded-full"})}),e.jsx("div",{className:"absolute bottom-1/4 right-1/3",children:e.jsx(l,{className:"h-6 w-6 rounded-full"})})]})}),e.jsx("div",{className:"absolute bottom-4 left-4 z-10",children:e.jsx(l,{className:"h-10 w-36 rounded-full"})}),e.jsxs("div",{className:"absolute top-4 right-4 z-10 flex flex-col gap-2",children:[e.jsx(l,{className:"h-8 w-8 rounded-md"}),e.jsx(l,{className:"h-8 w-8 rounded-md"})]})]}),ls=({restaurant:j,language:v})=>{const[a,h]=n.useState(999),y=n.useRef(null),g=j.type.map((t,f)=>({key:`type-${f}`,label:t,variant:"secondary",color:void 0}));n.useEffect(()=>{const t=()=>{if(!y.current)return;const T=y.current,o=Array.from(T.querySelectorAll(".tag-badge"));if(o.length===0){setTimeout(t,50);return}const d=o[0]?.offsetTop;let p=o.length;for(let u=0;u<o.length;u++)if(o[u].offsetTop>d){p=u;break}if(p===o.length){h(o.length);return}const m=T.offsetWidth,C=40;let x=0,S=p;for(let u=0;u<p;u++)x+=o[u].offsetWidth+8;x+C>m&&(S=Math.max(1,p-1)),h(S)};h(999);const f=setTimeout(t,100);return window.addEventListener("resize",t),()=>{clearTimeout(f),window.removeEventListener("resize",t)}},[g.length,j.id]);const D=g.slice(0,a),c=g.slice(a),k=c.length>0;return e.jsxs("div",{className:"flex items-center gap-2 -mt-1",children:[e.jsx("div",{ref:y,className:"flex gap-2 flex-wrap flex-1",children:D.map(t=>e.jsx(b,{variant:t.variant,className:"text-xs whitespace-nowrap tag-badge",style:t.color?{backgroundColor:t.color,color:"white"}:void 0,children:t.label},t.key))}),k&&e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"sm",className:"h-6 px-2 text-muted-foreground hover:text-foreground flex-shrink-0",children:e.jsx(Me,{className:"h-4 w-4"})})}),e.jsx(se,{className:"w-auto max-w-80",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:c.map(t=>e.jsx(b,{variant:t.variant,className:"text-xs",style:t.color?{backgroundColor:t.color,color:"white"}:void 0,children:t.label},t.key))})})]})]})},ks=()=>{const j=be(),v=es(),{t:a,i18n:h}=ss(),{toast:y}=ke(),{localizeRestaurant:q}=Ue(),[g,D]=n.useState(""),[c,k]=n.useState([]),[t,f]=n.useState(null),[T,o]=n.useState([]),[d,p]=n.useState("list"),[m,C]=n.useState(null),[x,S]=n.useState(null),[u,B]=n.useState(!1),[F,ae]=n.useState(!1),[_,te]=n.useState(!1),[le,A]=n.useState(!1),[re,M]=n.useState(!1),[R,ne]=n.useState(null),{user:E}=Ce(),{data:I,isLoading:ie}=$e(g,c.length>0?c.join(","):void 0),{data:oe=[]}=qe(),{data:P=[]}=Be(),{data:ce=[]}=Ye(),{data:de={}}=Ke(),me=n.useCallback(async()=>{await Promise.all([v.invalidateQueries({queryKey:["restaurants"]}),v.invalidateQueries({queryKey:["activities"]}),v.invalidateQueries({queryKey:["restaurantTypes"]})])},[v]),z=ce.filter(s=>(de[s.id]||0)>0),xe=Ee(),ue=(s,r)=>{r.preventDefault(),r.stopPropagation(),E&&xe.mutate(s)},he=s=>{k(r=>r.includes(s)?r.filter(w=>w!==s):[...r,s])},fe=()=>{M(!0)},V=async()=>{M(!1);try{const s=await Qe();S({lat:s.coords.latitude,lng:s.coords.longitude}),B(!0),y({title:a("restaurants.locationEnabled"),description:a("restaurants.sortByDistance")})}catch(s){console.error("Location error:",s)}},pe=s=>{C(s),s&&!x&&V()},ge=async s=>{if(t===s)f(null),o([]);else{f(s);const{data:r,error:w}=await Pe.from("activity_restaurants").select("restaurant_id").eq("activity_id",s);w?(console.error("Error fetching activity restaurants:",w),o([])):o(r.map(we=>we.restaurant_id))}},Q=I?.map(s=>{const r=q(s);if(x){const w=Ie(x.lat,x.lng,s.lat,s.lng);return{...r,distance:w}}return r})||[],W=t?Q.filter(s=>T.includes(s.id)):Q,O=m&&x?W.filter(s=>s.distance&&s.distance<=m):W,N=x?[...O].sort((s,r)=>(s.distance||0)-(r.distance||0)):[...O].sort((s,r)=>(r.rating||0)-(s.rating||0)),{displayedData:K,hasMore:je,loadMore:ve,reset:H}=Ge({data:N,initialItemsPerPage:12,incrementPerPage:12});n.useEffect(()=>{H()},[g,c,t,m,u,H]);const Ne=s=>{j(`/restaurant/${s.id}`)},X=e.jsx("div",{className:`bg-secondary/20 animate-fade-in ${d==="map"?"h-screen flex flex-col overflow-hidden":"min-h-screen py-8 px-4"}`,children:e.jsxs("div",{className:`${d==="map"?"flex flex-col h-full":"container mx-auto max-w-7xl"}`,children:[e.jsxs("div",{className:`${d==="map"?"px-4 pt-4 pb-2 flex-shrink-0":"mb-8"}`,children:[e.jsx("h1",{className:`text-4xl font-bold text-primary ${d==="map"?"hidden md:block md:mb-4":"mb-4"}`,children:a("restaurants.title")}),e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 md:items-center",children:[e.jsx(Re,{placeholder:a("restaurants.search"),value:g,onChange:s=>D(s.target.value),className:"w-full md:max-w-md"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(i,{variant:d==="list"?"default":"outline",size:"icon",onClick:()=>p("list"),title:a("restaurants.listView"),className:"flex-shrink-0",children:e.jsx(Te,{className:"w-4 h-4"})}),e.jsx(i,{variant:d==="map"?"default":"outline",size:"icon",onClick:()=>p("map"),title:a("restaurants.mapView"),className:"flex-shrink-0",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(i,{variant:c.length>0||t||m?"default":"outline",size:"icon",className:"flex-shrink-0 relative",title:a("restaurants.filter"),children:[e.jsx(ze,{className:"w-4 h-4"}),(c.length>0||t||m)&&e.jsx(b,{variant:"secondary",className:"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:(c.length>0?1:0)+(t?1:0)+(m?1:0)})]})}),e.jsx(se,{className:"w-[90vw] max-w-sm p-0",align:"start",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border/50 bg-muted/30",children:[e.jsx("span",{className:"font-semibold text-foreground text-base",children:a("restaurants.filter")}),(c.length>0||t||m)&&e.jsxs(i,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{k([]),f(null),o([]),C(null)},children:[e.jsx(L,{className:"w-3 h-3 mr-1"}),a("common.actions.clearFilter")]})]}),e.jsxs("div",{className:"p-4 space-y-5",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("restaurants.restaurantTypes")}),e.jsxs("div",{className:"flex items-center gap-2",children:[c.length>0&&e.jsxs(i,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>k([]),children:[e.jsx(L,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]}),P.length>8&&e.jsx(i,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-primary hover:text-primary/80",onClick:()=>ae(!F),children:a(F?"common.showLess":"common.showMore")})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap max-h-36 overflow-y-auto pr-1",children:(F?P:P.slice(0,8)).map(s=>e.jsx(b,{variant:c.includes(s)?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${c.includes(s)?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>he(s),children:s},s))})]}),z.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("nav.activities")}),e.jsxs("div",{className:"flex items-center gap-2",children:[t&&e.jsxs(i,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{f(null),o([])},children:[e.jsx(L,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]}),z.length>8&&e.jsx(i,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-primary hover:text-primary/80",onClick:()=>te(!_),children:a(_?"common.showLess":"common.showMore")})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap max-h-36 overflow-y-auto pr-1",children:(_?z:z.slice(0,8)).map(s=>{const r=h.language==="zh"?s.badge_text_zh||s.title_zh:h.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(b,{variant:t===s.id?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${t===s.id?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>ge(s.id),children:r},s.id)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:a("restaurants.radius")}),m&&e.jsxs(i,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>C(null),children:[e.jsx(L,{className:"w-3 h-3 mr-1"}),a("common.actions.clear")]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[{value:null,label:a("restaurants.allRestaurants")},{value:5,label:a("restaurants.radius5km")},{value:10,label:a("restaurants.radius10km")},{value:20,label:a("restaurants.radius20km")}].map(s=>e.jsx(b,{variant:m===s.value?"default":"outline",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs font-normal whitespace-nowrap hover:bg-primary/10 ${m===s.value?"bg-primary text-primary-foreground shadow-sm":"bg-background hover:border-primary/50"}`,onClick:()=>pe(s.value),children:s.label},s.value??"all"))})]})]})]})})]}),x?e.jsx(i,{variant:u?"default":"outline",onClick:()=>B(!u),className:"flex-1 md:flex-initial whitespace-nowrap",children:a("restaurants.sortByDistance")}):e.jsxs(i,{variant:"outline",onClick:fe,className:"flex-1 md:flex-initial",children:[e.jsx($,{className:"w-4 h-4 mr-2 flex-shrink-0"}),e.jsx("span",{className:"md:hidden whitespace-nowrap text-sm",children:a("restaurants.getLocationMobile")}),e.jsx("span",{className:"hidden md:inline whitespace-nowrap",children:a("restaurants.getLocation")})]})]})]})})]}),ie||!I?d==="map"?e.jsx(ts,{}):e.jsx(as,{count:6}):N.length===0?e.jsxs("div",{className:`text-center ${d==="map"?"flex-1 flex flex-col justify-center px-4":"py-20"}`,children:[e.jsx("p",{className:"text-xl text-muted-foreground",children:a("restaurants.noResults")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:a("restaurants.noResultsDesc")})]}):e.jsxs(e.Fragment,{children:[d==="map"&&N.length>0&&e.jsxs("div",{className:"relative flex-1 min-h-[300px] sm:min-h-[400px] lg:mx-4 lg:mb-4 lg:rounded-lg overflow-hidden lg:shadow-lg",children:[e.jsx(He,{restaurants:N,onRestaurantClick:Ne,userLocation:x,radiusFilter:m,showViewDetailsButton:!0}),e.jsxs("div",{className:"absolute bottom-4 left-4 z-10 pointer-events-none flex items-center gap-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg",children:[e.jsx("img",{src:Xe,alt:"Xiaoxiong Market Logo",className:"h-6 w-6 object-contain"}),e.jsx("span",{className:"text-sm font-semibold text-foreground whitespace-nowrap",children:h.language==="zh"?"小熊市场":"Xiaoxiong Market"})]})]}),d==="list"&&N.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:K.map(s=>e.jsxs(U,{className:"overflow-hidden hover:shadow-large transition-shadow flex flex-col h-full",children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx("img",{src:s.image_url||"https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600&q=80",alt:s.name,className:"w-full h-full object-cover transition-transform hover:scale-105"}),E&&e.jsx(i,{size:"icon",variant:"secondary",className:"absolute top-3 right-3",onClick:r=>ue(s.id,r),children:e.jsx(Le,{className:`w-5 h-5 ${oe.includes(s.id)?"fill-destructive text-destructive":""}`})})]}),e.jsx(Y,{className:"mb-px pb-[15px]",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-card-foreground",children:s.name}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"font-semibold text-sm text-foreground",children:[s.distance.toFixed(1)," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(De,{className:`w-5 h-5 ${s.rating?"fill-accent text-accent":"text-muted-foreground"}`}),s.rating?e.jsx("span",{className:"font-semibold text-card-foreground",children:s.rating.toFixed(1)}):e.jsxs("span",{className:"text-xs text-muted-foreground text-center whitespace-nowrap",children:[a("restaurant.noRatingLine1"),e.jsx("br",{}),a("restaurant.noRatingLine2")]})]})]})}),e.jsxs(G,{className:"space-y-2 flex-grow",children:[e.jsx(ls,{restaurant:s,language:h.language}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Fe,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-1",children:s.address})]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(_e,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:s.phone})]}),s.opening_hours&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx(Ae,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:We(s.opening_hours)})]})]}),e.jsxs(J,{className:"gap-2 mt-auto",children:[e.jsx(i,{asChild:!0,className:"flex-1",children:e.jsx(ye,{to:`/restaurant/${s.id}`,children:a("restaurants.viewDetails")})}),x&&e.jsx(i,{variant:"outline",size:"icon",onClick:()=>{ne({lat:s.lat,lng:s.lng,name:s.name}),A(!0)},title:a("restaurants.directions"),children:e.jsx($,{className:"w-4 h-4"})})]})]},s.id))}),je&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsxs(i,{onClick:ve,size:"lg",variant:"outline",children:[a("common.loadMore")," (",K.length," / ",N.length,")"]})})]})]}),e.jsx(Oe,{open:le,onOpenChange:A,onConfirm:()=>{R&&Ve(R.lat,R.lng,R.name),A(!1)},destinationName:R?.name||""}),e.jsx(Je,{open:re,onOpenChange:M,onConfirm:V})]})});return d==="list"?e.jsx(Ze,{onRefresh:me,children:X}):X};export{ks as default};
//# sourceMappingURL=Restaurants-6z2w-FXR.js.map
