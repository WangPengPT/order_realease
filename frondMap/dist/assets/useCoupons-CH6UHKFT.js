import{r as E}from"./vendor-react-iAJ0IrSD.js";import{a as m,u as _,b as f}from"./vendor-query-D82cqPtt.js";import{u as g,s as n,z as v}from"./index-wnyfSufX.js";import{i as c}from"./vendor-i18n-DxKeo2S1.js";const K=()=>m({queryKey:["couponTemplates"],queryFn:async()=>{const{data:e,error:t}=await n.from("coupon_templates").select("*").order("created_at",{ascending:!1});if(t)throw t;return e}}),D=()=>{const{user:e}=g(),t=_();return E.useEffect(()=>{if(!e)return;const r=n.channel("user-coupons-changes").on("postgres_changes",{event:"*",schema:"public",table:"user_coupons",filter:`user_id=eq.${e.id}`},()=>{t.invalidateQueries({queryKey:["userCoupons",e.id]})}).subscribe();return()=>{n.removeChannel(r)}},[e,t]),m({queryKey:["userCoupons",e?.id],queryFn:async()=>{if(!e)return[];const{data:r,error:o}=await n.from("user_coupons").select(`
          *,
          coupon_codes (
            *,
            coupon_templates (*)
          )
        `).eq("user_id",e.id).order("claimed_at",{ascending:!1});if(o)throw o;return r},enabled:!!e,staleTime:1e3*30,gcTime:1e3*60*5})},F=e=>m({queryKey:["activityCouponTemplates",e],queryFn:async()=>{const{data:t,error:r}=await n.from("coupon_template_activities").select(`
          coupon_templates (*)
        `).eq("activity_id",e);if(r)throw r;return(t||[]).map(s=>s.coupon_templates).filter(s=>s&&s.is_active&&s.visible)},enabled:!!e}),Q=e=>{const{user:t}=g();return m({queryKey:["hasSharedCoupon",e,t?.id],queryFn:async()=>{if(!t)return!1;const{data:r,error:o}=await n.from("user_coupons").select("id").eq("user_id",t.id).eq("activity_id",e).eq("source","share").maybeSingle();if(o)throw o;return!!r},enabled:!!t&&!!e})},M=()=>m({queryKey:["globalShareCouponTemplate"],queryFn:async()=>{const{data:e,error:t}=await n.from("coupon_templates").select("*").is("activity_id",null).eq("is_active",!0).maybeSingle();if(t)throw t;return e}}),L=e=>m({queryKey:["queryCouponByCode",e],queryFn:async()=>{if(!e)return null;const{data:t,error:r}=await n.from("coupon_codes").select(`
          *,
          coupon_templates (*),
          user_coupons (
            id,
            user_id,
            claimed_at,
            used_at,
            source,
            claimed_email
          )
        `).eq("code",e.trim().toUpperCase()).maybeSingle();if(r)throw r;if(!t)return null;const o=t.user_coupons?.filter(i=>i.user_id).map(i=>i.user_id)||[];let s={};if(o.length>0){const{data:i}=await n.rpc("get_public_profiles",{user_ids:o});i&&(s=i.reduce((d,u)=>(d[u.id]={display_name:u.display_name},d),{}))}const p=t.user_coupons?.map(i=>({...i,profiles:i.user_id&&s[i.user_id]||null}))||[];return{...t,user_coupons:p}},enabled:!!e&&e.trim().length>0}),U=()=>{const{user:e}=g(),{toast:t}=v(),r=_();return f({mutationFn:async({templateId:o,activityId:s,source:p="share"})=>{if(!e)throw new Error("User not authenticated");const i=e.email;if(p==="share"&&i&&s){const{data:l}=await n.from("user_coupons").select("id").eq("claimed_email",i).eq("activity_id",s).eq("source","share").maybeSingle();if(l)throw new Error("EMAIL_ALREADY_CLAIMED")}const{data:d,error:u}=await n.rpc("generate_coupon_code",{template_id_param:o});if(u)throw u;const q=d,{data:y,error:w}=await n.from("coupon_codes").insert({template_id:o,code:q,usage_limit:1,used_count:0,is_active:!0}).select().single();if(w)throw w;const{data:h,error:a}=await n.from("user_coupons").insert({user_id:e.id,coupon_code_id:y.id,activity_id:s||null,source:p,claimed_email:i||null}).select().single();if(a)throw a;return{userCoupon:h,couponCode:y}},onSuccess:(o,s)=>{r.invalidateQueries({queryKey:["userCoupons"]}),s.activityId&&r.invalidateQueries({queryKey:["hasSharedCoupon",s.activityId]}),t({title:c.t("coupon.claimSuccess"),description:c.t("coupon.claimSuccessDescription")})},onError:o=>{const s=o?.message?.includes("user_coupons_share_once_per_activity")||o?.message?.includes("idx_user_coupons_email")||o?.message==="EMAIL_ALREADY_CLAIMED"||o?.code==="23505";if(o?.message==="EMAIL_ALREADY_CLAIMED"){t({title:c.t("coupon.alreadyClaimed"),description:c.t("coupon.emailAlreadyClaimed"),variant:"destructive"});return}s||t({title:c.t("common.error"),description:o.message||"领取失败",variant:"destructive"})}})},x=()=>{const{toast:e}=v(),t=_();return f({mutationFn:async r=>{if(r.id){const{id:o,created_at:s,updated_at:p,...i}=r,{data:d,error:u}=await n.from("coupon_templates").update(i).eq("id",o).select().single();if(u)throw u;return d}else{const{id:o,created_at:s,updated_at:p,...i}=r,{data:d,error:u}=await n.from("coupon_templates").insert(i).select().single();if(u)throw u;return d}},onSuccess:()=>{t.invalidateQueries({queryKey:["couponTemplates"]}),e({title:c.t("common.success"),description:"优惠券模板保存成功"})},onError:r=>{e({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},R=()=>{const{toast:e}=v(),t=_();return f({mutationFn:async r=>{const{error:o}=await n.from("coupon_templates").delete().eq("id",r);if(o)throw o},onSuccess:()=>{t.invalidateQueries({queryKey:["couponTemplates"]}),e({title:c.t("common.success"),description:"优惠券模板删除成功"})},onError:r=>{e({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},H=e=>m({queryKey:["templateActivities",e],queryFn:async()=>{const{data:t,error:r}=await n.from("coupon_template_activities").select(`
          activity_id,
          activities (
            id,
            title_zh,
            title_en,
            title_pt,
            start_date,
            end_date,
            visible
          )
        `).eq("coupon_template_id",e);if(r)throw r;return t||[]},enabled:!!e}),I=()=>{const e=_(),{toast:t}=v();return f({mutationFn:async({templateId:r,activityId:o})=>{const{error:s}=await n.from("coupon_template_activities").insert({coupon_template_id:r,activity_id:o});if(s)throw s},onSuccess:(r,o)=>{e.invalidateQueries({queryKey:["templateActivities",o.templateId]}),e.invalidateQueries({queryKey:["activityCouponTemplates"]}),t({title:c.t("common.success"),description:"活动关联添加成功"})},onError:r=>{t({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},Y=()=>{const e=_(),{toast:t}=v();return f({mutationFn:async({templateId:r,activityId:o})=>{const{error:s}=await n.from("coupon_template_activities").delete().eq("coupon_template_id",r).eq("activity_id",o);if(s)throw s},onSuccess:(r,o)=>{e.invalidateQueries({queryKey:["templateActivities",o.templateId]}),e.invalidateQueries({queryKey:["activityCouponTemplates"]}),t({title:c.t("common.success"),description:"活动关联移除成功"})},onError:r=>{t({title:c.t("common.error"),description:r.message,variant:"destructive"})}})},z=e=>m({queryKey:["templateUsageHistory",e],queryFn:async()=>{if(!e)return[];const{data:t,error:r}=await n.from("coupon_codes").select("id").eq("template_id",e);if(r)throw r;if(!t||t.length===0)return[];const o=t.map(a=>a.id),{data:s,error:p}=await n.from("coupon_usage_history").select("*").in("coupon_code_id",o).order("used_at",{ascending:!1});if(p)throw p;if(!s||s.length===0)return[];const i=[...new Set(s.map(a=>a.used_by_user_id))],{data:d}=await n.from("profiles").select("id, display_name, avatar_url").in("id",i),u=(d||[]).reduce((a,l)=>(a[l.id]={display_name:l.display_name,avatar_url:l.avatar_url},a),{}),q=[...new Set(s.filter(a=>a.restaurant_id).map(a=>a.restaurant_id))];let y={};if(q.length>0){const{data:a}=await n.from("restaurants").select("id, name, name_en, name_pt").in("id",q);y=(a||[]).reduce((l,C)=>(l[C.id]={name:C.name,name_en:C.name_en,name_pt:C.name_pt},l),{})}const{data:w}=await n.from("coupon_codes").select("id, code").in("id",o),h=(w||[]).reduce((a,l)=>(a[l.id]=l.code,a),{});return s.map(a=>({...a,used_by_profile:u[a.used_by_user_id]||null,restaurant:a.restaurant_id&&y[a.restaurant_id]||null,coupon_code:h[a.coupon_code_id]||null}))},enabled:!!e});export{Q as a,M as b,U as c,D as d,x as e,K as f,R as g,H as h,I as i,Y as j,z as k,L as l,F as u};
//# sourceMappingURL=useCoupons-CH6UHKFT.js.map
