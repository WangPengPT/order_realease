import{j as e}from"./vendor-ui-DmpovMYY.js";import{r as o}from"./vendor-react-iAJ0IrSD.js";import{D as Q,aD as W,B as h,b as X,c as H,d as K,aA as R,bh as Y,m as Z,aV as G,aW as J,aX as ee,aY as se,aZ as V,X as L,W as te,bO as ae,L as T,a3 as g,s as u,b1 as re,v as i}from"./index-Bc-ZO2b2.js";import{P as oe}from"./PostCard-uQCcVBHo.js";import{c as le,d as ne,e as ie}from"./useCommunityPosts-D8W9k7TB.js";import{u as ce}from"./useActivities-Ba4YdxT4.js";import{u as me}from"./useLocalizedContent-BN2IWylL.js";import{u as $}from"./vendor-i18n-DxKeo2S1.js";import{P as de}from"./PullToRefresh-BDYBbPhW.js";import{u as ue}from"./vendor-query-D82cqPtt.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-6pZ9VDFn.js";import"./carousel-z4hM4yLh.js";const he=({trigger:c})=>{const{t:s}=$(),{getLocalizedField:p}=me(),x=le(),{data:j}=ce(),[P,l]=o.useState(!1),[m,I]=o.useState(""),[f,U]=o.useState([]),[y,k]=o.useState(null),[A,D]=o.useState(""),[S,v]=o.useState(!1),N=o.useRef(null),b=o.useRef(null),z=async t=>{const a=t.target.files;if(!(!a||a.length===0)){if(f.length+a.length>9){g.error(s("community.maxImages","最多上传9张图片"));return}v(!0);try{const{data:{user:r}}=await u.auth.getUser();if(!r)throw new Error("Not authenticated");const d=[];for(const n of Array.from(a)){const w=n.name.split(".").pop(),C=`${r.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${w}`,{error:E}=await u.storage.from("community-posts").upload(C,n);if(E)throw E;const{data:{publicUrl:M}}=u.storage.from("community-posts").getPublicUrl(C);d.push(M)}U(n=>[...n,...d])}catch(r){console.error("Upload error:",r),g.error(s("common.uploadError","上传失败"))}finally{v(!1),N.current&&(N.current.value="")}}},_=async t=>{const a=t.target.files?.[0];if(a){if(a.size>100*1024*1024){g.error(s("community.videoTooLarge","视频不能超过100MB"));return}v(!0);try{const{data:{user:r}}=await u.auth.getUser();if(!r)throw new Error("Not authenticated");const d=a.name.split(".").pop(),n=`${r.id}/${Date.now()}.${d}`,{error:w}=await u.storage.from("community-posts").upload(n,a);if(w)throw w;const{data:{publicUrl:C}}=u.storage.from("community-posts").getPublicUrl(n);k(C)}catch(r){console.error("Upload error:",r),g.error(s("common.uploadError","上传失败"))}finally{v(!1),b.current&&(b.current.value="")}}},q=t=>{U(a=>a.filter((r,d)=>d!==t))},B=()=>{k(null)},O=async()=>{if(!m.trim()){g.error(s("community.contentRequired","请输入内容"));return}await x.mutateAsync({content:m,image_urls:f,video_url:y||void 0,activity_id:A||void 0}),I(""),U([]),k(null),D(""),l(!1)},F=j?.filter(t=>t.status==="published")||[];return e.jsxs(Q,{open:P,onOpenChange:l,children:[e.jsx(W,{asChild:!0,children:c||e.jsx(h,{children:s("community.createPost","发布帖子")})}),e.jsxs(X,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(H,{children:e.jsx(K,{children:s("community.createPost","发布帖子")})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:s("community.content","内容")}),e.jsx(Y,{value:m,onChange:t=>I(t.target.value),placeholder:s("community.contentPlaceholder","分享你的想法..."),rows:4,className:"resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),s("community.linkActivity","关联活动")]}),e.jsxs(G,{value:A||"none",onValueChange:t=>D(t==="none"?"":t),children:[e.jsx(J,{children:e.jsx(ee,{placeholder:s("community.selectActivity","选择活动（可选）")})}),e.jsxs(se,{children:[e.jsx(V,{value:"none",children:s("community.noActivity","不关联活动")}),F.map(t=>e.jsx(V,{value:t.id,children:p(t,"title")},t.id))]})]})]}),f.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:f.map((t,a)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden",children:[e.jsx("img",{src:t,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>q(a),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(L,{className:"h-3 w-3"})})]},a))}),y&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:y,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:B,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(L,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:N,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:z}),e.jsx("input",{ref:b,type:"file",accept:"video/*",className:"hidden",onChange:_}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:()=>N.current?.click(),disabled:S||f.length>=9,children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),s("community.addImage","添加图片")]}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:()=>b.current?.click(),disabled:S||!!y,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),s("community.addVideo","添加视频")]}),S&&e.jsx(T,{className:"h-4 w-4 animate-spin"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(h,{variant:"outline",onClick:()=>l(!1),children:s("common.cancel","取消")}),e.jsxs(h,{onClick:O,disabled:x.isPending||!m.trim(),children:[x.isPending&&e.jsx(T,{className:"h-4 w-4 mr-2 animate-spin"}),s("community.publish","发布")]})]})]})]})]})},ke=()=>{const{t:c}=$(),s=ue(),{data:p,isLoading:x}=ne({status:"approved"}),{data:j}=ie(),P=o.useCallback(async()=>{await s.invalidateQueries({queryKey:["community-posts"]})},[s]);return e.jsx(de,{onRefresh:P,children:e.jsxs("div",{className:"container max-w-2xl mx-auto py-6 px-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:c("nav.community","社区")}),j&&e.jsx(he,{trigger:e.jsxs(h,{children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),c("community.createPost","发布帖子")]})})]}),e.jsx("div",{className:"space-y-4",children:x?Array.from({length:3}).map((l,m)=>e.jsxs("div",{className:"rounded-lg border p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(i,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"h-4 w-24"}),e.jsx(i,{className:"h-3 w-16"})]})]}),e.jsx(i,{className:"h-20 w-full"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(i,{className:"h-8 w-16"}),e.jsx(i,{className:"h-8 w-16"}),e.jsx(i,{className:"h-8 w-16"})]})]},m)):p&&p.length>0?p.map(l=>e.jsx(oe,{post:l},l.id)):e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx("p",{children:c("community.noPosts","暂无帖子")}),j&&e.jsx("p",{className:"mt-2",children:c("community.beFirst","成为第一个发帖的人吧！")})]})})]})})};export{ke as default};
//# sourceMappingURL=Community-Dl5aeMnZ.js.map
