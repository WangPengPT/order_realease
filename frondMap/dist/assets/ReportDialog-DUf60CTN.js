import{c as ge,t as L,A as xe,y as p,s as J,af as ee,ai as re,u as ve,r as u,j as e,D as je,ad as ye,B as w,d as Ce,e as we,f as _e,a9 as be,aa as I,aj as Ne,ak as Se,al as De,am as Ee,an as Ie,ao as Ue,I as K,X as Z,W as ke,Y as Ae,Z as Fe,$ as qe,a0 as Te,a1 as Pe,a2 as $e,a3 as Me,N as l}from"./index-tBrG_sQo.js";import{I as ze,a as He,b as z}from"./input-otp-D8cd1jdR.js";import{S as Qe}from"./shield-alert-CL6ZHph9.js";import{P as Ve}from"./plus-BnrcyCVr.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=ge("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),te=new Set,We=(d,j="restaurant",x)=>{const{user:n}=L();return xe({queryKey:["comments",d,j],enabled:(x==null?void 0:x.enabled)!==!1&&!!d,queryFn:async()=>{let r=p.from("comments").select("*").eq("target_id",d).eq("target_type",j).order("created_at",{ascending:!1});const{data:i,error:N}=await r;if(N)throw N;if(!i||i.length===0)return[];const y=i.filter(s=>s.moderation_status==="approved"||n&&s.user_id===n.id&&s.moderation_status==="pending"||n&&s.user_id===n.id&&s.moderation_status==="flagged"&&te.has(s.id)),U=[...new Set(y.map(s=>s.user_id))],{data:_}=await p.rpc("get_public_profiles",{user_ids:U}),m=new Map((_||[]).map(s=>[s.id,{display_name:s.display_name,avatar_url:s.avatar_url}])),f=y.filter(s=>!s.parent_id),C=y.filter(s=>s.parent_id),h=new Map;return C.forEach(s=>{const o=s.parent_id;h.has(o)||h.set(o,[]),h.get(o).push(s)}),f.map(s=>({...s,moderation_status:s.moderation_status,profiles:m.get(s.user_id),replies:(h.get(s.id)||[]).sort((o,A)=>new Date(o.created_at).getTime()-new Date(A.created_at).getTime()).map(o=>({...o,moderation_status:o.moderation_status,profiles:m.get(o.user_id)}))}))},staleTime:3e4})},Ge=()=>{const{user:d}=L(),{toast:j}=J(),x=ee();return re({mutationFn:async({targetId:n,targetType:r,content:i,ratingValue:N,priceRange:y,imageUrl:U,parentId:_})=>{if(!d)throw new Error("User not authenticated");const m={user_id:d.id,target_id:n,target_type:r,content:i,parent_id:_,moderation_status:"pending"};_||(N&&(m.rating_value=N),y&&(m.price_range=y)),U&&(m.image_url=U);const{data:f,error:C}=await p.from("comments").insert(m).select().single();if(C)throw C;try{const{data:h,error:v}=await p.functions.invoke("moderate-comment",{body:{comment_id:f.id,content:i,user_id:d.id,sensitive_word_detected:!1,target_id:n,target_type:r}});v?(console.error("AI moderation error:",v),await p.from("comments").update({moderation_status:"approved"}).eq("id",f.id)):h&&console.log("AI moderation result:",h)}catch(h){console.error("Failed to invoke AI moderation:",h),await p.from("comments").update({moderation_status:"approved"}).eq("id",f.id)}return f},onSuccess:(n,r)=>{n!=null&&n.id&&te.add(n.id),x.invalidateQueries({queryKey:["comments",r.targetId,r.targetType]}),x.invalidateQueries({queryKey:["restaurants"]}),x.invalidateQueries({queryKey:["restaurant",r.targetId]}),j({title:"评论已提交",description:"您的评论正在审核中，审核完成后会通知您结果"})},onError:()=>{j({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Xe=()=>{const{toast:d}=J(),j=ee();return re({mutationFn:async x=>{const{error:n}=await p.from("comments").delete().eq("id",x);if(n)throw n},onSuccess:()=>{j.invalidateQueries({queryKey:["comments"]}),d({title:"Success",description:"Comment deleted successfully"})},onError:()=>{d({title:"Error",description:"Failed to delete comment",variant:"destructive"})}})},Ye=({targetType:d,targetId:j,trigger:x,onLoginRequired:n})=>{const{t:r}=ve(),{user:i}=L(),[N,y]=u.useState(!1),[U,_]=u.useState(!1),[m,f]=u.useState(!1),[C,h]=u.useState(""),[v,s]=u.useState(""),[o,A]=u.useState((i==null?void 0:i.email)||""),[b,T]=u.useState([""]),[F,H]=u.useState([]),[O,R]=u.useState(!1),[Q,q]=u.useState("form"),[P,$]=u.useState(""),[S,V]=u.useState(0),[B,W]=u.useState(!1),se=t=>{if(t&&!i){n==null||n();return}y(t),t&&(i!=null&&i.email)&&A(i.email),t||(q("form"),$(""),V(0))};u.useEffect(()=>{let t;return S>0&&(t=setTimeout(()=>V(S-1),1e3)),()=>clearTimeout(t)},[S]);const ae=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],ie=()=>{T([...b,""])},oe=t=>{T(b.filter((a,c)=>c!==t))},ne=(t,a)=>{const c=[...b];c[t]=a,T(c)},le=t=>{const a=Array.from(t.target.files||[]);if(a.filter(g=>g.size>5*1024*1024).length>0){l.error(r("report.imageTooLarge"));return}const D=["image/jpeg","image/png","image/webp","image/gif"];if(a.filter(g=>!D.includes(g.type)).length>0){l.error(r("report.invalidImageType"));return}H(g=>[...g,...a])},ce=t=>{H(a=>a.filter((c,D)=>D!==t))},de=async()=>{if(F.length===0)return[];R(!0);const t=[];try{for(const a of F){const c=a.name.split(".").pop(),E=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${c}`}`,{error:g}=await p.storage.from("report-evidence").upload(E,a);if(g)throw g;const{data:M}=p.storage.from("report-evidence").getPublicUrl(E);t.push(M.publicUrl)}return t}catch(a){throw console.error("Error uploading images:",a),a}finally{R(!1)}},G=async()=>{if(!o.trim()){l.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)){l.error(r("report.invalidEmail"));return}W(!0);try{const{error:t}=await p.functions.invoke("send-verification-code",{body:{email:o}});if(t){l.error(r("auth.verificationCodeFailed")),console.error(t);return}q("verify"),l.success(r("auth.verificationCodeSent")),V(30)}catch(t){l.error(t.message||r("error.general"))}finally{W(!1)}},me=async()=>{S>0||await G()},ue=async()=>{if(P.length!==4){l.error(r("auth.invalidVerificationCode"));return}f(!0);try{const{data:t,error:a}=await p.functions.invoke("verify-email-code",{body:{email:o,code:P}});if(a||!(t!=null&&t.success)){(t==null?void 0:t.error)==="This verification code has already been used"?l.error(r("auth.verificationCodeUsed")):l.error((t==null?void 0:t.error)||r("auth.invalidVerificationCode")),f(!1);return}q("submitting"),await X()}catch(t){l.error(t.message||r("error.general")),f(!1)}},pe=async()=>{if(!C){l.error(r("report.reasonPlaceholder"));return}if(!v||v.length<20){l.error(r("report.detailsMin"));return}if(!o.trim()){l.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)){l.error(r("report.invalidEmail"));return}if(b.filter(a=>a.trim()!=="").length===0&&F.length===0){l.error(r("report.evidenceRequired"));return}i?_(!0):await G()},X=async()=>{f(!0);try{let t=[];try{t=await de()}catch{l.error(r("report.imageUploadFailed")),f(!1);return}const c=[...b.filter(k=>k.trim()!==""),...t],D={reporter_id:(i==null?void 0:i.id)||null,target_type:d,target_id:j,reason:C,description:v,evidence_urls:c,reporter_contact:o};console.log("Attempting to insert report:",D);const{data:E,error:g}=await p.from("reports").insert(D).select().single();if(console.log("Insert result:",{report:E,error:g}),g)throw g;let M="Anonymous",Y=o;if(i){const{data:k}=await p.from("profiles").select("display_name").eq("id",i.id).single();M=(k==null?void 0:k.display_name)||"Unknown",Y=i.email||o}await p.functions.invoke("send-report-email",{body:{reportId:E.id,reporterName:M,reporterEmail:Y,targetType:d,targetId:j,reason:C,description:v,evidenceUrls:c.length>0?c:void 0,reporterContact:o||void 0}});const he=E.id.substring(0,8).toUpperCase();l.success(r("report.successDetailed",{reference:he}),{description:r("report.successDescription"),duration:8e3}),y(!1),_(!1),h(""),s(""),i||A(""),T([""]),H([]),q("form"),$("")}catch(t){console.error("Error submitting report:",t),l.error(r("report.failed"))}finally{f(!1)}},fe=()=>{switch(d){case"comment":return r("report.reportComment");case"restaurant":return r("report.reportRestaurant");case"activity":return r("report.reportActivity");case"user":return r("report.reportUser");default:return r("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(je,{open:N,onOpenChange:se,children:[e.jsx(ye,{asChild:!0,children:x||e.jsxs(w,{variant:"ghost",size:"sm",children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),r("report.title")]})}),e.jsxs(Ce,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(we,{children:[e.jsx(_e,{children:fe()}),e.jsx(be,{children:r(Q==="verify"?"auth.verificationCodeSent":"report.description")})]}),Q==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"reason",children:r("report.reason")}),e.jsxs(Ne,{value:C,onValueChange:h,children:[e.jsx(Se,{children:e.jsx(De,{placeholder:r("report.reasonPlaceholder")})}),e.jsx(Ee,{children:ae.map(t=>e.jsx(Ie,{value:t,children:r(`report.reasons.${t}`)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"description",children:r("report.detailsLabel")}),e.jsx(Ue,{id:"description",value:v,onChange:t=>s(t.target.value),placeholder:r("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[v.length,"/20 ",r("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(I,{htmlFor:"contact",children:[r("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(K,{id:"contact",type:"email",value:o,onChange:t=>A(t.target.value),placeholder:r("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(I,{children:[r("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:r("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"image-upload",className:"text-sm font-medium",children:r("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:F.map((t,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Evidence ${a+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(w,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>ce(a),children:e.jsx(Z,{className:"w-3 h-3"})})]},a))}),e.jsx(K,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:le,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(I,{className:"text-sm font-medium",children:r("report.evidenceUrls")}),b.map((t,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{value:t,onChange:c=>ne(a,c.target.value),placeholder:r("report.evidencePlaceholder")}),b.length>1&&e.jsx(w,{variant:"ghost",size:"icon",onClick:()=>oe(a),children:e.jsx(Z,{className:"w-4 h-4"})})]},a)),e.jsxs(w,{variant:"outline",size:"sm",onClick:ie,className:"w-full",children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),r("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(w,{variant:"outline",onClick:()=>y(!1),children:r("report.cancel")}),e.jsx(w,{onClick:pe,disabled:!C||v.length<20||!o.trim()||b.filter(t=>t.trim()!=="").length===0&&F.length===0||O||B,children:r(O?"common.uploading":B?"auth.sendingCode":"report.submit")})]})]}):Q==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:r("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:r("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx(ze,{maxLength:4,value:P,onChange:t=>$(t),children:e.jsxs(He,{children:[e.jsx(z,{index:0}),e.jsx(z,{index:1}),e.jsx(z,{index:2}),e.jsx(z,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:r("auth.verificationCodeHint",{email:o})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(w,{variant:"link",size:"sm",onClick:me,disabled:S>0||m,children:S>0?`${r("auth.resendCode")} (${S}s)`:r("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",className:"w-full",onClick:()=>{q("form"),$("")},disabled:m,children:r("common.back")}),e.jsx(w,{className:"w-full",onClick:ue,disabled:P.length!==4||m,children:r(m?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(ke,{open:U,onOpenChange:_,children:e.jsxs(Ae,{children:[e.jsxs(Fe,{children:[e.jsx(qe,{children:r("report.confirmTitle")}),e.jsx(Te,{children:r("report.confirmMessage")})]}),e.jsxs(Pe,{children:[e.jsx($e,{children:r("report.cancel")}),e.jsx(Me,{onClick:X,disabled:m,children:r(m?"report.submitting":"report.submit")})]})]})})]})};export{Be as D,Ye as R,Ge as a,Xe as b,We as u};
