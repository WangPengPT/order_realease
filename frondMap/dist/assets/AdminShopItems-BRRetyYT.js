import{j as e}from"./vendor-ui-DAmPMpEA.js";import{r as _}from"./vendor-react-iAJ0IrSD.js";import{D as K,a as Q,b as X,d as Y,a6 as I,a7 as z,a8 as A,a9 as F,aa as x,I as v,ab as E,B as f,s as Z,y,C as ee,j as se,t as ne,k as ie,r as re,ag as te,J as ae,K as oe,N as le,O as ce,Q as de,R as me,T as he,V as pe}from"./index-Do1W_89N.js";import{T as xe,a as ue,b as O,c as u,d as je,e as j}from"./table-Bc8sHo2y.js";import{S as B}from"./switch-qzVpZlQq.js";import{u as R,a as _e,b as ge}from"./useShopItems-Btinl7k4.js";import{u as ve}from"./useLocalizedContent-tJ7i_ycU.js";import{u as fe}from"./index.esm-CVRqJy9l.js";import{o as ye,s as p,n as P,b as Ne,t as be}from"./types-CpDVS0Ep.js";import{F as Ce,a as l,b as c,c as d,d as m,e as h,f as L}from"./form-BnDjmcLX.js";import{u as U}from"./vendor-i18n-DxKeo2S1.js";import{P as V}from"./plus-D-VZe8Eb.js";import{P as H}from"./package-CXPU0Pej.js";import{G as Te}from"./grip-vertical-DBv79q-K.js";import{E as we}from"./eye-BYP9cNA5.js";import{E as ke}from"./eye-off-BdZXBMMx.js";import{S as De}from"./square-pen-jEvVvS5O.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-query-BlSVl3IQ.js";import"./vendor-supabase-KNAP0qdW.js";const Se=ye({item_type:p(),coupon_template_id:p().optional().nullable(),name_zh:p().min(1,"必填"),name_en:p().min(1,"Required"),name_pt:p().min(1,"Obrigatório"),description_zh:p().optional(),description_en:p().optional(),description_pt:p().optional(),image_url:p().optional(),points_cost:P().min(1,"积分必须大于0"),stock:P().optional().nullable(),per_user_limit:P().min(1,"限购次数必须大于0"),limit_refresh_period:p(),is_active:Ne()}),Ie=({open:n,onOpenChange:g,item:t})=>{const{t:r}=U(),N=R(),[k,D]=_.useState([]),[b,w]=_.useState(!1),a=fe({resolver:be(Se),defaultValues:{item_type:"coupon",coupon_template_id:null,name_zh:"",name_en:"",name_pt:"",description_zh:"",description_en:"",description_pt:"",image_url:"",points_cost:100,stock:null,per_user_limit:1,limit_refresh_period:"none",is_active:!0}});_.useEffect(()=>{n&&(async()=>{w(!0);try{const{data:o,error:T}=await Z.from("coupon_templates").select("id, title_zh, title_en, title_pt, discount_type, discount_value").eq("is_active",!0).order("title_en");if(T)throw T;D(o||[])}catch(o){console.error("Error loading templates:",o)}finally{w(!1)}})()},[n]),_.useEffect(()=>{t?a.reset({item_type:t.item_type,coupon_template_id:t.coupon_template_id,name_zh:t.name_zh,name_en:t.name_en,name_pt:t.name_pt,description_zh:t.description_zh||"",description_en:t.description_en||"",description_pt:t.description_pt||"",image_url:t.image_url||"",points_cost:t.points_cost,stock:t.stock,per_user_limit:t.per_user_limit,limit_refresh_period:t.limit_refresh_period,is_active:t.is_active}):a.reset({item_type:"coupon",coupon_template_id:null,name_zh:"",name_en:"",name_pt:"",description_zh:"",description_en:"",description_pt:"",image_url:"",points_cost:100,stock:null,per_user_limit:1,limit_refresh_period:"none",is_active:!0})},[t,a]);const S=async s=>{try{await N.mutateAsync({...t?.id?{id:t.id}:{},item_type:s.item_type,name_zh:s.name_zh,name_en:s.name_en,name_pt:s.name_pt,description_zh:s.description_zh,description_en:s.description_en,description_pt:s.description_pt,image_url:s.image_url,points_cost:s.points_cost,per_user_limit:s.per_user_limit,limit_refresh_period:s.limit_refresh_period,is_active:s.is_active,stock:s.stock||null,coupon_template_id:s.item_type==="coupon"?s.coupon_template_id:null}),y.success(t?r("admin.shop.updateSuccess","商品已更新"):r("admin.shop.createSuccess","商品已创建")),g(!1)}catch(o){console.error("Save error:",o),y.error(r("common.error","保存失败"))}},C=a.watch("item_type");return e.jsx(K,{open:n,onOpenChange:g,children:e.jsxs(Q,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(X,{children:e.jsx(Y,{children:t?r("admin.shop.editItem","编辑商品"):r("admin.shop.addItem","添加商品")})}),e.jsx(Ce,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(S),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(l,{control:a.control,name:"item_type",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.itemType","商品类型")}),e.jsxs(I,{onValueChange:s.onChange,value:s.value,children:[e.jsx(m,{children:e.jsx(z,{children:e.jsx(A,{})})}),e.jsxs(F,{children:[e.jsx(x,{value:"coupon",children:r("admin.shop.typeCoupon","优惠券")}),e.jsx(x,{value:"physical",children:r("admin.shop.typePhysical","实物商品")}),e.jsx(x,{value:"badge",children:r("admin.shop.typeBadge","徽章")})]})]}),e.jsx(h,{})]})}),C==="coupon"&&e.jsx(l,{control:a.control,name:"coupon_template_id",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.couponTemplate","优惠券模板")}),e.jsxs(I,{onValueChange:s.onChange,value:s.value||"",disabled:b,children:[e.jsx(m,{children:e.jsx(z,{children:e.jsx(A,{placeholder:r("admin.shop.selectTemplate","选择模板")})})}),e.jsx(F,{children:k.map(o=>e.jsxs(x,{value:o.id,children:[o.title_zh," (",o.discount_type==="percentage"?`${o.discount_value}%`:`€${o.discount_value}`,")"]},o.id))})]}),e.jsx(h,{})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:r("admin.shop.itemName","商品名称")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{control:a.control,name:"name_zh",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"中文"}),e.jsx(m,{children:e.jsx(v,{...s})}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"name_en",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"English"}),e.jsx(m,{children:e.jsx(v,{...s})}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"name_pt",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Português"}),e.jsx(m,{children:e.jsx(v,{...s})}),e.jsx(h,{})]})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:r("admin.shop.itemDescription","商品描述")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{control:a.control,name:"description_zh",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"中文"}),e.jsx(m,{children:e.jsx(E,{...s,rows:2})}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"description_en",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"English"}),e.jsx(m,{children:e.jsx(E,{...s,rows:2})}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"description_pt",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:"Português"}),e.jsx(m,{children:e.jsx(E,{...s,rows:2})}),e.jsx(h,{})]})})]})]}),e.jsx(l,{control:a.control,name:"image_url",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.imageUrl","商品图片URL")}),e.jsx(m,{children:e.jsx(v,{...s,placeholder:"https://..."})}),e.jsx(L,{children:r("admin.shop.imageUrlHelp","可选，留空则显示默认图标")}),e.jsx(h,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(l,{control:a.control,name:"points_cost",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.pointsCost","所需积分")}),e.jsx(m,{children:e.jsx(v,{type:"number",...s,onChange:o=>s.onChange(parseInt(o.target.value)||0)})}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"stock",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.stock","库存")}),e.jsx(m,{children:e.jsx(v,{type:"number",placeholder:r("admin.shop.unlimited","无限"),value:s.value??"",onChange:o=>s.onChange(o.target.value?parseInt(o.target.value):null)})}),e.jsx(L,{children:r("admin.shop.stockHelp","留空表示无限")}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"per_user_limit",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.perUserLimit","每人限购")}),e.jsx(m,{children:e.jsx(v,{type:"number",...s,onChange:o=>s.onChange(parseInt(o.target.value)||1)})}),e.jsx(h,{})]})}),e.jsx(l,{control:a.control,name:"limit_refresh_period",render:({field:s})=>e.jsxs(c,{children:[e.jsx(d,{children:r("admin.shop.refreshPeriod","刷新周期")}),e.jsxs(I,{onValueChange:s.onChange,value:s.value,children:[e.jsx(m,{children:e.jsx(z,{children:e.jsx(A,{})})}),e.jsxs(F,{children:[e.jsx(x,{value:"none",children:r("admin.shop.periodNone","永久")}),e.jsx(x,{value:"daily",children:r("admin.shop.periodDaily","每日")}),e.jsx(x,{value:"weekly",children:r("admin.shop.periodWeekly","每周")}),e.jsx(x,{value:"monthly",children:r("admin.shop.periodMonthly","每月")})]})]}),e.jsx(h,{})]})})]}),e.jsx(l,{control:a.control,name:"is_active",render:({field:s})=>e.jsxs(c,{className:"flex items-center justify-between rounded-lg border p-4",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(d,{children:r("admin.shop.isActive","上架状态")}),e.jsx(L,{children:r("admin.shop.isActiveHelp","下架后用户将无法在商店中看到此商品")})]}),e.jsx(m,{children:e.jsx(B,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>g(!1),children:r("common.cancel","取消")}),e.jsx(f,{type:"submit",disabled:N.isPending,children:N.isPending?r("common.saving","保存中..."):r("common.save","保存")})]})]})})]})})},Ye=()=>{const{t:n}=U(),{getLocalizedField:g}=ve(),{data:t,isLoading:r}=_e(),N=R(),k=ge(),[D,b]=_.useState(!1),[w,a]=_.useState(null),[S,C]=_.useState(!1),[s,o]=_.useState(null),T=()=>{a(null),b(!0)},q=i=>{a(i),b(!0)},M=i=>{o(i),C(!0)},W=async()=>{if(s)try{await k.mutateAsync(s.id),y.success(n("admin.shop.deleteSuccess","商品已删除"))}catch{y.error(n("admin.shop.deleteFailed","删除失败"))}C(!1),o(null)},$=async i=>{try{await N.mutateAsync({...i,is_active:!i.is_active}),y.success(i.is_active?n("admin.shop.itemDeactivated","商品已下架"):n("admin.shop.itemActivated","商品已上架"))}catch{y.error(n("common.error","操作失败"))}},G=i=>{switch(i){case"coupon":return n("admin.shop.typeCoupon","优惠券");case"physical":return n("admin.shop.typePhysical","实物商品");case"badge":return n("admin.shop.typeBadge","徽章");default:return i}},J=i=>{switch(i){case"daily":return n("admin.shop.periodDaily","每日");case"weekly":return n("admin.shop.periodWeekly","每周");case"monthly":return n("admin.shop.periodMonthly","每月");case"none":return n("admin.shop.periodNone","永久");default:return i}};return r?e.jsx("div",{className:"p-6",children:n("common.loading")}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:n("admin.shop.title","积分商店管理")}),e.jsx("p",{className:"text-muted-foreground",children:n("admin.shop.description","管理积分商店中的商品")})]}),e.jsxs(f,{onClick:T,children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),n("admin.shop.addItem","添加商品")]})]}),e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),n("admin.shop.itemList","商品列表")]})}),e.jsx(ie,{children:t&&t.length>0?e.jsxs(xe,{children:[e.jsx(ue,{children:e.jsxs(O,{children:[e.jsx(u,{className:"w-12"}),e.jsx(u,{children:n("admin.shop.itemName","商品名称")}),e.jsx(u,{children:n("admin.shop.itemType","类型")}),e.jsx(u,{children:n("admin.shop.pointsCost","所需积分")}),e.jsx(u,{children:n("admin.shop.stock","库存")}),e.jsx(u,{children:n("admin.shop.limit","限购")}),e.jsx(u,{children:n("admin.shop.status","状态")}),e.jsx(u,{className:"text-right",children:n("common.actions","操作")})]})}),e.jsx(je,{children:t.map(i=>e.jsxs(O,{children:[e.jsx(j,{children:e.jsx(Te,{className:"h-4 w-4 text-muted-foreground cursor-grab"})}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[i.image_url?e.jsx("img",{src:i.image_url,alt:g(i,"name"),className:"w-10 h-10 rounded object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded bg-muted flex items-center justify-center",children:e.jsx(H,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:g(i,"name")}),e.jsx("div",{className:"text-sm text-muted-foreground line-clamp-1",children:g(i,"description")})]})]})}),e.jsx(j,{children:e.jsx(re,{variant:"outline",children:G(i.item_type)})}),e.jsx(j,{className:"font-medium",children:i.points_cost}),e.jsx(j,{children:i.stock===null?e.jsx("span",{className:"text-muted-foreground",children:n("admin.shop.unlimited","无限")}):e.jsx("span",{className:i.stock<=0?"text-destructive":"",children:i.stock})}),e.jsx(j,{children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[i.per_user_limit," ",n("admin.shop.times","次")]}),e.jsx("div",{className:"text-muted-foreground text-xs",children:J(i.limit_refresh_period)})]})}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{checked:i.is_active,onCheckedChange:()=>$(i)}),i.is_active?e.jsx(we,{className:"h-4 w-4 text-green-500"}):e.jsx(ke,{className:"h-4 w-4 text-muted-foreground"})]})}),e.jsx(j,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>q(i),children:e.jsx(De,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>M(i),children:e.jsx(te,{className:"h-4 w-4 text-destructive"})})]})})]},i.id))})]}):e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(H,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:n("admin.shop.noItems","暂无商品")}),e.jsxs(f,{variant:"outline",className:"mt-4",onClick:T,children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),n("admin.shop.addFirstItem","添加第一个商品")]})]})})]}),e.jsx(Ie,{open:D,onOpenChange:b,item:w}),e.jsx(ae,{open:S,onOpenChange:C,children:e.jsxs(oe,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:n("admin.shop.confirmDelete","确认删除")}),e.jsx(de,{children:n("admin.shop.deleteWarning","确定要删除这个商品吗？此操作无法撤销。")})]}),e.jsxs(me,{children:[e.jsx(he,{children:n("common.cancel","取消")}),e.jsx(pe,{onClick:W,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:n("common.delete","删除")})]})]})})]})};export{Ye as default};
//# sourceMappingURL=AdminShopItems-BRRetyYT.js.map
