import{c as X,u as B,j as s,D as Y,b as Z,d as ss,e as es,a6 as as,I as E,al as ns,B as j,G as f,r as u,C as T,l as w,w as S,m as C,v as rs,t as ts}from"./index-B9cY5t1p.js";import{T as P,a as D,b as y,c as o,d as _,e as c}from"./table-iSW2eeVe.js";import{T as is,a as os,b as F,c as H}from"./tabs-CsfMJY62.js";import{a as cs,b as ls}from"./usePoints-BvHtPm3H.js";import{u as ds}from"./index.esm-B0wqGTaE.js";import{o as ms,n as hs,s as xs,t as us}from"./types-fI2Nfy9l.js";import{F as ps,a as I,b as M,c as R,d as k,e as A}from"./form-BHzk0wsz.js";import{P as L}from"./plus-CFyGnb7B.js";import{C as $}from"./coins-BChzlX-c.js";import{U as js}from"./users-XuhtRWHh.js";import{H as G}from"./history-BRe2ycz8.js";import{S as U}from"./search-CXx_lIvB.js";import{f as fs}from"./format-BewYtBYJ.js";import"./startOfDay-DKu_CsZ5.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=X("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]),gs=ms({amount:hs().min(1,"积分数量必须大于0"),reason:xs().min(1,"请填写原因")}),ys=({open:a,onOpenChange:d,user:m,type:r})=>{const{t:n}=B(),h=cs(),x=ds({resolver:us(gs),defaultValues:{amount:10,reason:""}}),g=async t=>{if(!m)return;const p=r==="deduct"?-t.amount:t.amount;try{const l=await h.mutateAsync({userId:m.id,amount:p,reason:t.reason});l.success?(f.success(r==="grant"?n("admin.points.grantSuccess","积分发放成功"):n("admin.points.deductSuccess","积分扣除成功")),x.reset(),d(!1)):f.error(l.error||n("common.error","操作失败"))}catch(l){console.error("Error modifying points:",l),f.error(n("common.error","操作失败"))}};return m?s.jsx(Y,{open:a,onOpenChange:d,children:s.jsxs(Z,{children:[s.jsxs(ss,{children:[s.jsx(es,{className:"flex items-center gap-2",children:r==="grant"?s.jsxs(s.Fragment,{children:[s.jsx(L,{className:"h-5 w-5 text-green-500"}),n("admin.points.grantPoints","发放积分")]}):s.jsxs(s.Fragment,{children:[s.jsx(z,{className:"h-5 w-5 text-red-500"}),n("admin.points.deductPoints","扣除积分")]})}),s.jsxs(as,{children:[n("admin.points.targetUser","目标用户"),": ",s.jsx("strong",{children:m.display_name}),s.jsx("br",{}),n("admin.points.currentPoints","当前积分"),": ",s.jsx("strong",{children:m.points})]})]}),s.jsx(ps,{...x,children:s.jsxs("form",{onSubmit:x.handleSubmit(g),className:"space-y-4",children:[s.jsx(I,{control:x.control,name:"amount",render:({field:t})=>s.jsxs(M,{children:[s.jsx(R,{children:n("admin.points.amount","积分数量")}),s.jsx(k,{children:s.jsxs("div",{className:"relative",children:[s.jsx($,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(E,{type:"number",className:"pl-10",min:1,...t,onChange:p=>t.onChange(parseInt(p.target.value)||0)})]})}),s.jsx(A,{})]})}),s.jsx(I,{control:x.control,name:"reason",render:({field:t})=>s.jsxs(M,{children:[s.jsxs(R,{children:[n("admin.points.reason","原因/备注")," *"]}),s.jsx(k,{children:s.jsx(ns,{...t,placeholder:r==="grant"?n("admin.points.grantReasonPlaceholder","例如：活动奖励、补偿等"):n("admin.points.deductReasonPlaceholder","例如：违规处罚、订单取消等"),rows:3})}),s.jsx(A,{})]})}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(j,{type:"button",variant:"outline",onClick:()=>d(!1),children:n("common.cancel","取消")}),s.jsx(j,{type:"submit",disabled:h.isPending,variant:r==="deduct"?"destructive":"default",children:h.isPending?n("common.processing","处理中..."):r==="grant"?n("admin.points.confirmGrant","确认发放"):n("admin.points.confirmDeduct","确认扣除")})]})]})})]})}):null},Rs=()=>{const{t:a}=B(),{data:d,isLoading:m}=ls(),[r,n]=u.useState(""),[h,x]=u.useState([]),[g,t]=u.useState(!1),[p,l]=u.useState(!1),[Q,N]=u.useState(null),[V,v]=u.useState("grant"),b=async()=>{if(!r.trim()){f.error(a("admin.points.enterSearchTerm","请输入搜索关键词"));return}t(!0);try{const{data:e,error:i}=await rs.from("profiles").select("id, display_name, avatar_url, points").or(`display_name.ilike.%${r}%,id.eq.${r.match(/^[0-9a-f-]{36}$/i)?r:"00000000-0000-0000-0000-000000000000"}`).limit(20);if(i)throw i;x(e||[])}catch(e){console.error("Search error:",e),f.error(a("common.error","搜索失败"))}finally{t(!1)}},q=e=>{N(e),v("grant"),l(!0)},K=e=>{N(e),v("deduct"),l(!0)},O=e=>{switch(e){case"comment":return a("admin.points.typeComment","评论奖励");case"admin_grant":return a("admin.points.typeAdminGrant","管理员发放");case"admin_deduct":return a("admin.points.typeAdminDeduct","管理员扣除");case"purchase":return a("admin.points.typePurchase","积分兑换");case"refund":return a("admin.points.typeRefund","退款");case"expire":return a("admin.points.typeExpire","过期");default:return e}},J=(e,i)=>{const W=i>0;return s.jsx(ts,{variant:W?"default":"secondary",children:O(e)})};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold",children:a("admin.points.title","积分管理")}),s.jsx("p",{className:"text-muted-foreground",children:a("admin.points.description","管理用户积分，查看积分交易记录")})]}),s.jsxs(is,{defaultValue:"users",className:"space-y-4",children:[s.jsxs(os,{children:[s.jsxs(F,{value:"users",className:"flex items-center gap-2",children:[s.jsx(js,{className:"h-4 w-4"}),a("admin.points.userManagement","用户积分")]}),s.jsxs(F,{value:"history",className:"flex items-center gap-2",children:[s.jsx(G,{className:"h-4 w-4"}),a("admin.points.transactionHistory","交易记录")]})]}),s.jsx(H,{value:"users",className:"space-y-4",children:s.jsxs(T,{children:[s.jsx(w,{children:s.jsxs(S,{className:"flex items-center gap-2",children:[s.jsx(U,{className:"h-5 w-5"}),a("admin.points.searchUser","搜索用户")]})}),s.jsxs(C,{children:[s.jsxs("div",{className:"flex gap-2",children:[s.jsx(E,{placeholder:a("admin.points.searchPlaceholder","输入用户名或用户ID..."),value:r,onChange:e=>n(e.target.value),onKeyDown:e=>e.key==="Enter"&&b()}),s.jsxs(j,{onClick:b,disabled:g,children:[s.jsx(U,{className:"h-4 w-4 mr-2"}),a("common.search","搜索")]})]}),h.length>0&&s.jsx("div",{className:"mt-4",children:s.jsxs(P,{children:[s.jsx(D,{children:s.jsxs(y,{children:[s.jsx(o,{children:a("admin.points.user","用户")}),s.jsx(o,{children:a("admin.points.currentPoints","当前积分")}),s.jsx(o,{className:"text-right",children:a("common.actions","操作")})]})}),s.jsx(_,{children:h.map(e=>{var i;return s.jsxs(y,{children:[s.jsx(c,{children:s.jsxs("div",{className:"flex items-center gap-3",children:[e.avatar_url?s.jsx("img",{src:e.avatar_url,alt:e.display_name,className:"w-8 h-8 rounded-full object-cover"}):s.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center",children:(i=e.display_name)==null?void 0:i.charAt(0).toUpperCase()}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:e.display_name}),s.jsx("div",{className:"text-xs text-muted-foreground",children:e.id})]})]})}),s.jsx(c,{children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx($,{className:"h-4 w-4 text-amber-500"}),s.jsx("span",{className:"font-semibold",children:e.points})]})}),s.jsx(c,{className:"text-right",children:s.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.jsxs(j,{variant:"outline",size:"sm",onClick:()=>q(e),children:[s.jsx(L,{className:"h-4 w-4 mr-1"}),a("admin.points.grant","发放")]}),s.jsxs(j,{variant:"outline",size:"sm",onClick:()=>K(e),children:[s.jsx(z,{className:"h-4 w-4 mr-1"}),a("admin.points.deduct","扣除")]})]})})]},e.id)})})]})}),h.length===0&&r&&!g&&s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("admin.points.noResults","未找到匹配的用户")})]})]})}),s.jsx(H,{value:"history",children:s.jsxs(T,{children:[s.jsx(w,{children:s.jsxs(S,{className:"flex items-center gap-2",children:[s.jsx(G,{className:"h-5 w-5"}),a("admin.points.recentTransactions","最近交易记录")]})}),s.jsx(C,{children:m?s.jsx("div",{className:"text-center py-8",children:a("common.loading")}):d&&d.length>0?s.jsxs(P,{children:[s.jsx(D,{children:s.jsxs(y,{children:[s.jsx(o,{children:a("admin.points.time","时间")}),s.jsx(o,{children:a("admin.points.user","用户")}),s.jsx(o,{children:a("admin.points.type","类型")}),s.jsx(o,{children:a("admin.points.amount","变动")}),s.jsx(o,{children:a("admin.points.balance","余额")}),s.jsx(o,{children:a("admin.points.reason","原因")})]})}),s.jsx(_,{children:d.map(e=>{var i;return s.jsxs(y,{children:[s.jsx(c,{className:"text-sm",children:fs(new Date(e.created_at),"yyyy-MM-dd HH:mm")}),s.jsx(c,{children:s.jsx("div",{className:"font-medium",children:((i=e.profiles)==null?void 0:i.display_name)||e.user_id})}),s.jsx(c,{children:J(e.type,e.amount)}),s.jsx(c,{children:s.jsxs("span",{className:e.amount>0?"text-green-600":"text-red-600",children:[e.amount>0?"+":"",e.amount]})}),s.jsx(c,{children:e.balance_after}),s.jsx(c,{className:"text-sm text-muted-foreground max-w-[200px] truncate",children:e.reason||"-"})]},e.id)})})]}):s.jsx("div",{className:"text-center py-8 text-muted-foreground",children:a("admin.points.noTransactions","暂无交易记录")})})]})})]}),s.jsx(ys,{open:p,onOpenChange:l,user:Q,type:V})]})};export{Rs as default};
