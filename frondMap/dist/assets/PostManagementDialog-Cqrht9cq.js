import{p as T,j as e,cB as ae,be as y,bG as te,a_ as re,dO as ie,bb as q,aY as B,bu as $,q as ne,r as m,bS as le,cv as ce,c9 as de,bC as me,ek as oe,b0 as xe,aM as ue,w as E,cc as F,bR as he,c8 as ge,cg as je,bJ as fe,a4 as Ne}from"./vendor-react-87iFmKFJ.js";import{C as pe,B as h,n as ve,W as U,X as V,Y as Q,p as be,D as ye,c as we,d as _e,e as ke,$ as c,i as k,h as v,I as Ce,a8 as C,a9 as S,aa as A,ab as P,ac as b,s as Se}from"./index-C3xfGQgV.js";import{S as R}from"./separator-ZnoPDUxo.js";import{e as Ae}from"./useCommunityPosts-S0bg6xEn.js";import{u as Pe}from"./useActivities-CYv0-Emh.js";import{u as W}from"./useLocalizedContent-CFh79NZC.js";import{H as D,p as J,I as K,J as X}from"./vendor-utils-vwQGbBim.js";const Re=({post:s})=>{const{t:i,i18n:o}=T(),{getLocalizedField:t}=W(),w=()=>{switch(o.language){case"zh":return X;case"pt":return K;default:return J}},g=r=>{switch(r){case"easy":return"bg-green-500/20 text-green-700 dark:text-green-400 border-green-500/30";case"medium":return"bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 border-yellow-500/30";case"hard":return"bg-red-500/20 text-red-700 dark:text-red-400 border-red-500/30";default:return"bg-muted text-muted-foreground"}},x=r=>{switch(r){case"easy":return i("recipe.difficulty.easy","简单");case"medium":return i("recipe.difficulty.medium","中等");case"hard":return i("recipe.difficulty.hard","困难");default:return r}},j=t(s,"recipe_name")||s.recipe_name,f=s.image_urls&&s.image_urls.length>0,N=s.steps&&s.steps.length>0;return e.jsxs(pe,{className:"overflow-hidden",children:[f&&e.jsxs("div",{className:"relative aspect-video overflow-hidden",children:[e.jsx("img",{src:s.image_urls[0],alt:j||"",className:"w-full h-full object-cover"}),e.jsxs(h,{className:"absolute top-3 left-3 bg-primary text-primary-foreground gap-1",children:[e.jsx(ae,{className:"h-3 w-3"}),i("recipe.badge","食谱")]})]}),e.jsxs(ve,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsxs(U,{className:"h-10 w-10",children:[e.jsx(V,{src:s.author?.avatar_url||void 0}),e.jsx(Q,{children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.author?.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:D(new Date(s.created_at),{addSuffix:!0,locale:w()})})]})]}),e.jsx("h2",{className:"text-xl font-bold",children:j}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-3",children:[s.cook_time&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.cook_time," ",i("recipe.minutes","分钟")]})]}),s.servings&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.servings," ",i("recipe.servings","人份")]})]}),s.difficulty&&e.jsxs(h,{variant:"outline",className:g(s.difficulty),children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),x(s.difficulty)]})]})]}),e.jsxs(be,{className:"space-y-6",children:[s.content&&e.jsx("div",{children:e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:s.content})}),s.nutrition&&(s.nutrition.calories||s.nutrition.protein||s.nutrition.carbs||s.nutrition.fat)&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3 flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 text-primary"}),i("recipe.nutrition","营养信息")]}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[s.nutrition.calories&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-lg font-bold text-primary",children:s.nutrition.calories}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i("recipe.kcal","千卡")})]}),s.nutrition.protein&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.protein,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i("recipe.protein","蛋白质")})]}),s.nutrition.carbs&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.carbs,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i("recipe.carbs","碳水")})]}),s.nutrition.fat&&e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:[s.nutrition.fat,"g"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i("recipe.fat","脂肪")})]})]})]}),e.jsx(R,{}),s.ingredients&&s.ingredients.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3",children:[i("recipe.ingredients","食材")," (",s.ingredients.length,")"]}),e.jsx("ul",{className:"space-y-2",children:s.ingredients.map((r,l)=>e.jsx("li",{className:"flex flex-col text-sm py-1.5 border-b border-border/50 last:border-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:r.name}),e.jsxs("span",{className:"text-muted-foreground",children:[r.amount," ",r.unit]})]})},l))})]}),e.jsx(R,{}),N&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm mb-3",children:[i("recipe.steps","步骤")," (",s.steps.length,")"]}),e.jsx("ol",{className:"space-y-4",children:s.steps.sort((r,l)=>r.order-l.order).map((r,l)=>e.jsxs("li",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-xs font-bold",children:r.order}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("p",{className:"text-sm",children:r.description}),(()=>{const d=r.image_urls&&r.image_urls.length>0?r.image_urls:r.image_url?[r.image_url]:[];return d.length>0&&e.jsx("div",{className:`flex gap-2 ${d.length===1?"":"flex-wrap"}`,children:d.map((p,u)=>e.jsx("img",{src:p,alt:`Step ${r.order} - ${u+1}`,className:`rounded-lg max-h-48 object-cover ${d.length===1?"w-full":"w-[calc(50%-0.25rem)]"}`},u))})})()]})]},l))})]}),s.recipe_tags&&s.recipe_tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2",children:s.recipe_tags.map((r,l)=>e.jsxs(h,{variant:"secondary",className:"text-xs",children:["#",r]},l))}),e.jsxs("div",{className:"flex items-center gap-6 pt-4 border-t text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(q,{className:"h-4 w-4"}),s.likes_count||0]}),e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(B,{className:"h-4 w-4"}),s.comments_count||0]}),e.jsxs("span",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx($,{className:"h-4 w-4"}),s.shares_count||0]})]})]})]})},Fe=({post:s,open:i,onOpenChange:o})=>{const{t,i18n:w}=T(),{getLocalizedField:g}=W(),x=Ae(),{data:j}=Pe(),f=ne(),[N,r]=m.useState(0),[l,d]=m.useState("approved"),[p,u]=m.useState("pending"),[I,L]=m.useState(""),[z,H]=m.useState(!1);m.useEffect(()=>{s&&(r(s.weight),d(s.status),u(s.moderation_status),L(s.activity_id||""))},[s]);const Y=a=>a===null?"bg-gray-100 text-gray-600":a<=30?"bg-emerald-100 text-emerald-700":a<=60?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700",G=async()=>{if(s){H(!0);try{const{error:a}=await Se.functions.invoke("moderate-post",{body:{post_id:s.id,content:s.content,user_id:s.author_id,image_urls:s.image_urls,video_url:s.video_url}});if(a)throw a;E.success(t("admin.moderation.reReviewSuccess","重新审核完成")),f.invalidateQueries({queryKey:["admin-community-posts"]}),f.invalidateQueries({queryKey:["community-post"]})}catch(a){console.error("Re-moderation error:",a),E.error(t("admin.moderation.reReviewError","重新审核失败"))}finally{H(!1)}}},M=()=>{switch(w.language){case"zh":return X;case"pt":return K;default:return J}},O=async()=>{s&&(await x.mutateAsync({id:s.id,weight:N,status:l,moderation_status:p,activity_id:I||null}),o(!1))};if(!s)return null;const Z=j?.filter(a=>a.status==="published")||[],ee=a=>{switch(a){case"approved":return{icon:je,label:t("admin.status.approved","已发布"),className:"text-emerald-600"};case"pending":return{icon:y,label:t("admin.status.pending","待审核"),className:"text-amber-600"};case"rejected":return{icon:ge,label:t("admin.status.rejected","已拒绝"),className:"text-red-600"};case"hidden":return{icon:he,label:t("admin.status.hidden","已隐藏"),className:"text-gray-500"};default:return{icon:F,label:a,className:"text-gray-500"}}},se=a=>{switch(a){case"approved":return{icon:Ne,label:t("admin.moderation.approved","通过"),className:"text-emerald-600"};case"flagged":return{icon:fe,label:t("admin.moderation.flagged","标记"),className:"text-orange-500"};case"pending":return{icon:y,label:t("admin.moderation.pending","待审"),className:"text-gray-500"};default:return{icon:F,label:a,className:"text-gray-500"}}};return e.jsx(ye,{open:i,onOpenChange:o,children:e.jsxs(we,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(_e,{className:"pb-4 border-b",children:e.jsx(ke,{className:"text-xl",children:t("admin.communityPosts.manage","管理帖子")})}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gradient-to-r from-muted/50 to-muted/30 rounded-xl",children:[e.jsxs(U,{className:"h-14 w-14 ring-2 ring-background shadow-md",children:[e.jsx(V,{src:s.author?.avatar_url||void 0}),e.jsx(Q,{className:"bg-primary/10 text-primary font-semibold text-lg",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-lg",children:s.author?.display_name}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1.5",children:[e.jsx(y,{className:"h-3.5 w-3.5"}),D(new Date(s.created_at),{addSuffix:!0,locale:M()})]})]})]}),s.post_type==="recipe"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm font-medium",children:t("admin.communityPosts.content","内容")}),e.jsx(Re,{post:s})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm font-medium",children:t("admin.communityPosts.content","内容")}),e.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert p-4 border rounded-xl bg-muted/20",dangerouslySetInnerHTML:{__html:g(s,"content")?.replace(/\n/g,"<br>")||""}})]}),s.image_urls&&s.image_urls.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm font-medium",children:t("admin.communityPosts.images","图片")}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:s.image_urls.map((a,n)=>e.jsx("div",{className:"aspect-square rounded-xl overflow-hidden border shadow-sm hover:shadow-md transition-shadow",children:e.jsx("img",{src:a,alt:"",className:"w-full h-full object-cover"})},n))})]}),s.video_url&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm font-medium",children:t("admin.communityPosts.video","视频")}),e.jsx("video",{src:s.video_url,controls:!0,className:"w-full max-h-48 rounded-xl border shadow-sm",preload:"metadata"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/30 rounded-xl flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(le,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:s.views_count||0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.views","浏览")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(q,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium",children:s.likes_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.likes","赞")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx(B,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium",children:s.comments_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.comments","评论")})]}),e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-background rounded-lg shadow-sm",children:[e.jsx($,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium",children:s.shares_count}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("community.shares","分享")})]})]}),(s.risk_score!==null||s.ai_reviewed_at)&&e.jsxs("div",{className:"space-y-3 p-4 bg-muted/30 rounded-xl border border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(c,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4"}),t("admin.moderation.aiResult","AI审核结果")]}),e.jsxs(k,{size:"sm",variant:"ghost",onClick:G,disabled:z,className:"h-7 text-xs",children:[e.jsx(de,{className:v("h-3.5 w-3.5 mr-1",z&&"animate-spin")}),t("admin.moderation.reReview","重审")]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(h,{className:v("text-sm",Y(s.risk_score)),children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1"}),t("admin.moderation.riskScore","风险分数"),": ",s.risk_score??"-"]}),s.ai_reviewed_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:D(new Date(s.ai_reviewed_at),{addSuffix:!0,locale:M()})})]}),s.risk_reasons&&s.risk_reasons.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.risk_reasons.map((a,n)=>e.jsx(h,{variant:"outline",className:"text-xs whitespace-pre-wrap",children:a},n))})]}),e.jsx(R,{}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),t("admin.communityPosts.weight","权重")]}),e.jsx(Ce,{type:"number",value:N,onChange:a=>r(parseInt(a.target.value)||0),min:0,max:1e3,className:"h-10"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.communityPosts.weightHint","权重越高，帖子排序越靠前")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),t("admin.communityPosts.linkActivity","关联活动")]}),e.jsxs(C,{value:I||"none",onValueChange:a=>L(a==="none"?"":a),children:[e.jsx(S,{className:"h-10",children:e.jsx(A,{placeholder:t("community.selectActivity","选择活动（可选）")})}),e.jsxs(P,{children:[e.jsx(b,{value:"none",children:t("community.noActivity","不关联活动")}),Z.map(a=>e.jsx(b,{value:a.id,children:g(a,"title")},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm font-medium",children:t("admin.communityPosts.status","状态")}),e.jsxs(C,{value:l,onValueChange:d,children:[e.jsx(S,{className:"h-10",children:e.jsx(A,{})}),e.jsx(P,{children:["approved","pending","hidden","rejected"].map(a=>{const n=ee(a),_=n.icon;return e.jsx(b,{value:a,children:e.jsxs("span",{className:v("flex items-center gap-2",n.className),children:[e.jsx(_,{className:"h-4 w-4"}),n.label]})},a)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm font-medium",children:t("admin.communityPosts.moderation","审核状态")}),e.jsxs(C,{value:p,onValueChange:u,children:[e.jsx(S,{className:"h-10",children:e.jsx(A,{})}),e.jsx(P,{children:["pending","approved","flagged"].map(a=>{const n=se(a),_=n.icon;return e.jsx(b,{value:a,children:e.jsxs("span",{className:v("flex items-center gap-2",n.className),children:[e.jsx(_,{className:"h-4 w-4"}),n.label]})},a)})})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(k,{variant:"outline",onClick:()=>o(!1),className:"px-6",children:t("common.cancel","取消")}),e.jsxs(k,{onClick:O,disabled:x.isPending,className:"px-6",children:[x.isPending&&e.jsx(ue,{className:"h-4 w-4 mr-2 animate-spin"}),t("common.save","保存")]})]})]})})};export{Fe as P};
//# sourceMappingURL=PostManagementDialog-Cqrht9cq.js.map
