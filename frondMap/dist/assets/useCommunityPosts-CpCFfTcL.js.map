{"version":3,"file":"useCommunityPosts-CpCFfTcL.js","sources":["../../src/hooks/useCommunityPosts.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\nimport { useTranslation } from \"react-i18next\";\r\n\r\nexport interface CommunityPost {\r\n  id: string;\r\n  author_id: string;\r\n  content: string;\r\n  content_en: string | null;\r\n  content_zh: string | null;\r\n  content_pt: string | null;\r\n  image_urls: string[];\r\n  video_url: string | null;\r\n  weight: number;\r\n  activity_id: string | null;\r\n  status: string;\r\n  moderation_status: string;\r\n  likes_count: number;\r\n  comments_count: number;\r\n  shares_count: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  author?: {\r\n    id: string;\r\n    display_name: string;\r\n    avatar_url: string | null;\r\n  };\r\n  activity?: {\r\n    id: string;\r\n    title_en: string;\r\n    title_zh: string;\r\n    title_pt: string;\r\n  };\r\n  user_liked?: boolean;\r\n}\r\n\r\nexport const useCommunityPosts = (options?: { \r\n  authorId?: string; \r\n  status?: string;\r\n  limit?: number;\r\n}) => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"community-posts\", options],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from(\"community_posts\")\r\n        .select(`\r\n          *,\r\n          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),\r\n          activity:activities(id, title_en, title_zh, title_pt)\r\n        `)\r\n        .order(\"weight\", { ascending: false })\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (options?.authorId) {\r\n        query = query.eq(\"author_id\", options.authorId);\r\n      }\r\n\r\n      if (options?.status) {\r\n        query = query.eq(\"status\", options.status);\r\n      }\r\n\r\n      if (options?.limit) {\r\n        query = query.limit(options.limit);\r\n      }\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n\r\n      // Check if user has liked each post\r\n      if (user && data) {\r\n        const postIds = data.map((post) => post.id);\r\n        const { data: likes } = await supabase\r\n          .from(\"post_likes\")\r\n          .select(\"post_id\")\r\n          .eq(\"user_id\", user.id)\r\n          .in(\"post_id\", postIds);\r\n\r\n        const likedPostIds = new Set(likes?.map((l) => l.post_id) || []);\r\n\r\n        return data.map((post) => ({\r\n          ...post,\r\n          user_liked: likedPostIds.has(post.id),\r\n        })) as CommunityPost[];\r\n      }\r\n\r\n      return data as CommunityPost[];\r\n    },\r\n  });\r\n};\r\n\r\nexport const useCommunityPost = (postId: string) => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"community-post\", postId],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .select(`\r\n          *,\r\n          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),\r\n          activity:activities(id, title_en, title_zh, title_pt)\r\n        `)\r\n        .eq(\"id\", postId)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Check if user has liked\r\n      if (user) {\r\n        const { data: like } = await supabase\r\n          .from(\"post_likes\")\r\n          .select(\"id\")\r\n          .eq(\"post_id\", postId)\r\n          .eq(\"user_id\", user.id)\r\n          .maybeSingle();\r\n\r\n        return { ...data, user_liked: !!like } as CommunityPost;\r\n      }\r\n\r\n      return data as CommunityPost;\r\n    },\r\n    enabled: !!postId,\r\n  });\r\n};\r\n\r\nexport const useCreatePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (post: {\r\n      content: string;\r\n      image_urls?: string[];\r\n      video_url?: string;\r\n      activity_id?: string;\r\n    }) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .insert({\r\n          author_id: user.id,\r\n          content: post.content,\r\n          image_urls: post.image_urls || [],\r\n          video_url: post.video_url || null,\r\n          activity_id: post.activity_id || null,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      toast.success(t(\"community.postCreated\", \"帖子发布成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Create post error:\", error);\r\n      toast.error(t(\"community.postError\", \"发布失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useUpdatePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      id,\r\n      ...updates\r\n    }: {\r\n      id: string;\r\n      content?: string;\r\n      image_urls?: string[];\r\n      video_url?: string | null;\r\n      activity_id?: string | null;\r\n      weight?: number;\r\n      status?: string;\r\n      moderation_status?: string;\r\n    }) => {\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .update(updates)\r\n        .eq(\"id\", id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-community-posts\"] });\r\n      toast.success(t(\"common.saved\", \"保存成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Update post error:\", error);\r\n      toast.error(t(\"common.error\", \"操作失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useDeletePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (id: string) => {\r\n      const { error } = await supabase\r\n        .from(\"community_posts\")\r\n        .delete()\r\n        .eq(\"id\", id);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-community-posts\"] });\r\n      toast.success(t(\"common.deleted\", \"删除成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Delete post error:\", error);\r\n      toast.error(t(\"common.error\", \"操作失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useLikePost = () => {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ postId, liked }: { postId: string; liked: boolean }) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      if (liked) {\r\n        // Unlike\r\n        const { error } = await supabase\r\n          .from(\"post_likes\")\r\n          .delete()\r\n          .eq(\"post_id\", postId)\r\n          .eq(\"user_id\", user.id);\r\n\r\n        if (error) throw error;\r\n      } else {\r\n        // Like\r\n        const { error } = await supabase\r\n          .from(\"post_likes\")\r\n          .insert({\r\n            post_id: postId,\r\n            user_id: user.id,\r\n          });\r\n\r\n        if (error) throw error;\r\n      }\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n    },\r\n  });\r\n};\r\n\r\nexport const useSharePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (postId: string) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { error } = await supabase\r\n        .from(\"post_shares\")\r\n        .insert({\r\n          post_id: postId,\r\n          user_id: user.id,\r\n        });\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n      toast.success(t(\"community.shared\", \"分享成功\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useCanCreatePost = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"can-create-post\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return false;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"user_roles\")\r\n        .select(\"role\")\r\n        .eq(\"user_id\", user.id)\r\n        .single();\r\n\r\n      if (error) return false;\r\n      return [\"merchant\", \"supervisor\", \"admin\"].includes(data.role);\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\n\r\n// Admin hooks\r\nexport const useAdminCommunityPosts = (options?: {\r\n  status?: string;\r\n  moderation_status?: string;\r\n  search?: string;\r\n}) => {\r\n  return useQuery({\r\n    queryKey: [\"admin-community-posts\", options],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from(\"community_posts\")\r\n        .select(`\r\n          *,\r\n          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),\r\n          activity:activities(id, title_en, title_zh, title_pt)\r\n        `)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (options?.status) {\r\n        query = query.eq(\"status\", options.status);\r\n      }\r\n\r\n      if (options?.moderation_status) {\r\n        query = query.eq(\"moderation_status\", options.moderation_status);\r\n      }\r\n\r\n      if (options?.search) {\r\n        query = query.ilike(\"content\", `%${options.search}%`);\r\n      }\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n      return data as CommunityPost[];\r\n    },\r\n  });\r\n};\r\n"],"names":["useCommunityPosts","options","user","useAuth","useQuery","query","supabase","data","error","postIds","post","likes","likedPostIds","l","useCommunityPost","postId","like","useCreatePost","queryClient","useQueryClient","t","useTranslation","useMutation","toast","useUpdatePost","id","updates","useDeletePost","useLikePost","liked","useSharePost","useCanCreatePost","useAdminCommunityPosts"],"mappings":"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"}