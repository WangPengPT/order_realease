import{p as B,j as e,bL as oe,bK as te,bc as ce,ao as Ce,br as le,cz as de,q as me,v as Se,w as p,r as a,bS as J,b0 as Re,aM as ie,a4 as Pe,dL as _e,X as ae,bb as Ie,a_ as Ue,bg as Le,cU as Te,bX as re,dN as Ee,er as qe,b6 as Me,b5 as De}from"./vendor-react-uzPisSBl.js";import{D as Ae,a0 as Fe,c as $e,d as Oe,e as ze,s as w,h as O,M as Be,F as Ke,G as Qe,J as Ge,L as He,ad as Ve,a as We,u as Xe,S as z}from"./index-DMJMYAbQ.js";import{P as Je}from"./PostGridCard-B5xDZ2Vp.js";import{c as Ye}from"./usePoints-ZqBrb5ox.js";import{R as Ze,b as es,c as ss,M as ts,A as rs,d as is}from"./EditRecipeDialog-Qe6tA6HJ.js";import{P as ns}from"./progress-y4EccLw5.js";import{g as as,h as os,i as cs,u as ls,j as ds}from"./useCommunityPosts-ByYZQ9S7.js";import{u as ms}from"./useActivities-CoqYul82.js";import{u as us}from"./useRestaurants-yW4jMGnJ.js";import{u as ps}from"./useLocalizedContent-BCXwZ8Rh.js";import{P as hs}from"./PullToRefresh-B_sYL4et.js";import{u as xs}from"./useInfiniteScroll-CI5hIFAH.js";import{u as fs}from"./useLoginRequired-dq5y9iE8.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-vwQGbBim.js";import"./vendor-supabase-BoRSXImz.js";import"./drawer-CzD_8Roj.js";import"./popover-91qwUUr3.js";import"./collapsible-DtPzkxS0.js";const gs=()=>{const{t:r}=B(),{data:s}=Ye(),t=s?.find(c=>c.key==="post_points")?.value||"5",h=s?.find(c=>c.key==="min_post_length")?.value||"10",m=s?.find(c=>c.key==="post_require_media")?.value==="true";return e.jsxs(Ae,{children:[e.jsx(Fe,{asChild:!0,children:e.jsx("button",{className:"text-primary hover:underline text-sm whitespace-nowrap",children:r("community.viewPointsRules","查看详细规则")})}),e.jsxs($e,{className:"max-w-md",children:[e.jsx(Oe,{children:e.jsxs(ze,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5 text-primary"}),r("community.pointsRulesTitle","发帖积分规则")]})}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:r("community.pointsRulesIntro","通过发布社区帖子获得积分，具体规则如下：")}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:r("community.rulePostPoints",{points:t})})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:r("community.ruleMinLength",{length:h})})]}),m&&e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:r("community.ruleRequireMedia","帖子必须包含至少一张图片或一个视频")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(ce,{className:"h-4 w-4 text-blue-500 mt-0.5 shrink-0"}),e.jsx("span",{children:r("community.ruleDailyLimit","每天仅可通过发帖获得一次积分奖励")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ce,{className:"h-4 w-4 text-purple-500 mt-0.5 shrink-0"}),e.jsx("span",{children:r("community.ruleModerationRequired","帖子需通过审核后才能获得积分")})]})]})]})]})]})},ys=({onSelect:r})=>{const{t:s}=B();return e.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:s("community.selectPostType","选择发布类型")}),e.jsx("p",{className:"text-muted-foreground text-sm mb-8 text-center",children:s("community.selectPostTypeDesc","选择您想要发布的内容类型")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 w-full max-w-sm",children:[e.jsxs("button",{onClick:()=>r("post"),className:"flex flex-col items-center gap-3 p-6 rounded-xl border-2 border-border hover:border-primary hover:bg-primary/5 transition-all duration-200 group",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors",children:e.jsx(le,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium",children:s("community.postType.post","发布帖子")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s("community.postType.postDesc","分享美食体验和想法")})]})]}),e.jsxs("button",{onClick:()=>r("recipe"),className:"flex flex-col items-center gap-3 p-6 rounded-xl border-2 border-border hover:border-primary hover:bg-primary/5 transition-all duration-200 group",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors",children:e.jsx(de,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium",children:s("community.postType.recipe","发布食谱")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s("community.postType.recipeDesc","分享烹饪教程和菜谱")})]})]})]})]})},bs=()=>{const r=me(),{t:s}=B();return Se({mutationFn:async t=>{const{data:{user:h}}=await w.auth.getUser();if(!h)throw new Error("Not authenticated");let m;t.introduction?m=t.introduction:m="";const c=[];t.cover_image&&c.push(t.cover_image),t.steps.forEach(o=>{o.image_urls&&o.image_urls.length>0?o.image_urls.forEach(j=>c.push(j)):o.image_url&&c.push(o.image_url)});const{data:L,error:f}=await w.from("community_posts").insert({author_id:h.id,post_type:"recipe",content:m,image_urls:c,recipe_name:t.recipe_name,cook_time:t.cook_time,difficulty:t.difficulty,servings:t.servings,ingredients:t.ingredients,steps:t.steps,nutrition:t.nutrition?t.nutrition:null,recipe_tags:t.recipe_tags||null,recipe_category:t.recipe_category||null,status:"pending",moderation_status:"pending"}).select().single();if(f)throw f;try{await w.functions.invoke("moderate-post",{body:{post_id:L.id,content:m,user_id:h.id,image_urls:c}})}catch(o){console.error("Moderation call failed:",o)}return L},onSuccess:()=>{r.invalidateQueries({queryKey:["community-posts"]}),r.invalidateQueries({queryKey:["has-posted-today"]}),p.success(s("recipe.publishSuccess","食谱发布成功"))},onError:t=>{console.error("Create recipe error:",t),p.error(s("recipe.publishError","发布失败"))}})},js=({onClose:r,onSuccess:s})=>{const{t}=B(),h=bs(),[m,c]=a.useState(0),[L,f]=a.useState(null),[o,j]=a.useState({recipe_name:"",cook_time:void 0,difficulty:void 0,servings:void 0}),[v,D]=a.useState([{name:"",amount:"",unit:""}]),[A,k]=a.useState([{order:1,description:""}]),[g,F]=a.useState({}),[C,T]=a.useState(""),S=[{key:"basic",title:t("recipe.step.basic","基本信息")},{key:"ingredients",title:t("recipe.step.ingredients","配料")},{key:"steps",title:t("recipe.step.steps","步骤")}],R=(m+1)/S.length*100,N=()=>o.recipe_name?.trim()?!o.cook_time||o.cook_time<1?(p.error(t("recipe.cookTimeRequired","请输入烹饪时间")),!1):o.difficulty?!o.servings||o.servings<1?(p.error(t("recipe.servingsRequired","请输入份量")),!1):!0:(p.error(t("recipe.difficultyRequired","请选择难度")),!1):(p.error(t("recipe.nameRequired","请输入食谱名称")),!1),P=()=>v.filter(b=>b.name.trim()).length===0?(p.error(t("recipe.ingredientsRequired","请至少添加一种配料")),!1):!0,l=()=>A.filter(b=>b.description.trim()).length===0?(p.error(t("recipe.stepsRequired","请至少添加一个步骤")),!1):!0,_=()=>{m===0&&!N()||m===1&&!P()||c(y=>Math.min(y+1,S.length-1))},H=()=>{c(y=>Math.max(y-1,0))},I=async()=>{if(!l())return;const y=v.filter(U=>U.name.trim()),b=A.filter(U=>U.description.trim()).map((U,Z)=>({...U,order:Z+1})),Y=g.calories||g.protein||g.carbs||g.fat;try{await h.mutateAsync({recipe_name:o.recipe_name,cook_time:o.cook_time,difficulty:o.difficulty,servings:o.servings,ingredients:y,steps:b,cover_image:L,nutrition:Y?g:void 0,introduction:C.trim()||void 0}),s()}catch{}},K=()=>{switch(m){case 0:return e.jsx(ss,{data:o,coverImage:L,nutrition:g,introduction:C,onDataChange:j,onCoverImageChange:f,onNutritionChange:F,onIntroductionChange:T});case 1:return e.jsx(es,{ingredients:v,onChange:D});case 2:return e.jsx(Ze,{steps:A,onChange:k});default:return null}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-background shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("button",{type:"button",onClick:r,className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(J,{className:"h-5 w-5"})}),e.jsx("h2",{className:"font-medium",children:t("recipe.createTitle","创建食谱")}),e.jsx("div",{className:"w-6"})," "]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ns,{value:R,className:"h-1"}),e.jsx("div",{className:"flex justify-between text-xs text-muted-foreground",children:S.map((y,b)=>e.jsx("span",{className:b===m?"text-primary font-medium":"",children:y.title},y.key))})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:K()}),e.jsx("div",{className:"px-4 py-3 pb-[max(1rem,env(safe-area-inset-bottom))] border-t bg-background shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[m>0&&e.jsxs(O,{type:"button",variant:"outline",onClick:H,className:"flex-1",children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),t("common.back","上一步")]}),m<S.length-1?e.jsxs(O,{type:"button",onClick:_,className:"flex-1",children:[t("common.next","下一步"),e.jsx(Re,{className:"h-4 w-4 ml-2"})]}):e.jsxs(O,{type:"button",onClick:I,disabled:h.isPending,className:"flex-1",children:[h.isPending?e.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Pe,{className:"h-4 w-4 mr-2"}),t("recipe.publish","发布食谱")]})]})})]})},vs=({trigger:r})=>{const{t:s}=B(),{getLocalizedField:t}=ps(),h=as(),{data:m}=ms(),{data:c}=us(),{role:L,isMerchant:f,isAdmin:o,isSupervisor:j}=Be(),{data:v}=os(),{data:D,isLoading:A}=cs(),[k,g]=a.useState(!1),[F,C]=a.useState("selecting"),[T,S]=a.useState(""),[R,N]=a.useState([]),[P,l]=a.useState(null),[_,H]=a.useState(""),[I,K]=a.useState([]),[y,b]=a.useState(!1),[Y,U]=a.useState(!1),[Z,ne]=a.useState(!1),[ee,Q]=a.useState(!1),V=a.useRef(null),W=a.useRef(null),G=!f&&!j&&!o,X=o||j||f;a.useEffect(()=>{f&&v&&k&&K([v.id])},[f,v,k]);const se=()=>{C(X?"selecting":"post"),S(""),N([]),l(null),H(""),K([]),U(!1),ne(!1),Q(!1)};a.useEffect(()=>{k&&C(X?"selecting":"post")},[k,X]);const ue=i=>{g(i),i||se()},pe=m?.filter(i=>i.status==="published")||[],he=async i=>{const d=i.target.files;if(!(!d||d.length===0)){if(R.length+d.length>9){p.error(s("community.maxImages","最多上传9张图片"));return}b(!0);try{const{data:{user:x}}=await w.auth.getUser();if(!x)throw new Error("Not authenticated");const n=[];for(const u of Array.from(d)){const $=u.name.split(".").pop(),E=`${x.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${$}`,{error:q}=await w.storage.from("community-posts").upload(E,u);if(q)throw q;const{data:{publicUrl:M}}=w.storage.from("community-posts").getPublicUrl(E);n.push(M)}N(u=>[...u,...n])}catch(x){console.error("Upload error:",x),p.error(s("common.uploadError","上传失败"))}finally{b(!1),V.current&&(V.current.value="")}}},xe=i=>new Promise((d,x)=>{const n=document.createElement("video"),u=document.createElement("canvas"),$=u.getContext("2d");n.preload="auto",n.muted=!0,n.playsInline=!0;let E=!1;const q=()=>{E||n.videoWidth===0||n.videoHeight===0||(u.width=n.videoWidth,u.height=n.videoHeight,$&&($.drawImage(n,0,0,u.width,u.height),u.toBlob(M=>{M&&M.size>0?(E=!0,n.pause(),URL.revokeObjectURL(n.src),d(M)):x(new Error("Failed to create blob"))},"image/jpeg",.85)))};n.onloadedmetadata=()=>{u.width=n.videoWidth,u.height=n.videoHeight,n.currentTime=.1},n.onseeked=()=>{setTimeout(q,100)},n.onerror=()=>{URL.revokeObjectURL(n.src),x(new Error("Failed to load video"))},setTimeout(()=>{E||(URL.revokeObjectURL(n.src),x(new Error("Timeout")))},1e4),n.src=URL.createObjectURL(i),n.load()}),fe=async i=>{const d=i.target.files?.[0];if(d){if(d.size>100*1024*1024){p.error(s("community.videoTooLarge","视频不能超过100MB"));return}b(!0);try{const{data:{user:x}}=await w.auth.getUser();if(!x)throw new Error("Not authenticated");const n=d.name.split(".").pop(),u=`${x.id}/${Date.now()}.${n}`,{error:$}=await w.storage.from("community-posts").upload(u,d);if($)throw $;const{data:{publicUrl:E}}=w.storage.from("community-posts").getPublicUrl(u);l(E);try{p.info(s("community.extractingCover","正在提取视频封面..."));const q=await xe(d),M=`${x.id}/${Date.now()}-cover.jpg`,{error:Ne}=await w.storage.from("community-posts").upload(M,q);if(!Ne){const{data:{publicUrl:we}}=w.storage.from("community-posts").getPublicUrl(M);N(ke=>[we,...ke]),p.success(s("community.coverExtracted","封面已自动生成"))}}catch(q){console.warn("Cover extraction failed:",q)}}catch(x){console.error("Upload error:",x),p.error(s("common.uploadError","上传失败"))}finally{b(!1),W.current&&(W.current.value="")}}},ge=i=>{N(d=>d.filter((x,n)=>n!==i))},ye=()=>{l(null),N(i=>i.length>0&&i[0].includes("-cover.jpg")?i.slice(1):i)},be=async()=>{if(Q(!1),!T.trim()){p.error(s("community.contentRequired","请输入内容"));return}if(G&&I.length===0){Q(!0),p.error(s("community.restaurantRequired","请选择餐厅"));return}await h.mutateAsync({content:T,image_urls:R,video_url:P||void 0,activity_id:_||void 0,restaurant_ids:I.length>0?I:void 0}),se(),g(!1)},je=()=>v?t(v,"name"):s("community.noRestaurant","未关联餐厅"),ve=()=>{se(),g(!1)};return e.jsxs(Ke,{open:k,onOpenChange:ue,children:[e.jsx(Qe,{asChild:!0,children:r||e.jsx(O,{children:s("community.createPost","发布帖子")})}),e.jsxs(Ge,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(_e,{children:e.jsx(He,{children:s("community.createPost","发布帖子")})}),F==="selecting"&&e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>g(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(J,{className:"h-5 w-5"})}),e.jsx("span",{className:"font-medium",children:s("community.create","发布")}),e.jsx("div",{className:"w-6"})]}),e.jsx(ys,{onSelect:C})]}),F==="recipe"&&e.jsx(js,{onClose:()=>C("selecting"),onSuccess:ve}),F==="post"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>X?C("selecting"):g(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(J,{className:"h-5 w-5"})}),e.jsxs(O,{size:"sm",onClick:be,disabled:h.isPending||!T.trim(),className:"rounded-full px-6",children:[h.isPending&&e.jsx(ie,{className:"h-4 w-4 mr-2 animate-spin"}),s("community.publish","发布")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[!A&&!D&&e.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2 bg-primary/10 dark:bg-primary/20 border border-primary/30 dark:border-primary/40 rounded-md text-sm text-primary dark:text-primary",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:s("community.dailyPointsHint","每日发布首个帖子可获得5积分！")})]}),e.jsx(gs,{})]}),e.jsx(Ve,{value:T,onChange:i=>S(i.target.value),placeholder:s("community.contentPlaceholder","分享你的想法..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base whitespace-pre-wrap"}),R.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:R.map((i,d)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:i,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>ge(d),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(ae,{className:"h-3 w-3"})})]},d))}),P&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:P,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:ye,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(ae,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-2 pb-0 bg-background shrink-0 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:`flex items-center gap-3 ${ee&&G&&I.length===0?"text-destructive":""}`,children:[e.jsx(Ie,{className:`h-5 w-5 shrink-0 ${ee&&G&&I.length===0?"text-destructive":"text-muted-foreground"}`}),f?e.jsx("span",{className:"text-sm text-muted-foreground",children:je()}):e.jsx(ts,{open:Y,onOpenChange:i=>{U(i),i&&Q(!1)},value:I,onSelect:i=>{K(i),Q(!1)},restaurants:c||[],required:G})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ue,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(rs,{open:Z,onOpenChange:ne,value:_,onSelect:H,activities:pe})]})]}),ee&&G&&I.length===0&&e.jsx("p",{className:"text-xs text-destructive pl-8",children:s("community.restaurantRequired","请选择餐厅")})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 pt-0 py-2 pb-[max(2rem,calc(env(safe-area-inset-bottom)+1rem))] bg-background shrink-0",children:[e.jsx("input",{ref:V,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:he}),e.jsx("input",{ref:W,type:"file",accept:"video/*",className:"hidden",onChange:fe}),e.jsxs("button",{type:"button",onClick:()=>V.current?.click(),disabled:y||R.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Le,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:s("community.photo","照片")})]}),e.jsxs("button",{type:"button",onClick:()=>W.current?.click(),disabled:y||!!P,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Te,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:s("community.video","视频")})]}),e.jsx(is,{onSelect:i=>S(d=>d+i)}),y&&e.jsx(ie,{className:"h-5 w-5 animate-spin ml-auto"})]})]})]})]})},Ns=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(z,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{className:"h-4 w-full"}),e.jsx(z,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-5 w-5 rounded-full"}),e.jsx(z,{className:"h-3 w-16"})]}),e.jsx(z,{className:"h-4 w-10"})]})]})]}),Bs=()=>{const{t:r}=B(),s=me(),t=We(),{user:h}=Xe(),{requireLogin:m}=fs(),[c,L]=a.useState(()=>localStorage.getItem("community-mobile-layout")==="single"?"single":"double"),[f,o]=a.useState(()=>localStorage.getItem("community-sort")==="popular"?"popular":"latest"),[j,v]=a.useState(()=>{const l=localStorage.getItem("community-post-type");return["all","post","recipe"].includes(l||"")?l:"all"}),{data:D,isLoading:A}=ls({status:"approved",sortBy:f,postType:j}),{data:k}=ds(),{displayedData:g,hasMore:F,sentinelRef:C}=xs({data:D,initialItemsPerPage:12,incrementPerPage:12}),T=a.useCallback(async()=>{s.removeQueries({queryKey:["community-posts"]}),s.removeQueries({queryKey:["can-create-post"]}),s.removeQueries({queryKey:["has-posted-today"]}),await Promise.all([s.invalidateQueries({queryKey:["community-posts"]}),s.invalidateQueries({queryKey:["can-create-post"]}),s.invalidateQueries({queryKey:["has-posted-today"]})])},[s]),S=()=>{const l=c==="double"?"single":"double";L(l),localStorage.setItem("community-mobile-layout",l)},R=l=>{const _=l;o(_),localStorage.setItem("community-sort",_)},N=l=>{v(l),localStorage.setItem("community-post-type",l)},P=()=>t?c==="single"?"columns-1 gap-4":"columns-2 gap-3":"columns-3 lg:columns-4 gap-4";return e.jsx(hs,{onRefresh:T,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-5xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl mb-2 text-primary font-medium",children:r("community.title","社区")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:r("community.description","分享美食体验，发现更多精彩")})]}),k?e.jsx(vs,{trigger:e.jsxs(O,{size:"sm",className:"gap-1.5",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.createPost","发布")})]})}):h?null:e.jsxs(O,{size:"sm",className:"gap-1.5",onClick:()=>m(),children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.createPost","发布")})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs("div",{className:"inline-flex h-9 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>R("latest"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${f==="latest"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(ce,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.sortLatest","最新")})]}),e.jsxs("button",{onClick:()=>R("popular"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${f==="popular"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(Ee,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.sortPopular","热门")})]})]}),e.jsxs("div",{className:"inline-flex h-9 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>N("all"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${j==="all"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(qe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.filterAll","全部")})]}),e.jsxs("button",{onClick:()=>N("post"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${j==="post"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(le,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.filterPost","帖子")})]}),e.jsxs("button",{onClick:()=>N("recipe"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${j==="recipe"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(de,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:r("community.filterRecipe","食谱")})]})]}),t&&e.jsx("button",{onClick:S,className:"ml-auto inline-flex h-9 items-center justify-center whitespace-nowrap rounded-md bg-muted px-2.5 py-1.5 text-sm font-medium text-muted-foreground ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",title:c==="double"?r("community.singleColumn","单列布局"):r("community.doubleColumn","双列布局"),children:c==="double"?e.jsx(Me,{className:"h-3.5 w-3.5"}):e.jsx(De,{className:"h-3.5 w-3.5"})})]}),A?e.jsx("div",{className:P(),children:Array.from({length:8}).map((l,_)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Ns,{})},_))}):D&&D.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:P(),children:g.map(l=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Je,{post:l,showAssociations:t&&c==="single"})},l.id))}),F&&e.jsx("div",{ref:C,className:"flex justify-center py-6",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent"})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(re,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:r("community.noPosts","暂无帖子")}),k&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:r("community.beFirst","成为第一个发帖的人吧！")})]})]})})})};export{Bs as default};
//# sourceMappingURL=Community-CEjNSJkF.js.map
