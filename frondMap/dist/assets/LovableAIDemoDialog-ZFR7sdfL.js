import{j as e}from"./vendor-ui-DmpovMYY.js";import{r,a as J}from"./vendor-react-iAJ0IrSD.js";import{D as R,c as H,d as U,e as X,cx as b,S as B,L as C,U as Y,B as D,b1 as Z,I as _,i as F}from"./index-CcIuifO_.js";function Q({open:h,onOpenChange:L}){const[l,o]=r.useState([]),[u,w]=r.useState(""),[c,f]=r.useState(!1),[m,O]=r.useState(null),p=r.useRef(null),i=r.useRef(null);r.useEffect(()=>{h&&!m&&navigator.geolocation?.getCurrentPosition(s=>{O({lat:s.coords.latitude,lng:s.coords.longitude})},s=>{console.log("Unable to get user location:",s.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5})},[h,m]),r.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[l]);const k=async s=>{if(s.preventDefault(),!u.trim()||c)return;const a={role:"user",content:u.trim()};o(t=>[...t,a]),w(""),f(!0);const M={role:"assistant",content:""};o(t=>[...t,M]);try{i.current=new AbortController;const t=await fetch("https://tzdgqhwyzsxkxnncgzap.supabase.co/functions/v1/lovable-chat",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6ZGdxaHd5enN4a3hubmNnemFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTg2ODgsImV4cCI6MjA3OTIzNDY4OH0.D76C4OkjQVWyMxtjjdOofpD8X_hEEoTtrXHqi4XSYUw"},body:JSON.stringify({messages:[...l,a],lat:m?.lat,lng:m?.lng}),signal:i.current.signal});if(!t.ok){const g=await t.json().catch(()=>({}));throw new Error(g.error||`请求失败: ${t.status}`)}const x=t.body?.getReader();if(!x)throw new Error("无法读取响应流");const d=new TextDecoder;let n="";for(;;){const{done:g,value:T}=await x.read();if(g)break;n+=d.decode(T,{stream:!0});const N=n.split(`
`);n=N.pop()||"";for(const y of N){if(!y.startsWith("data: "))continue;const I=y.slice(6).trim();if(I!=="[DONE]")try{const v=JSON.parse(I).choices?.[0]?.delta?.content;v&&J.flushSync(()=>{o(z=>{const j=[...z],S=j[j.length-1];return S?.role==="assistant"&&(S.content+=v),j})})}catch{}}}}catch(t){if(t.name==="AbortError")return;o(x=>{const d=[...x],n=d[d.length-1];return n?.role==="assistant"&&(n.content=`错误: ${t.message}`),d})}finally{f(!1),i.current=null}},A=()=>{i.current?.abort(),o([]),f(!1)},E=s=>{s||i.current?.abort(),L(s)},$=s=>{let a=s.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre class="bg-muted p-2 rounded my-2 overflow-x-auto text-sm"><code>$2</code></pre>').replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm">$1</code>').replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" class="text-primary underline">$1</a>').replace(/\n/g,"<br />");return e.jsx("span",{dangerouslySetInnerHTML:{__html:a}})};return e.jsx(R,{open:h,onOpenChange:E,children:e.jsxs(H,{className:"max-w-2xl h-[600px] flex flex-col p-0",children:[e.jsx(U,{className:"p-4 pb-2 border-b",children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5 text-purple-500"}),"Lovable AI 测试"]})}),e.jsx(B,{className:"flex-1 p-4",ref:p,children:e.jsxs("div",{className:"space-y-4",children:[l.length===0&&e.jsxs("div",{className:"text-center text-muted-foreground py-8",children:[e.jsx(b,{className:"h-12 w-12 mx-auto mb-4 text-purple-500/50"}),e.jsx("p",{children:"发送消息开始测试 Lovable AI"}),e.jsx("p",{className:"text-sm mt-2",children:"使用 google/gemini-3-flash-preview 模型"})]}),l.map((s,a)=>e.jsxs("div",{className:`flex gap-3 ${s.role==="user"?"justify-end":"justify-start"}`,children:[s.role==="assistant"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0",children:e.jsx(b,{className:"h-4 w-4 text-purple-500"})}),e.jsx("div",{className:`max-w-[80%] rounded-lg px-4 py-2 ${s.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,children:s.role==="assistant"?e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none",children:s.content?$(s.content):e.jsx(C,{className:"h-4 w-4 animate-spin"})}):e.jsx("p",{className:"whitespace-pre-wrap",children:s.content})}),s.role==="user"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(Y,{className:"h-4 w-4 text-primary"})})]},a))]})}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("form",{onSubmit:k,className:"flex gap-2",children:[e.jsx(D,{type:"button",variant:"outline",size:"icon",onClick:A,disabled:l.length===0&&!c,children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsx(_,{value:u,onChange:s=>w(s.target.value),placeholder:"输入消息测试 Lovable AI...",disabled:c,className:"flex-1"}),e.jsx(D,{type:"submit",disabled:!u.trim()||c,children:c?e.jsx(C,{className:"h-4 w-4 animate-spin"}):e.jsx(F,{className:"h-4 w-4"})})]})})]})})}export{Q as L};
//# sourceMappingURL=LovableAIDemoDialog-ZFR7sdfL.js.map
