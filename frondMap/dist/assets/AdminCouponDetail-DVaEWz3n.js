import{p as O,r as u,s as te,j as e,ch as ge,aM as le,bQ as Ze,w as F,bA as Ge,u as Xe,q as Je,bT as es,an as fe,L as ss,b0 as as,c_ as ts,aZ as is,c$ as ns,ak as ls,am as ve,b5 as _e,cb as ds}from"./vendor-react-87iFmKFJ.js";import{D as de,a1 as rs,i as N,c as re,d as ce,e as oe,Z as ue,V as cs,B as z,s as m,$ as ie,I as Te,a8 as P,a9 as I,aa as $,ab as V,ac as p,a0 as Fe,C as J,n as ee,F as se,p as ae,W as ye,X as Ne,Y as De,A as be,r as we,t as Ce,v as Se,w as Ae,x as ke,y as Le,z as Ee}from"./index-C3xfGQgV.js";import{S as K}from"./separator-ZnoPDUxo.js";import{u as He}from"./useLocalizedContent-CFh79NZC.js";import{h as qe,i as os,j as us,k as ms}from"./useCoupons-BL_-D6Pz.js";import{C as ne}from"./checkbox-DJY8up14.js";import{D as T}from"./vendor-utils-vwQGbBim.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-supabase-CQWbleDe.js";const xs=({templateId:d,children:v})=>{const{t:s}=O(),{getLocalizedField:C}=He(),[t,h]=u.useState(!1),{data:S,isLoading:c}=qe(d),{data:A,isLoading:_}=te({queryKey:["allActivitiesForCoupon"],queryFn:async()=>{const{data:l,error:r}=await m.from("activities").select("id, title_zh, title_en, title_pt, start_date, end_date, visible").eq("visible",!0).order("start_date",{ascending:!1});if(r)throw r;return l},enabled:t}),f=os(),x=us(),H=new Set(S?.map(l=>l.activity_id)||[]),L=async(l,r)=>{r?await x.mutateAsync({templateId:d,activityId:l}):await f.mutateAsync({templateId:d,activityId:l})},k=c||_,q=f.isPending||x.isPending;return e.jsxs(de,{open:t,onOpenChange:h,children:[e.jsx(rs,{asChild:!0,children:v||e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),s("admin.templateActivities.manage")]})}),e.jsxs(re,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:s("admin.templateActivities.title")}),e.jsx(ue,{children:s("admin.templateActivities.description")})]}),e.jsx(cs,{className:"flex-1 pr-4",children:k?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(le,{className:"w-6 h-6 animate-spin"})}):e.jsx("div",{className:"space-y-2",children:A&&A.length>0?A.map(l=>{const r=H.has(l.id);return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(ne,{checked:r,onCheckedChange:()=>L(l.id,r),disabled:q}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:C(l,"title")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T(new Date(l.start_date),"yyyy-MM-dd"),l.end_date&&` ~ ${T(new Date(l.end_date),"yyyy-MM-dd")}`]})]})]}),r&&e.jsxs(z,{variant:"secondary",className:"ml-2",children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),s("admin.templateActivities.linked")]})]},l.id)}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:s("admin.templateActivities.noActivities")})})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.templateActivities.linkedCount",{count:H.size})}),e.jsx(N,{variant:"outline",onClick:()=>h(!1),children:s("admin.templateActivities.close")})]})]})]})};function ps({open:d,onOpenChange:v,couponCode:s,onSuccess:C}){const{t}=O(),[h,S]=u.useState(!1),c=()=>s.is_active?s.user_coupons?.some(r=>r.used_at)?"used":"available":"expired",{register:A,handleSubmit:_,watch:f,setValue:x,reset:H,formState:{errors:L}}=Ze({defaultValues:{usage_limit:s.usage_limit,status:c()}});u.useEffect(()=>{H({usage_limit:s.usage_limit,status:c()})},[s,H]);const k=f("status"),q=async l=>{S(!0);try{const{error:r}=await m.from("coupon_codes").update({usage_limit:l.usage_limit,is_active:l.status!=="expired"}).eq("id",s.id);if(r)throw r;if(s.user_coupons&&s.user_coupons.length>0){if(l.status==="used"){const{error:E}=await m.from("user_coupons").update({used_at:new Date().toISOString()}).eq("coupon_code_id",s.id).is("used_at",null);if(E)throw E}else if(l.status==="available"){const{error:E}=await m.from("user_coupons").update({used_at:null}).eq("coupon_code_id",s.id);if(E)throw E}}F.success(t("admin.couponCode.updateSuccess")),C(),v(!1)}catch(r){console.error("Error updating coupon code:",r),F.error(t("admin.couponCode.updateError"))}finally{S(!1)}};return e.jsx(de,{open:d,onOpenChange:v,children:e.jsxs(re,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:t("admin.couponCode.editTitle")}),e.jsxs(ue,{children:[t("admin.couponCode.editDescription"),": ",e.jsx("code",{className:"font-mono font-semibold",children:s.code})]})]}),e.jsxs("form",{onSubmit:_(q),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"usage_limit",children:t("admin.couponCode.usageLimit")}),e.jsx(Te,{id:"usage_limit",type:"number",min:"1",...A("usage_limit",{required:t("admin.couponCode.usageLimitRequired"),min:{value:1,message:t("admin.couponCode.usageLimitMin")},valueAsNumber:!0})}),L.usage_limit&&e.jsx("p",{className:"text-sm text-destructive",children:L.usage_limit.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("admin.couponCode.usageLimitHint")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(P,{value:k,onValueChange:l=>x("status",l),children:[e.jsx(I,{children:e.jsx($,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs(V,{children:[e.jsx(p,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(p,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(p,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[k==="available"&&t("admin.couponCode.statusAvailableHint"),k==="used"&&t("admin.couponCode.statusUsedHint"),k==="expired"&&t("admin.couponCode.statusExpiredHint")]})]}),e.jsxs(Fe,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:h,children:t("common.cancel")}),e.jsxs(N,{type:"submit",disabled:h,children:[h&&e.jsx(le,{className:"mr-2 h-4 w-4 animate-spin"}),t("common.save")]})]})]})]})})}function hs({open:d,onOpenChange:v,selectedCodeIds:s,onSuccess:C}){const{t}=O(),[h,S]=u.useState(!1),[c,A]=u.useState("available"),_=async()=>{if(s.length!==0){S(!0);try{const{error:f}=await m.from("coupon_codes").update({is_active:c!=="expired"}).in("id",s);if(f)throw f;if(c==="used"){const{error:x}=await m.from("user_coupons").update({used_at:new Date().toISOString()}).in("coupon_code_id",s).is("used_at",null);if(x)throw x}else if(c==="available"){const{error:x}=await m.from("user_coupons").update({used_at:null}).in("coupon_code_id",s);if(x)throw x}F.success(t("admin.couponCode.batchUpdateSuccess",{count:s.length})),C(),v(!1)}catch(f){console.error("Error batch updating coupon codes:",f),F.error(t("admin.couponCode.batchUpdateError"))}finally{S(!1)}}};return e.jsx(de,{open:d,onOpenChange:v,children:e.jsxs(re,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:t("admin.couponCode.batchEditTitle")}),e.jsx(ue,{children:t("admin.couponCode.batchEditDescription",{count:s.length})})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:t("admin.couponCode.status")}),e.jsxs(P,{value:c,onValueChange:f=>A(f),children:[e.jsx(I,{children:e.jsx($,{placeholder:t("admin.couponCode.selectStatus")})}),e.jsxs(V,{children:[e.jsx(p,{value:"available",children:t("admin.couponCode.statusAvailable")}),e.jsx(p,{value:"used",children:t("admin.couponCode.statusUsed")}),e.jsx(p,{value:"expired",children:t("admin.couponCode.statusExpired")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[c==="available"&&t("admin.couponCode.statusAvailableHint"),c==="used"&&t("admin.couponCode.statusUsedHint"),c==="expired"&&t("admin.couponCode.statusExpiredHint")]})]})}),e.jsxs(Fe,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:h,children:t("common.cancel")}),e.jsxs(N,{onClick:_,disabled:h,children:[h&&e.jsx(le,{className:"mr-2 h-4 w-4 animate-spin"}),t("admin.couponCode.batchUpdate")]})]})]})})}const Ss=()=>{const{id:d}=Ge(),v=Xe(),{t:s}=O(),{getLocalizedField:C}=He(),t=Je(),[h,S]=u.useState(""),[c,A]=u.useState("all"),[_,f]=u.useState("all"),[x,H]=u.useState("all"),[L,k]=u.useState(null),[q,l]=u.useState(null),[r,E]=u.useState(!1),[D,U]=u.useState(new Set),[Me,me]=u.useState(!1),[ze,W]=u.useState(!1),[R,xe]=u.useState(!1),{data:n,isLoading:Ue}=te({queryKey:["couponTemplate",d],queryFn:async()=>{const{data:a,error:i}=await m.from("coupon_templates").select("*").eq("id",d).single();if(i)throw i;return a},enabled:!!d}),{data:Y,isLoading:Be}=qe(d),{data:Q,isLoading:Pe}=ms(d),{data:w,isLoading:Ie}=te({queryKey:["templateCouponCodes",d],queryFn:async()=>{const{data:a,error:i}=await m.from("coupon_codes").select(`
          *,
          user_coupons(
            id,
            user_id,
            claimed_at,
            used_at,
            source
          )
        `).eq("template_id",d).order("created_at",{ascending:!1});if(i)throw i;const j=(a||[]).map(o=>o.id),{data:B}=await m.from("coupon_usage_history").select("user_coupon_id, used_by_user_id, restaurant_id").in("coupon_code_id",j),G=[...new Set((B||[]).map(o=>o.used_by_user_id))],{data:X}=await m.from("profiles").select("id, display_name, avatar_url").in("id",G),b=(X||[]).reduce((o,g)=>(o[g.id]={display_name:g.display_name,avatar_url:g.avatar_url},o),{}),pe=[...new Set((B||[]).filter(o=>o.restaurant_id).map(o=>o.restaurant_id))];let he={};if(pe.length>0){const{data:o}=await m.from("restaurants").select("id, name, name_en, name_pt").in("id",pe);he=(o||[]).reduce((g,y)=>(g[y.id]={name:y.name,name_en:y.name_en,name_pt:y.name_pt},g),{})}const je=(B||[]).reduce((o,g)=>(g.user_coupon_id&&(o[g.user_coupon_id]={used_by_merchant:b[g.used_by_user_id]||null,used_at_restaurant:g.restaurant_id&&he[g.restaurant_id]||null}),o),{});return await Promise.all((a||[]).map(async o=>{const g=await Promise.all((o.user_coupons||[]).map(async y=>{if(!y.user_id)return{...y,profiles:{id:"",display_name:"Unknown",avatar_url:null},...je[y.id]};const{data:Ye}=await m.from("profiles").select("id, display_name, avatar_url").eq("id",y.user_id).maybeSingle();return{...y,profiles:Ye||{id:y.user_id,display_name:"Unknown",avatar_url:null},...je[y.id]}}));return{...o,user_coupons:g}}))},enabled:!!d}),M=u.useMemo(()=>w?w.filter(a=>{const i=h.toLowerCase(),j=h===""||a.code.toLowerCase().includes(i)||a.user_coupons.some(b=>b.profiles.display_name.toLowerCase().includes(i)),B=c==="all"||c==="active"&&a.is_active||c==="inactive"&&!a.is_active,G=_==="all"||_==="unclaimed"&&a.user_coupons.length===0||_==="claimed"&&a.user_coupons.length>0&&a.user_coupons.every(b=>!b.used_at)||_==="used"&&a.user_coupons.some(b=>b.used_at),X=x==="all"||x==="share"&&a.user_coupons.some(b=>b.source==="share")||x==="other"&&a.user_coupons.some(b=>b.source!=="share");return j&&B&&G&&X}):[],[w,h,c,_,x]),Z=w?.length||0,$e=w?.reduce((a,i)=>a+i.used_count,0)||0,Ve=w?.reduce((a,i)=>a+i.user_coupons.length,0)||0,Qe=a=>{U(i=>{const j=new Set(i);return j.has(a)?j.delete(a):j.add(a),j})},Ke=()=>{D.size===M.length?U(new Set):U(new Set(M.map(a=>a.id)))},Oe=()=>{U(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",d]})},We=async()=>{if(D.size!==0){xe(!0);try{const a=Array.from(D),{error:i}=await m.from("user_coupons").delete().in("coupon_code_id",a);if(i)throw i;const{error:j}=await m.from("coupon_codes").delete().in("id",a);if(j)throw j;F.success(s("admin.couponCode.batchDeleteSuccess",{count:a.length})),U(new Set),t.invalidateQueries({queryKey:["templateCouponCodes",d]}),W(!1)}catch(a){console.error("Error batch deleting coupon codes:",a),F.error(s("admin.couponCode.batchDeleteError"))}finally{xe(!1)}}},Re=async a=>{E(!0);try{const{error:i}=await m.from("user_coupons").delete().eq("coupon_code_id",a);if(i)throw i;const{error:j}=await m.from("coupon_codes").delete().eq("id",a);if(j)throw j;F.success(s("admin.couponDetail.deleteSuccess")),t.invalidateQueries({queryKey:["templateCouponCodes",d]}),l(null)}catch(i){console.error("Error deleting coupon code:",i),F.error(s("admin.couponDetail.deleteError"))}finally{E(!1)}};return Ue?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center py-12",children:s("admin.couponDetail.loading")})}):n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(N,{variant:"ghost",onClick:()=>v("/admin/coupons"),className:"mb-4",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),s("admin.couponDetail.backToList")]}),e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(fe,{className:"w-8 h-8"}),s("admin.couponDetail.title")]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(J,{children:[e.jsx(ee,{children:e.jsx(se,{className:"text-lg",children:s("admin.couponDetail.templateInfo")})}),e.jsxs(ae,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s("admin.couponDetail.linkedActivities")}),Be?e.jsx("p",{className:"text-sm",children:s("admin.couponDetail.loading")}):Y&&Y.length>0?e.jsx("div",{className:"space-y-2",children:Y.map(a=>e.jsx(ss,{to:`/activity/${a.activity_id}`,className:"block text-primary hover:underline",children:C(a.activities,"title")},a.activity_id))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.noLinkedActivities")})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(xs,{templateId:d}),!n.visible&&e.jsx(z,{variant:"secondary",children:s("admin.couponDetail.hidden")}),!n.is_active&&e.jsx(z,{variant:"secondary",children:s("admin.couponDetail.inactive")}),n.is_active&&e.jsx(z,{children:s("admin.couponDetail.active")})]})]}),e.jsx(K,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s("admin.couponDetail.titleLabel")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.chinese"),"："]}),n.title_zh]}),e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.english"),"："]}),n.title_en]}),e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.portuguese"),"："]}),n.title_pt]})]})]}),(n.description_zh||n.description_en||n.description_pt)&&e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s("admin.couponDetail.descriptionLabel")}),e.jsxs("div",{className:"space-y-1 text-sm",children:[n.description_zh&&e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.chinese"),"："]}),n.description_zh]}),n.description_en&&e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.english"),"："]}),n.description_en]}),n.description_pt&&e.jsxs("p",{children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s("admin.portuguese"),"："]}),n.description_pt]})]})]})]}),e.jsx(K,{}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.discountType")}),e.jsx("p",{className:"font-medium",children:n.discount_type==="percentage"?s("admin.couponDetail.percentageDiscount"):s("admin.couponDetail.fixedAmount")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.discountValue")}),e.jsx("p",{className:"font-medium text-primary text-lg",children:n.discount_type==="percentage"?`${n.discount_value}%`:`€${n.discount_value}`})]}),n.min_order_amount&&n.min_order_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.minOrderAmount")}),e.jsxs("p",{className:"font-medium",children:["€",n.min_order_amount]})]}),n.max_discount_amount&&n.max_discount_amount>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.maxDiscountAmount")}),e.jsxs("p",{className:"font-medium",children:["€",n.max_discount_amount]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.generated")}),e.jsxs("p",{className:"font-medium",children:[Z," ",s("admin.couponDetail.units")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.claimed")}),e.jsxs("p",{className:"font-medium",children:[Ve," ",s("admin.couponDetail.times")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.used")}),e.jsxs("p",{className:"font-medium",children:[$e," ",s("admin.couponDetail.times")]})]})]}),e.jsx(K,{}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:s("admin.couponDetail.validPeriod")}),e.jsxs("p",{className:"font-medium",children:[T(new Date(n.valid_from),"yyyy-MM-dd"),n.valid_until?` - ${T(new Date(n.valid_until),"yyyy-MM-dd")}`:` - ${s("admin.couponDetail.unlimited")}`]})]})]})})]})]}),e.jsxs(J,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(ts,{className:"h-4 w-4"}),s("admin.couponDetail.generatedCoupons")," (",Z,")"]}),w&&w.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Te,{placeholder:s("admin.couponDetail.searchPlaceholder"),value:h,onChange:a=>S(a.target.value),className:"pl-9"})]}),e.jsxs(P,{value:c,onValueChange:a=>A(a),children:[e.jsx(I,{children:e.jsx($,{placeholder:s("admin.couponDetail.statusFilter")})}),e.jsxs(V,{children:[e.jsx(p,{value:"all",children:s("admin.couponDetail.allStatus")}),e.jsx(p,{value:"active",children:s("admin.couponDetail.statusActive")}),e.jsx(p,{value:"inactive",children:s("admin.couponDetail.statusInactive")})]})]}),e.jsxs(P,{value:_,onValueChange:a=>f(a),children:[e.jsx(I,{children:e.jsx($,{placeholder:s("admin.couponDetail.usageFilter")})}),e.jsxs(V,{children:[e.jsx(p,{value:"all",children:s("admin.couponDetail.usageAll")}),e.jsx(p,{value:"unclaimed",children:s("admin.couponDetail.usageUnclaimed")}),e.jsx(p,{value:"claimed",children:s("admin.couponDetail.usageClaimed")}),e.jsx(p,{value:"used",children:s("admin.couponDetail.usageUsed")})]})]}),e.jsxs(P,{value:x,onValueChange:a=>H(a),children:[e.jsx(I,{children:e.jsx($,{placeholder:s("admin.couponDetail.sourceFilter")})}),e.jsxs(V,{children:[e.jsx(p,{value:"all",children:s("admin.couponDetail.sourceAll")}),e.jsx(p,{value:"share",children:s("admin.couponDetail.sourceShare")}),e.jsx(p,{value:"other",children:s("admin.couponDetail.sourceOther")})]})]})]})]})}),e.jsx(ae,{children:Ie?e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.loading")}):!w||w.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.noCouponsYet")}):M.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:s("admin.couponDetail.noMatchingCoupons")}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{id:"selectAll",checked:D.size===M.length&&M.length>0,onCheckedChange:Ke}),e.jsx("label",{htmlFor:"selectAll",className:"text-sm cursor-pointer",children:s("admin.couponCode.selectAll")})]}),D.size>0&&e.jsx("span",{className:"text-sm text-muted-foreground",children:s("admin.couponCode.selectedCount",{count:D.size})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>me(!0),children:s("admin.couponCode.batchEditStatus")}),e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>W(!0),children:s("admin.couponCode.batchDelete")})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[M.length," / ",Z]})]})]}),M.map(a=>e.jsxs("div",{className:`rounded-lg border bg-card p-4 ${D.has(a.id)?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{checked:D.has(a.id),onCheckedChange:()=>Qe(a.id)}),e.jsx("div",{className:"w-12 h-12 rounded bg-primary/10 flex items-center justify-center",children:e.jsx(fe,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("code",{className:"font-mono font-semibold text-base",children:a.code}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s("admin.couponDetail.generatedAt"),"：",T(new Date(a.created_at),"yyyy-MM-dd HH:mm")]}),e.jsxs("div",{className:"flex items-center gap-4 mt-1",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("admin.couponDetail.usage"),"：",a.used_count," / ",a.usage_limit]}),e.jsx(z,{variant:a.is_active?"default":"secondary",children:a.is_active?s("admin.couponDetail.activated"):s("admin.couponDetail.deactivated")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>k(a),title:s("admin.couponDetail.edit"),children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>l(a.id),title:s("admin.couponDetail.delete"),children:e.jsx(ls,{className:"h-4 w-4 text-destructive"})})]})]}),a.user_coupons.length>0?e.jsxs("div",{className:"space-y-2 pt-3 border-t",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:s("admin.couponDetail.claimedUsers")}),a.user_coupons.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-md bg-secondary/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ye,{className:"h-10 w-10",children:[e.jsx(Ne,{src:i.profiles.avatar_url||void 0}),e.jsx(De,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.profiles.display_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("admin.couponDetail.claimedAt"),"：",T(new Date(i.claimed_at),"yyyy-MM-dd HH:mm")]}),i.source&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s("admin.couponDetail.source"),"：",i.source==="share"?s("admin.couponDetail.sourceShare"):i.source]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(z,{variant:i.used_at?"default":"secondary",children:i.used_at?`${s("admin.couponDetail.usedAt")} ${T(new Date(i.used_at),"MM-dd HH:mm")}`:s("admin.couponDetail.unused")}),i.used_at&&i.used_by_merchant&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(_e,{className:"h-3 w-3"}),e.jsxs("span",{children:[s("admin.couponDetail.verifiedBy"),"：",i.used_by_merchant.display_name]}),i.used_at_restaurant&&e.jsxs("span",{className:"text-primary",children:["@ ",C(i.used_at_restaurant,"name")]})]})]})]},i.id))]}):e.jsx("p",{className:"text-sm text-muted-foreground pt-3 border-t",children:s("admin.couponDetail.noClaims")})]},a.id))]})})]}),e.jsxs(J,{children:[e.jsx(ee,{children:e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(ds,{className:"h-4 w-4"}),s("admin.couponDetail.usageHistory")," (",Q?.length||0,")"]})}),e.jsx(ae,{children:Pe?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:s("admin.couponDetail.loading")}):!Q||Q.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:s("admin.couponDetail.noUsageHistory")}):e.jsx("div",{className:"space-y-3",children:Q.map(a=>e.jsxs("div",{className:"flex items-start gap-4 p-4 border rounded-lg",children:[e.jsxs(ye,{className:"h-10 w-10",children:[a.used_by_profile?.avatar_url?e.jsx(Ne,{src:a.used_by_profile.avatar_url}):null,e.jsx(De,{children:e.jsx(ve,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium",children:a.used_by_profile?.display_name||s("common.unknown")}),e.jsx("span",{className:"text-muted-foreground",children:s("admin.couponDetail.verifiedCoupon")}),a.coupon_code&&e.jsx(z,{variant:"outline",className:"font-mono text-xs",children:a.coupon_code})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground flex-wrap",children:[e.jsx("span",{children:T(new Date(a.used_at),"yyyy-MM-dd HH:mm:ss")}),a.restaurant&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"h-3 w-3"}),C(a.restaurant,"name")]})]}),a.notes&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[s("admin.couponDetail.notes"),": ",a.notes]})]})]},a.id))})})]})]})]}),L&&e.jsx(ps,{open:!!L,onOpenChange:a=>!a&&k(null),couponCode:L,onSuccess:()=>{t.invalidateQueries({queryKey:["templateCouponCodes",d]})}}),e.jsx(hs,{open:Me,onOpenChange:me,selectedCodeIds:Array.from(D),onSuccess:Oe}),e.jsx(be,{open:!!q,onOpenChange:a=>!a&&l(null),children:e.jsxs(we,{children:[e.jsxs(Ce,{children:[e.jsx(Se,{children:s("admin.couponDetail.deleteConfirmTitle")}),e.jsx(Ae,{children:s("admin.couponDetail.deleteConfirmDesc")})]}),e.jsxs(ke,{children:[e.jsx(Le,{disabled:r,children:s("common.cancel")}),e.jsx(Ee,{onClick:()=>q&&Re(q),disabled:r,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s(r?"admin.couponDetail.deleting":"admin.couponDetail.confirmDelete")})]})]})}),e.jsx(be,{open:ze,onOpenChange:W,children:e.jsxs(we,{children:[e.jsxs(Ce,{children:[e.jsx(Se,{children:s("admin.couponCode.batchDeleteTitle")}),e.jsx(Ae,{children:s("admin.couponCode.batchDeleteDescription",{count:D.size})})]}),e.jsxs(ke,{children:[e.jsx(Le,{disabled:R,children:s("common.cancel")}),e.jsx(Ee,{onClick:We,disabled:R,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:s(R?"common.deleting":"common.delete")})]})]})})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:s("admin.couponDetail.templateNotFound")}),e.jsx(N,{onClick:()=>v("/admin/coupons"),children:s("admin.couponDetail.backToList")})]})})};export{Ss as default};
//# sourceMappingURL=AdminCouponDetail-DVaEWz3n.js.map
