import{p as A,r as i,w as k,j as e,bA as L,X as q,a6 as J,dS as K,cl as Q,bJ as Y,aM as M,bL as Z,c8 as ee,aw as se,ev as G,b3 as te,b4 as W,b8 as ae,a4 as re,cw as O,c9 as ie,ab as ne}from"./vendor-react-DImbKuZP.js";import{s as $,q as y,ae as X}from"./index-_G3CuCzp.js";import{l as oe}from"./xiaoxiong-logo-clean-D2n3VLi4.js";import{u as le}from"./useWatermarkedVideo-V-xLJRQT.js";const he=()=>{const{t:u,i18n:v}=A(),[R,x]=i.useState(!1),[C,s]=i.useState(!1),[h,w]=i.useState(!1),[p,S]=i.useState(!1);return{identifyIngredients:async a=>{x(!0);try{const{data:t,error:r}=await $.functions.invoke("ai-recipe/identify",{body:{image_url:a}});if(r)throw r;if(t?.error)throw new Error(t.error);return t.ingredients||[]}catch(t){return console.error("Identify error:",t),k.error(u("aiRecipe.identifyError","食材识别失败，请重试")),null}finally{x(!1)}},generateRecipes:async(a,t,r,l,n,j)=>{s(!0);try{const{data:m,error:N}=await $.functions.invoke("ai-recipe/generate",{body:{ingredients:a,difficulty:t,servings:r,recipe_count:l||3,dish_count_specified:!!l,notes:n,exclude_dishes:j}});if(N){const E=(N?.context?.body?await N.context.json?.().catch(()=>null):null)?.error||N.message;if(E?.includes("credits"))return k.error(u("aiRecipe.creditsExhausted","AI 额度不足，请充值后重试")),null;if(E?.includes("rate limit"))return k.error(u("aiRecipe.rateLimited","请求过于频繁，请稍后重试")),null;throw new Error(E)}if(m?.error){if(m.error.includes("credits"))return k.error(u("aiRecipe.creditsExhausted","AI 额度不足，请充值后重试")),null;throw new Error(m.error)}return m.recipes||[]}catch(m){return console.error("Generate error:",m),k.error(u("aiRecipe.generateError","菜谱生成失败，请重试")),null}finally{s(!1)}},generateRecipeImages:async(a,t)=>{if(a.length){S(!0);try{const{data:r,error:l}=await $.functions.invoke("ai-recipe/generate-images",{body:{recipes:a}});if(l||!r?.images)return;for(const n of r.images)n.image_url&&t(n.recipe_name,n.image_url,n.image_source||"ai")}catch(r){console.error("Image generation error:",r)}finally{S(!1)}}},verifyResultPhoto:async(a,t,r,l)=>{w(!0);try{const{data:n,error:j}=await $.functions.invoke("ai-recipe/verify-photo",{body:{image_url:a,recipe_name:t,exif_time:r,lang:v.language,photo_source:l||"camera"}});if(j)throw j;if(n?.error)throw new Error(n.error);return n}catch(n){return console.error("Verify error:",n),k.error(u("aiRecipe.verifyError","照片验证失败，请重试")),null}finally{w(!1)}},uploadImage:async(a,t)=>{try{const r=a.name.split(".").pop(),l=`${t}/${Date.now()}-${Math.random().toString(36).slice(2)}.${r}`,{data:n,error:j}=await $.storage.from("community-images").upload(l,a,{cacheControl:"3600",upsert:!1});if(j)throw j;const{data:m}=$.storage.from("community-images").getPublicUrl(n.path);return m.publicUrl}catch(r){return console.error("Upload error:",r),k.error(u("common.uploadFailed","上传失败")),null}},isIdentifying:R,isGenerating:C,isVerifying:h,isGeneratingImages:p}},ce=({onCapture:u,onClose:v})=>{const{t:R}=A(),x=i.useRef(null),C=i.useRef(null),s=i.useRef(null),[h,w]=i.useState(!1),[p,S]=i.useState("environment"),[c,o]=i.useState(!1),f=i.useCallback(async a=>{s.current&&(s.current.getTracks().forEach(t=>t.stop()),s.current=null),w(!1);try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:a},audio:!1});s.current=t,x.current&&(x.current.srcObject=t,x.current.onloadedmetadata=()=>{x.current?.play(),w(!0)})}catch(t){console.error("Camera error:",t),t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?k.error(R("aiRecipe.cameraPermissionDenied","相机权限被拒绝，请在浏览器设置中允许访问相机")):t.name==="NotFoundError"?k.error(R("aiRecipe.cameraNotFound","未找到相机设备")):k.error(R("aiRecipe.cameraError","无法访问相机，请检查权限设置")),v()}},[v,R]);i.useEffect(()=>(f(p),()=>{s.current?.getTracks().forEach(a=>a.stop())}),[]);const I=async()=>{const a=p==="environment"?"user":"environment";S(a),await f(a)},P=()=>{if(!x.current||!C.current||!h)return;o(!0);const a=x.current,t=C.current;t.width=a.videoWidth,t.height=a.videoHeight;const r=t.getContext("2d");r&&(r.drawImage(a,0,0),t.toBlob(l=>{if(l){const n=new File([l],`photo-${Date.now()}.jpg`,{type:"image/jpeg"});s.current?.getTracks().forEach(j=>j.stop()),u(n)}o(!1)},"image/jpeg",.92))};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black flex flex-col",children:[e.jsxs("div",{className:"relative flex-1 overflow-hidden",children:[e.jsx("video",{ref:x,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),e.jsx("canvas",{ref:C,className:"hidden"}),h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsxs("div",{className:"w-64 h-64 relative",children:[e.jsx("div",{className:"absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white/80 rounded-tl"}),e.jsx("div",{className:"absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white/80 rounded-tr"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/80 rounded-bl"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white/80 rounded-br"})]})}),!h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3 text-white/70",children:[e.jsx(L,{className:"h-10 w-10 animate-pulse"}),e.jsx("span",{className:"text-sm",children:R("aiRecipe.cameraLoading","相机加载中...")})]})})]}),e.jsxs("div",{className:"bg-black/90 px-6 py-6 flex items-center justify-between safe-area-bottom",children:[e.jsx(y,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/10 rounded-full w-12 h-12",onClick:()=>{s.current?.getTracks().forEach(a=>a.stop()),v()},children:e.jsx(q,{className:"h-6 w-6"})}),e.jsx("button",{onClick:P,disabled:!h||c,className:"w-20 h-20 rounded-full bg-white flex items-center justify-center disabled:opacity-50 active:scale-95 transition-transform",children:e.jsx(J,{className:"w-16 h-16 text-black fill-black/10"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"text-white hover:bg-white/10 rounded-full w-12 h-12",onClick:I,disabled:!h,children:e.jsx(K,{className:"h-6 w-6"})})]})]})},pe=({onPhotoVerified:u,uploadImage:v,verifyPhoto:R,recipeName:x,isVerifying:C})=>{const{t:s}=A(),[h,w]=i.useState(!1),[p,S]=i.useState(null),[c,o]=i.useState(null),[f,I]=i.useState(!1),[P,a]=i.useState(null),[t,r]=i.useState(null),[l,n]=i.useState(""),[j,m]=i.useState(!1),[N,T]=i.useState(!1),E=i.useRef(null),z=async(g,_)=>{w(!0),o(null),a(_),S(URL.createObjectURL(g)),n(""),m(!1);const d=await v(g,"ai-recipe-results");if(!d){w(!1);return}r(d),w(!1);const b=await R(d,x,_);o(b),b?.is_genuine&&m(!0)},F=g=>{I(!1),z(g,"camera")},V=()=>{t&&c&&u(t,c.is_genuine,l.trim()||void 0)};return e.jsxs(e.Fragment,{children:[f&&e.jsx(ce,{onCapture:F,onClose:()=>I(!1)}),e.jsx("input",{ref:E,type:"file",accept:"image/*",className:"hidden",onChange:g=>{const _=g.target.files?.[0];_&&z(_,"upload"),g.target.value=""}}),e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto",children:e.jsx(Q,{className:"h-10 w-10 text-primary"})}),e.jsx("h3",{className:"text-lg font-semibold",children:s("aiRecipe.resultPhotoTitle","拍摄成品")}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-xs",children:s("aiRecipe.resultPhotoDesc","拍摄或上传成品照片，系统将验证真实性")})]}),!p&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg w-full max-w-sm bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-400",children:[e.jsx(Y,{className:"h-4 w-4 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs",children:s("aiRecipe.uploadStricterNote","相册上传将接受更严格的审核，建议直接拍摄")})]}),p&&e.jsxs("div",{className:"w-full max-w-sm rounded-xl overflow-hidden border relative",children:[e.jsx("img",{src:p,alt:"Result",className:"w-full h-48 object-cover"}),P==="upload"&&e.jsx("div",{className:"absolute top-2 right-2 bg-amber-500 text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s("aiRecipe.fromGallery","相册")}),P==="camera"&&e.jsx("div",{className:"absolute top-2 right-2 bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:s("aiRecipe.fromCamera","拍摄")})]}),(h||C)&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(M,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:h?s("common.uploading","上传中..."):s("aiRecipe.verifying","验证中...")})]}),c&&e.jsxs("div",{className:`w-full max-w-sm rounded-lg overflow-hidden ${c.is_genuine?"bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-400":"bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 p-3",children:[c.is_genuine?e.jsx(Z,{className:"h-5 w-5 shrink-0"}):e.jsx(ee,{className:"h-5 w-5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium flex-1",children:c.is_genuine?s("aiRecipe.photoVerified","照片验证通过"):s("aiRecipe.photoNotVerified","照片验证未通过")}),!c.is_genuine&&c.explanation&&e.jsxs("button",{onClick:()=>T(g=>!g),className:"flex items-center gap-0.5 text-xs opacity-70 hover:opacity-100 shrink-0",children:[s("aiRecipe.viewReason","原因"),e.jsx(se,{className:`h-3.5 w-3.5 transition-transform ${N?"rotate-180":""}`})]})]}),!c.is_genuine&&N&&c.explanation&&e.jsx("div",{className:"px-3 pb-3 text-xs opacity-80 border-t border-current/10 pt-2",children:c.explanation})]}),j&&c?.is_genuine&&e.jsxs("div",{className:"w-full max-w-sm space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-medium",children:[e.jsx(G,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:s("aiRecipe.cookingNote","写下烹饪心得")}),e.jsx("span",{className:"text-xs text-muted-foreground font-normal ml-1",children:s("common.optional","（可选）")})]}),e.jsx(X,{placeholder:s("aiRecipe.cookingNotePlaceholder","分享一下今天的烹饪体验、技巧或感受..."),value:l,onChange:g=>n(g.target.value),rows:3,maxLength:500,className:"resize-none text-sm"}),l.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[l.length,"/500"]})]}),c?.is_genuine?e.jsxs("div",{className:"flex flex-col gap-2 w-full max-w-sm",children:[e.jsxs(y,{className:"w-full gap-2 h-11",onClick:V,children:[e.jsx(te,{className:"h-4 w-4"}),s("aiRecipe.continueToShare","继续")]}),e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsxs(y,{variant:"ghost",className:"flex-1 gap-2 text-muted-foreground",onClick:()=>I(!0),children:[e.jsx(L,{className:"h-4 w-4"}),s("aiRecipe.retakePhoto","重新拍摄")]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-9 w-9 shrink-0 text-muted-foreground",onClick:()=>E.current?.click(),title:s("aiRecipe.uploadFromGallery","上传相册"),children:e.jsx(W,{className:"h-4 w-4"})})]})]}):e.jsxs("div",{className:"flex items-center gap-3 w-full max-w-sm",children:[e.jsxs(y,{className:"flex-1 gap-2 h-11",onClick:()=>I(!0),disabled:h||C,children:[e.jsx(L,{className:"h-4 w-4"}),p?s("aiRecipe.retakePhoto","重新拍摄"):s("aiRecipe.takeResultPhoto","拍摄成品")]}),e.jsx(y,{variant:"outline",size:"icon",className:"h-11 w-11 shrink-0",onClick:()=>E.current?.click(),disabled:h||C,title:s("aiRecipe.uploadFromGallery","上传相册"),children:e.jsx(W,{className:"h-4 w-4"})})]})]})]})},D=2,fe=({resultImageUrl:u,recipeName:v,initialNote:R="",onPublish:x,onSkip:C,isPublishing:s,recipeSteps:h,videoTask:w,videoState:p,onGenerateVideo:S,onSelectVideo:c})=>{const{t:o}=A(),[f,I]=i.useState(R),[P,a]=i.useState(!1),t=w?.status==="creating"||w?.status==="processing",r=p?.tasks?.filter(d=>d.status==="succeeded"&&d.videoUrl)||[],l=r.length>0,n=p?.selectedIndex??0,j=r[n],m=l?j?.videoUrl??null:null,{watermarkedUrl:N,isMp4:T}=le(m,oe),E=()=>{const d=N||m;if(!d)return;const b=N?T?"mp4":"webm":"mp4",U=document.createElement("a");U.href=d,U.download=`${v||"recipe"}-xiaoxiong.${b}`,document.body.appendChild(U),U.click(),document.body.removeChild(U),k.success(o("aiRecipe.video.downloadComplete","视频下载完成"))},z=p?.tasks?.length??0,F=p?.tasks?.filter(d=>d.status==="failed")||[],V=z<D&&!t,g=z,_=()=>{if(!S)return;const d=f.trim()?`Cooking notes: ${f.trim()}. `:"",b=(h||[]).slice(0,6).map(B=>B.description_en||B.description).filter(Boolean).join(". "),U=b?`${b}. `:"",H=`Step-by-step cooking tutorial video showing the complete preparation process of ${v}. Show hands chopping ingredients, mixing in a bowl, cooking in a pan with oil sizzling. ${U}${d}Kitchen counter with fresh ingredients, cutting board, knife, pots and pans visible. Warm natural kitchen lighting, steam rising from the pan, close-up of each cooking step, smooth transitions between steps. --duration 5 --camerafixed true`;S(H)};return e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx("h3",{className:"text-lg font-semibold",children:o("aiRecipe.congratulations","恭喜完成！")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o("aiRecipe.publishQuestion","要发布到社区吗？")})]}),u&&e.jsxs("div",{className:"w-full max-w-sm rounded-xl overflow-hidden border",children:[m?N?e.jsx("video",{src:N,controls:!0,autoPlay:!0,muted:!0,loop:!0,playsInline:!0,className:"w-full h-48 object-cover"},N):e.jsx("div",{className:"w-full h-48 bg-muted/30 flex items-center justify-center",children:e.jsx(M,{className:"h-4 w-4 animate-spin text-muted-foreground"})}):e.jsx("img",{src:u,alt:v,className:"w-full h-48 object-cover"}),m&&e.jsx("div",{className:"px-3 pt-2",children:e.jsxs(y,{variant:"outline",size:"sm",className:"gap-1.5 h-7 text-xs w-full",onClick:E,children:[e.jsx(ae,{className:"h-3 w-3"}),o("aiRecipe.video.downloadWithWatermark","下载视频")]})}),r.length>1&&e.jsx("div",{className:"flex gap-2 px-3 pt-2",children:r.map((d,b)=>e.jsxs("button",{onClick:()=>c?.(b),className:`relative w-16 h-16 rounded-lg overflow-hidden border-2 transition-all shrink-0 ${b===n?"border-primary ring-1 ring-primary/30":"border-muted opacity-70 hover:opacity-100"}`,children:[e.jsx("video",{src:d.videoUrl,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),b===n&&e.jsx("div",{className:"absolute inset-0 bg-primary/10 flex items-center justify-center",children:e.jsx(re,{className:"h-4 w-4 text-primary"})}),e.jsx("span",{className:"absolute bottom-0.5 right-0.5 text-[9px] bg-black/60 text-white px-1 rounded",children:b+1})]},d.taskId))}),e.jsxs("div",{className:"p-3 space-y-2",children:[e.jsx("p",{className:"font-medium text-sm",children:v}),P?e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{autoFocus:!0,placeholder:o("aiRecipe.cookingNotePlaceholder","分享一下今天的烹饪体验、技巧或感受..."),value:f,onChange:d=>I(d.target.value),rows:3,maxLength:500,className:"resize-none text-sm",disabled:s,onBlur:()=>a(!1)}),f.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[f.length,"/500"]})]}):e.jsx("button",{className:"w-full text-left",onClick:()=>a(!0),disabled:s,children:f?e.jsxs("p",{className:"text-sm text-foreground/80 flex items-start gap-1.5",children:[e.jsx(G,{className:"h-3.5 w-3.5 mt-0.5 shrink-0 text-primary"}),f]}):e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1.5",children:[e.jsx(G,{className:"h-3.5 w-3.5 shrink-0"}),o("aiRecipe.addCookingNote","点击添加烹饪心得...")]})}),S&&e.jsx("div",{className:"pt-1 space-y-1.5",children:t?e.jsxs("div",{className:"flex items-center gap-2 px-2 py-2 bg-muted/50 rounded-lg",children:[e.jsx(M,{className:"h-3.5 w-3.5 animate-spin text-primary"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:w?.status==="creating"?o("aiRecipe.video.creating","正在创建视频任务..."):o("aiRecipe.video.processing","AI 视频生成中，请稍候...")})]}):F.length>0&&!l?e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("p",{className:"text-xs text-destructive",children:F[F.length-1].error||o("aiRecipe.video.failed","视频生成失败")}),V&&e.jsxs(y,{variant:"outline",size:"sm",className:"gap-1.5 text-xs w-full",onClick:_,children:[e.jsx(O,{className:"h-3.5 w-3.5"}),o("aiRecipe.video.retry","重新生成视频"),e.jsxs("span",{className:"text-muted-foreground ml-auto",children:["(",g,"/",D,")"]})]})]}):l?V?e.jsxs(y,{variant:"outline",size:"sm",className:"gap-1.5 text-xs w-full",onClick:_,children:[e.jsx(ie,{className:"h-3.5 w-3.5"}),o("aiRecipe.video.regenerate","不满意？再生成一个"),e.jsxs("span",{className:"text-muted-foreground ml-auto",children:["(",g,"/",D,")"]})]}):r.length>1?e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:o("aiRecipe.video.selectHint","点击上方缩略图切换视频")}):null:e.jsxs(y,{variant:"outline",size:"sm",className:"gap-1.5 text-xs w-full",onClick:_,children:[e.jsx(O,{className:"h-3.5 w-3.5"}),o("aiRecipe.video.generateFromNote","根据心得生成视频")]})})]})]}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsxs(y,{className:"w-full gap-2",onClick:()=>x(f),disabled:s,children:[e.jsx(ne,{className:"h-4 w-4"}),s?o("common.publishing","发布中…"):o("aiRecipe.publishToCommunity","发布到社区")]})})]})};export{ce as C,fe as P,pe as R,he as u};
//# sourceMappingURL=PublishConfirmStep-CGHgxQDO.js.map
