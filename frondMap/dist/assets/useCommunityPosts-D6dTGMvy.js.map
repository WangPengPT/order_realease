{"version":3,"file":"useCommunityPosts-D6dTGMvy.js","sources":["../../src/hooks/useCommunityPosts.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { toast } from \"sonner\";\r\nimport { useTranslation } from \"react-i18next\";\r\n\r\nexport interface PostRestaurant {\r\n  id: string;\r\n  name: string;\r\n  name_en: string | null;\r\n  name_pt: string | null;\r\n}\r\n\r\nexport interface CommunityPost {\r\n  id: string;\r\n  author_id: string;\r\n  content: string;\r\n  content_en: string | null;\r\n  content_zh: string | null;\r\n  content_pt: string | null;\r\n  image_urls: string[];\r\n  video_url: string | null;\r\n  weight: number;\r\n  activity_id: string | null;\r\n  restaurant_id: string | null; // Legacy single restaurant\r\n  status: string;\r\n  moderation_status: string;\r\n  risk_score: number | null;\r\n  risk_reasons: string[] | null;\r\n  ai_reviewed_at: string | null;\r\n  likes_count: number;\r\n  comments_count: number;\r\n  shares_count: number;\r\n  views_count: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n  author?: {\r\n    id: string;\r\n    display_name: string;\r\n    avatar_url: string | null;\r\n  };\r\n  activity?: {\r\n    id: string;\r\n    title_en: string;\r\n    title_zh: string;\r\n    title_pt: string;\r\n  };\r\n  restaurant?: {\r\n    id: string;\r\n    name: string;\r\n    name_en: string | null;\r\n    name_pt: string | null;\r\n  };\r\n  // Multiple restaurants via junction table\r\n  restaurants?: PostRestaurant[];\r\n  user_liked?: boolean;\r\n}\r\n\r\nexport type SortOption = 'latest' | 'popular';\r\n\r\nexport type PostTypeFilter = 'all' | 'post' | 'recipe';\r\n\r\nexport const useCommunityPosts = (options?: { \r\n  authorId?: string; \r\n  status?: string;\r\n  limit?: number;\r\n  sortBy?: SortOption;\r\n  postType?: PostTypeFilter;\r\n}) => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"community-posts\", options],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from(\"community_posts\")\r\n        .select(`\r\n          *,\r\n          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),\r\n          activity:activities(id, title_en, title_zh, title_pt),\r\n          restaurant:restaurants(id, name, name_en, name_pt),\r\n          post_restaurants(\r\n            restaurant:restaurants(id, name, name_en, name_pt)\r\n          )\r\n        `);\r\n\r\n      // Apply sorting based on sortBy option\r\n      if (options?.sortBy === 'popular') {\r\n        query = query\r\n          .order(\"likes_count\", { ascending: false })\r\n          .order(\"created_at\", { ascending: false });\r\n      } else {\r\n        query = query\r\n          .order(\"weight\", { ascending: false })\r\n          .order(\"created_at\", { ascending: false });\r\n      }\r\n\r\n      if (options?.authorId) {\r\n        query = query.eq(\"author_id\", options.authorId);\r\n      }\r\n\r\n      if (options?.status) {\r\n        query = query.eq(\"status\", options.status);\r\n      }\r\n\r\n      // Filter by post type\r\n      if (options?.postType && options.postType !== 'all') {\r\n        query = query.eq(\"post_type\", options.postType);\r\n      }\r\n\r\n      // Apply limit - default to 100 to avoid loading thousands of posts\r\n      const limit = options?.limit || 100;\r\n      query = query.limit(limit);\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n\r\n      // Transform data to include restaurants array\r\n      const transformedData = data?.map((post: any) => ({\r\n        ...post,\r\n        restaurants: post.post_restaurants?.map((pr: any) => pr.restaurant).filter(Boolean) || [],\r\n      }));\r\n\r\n      // Check if user has liked each post - batch query\r\n      if (user && transformedData && transformedData.length > 0) {\r\n        const postIds = transformedData.map((post) => post.id);\r\n        const { data: likes } = await supabase\r\n          .from(\"post_likes\")\r\n          .select(\"post_id\")\r\n          .eq(\"user_id\", user.id)\r\n          .in(\"post_id\", postIds);\r\n\r\n        const likedPostIds = new Set(likes?.map((l) => l.post_id) || []);\r\n\r\n        return transformedData.map((post) => ({\r\n          ...post,\r\n          user_liked: likedPostIds.has(post.id),\r\n        })) as CommunityPost[];\r\n      }\r\n\r\n      return transformedData as CommunityPost[];\r\n    },\r\n  });\r\n};\r\n\r\nexport const useCommunityPost = (postId: string) => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"community-post\", postId],\r\n    queryFn: async () => {\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .select(`\r\n          *,\r\n          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),\r\n          activity:activities(id, title_en, title_zh, title_pt),\r\n          restaurant:restaurants(id, name, name_en, name_pt),\r\n          post_restaurants(\r\n            restaurant:restaurants(id, name, name_en, name_pt)\r\n          )\r\n        `)\r\n        .eq(\"id\", postId)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Transform to include restaurants array\r\n      const transformedData = {\r\n        ...data,\r\n        restaurants: (data as any).post_restaurants?.map((pr: any) => pr.restaurant).filter(Boolean) || [],\r\n      };\r\n\r\n      // Check if user has liked\r\n      if (user) {\r\n        const { data: like } = await supabase\r\n          .from(\"post_likes\")\r\n          .select(\"id\")\r\n          .eq(\"post_id\", postId)\r\n          .eq(\"user_id\", user.id)\r\n          .maybeSingle();\r\n\r\n        return { ...transformedData, user_liked: !!like } as CommunityPost;\r\n      }\r\n\r\n      return transformedData as CommunityPost;\r\n    },\r\n    enabled: !!postId,\r\n  });\r\n};\r\n\r\nexport const useCreatePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (post: {\r\n      content: string;\r\n      image_urls?: string[];\r\n      video_url?: string;\r\n      activity_id?: string;\r\n      restaurant_ids?: string[];\r\n      sensitive_word_detected?: boolean;\r\n    }) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      // Insert post with pending status\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .insert({\r\n          author_id: user.id,\r\n          content: post.content,\r\n          image_urls: post.image_urls || [],\r\n          video_url: post.video_url || null,\r\n          activity_id: post.activity_id || null,\r\n          restaurant_id: null, // Legacy field, use post_restaurants instead\r\n          status: \"pending\",\r\n          moderation_status: \"pending\",\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Insert post_restaurants relations\r\n      if (post.restaurant_ids && post.restaurant_ids.length > 0) {\r\n        const { error: relError } = await supabase\r\n          .from(\"post_restaurants\")\r\n          .insert(\r\n            post.restaurant_ids.map((restaurantId) => ({\r\n              post_id: data.id,\r\n              restaurant_id: restaurantId,\r\n            }))\r\n          );\r\n        if (relError) {\r\n          console.error(\"Failed to insert post restaurants:\", relError);\r\n        }\r\n      }\r\n\r\n      // Call moderation function and wait for it to complete\r\n      try {\r\n        await supabase.functions.invoke(\"moderate-post\", {\r\n          body: {\r\n            post_id: data.id,\r\n            content: post.content,\r\n            user_id: user.id,\r\n            image_urls: post.image_urls || [],\r\n            video_url: post.video_url || null,\r\n            sensitive_word_detected: post.sensitive_word_detected || false,\r\n          },\r\n        });\r\n      } catch (err) {\r\n        console.error(\"Moderation call failed:\", err);\r\n      }\r\n\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      // Invalidate queries to refresh the list\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"has-posted-today\"] });\r\n      toast.success(t(\"community.postSuccess\", \"帖子发布成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Create post error:\", error);\r\n      toast.error(t(\"community.postError\", \"发布失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useEditPost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (post: {\r\n      id: string;\r\n      content: string;\r\n      image_urls?: string[];\r\n      video_url?: string | null;\r\n      activity_id?: string | null;\r\n      restaurant_ids?: string[];\r\n      sensitive_word_detected?: boolean;\r\n    }) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      // Update the post and reset status to pending for re-moderation\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .update({\r\n          content: post.content,\r\n          image_urls: post.image_urls || [],\r\n          video_url: post.video_url ?? null,\r\n          activity_id: post.activity_id ?? null,\r\n          status: \"pending\",\r\n          moderation_status: \"pending\",\r\n          risk_score: null,\r\n          risk_reasons: null,\r\n          ai_reviewed_at: null,\r\n        })\r\n        .eq(\"id\", post.id)\r\n        .eq(\"author_id\", user.id) // Ensure only author can edit\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      // Update post_restaurants relations\r\n      // First delete existing relations\r\n      await supabase\r\n        .from(\"post_restaurants\")\r\n        .delete()\r\n        .eq(\"post_id\", post.id);\r\n\r\n      // Then insert new ones\r\n      if (post.restaurant_ids && post.restaurant_ids.length > 0) {\r\n        const { error: relError } = await supabase\r\n          .from(\"post_restaurants\")\r\n          .insert(\r\n            post.restaurant_ids.map((restaurantId) => ({\r\n              post_id: post.id,\r\n              restaurant_id: restaurantId,\r\n            }))\r\n          );\r\n        if (relError) {\r\n          console.error(\"Failed to update post restaurants:\", relError);\r\n        }\r\n      }\r\n\r\n      // Trigger re-moderation\r\n      try {\r\n        await supabase.functions.invoke(\"moderate-post\", {\r\n          body: {\r\n            post_id: data.id,\r\n            content: post.content,\r\n            user_id: user.id,\r\n            image_urls: post.image_urls || [],\r\n            video_url: post.video_url || null,\r\n            sensitive_word_detected: post.sensitive_word_detected || false,\r\n          },\r\n        });\r\n      } catch (err) {\r\n        console.error(\"Moderation call failed:\", err);\r\n      }\r\n\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-community-posts\"] });\r\n      toast.success(t(\"community.editSuccess\", \"帖子已更新，等待审核\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Edit post error:\", error);\r\n      toast.error(t(\"community.editError\", \"编辑失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useUpdatePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({\r\n      id,\r\n      ...updates\r\n    }: {\r\n      id: string;\r\n      content?: string;\r\n      image_urls?: string[];\r\n      video_url?: string | null;\r\n      activity_id?: string | null;\r\n      weight?: number;\r\n      status?: string;\r\n      moderation_status?: string;\r\n    }) => {\r\n      const { data, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .update(updates)\r\n        .eq(\"id\", id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      return data;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-community-posts\"] });\r\n      toast.success(t(\"common.saved\", \"保存成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Update post error:\", error);\r\n      toast.error(t(\"common.error\", \"操作失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useDeletePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (id: string) => {\r\n      const { error } = await supabase\r\n        .from(\"community_posts\")\r\n        .delete()\r\n        .eq(\"id\", id);\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"admin-community-posts\"] });\r\n      toast.success(t(\"common.deleted\", \"删除成功\"));\r\n    },\r\n    onError: (error) => {\r\n      console.error(\"Delete post error:\", error);\r\n      toast.error(t(\"common.error\", \"操作失败\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useLikePost = () => {\r\n  const queryClient = useQueryClient();\r\n\r\n  return useMutation({\r\n    mutationFn: async ({ postId, liked }: { postId: string; liked: boolean }) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      if (liked) {\r\n        // Unlike\r\n        const { error } = await supabase\r\n          .from(\"post_likes\")\r\n          .delete()\r\n          .eq(\"post_id\", postId)\r\n          .eq(\"user_id\", user.id);\r\n\r\n        if (error) throw error;\r\n      } else {\r\n        // Like\r\n        const { error } = await supabase\r\n          .from(\"post_likes\")\r\n          .insert({\r\n            post_id: postId,\r\n            user_id: user.id,\r\n          });\r\n\r\n        if (error) throw error;\r\n      }\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n    },\r\n  });\r\n};\r\n\r\nexport const useSharePost = () => {\r\n  const queryClient = useQueryClient();\r\n  const { t } = useTranslation();\r\n\r\n  return useMutation({\r\n    mutationFn: async (postId: string) => {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) throw new Error(\"Not authenticated\");\r\n\r\n      const { error } = await supabase\r\n        .from(\"post_shares\")\r\n        .insert({\r\n          post_id: postId,\r\n          user_id: user.id,\r\n        });\r\n\r\n      if (error) throw error;\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: [\"community-posts\"] });\r\n      queryClient.invalidateQueries({ queryKey: [\"community-post\"] });\r\n      toast.success(t(\"community.shared\", \"分享成功\"));\r\n    },\r\n  });\r\n};\r\n\r\nexport const useCanCreatePost = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"can-create-post\", user?.id],\r\n    queryFn: async () => {\r\n      // 现在所有登录用户都可以发帖\r\n      return !!user;\r\n    },\r\n    enabled: true,\r\n  });\r\n};\r\n\r\n// 获取商家关联的餐厅\r\nexport const useMerchantRestaurant = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"merchant-restaurant\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return null;\r\n\r\n      const { data } = await supabase\r\n        .from(\"merchant_restaurants\")\r\n        .select(\"restaurant_id, restaurants:restaurant_id(id, name, name_en, name_pt)\")\r\n        .eq(\"user_id\", user.id)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      return data?.restaurants || null;\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\n\r\n// Check if user has posted today\r\nexport const useHasPostedToday = () => {\r\n  const { user } = useAuth();\r\n\r\n  return useQuery({\r\n    queryKey: [\"has-posted-today\", user?.id],\r\n    queryFn: async () => {\r\n      if (!user) return false;\r\n\r\n      // Get start of today (local time)\r\n      const today = new Date();\r\n      today.setHours(0, 0, 0, 0);\r\n      const todayISO = today.toISOString();\r\n\r\n      // Check if user has posted today (any status)\r\n      const { count, error } = await supabase\r\n        .from(\"community_posts\")\r\n        .select(\"id\", { count: \"exact\", head: true })\r\n        .eq(\"author_id\", user.id)\r\n        .gte(\"created_at\", todayISO);\r\n\r\n      if (error) throw error;\r\n      return (count ?? 0) > 0;\r\n    },\r\n    enabled: !!user,\r\n  });\r\n};\r\n\r\n// Admin hooks\r\nexport const useAdminCommunityPosts = (options?: {\r\n  status?: string;\r\n  moderation_status?: string;\r\n  post_type?: string;\r\n  search?: string;\r\n}) => {\r\n  return useQuery({\r\n    queryKey: [\"admin-community-posts\", options],\r\n    queryFn: async () => {\r\n      let query = supabase\r\n        .from(\"community_posts\")\r\n        .select(`\r\n          *,\r\n          author:profiles!community_posts_author_id_fkey(id, display_name, avatar_url),\r\n          activity:activities(id, title_en, title_zh, title_pt),\r\n          restaurant:restaurants(id, name, name_en, name_pt)\r\n        `)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (options?.status) {\r\n        query = query.eq(\"status\", options.status);\r\n      }\r\n\r\n      if (options?.moderation_status) {\r\n        query = query.eq(\"moderation_status\", options.moderation_status);\r\n      }\r\n\r\n      if (options?.post_type) {\r\n        query = query.eq(\"post_type\", options.post_type);\r\n      }\r\n\r\n      if (options?.search) {\r\n        query = query.ilike(\"content\", `%${options.search}%`);\r\n      }\r\n\r\n      const { data, error } = await query;\r\n\r\n      if (error) throw error;\r\n      return data as CommunityPost[];\r\n    },\r\n  });\r\n};\r\n"],"names":["useCommunityPosts","options","user","useAuth","useQuery","query","supabase","limit","data","error","transformedData","post","pr","postIds","likes","likedPostIds","l","useCommunityPost","postId","like","useCreatePost","queryClient","useQueryClient","t","useTranslation","useMutation","relError","restaurantId","err","toast","useEditPost","useUpdatePost","id","updates","useDeletePost","useLikePost","liked","useSharePost","useCanCreatePost","useMerchantRestaurant","useHasPostedToday","today","todayISO","count","useAdminCommunityPosts"],"mappings":"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"}