import{p as G,j as e,bM as le,bL as se,bh as ce,ao as Pe,u as me,bu as de,cC as ue,bn as Ie,r as n,bT as Y,b3 as Te,aM as re,a4 as Le,w as h,aO as Ue,dN as qe,X as ae,b4 as oe,cw as Ee,bg as De,b1 as Me,q as _e,bY as te,dO as Ae,es as $e,bc as Fe,bb as Oe}from"./vendor-react-DImbKuZP.js";import{D as Be,a1 as ze,c as Qe,d as He,e as Ke,Q as pe,q as $,L as Ge,M as Ve,N as We,P as Xe,ae as Ye,s as q,a as Je,u as Ze,S as O}from"./index-_G3CuCzp.js";import{P as es}from"./PostGridCard--FUMjR5w.js";import{c as ss}from"./usePoints-AkMaCQUC.js";import{R as ts,b as rs,c as is,d as ns,M as as,A as os}from"./EditRecipeDialog-C_ulThZR.js";import{P as ls}from"./progress-Bi_ViBYA.js";import{u as cs}from"./useCreateRecipe-D3-oJXV2.js";import{g as ms,h as ds,i as us,u as ps,j as xs}from"./useCommunityPosts-CIwfJkFk.js";import{u as hs}from"./useActivities-B-dkIh_c.js";import{u as fs}from"./useRestaurants-DXIIBXS_.js";import{u as gs}from"./useLocalizedContent-B2SRIfSp.js";import{P as bs}from"./PullToRefresh-BimBuYXa.js";import{u as ys}from"./useInfiniteScroll-tnzLsXiS.js";import{u as js}from"./useLoginRequired-DynG1Vvm.js";import"./vendor-i18n-AOdgFpXS.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-vwQGbBim.js";import"./vendor-supabase-CRxszhSs.js";import"./drawer-CK8DetMs.js";import"./popover-CLT125d5.js";import"./collapsible-dyuDlGDF.js";const vs=()=>{const{t}=G(),{data:s}=ss(),a=s?.find(l=>l.key==="post_points")?.value||"5",b=s?.find(l=>l.key==="min_post_length")?.value||"10",u=s?.find(l=>l.key==="post_require_media")?.value==="true";return e.jsxs(Be,{children:[e.jsx(ze,{asChild:!0,children:e.jsx("button",{className:"text-primary hover:underline text-sm whitespace-nowrap",children:t("community.viewPointsRules","查看详细规则")})}),e.jsxs(Qe,{className:"max-w-md",children:[e.jsx(He,{children:e.jsxs(Ke,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-primary"}),t("community.pointsRulesTitle","发帖积分规则")]})}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:t("community.pointsRulesIntro","通过发布社区帖子获得积分，具体规则如下：")}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(se,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:t("community.rulePostPoints",{points:a})})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(se,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:t("community.ruleMinLength",{length:b})})]}),u&&e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(se,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:t("community.ruleRequireMedia","帖子必须包含至少一张图片或一个视频")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(ce,{className:"h-4 w-4 text-blue-500 mt-0.5 shrink-0"}),e.jsx("span",{children:t("community.ruleDailyLimit","每天仅可通过发帖获得一次积分奖励")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Pe,{className:"h-4 w-4 text-purple-500 mt-0.5 shrink-0"}),e.jsx("span",{children:t("community.ruleModerationRequired","帖子需通过审核后才能获得积分")})]})]})]})]})]})},Ns=({onSelect:t})=>{const{t:s}=G(),a=me(),{isAdmin:b,isMerchant:u,isSupervisor:l}=pe(),I=b||u||l;return e.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:s("community.selectPostType","选择发布类型")}),e.jsx("p",{className:"text-muted-foreground text-sm mb-8 text-center",children:s("community.selectPostTypeDesc","选择您想要发布的内容类型")}),e.jsxs("div",{className:"flex flex-col gap-3 w-full max-w-sm",children:[e.jsxs("button",{onClick:()=>t("post"),className:"flex items-center gap-4 p-4 rounded-xl border-2 border-border hover:border-primary hover:bg-primary/5 transition-all duration-200 group text-left",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors shrink-0",children:e.jsx(de,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm",children:s("community.postType.post","发布帖子")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:s("community.postType.postDesc","分享美食体验和想法")})]})]}),I&&e.jsxs("button",{onClick:()=>t("recipe"),className:"flex items-center gap-4 p-4 rounded-xl border-2 border-border hover:border-primary hover:bg-primary/5 transition-all duration-200 group text-left",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors shrink-0",children:e.jsx(ue,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm",children:s("community.postType.recipe","发布食谱")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:s("community.postType.recipeDesc","分享烹饪教程和菜谱")})]})]}),e.jsxs("button",{onClick:()=>a("/ai-recipe",{state:{from:"/community"}}),className:"flex items-center gap-4 p-4 rounded-xl border-2 border-border hover:border-primary hover:bg-primary/5 transition-all duration-200 group text-left",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors shrink-0",children:e.jsx(Ie,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm",children:s("community.postType.aiRecipe","AI 食谱")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:s("community.postType.aiRecipeDesc","AI 识别食材并生成菜谱")})]})]})]})]})},ws=({onClose:t,onSuccess:s})=>{const{t:a}=G(),b=cs(),[u,l]=n.useState(0),[I,E]=n.useState(null),[x,y]=n.useState({recipe_name:"",cook_time:void 0,difficulty:void 0,servings:void 0}),[D,M]=n.useState([{name:"",amount:"",unit:""}]),[j,F]=n.useState([{order:1,description:""}]),[k,S]=n.useState({}),[C,_]=n.useState(""),f=[{key:"basic",title:a("recipe.step.basic","基本信息")},{key:"ingredients",title:a("recipe.step.ingredients","配料")},{key:"steps",title:a("recipe.step.steps","步骤")}],R=(u+1)/f.length*100,P=()=>x.recipe_name?.trim()?!x.cook_time||x.cook_time<1?(h.error(a("recipe.cookTimeRequired","请输入烹饪时间")),!1):x.difficulty?!x.servings||x.servings<1?(h.error(a("recipe.servingsRequired","请输入份量")),!1):!0:(h.error(a("recipe.difficultyRequired","请选择难度")),!1):(h.error(a("recipe.nameRequired","请输入食谱名称")),!1),v=()=>D.filter(N=>N.name.trim()).length===0?(h.error(a("recipe.ingredientsRequired","请至少添加一种配料")),!1):!0,o=()=>j.filter(N=>N.description.trim()).length===0?(h.error(a("recipe.stepsRequired","请至少添加一个步骤")),!1):!0,g=()=>{u===0&&!P()||u===1&&!v()||l(m=>Math.min(m+1,f.length-1))},B=()=>{l(m=>Math.max(m-1,0))},V=async()=>{if(!o())return;const m=D.filter(w=>w.name.trim()),N=j.filter(w=>w.description.trim()).map((w,J)=>({...w,order:J+1})),z=k.calories||k.protein||k.carbs||k.fat;try{await b.mutateAsync({recipe_name:x.recipe_name,cook_time:x.cook_time,difficulty:x.difficulty,servings:x.servings,ingredients:m,steps:N,cover_image:I,nutrition:z?k:void 0,introduction:C.trim()||void 0}),s()}catch{}},W=()=>{switch(u){case 0:return e.jsx(is,{data:x,coverImage:I,nutrition:k,introduction:C,onDataChange:y,onCoverImageChange:E,onNutritionChange:S,onIntroductionChange:_});case 1:return e.jsx(rs,{ingredients:D,onChange:M});case 2:return e.jsx(ts,{steps:j,onChange:F});default:return null}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-background shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("button",{type:"button",onClick:t,className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(Y,{className:"h-5 w-5"})}),e.jsx("h2",{className:"font-medium",children:a("recipe.createTitle","创建食谱")}),e.jsx("div",{className:"w-6"})," "]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ls,{value:R,className:"h-1"}),e.jsx("div",{className:"flex justify-between text-xs text-muted-foreground",children:f.map((m,N)=>e.jsx("span",{className:N===u?"text-primary font-medium":"",children:m.title},m.key))})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:W()}),e.jsx("div",{className:"px-4 py-3 pb-[max(1rem,env(safe-area-inset-bottom))] border-t bg-background shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[u>0&&e.jsxs($,{type:"button",variant:"outline",onClick:B,className:"flex-1",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),a("common.back","上一步")]}),u<f.length-1?e.jsxs($,{type:"button",onClick:g,className:"flex-1",children:[a("common.next","下一步"),e.jsx(Te,{className:"h-4 w-4 ml-2"})]}):e.jsxs($,{type:"button",onClick:V,disabled:b.isPending,className:"flex-1",children:[b.isPending?e.jsx(re,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Le,{className:"h-4 w-4 mr-2"}),a("recipe.publish","发布食谱")]})]})})]})},ks=({trigger:t})=>{const{t:s}=G(),a=Ue(),b=me(),{getLocalizedField:u}=gs(),l=ms(),{data:I}=hs(),{data:E}=fs(),{role:x,isMerchant:y,isAdmin:D,isSupervisor:M}=pe(),{data:j}=ds(),{data:F,isLoading:k}=us(),[S,C]=n.useState(!1),[_,f]=n.useState("selecting");n.useEffect(()=>{a.state?.openCreatePost&&(C(!0),f("selecting"),b(a.pathname,{replace:!0,state:{}}))},[a.state]);const[R,P]=n.useState(""),[v,o]=n.useState([]),[g,B]=n.useState(null),[V,W]=n.useState(""),[m,N]=n.useState([]),[z,w]=n.useState(!1),[J,ie]=n.useState(!1),[xe,ne]=n.useState(!1),[Z,Q]=n.useState(!1),H=n.useRef(null),X=n.useRef(null),K=!y&&!M&&!D;n.useEffect(()=>{y&&j&&S&&N([j.id])},[y,j,S]);const ee=()=>{f("selecting"),P(""),o([]),B(null),W(""),N([]),ie(!1),ne(!1),Q(!1)};n.useEffect(()=>{S&&f("selecting")},[S]);const he=r=>{C(r),r||ee()},fe=I?.filter(r=>r.status==="published")||[],ge=async r=>{const c=r.target.files;if(!(!c||c.length===0)){if(v.length+c.length>9){h.error(s("community.maxImages","最多上传9张图片"));return}w(!0);try{const{data:{user:p}}=await q.auth.getUser();if(!p)throw new Error("Not authenticated");const i=[];for(const d of Array.from(c)){const A=d.name.split(".").pop(),T=`${p.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${A}`,{error:L}=await q.storage.from("community-posts").upload(T,d);if(L)throw L;const{data:{publicUrl:U}}=q.storage.from("community-posts").getPublicUrl(T);i.push(U)}o(d=>[...d,...i])}catch(p){console.error("Upload error:",p),h.error(s("common.uploadError","上传失败"))}finally{w(!1),H.current&&(H.current.value="")}}},be=r=>new Promise((c,p)=>{const i=document.createElement("video"),d=document.createElement("canvas"),A=d.getContext("2d");i.preload="auto",i.muted=!0,i.playsInline=!0;let T=!1;const L=()=>{T||i.videoWidth===0||i.videoHeight===0||(d.width=i.videoWidth,d.height=i.videoHeight,A&&(A.drawImage(i,0,0,d.width,d.height),d.toBlob(U=>{U&&U.size>0?(T=!0,i.pause(),URL.revokeObjectURL(i.src),c(U)):p(new Error("Failed to create blob"))},"image/jpeg",.85)))};i.onloadedmetadata=()=>{d.width=i.videoWidth,d.height=i.videoHeight,i.currentTime=.1},i.onseeked=()=>{setTimeout(L,100)},i.onerror=()=>{URL.revokeObjectURL(i.src),p(new Error("Failed to load video"))},setTimeout(()=>{T||(URL.revokeObjectURL(i.src),p(new Error("Timeout")))},1e4),i.src=URL.createObjectURL(r),i.load()}),ye=async r=>{const c=r.target.files?.[0];if(c){if(c.size>100*1024*1024){h.error(s("community.videoTooLarge","视频不能超过100MB"));return}w(!0);try{const{data:{user:p}}=await q.auth.getUser();if(!p)throw new Error("Not authenticated");const i=c.name.split(".").pop(),d=`${p.id}/${Date.now()}.${i}`,{error:A}=await q.storage.from("community-posts").upload(d,c);if(A)throw A;const{data:{publicUrl:T}}=q.storage.from("community-posts").getPublicUrl(d);B(T);try{h.info(s("community.extractingCover","正在提取视频封面..."));const L=await be(c),U=`${p.id}/${Date.now()}-cover.jpg`,{error:Ce}=await q.storage.from("community-posts").upload(U,L);if(!Ce){const{data:{publicUrl:Se}}=q.storage.from("community-posts").getPublicUrl(U);o(Re=>[Se,...Re]),h.success(s("community.coverExtracted","封面已自动生成"))}}catch(L){console.warn("Cover extraction failed:",L)}}catch(p){console.error("Upload error:",p),h.error(s("common.uploadError","上传失败"))}finally{w(!1),X.current&&(X.current.value="")}}},je=r=>{o(c=>c.filter((p,i)=>i!==r))},ve=()=>{B(null),o(r=>r.length>0&&r[0].includes("-cover.jpg")?r.slice(1):r)},Ne=async()=>{if(Q(!1),!R.trim()){h.error(s("community.contentRequired","请输入内容"));return}if(K&&m.length===0){Q(!0),h.error(s("community.restaurantRequired","请选择餐厅"));return}await l.mutateAsync({content:R,image_urls:v,video_url:g||void 0,activity_id:V||void 0,restaurant_ids:m.length>0?m:void 0}),ee(),C(!1)},we=()=>j?u(j,"name"):s("community.noRestaurant","未关联餐厅"),ke=()=>{ee(),C(!1)};return e.jsxs(Ge,{open:S,onOpenChange:he,children:[e.jsx(Ve,{asChild:!0,children:t||e.jsx($,{children:s("community.createPost","发布帖子")})}),e.jsxs(We,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(qe,{children:e.jsx(Xe,{children:s("community.createPost","发布帖子")})}),_==="selecting"&&e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>C(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(Y,{className:"h-5 w-5"})}),e.jsx("span",{className:"font-medium",children:s("community.create","发布")}),e.jsx("div",{className:"w-6"})]}),e.jsx(Ns,{onSelect:f})]}),_==="recipe"&&e.jsx(ws,{onClose:()=>f("selecting"),onSuccess:ke}),_==="post"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:H,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:ge}),e.jsx("input",{ref:X,type:"file",accept:"video/*",className:"hidden",onChange:ye}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>f("selecting"),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(Y,{className:"h-5 w-5"})}),e.jsxs($,{size:"sm",onClick:Ne,disabled:l.isPending||!R.trim(),className:"rounded-full px-6",children:[l.isPending&&e.jsx(re,{className:"h-4 w-4 mr-2 animate-spin"}),s("community.publish","发布")]})]}),!k&&!F&&e.jsxs("div",{className:"flex items-center justify-between gap-2 px-4 py-2 bg-primary/10 dark:bg-primary/20 border-b border-primary/30 dark:border-primary/40 text-sm text-primary dark:text-primary shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:s("community.dailyPointsHint","每日发布首个帖子可获得5积分！")})]}),e.jsx(vs,{})]}),e.jsxs("div",{className:"flex-1 flex flex-row overflow-hidden min-h-0",children:[e.jsxs("div",{className:"w-[45%] border-r bg-muted/20 flex flex-col overflow-hidden shrink-0",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-3",children:[v.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-2",children:v.map((r,c)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:r,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>je(c),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(ae,{className:"h-3 w-3"})})]},c))}),g&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:g,controls:!0,className:"w-full",preload:"metadata"}),e.jsx("button",{type:"button",onClick:ve,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(ae,{className:"h-4 w-4"})})]}),v.length===0&&!g&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 h-40 border-2 border-dashed border-muted-foreground/30 rounded-xl text-muted-foreground cursor-pointer hover:border-primary/50 hover:text-primary transition-colors",onClick:()=>H.current?.click(),children:[e.jsx(oe,{className:"h-8 w-8"}),e.jsx("span",{className:"text-sm",children:s("community.addPhoto","添加图片")})]})]}),e.jsxs("div",{className:"flex items-center gap-4 px-3 py-3 border-t bg-background pb-[max(0.75rem,env(safe-area-inset-bottom))] shrink-0",children:[e.jsxs("button",{type:"button",onClick:()=>H.current?.click(),disabled:z||v.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(oe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:s("community.photo","照片")})]}),e.jsxs("button",{type:"button",onClick:()=>X.current?.click(),disabled:z||!!g,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Ee,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:s("community.video","视频")})]}),z&&e.jsx(re,{className:"h-4 w-4 animate-spin ml-auto text-muted-foreground"})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(Ye,{value:R,onChange:r=>P(r.target.value),placeholder:s("community.contentPlaceholder","分享你的想法..."),className:"min-h-full h-full border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base whitespace-pre-wrap"})}),e.jsxs("div",{className:"px-4 py-2 border-t bg-background shrink-0 space-y-2 pb-[max(0.75rem,env(safe-area-inset-bottom))]",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsx(ns,{onSelect:r=>P(c=>c+r)}),e.jsxs("div",{className:`flex items-center gap-2 ${Z&&K&&m.length===0?"text-destructive":""}`,children:[e.jsx(De,{className:`h-4 w-4 shrink-0 ${Z&&K&&m.length===0?"text-destructive":"text-muted-foreground"}`}),y?e.jsx("span",{className:"text-sm text-muted-foreground",children:we()}):e.jsx(as,{open:J,onOpenChange:r=>{ie(r),r&&Q(!1)},value:m,onSelect:r=>{N(r),Q(!1)},restaurants:E||[],required:K})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx(os,{open:xe,onOpenChange:ne,value:V,onSelect:W,activities:fe})]})]}),Z&&K&&m.length===0&&e.jsx("p",{className:"text-xs text-destructive",children:s("community.restaurantRequired","请选择餐厅")})]})]})]})]})]})]})},Cs=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(O,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{className:"h-4 w-full"}),e.jsx(O,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5 rounded-full"}),e.jsx(O,{className:"h-3 w-16"})]}),e.jsx(O,{className:"h-4 w-10"})]})]})]}),Gs=()=>{const{t}=G(),s=_e(),a=Je(),{user:b}=Ze(),{requireLogin:u}=js(),[l,I]=n.useState(()=>localStorage.getItem("community-mobile-layout")==="single"?"single":"double"),[E,x]=n.useState(()=>localStorage.getItem("community-sort")==="popular"?"popular":"latest"),[y,D]=n.useState(()=>{const o=localStorage.getItem("community-post-type");return["all","post","recipe"].includes(o||"")?o:"all"}),{data:M,isLoading:j}=ps({status:"approved",sortBy:E,postType:y}),{data:F}=xs(),{displayedData:k,hasMore:S,sentinelRef:C}=ys({data:M,initialItemsPerPage:12,incrementPerPage:12}),_=n.useCallback(async()=>{s.removeQueries({queryKey:["community-posts"]}),s.removeQueries({queryKey:["can-create-post"]}),s.removeQueries({queryKey:["has-posted-today"]}),await Promise.all([s.invalidateQueries({queryKey:["community-posts"]}),s.invalidateQueries({queryKey:["can-create-post"]}),s.invalidateQueries({queryKey:["has-posted-today"]})])},[s]),f=()=>{const o=l==="double"?"single":"double";I(o),localStorage.setItem("community-mobile-layout",o)},R=o=>{const g=o;x(g),localStorage.setItem("community-sort",g)},P=o=>{D(o),localStorage.setItem("community-post-type",o)},v=()=>a?l==="single"?"columns-1 gap-4":"columns-2 gap-3":"columns-3 lg:columns-4 gap-4";return e.jsx(bs,{onRefresh:_,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-5xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl mb-2 text-primary font-medium",children:t("community.title","社区")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:t("community.description","分享美食体验，发现更多精彩")})]}),F?e.jsx(ks,{trigger:e.jsxs($,{size:"sm",className:"gap-1.5",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.createPost","发布")})]})}):b?null:e.jsxs($,{size:"sm",className:"gap-1.5",onClick:()=>u(),children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.createPost","发布")})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs("div",{className:"inline-flex h-9 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>R("latest"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${E==="latest"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(ce,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.sortLatest","最新")})]}),e.jsxs("button",{onClick:()=>R("popular"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${E==="popular"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(Ae,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.sortPopular","热门")})]})]}),e.jsxs("div",{className:"inline-flex h-9 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>P("all"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${y==="all"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx($e,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.filterAll","全部")})]}),e.jsxs("button",{onClick:()=>P("post"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${y==="post"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(de,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.filterPost","帖子")})]}),e.jsxs("button",{onClick:()=>P("recipe"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${y==="recipe"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(ue,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:t("community.filterRecipe","食谱")})]})]}),a&&e.jsx("button",{onClick:f,className:"ml-auto inline-flex h-9 items-center justify-center whitespace-nowrap rounded-md bg-muted px-2.5 py-1.5 text-sm font-medium text-muted-foreground ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",title:l==="double"?t("community.singleColumn","单列布局"):t("community.doubleColumn","双列布局"),children:l==="double"?e.jsx(Fe,{className:"h-3.5 w-3.5"}):e.jsx(Oe,{className:"h-3.5 w-3.5"})})]}),j?e.jsx("div",{className:v(),children:Array.from({length:8}).map((o,g)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Cs,{})},g))}):M&&M.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:v(),children:k.map(o=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(es,{post:o,showAssociations:a&&l==="single"})},o.id))}),S&&e.jsx("div",{ref:C,className:"flex justify-center py-6",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent"})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(te,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:t("community.noPosts","暂无帖子")}),F&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:t("community.beFirst","成为第一个发帖的人吧！")})]})]})})})};export{Gs as default};
//# sourceMappingURL=Community-BJbl4pzG.js.map
