import{u as fe,p as ge,r as n,j as e,b4 as z,b8 as ve,bo as be,bp as je,aw as H,ay as W,bb as M,ba as Z,bd as Ne}from"./vendor-react-BSvuipka.js";import{f as G}from"./textFormatting-3w-RxSBr.js";import{z as we,I as ye,h as p,B as o,C as J,F as ke,s as Ce}from"./index-Cu2A95Qe.js";import{P as Re,a as Fe,b as Se}from"./popover-CKKt4HJD.js";import{u as Le,b as ze}from"./useRestaurants-D41ccbkM.js";import{c as Me,g as Te}from"./geolocation-YPf7LJYy.js";import{u as _e,R as $e,l as Ee}from"./xiaoxiong-logo-clean-CnXaVAyc.js";import{u as Ae}from"./useLocalizedContent-lJaVO1Dw.js";import{u as Ie}from"./useActivities-uhCSB7LV.js";import{L as De}from"./LocationPermissionDialog-DYRrN2TK.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-vwQGbBim.js";import"./vendor-supabase-CH4YygDL.js";import"./vendor-map-CvE3ASYw.js";import"./map-icon-DR07RZr_.js";const K=({restaurant:y,language:t})=>{const[m,k]=n.useState(999),j=n.useRef(null),f=y.type.slice(0,3).map((r,d)=>({key:`type-${d}`,label:r,variant:"secondary",color:void 0}));n.useEffect(()=>{const r=()=>{if(!j.current)return;const N=j.current,h=Array.from(N.querySelectorAll(".tag-badge"));if(h.length===0){setTimeout(r,50);return}const g=h[0]?.offsetTop;let l=h.length;for(let v=0;v<h.length;v++)if(h[v].offsetTop>g){l=v;break}l<h.length&&(l=Math.max(1,l-1)),k(l)};k(999);const d=setTimeout(r,100);return window.addEventListener("resize",r),()=>{clearTimeout(d),window.removeEventListener("resize",r)}},[f.length,y.id]);const T=f.slice(0,m),x=f.length>m;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{ref:j,className:"flex gap-1.5 flex-wrap flex-1",children:T.map(r=>e.jsx(o,{variant:r.variant,className:"text-xs font-medium whitespace-nowrap tag-badge",style:r.color?{backgroundColor:r.color,color:"white"}:void 0,children:r.label},r.key))}),x&&e.jsxs(Re,{children:[e.jsx(Fe,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"sm",className:"h-6 px-2 text-muted-foreground hover:text-foreground flex-shrink-0",children:e.jsx(Ne,{className:"h-4 w-4"})})}),e.jsx(Se,{className:"w-80",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:f.map(r=>e.jsx(o,{variant:r.variant,className:"text-xs font-medium",style:r.color?{backgroundColor:r.color,color:"white"}:void 0,children:r.label},r.key))})})]})]})},ss=()=>{const y=fe(),{t,i18n:m}=ge(),{toast:k}=we(),{localizeRestaurant:j}=Ae(),[f,T]=n.useState(""),[x,r]=n.useState([]),[d,N]=n.useState(null),[h,g]=n.useState([]),[l,v]=n.useState(null),[i,Y]=n.useState(null),[_,ee]=n.useState(!1),[C,se]=n.useState(!1),[R,ae]=n.useState(!1),b=n.useRef(null),F=n.useRef(null),$=n.useRef({}),[P,te]=n.useState(null),[E,re]=n.useState(!1),[ne,A]=n.useState(!1),[I,le]=n.useState(!1),[D,ie]=n.useState(!1),V=4,{data:oe,isLoading:ce}=Le(f,x.length>0?x.join(","):void 0),{data:S=[]}=ze(),{data:de=[]}=Ie(),{data:me={}}=_e(),w=de.filter(s=>(me[s.id]||0)>0),U=s=>{r(a=>a.includes(s)?a.filter(c=>c!==s):[...a,s])},O=()=>{A(!0)},xe=async()=>{A(!1);try{const s=await Te();Y({lat:s.coords.latitude,lng:s.coords.longitude}),k({title:t("restaurants.locationEnabled"),description:t("restaurants.sortByDistance")})}catch(s){console.error("Location error:",s)}},L=s=>{v(s),s&&!i&&O()},Q=async s=>{if(d===s)N(null),g([]);else{N(s);const{data:a,error:c}=await Ce.from("activity_restaurants").select("restaurant_id").eq("activity_id",s);c?(console.error("Error fetching activity restaurants:",c),g([])):g(a.map(pe=>pe.restaurant_id))}},X=oe?.map(s=>{const a=j(s);if(i){const c=Me(i.lat,i.lng,s.lat,s.lng);return{...a,distance:c}}return a})||[],B=d?X.filter(s=>h.includes(s.id)):X,u=l&&i?B.filter(s=>s.distance&&s.distance<=l).sort((s,a)=>(s.distance||0)-(a.distance||0)):i?B.sort((s,a)=>(s.distance||0)-(a.distance||0)):B.sort((s,a)=>(a.rating||0)-(s.rating||0)),q=s=>{y(`/restaurant/${s.id}`)},ue=s=>{te(s.id);const a=$.current[s.id];a&&a.scrollIntoView({behavior:"smooth",block:"center"})},he=()=>{const s=document.getElementById("home-map-container");if(s)if(_)document.exitFullscreen&&document.exitFullscreen();else{if(b.current){const a=b.current.getCenter(),c=b.current.getZoom();F.current={center:[a.lng,a.lat],zoom:c}}s.requestFullscreen&&s.requestFullscreen()}};return n.useEffect(()=>{const s=()=>{const a=!!document.fullscreenElement;ee(a),!a&&F.current&&b.current&&setTimeout(()=>{b.current?.jumpTo({center:F.current.center,zoom:F.current.zoom})},100)};return document.addEventListener("fullscreenchange",s),()=>{document.removeEventListener("fullscreenchange",s)}},[]),e.jsxs("div",{className:"animate-fade-in",children:[e.jsxs("div",{className:"text-left mb-6",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-foreground mb-2 sm:mb-3",children:t("nav.mapView")}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:t("map.subtitle")})]}),e.jsxs("div",{className:"mb-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"flex-1 max-w-md",children:e.jsx(ye,{placeholder:t("restaurants.search"),value:f,onChange:s=>T(s.target.value),className:"h-11 bg-background/60 backdrop-blur-sm border-primary/20 focus:border-primary"})}),e.jsxs("div",{className:"flex gap-2 md:contents",children:[e.jsxs(p,{variant:i?"default":"outline",onClick:i?void 0:O,className:"flex-1 md:flex-initial gap-2 h-11 md:px-6",children:[e.jsx(z,{className:`w-4 h-4 ${i?"animate-pulse":""}`}),e.jsx("span",{className:"md:hidden",children:t("restaurants.getLocationMobile")}),e.jsx("span",{className:"hidden md:inline",children:t(i?"restaurants.locationEnabled":"restaurants.getLocation")})]}),e.jsxs(p,{variant:E?"default":"outline",onClick:()=>re(!E),className:"flex-1 md:flex-initial gap-2 h-11 md:px-6",children:[e.jsx(ve,{className:"w-4 h-4"}),t("restaurants.filter")]})]})]}),E&&e.jsxs("div",{className:"space-y-3 bg-card/50 backdrop-blur-sm rounded-lg p-4 border border-border/50 animate-fade-in",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-sm font-semibold text-foreground",children:[t("restaurants.restaurantTypes"),":"]}),x.length>0&&e.jsx(o,{variant:"outline",className:"cursor-pointer hover:bg-destructive hover:text-destructive-foreground hover:scale-105 transition-all duration-200 px-2 py-0 text-xs h-5",onClick:()=>r([]),children:t("common.actions.clearFilter")}),S.length>8&&e.jsx(p,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-primary hover:text-primary/80 ml-auto hidden sm:flex transition-all duration-200",onClick:()=>se(!C),children:t(C?"common.showLess":"common.showMore")})]}),e.jsxs("div",{className:"relative overflow-hidden",children:[e.jsx("div",{className:`hidden sm:flex gap-2 flex-wrap transition-all duration-300 ease-out ${C?"animate-expand-height":""}`,children:(C?S:S.slice(0,8)).map((s,a)=>e.jsx(o,{variant:x.includes(s)?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap hover:scale-105 active:animate-tag-select ${x.includes(s)?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>U(s),children:s},s))}),e.jsxs("div",{className:"sm:hidden relative -mx-1 px-1",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory scroll-smooth",children:S.map((s,a)=>e.jsx(o,{variant:x.includes(s)?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap flex-shrink-0 snap-start hover:scale-105 active:animate-tag-select ${x.includes(s)?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>U(s),children:s},s))}),e.jsx("div",{className:"absolute left-0 top-0 bottom-2 w-4 bg-gradient-to-r from-card via-card/60 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-2 w-4 bg-gradient-to-l from-card via-card/60 to-transparent pointer-events-none"})]})]})]}),w.length>0&&e.jsxs("div",{className:"space-y-2 pt-1 border-t border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-sm font-semibold text-foreground",children:[t("nav.activities"),":"]}),d&&e.jsx(o,{variant:"outline",className:"cursor-pointer hover:bg-destructive hover:text-destructive-foreground hover:scale-105 transition-all duration-200 px-2 py-0 text-xs h-5",onClick:()=>{N(null),g([])},children:t("common.actions.clearFilter")}),w.length>8&&e.jsx(p,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-primary hover:text-primary/80 ml-auto hidden sm:flex transition-all duration-200",onClick:()=>ae(!R),children:t(R?"common.showLess":"common.showMore")})]}),e.jsxs("div",{className:"relative overflow-hidden",children:[e.jsx("div",{className:`hidden sm:flex gap-2 flex-wrap transition-all duration-300 ease-out ${R?"animate-expand-height":""}`,children:(R?w:w.slice(0,8)).map((s,a)=>{const c=m.language==="zh"?s.badge_text_zh||s.title_zh:m.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(o,{variant:d===s.id?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap hover:scale-105 active:animate-tag-select ${d===s.id?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>Q(s.id),children:c},s.id)})}),e.jsxs("div",{className:"sm:hidden relative -mx-1 px-1",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory scroll-smooth",children:w.map((s,a)=>{const c=m.language==="zh"?s.badge_text_zh||s.title_zh:m.language==="pt"?s.badge_text_pt||s.title_pt:s.badge_text_en||s.title_en;return e.jsx(o,{variant:d===s.id?"default":"secondary",className:`cursor-pointer transition-all duration-200 px-3 py-1.5 text-xs whitespace-nowrap flex-shrink-0 snap-start hover:scale-105 active:animate-tag-select ${d===s.id?"ring-2 ring-primary/30 shadow-sm":""}`,style:{animationDelay:`${a*30}ms`},onClick:()=>Q(s.id),children:c},s.id)})}),e.jsx("div",{className:"absolute left-0 top-0 bottom-2 w-4 bg-gradient-to-r from-card via-card/60 to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute right-0 top-0 bottom-2 w-4 bg-gradient-to-l from-card via-card/60 to-transparent pointer-events-none"})]})]})]})]}),i&&e.jsxs("div",{className:"flex gap-2 flex-wrap items-center bg-muted/30 backdrop-blur-sm rounded-lg p-3 border border-primary/10",children:[e.jsxs("span",{className:"text-sm font-semibold text-primary",children:[t("restaurants.radius"),":"]}),e.jsx(o,{variant:l===null?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>L(null),children:t("restaurants.allRestaurants")}),e.jsx(o,{variant:l===5?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>L(5),children:t("restaurants.radius5km")}),e.jsx(o,{variant:l===10?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>L(10),children:t("restaurants.radius10km")}),e.jsx(o,{variant:l===20?"default":"secondary",className:"cursor-pointer hover:scale-105 transition-transform",onClick:()=>L(20),children:t("restaurants.radius20km")})]})]}),!ce&&u&&e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsx("div",{className:`w-full lg:flex-1 transition-all duration-300 ease-in-out ${I?"h-0 overflow-hidden lg:h-[500px]":"h-[400px] lg:h-[500px]"}`,children:e.jsxs("div",{id:"home-map-container",className:`${_?"fixed inset-0 z-50 bg-background":"w-full h-full"} rounded-xl overflow-hidden shadow-2xl border border-primary/10 relative group`,children:[e.jsx(p,{variant:"secondary",size:"icon",className:"absolute bottom-4 right-4 z-10 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity",onClick:he,children:_?e.jsx(be,{className:"w-5 h-5"}):e.jsx(je,{className:"w-5 h-5"})}),e.jsxs("div",{className:"h-full relative",children:[e.jsx($e,{restaurants:u,onRestaurantClick:q,userLocation:i,radiusFilter:l,onMarkerClick:ue,showViewDetailsButton:!0,onMapInit:s=>{b.current=s}}),e.jsxs("div",{className:"absolute bottom-4 left-4 z-10 pointer-events-none flex items-center gap-2 bg-background/80 backdrop-blur-sm px-3 py-2 rounded-full shadow-lg",children:[e.jsx("img",{src:Ee,alt:"Xiaoxiong Market Logo",className:"h-6 w-6 object-contain"}),e.jsx("span",{className:"text-sm font-semibold text-foreground whitespace-nowrap",children:m.language==="zh"?"小熊市场":"Xiaoxiong Market"})]})]})]})}),e.jsx(p,{variant:"outline",size:"sm",className:"lg:hidden flex items-center justify-center gap-2 -mt-3 mb-1",onClick:()=>le(!I),children:I?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4"}),t("map.showMap")]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-4 h-4"}),t("map.hideMap")]})}),e.jsxs("div",{className:"w-full lg:w-[420px] flex flex-col",children:[e.jsxs("div",{className:"mb-4 pb-4 border-b border-border",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(M,{className:"w-6 h-6 text-primary"}),t("restaurants.title"),e.jsx(o,{variant:"secondary",className:"ml-2",children:u.length})]}),i&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-2 flex items-center gap-1.5",children:[e.jsx(z,{className:"w-4 h-4"}),t("restaurants.sortedByDistance")]})]}),u.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(M,{className:"w-16 h-16 text-muted-foreground/40 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-foreground mb-2",children:t("restaurants.noResults")}),e.jsx("p",{className:"text-muted-foreground max-w-xs",children:t("restaurants.noResultsDesc")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"lg:hidden space-y-3 pb-4",children:[(D?u:u.slice(0,V)).map(s=>e.jsx(J,{ref:a=>$.current[s.id]=a,className:`p-5 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-primary/40 border-2 bg-gradient-to-br from-card to-card/50 backdrop-blur-sm ${P===s.id?"border-primary ring-2 ring-primary ring-offset-2":"border-transparent"}`,onClick:()=>q(s),children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-foreground line-clamp-1 flex-1",children:G(s.name)}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full w-fit",children:[e.jsx(z,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.distance<1?`${(s.distance*1e3).toFixed(0)} m`:`${s.distance.toFixed(1)} km`})]})]}),s.rating>0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full flex-shrink-0",children:[e.jsx(Z,{className:"w-4 h-4",style:{fill:"#016450",color:"#016450"}}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.rating})]})]}),s.type&&s.type.length>0&&e.jsx(K,{restaurant:s,language:m.language}),e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(M,{className:"w-4 h-4 mt-0.5 flex-shrink-0 text-primary/60"}),e.jsx("span",{className:"line-clamp-2",children:s.address})]})]})},s.id)),u.length>V&&e.jsx(p,{variant:"outline",className:"w-full mt-2 gap-2",onClick:()=>ie(!D),children:D?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-4 h-4"}),t("map.collapseList")]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4"}),t("map.showAllRestaurants",{count:u.length})]})})]}),e.jsx(ke,{className:"hidden lg:block h-[420px] pr-4",children:e.jsx("div",{className:"space-y-3 pb-4",children:u.map(s=>e.jsx(J,{ref:a=>$.current[s.id]=a,className:`p-5 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:border-primary/40 border-2 bg-gradient-to-br from-card to-card/50 backdrop-blur-sm ${P===s.id?"border-primary ring-2 ring-primary ring-offset-2":"border-transparent"}`,onClick:()=>q(s),children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-foreground line-clamp-1 flex-1",children:G(s.name)}),s.distance!==void 0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full w-fit",children:[e.jsx(z,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.distance<1?`${(s.distance*1e3).toFixed(0)} m`:`${s.distance.toFixed(1)} km`})]})]}),s.rating>0&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-primary/10 px-2.5 py-1 rounded-full flex-shrink-0",children:[e.jsx(Z,{className:"w-4 h-4",style:{fill:"#016450",color:"#016450"}}),e.jsx("span",{className:"font-bold text-sm text-primary",children:s.rating})]})]}),s.type&&s.type.length>0&&e.jsx(K,{restaurant:s,language:m.language}),e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(M,{className:"w-4 h-4 mt-0.5 flex-shrink-0 text-primary/60"}),e.jsx("span",{className:"line-clamp-2",children:s.address})]})]})},s.id))})})]})]})]}),e.jsx(De,{open:ne,onOpenChange:A,onConfirm:xe})]})};export{ss as default};
//# sourceMappingURL=HomeMapSection-Bz91aPHI.js.map
