{"version":3,"file":"usePageView-Bmbq_-xM.js","sources":["../../src/hooks/usePageView.ts"],"sourcesContent":["import { useEffect, useRef } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\n\r\nconst LOCATION_CACHE_KEY = \"location_cache\";\r\n\r\ninterface LocationData {\r\n  country: string | null;\r\n  city: string | null;\r\n  region: string | null;\r\n  ip?: string | null;\r\n}\r\n\r\n// Generate or retrieve a persistent visitor ID\r\nconst getVisitorId = (): string => {\r\n  const key = \"visitor_id\";\r\n  let visitorId = localStorage.getItem(key);\r\n  if (!visitorId) {\r\n    visitorId = crypto.randomUUID();\r\n    localStorage.setItem(key, visitorId);\r\n  }\r\n  return visitorId;\r\n};\r\n\r\n// Get cached location data from sessionStorage\r\nconst getCachedLocation = (): LocationData | null => {\r\n  try {\r\n    const cached = sessionStorage.getItem(LOCATION_CACHE_KEY);\r\n    if (cached) {\r\n      return JSON.parse(cached);\r\n    }\r\n  } catch {\r\n    // Ignore parse errors\r\n  }\r\n  return null;\r\n};\r\n\r\n// Cache location data to sessionStorage\r\nconst cacheLocation = (data: LocationData): void => {\r\n  try {\r\n    sessionStorage.setItem(LOCATION_CACHE_KEY, JSON.stringify(data));\r\n  } catch {\r\n    // Ignore storage errors\r\n  }\r\n};\r\n\r\n// Fetch location data via Edge Function (avoids CORS and rate limits)\r\nconst fetchLocationData = async (): Promise<LocationData> => {\r\n  // Check cache first\r\n  const cached = getCachedLocation();\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n\r\n  try {\r\n    const { data, error } = await supabase.functions.invoke('get-location');\r\n    \r\n    if (error) {\r\n      console.error(\"Failed to fetch location:\", error);\r\n      return { country: null, city: null, region: null };\r\n    }\r\n\r\n    const locationData: LocationData = {\r\n      country: data?.country || null,\r\n      city: data?.city || null,\r\n      region: data?.region || null,\r\n      ip: data?.ip || null,\r\n    };\r\n\r\n    // Cache successful result\r\n    if (locationData.country || locationData.city) {\r\n      cacheLocation(locationData);\r\n    }\r\n\r\n    return locationData;\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch location data:\", error);\r\n    return { country: null, city: null, region: null };\r\n  }\r\n};\r\n\r\ntype PageType = \r\n  | \"home\" \r\n  | \"restaurant\" \r\n  | \"activity\" \r\n  | \"restaurants\" \r\n  | \"activities\" \r\n  | \"map\" \r\n  | \"profile\"\r\n  | \"auth\"\r\n  | \"join-us\"\r\n  | \"other\";\r\n\r\ninterface UsePageViewOptions {\r\n  pageType: PageType;\r\n  targetId?: string;\r\n}\r\n\r\nexport const usePageView = ({ pageType, targetId }: UsePageViewOptions) => {\r\n  const { user } = useAuth();\r\n  const tracked = useRef(false);\r\n\r\n  useEffect(() => {\r\n    // Only track once per component mount\r\n    if (tracked.current) return;\r\n    tracked.current = true;\r\n\r\n    const trackView = async () => {\r\n      try {\r\n        const visitorId = getVisitorId();\r\n        const locationData = await fetchLocationData();\r\n        \r\n        await supabase.from(\"page_views\").insert({\r\n          page_type: pageType,\r\n          target_id: targetId || null,\r\n          visitor_id: visitorId,\r\n          user_id: user?.id || null,\r\n          user_agent: navigator.userAgent,\r\n          referer: document.referrer || null,\r\n          country: locationData.country,\r\n          city: locationData.city,\r\n          region: locationData.region,\r\n        });\r\n      } catch (error) {\r\n        // Silently fail - analytics should not break the app\r\n        console.error(\"Failed to track page view:\", error);\r\n      }\r\n    };\r\n\r\n    trackView();\r\n  }, [pageType, targetId, user?.id]);\r\n};\r\n\r\nexport default usePageView;\r\n"],"names":["LOCATION_CACHE_KEY","getVisitorId","key","visitorId","getCachedLocation","cached","cacheLocation","data","fetchLocationData","error","supabase","locationData","usePageView","pageType","targetId","user","useAuth","tracked","useRef","useEffect"],"mappings":"8FAIA,MAAMA,EAAqB,iBAUrBC,EAAe,IAAc,CACjC,MAAMC,EAAM,aACR,IAAAC,EAAY,aAAa,QAAQD,CAAG,EACxC,OAAKC,IACHA,EAAY,OAAO,aACN,aAAA,QAAQD,EAAKC,CAAS,GAE9BA,CACT,EAGMC,EAAoB,IAA2B,CAC/C,GAAA,CACI,MAAAC,EAAS,eAAe,QAAQL,CAAkB,EACxD,GAAIK,EACK,OAAA,KAAK,MAAMA,CAAM,CAC1B,MACM,CAER,CACO,OAAA,IACT,EAGMC,EAAiBC,GAA6B,CAC9C,GAAA,CACF,eAAe,QAAQP,EAAoB,KAAK,UAAUO,CAAI,CAAC,CAAA,MACzD,CAER,CACF,EAGMC,EAAoB,SAAmC,CAE3D,MAAMH,EAASD,IACf,GAAIC,EACK,OAAAA,EAGL,GAAA,CACI,KAAA,CAAE,KAAAE,EAAM,MAAAE,GAAU,MAAMC,EAAS,UAAU,OAAO,cAAc,EAEtE,GAAID,EACM,eAAA,MAAM,4BAA6BA,CAAK,EACzC,CAAE,QAAS,KAAM,KAAM,KAAM,OAAQ,MAG9C,MAAME,EAA6B,CACjC,QAASJ,GAAM,SAAW,KAC1B,KAAMA,GAAM,MAAQ,KACpB,OAAQA,GAAM,QAAU,KACxB,GAAIA,GAAM,IAAM,IAAA,EAId,OAAAI,EAAa,SAAWA,EAAa,OACvCL,EAAcK,CAAY,EAGrBA,QACAF,EAAO,CACN,eAAA,MAAM,iCAAkCA,CAAK,EAC9C,CAAE,QAAS,KAAM,KAAM,KAAM,OAAQ,KAC9C,CACF,EAmBaG,EAAc,CAAC,CAAE,SAAAC,EAAU,SAAAC,KAAmC,CACnE,KAAA,CAAE,KAAAC,GAASC,IACXC,EAAUC,SAAO,EAAK,EAE5BC,EAAAA,UAAU,IAAM,CAEd,GAAIF,EAAQ,QAAS,OACrBA,EAAQ,QAAU,IAEA,SAAY,CACxB,GAAA,CACF,MAAMd,EAAYF,IACZU,EAAe,MAAMH,IAE3B,MAAME,EAAS,KAAK,YAAY,EAAE,OAAO,CACvC,UAAWG,EACX,UAAWC,GAAY,KACvB,WAAYX,EACZ,QAASY,GAAM,IAAM,KACrB,WAAY,UAAU,UACtB,QAAS,SAAS,UAAY,KAC9B,QAASJ,EAAa,QACtB,KAAMA,EAAa,KACnB,OAAQA,EAAa,MAAA,CACtB,QACMF,EAAO,CAEN,QAAA,MAAM,6BAA8BA,CAAK,CACnD,CAAA,MAID,CAACI,EAAUC,EAAUC,GAAM,EAAE,CAAC,CACnC"}