import{l as fe,o as ge,s as x,f as Y,e as Z,ag as ee,ah as re,d as xe,r as m,j as e,D as ve,ad as je,B as C,q as ye,a6 as Ce,a7 as we,a9 as Se,aa as D,ai as be,aj as Ne,ak as _e,al as De,am as Ee,an as Ue,I as Q,X as J,K as Ie,N as Te,O as Fe,Q as ke,R as Ae,T as qe,U as Pe,V as Oe,z as n}from"./index-Dz3rGluG.js";import{I as ze,a as Me,b as O}from"./input-otp-AABZfAxl.js";import{S as $e}from"./shield-alert-C-MPzE0a.js";import{P as Ve}from"./plus-aSdKZ8UI.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=fe("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),Be=(o,h="restaurant",u)=>ge({queryKey:["comments",o,h],enabled:(u==null?void 0:u.enabled)!==!1&&!!o,queryFn:async()=>{const{data:l,error:r}=await x.from("comments").select("*").eq("target_id",o).eq("target_type",h).order("created_at",{ascending:!1});if(r)throw r;if(!l||l.length===0)return[];const i=[...new Set(l.map(a=>a.user_id))],{data:E}=await x.rpc("get_public_profiles",{user_ids:i}),v=new Map((E||[]).map(a=>[a.id,{display_name:a.display_name,avatar_url:a.avatar_url}])),U=l.filter(a=>!a.parent_id),w=l.filter(a=>a.parent_id),c=new Map;return w.forEach(a=>{const g=a.parent_id;c.has(g)||c.set(g,[]),c.get(g).push(a)}),U.map(a=>({...a,profiles:v.get(a.user_id),replies:(c.get(a.id)||[]).sort((g,y)=>new Date(g.created_at).getTime()-new Date(y.created_at).getTime()).map(g=>({...g,profiles:v.get(g.user_id)}))}))},staleTime:3e4}),We=()=>{const{user:o}=Y(),{toast:h}=Z(),u=ee();return re({mutationFn:async({targetId:l,targetType:r,content:i,ratingValue:E,priceRange:v,imageUrl:U,parentId:w})=>{if(!o)throw new Error("User not authenticated");const c={user_id:o.id,target_id:l,target_type:r,content:i,parent_id:w};w||(E&&(c.rating_value=E),v&&(c.price_range=v)),U&&(c.image_url=U);const{data:j,error:a}=await x.from("comments").insert(c).select().single();if(a)throw a;return j},onSuccess:(l,r)=>{u.invalidateQueries({queryKey:["comments",r.targetId,r.targetType]}),u.invalidateQueries({queryKey:["restaurants"]}),u.invalidateQueries({queryKey:["restaurant",r.targetId]}),h({title:"Success",description:"Comment added successfully"})},onError:()=>{h({title:"Error",description:"Failed to add comment",variant:"destructive"})}})},Ge=()=>{const{toast:o}=Z(),h=ee();return re({mutationFn:async u=>{const{error:l}=await x.from("comments").delete().eq("id",u);if(l)throw l},onSuccess:()=>{h.invalidateQueries({queryKey:["comments"]}),o({title:"Success",description:"Comment deleted successfully"})},onError:()=>{o({title:"Error",description:"Failed to delete comment",variant:"destructive"})}})},Xe=()=>{const o=navigator.userAgent,h=/iPad|iPhone|iPod/.test(o),u=/Safari/.test(o)&&!/CriOS|FxiOS|EdgiOS/.test(o),l=window.navigator.standalone===!0;return h&&!u&&!l},Je=({targetType:o,targetId:h,trigger:u,onLoginRequired:l})=>{const{t:r}=xe(),{user:i}=Y(),[E,v]=m.useState(!1),[U,w]=m.useState(!1),[c,j]=m.useState(!1),[a,g]=m.useState(""),[y,H]=m.useState(""),[p,z]=m.useState((i==null?void 0:i.email)||""),[S,k]=m.useState([""]),[T,M]=m.useState([]),[K,L]=m.useState(!1),[$,F]=m.useState("form"),[A,q]=m.useState(""),[b,V]=m.useState(0),[R,B]=m.useState(!1),te=t=>{if(t&&!i){l==null||l();return}v(t),t&&(i!=null&&i.email)&&z(i.email),t||(F("form"),q(""),V(0))};m.useEffect(()=>{let t;return b>0&&(t=setTimeout(()=>V(b-1),1e3)),()=>clearTimeout(t)},[b]);const se=["spam","harassment","inappropriate_content","misinformation","copyright","fraud","hate_speech","violence","other"],ae=()=>{k([...S,""])},ie=t=>{k(S.filter((s,d)=>d!==t))},ne=(t,s)=>{const d=[...S];d[t]=s,k(d)},oe=t=>{const s=Array.from(t.target.files||[]);if(s.filter(f=>f.size>5*1024*1024).length>0){n.error(r("report.imageTooLarge"));return}const N=["image/jpeg","image/png","image/webp","image/gif"];if(s.filter(f=>!N.includes(f.type)).length>0){n.error(r("report.invalidImageType"));return}M(f=>[...f,...s])},le=t=>{M(s=>s.filter((d,N)=>N!==t))},ce=async()=>{if(T.length===0)return[];L(!0);const t=[];try{for(const s of T){const d=s.name.split(".").pop(),_=`${`${Date.now()}-${Math.random().toString(36).substring(7)}.${d}`}`,{error:f}=await x.storage.from("report-evidence").upload(_,s);if(f)throw f;const{data:P}=x.storage.from("report-evidence").getPublicUrl(_);t.push(P.publicUrl)}return t}catch(s){throw console.error("Error uploading images:",s),s}finally{L(!1)}},W=async()=>{if(!p.trim()){n.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p)){n.error(r("report.invalidEmail"));return}B(!0);try{const{error:t}=await x.functions.invoke("send-verification-code",{body:{email:p}});if(t){n.error(r("auth.verificationCodeFailed")),console.error(t);return}F("verify"),n.success(r("auth.verificationCodeSent")),V(30)}catch(t){n.error(t.message||r("error.general"))}finally{B(!1)}},de=async()=>{b>0||await W()},me=async()=>{if(A.length!==4){n.error(r("auth.invalidVerificationCode"));return}j(!0);try{const{data:t,error:s}=await x.functions.invoke("verify-email-code",{body:{email:p,code:A}});if(s||!(t!=null&&t.success)){(t==null?void 0:t.error)==="This verification code has already been used"?n.error(r("auth.verificationCodeUsed")):n.error((t==null?void 0:t.error)||r("auth.invalidVerificationCode")),j(!1);return}F("submitting"),await G()}catch(t){n.error(t.message||r("error.general")),j(!1)}},ue=async()=>{if(!a){n.error(r("report.reasonPlaceholder"));return}if(!y||y.length<20){n.error(r("report.detailsMin"));return}if(!p.trim()){n.error(r("report.contactRequired"));return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p)){n.error(r("report.invalidEmail"));return}if(S.filter(s=>s.trim()!=="").length===0&&T.length===0){n.error(r("report.evidenceRequired"));return}i?w(!0):await W()},G=async()=>{j(!0);try{let t=[];try{t=await ce()}catch{n.error(r("report.imageUploadFailed")),j(!1);return}const d=[...S.filter(I=>I.trim()!==""),...t],N={reporter_id:(i==null?void 0:i.id)||null,target_type:o,target_id:h,reason:a,description:y,evidence_urls:d,reporter_contact:p};console.log("Attempting to insert report:",N);const{data:_,error:f}=await x.from("reports").insert(N).select().single();if(console.log("Insert result:",{report:_,error:f}),f)throw f;let P="Anonymous",X=p;if(i){const{data:I}=await x.from("profiles").select("display_name").eq("id",i.id).single();P=(I==null?void 0:I.display_name)||"Unknown",X=i.email||p}await x.functions.invoke("send-report-email",{body:{reportId:_.id,reporterName:P,reporterEmail:X,targetType:o,targetId:h,reason:a,description:y,evidenceUrls:d.length>0?d:void 0,reporterContact:p||void 0}});const he=_.id.substring(0,8).toUpperCase();n.success(r("report.successDetailed",{reference:he}),{description:r("report.successDescription"),duration:8e3}),v(!1),w(!1),g(""),H(""),i||z(""),k([""]),M([]),F("form"),q("")}catch(t){console.error("Error submitting report:",t),n.error(r("report.failed"))}finally{j(!1)}},pe=()=>{switch(o){case"comment":return r("report.reportComment");case"restaurant":return r("report.reportRestaurant");case"activity":return r("report.reportActivity");case"user":return r("report.reportUser");default:return r("report.title")}};return e.jsxs(e.Fragment,{children:[e.jsxs(ve,{open:E,onOpenChange:te,children:[e.jsx(je,{asChild:!0,children:u||e.jsxs(C,{variant:"ghost",size:"sm",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),r("report.title")]})}),e.jsxs(ye,{className:"max-w-[90vw] sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ce,{children:[e.jsx(we,{children:pe()}),e.jsx(Se,{children:r($==="verify"?"auth.verificationCodeSent":"report.description")})]}),$==="form"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"reason",children:r("report.reason")}),e.jsxs(be,{value:a,onValueChange:g,children:[e.jsx(Ne,{children:e.jsx(_e,{placeholder:r("report.reasonPlaceholder")})}),e.jsx(De,{children:se.map(t=>e.jsx(Ee,{value:t,children:r(`report.reasons.${t}`)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"description",children:r("report.detailsLabel")}),e.jsx(Ue,{id:"description",value:y,onChange:t=>H(t.target.value),placeholder:r("report.detailsPlaceholder"),rows:5,className:"resize-none"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y.length,"/20 ",r("common.characters")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"contact",children:[r("report.contactLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx(Q,{id:"contact",type:"email",value:p,onChange:t=>z(t.target.value),placeholder:r("report.contactPlaceholder"),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{children:[r("report.evidenceLabel"),e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:r("report.evidenceRequiredNote")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"image-upload",className:"text-sm font-medium",children:r("report.uploadImages")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:T.map((t,s)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`Evidence ${s+1}`,className:"w-20 h-20 object-cover rounded border"}),e.jsx(C,{type:"button",variant:"destructive",size:"icon",className:"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>le(s),children:e.jsx(J,{className:"w-3 h-3"})})]},s))}),e.jsx(Q,{id:"image-upload",type:"file",accept:"image/jpeg,image/png,image/webp,image/gif",multiple:!0,onChange:oe,className:"cursor-pointer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("report.imageUploadHint")})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(D,{className:"text-sm font-medium",children:r("report.evidenceUrls")}),S.map((t,s)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{value:t,onChange:d=>ne(s,d.target.value),placeholder:r("report.evidencePlaceholder")}),S.length>1&&e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>ie(s),children:e.jsx(J,{className:"w-4 h-4"})})]},s)),e.jsxs(C,{variant:"outline",size:"sm",onClick:ae,className:"w-full",children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),r("report.addEvidence")]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(C,{variant:"outline",onClick:()=>v(!1),children:r("report.cancel")}),e.jsx(C,{onClick:ue,disabled:!a||y.length<20||!p.trim()||S.filter(t=>t.trim()!=="").length===0&&T.length===0||K||R,children:r(K?"common.uploading":R?"auth.sendingCode":"report.submit")})]})]}):$==="submitting"?e.jsx("div",{className:"space-y-4 py-8",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-center text-muted-foreground",children:r("report.submitting")})]})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:r("auth.verificationCode")}),e.jsx("div",{className:"flex justify-center",children:e.jsx(ze,{maxLength:4,value:A,onChange:t=>q(t),children:e.jsxs(Me,{children:[e.jsx(O,{index:0}),e.jsx(O,{index:1}),e.jsx(O,{index:2}),e.jsx(O,{index:3})]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:r("auth.verificationCodeHint",{email:p})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(C,{variant:"link",size:"sm",onClick:de,disabled:b>0||c,children:b>0?`${r("auth.resendCode")} (${b}s)`:r("auth.resendCode")})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"outline",className:"w-full",onClick:()=>{F("form"),q("")},disabled:c,children:r("common.back")}),e.jsx(C,{className:"w-full",onClick:me,disabled:A.length!==4||c,children:r(c?"auth.verifying":"auth.verify")})]})]})]})]}),e.jsx(Ie,{open:U,onOpenChange:w,children:e.jsxs(Te,{children:[e.jsxs(Fe,{children:[e.jsx(ke,{children:r("report.confirmTitle")}),e.jsx(Ae,{children:r("report.confirmMessage")})]}),e.jsxs(qe,{children:[e.jsx(Pe,{children:r("report.cancel")}),e.jsx(Oe,{onClick:G,disabled:c,children:r(c?"report.submitting":"report.submit")})]})]})})]})};export{Re as D,Je as R,We as a,Ge as b,Xe as i,Be as u};
