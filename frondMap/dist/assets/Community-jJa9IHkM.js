import{p as G,u as Oe,r as i,j as e,cY as qe,cm as Be,ba as He,b5 as ne,be as ze,bC as ye,bB as te,bf as Ne,ao as Ve,b4 as ae,X as Z,e8 as ve,a4 as W,a_ as be,e9 as R,ea as Ge,eb as Qe,bK as Ke,aM as pe,bh as We,cL as Xe,w as O,q as Ye,bP as ge,ec as Je,bc as Ze,bb as es}from"./vendor-react-COnB1Bf9.js";import{u as ss,g as z,P as ts,Q as as,R as rs,D as ns,W as is,c as os,d as ls,e as cs,a as ee,I as fe,B as V,i as P,S as we,G as ds,af as ms,ak as us,ag as xs,al as hs,a8 as ps,s as q,j as K}from"./index-B-ATr_p9.js";import{c as gs,d as fs,e as js,f as ys,g as Ns,h as vs}from"./useCommunityPosts-ikj0n71E.js";import{u as se}from"./useLocalizedContent-pMHaJh_n.js";import{c as bs}from"./usePoints-CKyw2YyH.js";import{D as ie,b as oe,c as le,d as ce,f as ke}from"./drawer-BOruVZfi.js";import{P as de,a as me,b as ue}from"./popover-B4Zdx0S9.js";import{u as ws}from"./useActivities-CyjcT3q-.js";import{u as ks}from"./useRestaurants-qNgLbNB5.js";import{P as Cs}from"./PullToRefresh-D9ZdI0iA.js";import"./vendor-i18n-jtdHZIRR.js";import"./vendor-editor-B1vH4T8i.js";import"./vendor-utils-Z4kpnli5.js";import"./vendor-supabase-CK3nEoYK.js";const Ss=({post:s,showAssociations:t=!1})=>{const{t:r}=G(),{user:x}=ss(),m=Oe(),{getLocalizedField:l}=se(),L=gs(),[h,N]=i.useState(!1),b=p=>{p.preventDefault(),p.stopPropagation(),x&&L.mutate({postId:s.id,liked:s.user_liked||!1})},u=()=>{m(`/community/${s.id}`)},y=(p,E)=>{p.preventDefault(),p.stopPropagation(),m(`/restaurant/${E}`)},f=p=>{p.preventDefault(),p.stopPropagation(),s.activity?.id&&m(`/activity/${s.activity.id}`)},k=p=>new DOMParser().parseFromString(p,"text/html").body.textContent||"",j=l(s,"content"),n=k(j),U=s.image_urls&&s.image_urls.length>0,C=!!s.video_url,D=U||C,T=s.image_urls?.length||0,_=[...s.restaurants||[],...s.restaurant&&!s.restaurants?.find(p=>p.id===s.restaurant?.id)?[s.restaurant]:[]],B=s.activity?l(s.activity,"title"):null,A=2;return e.jsxs("div",{className:"group cursor-pointer rounded-lg overflow-hidden bg-card border border-border/50 hover:shadow-lg transition-all duration-300 hover:-translate-y-1",onClick:u,children:[D&&e.jsxs("div",{className:"relative aspect-[4/5] overflow-hidden",children:[U?h?e.jsx("div",{className:"w-full h-full bg-muted flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-muted-foreground",children:r("common.imageLoadError","å›¾ç‰‡åŠ è½½å¤±è´¥")})}):e.jsx("img",{src:s.image_urls[0],alt:"",className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500",onError:()=>N(!0)}):C?e.jsx("video",{src:s.video_url,className:"w-full h-full object-cover",preload:"metadata",muted:!0,playsInline:!0}):null,C&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-black/50 backdrop-blur-sm flex items-center justify-center",children:e.jsx(qe,{className:"h-5 w-5 text-white fill-white ml-0.5"})})}),!C&&T>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full z-10 flex items-center gap-1",children:[e.jsx(Be,{className:"h-3 w-3"}),e.jsx("span",{children:T})]})]}),e.jsxs("div",{className:"p-3",children:[t&&(_.length>0||B)&&e.jsxs("div",{className:"flex flex-wrap gap-1.5 mb-2",children:[_.slice(0,A).map(p=>e.jsxs(z,{variant:"secondary",className:"text-xs cursor-pointer hover:bg-secondary/80 gap-1",onClick:E=>y(E,p.id),children:[e.jsx(He,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-[120px]",children:l(p,"name")})]},p.id)),_.length>A&&e.jsxs(z,{variant:"secondary",className:"text-xs gap-1",children:["+",_.length-A]}),B&&e.jsxs(z,{variant:"secondary",className:"text-xs cursor-pointer hover:bg-secondary/80 gap-1",onClick:f,children:[e.jsx(ne,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-[120px]",children:B})]})]}),e.jsx("p",{className:`text-sm font-medium line-clamp-2 leading-relaxed ${D?"":"min-h-[60px]"}`,children:n}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsxs(ts,{className:"h-5 w-5 flex-shrink-0",children:[e.jsx(as,{src:s.author?.avatar_url||void 0}),e.jsx(rs,{className:"text-[10px]",children:s.author?.display_name?.charAt(0)||"?"})]}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:s.author?.display_name})]}),e.jsxs("button",{className:`flex items-center gap-1 text-xs ${s.user_liked?"text-red-500":"text-muted-foreground"} hover:text-red-500 transition-colors`,onClick:b,disabled:!x,children:[e.jsx(ze,{className:`h-4 w-4 ${s.user_liked?"fill-current":""}`}),e.jsx("span",{children:s.likes_count||0})]})]})]})]})},Ps=()=>{const{t:s}=G(),{data:t}=bs(),r=t?.find(l=>l.key==="post_points")?.value||"5",x=t?.find(l=>l.key==="min_post_length")?.value||"10",m=t?.find(l=>l.key==="post_require_media")?.value==="true";return e.jsxs(ns,{children:[e.jsx(is,{asChild:!0,children:e.jsx("button",{className:"text-primary hover:underline text-sm whitespace-nowrap",children:s("community.viewPointsRules","æŸ¥çœ‹è¯¦ç»†è§„åˆ™")})}),e.jsxs(os,{className:"max-w-md",children:[e.jsx(ls,{children:e.jsxs(cs,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),s("community.pointsRulesTitle","å‘å¸–ç§¯åˆ†è§„åˆ™")]})}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:s("community.pointsRulesIntro","é€šè¿‡å‘å¸ƒç¤¾åŒºå¸–å­è·å¾—ç§¯åˆ†ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š")}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.rulePostPoints",{points:r})})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleMinLength",{length:x})})]}),m&&e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(te,{className:"h-4 w-4 text-green-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleRequireMedia","å¸–å­å¿…é¡»åŒ…å«è‡³å°‘ä¸€å¼ å›¾ç‰‡æˆ–ä¸€ä¸ªè§†é¢‘")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ne,{className:"h-4 w-4 text-blue-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleDailyLimit","æ¯å¤©ä»…å¯é€šè¿‡å‘å¸–è·å¾—ä¸€æ¬¡ç§¯åˆ†å¥–åŠ±")})]}),e.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[e.jsx(Ve,{className:"h-4 w-4 text-purple-500 mt-0.5 shrink-0"}),e.jsx("span",{children:s("community.ruleModerationRequired","å¸–å­éœ€é€šè¿‡å®¡æ ¸åæ‰èƒ½è·å¾—ç§¯åˆ†")})]})]})]})]})]})},Rs=({open:s,onOpenChange:t,value:r,onSelect:x,restaurants:m,required:l=!1,maxDisplay:L=2})=>{const{t:h}=G(),{getLocalizedField:N}=se(),b=ee(),[u,y]=i.useState(""),[f,k]=i.useState(r),[j,n]=i.useState("85vh");i.useEffect(()=>{if(!s||!b)return;const a=window.visualViewport;if(!a){n("85vh");return}const o=()=>{const d=a.height,I=Math.min(d*.85,d-50);n(`${I}px`)};return o(),a.addEventListener("resize",o),()=>{a.removeEventListener("resize",o)}},[s,b]);const U=a=>{a&&(k(r),y("")),t(a)},C=m?.filter(a=>{if(!u)return!0;const o=N(a,"name")?.toLowerCase()||"",d=a.address?.toLowerCase()||"",I=u.toLowerCase();return o.includes(I)||d.includes(I)})||[],D=a=>{k(o=>o.includes(a)?o.filter(d=>d!==a):[...o,a])},T=()=>{x(f),t(!1),y("")},_=a=>{const o=r.includes(a)?r.filter(d=>d!==a):[...r,a];x(o)},A=r.map(a=>{const o=m?.find(d=>d.id===a);return o?N(o,"name"):null}).filter(Boolean),p=()=>{if(A.length===0)return e.jsxs("span",{className:"text-muted-foreground",children:[h("community.linkRestaurants","å…³è”é¤å…"),l&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]});const a=A.slice(0,L),o=A.length-L;return e.jsxs("span",{className:"text-primary flex items-center gap-1 flex-wrap",children:[a.map((d,I)=>e.jsxs("span",{children:[d,I<a.length-1?"ã€":""]},I)),o>0&&e.jsxs(z,{variant:"secondary",className:"text-xs px-1.5 py-0",children:["+",o]})]})},E=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors text-left",onClick:()=>U(!0),children:[e.jsx(p,{}),e.jsx(ve,{className:"h-4 w-4 opacity-50 shrink-0"})]}),Q=({restaurant:a,isSelected:o,onToggle:d})=>e.jsxs("div",{className:P("flex items-start gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",o?"bg-primary/10":"hover:bg-muted"),onClick:d,children:[e.jsx("div",{className:P("h-5 w-5 shrink-0 mt-0.5 rounded border flex items-center justify-center transition-colors",o?"bg-primary border-primary":"border-muted-foreground/30"),children:o&&e.jsx(W,{className:"h-3 w-3 text-primary-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:N(a,"name")}),a.address&&e.jsxs("p",{className:"text-sm text-muted-foreground truncate flex items-center gap-1 mt-0.5",children:[e.jsx(be,{className:"h-3 w-3 shrink-0"}),a.address]})]})]});return b?e.jsxs(e.Fragment,{children:[E,e.jsx(ie,{open:s,onOpenChange:U,children:e.jsxs(oe,{className:"flex flex-col",style:{height:j,maxHeight:j,transition:"height 0.15s ease-out, max-height 0.15s ease-out"},children:[e.jsx(le,{className:"pb-2 shrink-0",children:e.jsxs(ce,{children:[h("community.selectRestaurants","é€‰æ‹©é¤å…"),f.length>0&&e.jsx(z,{variant:"secondary",className:"ml-2",children:f.length})]})}),e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{placeholder:h("community.searchRestaurant","æœç´¢é¤å…..."),value:u,onChange:a=>y(a.target.value),className:"pl-9"})]})}),f.length>0&&e.jsx("div",{className:"px-4 pb-3 shrink-0",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:f.map(a=>{const o=m?.find(d=>d.id===a);return o?e.jsxs(z,{variant:"secondary",className:"gap-1 pr-1",children:[e.jsx("span",{className:"truncate max-w-[120px]",children:N(o,"name")}),e.jsx("button",{type:"button",className:"hover:bg-muted-foreground/20 rounded-full p-0.5",onClick:d=>{d.stopPropagation(),k(I=>I.filter(X=>X!==a))},children:e.jsx(Z,{className:"h-3 w-3"})})]},a):null})})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 min-h-0",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[C.map(a=>e.jsx(Q,{restaurant:a,isSelected:f.includes(a.id),onToggle:()=>D(a.id)},a.id)),C.length===0&&u&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:h("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")})]})}),e.jsx(ke,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(V,{variant:"outline",className:"flex-1",onClick:()=>U(!1),children:h("common.cancel","å–æ¶ˆ")}),e.jsxs(V,{className:"flex-1",onClick:T,children:[h("community.confirmSelection","ç¡®è®¤é€‰æ‹©"),f.length>0&&` (${f.length})`]})]})})]})})]}):e.jsxs(de,{open:s,onOpenChange:U,children:[e.jsx(me,{asChild:!0,children:E}),e.jsxs(ue,{className:"w-80 p-0",align:"start",children:[e.jsx("div",{className:"p-3 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{placeholder:h("community.searchRestaurant","æœç´¢é¤å…..."),value:u,onChange:a=>y(a.target.value),className:"pl-9"})]})}),r.length>0&&e.jsx("div",{className:"p-3 border-b",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:r.map(a=>{const o=m?.find(d=>d.id===a);return o?e.jsxs(z,{variant:"secondary",className:"gap-1 pr-1",children:[e.jsx("span",{className:"truncate max-w-[100px]",children:N(o,"name")}),e.jsx("button",{type:"button",className:"hover:bg-muted-foreground/20 rounded-full p-0.5",onClick:d=>{d.stopPropagation(),_(a)},children:e.jsx(Z,{className:"h-3 w-3"})})]},a):null})})}),e.jsxs("div",{className:"max-h-64 overflow-y-auto p-2",children:[C.map(a=>e.jsx(Q,{restaurant:a,isSelected:r.includes(a.id),onToggle:()=>_(a.id)},a.id)),C.length===0&&u&&e.jsx("div",{className:"py-4 text-center text-muted-foreground text-sm",children:h("community.noRestaurantFound","æœªæ‰¾åˆ°åŒ¹é…çš„é¤å…")})]})]})]})},Ce=i.forwardRef(({className:s,...t},r)=>e.jsx(R,{ref:r,className:P("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...t}));Ce.displayName=R.displayName;const Ls=i.forwardRef(({className:s,...t},r)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(ae,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(R.Input,{ref:r,className:P("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...t})]}));Ls.displayName=R.Input.displayName;const Se=i.forwardRef(({className:s,...t},r)=>e.jsx(R.List,{ref:r,className:P("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...t}));Se.displayName=R.List.displayName;const Us=i.forwardRef((s,t)=>e.jsx(R.Empty,{ref:t,className:"py-6 text-center text-sm",...s}));Us.displayName=R.Empty.displayName;const Pe=i.forwardRef(({className:s,...t},r)=>e.jsx(R.Group,{ref:r,className:P("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...t}));Pe.displayName=R.Group.displayName;const _s=i.forwardRef(({className:s,...t},r)=>e.jsx(R.Separator,{ref:r,className:P("-mx-1 h-px bg-border",s),...t}));_s.displayName=R.Separator.displayName;const re=i.forwardRef(({className:s,...t},r)=>e.jsx(R.Item,{ref:r,className:P("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",s),...t}));re.displayName=R.Item.displayName;const Es=({open:s,onOpenChange:t,value:r,onSelect:x,activities:m})=>{const{t:l}=G(),{getLocalizedField:L}=se(),h=ee(),[N,b]=i.useState(r),u=n=>{n&&b(r),t(n)},y=()=>{if(!r)return"";const n=m?.find(U=>U.id===r);return n?L(n,"title"):""},f=()=>{x(N),t(!1)},k=n=>{x(n),t(!1)},j=e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-sm hover:text-primary transition-colors",onClick:()=>u(!0),children:[r?e.jsx("span",{className:"text-primary",children:y()}):e.jsx("span",{className:"text-muted-foreground",children:l("community.linkActivity","å…³è”æ´»åŠ¨")}),e.jsx(ve,{className:"h-4 w-4 opacity-50"})]});return h?e.jsxs(e.Fragment,{children:[j,e.jsx(ie,{open:s,onOpenChange:u,children:e.jsxs(oe,{className:"max-h-[85vh] flex flex-col",children:[e.jsx(le,{className:"pb-2",children:e.jsx(ce,{children:l("community.selectActivity","é€‰æ‹©æ´»åŠ¨")})}),e.jsx(we,{className:"flex-1 px-4",children:e.jsxs("div",{className:"space-y-1 pb-4",children:[e.jsxs("div",{className:P("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",N===""?"bg-primary/10":"hover:bg-muted"),onClick:()=>b(""),children:[e.jsx(W,{className:P("h-4 w-4 shrink-0",N===""?"opacity-100 text-primary":"opacity-0")}),e.jsx("span",{className:"text-muted-foreground",children:l("community.noActivity","ä¸å…³è”æ´»åŠ¨")})]}),m.map(n=>e.jsxs("div",{className:P("flex items-center gap-3 py-3 px-3 rounded-lg cursor-pointer transition-colors",N===n.id?"bg-primary/10":"hover:bg-muted"),onClick:()=>b(n.id),children:[e.jsx(W,{className:P("h-4 w-4 shrink-0",N===n.id?"opacity-100 text-primary":"opacity-0")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:L(n,"title")})]})]},n.id)),m.length===0&&e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:l("activities.noActivities","æš‚æ— å¯ç”¨æ´»åŠ¨")})]})}),e.jsx(ke,{className:"pt-2",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(V,{variant:"outline",className:"flex-1",onClick:()=>u(!1),children:l("common.cancel","å–æ¶ˆ")}),e.jsx(V,{className:"flex-1",onClick:f,children:l("community.confirmSelection","ç¡®è®¤é€‰æ‹©")})]})})]})})]}):e.jsxs(de,{open:s,onOpenChange:u,children:[e.jsx(me,{asChild:!0,children:j}),e.jsx(ue,{className:"w-72 p-0",align:"start",children:e.jsx(Ce,{children:e.jsx(Se,{children:e.jsxs(Pe,{children:[e.jsxs(re,{value:"none",onSelect:()=>k(""),children:[e.jsx(W,{className:P("mr-2 h-4 w-4",r?"opacity-0":"opacity-100")}),l("community.noActivity","ä¸å…³è”æ´»åŠ¨")]}),m.map(n=>e.jsxs(re,{value:n.id,onSelect:()=>k(n.id),children:[e.jsx(W,{className:P("mr-2 h-4 w-4",r===n.id?"opacity-100":"opacity-0")}),L(n,"title")]},n.id))]})})})})]})},je=[{name:"smileys",emojis:["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ¤£","ğŸ˜‚","ğŸ™‚","ğŸ˜Š","ğŸ˜‡","ğŸ¥°","ğŸ˜","ğŸ¤©","ğŸ˜˜","ğŸ˜—","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ¤‘","ğŸ¤—","ğŸ¤­","ğŸ¤«","ğŸ¤”","ğŸ¤","ğŸ¤¨","ğŸ˜","ğŸ˜‘","ğŸ˜¶","ğŸ˜","ğŸ˜’","ğŸ™„","ğŸ˜¬","ğŸ¤¥","ğŸ˜Œ","ğŸ˜”","ğŸ˜ª","ğŸ¤¤","ğŸ˜´","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤®","ğŸ¥µ","ğŸ¥¶","ğŸ¥´","ğŸ˜µ","ğŸ¤¯","ğŸ¤ ","ğŸ¥³","ğŸ˜","ğŸ¤“","ğŸ§"]},{name:"gestures",emojis:["ğŸ‘","ğŸ‘","ğŸ‘Œ","ğŸ¤Œ","âœŒï¸","ğŸ¤","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","â˜ï¸","âœ‹","ğŸ¤š","ğŸ–ï¸","ğŸ––","ğŸ‘‹","ğŸ¤","ğŸ™","ğŸ’ª","ğŸ¦¾","ğŸ¦¿","ğŸ¦µ","ğŸ¦¶","ğŸ‘‚","ğŸ¦»","ğŸ‘ƒ","ğŸ§ ","ğŸ‘€","ğŸ‘ï¸","ğŸ‘…","ğŸ‘„"]},{name:"food",emojis:["ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥¬","ğŸ¥’","ğŸŒ¶ï¸","ğŸ«‘","ğŸŒ½","ğŸ¥•","ğŸ§„","ğŸ§…","ğŸ¥”","ğŸ ","ğŸ¥","ğŸ¥¯","ğŸ","ğŸ¥–","ğŸ¥¨","ğŸ§€","ğŸ¥š","ğŸ³","ğŸ§ˆ","ğŸ¥","ğŸ§‡","ğŸ¥“","ğŸ¥©","ğŸ—","ğŸ–","ğŸ¦´","ğŸŒ­","ğŸ”","ğŸŸ","ğŸ•","ğŸ«“","ğŸ¥ª","ğŸ¥™","ğŸ§†","ğŸŒ®","ğŸŒ¯","ğŸ«”","ğŸ¥—","ğŸ¥˜","ğŸ«•","ğŸ¥«","ğŸ","ğŸœ","ğŸ²","ğŸ›","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸ¦ª","ğŸ¤","ğŸ™","ğŸš","ğŸ˜","ğŸ¥","ğŸ¥ ","ğŸ¥®","ğŸ¢","ğŸ¡","ğŸ§","ğŸ¨","ğŸ¦","ğŸ¥§","ğŸ§","ğŸ°","ğŸ‚","ğŸ®","ğŸ­","ğŸ¬","ğŸ«","ğŸ¿","ğŸ©","ğŸª"]},{name:"hearts",emojis:["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ¤","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’","ğŸ’“","ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’","ğŸ’Ÿ","â™¥ï¸"]},{name:"objects",emojis:["â­","ğŸŒŸ","âœ¨","ğŸ’«","ğŸ”¥","ğŸ’¯","ğŸ‰","ğŸŠ","ğŸˆ","ğŸ","ğŸ†","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","âš½","ğŸ€","ğŸˆ","âš¾","ğŸ¾","ğŸ","ğŸ±","ğŸ“","ğŸ®","ğŸ²","ğŸ§©","ğŸ­","ğŸ¨","ğŸ¬","ğŸ¤","ğŸ§","ğŸµ","ğŸ¶","ğŸ¹","ğŸ¸","ğŸº","ğŸ»","ğŸ“·","ğŸ“¸","ğŸ“¹","ğŸ¥","ğŸ“±","ğŸ’»","âŒ¨ï¸","ğŸ–¥ï¸","ğŸ“º","ğŸ“»","â°","âŒš","ğŸ’¡","ğŸ”¦","ğŸ“š","ğŸ“–","âœï¸","ğŸ“","ğŸ’°","ğŸ’µ","ğŸ’´","ğŸ’¶","ğŸ’·","ğŸ’³","ğŸ›’","ğŸ€","ğŸ—ï¸"]},{name:"nature",emojis:["ğŸŒ¸","ğŸ’®","ğŸµï¸","ğŸŒ¹","ğŸ¥€","ğŸŒº","ğŸŒ»","ğŸŒ¼","ğŸŒ·","ğŸŒ±","ğŸª´","ğŸŒ²","ğŸŒ³","ğŸŒ´","ğŸŒµ","ğŸŒ¾","ğŸŒ¿","â˜˜ï¸","ğŸ€","ğŸ","ğŸ‚","ğŸƒ","ğŸŒ","ğŸŒ","ğŸŒ","ğŸŒ™","â­","â˜€ï¸","ğŸŒ¤ï¸","â›…","ğŸŒ¥ï¸","â˜ï¸","ğŸŒ¦ï¸","ğŸŒ§ï¸","â›ˆï¸","ğŸŒ©ï¸","ğŸŒ¨ï¸","â„ï¸","â˜ƒï¸","â›„","ğŸŒ¬ï¸","ğŸ’¨","ğŸŒŠ","ğŸ’§","ğŸ’¦","â˜”","ğŸŒˆ"]}],Is=({onSelect:s})=>{const{t}=G(),r=ee(),[x,m]=i.useState(!1),[l,L]=i.useState(0),h=y=>{s(y),r||m(!1)},N={smileys:t("emoji.smileys","è¡¨æƒ…"),gestures:t("emoji.gestures","æ‰‹åŠ¿"),food:t("emoji.food","ç¾é£Ÿ"),hearts:t("emoji.hearts","çˆ±å¿ƒ"),objects:t("emoji.objects","ç‰©å“"),nature:t("emoji.nature","è‡ªç„¶")},b=e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-1 overflow-x-auto pb-2 border-b",children:je.map((y,f)=>e.jsx("button",{type:"button",onClick:()=>L(f),className:`px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors ${l===f?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-muted-foreground"}`,children:N[y.name]},y.name))}),e.jsx("div",{className:"grid grid-cols-8 gap-1",children:je[l].emojis.map((y,f)=>e.jsx("button",{type:"button",onClick:()=>h(y),className:"w-9 h-9 flex items-center justify-center text-xl hover:bg-muted rounded-md transition-colors",children:y},f))})]}),u=e.jsxs("button",{type:"button",onClick:()=>m(!0),className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(Ge,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.emoji","è¡¨æƒ…")})]});return r?e.jsxs(e.Fragment,{children:[u,e.jsx(ie,{open:x,onOpenChange:m,children:e.jsxs(oe,{className:"h-[50vh]",children:[e.jsx(le,{className:"pb-2",children:e.jsx(ce,{children:t("emoji.title","é€‰æ‹©è¡¨æƒ…")})}),e.jsx(we,{className:"flex-1 px-4 pb-4",children:b})]})})]}):e.jsxs(de,{open:x,onOpenChange:m,children:[e.jsx(me,{asChild:!0,children:u}),e.jsx(ue,{className:"w-80 p-3",align:"start",side:"top",children:b})]})},Ds=({trigger:s})=>{const{t}=G(),{getLocalizedField:r}=se(),x=fs(),{data:m}=ws(),{data:l}=ks(),{role:L,isMerchant:h,isAdmin:N,isSupervisor:b}=ds(),{data:u}=js(),{data:y,isLoading:f}=ys(),[k,j]=i.useState(!1),[n,U]=i.useState(""),[C,D]=i.useState([]),[T,_]=i.useState(null),[B,A]=i.useState(""),[p,E]=i.useState([]),[Q,a]=i.useState(!1),[o,d]=i.useState(!1),[I,X]=i.useState(!1),Y=i.useRef(null),J=i.useRef(null),xe=!h&&!b&&!N;i.useEffect(()=>{h&&u&&k&&E([u.id])},[h,u,k]);const he=()=>{U(""),D([]),_(null),A(""),E([]),d(!1),X(!1)},Re=g=>{j(g),g||he()},Le=m?.filter(g=>g.status==="published")||[],Ue=async g=>{const v=g.target.files;if(!(!v||v.length===0)){if(C.length+v.length>9){O.error(t("community.maxImages","æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡"));return}a(!0);try{const{data:{user:S}}=await q.auth.getUser();if(!S)throw new Error("Not authenticated");const c=[];for(const w of Array.from(v)){const H=w.name.split(".").pop(),F=`${S.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${H}`,{error:M}=await q.storage.from("community-posts").upload(F,w);if(M)throw M;const{data:{publicUrl:$}}=q.storage.from("community-posts").getPublicUrl(F);c.push($)}D(w=>[...w,...c])}catch(S){console.error("Upload error:",S),O.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{a(!1),Y.current&&(Y.current.value="")}}},_e=g=>new Promise((v,S)=>{const c=document.createElement("video"),w=document.createElement("canvas"),H=w.getContext("2d");c.preload="auto",c.muted=!0,c.playsInline=!0;let F=!1;const M=()=>{F||c.videoWidth===0||c.videoHeight===0||(w.width=c.videoWidth,w.height=c.videoHeight,H&&(H.drawImage(c,0,0,w.width,w.height),w.toBlob($=>{$&&$.size>0?(F=!0,c.pause(),URL.revokeObjectURL(c.src),v($)):S(new Error("Failed to create blob"))},"image/jpeg",.85)))};c.onloadedmetadata=()=>{w.width=c.videoWidth,w.height=c.videoHeight,c.currentTime=.1},c.onseeked=()=>{setTimeout(M,100)},c.onerror=()=>{URL.revokeObjectURL(c.src),S(new Error("Failed to load video"))},setTimeout(()=>{F||(URL.revokeObjectURL(c.src),S(new Error("Timeout")))},1e4),c.src=URL.createObjectURL(g),c.load()}),Ee=async g=>{const v=g.target.files?.[0];if(v){if(v.size>100*1024*1024){O.error(t("community.videoTooLarge","è§†é¢‘ä¸èƒ½è¶…è¿‡100MB"));return}a(!0);try{const{data:{user:S}}=await q.auth.getUser();if(!S)throw new Error("Not authenticated");const c=v.name.split(".").pop(),w=`${S.id}/${Date.now()}.${c}`,{error:H}=await q.storage.from("community-posts").upload(w,v);if(H)throw H;const{data:{publicUrl:F}}=q.storage.from("community-posts").getPublicUrl(w);_(F);try{O.info(t("community.extractingCover","æ­£åœ¨æå–è§†é¢‘å°é¢..."));const M=await _e(v),$=`${S.id}/${Date.now()}-cover.jpg`,{error:Fe}=await q.storage.from("community-posts").upload($,M);if(!Fe){const{data:{publicUrl:Me}}=q.storage.from("community-posts").getPublicUrl($);D($e=>[Me,...$e]),O.success(t("community.coverExtracted","å°é¢å·²è‡ªåŠ¨ç”Ÿæˆ"))}}catch(M){console.warn("Cover extraction failed:",M)}}catch(S){console.error("Upload error:",S),O.error(t("common.uploadError","ä¸Šä¼ å¤±è´¥"))}finally{a(!1),J.current&&(J.current.value="")}}},Ie=g=>{D(v=>v.filter((S,c)=>c!==g))},De=()=>{_(null),D(g=>g.length>0&&g[0].includes("-cover.jpg")?g.slice(1):g)},Ae=async()=>{if(!n.trim()){O.error(t("community.contentRequired","è¯·è¾“å…¥å†…å®¹"));return}if(xe&&p.length===0){O.error(t("community.restaurantRequired","è¯·é€‰æ‹©é¤å…"));return}await x.mutateAsync({content:n,image_urls:C,video_url:T||void 0,activity_id:B||void 0,restaurant_ids:p.length>0?p:void 0}),he(),j(!1)},Te=()=>u?r(u,"name"):t("community.noRestaurant","æœªå…³è”é¤å…");return e.jsxs(ms,{open:k,onOpenChange:Re,children:[e.jsx(us,{asChild:!0,children:s||e.jsx(V,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs(xs,{side:"bottom",className:"h-full flex flex-col p-0 rounded-none border-0 [&>button]:hidden",children:[e.jsx(Qe,{children:e.jsx(hs,{children:t("community.createPost","å‘å¸ƒå¸–å­")})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-background shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>j(!1),className:"p-1 -ml-1 hover:bg-muted rounded-md transition-colors",children:e.jsx(Ke,{className:"h-5 w-5"})}),e.jsxs(V,{size:"sm",onClick:Ae,disabled:x.isPending||!n.trim(),className:"rounded-full px-6",children:[x.isPending&&e.jsx(pe,{className:"h-4 w-4 mr-2 animate-spin"}),t("community.publish","å‘å¸ƒ")]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[!f&&!y&&e.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2 bg-primary/10 dark:bg-primary/20 border border-primary/30 dark:border-primary/40 rounded-md text-sm text-primary dark:text-primary",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:t("community.dailyPointsHint","æ¯æ—¥å‘å¸ƒé¦–ä¸ªå¸–å­å¯è·å¾—5ç§¯åˆ†ï¼")})]}),e.jsx(Ps,{})]}),e.jsx(ps,{value:n,onChange:g=>U(g.target.value),placeholder:t("community.contentPlaceholder","åˆ†äº«ä½ çš„æƒ³æ³•..."),className:"min-h-[150px] border-none shadow-none resize-none focus-visible:ring-0 p-0 text-base"}),C.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:C.map((g,v)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden bg-muted",children:[e.jsx("img",{src:g,alt:"",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>Ie(v),className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(Z,{className:"h-3 w-3"})})]},v))}),T&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[e.jsx("video",{src:T,controls:!0,className:"w-full max-h-48",preload:"metadata"}),e.jsx("button",{type:"button",onClick:De,className:"absolute top-2 right-2 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(Z,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"px-4 py-2 pb-0 bg-background shrink-0 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(be,{className:"h-5 w-5 text-muted-foreground shrink-0"}),h?e.jsx("span",{className:"text-sm text-muted-foreground",children:Te()}):e.jsx(Rs,{open:o,onOpenChange:d,value:p,onSelect:E,restaurants:l||[],required:xe})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{className:"h-5 w-5 text-muted-foreground shrink-0"}),e.jsx(Es,{open:I,onOpenChange:X,value:B,onSelect:A,activities:Le})]})]}),e.jsxs("div",{className:"flex items-center gap-6 px-4 pt-0 py-2 pb-[max(2rem,calc(env(safe-area-inset-bottom)+1rem))] bg-background shrink-0",children:[e.jsx("input",{ref:Y,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:Ue}),e.jsx("input",{ref:J,type:"file",accept:"video/*",className:"hidden",onChange:Ee}),e.jsxs("button",{type:"button",onClick:()=>Y.current?.click(),disabled:Q||C.length>=9,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(We,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.photo","ç…§ç‰‡")})]}),e.jsxs("button",{type:"button",onClick:()=>J.current?.click(),disabled:Q||!!T,className:"flex items-center gap-1.5 text-muted-foreground hover:text-foreground disabled:opacity-50 transition-colors",children:[e.jsx(Xe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:t("community.video","è§†é¢‘")})]}),e.jsx(Is,{onSelect:g=>U(v=>v+g)}),Q&&e.jsx(pe,{className:"h-5 w-5 animate-spin ml-auto"})]})]})]})},As=()=>e.jsxs("div",{className:"rounded-xl overflow-hidden bg-card border border-border/50",children:[e.jsx(K,{className:"aspect-[4/5] w-full"}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4 w-full"}),e.jsx(K,{className:"h-4 w-3/4"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5 rounded-full"}),e.jsx(K,{className:"h-3 w-16"})]}),e.jsx(K,{className:"h-4 w-10"})]})]})]}),Xs=()=>{const{t:s}=G(),t=Ye(),r=ee(),[x,m]=i.useState(()=>localStorage.getItem("community-mobile-layout")==="single"?"single":"double"),[l,L]=i.useState(()=>localStorage.getItem("community-sort")==="popular"?"popular":"latest"),{data:h,isLoading:N}=Ns({status:"approved",sortBy:l}),{data:b}=vs(),u=i.useCallback(async()=>{t.removeQueries({queryKey:["community-posts"]}),t.removeQueries({queryKey:["can-create-post"]}),t.removeQueries({queryKey:["has-posted-today"]}),await Promise.all([t.invalidateQueries({queryKey:["community-posts"]}),t.invalidateQueries({queryKey:["can-create-post"]}),t.invalidateQueries({queryKey:["has-posted-today"]})])},[t]),y=()=>{const j=x==="double"?"single":"double";m(j),localStorage.setItem("community-mobile-layout",j)},f=j=>{const n=j;L(n),localStorage.setItem("community-sort",n)},k=()=>r?x==="single"?"columns-1 gap-4":"columns-2 gap-3":"columns-3 lg:columns-4 gap-4";return e.jsx(Cs,{onRefresh:u,children:e.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4 animate-fade-in",children:e.jsxs("div",{className:"container mx-auto max-w-5xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl sm:text-4xl mb-2 text-primary font-medium",children:s("community.title","ç¤¾åŒº")}),e.jsx("p",{className:"text-muted-foreground text-base sm:text-lg",children:s("community.description","åˆ†äº«ç¾é£Ÿä½“éªŒï¼Œå‘ç°æ›´å¤šç²¾å½©")})]}),b&&e.jsx(Ds,{trigger:e.jsxs(V,{size:"sm",className:"gap-1.5",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.createPost","å‘å¸ƒ")})]})})]}),e.jsx("div",{className:"flex items-center mb-4",children:e.jsxs("div",{className:"inline-flex h-9 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",children:[e.jsxs("button",{onClick:()=>f("latest"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${l==="latest"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(Ne,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.sortLatest","æœ€æ–°")})]}),e.jsxs("button",{onClick:()=>f("popular"),className:`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 gap-1.5 ${l==="popular"?"bg-background text-foreground shadow-sm":""}`,children:[e.jsx(Je,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:s("community.sortPopular","çƒ­é—¨")})]}),r&&e.jsx("button",{onClick:y,className:"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-2.5 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",title:x==="double"?s("community.singleColumn","å•åˆ—å¸ƒå±€"):s("community.doubleColumn","åŒåˆ—å¸ƒå±€"),children:x==="double"?e.jsx(Ze,{className:"h-3.5 w-3.5"}):e.jsx(es,{className:"h-3.5 w-3.5"})})]})}),N?e.jsx("div",{className:k(),children:Array.from({length:8}).map((j,n)=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(As,{})},n))}):h&&h.length>0?e.jsx("div",{className:k(),children:h.map(j=>e.jsx("div",{className:"break-inside-avoid mb-3 sm:mb-4",children:e.jsx(Ss,{post:j,showAssociations:r&&x==="single"})},j.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(ge,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground text-lg",children:s("community.noPosts","æš‚æ— å¸–å­")}),b&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground/70",children:s("community.beFirst","æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸–çš„äººå§ï¼")})]})]})})})};export{Xs as default};
//# sourceMappingURL=Community-jJa9IHkM.js.map
