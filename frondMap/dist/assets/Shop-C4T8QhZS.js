import{j as s}from"./vendor-ui-DmpovMYY.js";import{r as N,u as B}from"./vendor-react-iAJ0IrSD.js";import{u as F}from"./vendor-query-D82cqPtt.js";import{D as M,b as U,c as q,d as z,ay as O,bc as j,az as Q,m as V,aU as H,aV as K,aW as Y,aX as E,aY as $,aB as G,B as P,L as J,u as W,n as w,J as b,p as D,G as X,V as Z,aM as ss,h as S,cI as es,br as as,b5 as ts}from"./index-B44MF3Hr.js";import{e as ns}from"./usePoints-C-nfQt4J.js";import{c as rs,d as is,e as cs}from"./useShopItems-HJEiWLlQ.js";import{u as k}from"./useLocalizedContent-BN2IWylL.js";import{u as ls,P as os}from"./PointsHistoryDialog-5yUHHIqD.js";import{u as I}from"./vendor-i18n-DxKeo2S1.js";import{P as ds}from"./PullToRefresh-CA7kv_F8.js";import"./vendor-charts-Bz7hPIBd.js";import"./vendor-supabase-6pZ9VDFn.js";import"./tabs-58Z4HKoY.js";import"./format-CYFaqHf-.js";import"./startOfDay-CITyH735.js";const ms=({open:a,onOpenChange:p,item:n,userPoints:o})=>{const{t}=I(),{getLocalizedField:r}=k(),{data:f=[]}=ls(),d=rs(),[x,y]=N.useState(""),m=n.item_type==="physical",v=o-n.points_cost,_=async()=>{await d.mutateAsync({itemId:n.id,shippingAddressId:m?x:void 0}),p(!1)},g=!m||x;return s.jsx(M,{open:a,onOpenChange:p,children:s.jsxs(U,{className:"sm:max-w-md",children:[s.jsxs(q,{children:[s.jsx(z,{children:t("shop.confirmPurchase")}),s.jsx(O,{children:t("shop.confirmPurchaseDesc")})]}),s.jsxs("div",{className:"space-y-4 py-4",children:[s.jsxs("div",{className:"flex items-start gap-4 p-4 bg-secondary/30 rounded-lg",children:[n.image_url&&s.jsx("img",{src:n.image_url,alt:String(r(n,"name")),className:"w-16 h-16 rounded-lg object-cover"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h4",{className:"font-semibold",children:r(n,"name")}),s.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:r(n,"description")})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"text-muted-foreground",children:t("shop.currentPoints")}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(j,{className:"w-4 h-4 text-accent"}),s.jsx("span",{className:"font-medium",children:o})]})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"text-muted-foreground",children:t("shop.pointsCost")}),s.jsxs("span",{className:"flex items-center gap-1 text-destructive",children:[s.jsx("span",{children:"-"}),s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{className:"font-medium",children:n.points_cost})]})]}),s.jsxs("div",{className:"border-t pt-2 flex justify-between items-center",children:[s.jsx("span",{className:"font-medium",children:t("shop.afterPurchase")}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(j,{className:"w-4 h-4 text-accent"}),s.jsx("span",{className:"font-bold",children:v})]})]})]}),m&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs(Q,{className:"flex items-center gap-2",children:[s.jsx(V,{className:"w-4 h-4"}),t("shop.selectAddress")]}),f.length===0?s.jsx("p",{className:"text-sm text-muted-foreground",children:t("shop.noAddresses")}):s.jsxs(H,{value:x,onValueChange:y,children:[s.jsx(K,{children:s.jsx(Y,{placeholder:t("shop.selectAddressPlaceholder")})}),s.jsx(E,{children:f.map(c=>s.jsx($,{value:c.id,children:s.jsxs("div",{className:"text-left",children:[s.jsx("div",{className:"font-medium",children:c.label}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:[c.street,", ",c.city]})]})},c.id))})]})]})]}),s.jsxs(G,{className:"gap-2 sm:gap-0",children:[s.jsx(P,{variant:"outline",onClick:()=>p(!1),children:t("common.cancel")}),s.jsx(P,{onClick:_,disabled:!g||d.isPending,children:d.isPending?s.jsxs(s.Fragment,{children:[s.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),t("common.processing")]}):t("shop.confirmPurchaseBtn")})]})]})})},Ds=()=>{const{t:a}=I(),p=B(),{user:n}=W(),{getLocalizedField:o}=k(),t=F(),{data:r=0,isLoading:f}=ns(),{data:d=[],isLoading:x}=is(),{data:y=[]}=cs(),[m,v]=N.useState(null),[_,g]=N.useState(!1),c=N.useCallback(async()=>{await Promise.all([t.invalidateQueries({queryKey:["shop-items"]}),t.invalidateQueries({queryKey:["user-points"]}),t.invalidateQueries({queryKey:["user-purchase-limits"]})])},[t]),L=e=>{switch(e){case"coupon":return s.jsx(ts,{className:"w-5 h-5"});case"physical":return s.jsx(as,{className:"w-5 h-5"});case"badge":return s.jsx(es,{className:"w-5 h-5"});default:return s.jsx(D,{className:"w-5 h-5"})}},T=e=>{switch(e){case"coupon":return a("shop.itemType.coupon");case"physical":return a("shop.itemType.physical");case"badge":return a("shop.itemType.badge");default:return e}},C=e=>{const i=y.find(u=>u.shop_item_id===e.id);if(!i)return e.per_user_limit;const l=new Date(i.period_start),h=new Date;if(e.limit_refresh_period==="daily"&&l.toDateString()!==h.toDateString())return e.per_user_limit;if(e.limit_refresh_period==="weekly"){const u=new Date(h.getTime()-6048e5);if(l<u)return e.per_user_limit}return e.limit_refresh_period==="monthly"&&(l.getMonth()!==h.getMonth()||l.getFullYear()!==h.getFullYear())?e.per_user_limit:Math.max(0,e.per_user_limit-i.purchase_count)},A=e=>!(!n||r<e.points_cost||e.stock!==null&&e.stock<=0||C(e)<=0),R=e=>{if(!n){p("/auth");return}v(e),g(!0)};return x?s.jsx("div",{className:"min-h-screen bg-secondary/20 py-8 px-4",children:s.jsx("div",{className:"container mx-auto max-w-6xl",children:s.jsx("div",{className:"text-center",children:a("common.loading")})})}):s.jsx(ds,{onRefresh:c,children:s.jsxs("div",{className:"min-h-screen bg-secondary/20 py-4 md:py-8 px-3 md:px-4",children:[s.jsxs("div",{className:"container mx-auto max-w-6xl",children:[s.jsx("div",{className:"mb-6 md:mb-8",children:s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-foreground mb-2",children:a("shop.title")}),s.jsx("p",{className:"text-muted-foreground",children:a("shop.description")})]}),n&&s.jsx(w,{className:"md:w-auto",children:s.jsxs(b,{className:"p-4 flex items-center gap-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(j,{className:"w-6 h-6 text-accent"}),s.jsx("span",{className:"text-2xl font-bold text-foreground",children:f?"...":r}),s.jsx("span",{className:"text-muted-foreground",children:a("shop.points")})]}),s.jsx(os,{})]})})]})}),d.length===0?s.jsx(w,{children:s.jsxs(b,{className:"py-12 text-center",children:[s.jsx(D,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),s.jsx("p",{className:"text-muted-foreground",children:a("shop.noItems")})]})}):s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6",children:d.map(e=>{const i=e.stock!==null&&e.stock<=0,l=C(e),h=l<=0,u=r<e.points_cost;return s.jsxs(w,{className:`overflow-hidden ${i?"opacity-60":""}`,children:[e.image_url&&s.jsx("div",{className:"aspect-video overflow-hidden bg-secondary/30",children:s.jsx("img",{src:e.image_url,alt:String(o(e,"name")),className:"w-full h-full object-cover"})}),s.jsx(X,{className:"pb-2",children:s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx(Z,{className:"text-lg line-clamp-1",children:o(e,"name")}),s.jsx(ss,{className:"line-clamp-2 mt-1",children:o(e,"description")})]}),s.jsxs(S,{variant:"secondary",className:"flex items-center gap-1 shrink-0",children:[L(e.item_type),s.jsx("span",{className:"hidden sm:inline",children:T(e.item_type)})]})]})}),s.jsxs(b,{className:"pt-0",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(j,{className:"w-4 h-4 text-accent"}),s.jsx("span",{className:"font-bold text-lg",children:e.points_cost}),s.jsx("span",{className:"text-muted-foreground text-sm",children:a("shop.points")})]}),s.jsx("div",{className:"text-sm text-muted-foreground",children:e.stock!==null?i?s.jsx(S,{variant:"destructive",children:a("shop.soldOut")}):s.jsxs("span",{children:[a("shop.stock"),": ",e.stock]}):s.jsx("span",{children:a("shop.unlimited")})})]}),s.jsxs("div",{className:"text-sm text-muted-foreground mb-3",children:[e.limit_refresh_period==="none"?s.jsx("span",{children:a("shop.limitTotal",{count:e.per_user_limit})}):s.jsx("span",{children:a(`shop.limit.${e.limit_refresh_period}`,{count:e.per_user_limit})}),n&&!i&&s.jsxs("span",{className:"ml-2",children:["(",a("shop.remaining"),": ",l,")"]})]}),s.jsx(P,{className:"w-full",disabled:!A(e),onClick:()=>R(e),children:a(n?i?"shop.soldOut":h?"shop.limitReached":u?"shop.insufficientPoints":"shop.purchase":"shop.loginToPurchase")})]})]},e.id)})})]}),m&&s.jsx(ms,{open:_,onOpenChange:g,item:m,userPoints:r})]})})};export{Ds as default};
//# sourceMappingURL=Shop-C4T8QhZS.js.map
